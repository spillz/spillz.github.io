var xt=Object.defineProperty;var vt=(h,t,e)=>t in h?xt(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var l=(h,t,e)=>vt(h,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();function gt(h,t){for(let e=1e3;e>0;e--)if(t())return;throw"Timeout while trying to "+h}function J(h,t=0){return t!=0?h+Math.floor(Math.random()*(t-h)):Math.floor(Math.random()*h)}function bt(h,t){return[J(h),J(t)]}function ft(h){let t=h.length,e;for(;t!=0;)e=Math.floor(Math.random()*t),t--,[h[t],h[e]]=[h[e],h[t]];return h}function P(h){return h[Math.floor(Math.random()*h.length)]}class C extends Array{constructor(...t){t.length==1&&t[0]instanceof Array?super(...t[0]):super(...t)}sum(){let t=0;return this.forEach(e=>t+=e),t}mean(){return this.sum()/this.length}max(){return Math.max.apply(null,this)}min(){return Math.min.apply(null,this)}vars(){let t=0;return this.forEach(e=>t+=e*e),(t-this.length*this.mean()^2)/(this.length-1)}var(){let t=0;return this.forEach(e=>t+=e*e),t/this.length-this.mean()^2}std(){return Math.sqrt(this.var())}add(t){let e=new C(this);if(t instanceof Array||t instanceof C)for(let s=0;s<this.length;s++)e[s]+=t[s];else for(let s=0;s<this.length;s++)e[s]+=t;return e}mul(t){let e=new C(this);if(t instanceof Array||t instanceof C)for(let s=0;s<this.length;s++)e[s]*=t[s];else for(let s=0;s<this.length;s++)e[s]*=t;return e}dot(t){return this.mul(t).sum()}abs(){return Math.abs.apply(null,this)}shift(t){let e=new C;for(let s=-t;s<this.length-t;s++)s<0||s>=this.length?e.push(NaN):e.push(this[s]);return e}filter(t){return new C(super.filter(t))}dropNaN(){return this.filter(t=>!Number.isNaN(t))}}class d extends Array{constructor(t){super(),this[0]=t[0],this[1]=t[1]}static random(t){return new d(bt(t[0],t[1]))}add(t){return new d([this[0]+t[0],this[1]+t[1]])}subtract(t){return new d([this[0]-t[0],this[1]-t[1]])}scale(t){return new d([this[0]*t,this[1]*t])}mul(t){return new d([this[0]*t[0],this[1]*t[1]])}dot(t){return this[0]*t[0]+this[1]*t[1]}dist(t){return Math.hypot(this[0]-t[0],this[1]-t[1])}set x(t){this[0]=t}set y(t){this[1]=t}get x(){return this[0]}get y(){return this[1]}}class f extends Array{constructor(t){super(),this.length=4,this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3]}set x(t){this[0]=t}set y(t){this[1]=t}set w(t){this[2]=t}set h(t){this[3]=t}set pos(t){this[0]=t[0],this[1]=t[1]}get pos(){return new d([this[0],this[1]])}get x(){return this[0]}get y(){return this[1]}get w(){return this[2]}get h(){return this[3]}get right(){return this[0]+this[2]}get bottom(){return this[1]+this[3]}get center_x(){return this[0]+this[2]/2}get center_y(){return this[1]+this[3]/2}get center(){return new d([this.center_x,this.center_y])}shift(t){return new f([this.x+t[0],this.y+t[1],this.w,this.h])}shrinkBorders(t){return new f([this.x+t,this.y+t,this.w-t*2,this.h-t*2])}scale(t,e=!0){if(e){let s=[this[2]*t,this[3]*t];return new f([this[0]+.5*(this[2]-s[0]),this[1]+.5*(this[3]-s[1]),s[0],s[1]])}else{let s=[this[2]*t,this[3]*t];return new f([this[0],this[1],s[0],s[1]])}}collide(t){return this.x<t.x+t.w&&this.x+this.w>t.x&&this.y<t.y+t.h&&this.h+this.y>t.y}contact(t){return this.x<=t.x+t.w&&this.x+this.w>=t.x&&this.y<=t.y+t.h&&this.h+this.y>=t.y}}function at(h,t){return Math.floor(Math.random()*(t-h+1))+h}function rt(h,t=20){let e="";return h.forEach(s=>{s+="";for(let i=s.length;i<t;i++)s+=" ";e+=s}),e}function Mt(h,t,e,s,i="IM Fell English SC"){h.font=s+"px "+i;const a=t.split(`
`),n=[];for(let r of a){const c=r.split(/\s+/);let u="";for(let w of c){const x=u?u+" "+w:w;h.measureText(x).width>e&&u?(n.push(u),u=w):u=x}u&&n.push(u)}return n}function Tt(h,t,e,s,i,a=10,n="IM Fell English SC",r=1.2){h.font=a+"px "+n,h.fillStyle=i,h.textBaseline="top";const c=a*r;for(let u=0;u<t.length;u++)h.fillText(t[u],e,s+u*c);return t.length*c}class b{constructor(t,e=0){this.elapsed=0,this.timer=t,this.triggered=!1,e>0&&this.tick(e)}finished(){return this.elapsed>=this.timer}tick(t){return this.elapsed>=this.timer?(this.triggered&&(this.triggered=!1),!1):(this.elapsed+=t,this.elapsed>=this.timer?(this.triggered=!0,!0):!1)}reset(t=-1,e=0){this.elapsed=e,this.triggered=!1,t>=0&&(this.timer=t)}}const g={left:!1,right:!1,up:!1,down:!1,cycle:!1,use:!1,dodge:!1,dash:!1,camera:!1,menu:!1};var wt={...g};function st(){return{...wt}}var F={...g};({...g});function kt(h){F={...h}}var Y=null,Pt={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down",a:"left",d:"right",w:"up",s:"down",j:"dash",k:"dodge",l:"cycle",i:"use"," ":"dash",z:"dodge",x:"cycle",c:"use",0:"camera",Escape:"menu"};class ht{constructor(){this.controlStates={...wt},this.attach_to_player(),window.addEventListener("blur",t=>{this.clearPressedAll()})}attach_to_player(t=null){this.player=t,Y=this,t!=null&&(this.player.controller=this)}set(t,e=!0){g[t]=e,Y=this;let s=this.player;s!=null&&(s.controlStates[t]=e)}clearPressedAll(){for(const t in this.controlStates)this.controlStates[t]=!1}vibrate(t,e,s){}}class Ht extends ht{constructor(t,e=null){super(),this.game=t,e==null&&(e=Pt),this.keyMap=e;let s=this;document.onkeydown=function(i){s.keyDownHandler(i)},document.onkeyup=function(i){s.keyUpHandler(i)}}keyDownHandler(t){t.key=="p"&&(this.game.fillScreen=!this.game.fillScreen,this.game.updateWindowSize()),t.key=="f"&&(this.game.showFPS=!this.game.showFPS,this.game.updateWindowSize()),t.key=="G"&&(this.game.cullOffCamera=!this.game.cullOffCamera),t.key=="H"&&this.game.gameState==="running"&&this.game.activePlayers.length>0&&this.game.activePlayers[0].hp++,t.key=="T"&&this.game.gameState==="running"&&this.game.activePlayers.length>0&&(this.game.activePlayers[0].pos=new d([19,21]),this.game.camera.pos=new d([-19+this.game.camera.viewPortW/2,-21+this.game.camera.viewPortH/2])),t.key in this.keyMap&&this.set(this.keyMap[t.key],!0)}keyUpHandler(t){t.key in this.keyMap&&this.set(this.keyMap[t.key],!1)}}class Dt extends ht{constructor(t,e){super(),this.game=t,this.gamepad=e,this.thresh=.2,this.internalStates={...this.controlStates}}set(t,e=!0){this.internalStates[t]!=e&&(this.internalStates[t]=e,super.set(t,e))}vibrate(t,e,s){this.game.activePlayers.length==1&&window.navigator.vibrate(s),this.gamepad.vibrationActuator!=null&&this.gamepad.vibrationActuator.playEffect("dual-rumble",{startDelay:0,duration:s,weakMagnitude:t,strongMagnitude:e})}}class Ct{constructor(t){l(this,"gamepads",{});let e=this;this.game=t,window.addEventListener("gamepadconnected",function(s){e.connected(s)}),window.addEventListener("gamepaddisconnected",function(s){e.disconnected(s)})}connected(t){this.gamepads[t.gamepad.index]=new Dt(this.game,t.gamepad)}disconnected(t){let e=this.gamepads[t.gamepad.index];e.player!=null&&(e.player.dead=!0,e.player.dropFromGame=!0),delete this.gamepads[t.gamepad.index]}update_gamepad_states(){let t=navigator.getGamepads();if(t!=null)for(let e of t){if(e==null)continue;let s=this.gamepads[e.index];s.gamepad=e,s.set("dash",this.buttonPressed(e.buttons[0])),s.set("cycle",this.buttonPressed(e.buttons[1])||this.buttonPressed(e.buttons[6])),s.set("use",this.buttonPressed(e.buttons[2])||this.buttonPressed(e.buttons[7])),s.set("dodge",this.buttonPressed(e.buttons[5])),s.set("camera",this.buttonPressed(e.buttons[12])),s.set("menu",this.buttonPressed(e.buttons[9])),s.set("left",e.axes[0]<-s.thresh&&e.axes[0]<-.5*Math.abs(e.axes[1])),s.set("right",e.axes[0]>s.thresh&&e.axes[0]>.5*Math.abs(e.axes[1])),s.set("up",e.axes[1]<-s.thresh&&e.axes[1]<-.5*Math.abs(e.axes[0])),s.set("down",e.axes[1]>s.thresh&&e.axes[1]>-.5*Math.abs(e.axes[0]))}}buttonPressed(t){return typeof t=="object"?t.pressed:t==1}attach_all_to_player(t){for(let e of Object.keys(this.gamepads))this.gamepads[e].attach_to_player(t)}release_all_players(){for(let t of Object.keys(this.gamepads))this.gamepads[t].attach_to_player()}}class Ft extends ht{constructor(e){super();l(this,"canvas");this.game=e;const s=document.getElementById("canvas");if(s instanceof HTMLCanvasElement){this.canvas=s;let i=this;s.addEventListener("touchstart",function(a){i.process_touchstart(a)},!1),s.addEventListener("touchmove",function(a){i.process_touchmove(a)},!1),s.addEventListener("touchcancel",function(a){i.process_touchend(a)},!1),s.addEventListener("touchend",function(a){i.process_touchend(a)},!1),document.addEventListener("backbutton",function(a){i.process_back(a)},!0)}this.dPad=[-1,0,0],this.butJump=[-1,0,0],this.butInv=[-1,0,0],this.butUse=[-1,0,0],this.butCamera=[-1,0,0]}process_back(e){console.log("Back pressed",e),this.set("menu",!0)}process_touchstart(e){let s=this.canvas;e.touches[0];for(let i of e.changedTouches)i.clientX<.5*s.width?i.clientY>.33*s.height?this.dPad=[i.identifier,i.clientX,i.clientY]:(this.set("camera"),this.butCamera=[i.identifier,i.clientX,i.clientY]):i.clientY>.66*s.height?(this.set("jump"),this.butJump=[i.identifier,i.clientX,i.clientY]):i.clientY<.33*s.height?(this.set("cycle"),this.butInv=[i.identifier,i.clientX,i.clientY]):(this.set("use"),this.butUse=[i.identifier,i.clientX,i.clientY]);e.preventDefault()}process_touchmove(e){for(let s of e.changedTouches)if(s.identifier==this.dPad[0]){let i=this.dPad[1],a=this.dPad[2];for(let n of["left","right","up","down","run","camera"])this.set(n,!1);this.set("left",s.clientX<i-.1*this.game.tileSize&&s.clientX-i<-.5*Math.abs(s.clientY-a)),this.set("right",s.clientX>i+.1*this.game.tileSize&&s.clientX-i>.5*Math.abs(s.clientY-a)),this.set("up",s.clientY<a-.1*this.game.tileSize&&s.clientY-a<-.5*Math.abs(s.clientX-i)),this.set("down",s.clientY>a+.1*this.game.tileSize&&s.clientY-a>.5*Math.abs(s.clientX-i)),this.set("run",s.clientX<i-this.game.tileSize||s.clientX>i+this.game.tileSize||s.clientY>a+this.game.tileSize||s.clientY<a-this.game.tileSize)}e.preventDefault()}process_touchend(e){for(let s of e.changedTouches){if(s.identifier==this.dPad[0]){for(let i of["left","right","up","down"])this.set(i,!1);this.dPad=[-1,0,0]}s.identifier==this.butInv[0]&&this.set("cycle",!1),s.identifier==this.butUse[0]&&this.set("use",!1),s.identifier==this.butJump[0]&&this.set("jump",!1),s.identifier==this.butCamera[0]&&this.set("camera",!1)}e.preventDefault()}vibrate(e,s,i){window.navigator.vibrate(i)}}class O extends f{constructor(t,e=null,s=!0,i=!1){super([t[0],t[1],1,1]),this.sprite=e,this.passable=s,this.climbable=i,this.climbSpeed=1/300,this.hp=100}bounds(){return new f([this.x,this.y,1,1])}dist(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}draw(t){this.sprite!=null&&t.sprites.base.draw(this.sprite,this.x,this.y)}playerInteract(t,e,s){}entityInteract(t,e,s){}initItems(t){}hitFrom(t,e,s,i){}}class k extends O{constructor(t,e=null){super(t,e,!0,!1)}}function Bt(h){z.riverTimer+=h,z.riverSprite=[p.Water1,p.Water2,p.Water3,p.Water4][Math.floor(z.riverTimer/500)%4],E.lanternTimer+=h,E.lanternSprite=[y.Lantern1,y.Lantern2,y.Lantern3,y.Lantern4][Math.floor(E.lanternTimer/500)%4]}class it extends O{constructor(){super(...arguments);l(this,"passable",!1)}}class zt extends O{constructor(e,s=null){s===null&&(s=P([y.Tree1,y.Tree2]));super(e,s,!0,!1);l(this,"passable",!1)}draw(e){e.sprites.base.draw(p.Snow1,this.x,this.y),e.sprites.base.drawRotatedMultitile(this.sprite,this.x,this.y-1,0)}}class ot extends O{constructor(e,s=null){s===null&&(s=p.Hessian1);super(e,s,!0,!1);l(this,"passable",!1);this.hat=P([!1,!1,!1,!1,!0])}draw(e){e.sprites.base.draw(p.Snow1,this.x,this.y),e.sprites.base.draw(this.sprite,this.x,this.y),this.hat&&e.sprites.base.draw(p.HessianHelmet1,this.x,this.y-.5)}}const X=class X extends O{constructor(t,e=null){super(t,e,!1,!1)}draw(t){t.sprites.base.draw(p.Snow1,this.x,this.y),X.lanternSprite&&t.sprites.base.drawRotatedMultitile(X.lanternSprite,this.x,this.y-1,0)}};l(X,"lanternTimer",0),l(X,"lanternSprite");let E=X;const V=class V extends O{constructor(e,s=null){super(e,s,!0,!1);l(this,"passable",!1)}draw(e){e.sprites.base.draw(V.riverSprite,this.x,this.y)}};l(V,"riverTimer",0),l(V,"riverSprite");let z=V;class q extends O{constructor(t,e=null){e==null&&(e=P([p.Snow1,p.Snow1,p.Snow1,p.Snow1,p.Snow1,p.Snow1,p.Snow2,p.Snow3])),super(t,e,!0,!1)}draw(t){super.draw(t)}}class v extends O{constructor(t,e=null){e==null&&(e=P([p.RoadNS,p.RoadEW])),super(t,e,!0,!1)}draw(t){super.draw(t)}}class M{constructor(t,e){this.pos=new d([0,0]),this.vel=new d([0,0]),this.oldVel=new d([0,0]),this.angle=0,this.isPlayer=!1,this.size=new d([1,1]),this.boundingBox=new f([.25,.25,.5,.5]),this.boundingBoxes=[],this.facing=1,this.falling=!1,this.canFall=!0,this.dead=!1,this.sprite=e,this.hitBox=new f(this.boundingBox),t instanceof O||t===null?this.move(t):this.pos=new d(t),this.oldPos=new d(this.pos)}move(t){t!==null?this.pos=new d([t[0],t[1]]):this.pos=new d([-1,-1])}rotatedBoundingBox(t=null,e=null,s=null,i=null,a=null){s=s??this.getFlipped(),e=e??this.angle,t==null&&(t=this.sprite.length==2?[.5,.5]:[.5*this.sprite[2],.5*this.sprite[3]]),i==null&&(i=[this.boundingBox[0]+this.boundingBox[2]/2,this.boundingBox[1]+this.boundingBox[3]/2]),a==null&&(a=this.boundingBox.slice(2,4));let n=(i[0]-t[0])*(1-2*s),r=i[1]-t[1],c=Math.cos(e/180*Math.PI),u=Math.sin(e/180*Math.PI),w=-(n-n*c+r*u),x=-(r-n*u-r*c);return new f([(i[0]-t[0])*(1-2*s)+t[0]+w-a[0]/2,i[1]+x-a[1]/2,a[0],a[1]])}bounds(t=null,e=null){return t==null&&(t=this.pos),e==null&&(e=this.boundingBox!=null?this.boundingBox:this.boundingBoxes[0]),new f([t[0]+e[0],t[1]+e[1],e[2],e[3]])}hitBounds(t=null){return t==null&&(t=this.pos),new f([t[0]+this.hitBox[0],t[1]+this.hitBox[1],this.hitBox[2],this.hitBox[3]])}getDisplayX(){return this.pos.x}getDisplayY(){return this.pos.y}getFlipped(){return this.facing==-1}draw(t){t.sprites.base.draw([this.sprite[0],this.sprite[1]],this.getDisplayX(),this.getDisplayY(),this.getFlipped())}draw_bounds(t){if(this.boundingBox!=null){let e=this.bounds(this.pos,this.boundingBox);e[0]=e[0]*t.tileSize+t.shakeX+t.gameOffsetX,e[1]=e[1]*t.tileSize+t.shakeY+t.gameOffsetY,e[2]=e[2]*t.tileSize,e[3]=e[3]*t.tileSize,t.ctx.beginPath(),t.ctx.lineWidth=t.tileSize/16,t.ctx.strokeStyle="#BAC3D9",t.ctx.rect(e[0],e[1],e[2],e[3]),t.ctx.stroke()}else for(let e of this.boundingBoxes){let s=this.bounds(this.pos,e);s[0]=s[0]*t.tileSize+t.shakeX+t.gameOffsetX,s[1]=s[1]*t.tileSize+t.shakeY+t.gameOffsetY,s[2]=s[2]*t.tileSize,s[3]=s[3]*t.tileSize,t.ctx.beginPath(),t.ctx.lineWidth=t.tileSize/16,t.ctx.strokeStyle="#BAC3D9",t.ctx.rect(s[0],s[1],s[2],s[3]),t.ctx.stroke()}}entityInteract(t,e,s){}entityCollide(t,e){}update(t,e){}}class N extends M{constructor(t,e,s=1){super(t,e),this.hp=s,this.maxHp=s,this.facing=at(0,1)*2-1,this.topSpeed=1/600,this.jumpSpeed=1/350,this.maxFallSpeed=1/50,this.hitDamage=1,this.spawnTimer=1e3,this.spawnElapsed=0,this.stunTimer=new b(0,0),this.hitTimer=new b(0,0),this.boundingBox=new f([.25,.5,.5,.5]),this.hitBox=new f([.25,.2,.5,.8]),this.drone=!1,this.climbing=!1,this.falling=!1,this.dying=!1,this.intelLevel=1,this.elevation=0,this.stance="aggressive",this.playerFriendly=!1,this.destination=new d([0,0])}getDisplayY(){return super.getDisplayY()-this.elevation}draw(t){t.sprites.monsters.draw([this.dying?1:0,this.sprite[1]],this.getDisplayX(),this.getDisplayY(),this.getFlipped()),this.hitTimer.finished()||p.Strike.length===2&&t.sprites.entitiesItems.draw(p.Strike,this.getDisplayX(),this.getDisplayY(),this.getFlipped())}die(t){this.stun(),this.dying=!0}death(t){this.dead=!0,!this.isPlayer&&t.tiles.closestTile(this.bounds())instanceof k}heal(t){this.hp=Math.min(this.maxHp,this.hp+t)}tile_pos(){return new d([Math.round(this.pos.x),Math.ceil(this.pos.y)])}stun(t=2e3){this.dying||this.stunTimer.reset(t)}update(t,e){if(this.spawnElapsed+=e,this.spawnElapsed<this.spawnTimer)return;this.hitTimer.tick(e),this.stunTimer.tick(e);let s=!this.stunTimer.finished();if(!s&&this.dying){this.death(t);return}if(this.dying&&(this.vel=this.vel.scale(.9**(e/15))),this.stance==="fleeing"){const i=this.destination.subtract(this.pos),a=this.destination.dist(this.pos);this.vel=i.scale(this.topSpeed/a)}if(t.tiles.move(this,e),!s&&!this.playerFriendly)for(let i of t.activePlayers)i.hitBounds().collide(this.bounds())&&(i.hitFrom(t,this.pos,this.hitDamage,this.hitDamage),i.stun(500*this.hitDamage));this.pos.y>t.tiles.dimH+3&&this.die(t)}hitFrom(t,e,s,i=0){this.hp-=s,s>0&&this.hitTimer.reset(200),this.hp<=0&&this.die(t);const a=this.pos.dist(e);if(a>0){const n=this.pos.add(e.scale(-1)).scale(1/a);this.vel.x=i*1/200*n[0],this.vel.y=i*1/200*n[1]}this.falling=!0}tile_collide(t){return t.bounds.collide(this.bounds())}monster_collide(t){return t.bounds.collide(this.bounds())}fallCheck(t,e){return!1}}class Rt extends N{constructor(t){super(t,y.Rall1,1),this.hp=10,this.topSpeed=.5*this.topSpeed,this.fallOrigin=null,this.leapDestination=new d([0,0]),this.attackTimer=new b(1e4,Math.random()*5e3),this.stance="passive",this.immune=!0,this.boundingBox=new f([.75,1,1.5,2]),this.boundingBox=new f([.75,1,1.5,2])}draw(t){this.dead||(this.stance==="passive"?(t.sprites.base.drawRotatedMultitile(y.RallHorse1,this.getDisplayX()-1.25,this.getDisplayY()-2,0,this.getFlipped()),t.sprites.base.drawRotatedMultitile(y.RallHorsback,this.getDisplayX(),this.getDisplayY()-2,0,this.getFlipped())):this.stance==="preLeap"?(t.sprites.base.drawRotatedMultitile(y.RallHorse1,this.getDisplayX()-1.25,this.getDisplayY()-2,0,this.getFlipped()),t.sprites.base.drawRotatedMultitile(y.RallHorsback,this.getDisplayX(),this.getDisplayY()-2,0,this.getFlipped())):this.stance==="leap"?(t.sprites.base.drawRotatedMultitile(y.RallHorse1,this.getDisplayX()-1.25,this.getDisplayY()-2,0,this.getFlipped()),t.sprites.base.drawRotatedMultitile(y.RallHorsback,this.getDisplayX(),this.getDisplayY()-2,0,this.getFlipped())):this.stance==="postLeap"&&(t.sprites.base.drawRotatedMultitile(y.RallHorse1,this.getDisplayX()-1.25,this.getDisplayY()-2,0,this.getFlipped()),t.sprites.base.drawRotatedMultitile(y.RallHorsback,this.getDisplayX(),this.getDisplayY()-2,0,this.getFlipped())))}update(t,e){if(super.update(t,e),!this.dead)if(this.stance==="passive")this.attackTimer.tick(e),this.attackTimer.finished()&&(this.immune=!0,this.stance="preLeap",this.attackTimer.reset(1e3));else if(this.stance==="preLeap"){if(this.attackTimer.tick(e),this.attackTimer.finished()){this.stance="leap",this.attackTimer.reset(1e3);const[s,i]=t.nearestPlayer(this.pos);if(s!==null){let a=s.pos.dist(this.pos);a<=10?this.leapDestination=new d(s.pos):(this.leapDestination=this.pos.add(s.pos.subtract(this.pos).scale(10/a)),a=10),this.vel=this.leapDestination.subtract(this.pos).scale(1/1e3),this.attackTimer.reset(1e3*a/10),console.log("started leap dest",this.leapDestination,"cur",this.pos,a)}}}else if(this.stance==="leap"){this.attackTimer.tick(e);const s=this.attackTimer.elapsed/this.attackTimer.timer,i=2;this.elevation=-4*i*s*s+4*i*s,(this.vel.dist([0,0])<=1e-6||this.attackTimer.finished())&&(console.log("ended leap dest",this.leapDestination,"cur",this.pos),this.vel=new d([0,0]),this.stance="postLeap",this.attackTimer.reset(1e3),this.elevation=0)}else this.stance==="postLeap"&&(this.attackTimer.tick(e),this.attackTimer.finished()&&(this.immune=!1,this.stance="passive",this.attackTimer.reset(5e3),this.vel=new d([0,0])))}}class _ extends N{constructor(t,e=null,s=1,i=!1){super(t,p.Soldier1,1),this.playerFriendly=!0,this.hp=1,this.topSpeed=.5*this.topSpeed,this.fallOrigin=null,this.stance="passive",this.hat=i}draw(t){if(this.dead||this.dying){t.sprites.base.drawRotated(p.Soldier1,this.getDisplayX(),this.getDisplayY(),90,!this.getFlipped());return}p.Soldier1.length===2&&(t.sprites.base.draw(p.Soldier1,this.getDisplayX(),this.getDisplayY(),!this.getFlipped()),this.hat&&t.sprites.base.draw(p.SoldierHat,this.getDisplayX(),this.getDisplayY()-.5,!this.getFlipped()))}update(t,e){super.update(t,e)}}class tt extends N{constructor(t){super(t,p.Hessian1,1),this.hp=1,this.topSpeed=.5*this.topSpeed,this.fallOrigin=null,this.stance="passive",this.launchTimer=new b(1e4,Math.random()*5e3),this.launching=0,this.shoots=!0}draw(t){if(p.Hessian1.length===2){if(this.dead||this.dying){t.sprites.base.drawRotated(p.Hessian1,this.getDisplayX(),this.getDisplayY(),90,this.getFlipped());return}t.sprites.base.draw(p.Hessian1,this.getDisplayX(),this.getDisplayY(),this.getFlipped()),t.sprites.base.draw(p.HessianHelmet1,this.getDisplayX(),this.getDisplayY()-.5,this.getFlipped()),this.shoots&&t.sprites.base.draw(this.launchTimer.elapsed-this.launchTimer.timer>1e3?p.Rifle1:p.Rifle2,this.getDisplayX()+this.facing*.375,this.getDisplayY()+.25,!this.getFlipped())}}update(t,e){if(super.update(t,e),this.dead||this.dying)return;const s=t.activePlayers[0];if(!(this.pos.dist(s.pos)>20)&&(this.facing=s.pos[0]>this.pos[0]?1:-1,!!this.shoots&&(this.launchTimer.tick(e),this.launchTimer.finished()))){if(this.launching<=2){this.launchTimer.reset(500);const[i,a]=this.pos.scale(-1).add(s.pos);let n=Math.atan2(a,i)*180/Math.PI;n=Math.round(n/45)*45,t.items.push(new yt(t.tiles.at(this.tile_pos()),null,n))}else this.launching=0,this.launchTimer.reset(2e3-0*Math.random());this.launching++}}}class Ot extends N{constructor(t){super(t,p.Hessian1,1),this.hp=1,this.topSpeed=.5*this.topSpeed,this.fallOrigin=null,this.stance="passive",this.destination=new d(t.pos),this.launchTimer=new b(1e4,Math.random()*5e3),this.launching=0}draw(t){if(p.Hessian1.length===2){if(this.dead||this.dying){t.sprites.base.drawRotated(p.Hessian1,this.getDisplayX(),this.getDisplayY(),90,this.getFlipped());return}t.sprites.base.draw(p.Hessian1,this.getDisplayX(),this.getDisplayY(),this.getFlipped()),t.sprites.base.draw(this.launchTimer.elapsed-this.launchTimer.timer>1e3?p.Rifle1:p.Rifle2,this.getDisplayX()+this.facing*.375,this.getDisplayY()+.25,!this.getFlipped())}}update(t,e){if(super.update(t,e),this.dead||this.dying)return;const s=t.activePlayers[0];if(this.pos.dist(s.pos)>30&&!this.dead){this.stance==="fleeing"&&(this.dead=!0);return}if(this.pos.dist(s.pos)<10&&this.stance==="passive"&&!this.dead&&(this.stance="fleeing"),this.facing=s.pos[0]>this.pos[0]?1:-1,this.launchTimer.tick(e),this.launchTimer.finished()){if(this.launching<=2){this.launchTimer.reset(500);const[i,a]=this.pos.scale(-1).add(s.pos);let n=Math.atan2(a,i)*180/Math.PI;n=Math.round(n/45)*45,t.items.push(new yt(t.tiles.at(this.tile_pos()),null,n))}else this.launching=0,this.launchTimer.reset(2e3-0*Math.random());this.launching++}}}class Wt extends N{constructor(t){super(t,[0,0],1),this.hp=10,this.topSpeed=.5*this.topSpeed,this.fallOrigin=null,this.stance="passive",this.launchTimer=new b(1e3),this.launching=0,this.firingAngle=0,this.hitDamage=0,this.spawnTimer=0,this.facing=1}draw(t){t.sprites.base.drawRotatedMultitile(y.Cannon,this.getDisplayX()-1,this.getDisplayY(),0,this.getFlipped())}stun(t=2e3){}update(t,e){super.update(t,e),!this.dead&&(this.firingAngle+=e/15,this.firingAngle>=360&&(this.firingAngle=0),this.launchTimer.tick(e),this.launchTimer.finished()&&(t.items.push(new Yt(t.tiles.at(this.tile_pos()),null,this.firingAngle)),this.launchTimer.reset()))}hitFrom(t,e,s,i=0){this.hp-=s,s>0&&this.hitTimer.reset(200),this.hp<=0&&this.die(t)}}const G=0,dt=1,I=2,U=3,W=4,Z=5,D=6;class j extends N{constructor(e=-1,s=null){super(s,[0,e],3);l(this,"isPlayer",!0);l(this,"boundingBox",new f([.25,.5,.5,.5]));l(this,"hitBox",new f([.25,.25,.5,.5]));l(this,"dashBox",new f([0,0,1,1]));l(this,"immunityTimer",new b(1e3,1e3));l(this,"selectedTimer",new b(500,500));l(this,"dashTimer",new b(3e3,3e3));l(this,"hitTimer",new b(500,500));l(this,"stunTimer",new b(500,500));l(this,"jumpTimer",new b(0,0));l(this,"freeze",!1);l(this,"selectedSprite",null);l(this,"hidden",!1);l(this,"escaped",!1);l(this,"running",!1);l(this,"climbing",!1);l(this,"aiming",!1);l(this,"dropFromGame",!1);l(this,"startLevel",0);l(this,"lastVel",new d([0,0]));l(this,"dodgeOrigin",new d(this.pos));l(this,"boatOffset",new d([-2.5,0]));l(this,"holding","sword");l(this,"ridingBoat",!1);l(this,"maxHp",4);l(this,"topSpeed",1/250);l(this,"jumpSpeed",1/135);l(this,"maxFallSpeed",1/50);l(this,"airJumps",0);l(this,"wallJumps",0);l(this,"spikedBoots",0);l(this,"chips",0);l(this,"dead",!1);l(this,"score",0);l(this,"deaths",0);l(this,"pause",0);l(this,"lastFacing",0);l(this,"lastFramePos",new d([0,0]));l(this,"currentFrame",0);l(this,"useTimer",new b(0));l(this,"hookHitModifier",[]);l(this,"hookUpdate",[]);l(this,"activeState",W);l(this,"stateTimer",new b);l(this,"controller",null);this.controlStates={...st()},this.newControlStates={...st()},this.oldControlStates={...st()},this.sprite=[0,8],this.setAnimationFrames()}bounds(e=null){return e===null&&(e=this.pos),this.activeState===D?new f([this.pos.x-2.5,this.pos.y,3.5,1]):super.bounds(e)}dashBounds(){const e=this.vel.x>0?.5:this.vel.x<0?-.5:0,s=this.vel.y>0?.5:this.vel.y<0?-.5:0,i=[this.pos.x+e,this.pos.y+s];return this.dashBox.shift(i)}setAnimationFrames(){this.animationFrames={WALK_EW:[new d([1,0]),new d([4,0]),new d([4,0]),new d([3,0]),new d([3,0]),new d([2,0]),new d([2,0]),new d([1,0])],WALK_N:[new d([1,0]),new d([2,0]),new d([1,0]),new d([2,0])],WALK_S:[new d([1,0]),new d([2,0]),new d([1,0]),new d([2,0])],DASH_EW:[new d([1,0]),new d([2,0]),new d([2,0])],DASH_N:[new d([14,0]),new d([15,0]),new d([15,0]),new d([14,0])],DASH_S:[new d([12,0]),new d([13,0]),new d([13,0]),new d([12,0])],STAND:[new d([0,0])]}}cycleSprite(e){let s=e.other_players(this).map(i=>i.sprite[1]);for(;this.sprite[1]++,this.sprite[1]>=4&&(this.sprite[1]=0),!!s.includes(this.sprite[1]););this.setAnimationFrames()}die(e){if(this.dead)return;this.dead=!0,this.hp=0,this.deaths++;let s=P(["dead1","dead2","dead3","dead4","dead5","dead6","dead7","dead8"]);this.setState(e,Z),e.playSound(s)}boardBoat(e,s){this.enterState(e,D),this.pos=s.pos.subtract(this.boatOffset).add([3,0])}enterState(e,s){switch(s){case D:case I:{const i=this.dashTimer.finished()?.01:.004;this.vel.x>0&&(this.vel.x=1),this.vel.x<0&&(this.vel.x=-1),this.vel.y>0&&(this.vel.y=1),this.vel.y<0&&(this.vel.y=-1);const a=this.vel.dist([0,0]);a>0&&(this.vel=this.vel.scale(i/a));break}}this.activeState=s}exitState(e,s){}updateState(e,s){switch(this.activeState){case W:case G:if(this.entityInteract(e),this.stunTimer.finished()){if(this.moveCheck(e,s,this.running),this.cycleInventoryCheck(e,s),this.vel.x!==0||this.vel.y!==0){if(!this.oldControlStates.dodge&&this.controlStates.dodge){this.setState(e,U),this.dodgeOrigin=new d(this.pos);return}else if(!this.oldControlStates.dash&&this.controlStates.dash){this.setState(e,I),this.dashTimer.reset();return}}this.activeState===W&&this.setState(e,G)}this.vel.x===0&&this.vel.y===0&&this.activeState===G&&this.setState(e,W),this.tileInteract(e,s);break;case dt:this.stunTimer.finished()&&(this.entityInteract(e),this.setState(e,G),this.stunTimer.finished()&&(this.moveCheck(e,s,!1),this.cycleInventoryCheck(e,s)),this.tileInteract(e,s)),!this.jumpTimer.finished()&&this.vel.y<0&&!this.controlStates.dash&&(this.vel.y*=.5**(s/15));break;case I:this.entityInteract(e);for(let i of e.monsters)i.hitBounds().collide(this.dashBounds())&&(i.hitFrom(e,this.pos,1,2),i.stun());this.stateTimer.elapsed>100&&this.setState(e,W);break;case U:this.entityInteract(e),this.stunTimer.finished()&&(this.moveCheck(e,s,!0),this.cycleInventoryCheck(e,s)),!this.oldControlStates.dash&&this.controlStates.dash&&(this.vel.x!==0||this.vel.y!==0)&&this.setState(e,I),this.tileInteract(e,s),this.stateTimer.elapsed>500&&this.setState(e,W);break;case Z:this.driftCheck(e,s,!1);break;case D:this.facing=1,!this.oldControlStates.left&&this.controlStates.left&&(this.vel.x=-1/400,this.vel.y=0),!this.oldControlStates.right&&this.controlStates.right&&(this.vel.x=1/200,this.vel.y=0),!this.oldControlStates.up&&this.controlStates.up&&(this.vel.y=-1/800,this.vel.x=0),!this.oldControlStates.down&&this.controlStates.down&&(this.vel.y=1/400,this.vel.x=0),this.entityInteract(e),this.vel.y=this.vel.y*.99,this.vel.x=this.vel.x*.99;break}}revive(e){this.dead=!1,this.setState(e,G),this.hp=e.competitiveMode?this.maxHp:1}hitFrom(e,s,i,a=0){if(!this.dead&&!this.escaped&&this.activeState!==U&&this.immunityTimer.finished()){for(let n of this.hookHitModifier)[i,a]=n.hitModifier(i,a);super.hitFrom(e,s,i,a),this.immunityTimer.reset(),e.playSound("hit1")}}use(e,s){this.useTimer.reset(s)}draw(e){if(this.hidden)return;const s=this.activeState===I?this.animationFrames.DASH_EW:this.animationFrames.WALK_EW;let i=this.getFlipped();if(this.escaped)return;let a=[0,0];if(this.dead?(a=[0,a[1]],this.currentFrame=0,this.lastFramePos=new d(this.pos)):this.activeState===dt?(a=[0,a[1]],this.currentFrame=0,this.lastFramePos=new d(this.pos)):this.activeState===W?(a=p.Washington1,this.currentFrame=0,this.lastFramePos=new d(this.pos)):this.activeState===U?(a=p.WashingtonDodge,this.currentFrame=0,this.lastFramePos=new d(this.pos)):(this.facing!==this.lastFacing?(this.currentFrame=0,this.lastFramePos=new d(this.pos)):this.pos.dist(this.lastFramePos)*4>=1&&(this.currentFrame+=Math.floor(this.pos.dist(this.lastFramePos)*4),this.lastFramePos=new d(this.pos)),this.currentFrame=this.currentFrame%s.length,a=s[this.currentFrame]),this.activeState===U){if(e.ctx.globalAlpha=.75,this.vel.x===0){if(this.vel.y<0){const n=this.dodgeOrigin.y-this.pos.y;e.sprites.base.drawRotatedMultitile([20,4.5-n,1,.5+n],this.pos.x,this.pos.y+.5,0,!i)}else if(this.vel.y>0){const n=this.pos.y-this.dodgeOrigin.y;e.sprites.base.drawRotatedMultitile([21,1,1,.5+n],this.pos.x,this.dodgeOrigin.y,0,!i)}}else if(this.vel.x>0){const n=Math.min(this.pos.x-this.dodgeOrigin.x,3.5);e.sprites.base.drawRotatedMultitile([24.5-n,0,.5+n,1],this.dodgeOrigin.x,this.pos.y,this.vel.y<0?-20:this.vel.y>0?20:0,!i)}else if(this.vel.x<0){const n=Math.min(this.dodgeOrigin.x-this.pos.x,3.5);e.sprites.base.drawRotatedMultitile([24.5-n,0,.5+n,1],this.pos.x+.5,this.pos.y,this.vel.y<0?20:this.vel.y>0?-20:0,!i)}e.ctx.globalAlpha=1}if(this.activeState===D){e.sprites.base.drawRotatedMultitile(y.BoatBack,this.getDisplayX()+this.boatOffset.x,this.getDisplayY()+this.boatOffset.y,0,i);for(let n=0;n<4;n++)e.sprites.base.draw(p.Soldier1,this.getDisplayX()-2+n/2,this.getDisplayY(),!i);a=p.Washington1}if(this.activeState===Z)e.sprites.base.drawRotated([a[0],a[1]],this.getDisplayX(),this.getDisplayY(),i?270:90,!i);else if(e.sprites.base.draw([a[0],a[1]],this.getDisplayX(),this.getDisplayY(),!i),this.activeState===I){const n=this.currentFrame===0?this.facing*.25:this.facing*.5;e.sprites.base.draw(this.currentFrame===0?p.Sword2:p.Sword3,this.getDisplayX()+n,this.getDisplayY(),!i)}else{const n=this.facing*.5;e.sprites.base.draw(p.Sword1,this.getDisplayX()+n,this.getDisplayY(),!i)}this.hitTimer.finished()||p.Strike.length===2&&e.sprites.base.draw(p.Strike,this.getDisplayX(),this.getDisplayY(),!this.getFlipped()),this.activeState===D&&e.sprites.base.drawRotatedMultitile(y.BoatFront,this.getDisplayX()+this.boatOffset.x,this.getDisplayY()+this.boatOffset.y,0,i),this.lastFacing=this.facing}drawHUD(e,s){p.Health.length===2&&e.sprites.base.draw(p.Health,s.x,s.y),e.drawTileText(""+Math.ceil(this.hp),.5*e.tileSize,s.add([0,-.5]),"White")}update(e,s){if(!this.escaped){new d(this.vel),new d(this.pos),this.immunityTimer.tick(s),this.stateTimer.tick(s),this.jumpTimer.tick(s),this.hitTimer.tick(s),this.useTimer.tick(s),this.stunTimer.tick(s),this.selectedTimer.tick(s),this.dashTimer.tick(s),this.updateState(e,s);for(let i of this.hookUpdate)i.update(e,s,this);this.activeState!=Z&&this.pos.y>e.tiles.dimH+3&&this.die(e),this.lastVel=new d(this.vel),this.activeState!==D?this.freeze||e.tiles.move(this,s):this.activeState===D?this.freeze||e.tiles.moveBoat(this,s):this.pos=this.pos.add(this.vel.scale(15/s)),this.activeState===D&&(this.lastVel.x!==this.vel.x||this.lastVel.y!==this.vel.y)&&(this.pos=this.pos.add([3,0]),e.tiles.closestTile(new f([this.pos[0],this.pos[1],1,1]))instanceof q&&(this.setState(e,W),e.items.push(new H(e.tiles.at(this.pos.subtract([6,0]).map(Math.ceil))))))}}driftCheck(e,s,i){const a=15625e-8;this.vel.x=this.vel.x>0?Math.max(this.vel.x-a*s/15,0):Math.min(this.vel.x+a*s/15,0),this.vel.y=this.vel.y>0?Math.max(this.vel.y-a*s/15,0):Math.min(this.vel.y+a*s/15,0)}moveCheck(e,s,i){this.controlStates.left?(this.vel.x=Math.max(-this.topSpeed*(i?2:1),this.vel.x-1/1600*s/15),this.facing=-1):!i&&this.vel.x<0&&(this.vel.x=0),this.controlStates.right?(this.vel.x=Math.min(this.topSpeed*(i?2:1),this.vel.x+1/1600*s/15),this.facing=1):!i&&this.vel.x>0&&(this.vel.x=0),this.controlStates.up?this.vel.y=Math.max(-this.topSpeed*(i?2:1),this.vel.y-1/1600*s/15):!i&&this.vel.y<0&&(this.vel.y=0),this.controlStates.down?this.vel.y=Math.min(this.topSpeed*(i?2:1),this.vel.y+1/1600*s/15):!i&&this.vel.y>0&&(this.vel.y=0)}cycleInventoryCheck(e,s){this.controlStates.cycle&&this.oldControlStates.cycle}entityInteract(e){for(let s=0;s<e.items.length;s++)this.bounds().collide(e.items[s].bounds())&&(e.items[s].entityCollide(e,this),this.aiming||(this.controlStates.up&&e.items[s].entityInteract(e,this,"up"),this.controlStates.down&&e.items[s].entityInteract(e,this,"down")))}tileInteract(e,s){if(this.controlStates.up){let i=e.tiles.closestTile(this.bounds());i instanceof k||i.entityInteract(e,this,"up")}if(this.controlStates.down){let i=e.tiles.closestTile(this.bounds());if(!(i instanceof k)){i.entityInteract(e,this,"down");let a=e.tiles.below(i.pos);!(a instanceof k)&&a.tile.y==this.bounds().bottom&&a.tile.entityInteract(e,this,"down")}}}setState(e,s){this.exitState(e,this.activeState),this.enterState(e,s),this.stateTimer.reset()}}class At extends M{constructor(t,e=null){e==null&&(e=P([y.Tree1,y.Tree2])),super(t,e)}entityCollide(t,e){if(e.isPlayer){const[s,i,a,n]=e.bounds(),[r,c,u,w]=this.bounds(),x=Math.min(s+a-r,r+u-s),T=Math.min(i+n-c,c+w-i);x>0&&T>0&&(x<=T?e.pos[0]+=s<r?-x:x:e.pos[1]+=i<c?-T:T),e.vel[0]=0,e.vel[1]=0}}bounds(){return new f([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){t.sprites.base.drawRotatedMultitile(this.sprite,this.pos[0]-.5,this.pos[1]-1,0,!1)}}class H extends M{constructor(t,e=null){e==null&&(e=P([y.Tree1,y.Tree2])),super(t,e),this.boardable=!1}entityCollide(t,e){this.boardable&&e instanceof j&&e.bounds().collide(this.bounds())&&!this.dead&&t.activeChapter===0&&t.chapters[t.activeChapter].activeObjective===2&&(e.vel[0]=0,e.vel[1]=0,e.boardBoat(t,this),this.dead=!0)}bounds(){return new f([this.pos[0],this.pos[1],4,1])}draw(t){t.sprites.base.drawRotatedMultitile(y.BoatBack,this.pos[0],this.pos[1],0,!1),t.sprites.base.drawRotatedMultitile(y.BoatFront,this.pos[0],this.pos[1],0,!1)}}class B extends M{constructor(t,e=null){e==null&&(e=P([p.Iceberg1,p.Iceberg2,p.Iceberg3])),super(t,e),this.vel.x=1/200,this.vel.y=1/100}entityCollide(t,e){if(e instanceof j&&e.bounds().collide(this.bounds())){e.vel[0]=1/200,e.vel[1]=1/100;const s=new d([Math.round(e.pos.x),Math.round(e.pos.y)]);t.items.push(new B(s.add([2,1]),p.SoldierIcecube)),t.items.push(new B(s.add([1,2]),p.SoldierIcecube)),t.items.push(new B(s.add([0,1]),y.BoatVerticle1)),t.items.push(new B(s.add([-1,2]),p.SoldierIcecube)),t.items.push(new B(s.add([-2,1]),p.SoldierIcecube)),e.die(t),e.hidden=!0}}update(t,e){super.update(t,e),this.pos=this.pos.add(this.vel.scale(e/15)),(this.pos.x<-1||this.pos.y<-1||this.pos.x>t.tiles.dimW||this.pos.y>t.tiles.dimH)&&(this.dead=!0)}bounds(){return new f([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){this.sprite.length===2?t.sprites.base.draw(this.sprite,this.pos[0],this.pos[1]):t.sprites.base.drawRotatedMultitile(this.sprite,this.pos[0]-(this.sprite[2]-1)/2,this.pos[1]-this.sprite[3]+1,0,!1)}}class _t extends M{constructor(t,e=null){e==null&&(e=p.StoneHighlighted),super(t,e)}entityCollide(t,e){}bounds(){return new f([this.pos[0]+.2,this.pos[1]+.2,.6,.2])}}class K extends M{constructor(t,e=null){e==null&&(e=P([y.HouseBlue,y.HouseRed])),super(t,e)}entityCollide(t,e){if(e.isPlayer){const[s,i,a,n]=e.bounds(),[r,c,u,w]=this.bounds(),x=Math.min(s+a-r,r+u-s),T=Math.min(i+n-c,c+w-i);x>0&&T>0&&(x<=T?e.pos[0]+=s<r?-x:x:e.pos[1]+=i<c?-T:T),e.vel[0]=0,e.vel[1]=0}}bounds(){return new f([this.pos[0],this.pos[1]+2,8,4.5])}draw(t){t.sprites.base.drawRotatedMultitile(this.sprite,this.pos[0],this.pos[1],0,!1)}}class Lt{constructor(){l(this,"flakes",[]);l(this,"maxFlakes",100);l(this,"fallSpeed",1/100);l(this,"xySpeed",1/200);l(this,"xWind",0);l(this,"yWind",0);l(this,"sprite",p.SnowFlake1)}reset(){this.flakes=[]}changeMode(t){t==="clear"?(this.flakes=[],this.maxFlakes=0):t==="snow"?(this.flakes=[],this.sprite=p.SnowFlake1,this.fallSpeed=1/50,this.maxFlakes=50,this.xySpeed=1/200,this.xWind=0):t==="heavySnow"?(this.flakes=[],this.sprite=p.SnowFlake1,this.fallSpeed=1/30,this.maxFlakes=150,this.xySpeed=1/50,this.xWind=-1/20):(this.flakes=[],this.sprite=p.Sleet,this.fallSpeed=1/3,this.xySpeed=0,this.xWind=-1/30)}update(t,e){const s=new f([t.camera.x,t.camera.y,t.camera.w,t.camera.h]);for(let i of this.flakes)i[0]<s.x&&(i[0]+=s.w),i[0]>s.right&&(i[0]-=s.w),i[1]<s.y&&(i[1]+=s.h),i[1]>s.bottom&&(i[1]-=s.h),i[2]-=(.5+.5*Math.random())*15/e*this.fallSpeed,i[1]+=(Math.random()-.5)*15/e*this.xySpeed+15/e*this.yWind,i[0]+=(Math.random()-.5)*15/e*this.xySpeed+15/e*this.xWind;for(this.flakes=this.flakes.filter(i=>i[2]>=0);this.flakes.length<this.maxFlakes;)this.flakes.push([s.x+Math.random()*s.w,s.y+Math.random()*s.h,Math.random()*s.h])}draw(t,e){for(let s of this.flakes)t.sprites.base.draw(this.sprite,s[0],s[1]-s[2])}}class yt extends M{constructor(t,e=null,s){super(t,p.OrangeBullet),this.vel[0]=Math.cos(s*Math.PI/180)*1/150,this.vel[1]=Math.sin(s*Math.PI/180)*1/150,this.angle=s}entityCollide(t,e){e.isPlayer&&(e.hitFrom(t,this.pos,1,1),this.dead=!0)}update(t,e){super.update(t,e),t.tiles.move(this,e,this.vel.scale(e/15)),(this.pos.x<-1||this.pos.y<-1||this.pos.x>t.tiles.dimW||this.pos.y>t.tiles.dimH||this.vel.dist([0,0])===0)&&(this.dead=!0)}bounds(){return new f([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){this.sprite.length===2&&t.sprites.base.drawRotated(this.sprite,this.pos[0],this.pos[1],this.angle+180)}}class It extends M{constructor(t,e=null,s=0){super(t,p.HessianLB1),this.vel[0]=Math.cos(s*Math.PI/180)*1/100,this.vel[1]=Math.sin(s*Math.PI/180)*1/100,this.angle=s}entityCollide(t,e){e.isPlayer&&(e.hitFrom(t,this.pos,1,1),this.dead=!0)}update(t,e){super.update(t,e),t.tiles.move(this,e,this.vel.scale(e/15)),(this.pos.x<-1||this.pos.y<-1||this.pos.x>t.tiles.dimW||this.pos.y>t.tiles.dimH||this.vel.dist([0,0])===0)&&(this.dead=!0)}bounds(){return new f([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){this.sprite.length===2&&t.sprites.base.draw(this.sprite,this.pos[0],this.pos[1])}}class Yt extends M{constructor(t,e=null,s){super(t,p.CannonBall);const i=Math.cos(s*Math.PI/180),a=Math.sin(s*Math.PI/180);this.vel[0]=i*1/20,this.vel[1]=a*1/20,this.pos[0]+=i,this.pos[1]+=a,this.angle=s}entityCollide(t,e){e.isPlayer&&(e.hitFrom(t,this.pos,1,1),this.dead=!0)}update(t,e){super.update(t,e),this.pos=this.pos.add(this.vel.scale(e/15)),(this.pos.x<-1||this.pos.y<-1||this.pos.x>t.tiles.dimW||this.pos.y>t.tiles.dimH)&&(this.dead=!0)}bounds(){return new f([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){this.sprite.length===2&&t.sprites.base.drawRotated(this.sprite,this.pos[0],this.pos[1],this.angle+90)}}class Xt extends M{constructor(t,e=1){super(t,p.Sausage),this.value=e}entityCollide(t,e){t.score++,e instanceof j&&(t.playSound("pickup2"),e.hp<e.maxHp&&e.hp++,this.dead=!0)}entityInteract(t,e,s){!this.dead&&e instanceof j&&(e.hp<e.maxHp&&e.hp++,t.score++,t.playSound("pickup2"),this.dead=!0)}}class Et extends M{constructor(t,e){super(t,[1,e.sprite[1]]),this.elapsed=0,this.timer=3e3}update(t,e){this.elapsed+=e,this.elapsed>this.timer&&(this.dead=!0)}draw(t){this.sprite.length===2&&t.sprites.players.draw(this.sprite,this.getDisplayX(),this.getDisplayY(),this.getFlipped())}}class jt extends M{constructor(t,e){super(null,null),this.sound=t,this.delay=e,this.elapsed=0}update(t,e){this.elapsed+=e,this.elapsed>this.delay&&(t.playSound(this.sound),this.dead=!0)}draw(){}}class Nt extends M{constructor(t,e=250){super(t,p.Boom),this.timer=e,this.elapsed=0}update(t,e){if(this.elapsed+=e,this.elapsed>=this.timer){this.dead=!0;let s=t.tiles.get(this.pos);s instanceof q||s.replace(q)}}}class Gt extends M{constructor(t){super(null,p.TrapBlade),this.platform=t,this.triggered=!1,t.type=="static"?this.pos=new d(this.platform.shift([0,-1])):this.pos=new d(this.platform),this.facing=1,this.boundingBox=new f([.125,.25,.75,.75]),this.elapsed=0}update(t,e){let s=this.platform;if(t.tiles.at(s.pos)!=s&&(this.dead=!0),this.elapsed+=e,s.type=="contact")if(this.pos.y==s.y&&this.vel.y==0){for(let a of t.activePlayers)if(a.bounds().collide(t.tiles.at(s).shift([0,-1]))){this.vel.y=-1/s.extendTime,this.elapsed=0;break}}else this.pos.y==s.y-1&&this.elapsed>=s.extendedTime&&(this.vel.y=1/s.extendTime,this.elapsed=0);else s.type=="cycling"&&(this.pos.y==s.y-1&&this.elapsed>=s.extendedTime&&(this.vel.y=1/s.extendTime,this.elapsed=0),this.pos.y==s.y&&this.elapsed>=s.retractedTime&&(this.vel.y=-1/s.extendTime,this.elapsed=0));for(let a of t.monsters_and_players())this.bounds().collide(a.bounds())&&(a.hitFrom(t,this.pos,s.damage,1),a.isPlayer||a.stun(500));let i=this.elapsed>s.contactDelay||s.type!=="contact"?this.vel.y:0;this.pos.y=Math.min(Math.max(this.pos.y+i*e,s.y-1),s.y),(this.pos.y==s.y-1&&this.vel.y<0||this.pos.y==s.y&&this.vel.y>0)&&(this.vel.y=0)}drawAsTile(t){this.sprite.length===2&&t.sprites.entitiesItems.draw(this.sprite,this.getDisplayX(),this.getDisplayY(),this.getFlipped())}draw(t){}}function o(h,t){return[h,t]}function S(h,t,e,s){return[h,t,e,s]}class Ut{constructor(t,e,s=16){this.spriteSize=s,this.sheet=new Image,this.sheet.src=e,this.game=t}draw(t,e,s,i=!1){let a=i?-1:1;i&&this.game.ctx.scale(-1,1),this.game.ctx.drawImage(this.sheet,t[0]*this.spriteSize,t[1]*this.spriteSize,this.spriteSize,this.spriteSize,a*(e*this.game.tileSize+this.game.shakeX+this.game.gameOffsetX),s*this.game.tileSize+this.game.shakeY+this.game.gameOffsetY,a*this.game.tileSize,this.game.tileSize),i&&this.game.ctx.scale(-1,1)}drawScaled(t,e,s,i,a=!1){let n=a?-1:1;a&&this.game.ctx.scale(-1,1),this.game.ctx.drawImage(this.sheet,t[0]*this.spriteSize,t[1]*this.spriteSize,this.spriteSize,this.spriteSize,n*Math.floor(e*this.game.tileSize+this.game.shakeX+this.game.gameOffsetX),Math.floor(s*this.game.tileSize+this.game.shakeY+this.game.gameOffsetY),n*this.game.tileSize*i,this.game.tileSize*i),a&&this.game.ctx.scale(-1,1)}drawRotated(t,e,s,i,a=!1,n="center"){const r=this.game;r.ctx.save(),n=="center"?n=[r.tileSize/2,r.tileSize/2]:n=[Math.floor(n[0]*r.tileSize),Math.floor(n[1]*r.tileSize)],r.ctx.translate(Math.floor(e*r.tileSize+r.shakeX+r.gameOffsetX+n[0]),Math.floor(s*r.tileSize+r.shakeY+r.gameOffsetY+n[1])),r.ctx.rotate(i*Math.PI/180),a&&r.ctx.scale(-1,1),r.ctx.translate(-n[0],-n[1]),r.ctx.drawImage(this.sheet,t[0]*this.spriteSize,t[1]*this.spriteSize,this.spriteSize,this.spriteSize,0,0,r.tileSize,r.tileSize),r.ctx.restore()}drawRotatedMultitile(t,e,s,i,a=!1,n="center"){const r=this.game;r.ctx.save();let c=t[2],u=t[3];n=="center"?n=[c*r.tileSize/2,u*r.tileSize/2]:n=[Math.floor(n[0]*r.tileSize),Math.floor(n[1]*r.tileSize)],r.ctx.translate(Math.floor(e*r.tileSize+r.shakeX+r.gameOffsetX+n[0]),Math.floor(s*r.tileSize+r.shakeY+r.gameOffsetY+n[1])),r.ctx.rotate(i*Math.PI/180),a&&r.ctx.scale(-1,1),r.ctx.translate(-n[0],-n[1]),r.ctx.drawImage(this.sheet,t[0]*this.spriteSize,t[1]*this.spriteSize,this.spriteSize*c,this.spriteSize*u,0,0,r.tileSize*c,r.tileSize*u),r.ctx.restore()}}const p=Object.freeze({Health:o(12,0),Snow1:o(0,4),Snow2:o(1,4),Snow3:o(2,4),Snow4:o(3,4),ShoreSW:o(4,4),ShoreNE:o(6,4),ShoreS:o(5,4),ShoreN:o(7,4),RoadNS:o(4,5),RoadEW:o(5,5),Water1:o(0,5),Water2:o(1,5),Water3:o(2,5),Water4:o(3,5),Iceberg1:o(0,6),Iceberg2:o(1,6),Iceberg3:o(2,6),SnowFlake1:o(3,6),SnowFlake2:o(4,6),Sleet:o(5,6),CannonBall:o(7,3),RedBullet:o(8,3),OrangeBullet:o(9,3),PiercingBullet:o(10,3),Cheese:o(12,1),Sausage:o(13,1),StoneHighlighted:o(42,0),Stone:o(43,0),Sword1:o(30,0),Sword2:o(31,0),Sword3:o(32,0),Pistol1:o(33,0),Pistol2:o(34,0),Pistol3:o(35,0),Pistol4:o(36,0),Pistol5:o(38,0),Pistol6:o(39,0),Pistol7:o(40,0),Pistol8:o(41,0),HessianHelmet1:o(10,1),HessianHelmet2:o(11,1),Rifle1:o(10,2),Rifle2:o(11,2),Washington1:o(0,0),Washington2:o(1,0),Washington3:o(2,0),Washington4:o(3,0),Washington5:o(4,0),Washington6:o(5,0),WashingtonDodge:o(20,0),WashingtonSunglasses:o(9,0),Soldier1:o(0,1),Soldier2:o(1,1),Soldier3:o(2,1),Soldier4:o(3,1),Soldier5:o(4,1),SoldierFall:o(5,1),SoldierIcecube:o(6,1),SoldierDead:o(7,1),SoldierHat:o(9,1),Hessian1:o(0,2),Hessian2:o(1,2),Hessian3:o(2,2),Hessian4:o(3,2),Hessian5:o(4,2),HessianDaed:o(5,2),HessianLB1:o(11,3),HessianLB2:o(12,3),HessianLB3:o(13,3),HessianLB4:o(14,3),HessianLB5:o(15,3),HessianLB6:o(16,3),HessianLBSword:o(17,3),HessianLBRifle:o(18,3),Empty:o(15,15),BeachUpper:o(4,0),BeachLower:o(5,0),Water:o(6,0),Jelly:o(11,1),Cannonball:o(13,2),Wall:o(8,0),WallEnd:o(9,0),Pillar1:o(6,1),Pillar2:o(7,1),Pillar3:o(8,1),Slash:o(10,7),Strike:o(10,7),Cutlas:o(11,7),Crab:o(6,4),Chips:o(16,0),Treasure:o(16,0),Boot1:o(16,0),Boot2:o(16,0),Boot3:o(16,0),Boom:o(16,0),Key:o(16,0),Pickup1:o(16,0),Pickup2:o(16,0),Shot1:o(15,0),Shot2:o(16,0),Shot3:o(16,0),LiveGrenade:o(16,0),Frag:o(16,0),LiveRocket:o(16,0),Drone1:o(16,0),LiveVibroBlade:o(16,0),Reticle:o(16,0),TrapBlade:o(16,0),Floor:o(16,0),Ledge:o(16,0),LockedExit:o(16,0),Exit:o(16,0),TrapBlock:o(16,0)}),y=Object.freeze({Rall1:S(1,13,1,2),RallHorsback:S(3,13,1,2),RallHorse1:S(0,10,3,3),BoatBack:S(0,9,4,1),BoatFront:S(4,9,4,1),BoatVerticle1:S(10,8,1,2),BoatVerticle2:S(12,8,1,2),Lantern1:S(3,7,1,2),Lantern2:S(4,7,1,2),Lantern3:S(5,7,1,2),Lantern4:S(6,7,1,2),Tree1:S(0,7,1,2),Tree2:S(1,7,1,2),Cannon:S(12,5,2,1),CanonNS:S(14,3,1,2),CanonEW:S(12,4,2,1),House1:S(0,16,3,3),House2:S(3,16,3,3),House3:S(6,16,3,3),BigHouseBlue:S(1,22,11,10),BigHouseRed:S(13,22,11,10),HouseBlue:S(25,22,8,7),HouseRed:S(34,22,8,7)});class L{constructor(t,e,s){this.tilemap=t,this.tile=e,this.pos=s}move(t,e){const s=new d([this.pos[0]+t,this.pos[1]+e]),i=this.tilemap.at(s);return new L(this.tilemap,i,s)}left(){return this.move(-1,0)}right(){return this.move(1,0)}above(){return this.move(0,-1)}below(){return this.move(0,1)}replace(t,...e){return this.tilemap.set(this.pos,t,...e),this.tile=t,this}getNeighbor(t,e){return this.move(t,e)}getAdjacentNeighbors(){return ft([this.getNeighbor(0,-1),this.getNeighbor(0,1),this.getNeighbor(-1,0),this.getNeighbor(1,0)])}getAdjacentPassableNeighbors(){return this.getAdjacentNeighbors().filter(t=>t.tile.passable)}getConnectedTiles(){let t=[this],e=[this];for(;e.length;){let s=e.pop().getAdjacentPassableNeighbors().filter(i=>!t.includes(i));t=t.concat(s),e=e.concat(s)}return t}}class Kt{constructor(t,e){const s=new d([0,0]);this.startTile=new k(s),this.endTile=new k(s),this.dimW=t,this.dimH=e,this.array=[];for(let i=0;i<t;i++){this.array[i]=[];for(let a=0;a<e;a++)this.array[i][a]=new O([i,a])}}isValidPos(t){return t!=null&&t[0]>=0&&t[0]<this.dimW&&t[1]>=0&&t[1]<this.dimH}at(t){return this.isValidPos(t)?this.array[t[0]][t[1]]:new k(t)}get(t){const e=new d(t),s=this.at(e);return new L(this,s,e)}set(t,e,...s){if(!this.isValidPos(t))return null;let i=new e(t,...s);return this.array[t[0]][t[1]]=i,i}fillRect(t,e){for(let s of this.iterRectPos(t))this.set(s,e)}fillLine(t,e,s){const i=new d(t),a=new d(e),n=a[0]-i[0],r=a[1]-i[1],c=Math.max(Math.abs(n),Math.abs(r));for(let u=0;u<=c;u++){const w=new d([i[0]+n*u/c,i[1]+r*u/c]).map(Math.floor);this.set(w,s)}}fillCircle(t,e,s){for(let i of this.iterRange(t,e))this.set(i.pos,s)}leftOf(t){return new L(this,this.at([t[0],t[1]]),t).left()}rightOf(t){return new L(this,this.at([t[0],t[1]]),t).right()}above(t){return new L(this,this.at([t[0],t[1]]),t).above()}below(t){return new L(this,this.at([t[0],t[1]]),t).below()}*iterAllPos(){for(let t=0;t<this.dimW;t++)for(let e=0;e<this.dimH;e++)yield new d([t,e])}*iterRectPos(t){for(let e=Math.max(t.x,0);e<Math.min(t.right,this.dimW);e++)for(let s=Math.max(t.y,0);s<Math.min(t.bottom,this.dimH);s++)yield new d([e,s])}*iterAll(){for(let t=0;t<this.dimW;t++)for(let e=0;e<this.dimH;e++)yield this.at([t,e])}*iterRect(t){for(let e=t.x;e<t.right;e++)for(let s=t.y;s<t.bottom;s++){let i=this.at([e,s]);i instanceof k||(yield i)}}*iterRectBorder(t){for(let e=t.x;e<t.right;e++){let s=this.at([e,t.y]);s instanceof k||(yield s),s=this.at([e,t.bottom-1]),s instanceof k||(yield s)}for(let e=t.y;e<t.bottom;e++){let s=this.at([t.x,e]);s instanceof k||(yield s),s=this.at([t.right-1,e]),s instanceof k||(yield s)}}*iterRange(t,e){for(let s=Math.floor(t[0]-e);s<=Math.ceil(t[0]+e);s++)for(let i=Math.floor(t[1]-e);i<=Math.ceil(t[1]+e);i++)if(Math.hypot(t[0]-s,t[1]-i)<=e){let a=this.at([s,i]);a instanceof k||(yield a)}}*colliders(t){for(let e of this.iterRange([t.center_x-.5,t.center_y-.5],1.5))e.collide(t)&&(yield e)}*contacters(t){for(let e of this.iterRange([t.center_x-.5,t.center_y-.5],1.5))e.contact(t)&&(yield e)}*iterRandom(t=null,e=null,s=null,i=1){let a=t==null?this.iterAllPos():this.iterRectPos(t);for(let n of ft(Array.from(a)))(e==null||this.at(n)instanceof e)&&(s==null||!(this.numNeighbors(n,s)<=i))&&(yield n)}hasNeighbors(t,e){for(let s of this.iterRange(t,1.5))if(this.at(s.pos)instanceof e)return!0;return!1}numNeighbors(t,e,s=1.5){let i=0;for(let a of this.iterRange(t,s))this.at(a.pos)instanceof e&&(i+=1);return i}closestTile(t){return this.at([Math.round(t.center_x-.5),Math.round(t.center_y-.5)])}closestPos(t){return new d([Math.round(t.x),Math.round(t.y)])}move(t,e=15,s=null){s===null&&(s=new d(t.vel));let i=t.pos.add([0,s.y*e]),a=t.bounds(i);for(let c of this.colliders(a))c.passable||(s.y>0&&a.bottom>c.y&&(i.y-=a.bottom-c.y,s.y=0,t.vel.y=0,a=t.bounds(i)),s.y<0&&a.y<c.bottom&&(i.y+=c.bottom-a.y,s.y=0,t.vel.y=0,a=t.bounds(i)));let n=i.add([s.x*e,0]),r=t.bounds(n);for(let c of this.colliders(r))c.passable||(s.x>0&&r.right>c.x&&(n.x-=r.right-c.x,s.x=0,t.vel.x=0,r=t.bounds(n)),s.x<0&&r.x<c.right&&(n.x+=c.right-r.x,s.x=0,t.vel.x=0,r=t.bounds(n)));t.pos=new d([n.x,i.y])}moveBoat(t,e=15,s=null){s===null&&(s=new d(t.vel));let i=t.pos.add([0,s.y*e]),a=t.bounds(i);for(let c of this.colliders(a))c instanceof z||(s.y>0&&a.bottom>c.y&&(i.y-=a.bottom-c.y,s.y=0,t.vel.y=0,a=t.bounds(i)),s.y<0&&a.y<c.bottom&&(i.y+=c.bottom-a.y,s.y=0,t.vel.y=0,a=t.bounds(i)));let n=i.add([s.x*e,0]),r=t.bounds(n);for(let c of this.colliders(r))c instanceof z||(s.x>0&&r.right>c.x&&(n.x-=r.right-c.x,s.x=0,t.vel.x=0,r=t.bounds(n)),s.x<0&&r.x<c.right&&(n.x+=c.right-r.x,s.x=0,t.vel.x=0,r=t.bounds(n)));t.pos=new d([n.x,i.y])}}class Vt extends f{constructor(){super([0,0,14,8]),this.scrollable=!0,this.focusPlayer=null}get viewPortH(){return this.h}set viewPortH(t){this.h=t}get viewPortW(){return this.w}set viewPortW(t){this.w=t}get pos(){return new d([-this.x,-this.y])}set pos(t){t!=null?(this.x=-t.x,this.y=-t.y):(this.x=null,this.y=null)}update(t,e){if(this.scrollable){let s=0,i=0,a=0;for(let c of t.activePlayers)!c.dead&&!c.escaped&&((this.focusPlayer==null||this.focusPlayer.dead||this.focusPlayer.escaped)&&(this.focusPlayer=c),c.controlStates.camera&&!c.oldControlStates.camera&&(this.focusPlayer=c),i+=c.pos.x,a+=c.pos.y,s++);this.focusPlayer===null&&(this.focusPlayer=t.activePlayers[0]),s>0&&(i/=s,a/=s),s==0&&(i=this.focusPlayer.pos.x,a=this.focusPlayer.pos.y),s>1&&(Math.abs(this.focusPlayer.pos.x-i)>this.viewPortW/2-1||Math.abs(this.focusPlayer.pos.y-a)>this.viewPortH/2-1)&&(i=this.focusPlayer.pos.x,a=this.focusPlayer.pos.y);let n=-i-.5+this.viewPortW/2,r=-a-.5+this.viewPortH/2;if(n=Math.max(Math.min(n,0),-t.dimW+this.viewPortW),r=Math.max(Math.min(r,0),-t.dimH+this.viewPortH),this.x==null||this.y==null)this.pos=new d([n,r]);else{let c=n-this.pos.x,u=r-this.pos.y,w=.2*(e/15),x=Math.max(Math.abs(c),Math.abs(u));this.pos!=null&&x>w?this.pos=new d([this.pos.x+c*w/x,this.pos.y+u*w/x]):this.pos=new d([n,r])}t.shakeX=Math.floor(-this.x*t.tileSize),t.shakeY=Math.floor(-this.y*t.tileSize)}}draw(){}}function Jt(h){let t;if(h.camera.scrollable&&h.prefDimW==null&&h.prefDimH==null)switch(t=0,t){case 0:h.dimW=256,h.dimH=128;break}const e=h.dimW,s=h.dimH;h.tiles=new Kt(e,s);let i=h.tiles;i.fillRect(new f([0,0,e,s]),q);for(let u=0;u<s;u++){const w=Math.floor(u/2);i.fillLine([w+20,u],[w+120,u],z)}const a=116;i.fillLine([0,a],[50,a],v),i.fillLine([0,a+1],[50,a+1],v),i.fillLine([49,a],[49,a-10],v),i.fillLine([50,a+1],[50,a-10],v),i.fillLine([48,a-10],[28,a-30],v),i.fillLine([49,a-10],[29,a-30],v),i.fillLine([50,a-10],[30,a-30],v),i.fillLine([28,a-30],[18,a-80],v),i.fillLine([29,a-30],[19,a-80],v),i.fillLine([30,a-30],[20,a-80],v),i.fillLine([19,a-80],[19,a-95],v),i.fillLine([130,0],[194,128],v),i.fillLine([131,0],[195,128],v),i.fillLine([132,0],[196,128],v),i.fillRect(new f([185,107,63,2]),v),i.fillRect(new f([193,122,57,2]),v),i.fillRect(new f([248,107,2,24]),v),i.endTile=i.at([255,127]),i.startTile=i.at([0,116]),i.endTile=i.at([255,127]),h.cells=10,h.cellsCollected=0,h.items=[],h.items.push(new K([15.5,a-100])),h.items.push(new H([28,20]));const n=new H([38,40]);n.boardable=!0,h.items.push(n),h.items.push(new H([48,60])),h.items.push(new H([58,80])),h.items.push(new H([68,100])),h.items.push(new H([78,120])),h.items.push(new H([152,60])),h.items.push(new H([162,80])),h.items.push(new H([172,100])),h.items.push(new H([182,120])),i.fillRect(new f([185,107,63,2]),v),i.fillRect(new f([193,122,57,2]),v),i.fillRect(new f([248,107,2,24]),v);for(let u=0;u<100;u+=24){let w=140+Math.floor(u/2);h.items.push(new K([w,u]))}for(let u=10;u<110;u+=24){let w=133+Math.floor(u/2)+J(5);i.set([w,u],E)}let r=0;for(let u=0;u<100;u++){r=Math.min(Math.max(Math.random()>.5?-1:1,0),5);let w=150+Math.floor(u/2)+r;i.fillLine([w,u],[256,u],zt)}let c=0;h.tiles.fillRect(new f([198,102,52,5]),it),h.tiles.fillRect(new f([198,124,52,7]),it),h.tiles.fillRect(new f([250,107,5,24]),it);for(let u=198;u<250;u+=8)h.items.push(new K([u,100]));for(let u=198;u<250;u+=8)h.items.push(new K([u,124]));for(let u=105;u<128;u+=6)h.items.push(new K([250,u]));c=0,c=0;for(let u of h.tiles.iterRandom(null,z,null,20))if(h.items.push(new B(h.tiles.at(u))),c++,c>100)break;c=0;for(let u of h.tiles.iterRandom(null,q,null,200))if(h.items.push(new At(h.tiles.at(u))),c++,c>100)break;h.monsters=[];for(let u=0;u<8;u+=2)for(let w=0;w<12;w+=2)h.monsters.push(new _([9+u,a+w-80]));for(let u=0;u<10;u+=2)for(let w=0;w<12;w+=2)h.monsters.push(new _([22+u,a+w-80]));h.monsters.push(new _([n.pos.x-2,n.pos.y-2],null,2,!0)),h.monsters.push(new _([n.pos.x-4,n.pos.y-2],null,2,!0)),h.monsters.push(new _([n.pos.x-2,n.pos.y+2],null,2,!0)),h.monsters.push(new _([n.pos.x-4,n.pos.y+2],null,2,!0));for(let u of h.tiles.iterAll())u.initItems(h)}function qt(h,t=null,e=!1,s=!0){let i;return gt("get random passable tile",function(){let a=at(0,h.dimW-1),n=at(0,h.dimH-1);return i=h.at([a,n]),t!=null?i.passable&&i.pos.dist(t)>3:!0}),i}function Qt(h,t,e=!1,s=null){s===null&&(s=[tt]);let i=P(s),a=new i(qt(h.tiles,t,e));h.monsters.push(a)}class nt{constructor(t,e,s){this.options=t,this.dim=new f(e),this.activeOption=0,this.callback=s,this.color="rgba(100, 100, 218, 1)"}draw(t){let e=Math.ceil(this.dim.h/this.options.length),s=Math.ceil(this.dim.h/this.options.length/2),i=this.dim.y,a=this.dim.x+this.dim.w/2,n=0;for(let r of this.options){let c=n==this.activeOption?">"+r+"<":r;this.drawMenuText(t,c,s,!0,a,i,this.color),n+=1,i+=e}}drawMenuText(t,e,s,i,a,n,r){t.ctx.fillStyle=r,t.ctx.font=s+"px IM Fell English SC",i&&(a=a-t.ctx.measureText(e).width/2),t.ctx.fillText(e,a,n)}update(t,e){g.up&&!F.up&&(this.activeOption=this.activeOption>0?this.activeOption-1:this.options.length-1,this.callback(this,"change")),g.down&&!F.down&&(this.activeOption=this.activeOption<this.options.length-1?this.activeOption+1:0,this.callback(this,"change")),(g.use&&!F.use||g.dash&&!F.dash)&&this.callback(this,"select")}}class Zt extends nt{constructor(t){let e=new f([0,t.canvas.height/2,t.canvas.width,4*t.tileSize]);super(["Play Game","High Scores","Options"],e,(s,i)=>this.handler(t,s,i))}updateWindowSize(t){this.dim=new f([0,t.canvas.height/2,t.canvas.width,4*t.tileSize])}handler(t,e,s){if(s==="select")switch(e.activeOption){case 0:g.left?(t.prefDimW=80,t.prefDimH=40,t.startLevelTime=0):g.right?(t.prefDimW=22,t.prefDimH=13,t.startLevelTime=0):(t.prefDimW=null,t.prefDimH=null,t.startLevelTime=0),t.competitiveMode=!1,t.updateWindowSize(),t.startGame();break;case 1:t.gameState="scores";break;case 2:t.gameState="options";break}}}class $t extends nt{constructor(t){let e=new f([0,t.canvas.height/2,t.canvas.width,0]);super([],e,(s,i)=>this.handler(t,s,i))}updateWindowSize(t){this.dim=new f([0,t.canvas.height/2,t.canvas.width,this.options.length*t.tileSize])}update(t,e){this.options=["Pixel perfect scaling: "+(t.fillScreen?"OFF":"ON"),"Show framerate: "+(t.showFPS?"ON":"OFF"),"Sandbox mode: "+(t.sandboxMode?"ON":"OFF"),"Back"],this.dim=new f([0,t.canvas.height/2,t.canvas.width,this.options.length*t.tileSize]),super.update(t,e)}handler(t,e,s){if(s=="select")switch(e.activeOption){case 0:t.fillScreen=!t.fillScreen,t.updateWindowSize();break;case 1:t.showFPS=!t.showFPS;break;case 2:t.sandboxMode=!t.sandboxMode;break;case 3:t.gameState="title";break;case 4:break;case 5:t.gameState="title";break}}}class te extends nt{constructor(t){let e=new f([0,t.canvas.height/2,t.canvas.width,3*t.tileSize]);super(["Continue","Drop Player","Exit to Main Menu"],e,(s,i)=>this.handler(t,s,i))}updateWindowSize(t){this.dim=new f([0,t.canvas.height/2,t.canvas.width,this.options.length*t.tileSize])}handler(t,e,s){if(s=="select")switch(e.activeOption){case 0:t.gameState="running";break;case 1:for(let i of t.activePlayers)i.controlStates.dash&&!i.oldControlStates.dash&&(i.dead=!0,i.dropFromGame=!0,t.gameState="running");break;case 2:t.gameState="title";break}}}function mt(){return localStorage["1776/high_scores"]?JSON.parse(localStorage["1776/high_scores"]):[]}function ee(h,t,e){var a;let s=mt(),i={score:t,chapter:((a=h.chapters[h.activeChapter])==null?void 0:a.title)??"Pennsylvania",won:e};s.push(i),h.sandboxMode||(localStorage["1776/high_scores"]=JSON.stringify(s))}function se(h){let t=mt();if(t.length){h.drawText(rt(["CHAPTER","SCORE","END"]),18,!0,h.canvas.height/2,"white");let e=t.pop();t.sort(function(s,i){return i.score-s.score}),t.unshift(e);for(let s=0;s<Math.min(10,t.length);s++){let i=rt([t[s].chapter??"Pennsylvania",t[s].score,t[s].won?"SURVIVED":"DIED"]);h.drawText(i,18,!0,h.canvas.height/2+24+s*24,s==0?"DarkOrange":"DarkSeaGreen")}}}const ie="/washdel/assets/spritesheet-C-PdJtSR.png",ae="/washdel/assets/the_marines_hymn_slow_version-wL2A_HOJ.mp3",he="/washdel/assets/four-flams-CE5QOPlm.mp3",ne="/washdel/assets/holst-march-DHIMIGoC.mp3",le="/washdel/assets/star-spangled-banner-Bht74Z9J.mp3",re="/washdel/assets/to-the-colors-DfVqikZB.mp3",oe="/washdel/assets/hit1-B8fjDMVY.wav",de="/washdel/assets/hit2-BUt-r6lq.wav",ce="/washdel/assets/sfx_sounds_powerup5-9kcmwmYb.wav",ue="/washdel/assets/sfx_sounds_powerup15-BCTjFyTw.wav",$="/washdel/assets/Slide_Sharp_01-Chnp6Y48.wav",pe="/washdel/assets/explodemini-D3OoVwHb.wav",fe="/washdel/assets/explode-BNxvceyl.wav",we="/washdel/assets/aargh0-BapSXfr1.ogg",ye="/washdel/assets/aargh1-CpJFM2VX.ogg",me="/washdel/assets/aargh2-DSamuWiH.ogg",Se="/washdel/assets/aargh3-ByRNAUSJ.ogg",xe="/washdel/assets/aargh4-ClzDA7Un.ogg",ve="/washdel/assets/aargh5-C63Uz6i_.ogg",ge="/washdel/assets/aargh6-CYmQwO-t.ogg",be="/washdel/assets/aargh7-9yHQMFdu.ogg",ct="/washdel/assets/rock_metal_slide_1-C2c5Tw6I.wav",Me="/washdel/assets/Click_Standard_02-B2nmSCJT.wav",Te="/washdel/assets/flaunch-BKRvBjGH.wav",ke="/washdel/assets/sfx_wpn_laser7-B5OWkHW5.wav",Pe="/washdel/assets/sfx_wpn_laser6-Drhqhz-r.wav",He="/washdel/assets/sfx_wpn_laser5-v584Gpjn.wav",ut="/washdel/assets/sfx_wpn_reload-DQ6QsLU9.wav",De="/washdel/assets/Rifleprimary2-CKvPeCK4.ogg",Ce="/washdel/assets/minigun3-D9jlbypc.ogg",Fe="/washdel/assets/Rack-BKgWHnMr.mp3",Be="/washdel/assets/sfx_wpn_missilelaunch-DaPY7xwi.wav",ze="/washdel/assets/jumppad-BqbMzNcn.ogg",pt="/washdel/assets/rattle1-D8oszgzt.wav",Re="/washdel/assets/SpaceShip_Engine_Large_Loop_00-wpyxUmoF.wav";function Oe(){return{main:ie}}function We(){return Object.freeze({hit1:new Audio(oe),hit2:new Audio(de),pickup1:new Audio(ce),pickup2:new Audio(ue),changeInv:new Audio($),boom:new Audio(pe),boomBig:new Audio(fe),dead1:new Audio(we),dead2:new Audio(ye),dead3:new Audio(me),dead4:new Audio(Se),dead5:new Audio(xe),dead6:new Audio(ve),dead7:new Audio(ge),dead8:new Audio(be),exitLevel:new Audio(ct),gameOver:new Audio(ct),kioskInteract:new Audio(Me),kioskDispense:new Audio(Te),gunFire1:new Audio(ke),gunFire2:new Audio(Pe),gunFire3:new Audio(He),gunReload:new Audio(ut),rifleFire:new Audio(De),rifleReload:new Audio(ut),shotgunFire:new Audio(Ce),shotgunReload:new Audio(Fe),rocketFire:new Audio(Be),rocketReload:new Audio($),grappleFire:new Audio(ze),grappleReload:new Audio($),grappleRetract:new Audio(pt),wrenchFire:new Audio(pt),wrenchReload:new Audio($),saberCharge:new Audio(Re),marinesHymn:new Audio(ae),fourFlams:new Audio(he),holstMarch:new Audio(ne),starSpangled:new Audio(le),toTheColors:new Audio(re)})}class Q{constructor(){l(this,"intro",[]);l(this,"activeIntroLine",0);l(this,"objectives",[]);l(this,"activeObjective",0);l(this,"startTime",0);l(this,"title","")}start(t){this.startTime=t.levelTime,t.music!=null&&t.music.pause()}update(t,e){t.levelTime>=this.startTime+1e4*(this.activeIntroLine+1)&&this.activeIntroLine++}draw(t,e){t.activePlayers[0].dead?t.activePlayers[0].hidden?this.drawTextBox(t,`
Washington drowned crossing the Delaware (press ESC to exit).`):this.drawTextBox(t,`
Washington has died in battle (press ESC to exit).`):this.activeIntroLine<this.intro.length&&this.activeObjective===0?this.drawTextBox(t,this.intro[this.activeIntroLine]):(t.levelTime>=this.startTime+1e4*this.intro.length||this.activeObjective>0)&&this.objectives.length>this.activeObjective&&this.drawTextBox(t,this.objectives[this.activeObjective])}drawTextBox(t,e){t.ctx.globalAlpha=.5,t.ctx.fillStyle="darkGray";const s=1*t.tileSize,i=(t.camera.viewPortW-2)*t.tileSize,a=Mt(t.ctx,e,i,t.tileSize/2),n=a.length*1.1*t.tileSize/2,r=(t.camera.viewPortH-.5)*t.tileSize-n;t.ctx.fillRect(s,r,i,n),t.ctx.globalAlpha=1,Tt(t.ctx,a,s,r,"darkOrange",t.tileSize/2)}}class Ae extends Q{constructor(){super(...arguments);l(this,"stone",null);l(this,"title","McConkey Ferry, Pennsylvania");l(this,"intro",["The year is 1776, the U.S. army has faced defeat after defeat. Having recently lost New York, the colonial army holds a lower morale than ever, and is on the verge of collapse.","General Washington knows the soldiers need a decisive victory to raise their spirits, and has planned a surprise attack on the Hessian occupied Trenton. However, first he must cross the Delaware River, which has begun to freeze due to poor weather conditions."]);l(this,"objectives",[`Head north and rouse your troops.
Controls: ARROWS or W/A/S/D to move, SPACE/J to swing sword, Z/K to dodge.`,'Tyranny, like hell, is not easily conquered; yet we have this consolation with us, that the harder the conflict, the more glorious the triumph..."',"Find your captains and board your boat."]);l(this,"speechTimer",5e3)}start(e){super.start(e),e.weather.changeMode("snow"),e.backLight="rgba(156, 156, 192, 1)",this.stone=new _t([17,32]),e.items.push(this.stone),e.music=e.sounds.fourFlams,e.music.loop=!0,e.music.play()}update(e,s){super.update(e,s);const i=e.activePlayers[0];this.activeObjective===0&&i.bounds().collide(this.stone.bounds())&&(i.pos=this.stone.pos.add([0,-.5]),i.freeze=!0,this.activeObjective++),this.activeObjective===1&&this.speechTimer>0?(this.speechTimer-=s,this.speechTimer<=0&&(i.freeze=!1,this.activeObjective++)):this.activeObjective===2&&e.activePlayers[0].activeState===D&&(e.monsters=e.monsters.filter(r=>!(r instanceof _&&r.hat)),e.nextChapter());let a=100-e.items.reduce((r,c)=>c instanceof B?r+1:r,0);const n=e.tiles.iterRandom(null,z);for(;a>0;){const r=n.next();r.value&&r.value.dist(i.pos)>=20&&e.items.push(new B(r.value,P([p.Iceberg1,p.SoldierIcecube,p.SoldierIcecube,y.BoatVerticle1]))),a--}}draw(e,s){super.draw(e,s)}}class _e extends Q{constructor(){super(...arguments);l(this,"title","Delaware River");l(this,"intro",["The snow was unyielding, but Washington was determined to take Trenton so the plan continued. The ice and poor visibility made the crossing a tremendous task.","FACT CHECK: Although some boats did flip in the water, in reality no one died."]);l(this,"objectives",["Get to the other side!"])}start(e){super.start(e),e.weather.changeMode("heavySnow"),e.backLight="rgba(108, 108, 128, 1)",e.music=e.sounds.marinesHymn,e.music.loop=!0,e.music.play()}update(e,s){super.update(e,s),e.activePlayers[0].activeState!==D&&e.nextChapter();const i=e.activePlayers[0];let a=150-e.items.reduce((r,c)=>c instanceof B?r+1:r,0);const n=e.tiles.iterRandom(new f([20,i.pos.x-Math.round(e.camera.viewPortH/2)-2,180,5]),z);for(;a>0;){const r=n.next();r.value&&r.value.dist(i.pos)>=20&&e.items.push(new B(r.value,P([p.Iceberg1,p.SoldierIcecube,p.SoldierIcecube,y.BoatVerticle1]))),a--}}draw(e,s){super.draw(e,s)}}class Le extends Q{constructor(){super(...arguments);l(this,"title","The Frozen March to Trenton");l(this,"intro",["Having crossed the river, Washington began a march South towards Trenton. The march started later than anticipated at around 3AM instead of the planned midnight.",'Look out for spies, men! No shooting!"']);l(this,"objectives",["Follow the river south until you get to Trenton. Stop any spies from reporting to Colonel Rall."])}start(e){super.start(e),e.weather.changeMode("sleet"),e.backLight="rgba(108, 108, 128, 1)";for(let s=9;s<100;s+=24){let i=140+Math.floor(s/2)+5;e.monsters.push(new Ot(e.tiles.at([i+J(5),s+J(5)])))}e.music=e.sounds.holstMarch,e.music.loop=!0,e.music.play()}update(e,s){super.update(e,s);const i=e.activePlayers[0];i.pos.x>=195&&i.pos.y>=100&&e.nextChapter()}draw(e,s){super.draw(e,s)}}class Ie extends Q{constructor(){super(...arguments);l(this,"cannon",null);l(this,"cannonier",null);l(this,"title","Trenton");l(this,"intro",["By the time Washingtons army reached Trenton the sun had started to rise, it was around 8AM. The battle of Trenton had begun.","The Hessians had a total of 6 cannons during the battle, take that down to 5.","FACT CHECK: In reality the Americans actually had more cannons than the Hessians but for gameplay purposes, its more entertaining to be less powerful."]);l(this,"objectives",["Destroy the cannon!"])}start(e){super.start(e),e.weather.changeMode("clear"),e.backLight="rgba(255,225,225,1)",e.music=e.sounds.toTheColors,e.music.loop=!0,e.music.play();for(let i=185;i<215;i+=5)e.monsters.push(new tt(e.tiles.at([i,107]))),e.monsters.push(new tt(e.tiles.at([i+3,122])));const s=Math.floor(229/2);this.cannon=new Wt([212,s]),e.monsters.push(this.cannon),this.cannonier=new tt([213,s]),this.cannonier.shoots=!1,e.monsters.push(this.cannonier)}update(e,s){super.update(e,s),this.cannonier.dead&&(this.cannon.hp=1),this.cannon.dead&&e.nextChapter()}draw(e,s){super.draw(e,s)}}class Ye extends Q{constructor(){super(...arguments);l(this,"title","Colonel Johann Rall");l(this,"boss",null);l(this,"launchTimer",0);l(this,"leftBarrier",180);l(this,"rightBarrier",247);l(this,"intro",["Great work, now take the final Hessian position held by Colonel Rall.","FACT CHECK: There wasnt actually an epic battle between Washington and Rall, however, Rall was injured and later died after the conflict"]);l(this,"objectives",["Defeat Rall",`################
    VICTORY!!!!
################`])}start(e){super.start(e),e.weather.changeMode("clear"),e.backLight="rgba(255,255,255,1)";const s=e.activePlayers[0],i=Math.floor(s.pos.x-2);this.leftBarrier=i;for(let a=0;a<10;a+=2)e.tiles.fillLine([i-a,107],[i-a,122],ot);e.tiles.fillLine([248,107],[248,122],ot),this.boss=new Rt(e.tiles.at([240,Math.floor(229/2)])),e.monsters.push(this.boss)}update(e,s){if(super.update(e,s),this.launchTimer-=s,this.launchTimer<0){let i=Math.random()>.5?this.leftBarrier+1:this.rightBarrier-1;for(let a=107;a<122;a++)e.items.push(new It(e.tiles.at([i,a]),null,i>this.leftBarrier+1?180:0));this.launchTimer=8e3}this.activeObjective===0&&this.boss.dead&&(e.gameState="dead",this.activeObjective++)}draw(e,s){super.draw(e,s)}}class Xe{constructor(){l(this,"timer_tick",null);l(this,"FPSframes",0);l(this,"FPStime",0);l(this,"FPS",0);l(this,"updateTimes",new C([]));l(this,"drawTimes",new C([]));l(this,"updateMean",0);l(this,"updateMax",0);l(this,"drawMean",0);l(this,"drawMax",0);l(this,"weather",new Lt);l(this,"activeChapter",-1);l(this,"chapters",[]);l(this,"music",null);l(this,"fillScreen",!1);l(this,"prefDimW",44);l(this,"prefDimH",26);l(this,"dimW",this.prefDimW);l(this,"dimH",this.prefDimH);l(this,"uiWidth",0);l(this,"uiHeight",2);l(this,"gameOffsetX",0);l(this,"gameOffsetY",0);l(this,"startLevelTime",0);l(this,"maxHp",3);l(this,"backLight","rgba(108, 108, 128, 1)");l(this,"activePlayers",[]);l(this,"tiles",null);l(this,"monsters",null);l(this,"items",null);l(this,"multiplayerEnabled",!0);l(this,"competitiveMode",!1);l(this,"sandboxMode",!1);l(this,"gameState","loading");l(this,"showFPS",!1);l(this,"cullOffCamera",!0);l(this,"cells",0);l(this,"cellsCollected",0);l(this,"startingHp",3);l(this,"shakeAmount",0);l(this,"shakeX",0);l(this,"shakeY",0);l(this,"numReady",0);this.initSounds(),this.keyboard=new Ht(this),this.touch=new Ft(this),this.gamepadMgr=new Ct(this),this.camera=new Vt,this.tileSize=this.getTileScale()*16;const t=Oe();this.sprites={base:new Ut(this,t.main,16)}}start(){window.onresize=()=>t.updateWindowSize(),this.setupCanvas();let t=this;this.sprites.base.sheet.onload=()=>t.ready(),this.mainMenu=new Zt(this),this.optionsMenu=new $t(this),this.inGameMenu=new te(this)}ready(){this.numReady++,this.numReady>=1&&(this.gameState="title",this.music=this.sounds.starSpangled,this.music.loop=!0,this.music.play(),this.update())}update(){var s;let t=performance.now();this.gamepadMgr.update_gamepad_states();for(let i of Object.keys(g))F[i],g[i];for(let i of this.activePlayers)for(let a of Object.keys(i.controlStates))i.newControlStates[a]=i.oldControlStates[a]!==i.controlStates[a];if(this.gameState=="dead"&&!F.menu&&g.menu)this.gameState="scores";else if(this.gameState=="running"||this.gameState=="dead"){this.gameState=="running"&&g.menu&&!F.menu&&(this.gameState="paused"),this.gameState=="running"&&g.dash&&!F.dash&&Y.player==null&&this.addPlayer();let i=15,a=Date.now();this.timer_tick!=null&&(i=Math.min(a-this.timer_tick,30)),this.timer_tick=a;for(let r of this.activePlayers)r.update(R,i);this.levelTime+=i,Bt(i),this.weather.update(this,i);for(let r of this.items)r.update(this,i);this.remove_dead(this.items);for(let r of this.monsters)r.update(this,i);this.remove_dead(this.monsters),this.remove_dropped(this.activePlayers);let n=!0;for(let r of this.activePlayers)if(!r.dead){n=!1;break}!this.competitiveMode&&n&&this.gameState!="dead"&&(this.keyboard.player=null,this.touch.player=null,this.gamepadMgr.release_all_players(),ee(R,this.activePlayers[0].score,!1),this.gameState="dead",this.items.push(new jt("gameOver",1e3)));for(let r of this.activePlayers)if(!r.dead&&!r.escaped)break;this.spawnCounter-=i,this.spawnCounter<=0&&this.activePlayers.length>0&&(this.spawnCounter=this.spawnRate,this.monsters.length<20&&Qt(this,this.activePlayers[0].pos,!0)),this.updateTimes.push(performance.now()-t),(s=this.chapters[this.activeChapter])==null||s.update(this,i),this.draw(i)}else this.gameState==="title"||this.gameState==="options"?this.showTitle():this.gameState==="scores"?(this.showTitle(),!F.dash&&g.dash&&(this.gameState="title",this.music!==null&&(this.music.pause(),this.music=null))):this.gameState==="paused"&&(this.showTitle(),this.gameState==="paused"&&!F.menu&&g.menu&&(this.gameState="running",this.music!==null&&(this.music.pause(),this.music=null)));kt(g);for(let i of this.activePlayers)i.oldControlStates={...i.controlStates};let e=this;window.requestAnimationFrame(()=>e.update())}draw(t){var s;let e=performance.now();if(this.gameState==="running"||this.gameState==="dead"){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.screenshake(),this.camera.update(R,t);let i=0,a=0,n=this.tiles.dimW,r=this.tiles.dimH;this.cullOffCamera&&(i=Math.floor(this.camera.x),a=Math.floor(this.camera.y),n=Math.ceil(this.camera.right),r=Math.ceil(this.camera.bottom));for(let m=i;m<n;m++)for(let A=a;A<r;A++)this.tiles.at([m,A]).draw(R);let c=this.camera;this.ctx.globalCompositeOperation="multiply";const u=this.activePlayers[0];this.ctx.fillStyle=this.backLight,this.ctx.fillRect(-c.pos.x*this.tileSize+this.shakeX+this.gameOffsetX,-c.pos.y*this.tileSize+this.shakeY+this.gameOffsetY,c.viewPortW*this.tileSize+1,c.viewPortH*this.tileSize+1),this.ctx.globalCompositeOperation="source-over";const w=[...this.monsters,...this.activePlayers,...this.items];if(w.sort((m,A)=>m.bounds().bottom-A.bounds().bottom),this.cullOffCamera)for(let m of w)m.sprite&&(m.sprite.length===2?c.shrinkBorders(-2).collide(new f([m.pos.x,m.pos.y,1,1]))&&m.draw(this):c.shrinkBorders(-2).collide(new f([m.pos.x,m.pos.y,m.sprite[2],m.sprite[3]]))&&m.draw(this));else for(let m=0;m<this.items.length;m++)this.items[m].draw(this);this.weather.draw(R,t),this.ctx.globalCompositeOperation="multiply";let x=this.ctx.createRadialGradient((u.pos[0]+.5)*this.tileSize+this.shakeX+this.gameOffsetX,(u.pos[1]+.5)*this.tileSize+this.shakeY+this.gameOffsetY,c.viewPortW/4*this.tileSize,(u.pos[0]+.5)*this.tileSize+this.shakeX+this.gameOffsetX,(u.pos[1]+.5)*this.tileSize+this.shakeY+this.gameOffsetY,this.tileSize*2);x.addColorStop(0,"rgba(128, 128, 192, 1)"),x.addColorStop(1,"rgba(192, 192, 192, 1)"),this.ctx.fillStyle=x,this.ctx.fillRect(-c.pos.x*this.tileSize+this.shakeX+this.gameOffsetX,-c.pos.y*this.tileSize+this.shakeY+this.gameOffsetY,c.viewPortW*this.tileSize+1,c.viewPortH*this.tileSize+1),this.ctx.globalCompositeOperation="source-over",this.shakeX=0,this.shakeY=0;const T=this.camera.scrollable?this.camera.viewPortW:this.dimW,et=this.camera.scrollable?this.camera.viewPortH:this.dimH;this.drawText(this.chapters[this.activeChapter].title,this.tileSize*3/8,!0,this.tileSize/4,"DarkOrange");let St=[new d([0,0]),new d([T-6,0]),new d([0,et-1]),new d([T-6,et-1])],lt=0;for(let m of this.activePlayers){let A=St[lt];m.drawHUD(R,A),lt++}if((s=this.chapters[this.activeChapter])==null||s.draw(this,t),this.drawTimes.push(performance.now()-e),this.showFPS){this.FPSframes+=1,this.FPStime+=t,this.FPStime>1e3&&(this.FPS=Math.round(10*1e3*this.FPSframes/this.FPStime)/10,this.FPStime=0,this.FPSframes=0,this.updateMean=Math.round(this.updateTimes.mean()*100)/100,this.updateMax=Math.round(this.updateTimes.max()*100)/100,this.updateTimes=new C([]),this.drawMean=Math.round(this.drawTimes.mean()*100)/100,this.drawMax=Math.round(this.drawTimes.max()*100)/100,this.drawTimes=new C([]));let m=this.cullOffCamera?"CULL":"";this.drawText("FPS: "+this.FPS+"  Update: "+this.updateMean+"ms (peak "+this.updateMax+")  Draw: "+this.drawMean+"ms (peak "+this.drawMax+") "+m,this.tileSize*3/8,!0,this.tileSize*(et-.25)+this.gameOffsetY,"DarkSeaGreen")}}}setupCanvas(){this.canvas=document.querySelector("canvas"),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.canvas.style.width=this.canvas.width+"px",this.canvas.style.height=this.canvas.height+"px",this.ctx=this.canvas.getContext("2d"),this.ctx.imageSmoothingEnabled=!1,this.camera.scrollable?(this.gameOffsetX=Math.floor((window.innerWidth-this.tileSize*this.camera.viewPortW)/2),this.gameOffsetY=Math.floor((window.innerHeight-this.tileSize*this.camera.viewPortH)/2)):(this.gameOffsetX=Math.floor((window.innerWidth-this.tileSize*this.dimW)/2),this.gameOffsetY=Math.floor((window.innerHeight-this.tileSize*this.dimH)/2))}getTileScale(){let t=window.innerHeight,e=window.innerWidth,s;return this.camera.scrollable?s=Math.min(t/(this.camera.viewPortH+this.uiHeight)/16,e/(this.camera.viewPortW+this.uiWidth)/16):s=Math.min(t/(this.prefDimH+this.uiHeight)/16,e/(this.prefDimW+this.uiWidth)/16),this.fillScreen||(s=Math.floor(s)),s}fitMaptoTileSize(t){let e=window.innerHeight,s=window.innerWidth;this.camera.scrollable?(this.camera.viewPortH=e/t,this.camera.viewPortW=s/t):(this.dimH=Math.floor(e/t),this.dimW=Math.floor(s/t),this.camera.viewPortH=this.dimH,this.camera.viewPortW=this.dimW)}updateWindowSize(){this.competitiveMode?this.camera.scrollable=!1:(this.camera.scrollable=!0,this.camera.viewPortW=14,this.camera.viewPortH=8),this.tileSize=this.getTileScale()*16,this.fitMaptoTileSize(this.tileSize),this.setupCanvas(),this.mainMenu.updateWindowSize(this),this.optionsMenu.updateWindowSize(this)}initSounds(){this.sounds=We()}playSound(t,e=0,s=!1,i=!0){return this.sounds[t].currentTime=e,this.sounds[t].loop=s,i&&this.sounds[t].play(),this.sounds[t]}showTitle(){this.ctx.fillStyle="rgba(0,0,0,.75)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),R.drawText("1776: Washington's Crossing",1.25*this.tileSize,!0,this.canvas.height/2-3.5*this.tileSize,"DarkRed"),R.drawText("by Evan Moore",this.tileSize,!0,this.canvas.height/2-2*this.tileSize,"White"),this.gameState==="title"?(this.mainMenu.update(this,0),this.mainMenu.draw(this)):this.gameState==="options"?(this.optionsMenu.update(this,0),this.optionsMenu.draw(this)):this.gameState==="paused"?(this.inGameMenu.update(this,0),this.inGameMenu.draw(this)):this.gameState==="scores"&&se(this)}addPlayer(){let t=new j;t.hp=this.startingHp,t.maxHp=this.startingHp,t.pos=this.tiles.startTile.pos,t.controller=Y,Y.attach_to_player(t),this.activePlayers.push(t)}startGame(){this.timer_tick=null,this.score=0,this.cellsCollected=2,this.activePlayers=[];let t=new j;this.activePlayers.push(t),this.multiplayerEnabled?Y.attach_to_player(t):(this.keyboard.attach_to_player(t),this.touch.attach_to_player(t),this.gamepadMgr.attach_all_to_player(t)),t.hp=this.startingHp,t.maxHp=this.startingHp,this.chapters=[new Ae,new _e,new Le,new Ie,new Ye],this.weather.reset(),this.startLevel(),this.gameState="running"}nextChapter(){this.activeChapter++,this.chapters[this.activeChapter].start(this)}startLevel(){this.spawnRate=1e4,this.spawnCounter=this.spawnRate,this.levelTime=this.startLevelTime,this.camera.pos=null,this.activeChapter=0,this.competitiveMode||this.cellsCollected,Jt(R);for(let t of this.activePlayers)t.pos=this.tiles.startTile.pos,t.escaped=!1,t.dead&&t.revive(this);this.chapters[this.activeChapter].start(this)}screenshake(){this.shakeAmount&&this.shakeAmount--;let t=Math.random()*Math.PI*2;this.shakeX=Math.round(Math.cos(t)*this.shakeAmount),this.shakeY=Math.round(Math.sin(t)*this.shakeAmount)}drawText(t,e,s,i,a,n="IM Fell English SC"){this.ctx.fillStyle=a,this.ctx.font=e+"px "+n;let r;s?r=(this.canvas.width-this.ctx.measureText(t).width)/2:r=this.canvas.width-this.uiWidth*(this.tileSize-1),this.ctx.fillText(t,r,i)}drawTileText(t,e,s,i){this.ctx.fillStyle=i,this.ctx.font=e+"px IM Fell English SC";let a=(s.y+1-(1-e/this.tileSize)/2)*this.tileSize+this.gameOffsetY+this.shakeY,n=(s.x+(1-this.ctx.measureText(t).width/this.tileSize)/2)*this.tileSize+this.gameOffsetX+this.shakeX;this.ctx.fillText(t,n,a)}nearestPlayer(t){let e=1e9,s=null;for(let i of this.activePlayers)if(!i.dead){let a=i.pos.dist(t);s=a<e?i:s,e=a<e?a:e}return[s,e]}monsters_and_players(t=!0,e=null){return!t&&(!this.competitiveMode||this.levelTime>this.startLevelTime+1e4)?this.monsters.filter(s=>s!==e):this.monsters.concat(this.activePlayers).filter(s=>s!==e)}monsters_with_other_players(t){if(!this.competitiveMode||this.levelTime>this.startLevelTime+1e4)return this.monsters;let e=this.activePlayers.indexOf(t),s=this.activePlayers.slice(0,e).concat(this.activePlayers.slice(e+1));return this.monsters.concat(s)}other_players(t){let e=this.activePlayers.indexOf(t);return this.activePlayers.slice(0,e).concat(this.activePlayers.slice(e+1))}remove(t,e){for(let s=0;s<t.length;s++)if(t[s]==e){t.splice(s,1);return}}remove_dead(t){for(let e=t.length-1;e>=0;e--)t[e].dead&&t.splice(e,1)}remove_dropped(t){for(let e=t.length-1;e>=0;e--)t[e].dropFromGame&&(t[e].controller.attach_to_player(),this.items.push(new Et(t[e])),t.splice(e,1))}addGunPlatform(t){}addChips(t,e){const s=new Xt(t,e);return this.items.push(s),s}addBoom(t,e){const s=new Nt(t,e);return this.items.push(s),s}addTrapBlade(t){const e=new Gt(t);return this.items.push(e),e}}var R=new Xe;R.start();
