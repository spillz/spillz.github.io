var rt=Object.defineProperty;var ot=(h,t,e)=>t in h?rt(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var o=(h,t,e)=>ot(h,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();function dt(h,t){for(let e=1e3;e>0;e--)if(t())return;throw"Timeout while trying to "+h}function q(h,t=0){return t!=0?h+Math.floor(Math.random()*(t-h)):Math.floor(Math.random()*h)}function ct(h,t){return[q(h),q(t)]}function et(h){let t=h.length,e;for(;t!=0;)e=Math.floor(Math.random()*t),t--,[h[t],h[e]]=[h[e],h[t]];return h}function W(h){return h[Math.floor(Math.random()*h.length)]}class k extends Array{constructor(...t){t.length==1&&t[0]instanceof Array?super(...t[0]):super(...t)}sum(){let t=0;return this.forEach(e=>t+=e),t}mean(){return this.sum()/this.length}max(){return Math.max.apply(null,this)}min(){return Math.min.apply(null,this)}vars(){let t=0;return this.forEach(e=>t+=e*e),(t-this.length*this.mean()^2)/(this.length-1)}var(){let t=0;return this.forEach(e=>t+=e*e),t/this.length-this.mean()^2}std(){return Math.sqrt(this.var())}add(t){let e=new k(this);if(t instanceof Array||t instanceof k)for(let s=0;s<this.length;s++)e[s]+=t[s];else for(let s=0;s<this.length;s++)e[s]+=t;return e}mul(t){let e=new k(this);if(t instanceof Array||t instanceof k)for(let s=0;s<this.length;s++)e[s]*=t[s];else for(let s=0;s<this.length;s++)e[s]*=t;return e}dot(t){return this.mul(t).sum()}abs(){return Math.abs.apply(null,this)}shift(t){let e=new k;for(let s=-t;s<this.length-t;s++)s<0||s>=this.length?e.push(NaN):e.push(this[s]);return e}filter(t){return new k(super.filter(t))}dropNaN(){return this.filter(t=>!Number.isNaN(t))}}class d extends Array{constructor(t){super(),this[0]=t[0],this[1]=t[1]}static random(t){return new d(ct(t[0],t[1]))}add(t){return new d([this[0]+t[0],this[1]+t[1]])}subtract(t){return new d([this[0]-t[0],this[1]-t[1]])}scale(t){return new d([this[0]*t,this[1]*t])}mul(t){return new d([this[0]*t[0],this[1]*t[1]])}dot(t){return this[0]*t[0]+this[1]*t[1]}dist(t){return Math.hypot(this[0]-t[0],this[1]-t[1])}set x(t){this[0]=t}set y(t){this[1]=t}get x(){return this[0]}get y(){return this[1]}}class p extends Array{constructor(t){super(),this.length=4,this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3]}set x(t){this[0]=t}set y(t){this[1]=t}set w(t){this[2]=t}set h(t){this[3]=t}set pos(t){this[0]=t[0],this[1]=t[1]}get pos(){return new d([this[0],this[1]])}get x(){return this[0]}get y(){return this[1]}get w(){return this[2]}get h(){return this[3]}get right(){return this[0]+this[2]}get bottom(){return this[1]+this[3]}get center_x(){return this[0]+this[2]/2}get center_y(){return this[1]+this[3]/2}get center(){return new d([this.center_x,this.center_y])}shift(t){return new p([this.x+t[0],this.y+t[1],this.w,this.h])}shrinkBorders(t){return new p([this.x+t,this.y+t,this.w-t*2,this.h-t*2])}scale(t,e=!0){if(e){let s=[this[2]*t,this[3]*t];return new p([this[0]+.5*(this[2]-s[0]),this[1]+.5*(this[3]-s[1]),s[0],s[1]])}else{let s=[this[2]*t,this[3]*t];return new p([this[0],this[1],s[0],s[1]])}}collide(t){return this.x<t.x+t.w&&this.x+this.w>t.x&&this.y<t.y+t.h&&this.h+this.y>t.y}contact(t){return this.x<=t.x+t.w&&this.x+this.w>=t.x&&this.y<=t.y+t.h&&this.h+this.y>=t.y}}function j(h,t){return Math.floor(Math.random()*(t-h+1))+h}function Q(h){let t="";return h.forEach(e=>{e+="";for(let s=e.length;s<20;s++)e+=" ";t+=e}),t}class M{constructor(t,e=0){this.elapsed=0,this.timer=t,this.triggered=!1,e>0&&this.tick(e)}finished(){return this.elapsed>=this.timer}tick(t){return this.elapsed>=this.timer?(this.triggered&&(this.triggered=!1),!1):(this.elapsed+=t,this.elapsed>=this.timer?(this.triggered=!0,!0):!1)}reset(t=-1,e=0){this.elapsed=e,this.triggered=!1,t>=0&&(this.timer=t)}}const x={left:!1,right:!1,up:!1,down:!1,cycle:!1,use:!1,dodge:!1,dash:!1,camera:!1,menu:!1};var st={...x};function N(){return{...st}}var P={...x};({...x});function ut(h){P={...h}}var B=null,pt={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down",a:"left",d:"right",w:"up",s:"down",j:"dash",k:"use",l:"cycle",i:"dodge"," ":"dash",z:"use",x:"cycle",c:"dodge",0:"camera",Escape:"menu"};class G{constructor(){this.controlStates={...st},this.attach_to_player(),window.addEventListener("blur",t=>{this.clearPressedAll()})}attach_to_player(t=null){this.player=t,B=this,t!=null&&(this.player.controller=this)}set(t,e=!0){x[t]=e,B=this;let s=this.player;s!=null&&(s.controlStates[t]=e)}clearPressedAll(){for(const t in this.controlStates)this.controlStates[t]=!1}vibrate(t,e,s){}}class ft extends G{constructor(t,e=null){super(),this.game=t,e==null&&(e=pt),this.keyMap=e;let s=this;document.onkeydown=function(i){s.keyDownHandler(i)},document.onkeyup=function(i){s.keyUpHandler(i)}}keyDownHandler(t){t.key=="p"&&(this.game.fillScreen=!this.game.fillScreen,this.game.updateWindowSize()),t.key=="f"&&(this.game.showFPS=!this.game.showFPS,this.game.updateWindowSize()),t.key=="G"&&(this.game.cullOffCamera=!this.game.cullOffCamera),t.key in this.keyMap&&this.set(this.keyMap[t.key],!0)}keyUpHandler(t){t.key in this.keyMap&&this.set(this.keyMap[t.key],!1)}}class wt extends G{constructor(t,e){super(),this.game=t,this.gamepad=e,this.thresh=.2,this.internalStates={...this.controlStates}}set(t,e=!0){this.internalStates[t]!=e&&(this.internalStates[t]=e,super.set(t,e))}vibrate(t,e,s){this.game.activePlayers.length==1&&window.navigator.vibrate(s),this.gamepad.vibrationActuator!=null&&this.gamepad.vibrationActuator.playEffect("dual-rumble",{startDelay:0,duration:s,weakMagnitude:t,strongMagnitude:e})}}class mt{constructor(t){o(this,"gamepads",{});let e=this;this.game=t,window.addEventListener("gamepadconnected",function(s){e.connected(s)}),window.addEventListener("gamepaddisconnected",function(s){e.disconnected(s)})}connected(t){this.gamepads[t.gamepad.index]=new wt(this.game,t.gamepad)}disconnected(t){let e=this.gamepads[t.gamepad.index];e.player!=null&&(e.player.dead=!0,e.player.dropFromGame=!0),delete this.gamepads[t.gamepad.index]}update_gamepad_states(){let t=navigator.getGamepads();if(t!=null)for(let e of t){if(e==null)continue;let s=this.gamepads[e.index];s.gamepad=e,s.set("dash",this.buttonPressed(e.buttons[0])),s.set("cycle",this.buttonPressed(e.buttons[1])||this.buttonPressed(e.buttons[6])),s.set("use",this.buttonPressed(e.buttons[2])||this.buttonPressed(e.buttons[7])),s.set("dodge",this.buttonPressed(e.buttons[5])),s.set("camera",this.buttonPressed(e.buttons[12])),s.set("menu",this.buttonPressed(e.buttons[9])),s.set("left",e.axes[0]<-s.thresh&&e.axes[0]<-.5*Math.abs(e.axes[1])),s.set("right",e.axes[0]>s.thresh&&e.axes[0]>.5*Math.abs(e.axes[1])),s.set("up",e.axes[1]<-s.thresh&&e.axes[1]<-.5*Math.abs(e.axes[0])),s.set("down",e.axes[1]>s.thresh&&e.axes[1]>-.5*Math.abs(e.axes[0]))}}buttonPressed(t){return typeof t=="object"?t.pressed:t==1}attach_all_to_player(t){for(let e of Object.keys(this.gamepads))this.gamepads[e].attach_to_player(t)}release_all_players(){for(let t of Object.keys(this.gamepads))this.gamepads[t].attach_to_player()}}class yt extends G{constructor(e){super();o(this,"canvas");this.game=e;const s=document.getElementById("canvas");if(s instanceof HTMLCanvasElement){this.canvas=s;let i=this;s.addEventListener("touchstart",function(a){i.process_touchstart(a)},!1),s.addEventListener("touchmove",function(a){i.process_touchmove(a)},!1),s.addEventListener("touchcancel",function(a){i.process_touchend(a)},!1),s.addEventListener("touchend",function(a){i.process_touchend(a)},!1),document.addEventListener("backbutton",function(a){i.process_back(a)},!0)}this.dPad=[-1,0,0],this.butJump=[-1,0,0],this.butInv=[-1,0,0],this.butUse=[-1,0,0],this.butCamera=[-1,0,0]}process_back(e){console.log("Back pressed",e),this.set("menu",!0)}process_touchstart(e){let s=this.canvas;e.touches[0];for(let i of e.changedTouches)i.clientX<.5*s.width?i.clientY>.33*s.height?this.dPad=[i.identifier,i.clientX,i.clientY]:(this.set("camera"),this.butCamera=[i.identifier,i.clientX,i.clientY]):i.clientY>.66*s.height?(this.set("jump"),this.butJump=[i.identifier,i.clientX,i.clientY]):i.clientY<.33*s.height?(this.set("cycle"),this.butInv=[i.identifier,i.clientX,i.clientY]):(this.set("use"),this.butUse=[i.identifier,i.clientX,i.clientY]);e.preventDefault()}process_touchmove(e){for(let s of e.changedTouches)if(s.identifier==this.dPad[0]){let i=this.dPad[1],a=this.dPad[2];for(let l of["left","right","up","down","run","camera"])this.set(l,!1);this.set("left",s.clientX<i-.1*this.game.tileSize&&s.clientX-i<-.5*Math.abs(s.clientY-a)),this.set("right",s.clientX>i+.1*this.game.tileSize&&s.clientX-i>.5*Math.abs(s.clientY-a)),this.set("up",s.clientY<a-.1*this.game.tileSize&&s.clientY-a<-.5*Math.abs(s.clientX-i)),this.set("down",s.clientY>a+.1*this.game.tileSize&&s.clientY-a>.5*Math.abs(s.clientX-i)),this.set("run",s.clientX<i-this.game.tileSize||s.clientX>i+this.game.tileSize||s.clientY>a+this.game.tileSize||s.clientY<a-this.game.tileSize)}e.preventDefault()}process_touchend(e){for(let s of e.changedTouches){if(s.identifier==this.dPad[0]){for(let i of["left","right","up","down"])this.set(i,!1);this.dPad=[-1,0,0]}s.identifier==this.butInv[0]&&this.set("cycle",!1),s.identifier==this.butUse[0]&&this.set("use",!1),s.identifier==this.butJump[0]&&this.set("jump",!1),s.identifier==this.butCamera[0]&&this.set("camera",!1)}e.preventDefault()}vibrate(e,s,i){window.navigator.vibrate(i)}}class X extends p{constructor(t,e=null,s=!0,i=!1){super([t[0],t[1],1,1]),this.sprite=e,this.passable=s,this.climbable=i,this.climbSpeed=1/300,this.hp=100}bounds(){return new p([this.x,this.y,1,1])}dist(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}draw(t){this.sprite!=null&&t.sprites.base.draw(this.sprite,this.x,this.y)}playerInteract(t,e,s){}entityInteract(t,e,s){}initItems(t){}hitFrom(t,e,s,i){}}class v extends X{constructor(t,e=null){super(t,e,!0,!1)}}function St(h){_.riverTimer+=h,_.riverSprite=[u.Water1,u.Water2,u.Water3,u.Water4][Math.floor(_.riverTimer/500)%4]}class gt extends X{constructor(){super(...arguments);o(this,"passable",!1)}}const Y=class Y extends X{constructor(t,e=null){super(t,e,!0,!1)}draw(t){super.draw(t),t.sprites.base.draw(Y.riverSprite,this.x,this.y)}};o(Y,"riverTimer",0),o(Y,"riverSprite");let _=Y;class O extends X{constructor(t,e=null){e==null&&(e=W([u.Snow1,u.Snow1,u.Snow1,u.Snow1,u.Snow1,u.Snow1,u.Snow2,u.Snow3])),super(t,e,!0,!1)}draw(t){super.draw(t),t.sprites.base.draw(u.Water,this.x,this.y),t.sprites.base.draw(u.Water,this.x,this.y)}}class b{constructor(t,e){this.pos=new d([0,0]),this.vel=new d([0,0]),this.oldVel=new d([0,0]),this.angle=0,this.isPlayer=!1,this.size=new d([1,1]),this.boundingBox=new p([.25,.25,.5,.5]),this.boundingBoxes=[],this.facing=1,this.falling=!1,this.canFall=!0,this.dead=!1,this.sprite=e,this.hitBox=new p(this.boundingBox),this.move(t),this.oldPos=new d(this.pos)}move(t){t!==null?this.pos=new d([t[0],t[1]]):this.pos=new d([-1,-1])}rotatedBoundingBox(t=null,e=null,s=null,i=null,a=null){s=s??this.getFlipped(),e=e??this.angle,t==null&&(t=this.sprite.length==2?[.5,.5]:[.5*this.sprite[2],.5*this.sprite[3]]),i==null&&(i=[this.boundingBox[0]+this.boundingBox[2]/2,this.boundingBox[1]+this.boundingBox[3]/2]),a==null&&(a=this.boundingBox.slice(2,4));let l=(i[0]-t[0])*(1-2*s),r=i[1]-t[1],c=Math.cos(e/180*Math.PI),w=Math.sin(e/180*Math.PI),g=-(l-l*c+r*w),f=-(r-l*w-r*c);return new p([(i[0]-t[0])*(1-2*s)+t[0]+g-a[0]/2,i[1]+f-a[1]/2,a[0],a[1]])}bounds(t=null,e=null){return t==null&&(t=this.pos),e==null&&(e=this.boundingBox!=null?this.boundingBox:this.boundingBoxes[0]),new p([t[0]+e[0],t[1]+e[1],e[2],e[3]])}hitBounds(t=null){return t==null&&(t=this.pos),new p([t[0]+this.hitBox[0],t[1]+this.hitBox[1],this.hitBox[2],this.hitBox[3]])}getDisplayX(){return this.pos.x}getDisplayY(){return this.pos.y}getFlipped(){return this.facing==-1}draw(t){t.sprites.base.draw([this.sprite[0],this.sprite[1]],this.getDisplayX(),this.getDisplayY(),this.getFlipped())}draw_bounds(t){if(this.boundingBox!=null){let e=this.bounds(this.pos,this.boundingBox);e[0]=e[0]*t.tileSize+t.shakeX+t.gameOffsetX,e[1]=e[1]*t.tileSize+t.shakeY+t.gameOffsetY,e[2]=e[2]*t.tileSize,e[3]=e[3]*t.tileSize,t.ctx.beginPath(),t.ctx.lineWidth=t.tileSize/16,t.ctx.strokeStyle="#BAC3D9",t.ctx.rect(e[0],e[1],e[2],e[3]),t.ctx.stroke()}else for(let e of this.boundingBoxes){let s=this.bounds(this.pos,e);s[0]=s[0]*t.tileSize+t.shakeX+t.gameOffsetX,s[1]=s[1]*t.tileSize+t.shakeY+t.gameOffsetY,s[2]=s[2]*t.tileSize,s[3]=s[3]*t.tileSize,t.ctx.beginPath(),t.ctx.lineWidth=t.tileSize/16,t.ctx.strokeStyle="#BAC3D9",t.ctx.rect(s[0],s[1],s[2],s[3]),t.ctx.stroke()}}entityInteract(t,e,s){}entityCollide(t,e){}update(t,e){}}class U extends b{constructor(t,e,s=1){super(t,e),this.hp=s,this.maxHp=s,this.facing=j(0,1)*2-1,this.topSpeed=1/600,this.jumpSpeed=1/350,this.maxFallSpeed=1/50,this.hitDamage=1,this.spawnTimer=1e3,this.spawnElapsed=0,this.stunTimer=new M(0,0),this.hitTimer=new M(0,0),this.boundingBox=new p([.25,.5,.5,.5]),this.hitBox=new p([.25,.2,.5,.8]),this.drone=!1,this.climbing=!1,this.falling=!1,this.dying=!1,this.intelLevel=1,this.elevation=0,this.stance="aggressive"}getDisplayY(){return super.getDisplayY()-this.elevation}draw(t){t.sprites.monsters.draw([this.dying?1:0,this.sprite[1]],this.getDisplayX(),this.getDisplayY(),this.getFlipped()),this.hitTimer.finished()||u.Strike.length===2&&t.sprites.entitiesItems.draw(u.Strike,this.getDisplayX(),this.getDisplayY(),this.getFlipped())}die(t){this.stun(),this.dying=!0}death(t){if(this.dead=!0,!this.isPlayer){let e=t.tiles.closestTile(this.bounds());if(e instanceof v)return;t.addChips(e,1)}}heal(t){this.hp=Math.min(this.maxHp,this.hp+t)}tile_pos(){return new d([Math.round(this.pos.x),Math.ceil(this.pos.y)])}stun(t=2e3){this.dying||this.stunTimer.reset(t)}update(t,e){if(this.spawnElapsed+=e,this.spawnElapsed<this.spawnTimer)return;this.hitTimer.tick(e),this.stunTimer.tick(e);let s=!this.stunTimer.finished();if(!s&&this.dying){this.death(t);return}if(this.dying&&(this.vel=this.vel.scale(.9**(e/15))),t.tiles.move(this,e),!s)for(let i of t.activePlayers)i.hitBounds().collide(this.bounds())&&(i.hitFrom(t,this.pos,this.hitDamage,this.hitDamage),i.stun(500*this.hitDamage));this.pos.y>t.tiles.dimH&&this.die(t)}hitFrom(t,e,s,i=0){this.hp-=s,s>0&&this.hitTimer.reset(200),this.hp<=0&&this.die(t);const a=this.pos.dist(e);if(a>0){const l=this.pos.add(e.scale(-1)).scale(1/a);this.vel.x=i*1/200*l[0],this.vel.y=i*1/200*l[1]}this.falling=!0}tile_collide(t){return t.bounds.collide(this.bounds())}monster_collide(t){return t.bounds.collide(this.bounds())}fallCheck(t,e){return!1}}class xt extends U{constructor(t){super(t,u.Soldier1,1),this.hp=1,this.topSpeed=.5*this.topSpeed,this.fallOrigin=null,this.stance="passive"}draw(t){if(this.dead||this.dying){t.sprites.base.drawRotated(u.Soldier1,this.getDisplayX(),this.getDisplayY(),90,this.getFlipped());return}u.Soldier1.length===2&&t.sprites.base.draw(u.Soldier1,this.getDisplayX(),this.getDisplayY(),this.getFlipped())}update(t,e){super.update(t,e)}}class K extends U{constructor(t){super(t,u.Hessian1,1),this.hp=1,this.topSpeed=.5*this.topSpeed,this.fallOrigin=null,this.stance="passive",this.launchTimer=new M(1e4,Math.random()*5e3),this.launching=0}draw(t){if(u.Hessian1.length===2){if(this.dead||this.dying){t.sprites.base.drawRotated(u.Hessian1,this.getDisplayX(),this.getDisplayY(),90,this.getFlipped());return}t.sprites.base.draw(u.Hessian1,this.getDisplayX(),this.getDisplayY(),this.getFlipped()),t.sprites.base.draw(u.HessianHelmet1,this.getDisplayX(),this.getDisplayY()-.5,this.getFlipped()),t.sprites.base.draw(this.launchTimer.elapsed-this.launchTimer.timer>1e3?u.Rifle1:u.Rifle2,this.getDisplayX()+this.facing*.375,this.getDisplayY()+.25,!this.getFlipped())}}update(t,e){if(super.update(t,e),this.dead||this.dying)return;const s=t.activePlayers[0];if(!(this.pos.dist(s.pos)>20)&&(this.facing=s.pos[0]>this.pos[0]?1:-1,this.launchTimer.tick(e),this.launchTimer.finished())){if(this.launching<=2){this.launchTimer.reset(500);const[i,a]=this.pos.scale(-1).add(s.pos);let l=Math.atan2(a,i)*180/Math.PI;l=Math.round(l/45)*45,t.items.push(new Tt(t.tiles.at(this.tile_pos()),null,l))}else this.launching=0,this.launchTimer.reset(2e3-0*Math.random());this.launching++}}}const A=0,Z=1,C=2,R=3,z=4,E=5;class I extends U{constructor(e=-1,s=null){super(s,[0,e],3);o(this,"isPlayer",!0);o(this,"boundingBox",new p([.25,.5,.5,.5]));o(this,"hitBox",new p([.25,.25,.5,.5]));o(this,"dashBox",new p([0,0,1,1]));o(this,"immunityTimer",new M(1e3,1e3));o(this,"selectedTimer",new M(500,500));o(this,"dashTimer",new M(3e3,3e3));o(this,"hitTimer",new M(500,500));o(this,"stunTimer",new M(500,500));o(this,"jumpTimer",new M(0,0));o(this,"selectedSprite",null);o(this,"escaped",!1);o(this,"running",!1);o(this,"climbing",!1);o(this,"aiming",!1);o(this,"dropFromGame",!1);o(this,"startLevel",0);o(this,"lastVel",new d([0,0]));o(this,"dodgeOrigin",new d(this.pos));o(this,"holding","sword");o(this,"ridingBoat",!1);o(this,"maxHp",4);o(this,"topSpeed",1/250);o(this,"jumpSpeed",1/135);o(this,"maxFallSpeed",1/50);o(this,"airJumps",0);o(this,"wallJumps",0);o(this,"spikedBoots",0);o(this,"chips",0);o(this,"dead",!1);o(this,"score",0);o(this,"deaths",0);o(this,"pause",0);o(this,"lastFacing",0);o(this,"lastFramePos",new d([0,0]));o(this,"currentFrame",0);o(this,"useTimer",new M(0));o(this,"hookHitModifier",[]);o(this,"hookUpdate",[]);o(this,"activeState",z);o(this,"stateTimer",new M);o(this,"controller",null);this.controlStates={...N()},this.newControlStates={...N()},this.oldControlStates={...N()},this.sprite=[0,8],this.setAnimationFrames()}dashBounds(){const e=this.vel.x>0?.5:this.vel.x<0?-.5:0,s=this.vel.y>0?.5:this.vel.y<0?-.5:0,i=[this.pos.x+e,this.pos.y+s];return this.dashBox.shift(i)}setAnimationFrames(){this.animationFrames={WALK_EW:[new d([1,0]),new d([4,0]),new d([4,0]),new d([3,0]),new d([3,0]),new d([2,0]),new d([2,0]),new d([1,0])],WALK_N:[new d([1,0]),new d([2,0]),new d([1,0]),new d([2,0])],WALK_S:[new d([1,0]),new d([2,0]),new d([1,0]),new d([2,0])],DASH_EW:[new d([1,0]),new d([2,0]),new d([2,0])],DASH_N:[new d([14,0]),new d([15,0]),new d([15,0]),new d([14,0])],DASH_S:[new d([12,0]),new d([13,0]),new d([13,0]),new d([12,0])],STAND:[new d([0,0])]}}cycleSprite(e){let s=e.other_players(this).map(i=>i.sprite[1]);for(;this.sprite[1]++,this.sprite[1]>=4&&(this.sprite[1]=0),!!s.includes(this.sprite[1]););this.setAnimationFrames()}die(e){if(this.dead)return;this.dead=!0,this.hp=0,this.deaths++;let s=W(["dead1","dead2","dead3","dead4","dead5","dead6","dead7","dead8"]);this.setState(e,E),e.playSound(s)}enterState(e,s){switch(s){case C:const i=this.dashTimer.finished()?.01:.004;this.vel.x>0&&(this.vel.x=1),this.vel.x<0&&(this.vel.x=-1),this.vel.y>0&&(this.vel.y=1),this.vel.y<0&&(this.vel.y=-1);const a=this.vel.dist([0,0]);a>0&&(this.vel=this.vel.scale(i/a));break}this.activeState=s}exitState(e,s){}updateState(e,s){switch(this.activeState){case z:case A:if(this.entityInteract(e),this.stunTimer.finished()){if(this.moveCheck(e,s,this.running),this.cycleInventoryCheck(e,s),this.vel.x!==0||this.vel.y!==0){if(!this.oldControlStates.dodge&&this.controlStates.dodge){this.setState(e,R),this.dodgeOrigin=new d(this.pos);return}else if(!this.oldControlStates.dash&&this.controlStates.dash){this.setState(e,C),this.dashTimer.reset();return}}this.activeState===z&&this.setState(e,A)}this.vel.x===0&&this.vel.y===0&&this.activeState===A&&this.setState(e,z),this.tileInteract(e,s);break;case Z:this.stunTimer.finished()&&(this.entityInteract(e),this.setState(e,A),this.stunTimer.finished()&&(this.moveCheck(e,s,!1),this.cycleInventoryCheck(e,s)),this.tileInteract(e,s)),!this.jumpTimer.finished()&&this.vel.y<0&&!this.controlStates.dash&&(this.vel.y*=.5**(s/15));break;case C:this.entityInteract(e);for(let i of e.monsters)i.hitBounds().collide(this.dashBounds())&&(i.hitFrom(e,this.pos,1,2),i.stun());this.stateTimer.elapsed>100&&this.setState(e,z);break;case R:this.entityInteract(e),this.stunTimer.finished()&&(this.moveCheck(e,s,!0),this.cycleInventoryCheck(e,s)),!this.oldControlStates.dash&&this.controlStates.dash&&(this.vel.x!==0||this.vel.y!==0)&&this.setState(e,C),this.tileInteract(e,s),this.stateTimer.elapsed>500&&this.setState(e,z);break;case E:this.driftCheck(e,s,!1);break}}revive(e){this.dead=!1,this.setState(e,A),this.hp=e.competitiveMode?this.maxHp:1}hitFrom(e,s,i,a=0){if(!this.dead&&!this.escaped&&this.activeState!==R&&this.immunityTimer.finished()){for(let l of this.hookHitModifier)[i,a]=l.hitModifier(i,a);super.hitFrom(e,s,i,a),this.immunityTimer.reset(),e.playSound("hit1")}}use(e,s){this.useTimer.reset(s)}draw(e){const s=this.activeState===C?this.animationFrames.DASH_EW:this.animationFrames.WALK_EW;let i=this.getFlipped();if(this.escaped)return;let a=[0,0];if(this.dead?(a=[0,a[1]],this.currentFrame=0,this.lastFramePos=new d(this.pos)):this.activeState===Z?(a=[0,a[1]],this.currentFrame=0,this.lastFramePos=new d(this.pos)):this.activeState===z?(a=u.Washington1,this.currentFrame=0,this.lastFramePos=new d(this.pos)):this.activeState===R?(a=u.WashingtonDodge,this.currentFrame=0,this.lastFramePos=new d(this.pos)):(this.facing!==this.lastFacing?(this.currentFrame=0,this.lastFramePos=new d(this.pos)):this.pos.dist(this.lastFramePos)*4>=1&&(this.currentFrame+=Math.floor(this.pos.dist(this.lastFramePos)*4),this.lastFramePos=new d(this.pos)),this.currentFrame=this.currentFrame%s.length,a=s[this.currentFrame]),this.activeState===R){if(e.ctx.globalAlpha=.75,this.vel.x===0){if(this.vel.y<0){const l=this.pos.y-this.dodgeOrigin.y;e.sprites.base.drawRotatedMultitile([21,4-l,1,.5+l],this.pos.x,this.pos.y,0,!i)}else if(this.vel.y>0){const l=this.dodgeOrigin.y-this.pos.y;e.sprites.base.drawRotatedMultitile([21,1,1,.5+l],this.pos.x,this.dodgeOrigin.y,0,!i)}}else if(this.vel.x>0){const l=Math.min(this.pos.x-this.dodgeOrigin.x,3.5);e.sprites.base.drawRotatedMultitile([24.5-l,0,.5+l,1],this.dodgeOrigin.x,this.pos.y,0,!i)}else if(this.vel.x<0){const l=Math.min(this.dodgeOrigin.x-this.pos.x,3.5);e.sprites.base.drawRotatedMultitile([24.5-l,0,.5+l,1],this.pos.x+.5,this.pos.y,0,!i)}e.ctx.globalAlpha=1}if(this.activeState===E?e.sprites.base.drawRotated([a[0],a[1]],this.getDisplayX(),this.getDisplayY(),i?270:90,!i):e.sprites.base.draw([a[0],a[1]],this.getDisplayX(),this.getDisplayY(),!i),this.activeState===C){const l=this.currentFrame===0?this.facing*.25:this.facing*.5;e.sprites.base.draw(this.currentFrame===0?u.Sword2:u.Sword3,this.getDisplayX()+l,this.getDisplayY(),!i)}else{const l=this.facing*.5;e.sprites.base.draw(u.Sword1,this.getDisplayX()+l,this.getDisplayY(),!i)}this.hitTimer.finished()||u.Strike.length===2&&e.sprites.base.draw(u.Strike,this.getDisplayX(),this.getDisplayY(),!this.getFlipped()),this.lastFacing=this.facing}drawHUD(e,s){u.Health.length===2&&e.sprites.base.draw(u.Health,s.x,s.y),e.drawTileText(""+Math.ceil(this.hp),.5*e.tileSize,s.add([0,-.25]),"White")}update(e,s){if(!this.escaped){new d(this.vel),new d(this.pos),this.immunityTimer.tick(s),this.stateTimer.tick(s),this.jumpTimer.tick(s),this.hitTimer.tick(s),this.useTimer.tick(s),this.stunTimer.tick(s),this.selectedTimer.tick(s),this.dashTimer.tick(s),this.updateState(e,s);for(let i of this.hookUpdate)i.update(e,s,this);this.activeState!=E&&this.pos.y>e.tiles.dimH+3&&this.die(e),this.lastVel=new d(this.vel),e.tiles.move(this,s)}}driftCheck(e,s,i){const a=15625e-8;this.vel.x=this.vel.x>0?Math.max(this.vel.x-a*s/15,0):Math.min(this.vel.x+a*s/15,0),this.vel.y=this.vel.y>0?Math.max(this.vel.y-a*s/15,0):Math.min(this.vel.y+a*s/15,0)}moveCheck(e,s,i){this.controlStates.left?(this.vel.x=Math.max(-this.topSpeed*(i?2:1),this.vel.x-1/1600*s/15),this.facing=-1):!i&&this.vel.x<0&&(this.vel.x=0),this.controlStates.right?(this.vel.x=Math.min(this.topSpeed*(i?2:1),this.vel.x+1/1600*s/15),this.facing=1):!i&&this.vel.x>0&&(this.vel.x=0),this.controlStates.up?this.vel.y=Math.max(-this.topSpeed*(i?2:1),this.vel.y-1/1600*s/15):!i&&this.vel.y<0&&(this.vel.y=0),this.controlStates.down?this.vel.y=Math.min(this.topSpeed*(i?2:1),this.vel.y+1/1600*s/15):!i&&this.vel.y>0&&(this.vel.y=0)}cycleInventoryCheck(e,s){this.controlStates.cycle&&this.oldControlStates.cycle}entityInteract(e){for(let s=0;s<e.items.length;s++)this.bounds().collide(e.items[s].bounds())&&(e.items[s].entityCollide(e,this),this.aiming||(this.controlStates.up&&e.items[s].entityInteract(e,this,"up"),this.controlStates.down&&e.items[s].entityInteract(e,this,"down")))}tileInteract(e,s){if(this.controlStates.up){let i=e.tiles.closestTile(this.bounds());i instanceof v||i.entityInteract(e,this,"up")}if(this.controlStates.down){let i=e.tiles.closestTile(this.bounds());if(!(i instanceof v)){i.entityInteract(e,this,"down");let a=e.tiles.below(i.pos);!(a instanceof v)&&a.tile.y==this.bounds().bottom&&a.tile.entityInteract(e,this,"down")}}}setState(e,s){this.exitState(e,this.activeState),this.enterState(e,s),this.stateTimer.reset()}}class vt extends b{constructor(t,e=null){e==null&&(e=W([F.Tree1,F.Tree2])),super(t,e)}entityCollide(t,e){if(e.isPlayer){const[s,i,a,l]=e.bounds(),[r,c,w,g]=this.bounds(),f=Math.min(s+a-r,r+w-s),y=Math.min(i+l-c,c+g-i);f>0&&y>0&&(f<=y?e.pos[0]+=s<r?-f:f:e.pos[1]+=i<c?-y:y),e.vel[0]=0,e.vel[1]=0}}bounds(){return new p([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){t.sprites.base.drawRotatedMultitile(this.sprite,this.pos[0]-.5,this.pos[1]-1,0,!1)}}class bt extends b{constructor(t,e=null){e==null&&(e=W([F.Tree1,F.Tree2])),super(t,e)}entityCollide(t,e){if(e.isPlayer){const[s,i,a,l]=e.bounds(),[r,c,w,g]=this.bounds(),f=Math.min(s+a-r,r+w-s),y=Math.min(i+l-c,c+g-i);f>0&&y>0&&(f<=y?e.pos[0]+=s<r?-f:f:e.pos[1]+=i<c?-y:y),e.vel[0]=0,e.vel[1]=0}}bounds(){return new p([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){t.sprites.base.drawRotatedMultitile(F.BoatBack,this.pos[0],this.pos[1],0,!1),t.sprites.base.drawRotatedMultitile(F.BoatFront,this.pos[0],this.pos[1],0,!1)}}class Mt extends b{constructor(t,e=null){e==null&&(e=W([u.Iceberg1,u.Iceberg2,u.Iceberg3])),super(t,e)}entityCollide(t,e){if(e.isPlayer){const[s,i,a,l]=e.bounds(),[r,c,w,g]=this.bounds(),f=Math.min(s+a-r,r+w-s),y=Math.min(i+l-c,c+g-i);f>0&&y>0&&(f<=y?e.pos[0]+=s<r?-f:f:e.pos[1]+=i<c?-y:y),e.vel[0]=0,e.vel[1]=0}}bounds(){return new p([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){this.sprite.length===2&&t.sprites.base.draw(this.sprite,this.pos[0],this.pos[1])}}class kt extends b{constructor(t,e=null){e==null&&(e=W([F.HouseBlue,F.HouseRed])),super(t,e)}entityCollide(t,e){if(e.isPlayer){const[s,i,a,l]=e.bounds(),[r,c,w,g]=this.bounds(),f=Math.min(s+a-r,r+w-s),y=Math.min(i+l-c,c+g-i);f>0&&y>0&&(f<=y?e.pos[0]+=s<r?-f:f:e.pos[1]+=i<c?-y:y),e.vel[0]=0,e.vel[1]=0}}bounds(){return new p([this.pos[0],this.pos[1]+2,8,4.5])}draw(t){t.sprites.base.drawRotatedMultitile(this.sprite,this.pos[0],this.pos[1],0,!1)}}class Pt{constructor(){o(this,"flakes",[]);o(this,"maxFlakes",100);o(this,"fallSpeed",1/100);o(this,"xySpeed",1/200);o(this,"xWind",0);o(this,"yWind",0);o(this,"sprite",u.SnowFlake1)}reset(){this.flakes=[]}changeMode(t){t==="snow"?(this.flakes=[],this.sprite=u.SnowFlake1,this.fallSpeed=1/50,this.xySpeed=1/200):(this.flakes=[],this.sprite=u.Sleet,this.fallSpeed=1/3,this.xySpeed=0,this.xWind=-1/30)}update(t,e){const s=new p([t.camera.x,t.camera.y,t.camera.w,t.camera.h]);for(let i of this.flakes)i[0]<s.x&&(i[0]+=s.w),i[0]>s.right&&(i[0]-=s.w),i[1]<s.y&&(i[1]+=s.h),i[1]>s.bottom&&(i[1]-=s.h),i[2]-=(.5+.5*Math.random())*15/e*this.fallSpeed,i[1]+=(Math.random()-.5)*15/e*this.xySpeed+15/e*this.yWind,i[0]+=(Math.random()-.5)*15/e*this.xySpeed+15/e*this.xWind;for(this.flakes=this.flakes.filter(i=>i[2]>=0);this.flakes.length<this.maxFlakes;)this.flakes.push([s.x+Math.random()*s.w,s.y+Math.random()*s.h,Math.random()*s.h])}draw(t,e){for(let s of this.flakes)t.sprites.base.draw(this.sprite,s[0],s[1]-s[2])}}class Tt extends b{constructor(t,e=null,s){super(t,u.OrangeBullet),this.vel[0]=Math.cos(s*Math.PI/180)*1/100,this.vel[1]=Math.sin(s*Math.PI/180)*1/100,this.angle=s}entityCollide(t,e){e.isPlayer&&(e.hitFrom(t,this.pos,1,1),this.dead=!0)}update(t,e){super.update(t,e),t.tiles.move(this,e,this.vel.scale(e/15)),(this.pos.x<-1||this.pos.y<-1||this.pos.x>t.tiles.dimW||this.pos.y>t.tiles.dimH||this.vel.dist([0,0])===0)&&(this.dead=!0)}bounds(){return new p([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){this.sprite.length===2&&t.sprites.base.drawRotated(this.sprite,this.pos[0],this.pos[1],this.angle+180)}}class Ft extends b{constructor(t){super(t,u.Cheese),this.pos}entityCollide(t,e){t.competitiveMode?e instanceof I&&(e.score+=1):(t.score++,t.cellsCollected++),t.playSound("pickup1"),this.dead=!0}entityInteract(t,e,s){this.dead||(t.score++,t.cellsCollected++,t.playSound("pickup1"),this.dead=!0)}}class Ht extends b{constructor(t,e=1){super(t,u.Sausage),this.value=e}entityCollide(t,e){t.score++,e instanceof I&&(t.playSound("pickup2"),e.hp<e.maxHp&&e.hp++,this.dead=!0)}entityInteract(t,e,s){!this.dead&&e instanceof I&&(e.hp<e.maxHp&&e.hp++,t.score++,t.playSound("pickup2"),this.dead=!0)}}class zt extends b{constructor(t,e){super(t,[1,e.sprite[1]]),this.elapsed=0,this.timer=3e3}update(t,e){this.elapsed+=e,this.elapsed>this.timer&&(this.dead=!0)}draw(t){this.sprite.length===2&&t.sprites.players.draw(this.sprite,this.getDisplayX(),this.getDisplayY(),this.getFlipped())}}class Dt extends b{constructor(t,e){super(null,null),this.sound=t,this.delay=e,this.elapsed=0}update(t,e){this.elapsed+=e,this.elapsed>this.delay&&(t.playSound(this.sound),this.dead=!0)}draw(){}}class _t extends b{constructor(t,e=250){super(t,u.Boom),this.timer=e,this.elapsed=0}update(t,e){if(this.elapsed+=e,this.elapsed>=this.timer){this.dead=!0;let s=t.tiles.get(this.pos);s instanceof O||s.replace(O)}}}class Wt extends b{constructor(t){super(null,u.TrapBlade),this.platform=t,this.triggered=!1,t.type=="static"?this.pos=new d(this.platform.shift([0,-1])):this.pos=new d(this.platform),this.facing=1,this.boundingBox=new p([.125,.25,.75,.75]),this.elapsed=0}update(t,e){let s=this.platform;if(t.tiles.at(s.pos)!=s&&(this.dead=!0),this.elapsed+=e,s.type=="contact")if(this.pos.y==s.y&&this.vel.y==0){for(let a of t.activePlayers)if(a.bounds().collide(t.tiles.at(s).shift([0,-1]))){this.vel.y=-1/s.extendTime,this.elapsed=0;break}}else this.pos.y==s.y-1&&this.elapsed>=s.extendedTime&&(this.vel.y=1/s.extendTime,this.elapsed=0);else s.type=="cycling"&&(this.pos.y==s.y-1&&this.elapsed>=s.extendedTime&&(this.vel.y=1/s.extendTime,this.elapsed=0),this.pos.y==s.y&&this.elapsed>=s.retractedTime&&(this.vel.y=-1/s.extendTime,this.elapsed=0));for(let a of t.monsters_and_players())this.bounds().collide(a.bounds())&&(a.hitFrom(t,this.pos,s.damage,1),a.isPlayer||a.stun(500));let i=this.elapsed>s.contactDelay||s.type!=="contact"?this.vel.y:0;this.pos.y=Math.min(Math.max(this.pos.y+i*e,s.y-1),s.y),(this.pos.y==s.y-1&&this.vel.y<0||this.pos.y==s.y&&this.vel.y>0)&&(this.vel.y=0)}drawAsTile(t){this.sprite.length===2&&t.sprites.entitiesItems.draw(this.sprite,this.getDisplayX(),this.getDisplayY(),this.getFlipped())}draw(t){}}function n(h,t){return[h,t]}function S(h,t,e,s){return[h,t,e,s]}class Ct{constructor(t,e,s=16){this.spriteSize=s,this.sheet=new Image,this.sheet.src=e,this.game=t}draw(t,e,s,i=!1){let a=i?-1:1;i&&this.game.ctx.scale(-1,1),this.game.ctx.drawImage(this.sheet,t[0]*this.spriteSize,t[1]*this.spriteSize,this.spriteSize,this.spriteSize,a*(e*this.game.tileSize+this.game.shakeX+this.game.gameOffsetX),s*this.game.tileSize+this.game.shakeY+this.game.gameOffsetY,a*this.game.tileSize,this.game.tileSize),i&&this.game.ctx.scale(-1,1)}drawScaled(t,e,s,i,a=!1){let l=a?-1:1;a&&this.game.ctx.scale(-1,1),this.game.ctx.drawImage(this.sheet,t[0]*this.spriteSize,t[1]*this.spriteSize,this.spriteSize,this.spriteSize,l*Math.floor(e*this.game.tileSize+this.game.shakeX+this.game.gameOffsetX),Math.floor(s*this.game.tileSize+this.game.shakeY+this.game.gameOffsetY),l*this.game.tileSize*i,this.game.tileSize*i),a&&this.game.ctx.scale(-1,1)}drawRotated(t,e,s,i,a=!1,l="center"){const r=this.game;r.ctx.save(),l=="center"?l=[r.tileSize/2,r.tileSize/2]:l=[Math.floor(l[0]*r.tileSize),Math.floor(l[1]*r.tileSize)],r.ctx.translate(Math.floor(e*r.tileSize+r.shakeX+r.gameOffsetX+l[0]),Math.floor(s*r.tileSize+r.shakeY+r.gameOffsetY+l[1])),r.ctx.rotate(i*Math.PI/180),a&&r.ctx.scale(-1,1),r.ctx.translate(-l[0],-l[1]),r.ctx.drawImage(this.sheet,t[0]*this.spriteSize,t[1]*this.spriteSize,this.spriteSize,this.spriteSize,0,0,r.tileSize,r.tileSize),r.ctx.restore()}drawRotatedMultitile(t,e,s,i,a=!1,l="center"){const r=this.game;r.ctx.save();let c=t[2],w=t[3];l=="center"?l=[c*r.tileSize/2,w*r.tileSize/2]:l=[Math.floor(l[0]*r.tileSize),Math.floor(l[1]*r.tileSize)],r.ctx.translate(Math.floor(e*r.tileSize+r.shakeX+r.gameOffsetX+l[0]),Math.floor(s*r.tileSize+r.shakeY+r.gameOffsetY+l[1])),r.ctx.rotate(i*Math.PI/180),a&&r.ctx.scale(-1,1),r.ctx.translate(-l[0],-l[1]),r.ctx.drawImage(this.sheet,t[0]*this.spriteSize,t[1]*this.spriteSize,this.spriteSize*c,this.spriteSize*w,0,0,r.tileSize*c,r.tileSize*w),r.ctx.restore()}}const u=Object.freeze({Health:n(12,0),Snow1:n(0,4),Snow2:n(1,4),Snow3:n(2,4),Snow4:n(3,4),ShoreSW:n(4,4),ShoreNE:n(6,4),ShoreS:n(5,4),ShoreN:n(7,4),Water1:n(0,5),Water2:n(1,5),Water3:n(2,5),Water4:n(3,5),Iceberg1:n(0,6),Iceberg2:n(1,6),Iceberg3:n(2,6),SnowFlake1:n(3,6),SnowFlake2:n(4,6),Sleet:n(5,6),CannonBall:n(7,3),RedBullet:n(8,3),OrangeBullet:n(9,3),PiercingBullet:n(10,3),Cheese:n(12,1),Sausage:n(13,1),StoneHighlighted:n(42,0),Stone:n(43,0),Sword1:n(30,0),Sword2:n(31,0),Sword3:n(32,0),Pistol1:n(33,0),Pistol2:n(34,0),Pistol3:n(35,0),Pistol4:n(36,0),Pistol5:n(38,0),Pistol6:n(39,0),Pistol7:n(40,0),Pistol8:n(41,0),HessianHelmet1:n(10,1),HessianHelmet2:n(11,1),Rifle1:n(10,2),Rifle2:n(11,2),Washington1:n(0,0),Washington2:n(1,0),Washington3:n(2,0),Washington4:n(3,0),Washington5:n(4,0),Washington6:n(5,0),WashingtonDodge:n(20,0),WashingtonSunglasses:n(9,0),Soldier1:n(0,1),Soldier2:n(1,1),Soldier3:n(2,1),SoldierFall:n(4,1),SoldierIcecube:n(5,1),SoldierDead:n(6,1),Hessian1:n(0,2),Hessian2:n(1,2),Hessian3:n(2,2),Hessian4:n(3,2),Hessian5:n(4,2),HessianLB1:n(11,3),HessianLB2:n(12,3),HessianLB3:n(13,3),HessianLB4:n(14,3),HessianLB5:n(15,3),HessianLB6:n(16,3),HessianLBSword:n(17,3),HessianLBRifle:n(18,3),Empty:n(15,15),BeachUpper:n(4,0),BeachLower:n(5,0),Water:n(6,0),Jelly:n(11,1),Cannonball:n(13,2),Wall:n(8,0),WallEnd:n(9,0),Pillar1:n(6,1),Pillar2:n(7,1),Pillar3:n(8,1),Slash:n(10,7),Strike:n(10,7),Cutlas:n(11,7),Crab:n(6,4),Chips:n(16,0),Treasure:n(16,0),Boot1:n(16,0),Boot2:n(16,0),Boot3:n(16,0),Boom:n(16,0),Key:n(16,0),Pickup1:n(16,0),Pickup2:n(16,0),Shot1:n(15,0),Shot2:n(16,0),Shot3:n(16,0),LiveGrenade:n(16,0),Frag:n(16,0),LiveRocket:n(16,0),Drone1:n(16,0),LiveVibroBlade:n(16,0),Reticle:n(16,0),TrapBlade:n(16,0),Floor:n(16,0),Ledge:n(16,0),LockedExit:n(16,0),Exit:n(16,0),TrapBlock:n(16,0)}),F=Object.freeze({Rall1:S(1,13,1,2),RallHorsback:S(3,13,1,2),RallHorse1:S(0,10,3,3),BoatBack:S(0,9,4,1),BoatFront:S(4,9,4,1),BoatVerticle1:S(10,8,1,2),BoatVerticle2:S(12,8,1,2),Lantern1:S(3,7,1,2),Lantern2:S(4,7,1,2),Lantern3:S(5,7,1,2),Lantern4:S(6,7,1,2),Tree1:S(0,7,1,2),Tree2:S(1,7,1,2),CanonNS:S(14,3,1,2),CanonEW:S(12,4,2,1),House1:S(0,16,3,3),House2:S(3,16,3,3),House3:S(6,16,3,3),BigHouseBlue:S(1,22,11,10),BigHouseRed:S(13,22,11,10),HouseBlue:S(25,22,8,7),HouseRed:S(34,22,8,7)});class D{constructor(t,e,s){this.tilemap=t,this.tile=e,this.pos=s}move(t,e){const s=new d([this.pos[0]+t,this.pos[1]+e]),i=this.tilemap.at(s);return new D(this.tilemap,i,s)}left(){return this.move(-1,0)}right(){return this.move(1,0)}above(){return this.move(0,-1)}below(){return this.move(0,1)}replace(t,...e){return this.tilemap.set(this.pos,t,...e),this.tile=t,this}getNeighbor(t,e){return this.move(t,e)}getAdjacentNeighbors(){return et([this.getNeighbor(0,-1),this.getNeighbor(0,1),this.getNeighbor(-1,0),this.getNeighbor(1,0)])}getAdjacentPassableNeighbors(){return this.getAdjacentNeighbors().filter(t=>t.tile.passable)}getConnectedTiles(){let t=[this],e=[this];for(;e.length;){let s=e.pop().getAdjacentPassableNeighbors().filter(i=>!t.includes(i));t=t.concat(s),e=e.concat(s)}return t}}class Bt{constructor(t,e){const s=new d([0,0]);this.startTile=new v(s),this.endTile=new v(s),this.dimW=t,this.dimH=e,this.array=[];for(let i=0;i<t;i++){this.array[i]=[];for(let a=0;a<e;a++)this.array[i][a]=new X([i,a])}}isValidPos(t){return t!=null&&t[0]>=0&&t[0]<this.dimW&&t[1]>=0&&t[1]<this.dimH}at(t){return this.isValidPos(t)?this.array[t[0]][t[1]]:new v(t)}get(t){const e=new d(t),s=this.at(e);return new D(this,s,e)}set(t,e,...s){if(!this.isValidPos(t))return null;let i=new e(t,...s);return this.array[t[0]][t[1]]=i,i}fillRect(t,e){for(let s of this.iterRectPos(t))this.set(s,e)}fillLine(t,e,s){const i=new d(t),a=new d(e),l=a[0]-i[0],r=a[1]-i[1],c=Math.max(Math.abs(l),Math.abs(r));for(let w=0;w<=c;w++){const g=new d([i[0]+l*w/c,i[1]+r*w/c]);this.set(g,s)}}fillCircle(t,e,s){for(let i of this.iterRange(t,e))this.set(i.pos,s)}leftOf(t){return new D(this,this.at([t[0],t[1]]),t).left()}rightOf(t){return new D(this,this.at([t[0],t[1]]),t).right()}above(t){return new D(this,this.at([t[0],t[1]]),t).above()}below(t){return new D(this,this.at([t[0],t[1]]),t).below()}*iterAllPos(){for(let t=0;t<this.dimW;t++)for(let e=0;e<this.dimH;e++)yield new d([t,e])}*iterRectPos(t){for(let e=Math.max(t.x,0);e<Math.min(t.right,this.dimW);e++)for(let s=Math.max(t.y,0);s<Math.min(t.bottom,this.dimH);s++)yield new d([e,s])}*iterAll(){for(let t=0;t<this.dimW;t++)for(let e=0;e<this.dimH;e++)yield this.at([t,e])}*iterRect(t){for(let e=t.x;e<t.right;e++)for(let s=t.y;s<t.bottom;s++){let i=this.at([e,s]);i instanceof v||(yield i)}}*iterRectBorder(t){for(let e=t.x;e<t.right;e++){let s=this.at([e,t.y]);s instanceof v||(yield s),s=this.at([e,t.bottom-1]),s instanceof v||(yield s)}for(let e=t.y;e<t.bottom;e++){let s=this.at([t.x,e]);s instanceof v||(yield s),s=this.at([t.right-1,e]),s instanceof v||(yield s)}}*iterRange(t,e){for(let s=Math.floor(t[0]-e);s<=Math.ceil(t[0]+e);s++)for(let i=Math.floor(t[1]-e);i<=Math.ceil(t[1]+e);i++)if(Math.hypot(t[0]-s,t[1]-i)<=e){let a=this.at([s,i]);a instanceof v||(yield a)}}*colliders(t){for(let e of this.iterRange([t.center_x-.5,t.center_y-.5],1.5))e.collide(t)&&(yield e)}*contacters(t){for(let e of this.iterRange([t.center_x-.5,t.center_y-.5],1.5))e.contact(t)&&(yield e)}*iterRandom(t=null,e=null,s=null,i=1){let a=t==null?this.iterAllPos():this.iterRectPos(t);for(let l of et(Array.from(a)))(e==null||this.at(l)instanceof e)&&(s==null||!(this.numNeighbors(l,s)<=i))&&(yield l)}hasNeighbors(t,e){for(let s of this.iterRange(t,1.5))if(this.at(s.pos)instanceof e)return!0;return!1}numNeighbors(t,e,s=1.5){let i=0;for(let a of this.iterRange(t,s))this.at(a.pos)instanceof e&&(i+=1);return i}closestTile(t){return this.at([Math.round(t.center_x-.5),Math.round(t.center_y-.5)])}closestPos(t){return new d([Math.round(t.x),Math.round(t.y)])}move(t,e=15,s=null){s===null&&(s=new d(t.vel));let i=t.pos.add([0,s.y*e]),a=t.bounds(i);for(let c of this.colliders(a))c.passable||(s.y>0&&a.bottom>c.y&&(i.y-=a.bottom-c.y,s.y=0,t.vel.y=0,a=t.bounds(i)),s.y<0&&a.y<c.bottom&&(i.y+=c.bottom-a.y,s.y=0,t.vel.y=0,a=t.bounds(i)));let l=i.add([s.x*e,0]),r=t.bounds(l);for(let c of this.colliders(r))c.passable||(s.x>0&&r.right>c.x&&(l.x-=r.right-c.x,s.x=0,t.vel.x=0,r=t.bounds(l)),s.x<0&&r.x<c.right&&(l.x+=c.right-r.x,s.x=0,t.vel.x=0,r=t.bounds(l)));t.pos=new d([l.x,i.y])}}class Ot extends p{constructor(){super([0,0,14,8]),this.scrollable=!0,this.focusPlayer=null}get viewPortH(){return this.h}set viewPortH(t){this.h=t}get viewPortW(){return this.w}set viewPortW(t){this.w=t}get pos(){return new d([-this.x,-this.y])}set pos(t){t!=null?(this.x=-t.x,this.y=-t.y):(this.x=null,this.y=null)}update(t,e){if(this.scrollable){let s=0,i=0,a=0;for(let c of t.activePlayers)!c.dead&&!c.escaped&&((this.focusPlayer==null||this.focusPlayer.dead||this.focusPlayer.escaped)&&(this.focusPlayer=c),c.controlStates.camera&&!c.oldControlStates.camera&&(this.focusPlayer=c),i+=c.pos.x,a+=c.pos.y,s++);this.focusPlayer===null&&(this.focusPlayer=t.activePlayers[0]),s>0&&(i/=s,a/=s),s==0&&(i=this.focusPlayer.pos.x,a=this.focusPlayer.pos.y),s>1&&(Math.abs(this.focusPlayer.pos.x-i)>this.viewPortW/2-1||Math.abs(this.focusPlayer.pos.y-a)>this.viewPortH/2-1)&&(i=this.focusPlayer.pos.x,a=this.focusPlayer.pos.y);let l=-i-.5+this.viewPortW/2,r=-a-.5+this.viewPortH/2;if(l=Math.max(Math.min(l,0),-t.dimW+this.viewPortW),r=Math.max(Math.min(r,0),-t.dimH+this.viewPortH),this.x==null||this.y==null)this.pos=new d([l,r]);else{let c=l-this.pos.x,w=r-this.pos.y,g=.2*(e/15),f=Math.max(Math.abs(c),Math.abs(w));this.pos!=null&&f>g?this.pos=new d([this.pos.x+c*g/f,this.pos.y+w*g/f]):this.pos=new d([l,r])}t.shakeX=Math.floor(-this.x*t.tileSize),t.shakeY=Math.floor(-this.y*t.tileSize)}}draw(){}}function At(h){Rt(h),h.items=[];let t=0;for(let e=0;e<3;e++){let s=h.tiles.iterRandom(new p([0,15,20,40]),O,null,1).next();if(!s.done&&s.value){let i=s.value;h.items.push(new kt(h.tiles.at(i)));for(let a=0;a<8;a++)for(let l=2;l<6;l++)h.tiles.set(i.add([a,l]),gt)}}h.cells=10,h.cellsCollected=0;for(let e=0;e<h.cells;e++)h.items.push(new Ft(it(h.tiles)));t=0;for(let e of h.tiles.iterRandom(null,_,null,500))if(h.items.push(new Mt(h.tiles.at(e))),t++,t>100)break;t=0;for(let e of h.tiles.iterRandom(null,O,null,200))if(h.items.push(new vt(h.tiles.at(e))),t++,t>100)break;h.items.push(new bt(h.tiles.at([20,20]))),h.monsters=[],t=0;for(let e of h.tiles.iterRandom(null,O,null,100))if(h.monsters.push(new K(h.tiles.at(e))),t++,t>100)break;for(let e of h.tiles.iterAll())e.initItems(h);Yt(h,h.tiles.startTile.pos)}function Rt(h){let t;if(h.camera.scrollable&&h.prefDimW==null&&h.prefDimH==null)switch(t=0,t){case 0:h.dimW=256,h.dimH=128;break}const e=h.dimW,s=h.dimH;h.tiles=new Bt(e,s);let i=h.tiles;i.fillRect(new p([0,0,e,s]),O);for(let a=0;a<s;a++){const l=Math.floor(a);i.fillLine([l,a],[l+100,a],_)}i.startTile=i.at([0,32]),i.endTile=i.at([10,10])}function it(h,t=null,e=!1,s=!0){let i;return dt("get random passable tile",function(){let a=j(0,h.dimW-1),l=j(0,h.dimH-1);return i=h.at([a,l]),t!=null?i.passable&&i.pos.dist(t)>3:!0}),i}function Yt(h,t){let e=Math.min(4,15)+5;for(let s=0;s<e;s++)at(h,t,!1,[xt,K])}function at(h,t,e=!1,s=null){s===null&&(s=[K]);let i=W(s),a=new i(it(h.tiles,t,e));h.monsters.push(a)}class J{constructor(t,e,s){this.options=t,this.dim=new p(e),this.activeOption=0,this.callback=s,this.color="rgba(100, 100, 218, 1)"}draw(t){let e=Math.ceil(this.dim.h/this.options.length),s=Math.ceil(this.dim.h/this.options.length/2),i=this.dim.y,a=this.dim.x+this.dim.w/2,l=0;for(let r of this.options){let c=l==this.activeOption?">"+r+"<":r;this.drawMenuText(t,c,s,!0,a,i,this.color),l+=1,i+=e}}drawMenuText(t,e,s,i,a,l,r){t.ctx.fillStyle=r,t.ctx.font=s+"px IM Fell English SC",i&&(a=a-t.ctx.measureText(e).width/2),t.ctx.fillText(e,a,l)}update(t,e){x.up&&!P.up&&(this.activeOption=this.activeOption>0?this.activeOption-1:this.options.length-1,this.callback(this,"change")),x.down&&!P.down&&(this.activeOption=this.activeOption<this.options.length-1?this.activeOption+1:0,this.callback(this,"change")),(x.use&&!P.use||x.dash&&!P.dash)&&this.callback(this,"select")}}class It extends J{constructor(t){let e=new p([0,t.canvas.height/2,t.canvas.width,4*t.tileSize]);super(["Play Game","High Scores","Options"],e,(s,i)=>this.handler(t,s,i))}updateWindowSize(t){this.dim=new p([0,t.canvas.height/2,t.canvas.width,4*t.tileSize])}handler(t,e,s){if(s==="select")switch(e.activeOption){case 0:x.left?(t.prefDimW=80,t.prefDimH=40,t.startLevelTime=0):x.right?(t.prefDimW=22,t.prefDimH=13,t.startLevelTime=0):(t.prefDimW=null,t.prefDimH=null,t.startLevelTime=0),t.competitiveMode=!1,t.updateWindowSize(),t.startGame();break;case 1:t.gameState="scores";break;case 2:t.gameState="options";break}}}class Xt extends J{constructor(t){let e=new p([0,t.canvas.height/2,t.canvas.width,0]);super([],e,(s,i)=>this.handler(t,s,i))}updateWindowSize(t){this.dim=new p([0,t.canvas.height/2,t.canvas.width,this.options.length*t.tileSize])}update(t,e){this.options=["Pixel perfect scaling: "+(t.fillScreen?"OFF":"ON"),"Show framerate: "+(t.showFPS?"ON":"OFF"),"Sandbox mode: "+(t.sandboxMode?"ON":"OFF"),"Back"],this.dim=new p([0,t.canvas.height/2,t.canvas.width,this.options.length*t.tileSize]),super.update(t,e)}handler(t,e,s){if(s=="select")switch(e.activeOption){case 0:t.fillScreen=!t.fillScreen,t.updateWindowSize();break;case 1:t.showFPS=!t.showFPS;break;case 2:t.sandboxMode=!t.sandboxMode;break;case 3:t.gameState="title";break;case 4:break;case 5:t.gameState="title";break}}}class Et extends J{constructor(t){let e=new p([0,t.canvas.height/2,t.canvas.width,3*t.tileSize]);super(["Continue","Drop Player","Exit to Main Menu"],e,(s,i)=>this.handler(t,s,i))}updateWindowSize(t){this.dim=new p([0,t.canvas.height/2,t.canvas.width,this.options.length*t.tileSize])}handler(t,e,s){if(s=="select")switch(e.activeOption){case 0:t.gameState="running";break;case 1:for(let i of t.activePlayers)i.controlStates.dash&&!i.oldControlStates.dash&&(i.dead=!0,i.dropFromGame=!0,t.gameState="running");break;case 2:t.gameState="title";break}}}function ht(){return localStorage["1776/high_scores"]?JSON.parse(localStorage["1776/high_scores"]):[]}function Lt(h,t,e){let s=ht(),i={score:t,chapter:h.chapter,won:e};s.push(i),h.sandboxMode||(localStorage["1776/high_scores"]=JSON.stringify(s))}function Nt(h){let t=ht();if(t.length){h.drawText(Q(["CHAPTER","SCORE","END"]),18,!0,h.canvas.height/2,"white");let e=t.pop();t.sort(function(s,i){return i.score-s.score}),t.unshift(e);for(let s=0;s<Math.min(10,t.length);s++){let i=Q([t[s].chapter??"Pennsylvania",t[s].score,t[s].won?"SURVIVED":"DIED"]);h.drawText(i,18,!0,h.canvas.height/2+24+s*24,s==0?"DarkOrange":"DarkSeaGreen")}}}const jt="/washdel/assets/spritesheet-Bp6c2UTF.png",Gt="/washdel/assets/hit1-B8fjDMVY.wav",Ut="/washdel/assets/hit2-BUt-r6lq.wav",Kt="/washdel/assets/sfx_sounds_powerup5-9kcmwmYb.wav",Jt="/washdel/assets/sfx_sounds_powerup15-BCTjFyTw.wav",L="/washdel/assets/Slide_Sharp_01-Chnp6Y48.wav",Vt="/washdel/assets/explodemini-D3OoVwHb.wav",qt="/washdel/assets/explode-BNxvceyl.wav",Qt="/washdel/assets/aargh0-BapSXfr1.ogg",Zt="/washdel/assets/aargh1-CpJFM2VX.ogg",$t="/washdel/assets/aargh2-DSamuWiH.ogg",te="/washdel/assets/aargh3-ByRNAUSJ.ogg",ee="/washdel/assets/aargh4-ClzDA7Un.ogg",se="/washdel/assets/aargh5-C63Uz6i_.ogg",ie="/washdel/assets/aargh6-CYmQwO-t.ogg",ae="/washdel/assets/aargh7-9yHQMFdu.ogg",he="/washdel/assets/rock_metal_slide_1-C2c5Tw6I.wav",le="/washdel/assets/evil%20cyber%20laugh-DGgv1943.wav",ne="/washdel/assets/Click_Standard_02-B2nmSCJT.wav",re="/washdel/assets/flaunch-BKRvBjGH.wav",oe="/washdel/assets/sfx_wpn_laser7-B5OWkHW5.wav",de="/washdel/assets/sfx_wpn_laser6-Drhqhz-r.wav",ce="/washdel/assets/sfx_wpn_laser5-v584Gpjn.wav",$="/washdel/assets/sfx_wpn_reload-DQ6QsLU9.wav",ue="/washdel/assets/Rifleprimary2-CKvPeCK4.ogg",pe="/washdel/assets/minigun3-D9jlbypc.ogg",fe="/washdel/assets/Rack-BKgWHnMr.mp3",we="/washdel/assets/sfx_wpn_missilelaunch-DaPY7xwi.wav",me="/washdel/assets/jumppad-BqbMzNcn.ogg",tt="/washdel/assets/rattle1-D8oszgzt.wav",ye="/washdel/assets/SpaceShip_Engine_Large_Loop_00-wpyxUmoF.wav";function Se(){return{main:jt}}function ge(){return{hit1:new Audio(Gt),hit2:new Audio(Ut),pickup1:new Audio(Kt),pickup2:new Audio(Jt),changeInv:new Audio(L),boom:new Audio(Vt),boomBig:new Audio(qt),dead1:new Audio(Qt),dead2:new Audio(Zt),dead3:new Audio($t),dead4:new Audio(te),dead5:new Audio(ee),dead6:new Audio(se),dead7:new Audio(ie),dead8:new Audio(ae),exitLevel:new Audio(he),gameOver:new Audio(le),kioskInteract:new Audio(ne),kioskDispense:new Audio(re),gunFire1:new Audio(oe),gunFire2:new Audio(de),gunFire3:new Audio(ce),gunReload:new Audio($),rifleFire:new Audio(ue),rifleReload:new Audio($),shotgunFire:new Audio(pe),shotgunReload:new Audio(fe),rocketFire:new Audio(we),rocketReload:new Audio(L),grappleFire:new Audio(me),grappleReload:new Audio(L),grappleRetract:new Audio(tt),wrenchFire:new Audio(tt),wrenchReload:new Audio(L),saberCharge:new Audio(ye)}}class xe{constructor(){o(this,"timer_tick",null);o(this,"FPSframes",0);o(this,"FPStime",0);o(this,"FPS",0);o(this,"updateTimes",new k([]));o(this,"drawTimes",new k([]));o(this,"updateMean",0);o(this,"updateMax",0);o(this,"drawMean",0);o(this,"drawMax",0);o(this,"weather",new Pt);o(this,"fillScreen",!1);o(this,"prefDimW",44);o(this,"prefDimH",26);o(this,"dimW",this.prefDimW);o(this,"dimH",this.prefDimH);o(this,"uiWidth",0);o(this,"uiHeight",2);o(this,"gameOffsetX",0);o(this,"gameOffsetY",0);o(this,"startLevelTime",0);o(this,"chapter","Pennsylvania");o(this,"maxHp",3);o(this,"activePlayers",[]);o(this,"tiles",null);o(this,"monsters",null);o(this,"items",null);o(this,"multiplayerEnabled",!0);o(this,"competitiveMode",!1);o(this,"sandboxMode",!1);o(this,"gameState","loading");o(this,"showFPS",!1);o(this,"cullOffCamera",!0);o(this,"cells",0);o(this,"cellsCollected",0);o(this,"startingHp",3);o(this,"shakeAmount",0);o(this,"shakeX",0);o(this,"shakeY",0);o(this,"numReady",0);this.initSounds(),this.keyboard=new ft(this),this.touch=new yt(this),this.gamepadMgr=new mt(this),this.camera=new Ot,this.tileSize=this.getTileScale()*16;const t=Se();this.sprites={base:new Ct(this,t.main,16)}}start(){window.onresize=()=>t.updateWindowSize(),this.setupCanvas();let t=this;this.sprites.base.sheet.onload=()=>t.ready(),this.mainMenu=new It(this),this.optionsMenu=new Xt(this),this.inGameMenu=new Et(this)}ready(){this.numReady++,this.numReady>=1&&(this.gameState="title",this.update())}update(){let t=performance.now();this.gamepadMgr.update_gamepad_states();for(let s of Object.keys(x))P[s],x[s];for(let s of this.activePlayers)for(let i of Object.keys(s.controlStates))s.newControlStates[i]=s.oldControlStates[i]!==s.controlStates[i];if(this.gameState=="dead"&&!P.dash&&x.dash)this.gameState="scores";else if(this.gameState=="running"||this.gameState=="dead"){this.gameState=="running"&&x.menu&&!P.menu&&(this.gameState="paused"),this.gameState=="running"&&x.dash&&!P.dash&&B.player==null&&this.addPlayer();let s=15,i=Date.now();this.timer_tick!=null&&(s=Math.min(i-this.timer_tick,30)),this.timer_tick=i;for(let l of this.activePlayers)l.update(T,s);this.levelTime+=s,St(s),this.weather.update(this,s);for(let l of this.items)l.update(this,s);this.remove_dead(this.items);for(let l of this.monsters)l.update(this,s);this.remove_dead(this.monsters),this.remove_dropped(this.activePlayers);let a=!0;for(let l of this.activePlayers)if(!l.dead){a=!1;break}!this.competitiveMode&&a&&this.gameState!="dead"&&(this.keyboard.player=null,this.touch.player=null,this.gamepadMgr.release_all_players(),Lt(T,this.activePlayers[0].score,!1),this.gameState="dead",this.items.push(new Dt("gameOver",1e3)));for(let l of this.activePlayers)if(!l.dead&&!l.escaped)break;this.spawnCounter-=s,this.spawnCounter<=0&&this.activePlayers.length>0&&(this.spawnCounter=this.spawnRate,this.monsters.length<20&&at(this,this.activePlayers[0].pos,!0)),this.updateTimes.push(performance.now()-t),this.draw(s)}else this.gameState==="title"||this.gameState==="options"?this.showTitle():this.gameState==="scores"?(this.showTitle(),!P.dash&&x.dash&&(this.gameState="title")):this.gameState==="paused"&&(this.showTitle(),this.gameState==="paused"&&!P.menu&&x.menu&&(this.gameState="running"));ut(x);for(let s of this.activePlayers)s.oldControlStates={...s.controlStates};let e=this;window.requestAnimationFrame(()=>e.update())}draw(t){let e=performance.now();if(this.gameState==="running"||this.gameState==="dead"){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.screenshake(),this.camera.update(T,t);let s=0,i=0,a=this.tiles.dimW,l=this.tiles.dimH;this.cullOffCamera&&(s=Math.floor(this.camera.x),i=Math.floor(this.camera.y),a=Math.ceil(this.camera.right),l=Math.ceil(this.camera.bottom));for(let m=s;m<a;m++)for(let H=i;H<l;H++)this.tiles.at([m,H]).draw(T);let r=this.camera;this.ctx.globalCompositeOperation="multiply";const c=this.activePlayers[0];this.ctx.fillStyle="rgba(92, 92, 128, 1)",this.ctx.fillStyle="rgba(255, 255, 255, 1)",this.ctx.fillRect(-r.pos.x*this.tileSize+this.shakeX+this.gameOffsetX,-r.pos.y*this.tileSize+this.shakeY+this.gameOffsetY,r.viewPortW*this.tileSize+1,r.viewPortH*this.tileSize+1),this.ctx.globalCompositeOperation="source-over";const w=[...this.monsters,...this.activePlayers,...this.items];if(w.sort((m,H)=>m.bounds().bottom-H.bounds().bottom),this.cullOffCamera)for(let m of w)m.sprite&&(m.sprite.length===2?r.shrinkBorders(-2).collide(new p([m.pos.x,m.pos.y,1,1]))&&m.draw(this):r.shrinkBorders(-2).collide(new p([m.pos.x,m.pos.y,m.sprite[2],m.sprite[3]]))&&m.draw(this));else for(let m=0;m<this.items.length;m++)this.items[m].draw(this);this.ctx.globalCompositeOperation="multiply";let g=this.ctx.createRadialGradient((c.pos[0]+.5)*this.tileSize+this.shakeX+this.gameOffsetX,(c.pos[1]+.5)*this.tileSize+this.shakeY+this.gameOffsetY,r.viewPortW/4*this.tileSize,(c.pos[0]+.5)*this.tileSize+this.shakeX+this.gameOffsetX,(c.pos[1]+.5)*this.tileSize+this.shakeY+this.gameOffsetY,this.tileSize*2);g.addColorStop(0,"rgba(128, 128, 192, 1)"),g.addColorStop(1,"rgba(192, 192, 192, 1)"),this.ctx.fillStyle="rgba(255,255,255,1)",this.ctx.fillRect(-r.pos.x*this.tileSize+this.shakeX+this.gameOffsetX,-r.pos.y*this.tileSize+this.shakeY+this.gameOffsetY,r.viewPortW*this.tileSize+1,r.viewPortH*this.tileSize+1),this.ctx.globalCompositeOperation="source-over",this.weather.draw(T,t),this.shakeX=0,this.shakeY=0;const f=this.camera.scrollable?this.camera.viewPortW:this.dimW,y=this.camera.scrollable?this.camera.viewPortH:this.dimH;let lt=this.levelTime>this.startLevelTime+1e4?"DarkSeaGreen":"DarkOrange";this.drawText(this.chapter+" Time "+Math.ceil(this.levelTime/1e3)+" Score "+this.score,this.tileSize*3/8,!0,this.tileSize*3/4,lt);let nt=[new d([0,0]),new d([f-6,0]),new d([0,y-1]),new d([f-6,y-1])],V=0;for(let m of this.activePlayers){let H=nt[V];m.drawHUD(T,H),V++}if(this.drawTimes.push(performance.now()-e),this.showFPS){this.FPSframes+=1,this.FPStime+=t,this.FPStime>1e3&&(this.FPS=Math.round(10*1e3*this.FPSframes/this.FPStime)/10,this.FPStime=0,this.FPSframes=0,this.updateMean=Math.round(this.updateTimes.mean()*100)/100,this.updateMax=Math.round(this.updateTimes.max()*100)/100,this.updateTimes=new k([]),this.drawMean=Math.round(this.drawTimes.mean()*100)/100,this.drawMax=Math.round(this.drawTimes.max()*100)/100,this.drawTimes=new k([]));let m=this.cullOffCamera?"CULL":"";this.drawText("FPS: "+this.FPS+"  Update: "+this.updateMean+"ms (peak "+this.updateMax+")  Draw: "+this.drawMean+"ms (peak "+this.drawMax+") "+m,this.tileSize*3/8,!0,this.tileSize*(y-.25)+this.gameOffsetY,"DarkSeaGreen")}}}setupCanvas(){this.canvas=document.querySelector("canvas"),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.canvas.style.width=this.canvas.width+"px",this.canvas.style.height=this.canvas.height+"px",this.ctx=this.canvas.getContext("2d"),this.ctx.imageSmoothingEnabled=!1,this.camera.scrollable?(this.gameOffsetX=Math.floor((window.innerWidth-this.tileSize*this.camera.viewPortW)/2),this.gameOffsetY=Math.floor((window.innerHeight-this.tileSize*this.camera.viewPortH)/2)):(this.gameOffsetX=Math.floor((window.innerWidth-this.tileSize*this.dimW)/2),this.gameOffsetY=Math.floor((window.innerHeight-this.tileSize*this.dimH)/2))}getTileScale(){let t=window.innerHeight,e=window.innerWidth,s;return this.camera.scrollable?s=Math.min(t/(this.camera.viewPortH+this.uiHeight)/16,e/(this.camera.viewPortW+this.uiWidth)/16):s=Math.min(t/(this.prefDimH+this.uiHeight)/16,e/(this.prefDimW+this.uiWidth)/16),this.fillScreen||(s=Math.floor(s)),s}fitMaptoTileSize(t){let e=window.innerHeight,s=window.innerWidth;this.camera.scrollable?(this.camera.viewPortH=e/t,this.camera.viewPortW=s/t):(this.dimH=Math.floor(e/t),this.dimW=Math.floor(s/t),this.camera.viewPortH=this.dimH,this.camera.viewPortW=this.dimW)}updateWindowSize(){this.competitiveMode?this.camera.scrollable=!1:(this.camera.scrollable=!0,this.camera.viewPortW=14,this.camera.viewPortH=8),this.tileSize=this.getTileScale()*16,this.fitMaptoTileSize(this.tileSize),this.setupCanvas(),this.mainMenu.updateWindowSize(this),this.optionsMenu.updateWindowSize(this)}initSounds(){this.sounds=ge()}playSound(t,e=0,s=!1,i=!0){return this.sounds[t].currentTime=e,this.sounds[t].loop=s,i&&this.sounds[t].play(),this.sounds[t]}showTitle(){this.ctx.fillStyle="rgba(0,0,0,.75)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),T.drawText("1776: Washington's Crossing",1.25*this.tileSize,!0,this.canvas.height/2-3.5*this.tileSize,"DarkRed"),T.drawText("by Evan Moore",this.tileSize,!0,this.canvas.height/2-2*this.tileSize,"White"),this.gameState==="title"?(this.mainMenu.update(this,0),this.mainMenu.draw(this)):this.gameState==="options"?(this.optionsMenu.update(this,0),this.optionsMenu.draw(this)):this.gameState==="paused"?(this.inGameMenu.update(this,0),this.inGameMenu.draw(this)):this.gameState==="scores"&&Nt(this)}addPlayer(){let t=new I;t.hp=this.startingHp,t.maxHp=this.startingHp,t.pos=this.tiles.startTile.pos,t.controller=B,B.attach_to_player(t),this.activePlayers.push(t)}startGame(){this.timer_tick=null,this.chapter="Pennsylvania",this.score=0,this.cellsCollected=2,this.activePlayers=[];let t=new I;this.activePlayers.push(t),this.multiplayerEnabled?B.attach_to_player(t):(this.keyboard.attach_to_player(t),this.touch.attach_to_player(t),this.gamepadMgr.attach_all_to_player(t)),t.hp=this.startingHp,t.maxHp=this.startingHp,this.weather.reset(),this.weather.changeMode(Math.random()>.5?"sleet":"snow"),this.startLevel(),this.gameState="running"}startLevel(){this.spawnRate=1e4,this.spawnCounter=this.spawnRate,this.levelTime=this.startLevelTime,this.camera.pos=null,this.competitiveMode||this.cellsCollected,At(T);for(let t of this.activePlayers)t.pos=this.tiles.startTile.pos,t.escaped=!1,t.dead&&t.revive(this)}screenshake(){this.shakeAmount&&this.shakeAmount--;let t=Math.random()*Math.PI*2;this.shakeX=Math.round(Math.cos(t)*this.shakeAmount),this.shakeY=Math.round(Math.sin(t)*this.shakeAmount)}drawText(t,e,s,i,a,l="IM Fell English SC"){this.ctx.fillStyle=a,this.ctx.font=e+"px "+l;let r;s?r=(this.canvas.width-this.ctx.measureText(t).width)/2:r=this.canvas.width-this.uiWidth*(this.tileSize-1),this.ctx.fillText(t,r,i)}drawTileText(t,e,s,i){this.ctx.fillStyle=i,this.ctx.font=e+"px IM Fell English SC";let a=(s.y+1-(1-e/this.tileSize)/2)*this.tileSize+this.gameOffsetY+this.shakeY,l=(s.x+(1-this.ctx.measureText(t).width/this.tileSize)/2)*this.tileSize+this.gameOffsetX+this.shakeX;this.ctx.fillText(t,l,a)}nearestPlayer(t){let e=1e9,s=null;for(let i of this.activePlayers)if(!i.dead){let a=i.pos.dist(t);s=a<e?i:s,e=a<e?a:e}return[s,e]}monsters_and_players(t=!0,e=null){return!t&&(!this.competitiveMode||this.levelTime>this.startLevelTime+1e4)?this.monsters.filter(s=>s!==e):this.monsters.concat(this.activePlayers).filter(s=>s!==e)}monsters_with_other_players(t){if(!this.competitiveMode||this.levelTime>this.startLevelTime+1e4)return this.monsters;let e=this.activePlayers.indexOf(t),s=this.activePlayers.slice(0,e).concat(this.activePlayers.slice(e+1));return this.monsters.concat(s)}other_players(t){let e=this.activePlayers.indexOf(t);return this.activePlayers.slice(0,e).concat(this.activePlayers.slice(e+1))}remove(t,e){for(let s=0;s<t.length;s++)if(t[s]==e){t.splice(s,1);return}}remove_dead(t){for(let e=t.length-1;e>=0;e--)t[e].dead&&t.splice(e,1)}remove_dropped(t){for(let e=t.length-1;e>=0;e--)t[e].dropFromGame&&(t[e].controller.attach_to_player(),this.items.push(new zt(t[e])),t.splice(e,1))}addGunPlatform(t){}addChips(t,e){const s=new Ht(t,e);return this.items.push(s),s}addBoom(t,e){const s=new _t(t,e);return this.items.push(s),s}addTrapBlade(t){const e=new Wt(t);return this.items.push(e),e}}var T=new xe;T.start();
