(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function o(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(r){if(r.ep)return;r.ep=!0;const s=o(r);fetch(r.href,s)}})();class m extends Array{constructor(...t){super(...t)}static fromValues(t,o){return new m(t,o)}static create(){return new m(0,0)}static clone(t){return new m(t[0],t[1])}equals(t){return this[0]===t[0]&&this[1]===t[1]}equalsValues(t,o){return this[0]===t&&this[1]===o}copy(t){this[0]=t[0],this[1]=t[1]}set(t,o){this[0]=t,this[1]=o}add(t){return m.fromValues(this[0]+t[0],this[1]+t[1])}subtract(t){return m.fromValues(this[0]-t[0],this[1]-t[1])}multiply(t){return m.fromValues(this[0]*t[0],this[1]*t[1])}scale(t){return m.fromValues(this[0]*t,this[1]*t)}scaleAndAdd(t,o){return m.fromValues(this[0]+t[0]*o,this[1]+t[1]*o)}distance(t){const o=this[0]-t[0],n=this[1]-t[1];return Math.hypot(o,n)}squaredDistance(t){const o=this[0]-t[0],n=this[1]-t[1];return o*o+n*n}len(){return Math.hypot(this[0],this[1])}squaredLen(t){const o=this[0],n=this[1];return o*o+n*n}negate(){return m.fromValues(-this[0],-this[1])}dot(t){return this[0]*t[0]+this[1]*t[1]}lerp(t,o){return m.fromValues(this[0]+o*(t[0]-this[0]),this[1]+o*(t[1]-this[1]))}zero(){this[0]=0,this[1]=0}static copy(t,o){t[0]=o[0],t[1]=o[1]}static set(t,o,n){t[0]=o,t[1]=n}static add(t,o,n){t[0]=o[0]+n[0],t[1]=o[1]+n[1]}static subtract(t,o,n){t[0]=o[0]-n[0],t[1]=o[1]-n[1]}static multiply(t,o,n){t[0]=o[0]*n[0],t[1]=o[1]*n[1]}static scale(t,o,n){t[0]=o[0]*n,t[1]=o[1]*n}static scaleAndAdd(t,o,n,r){t[0]=o[0]+n[0]*r,t[1]=o[1]+n[1]*r}static distance(t,o){const n=t[0]-o[0],r=t[1]-o[1];return Math.hypot(n,r)}static squaredDistance(t,o){const n=t[0]-o[0],r=t[1]-o[1];return n*n+r*r}static len(t){return Math.hypot(t[0],t[1])}static squaredLen(t){const o=t[0],n=t[1];return o*o+n*n}static negate(t,o){t[0]=-o[0],t[1]=-o[1]}static dot(t,o){return t[0]*o[0]+t[1]*o[1]}static lerp(t,o,n,r){t[0]=o[0]+r*(n[0]-o[0]),t[1]=o[1]+r*(n[1]-o[1])}static zero(t){t[0]=0,t[1]=0}}var le;(e=>{function t(){return[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}e.create=t;function o(r,s){r[0]=s[0],r[1]=s[1],r[2]=s[2],r[3]=s[3],r[4]=s[4],r[5]=s[5],r[6]=s[6],r[7]=s[7],r[8]=s[8],r[9]=s[9],r[10]=s[10],r[11]=s[11],r[12]=s[12],r[13]=s[13],r[14]=s[14],r[15]=s[15]}e.copy=o;function n(r,s,i,c,l,f,d){const a=1/(s-i),u=1/(c-l),h=1/(f-d);r[0]=-2*a,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-2*u,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=2*h,r[11]=0,r[12]=(s+i)*a,r[13]=(l+c)*u,r[14]=(d+f)*h,r[15]=1}e.ortho=n})(le||(le={}));var H=(e=>(e[e.Damage=0]="Damage",e[e.GuardChase=1]="GuardChase",e[e.GuardInvestigate=2]="GuardInvestigate",e[e.GuardSeeThief=3]="GuardSeeThief",e[e.GuardHearThief=4]="GuardHearThief",e[e.GuardDownWarning=5]="GuardDownWarning",e[e.GuardAwakesWarning=6]="GuardAwakesWarning",e[e.GuardExamineStolenTreasure=7]="GuardExamineStolenTreasure",e[e.GuardWarningResponse=8]="GuardWarningResponse",e[e.GuardHearGuard=9]="GuardHearGuard",e[e.GuardSpotDownedGuard=10]="GuardSpotDownedGuard",e[e.GuardSeeTorchLit=11]="GuardSeeTorchLit",e[e.GuardSeeUnlitTorch=12]="GuardSeeUnlitTorch",e[e.GuardEndChase=13]="GuardEndChase",e[e.GuardFinishInvestigating=14]="GuardFinishInvestigating",e[e.GuardFinishLooking=15]="GuardFinishLooking",e[e.GuardFinishListening=16]="GuardFinishListening",e[e.GuardFinishLightingTorch=17]="GuardFinishLightingTorch",e[e.GuardFinishLookingAtLitTorch=18]="GuardFinishLookingAtLitTorch",e[e.GuardStirring=19]="GuardStirring",e[e.GuardSpotStolenTreasure=20]="GuardSpotStolenTreasure",e[e.GuardSeeTorchDoused=21]="GuardSeeTorchDoused",e))(H||{});const en=1,Pt=2;class Gr{constructor(){this.currentSpeech="",this.currentSpeaker=void 0,this.currentSpeechAbove=!1,this.currentSpeechTimeRemaining=0,this.notification="",this.notificationMaxTurns=0,this.notificationWorldPos=m.create(),this.notificationTimeRemaining=0}setSpeech(t,o,n){this.currentSpeech=t,this.currentSpeaker=o,this.currentSpeechAbove=n,this.currentSpeechTimeRemaining=Pt}setNotification(t,o,n=en,r=Pt){this.notification=t,this.notificationWorldPos=o instanceof at?o:m.clone(o),this.notificationTimeRemaining=r,this.notificationMaxTurns=n}setNotificationHold(t,o){this.notification=t,this.notificationWorldPos=o instanceof at?o:m.clone(o),this.notificationTimeRemaining=1/0,this.notificationMaxTurns=en}updateNotification(){--this.notificationMaxTurns,this.notificationMaxTurns<=0&&(this.notificationTimeRemaining=0,this.notificationMaxTurns=0)}isSpeechBubbleVisible(){return this.currentSpeechTimeRemaining>0}isNotificationVisible(){return this.notificationTimeRemaining>0}animate(t){this.currentSpeechTimeRemaining=Math.max(0,this.currentSpeechTimeRemaining-t),this.notificationTimeRemaining=Math.max(0,this.notificationTimeRemaining-t)}toggleShow(t){this.notificationTimeRemaining=this.notificationTimeRemaining>0?0:Pt,this.currentSpeechTimeRemaining>0?this.currentSpeechTimeRemaining=0:this.currentSpeaker!==void 0&&this.currentSpeech!==""&&(this.currentSpeechTimeRemaining=Pt,this.currentSpeechAbove=this.currentSpeaker.pos[1]>=t[1])}reset(){this.currentSpeech="",this.currentSpeaker=void 0,this.currentSpeechAbove=!1,this.currentSpeechTimeRemaining=0,this.notification="",this.notificationWorldPos=new m(0,0),this.notificationTimeRemaining=0,this.notificationMaxTurns=0}}var ct=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ur(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function Er(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var t=e.default;if(typeof t=="function"){var o=function n(){return this instanceof n?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};o.prototype=t.prototype}else o={};return Object.defineProperty(o,"__esModule",{value:!0}),Object.keys(e).forEach(function(n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(o,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}),o}var ho,tn;function Nr(){if(tn)return ho;tn=1;var e={linear:function(t,o,n,r){var s=n-o;return s*t/r+o},easeInQuad:function(t,o,n,r){var s=n-o;return s*(t/=r)*t+o},easeOutQuad:function(t,o,n,r){var s=n-o;return-s*(t/=r)*(t-2)+o},easeInOutQuad:function(t,o,n,r){var s=n-o;return(t/=r/2)<1?s/2*t*t+o:-s/2*(--t*(t-2)-1)+o},easeInCubic:function(t,o,n,r){var s=n-o;return s*(t/=r)*t*t+o},easeOutCubic:function(t,o,n,r){var s=n-o;return s*((t=t/r-1)*t*t+1)+o},easeInOutCubic:function(t,o,n,r){var s=n-o;return(t/=r/2)<1?s/2*t*t*t+o:s/2*((t-=2)*t*t+2)+o},easeInQuart:function(t,o,n,r){var s=n-o;return s*(t/=r)*t*t*t+o},easeOutQuart:function(t,o,n,r){var s=n-o;return-s*((t=t/r-1)*t*t*t-1)+o},easeInOutQuart:function(t,o,n,r){var s=n-o;return(t/=r/2)<1?s/2*t*t*t*t+o:-s/2*((t-=2)*t*t*t-2)+o},easeInQuint:function(t,o,n,r){var s=n-o;return s*(t/=r)*t*t*t*t+o},easeOutQuint:function(t,o,n,r){var s=n-o;return s*((t=t/r-1)*t*t*t*t+1)+o},easeInOutQuint:function(t,o,n,r){var s=n-o;return(t/=r/2)<1?s/2*t*t*t*t*t+o:s/2*((t-=2)*t*t*t*t+2)+o},easeInSine:function(t,o,n,r){var s=n-o;return-s*Math.cos(t/r*(Math.PI/2))+s+o},easeOutSine:function(t,o,n,r){var s=n-o;return s*Math.sin(t/r*(Math.PI/2))+o},easeInOutSine:function(t,o,n,r){var s=n-o;return-s/2*(Math.cos(Math.PI*t/r)-1)+o},easeInExpo:function(t,o,n,r){var s=n-o;return t==0?o:s*Math.pow(2,10*(t/r-1))+o},easeOutExpo:function(t,o,n,r){var s=n-o;return t==r?o+s:s*(-Math.pow(2,-10*t/r)+1)+o},easeInOutExpo:function(t,o,n,r){var s=n-o;return t===0?o:t===r?o+s:(t/=r/2)<1?s/2*Math.pow(2,10*(t-1))+o:s/2*(-Math.pow(2,-10*--t)+2)+o},easeInCirc:function(t,o,n,r){var s=n-o;return-s*(Math.sqrt(1-(t/=r)*t)-1)+o},easeOutCirc:function(t,o,n,r){var s=n-o;return s*Math.sqrt(1-(t=t/r-1)*t)+o},easeInOutCirc:function(t,o,n,r){var s=n-o;return(t/=r/2)<1?-s/2*(Math.sqrt(1-t*t)-1)+o:s/2*(Math.sqrt(1-(t-=2)*t)+1)+o},easeInElastic:function(t,o,n,r){var s=n-o,i,c,l;return l=1.70158,c=0,i=s,t===0?o:(t/=r)===1?o+s:(c||(c=r*.3),i<Math.abs(s)?(i=s,l=c/4):l=c/(2*Math.PI)*Math.asin(s/i),-(i*Math.pow(2,10*(t-=1))*Math.sin((t*r-l)*(2*Math.PI)/c))+o)},easeOutElastic:function(t,o,n,r){var s=n-o,i,c,l;return l=1.70158,c=0,i=s,t===0?o:(t/=r)===1?o+s:(c||(c=r*.3),i<Math.abs(s)?(i=s,l=c/4):l=c/(2*Math.PI)*Math.asin(s/i),i*Math.pow(2,-10*t)*Math.sin((t*r-l)*(2*Math.PI)/c)+s+o)},easeInOutElastic:function(t,o,n,r){var s=n-o,i,c,l;return l=1.70158,c=0,i=s,t===0?o:(t/=r/2)===2?o+s:(c||(c=r*(.3*1.5)),i<Math.abs(s)?(i=s,l=c/4):l=c/(2*Math.PI)*Math.asin(s/i),t<1?-.5*(i*Math.pow(2,10*(t-=1))*Math.sin((t*r-l)*(2*Math.PI)/c))+o:i*Math.pow(2,-10*(t-=1))*Math.sin((t*r-l)*(2*Math.PI)/c)*.5+s+o)},easeInBack:function(t,o,n,r,s){var i=n-o;return s===void 0&&(s=1.70158),i*(t/=r)*t*((s+1)*t-s)+o},easeOutBack:function(t,o,n,r,s){var i=n-o;return s===void 0&&(s=1.70158),i*((t=t/r-1)*t*((s+1)*t+s)+1)+o},easeInOutBack:function(t,o,n,r,s){var i=n-o;return s===void 0&&(s=1.70158),(t/=r/2)<1?i/2*(t*t*(((s*=1.525)+1)*t-s))+o:i/2*((t-=2)*t*(((s*=1.525)+1)*t+s)+2)+o},easeInBounce:function(t,o,n,r){var s=n-o,i;return i=e.easeOutBounce(r-t,0,s,r),s-i+o},easeOutBounce:function(t,o,n,r){var s=n-o;return(t/=r)<1/2.75?s*(7.5625*t*t)+o:t<2/2.75?s*(7.5625*(t-=1.5/2.75)*t+.75)+o:t<2.5/2.75?s*(7.5625*(t-=2.25/2.75)*t+.9375)+o:s*(7.5625*(t-=2.625/2.75)*t+.984375)+o},easeInOutBounce:function(t,o,n,r){var s=n-o,i;return t<r/2?(i=e.easeInBounce(t*2,0,s,r),i*.5+o):(i=e.easeOutBounce(t*2-r,0,s,r),i*.5+s*.5+o)}};return ho=e,ho}var O=Nr();class _t{update(t){return!1}currentTile(){return{}}}class Ze extends _t{constructor(t,o,n=0,r=-1){super(),this.time=0,this.tileInfo=t,this.activeFrame=n,this.frameDuration=o,this.removeOnFinish=!1,this.loops=r}update(t){this.time+=t;const o=this.frameDuration instanceof Array?this.frameDuration[this.activeFrame]:this.frameDuration;return this.time>o&&(this.activeFrame++,this.activeFrame>=this.tileInfo.length&&(this.activeFrame=0,this.loops>0&&this.loops--),this.time=0),this.loops===0}currentTile(){return this.tileInfo[this.activeFrame]}}class ue extends _t{constructor(t,o){super(),this.time=0,this.offset=m.clone(t[0].pt0),this.tileInfo=o,this.activeFrame=0,this.frameStep=1,this.activePt=0,this.tweenSeq=t,this.removeOnFinish=!1}update(t){const o=this.tweenSeq[this.activePt].pt0,n=this.tweenSeq[this.activePt].pt1,r=this.tweenSeq[this.activePt].duration,s=this.tweenSeq[this.activePt].fn;return o===void 0||n==null?!0:(this.time=Math.min(this.time+t,r),this.time>=0&&(this.offset[0]=s(this.time,o[0],n[0],r),this.offset[1]=s(this.time,o[1],n[1],r)),this.time==r&&(this.activePt++,this.time=0,this.activeFrame++),this.activeFrame>=this.tileInfo.length&&(this.activeFrame=0),this.activePt===this.tweenSeq.length)}currentTile(){return this.tileInfo[this.activeFrame]}}class Un extends _t{constructor(t,o,n){super(),this.offset=new m,this.duration=0,this.period=1,this.time=0,this.tile=t,this.duration=o,this.period=n}update(t){return this.duration>0?this.time=Math.min(this.time+t,this.duration):this.time+=t,this.duration>0&&this.time===this.duration}get intensity(){return Math.sin(this.time/this.period)}agbr_color_to_tuple(t){const o=t>>24&255,n=t>>16&255,r=t>>8&255,s=t&255;return[o,n,r,s]}abgr_tuple_to_color(t,o,n,r){return(Math.floor(t%256)<<24|Math.floor(o%256)<<16|Math.floor(n%256)<<8|Math.floor(r%256))>>>0}blend(t,o,n){const r=this.agbr_color_to_tuple(t),s=this.agbr_color_to_tuple(o),i=r.map((c,l)=>c*n+s[l]*(1-n));return this.abgr_tuple_to_color(i[0],i[1],i[2],i[3])}currentTile(){const o=(1+this.intensity)/2;return{textureIndex:this.tile.textureIndex,color:this.tile.color!==void 0&&this.tile.unlitColor!==void 0?this.blend(this.tile.color,this.tile.unlitColor,o):4294967295}}}class mt extends _t{constructor(t,o,n,r,s,i=new m(0,0),c=0,l=0){super(),this.time=0,this.tileInfo=t,this.offset=new m,this.centerPos=i,this.radius=o,this.speed=n,this.startingPos=r,this.duration=s,this.posRadians=r,this.removeOnFinish=!1}update(t){return this.duration>0?this.time=Math.min(this.time+t,this.duration):this.time+=t,this.posRadians+=this.speed*t,this.offset[0]=this.centerPos[0]+Math.cos(this.posRadians)*this.radius,this.offset[1]=this.centerPos[1]+Math.sin(this.posRadians)*this.radius,this.time===this.duration}currentTile(){return this.tileInfo}}var rt=(e=>(e[e.idle=0]="idle",e[e.dimmed=1]="dimmed",e[e.off=2]="off",e))(rt||{});class ft extends _t{constructor(t,o,n,r,s,i,c){super(),this.activeFrame=0,this.time=0,this.dimDuration=300,this.idleTiles=s,this.dimTile=i,this.offTile=c,this.lightId=o,this.lightVector=n,this.state=t,this.item=r}update(t){if(this.item!==null&&(this.item.type===M.TorchUnlit&&(this.state=2),this.item.type!==M.TorchUnlit&&this.state===2&&(this.state=0,this.lightVector[this.lightId]=0)),this.time+=t,this.state==2)return!1;let o=this.lightVector[this.lightId];if(o==0&&Math.random()>.995**(t*60)?(this.state=1,o=1.5):o>0&&(o=Math.max(o-3*t,0)),o==0){this.state=0;const n=this.idleTiles[this.activeFrame][1];this.time>=n&&(this.time=0,this.activeFrame++,this.activeFrame>=this.idleTiles.length&&(this.activeFrame=0))}return this.lightVector[this.lightId]=o,!1}currentTile(){return this.state==0?this.idleTiles[this.activeFrame][0]:this.state==1?this.dimTile:this.offTile}}const Uo=64;var fe=(e=>(e[e.Patrol=0]="Patrol",e[e.Look=1]="Look",e[e.LookAtTorch=2]="LookAtTorch",e[e.Listen=3]="Listen",e[e.ChaseVisibleTarget=4]="ChaseVisibleTarget",e[e.MoveToLastSighting=5]="MoveToLastSighting",e[e.InvestigateLastSighting=6]="InvestigateLastSighting",e[e.MoveToLastSound=7]="MoveToLastSound",e[e.MoveToGuardShout=8]="MoveToGuardShout",e[e.MoveToDownedGuard=9]="MoveToDownedGuard",e[e.MoveToMissingTreasure=10]="MoveToMissingTreasure",e[e.LookAtMissingTreasure=11]="LookAtMissingTreasure",e[e.WakeGuard=12]="WakeGuard",e[e.MoveToTorch=13]="MoveToTorch",e[e.LightTorch=14]="LightTorch",e[e.Unconscious=15]="Unconscious",e))(fe||{});class Et{constructor(t,o){this.dir=m.fromValues(1,0),this.mode=0,this.modePrev=0,this.angry=!1,this.hasTorch=!1,this.hasPurse=!1,this.hasVaultKey=!1,this.torchAnimation=null,this.speaking=!1,this.hasMoved=!1,this.heardThief=!1,this.heardThiefClosest=!1,this.heardAlarm=!1,this.hearingGuard=!1,this.heardGuard=!1,this.animation=null,this.goals=[],this.modeTimeout=0;const n=t[o];this.pos=m.clone(n),this.heardGuardPos=m.create(),this.goal=m.clone(n),this.patrolPath=t,this.patrolPathIndex=o,this.updateDirInitial()}overheadIcon(){return this.mode===15?Xe.Unconscious:this.mode===4?Xe.Chasing:Me(this.mode)?this.angry?Xe.Angry:Xe.Relaxed:Xe.Alerted}posAnimated(){var n;let t=((n=this.animation)==null?void 0:n.offset)??m.create();const o=m.create();return m.add(o,this.pos,t),o}allowsMoveOntoFrom(t){if(this.goals.length<=0)return!0;const o=this.goals[0];if(o.equals(this.pos)||o.equals(t))return!1;const n=Math.floor((this.pos[0]+t[0])/2),r=Math.floor((this.pos[1]+t[1])/2);return!(o[0]===n&&o[1]===r)}moving(){if(this.goals.length<=0)return!1;const t=this.goals[0];return!this.pos.equals(t)}chooseMoves(t){switch(this.mode){case 0:this.goals=this.choosePatrolStep(t);break;case 1:case 2:case 3:case 15:this.goals=this.chooseMoveTowardPosition(this.pos,t.gameMap);break;case 4:case 5:case 6:case 8:case 7:this.goals=this.chooseMoveTowardPosition(this.goal,t.gameMap);break;case 9:case 10:case 11:case 12:case 13:case 14:this.goals=this.chooseMoveTowardAdjacentToPosition(this.goal,t.gameMap);break}}bestAvailableMove(t,o,n){let r=!1;for(const s of t)if(o.guardMoveCost(this.pos,s)!=1/0){if(n.pos.equals(s)){r=!0;continue}if(!o.isGuardAtVec(s))return[s,r]}return[this.pos,r]}act(t,o){const n=m.clone(this.pos),r=t.gameMap,s=t.player,i=t.levelStats;if(this.mode!==15&&!Me(this.mode)){const c=this.moving()?1:0;this.seesActor(r,s,c)&&(this.mode=4)}switch(this.heardThief&&this.mode!==15&&this.mode!==4&&(Me(this.mode)&&!this.heardThiefClosest?(this.mode=3,this.modeTimeout=2+t.rng.randomInRange(4),this.goals=this.chooseMoveTowardPosition(this.pos,t.gameMap)):this.mode!==9&&(m.copy(this.goal,s.pos),Me(this.mode)?this.goals=this.chooseMoveTowardPosition(this.pos,t.gameMap):this.goals=this.chooseMoveTowardPosition(this.goal,t.gameMap),this.mode=this.heardAlarm?10:7,this.modeTimeout=4+t.rng.randomInRange(2))),this.mode){case 0:if(this.makeBestAvailableMove(r,s),!this.pos.equals(this.patrolPath[this.patrolPathIndex]))this.enterPatrolMode(r);else if(this.pos.equals(n)){const l=this.patrolPath[Math.max(0,this.patrolPathIndex+this.patrolPath.length-2)%this.patrolPath.length];if(n.equals(l)){const f=this.patrolPath.length===1,d=r.tryGetPosLookAt(this.pos,f);d!==void 0&&De(this.dir,this.pos,d)}}break;case 1:case 3:this.makeBestAvailableMove(r,s),this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r);break;case 2:this.makeBestAvailableMove(r,s),De(this.dir,this.pos,this.goal),this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r);break;case 4:if(m.copy(this.goal,s.pos),this.adjacentTo(s.pos)&&!this.pos.equals(s.pos)){if(De(this.dir,this.pos,this.goal),this.modePrev===4){s.damagedLastTurn||o.push({speaker:this,speechType:H.Damage});const l=m.create(),f=m.create();m.subtract(f,s.pos,this.pos),m.scale(f,f,.5),this.animation=new ue([{pt0:l,pt1:f,duration:.1,fn:O.easeInQuad},{pt0:f,pt1:l,duration:.1,fn:O.easeOutQuad}],[]),s.applyDamage(1),Ir(t,s.health),Ar(t),St(t,s.pos[0]-this.pos[0],s.pos[1]-this.pos[1]),++i.damageTaken}}else this.goals=this.chooseMoveTowardPosition(this.goal,r),this.makeBestAvailableMove(r,s);break;case 5:this.makeBestAvailableMove(r,s),this.pos.equals(this.goal)?(this.mode=6,this.modeTimeout=5):this.pos.equals(n)&&(this.modeTimeout-=1),this.modeTimeout<=0&&this.enterPatrolMode(r);break;case 6:this.makeBestAvailableMove(r,s),this.modeTimeout>=3&&this.pos.equals(this.goal)&&this.tryStepGoalForward(t),this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r);break;case 7:case 8:this.makeBestAvailableMove(r,s),this.pos.equals(n)&&(this.modeTimeout-=1),this.modeTimeout<=0&&this.enterPatrolMode(r);break;case 9:this.makeBestAvailableMove(r,s),this.cardinallyAdjacentTo(this.goal)?r.guards.find(l=>l.pos.equals(this.goal)&&l.mode===15)?(this.mode=12,this.modeTimeout=3):(this.modeTimeout=0,this.enterPatrolMode(r)):this.pos.equals(n)&&(this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r));break;case 10:this.makeBestAvailableMove(r,s),this.cardinallyAdjacentTo(this.goal)?(this.mode=11,this.modeTimeout=4):this.pos.equals(n)?(this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r)):this.modeTimeout=3;break;case 11:this.makeBestAvailableMove(r,s),this.pos.equals(n)&&this.cardinallyAdjacentTo(this.goal)&&De(this.dir,this.pos,this.goal),this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r);break;case 12:this.makeBestAvailableMove(r,s),this.pos.equals(n)&&De(this.dir,this.pos,this.goal),--this.modeTimeout;const c=r.guards.find(l=>l.pos.equals(this.goal)&&l.mode===15);c!==void 0?this.modeTimeout<=0&&(c.modeTimeout=0,this.enterPatrolMode(r)):(this.modeTimeout=0,this.enterPatrolMode(r));break;case 13:this.makeBestAvailableMove(r,s),r.items.some(l=>l.pos.equals(this.goal)&&l.type===M.TorchLit)?this.enterPatrolMode(r):this.cardinallyAdjacentTo(this.goal)?(this.mode=14,this.modeTimeout=5):this.pos.equals(n)?(this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r)):this.modeTimeout=3;break;case 14:if(this.makeBestAvailableMove(r,s),--this.modeTimeout,De(this.dir,this.pos,this.goal),this.modeTimeout<=0){Yr(r,this.goal);const l=on(r,this.pos);l===void 0?this.enterPatrolMode(r):(m.copy(this.goal,l.pos),this.cardinallyAdjacentTo(this.goal)?(this.mode=14,this.modeTimeout=5):(this.mode=13,this.modeTimeout=3))}break;case 15:this.modeTimeout<=0&&(this.modeTimeout=0,this.angry=!0,this.enterPatrolMode(r));break}}postActSense(t,o,n,r,s,i){if(this.mode!==15){if(this.seesActor(t,o)?Me(this.mode)&&!this.adjacentTo(o.pos)?(this.mode=1,this.modeTimeout=2+i.randomInRange(4)):this.mode=4:this.mode===4&&this.modePrev===4&&(this.mode=5,this.modeTimeout=3),this.heardGuard&&this.mode!==1&&this.mode!==4&&this.mode!==5&&this.mode!==6&&this.mode!==7&&this.mode!==9&&this.mode!==12&&(this.mode=8,this.modeTimeout=2+i.randomInRange(4),m.copy(this.goal,this.heardGuardPos)),this.mode!==4&&this.mode!==9&&this.mode!==12){for(let l of t.guards)if(l!==this&&l.mode===15&&this.seesActor(t,l)){m.copy(this.goal,l.pos),this.mode=9,this.angry=!0,this.modeTimeout=3;break}}if(!this.angry&&Me(this.mode)){const l=t.treasures.find(f=>f.stolen&&this.seesPosition(t,f.posTreasure));l!==void 0&&(this.mode=10,m.copy(this.goal,l.posTreasure),this.angry=!0,this.modeTimeout=3)}if(this.hasTorch&&this.mode===0){const l=on(t,this.pos);l!==void 0&&(m.copy(this.goal,l.pos),this.cardinallyAdjacentTo(this.goal)?(this.mode=14,this.modeTimeout=5):(this.mode=13,this.modeTimeout=3))}!this.hasTorch&&Me(this.mode)&&o.itemUsed!==null&&m.squaredDistance(this.pos,o.itemUsed.pos)<=Uo&&Ro(t,this.pos,o.itemUsed.pos)&&(o.itemUsed.type===M.TorchLit?(m.copy(this.goal,o.itemUsed.pos),this.mode=2,this.modeTimeout=2+i.randomInRange(4)):o.itemUsed.type===M.TorchUnlit&&r.push({speaker:this,speechType:H.GuardSeeTorchDoused})),this.mode===8&&Lo(t,this.pos,this.goal)&&t.guards.some(l=>l.pos.equals(this.goal))&&m.copy(this.goal,this.pos)}this.heardThief=!1,this.heardThiefClosest=!1,this.heardAlarm=!1;const c=zr(this.modePrev,this.mode,m.squaredDistance(this.pos,o.pos));if(c!==void 0&&r.push({speaker:this,speechType:c}),this.mode!==this.modePrev)switch(this.mode){case 4:s.push({posShouter:m.clone(this.pos),posGoal:m.clone(o.pos),angry:!1}),++n.numSpottings;break;case 12:case 11:s.push({posShouter:m.clone(this.pos),posGoal:m.clone(this.goal),angry:!0});break}}tryStepGoalForward(t){const o=m.create();if(m.add(o,this.pos,this.dir),t.gameMap.guardMoveCost(this.pos,o)===0){m.copy(this.goal,o);return}let n=[m.fromValues(this.pos[0]-this.dir[1],this.pos[1]+this.dir[0]),m.fromValues(this.pos[0]+this.dir[1],this.pos[1]-this.dir[0])];if(n=n.filter(r=>t.gameMap.guardMoveCost(this.pos,r)===0),n.length>0){const r=t.rng.randomInRange(n.length);m.copy(this.goal,n[r])}}cardinallyAdjacentTo(t){const o=Math.abs(t[0]-this.pos[0]),n=Math.abs(t[1]-this.pos[1]);return o==1&&n==0||o==0&&n==1}adjacentTo(t){const o=t[0]-this.pos[0],n=t[1]-this.pos[1];return Math.abs(o)<2&&Math.abs(n)<2}seesActor(t,o,n=0){return this.seesPositionInternal(t,o.pos,o.hidden(t),Lo,n)}seesPosition(t,o){return this.seesPositionInternal(t,o,!1,Ro,0)}seesPositionInternal(t,o,n,r,s){const i=m.create();if(m.subtract(i,o,this.pos),this.mode!==4&&m.dot(this.dir,i)<s)return!1;const c=t.cells.atVec(o).lit>0;if(m.squaredLen(i)>=this.sightCutoff(c)&&!(i[0]===this.dir[0]*2&&i[1]===this.dir[1]*2))return!1;if(Me(this.mode)&&!this.angry||Math.abs(i[0])>=2||Math.abs(i[1])>=2){if(n||!r(t,this.pos,o))return!1}else if(this.pos[0]!==o[0]&&this.pos[1]!==o[1]&&(t.cells.at(this.pos[0],o[1]).blocksSight||t.cells.at(o[0],this.pos[1]).blocksSight))return!1;return!0}hidden(t){return!!t.cells.atVec(this.pos).hidesPlayer}sightCutoff(t){return this.mode===4?t?75:33:!Me(this.mode)||this.angry?t?75:15:t?40:3}enterPatrolMode(t){this.patrolPathIndex=t.patrolPathIndexForResume(this.patrolPath,this.patrolPathIndex,this.pos),this.mode=0}choosePatrolStep(t){return this.pos.equals(this.patrolPath[this.patrolPathIndex])&&(this.patrolPathIndex=(this.patrolPathIndex+1)%this.patrolPath.length),this.chooseMoveTowardPosition(this.patrolPath[this.patrolPathIndex],t.gameMap)}makeBestAvailableMove(t,o){const[n,r]=this.bestAvailableMove(this.goals,t,o);if(!n.equals(this.pos)){De(this.dir,this.pos,n);const s=m.create();m.subtract(s,this.pos,n);const i=m.create();this.animation=new ue([{pt0:s,pt1:i,duration:.2,fn:O.linear}],[]),m.copy(this.pos,n)}r&&(this.mode=4,De(this.dir,this.pos,o.pos))}updateDirInitial(){const t=(this.patrolPathIndex+1)%this.patrolPath.length;De(this.dir,this.pos,this.patrolPath[t])}chooseMoveTowardPosition(t,o){const n={posMin:m.fromValues(Math.max(0,this.pos[0]-1),Math.max(0,this.pos[1]-1)),posMax:m.fromValues(Math.min(o.cells.sizeX,this.pos[0]+2),Math.min(o.cells.sizeY,this.pos[1]+2))},r=o.computeDistancesToPosition(t,n);return o.nextPositions(r,this.pos)}chooseMoveTowardAdjacentToPosition(t,o){const n={posMin:m.fromValues(Math.max(0,this.pos[0]-1),Math.max(0,this.pos[1]-1)),posMax:m.fromValues(Math.min(o.cells.sizeX,this.pos[0]+2),Math.min(o.cells.sizeY,this.pos[1]+2))},r=o.computeDistancesToAdjacentToPosition(t,n);return o.nextPositions(r,this.pos)}}function Me(e){return e===0||e===13||e===14}function Fr(e,t,o){const r=o.cells,s=o.items.filter(l=>l.type>=M.DoorNS&&l.type<=M.PortcullisEW);let i;function c(l,f,d,a){const u=[];for(let h of[[1,0],[0,1],[-1,0],[0,-1]]){const p=f.add(m.fromValues(h[0],h[1]));if(l.has(p[1]*r.sizeX+p[0]))continue;l.add(p[1]*r.sizeX+p[0]);const y=r.atVec(p);if(y.type===L.DoorEW||y.type===L.DoorNS||y.type===L.PortcullisEW||y.type===L.PortcullisNS){const g=s.find(w=>w.pos.equals(p)),x=t.find(w=>w[0].equals(p));if(g!==void 0&&x){const w=x[1],S=w[1]*r.sizeX+w[0];if(!l.has(S))switch(g.type){case M.DoorEW:case M.DoorNS:i=["doorOpen",p];break;case M.LockedDoorEW:case M.LockedDoorNS:i=["doorOpenLocked",p];break;case M.PortcullisEW:case M.PortcullisNS:i=["gate",p];break}}if(i!==void 0||g&&!a)return}(y.type<L.Wall0000||y.type>L.Wall1111)&&u.push(p)}if(d>0&&i===void 0)for(let h of u)c(l,h,d-1,!1)}return c(new Set,e,20,!0),i}function Lt(e){for(const t of e.gameMap.guards)t.chooseMoves(e)}function Or(e){const t=e.gameMap,o=e.player;for(const l of t.guards)l.modePrev=l.mode,l.heardGuard=l.hearingGuard,l.hearingGuard=!1,l.speaking=!1,l.hasMoved=!1;const n=(l,f)=>{const d=l.mode===4,a=f.mode===4;return d!==a?d?-1:1:f.patrolPath.length-l.patrolPath.length};t.guards.sort(n);const r=[],s=[];for(const l of t.guards){const f=m.clone(l.pos);l.act(e,r),l.hasMoved=!0,f.equals(l.pos)||s.push([l.pos,f])}t.computeLighting(o);const i=[];for(const l of t.guards)l.postActSense(t,o,e.levelStats,r,i,e.rng);if(r.length>0){r.sort((y,g)=>{if(y.speechType<g.speechType)return-1;if(y.speechType>g.speechType)return 1;const x=y.speaker.pos,w=g.speaker.pos,S=m.squaredDistance(x,o.pos),T=m.squaredDistance(w,o.pos);return S<T?-1:S>T?1:0});const l=r[0],f=Hr(l.speechType);let d=Math.max(Math.min((l.speaker.pos[0]-o.pos[0])/12,1),0),a=Math.max(1-l.speaker.pos.distance(o.pos)/12,0);const u=e.subtitledSounds[f].play(.3+.3*a,d),h=r[0].speaker,p=h.pos[1]>=o.pos[1];e.popups.setSpeech(u.subtitle,h,p),h.speaking=!0}for(const l of i)Xr(t,l);o.pickTarget!==null&&o.pickTarget instanceof Et&&(o.pickTarget.mode===4||!o.pickTarget.cardinallyAdjacentTo(o.pos))&&(o.pickTarget=null);const c=Fr(e.player.pos,s,e.gameMap);if(c){const[l,f]=c;let d=Math.max(Math.min((f[0]-o.pos[0])/12,1),0),a=Math.max(1-f.distance(o.pos)/12,0);e.sounds[l].play(.2+.3*a,d)}}function Hr(e){switch(e){case H.Damage:return"guardDamage";case H.GuardChase:return"guardChase";case H.GuardSeeThief:return"guardSeeThief";case H.GuardHearThief:return"guardHearThief";case H.GuardHearGuard:return"guardHearGuard";case H.GuardSpotDownedGuard:return"guardSpotDownedGuard";case H.GuardSeeTorchLit:return"guardSeeTorchLit";case H.GuardSeeUnlitTorch:return"guardSeeUnlitTorch";case H.GuardDownWarning:return"guardDownWarning";case H.GuardAwakesWarning:return"guardAwakesWarning";case H.GuardWarningResponse:return"guardWarningResponse";case H.GuardInvestigate:return"guardInvestigate";case H.GuardEndChase:return"guardEndChase";case H.GuardFinishInvestigating:return"guardFinishInvestigating";case H.GuardFinishLooking:return"guardFinishLooking";case H.GuardFinishListening:return"guardFinishListening";case H.GuardFinishLightingTorch:return"guardFinishLightingTorch";case H.GuardFinishLookingAtLitTorch:return"guardFinishLookingAtLitTorch";case H.GuardStirring:return"guardStirring";case H.GuardSeeTorchDoused:return"guardSeeTorchDoused";case H.GuardSpotStolenTreasure:return"guardSpotStolenTreasure";case H.GuardExamineStolenTreasure:return"guardExamineStolenTreasure"}}function zr(e,t,o){if(t==e)return;const n=o<=Uo;switch(t){case 0:switch(e){case 1:return H.GuardFinishLooking;case 2:return H.GuardFinishLookingAtLitTorch;case 3:return H.GuardFinishListening;case 7:return H.GuardFinishInvestigating;case 8:return H.GuardEndChase;case 5:return H.GuardEndChase;case 6:return H.GuardEndChase;case 14:return n?H.GuardFinishLightingTorch:void 0;case 15:return H.GuardAwakesWarning;case 10:return;case 11:return;default:return}case 1:return H.GuardSeeThief;case 2:return H.GuardSeeTorchLit;case 3:return H.GuardHearThief;case 4:return e!=5&&e!==6?H.GuardChase:void 0;case 14:return e===0&&n?H.GuardSeeUnlitTorch:void 0;case 5:return;case 6:return;case 7:return H.GuardInvestigate;case 8:return H.GuardHearGuard;case 13:return e!==14&&n?H.GuardSeeUnlitTorch:void 0;case 9:return H.GuardSpotDownedGuard;case 12:return H.GuardDownWarning;case 10:return H.GuardSpotStolenTreasure;case 11:return H.GuardExamineStolenTreasure}}function Xr(e,t){for(const o of e.guardsInEarshot(t.posShouter,25))o.mode!==15&&(o.pos.equals(t.posShouter)||(o.hearingGuard=!0,t.angry&&(o.angry=!0),m.copy(o.heardGuardPos,t.posGoal)))}function De(e,t,o){const n=m.create();m.subtract(n,o,t);const r=m.fromValues(-e[1],e[0]),s=m.dot(e,n),i=m.dot(r,n);s>=Math.abs(i)||(-s>Math.abs(i)?m.negate(e,e):i>=0?m.copy(e,r):m.negate(e,r))}function on(e,t){let o,n=Uo+1;for(const r of e.items)if(r.type===M.TorchUnlit){const s=m.squaredDistance(r.pos,t);if(s>=n||!Ro(e,t,r.pos))continue;n=s,o=r}return o}function Yr(e,t){for(const o of e.items)o.type===M.TorchUnlit&&o.pos.equals(t)&&(o.type=M.TorchLit)}function Lo(e,t,o){let n=t[0],r=t[1];const s=o[0]-n,i=o[1]-r;let c=Math.abs(s),l=Math.abs(i);const f=s>0?1:-1,d=i>0?1:-1;let a=l-c;const u=c+l-1;let h=u;for(c*=2,l*=2;h>0;){if(a>0)r+=d,a-=c;else{if(a===0){const y=e.cells.at(n,r+d);if(y.blocksSight||y.isWindow&&h>1&&h<u-1)return!1}n+=f,a+=l}const p=e.cells.at(n,r);if(p.blocksSight||p.isWindow&&h>1&&h<u-1)return!1;--h}return!0}function jr(e){return!!(e.blocksSight||Ye(e.type))}function Ro(e,t,o){let n=t[0],r=t[1];const s=o[0]-n,i=o[1]-r;let c=Math.abs(s),l=Math.abs(i);const f=s>0?1:-1,d=i>0?1:-1;let a=l-c,u=c+l-1;for(c*=2,l*=2;u>0;){if(a>0)r+=d,a-=c;else{if(a===0&&jr(e.cells.at(n,r+d)))return!1;n+=f,a+=l}const h=e.cells.at(n,r);if(h.blocksSight||Ye(h.type))return!1;--u}return!0}const nn=[m.fromValues(-1,0),m.fromValues(1,0),m.fromValues(0,-1),m.fromValues(0,1)];class he{constructor(t,o,n){this.sizeX=t,this.sizeY=o,this.values=new Uint8Array(t*o),this.fill(n)}fill(t){this.values.fill(t?1:0)}get(t,o){return this.values[this.sizeX*o+t]!==0}set(t,o,n){this.values[this.sizeX*o+t]=n?1:0}}class Ue{constructor(t,o,n){this.sizeX=t,this.sizeY=o,this.values=new Int32Array(t*o),this.fill(n)}fill(t){this.values.fill(t)}get(t,o){return this.values[this.sizeX*o+t]}set(t,o,n){this.values[this.sizeX*o+t]=n}}class po{constructor(t,o,n){this.sizeX=t,this.sizeY=o,this.values=new Float64Array(t*o),this.fill(n)}fill(t){this.values.fill(t)}get(t,o){return this.values[this.sizeX*o+t]}set(t,o,n){this.values[this.sizeX*o+t]=n}}var E=(e=>(e[e.Manor=0]="Manor",e[e.ManorRed=1]="ManorRed",e[e.Mansion=2]="Mansion",e[e.Fortress=3]="Fortress",e[e.Warrens=4]="Warrens",e))(E||{});function qr(e){switch(e){case 0:return"Manor";case 1:return"Manor";case 2:return"Mansion";case 3:return"Fortress";case 4:return"Warrens"}}var L=(e=>(e[e.GroundNormal=0]="GroundNormal",e[e.GroundGrass=1]="GroundGrass",e[e.GroundWater=2]="GroundWater",e[e.GroundMarble=3]="GroundMarble",e[e.GroundWood=4]="GroundWood",e[e.GroundWoodCreaky=5]="GroundWoodCreaky",e[e.GroundVault=6]="GroundVault",e[e.GroundTreasure=7]="GroundTreasure",e[e.Wall0000=8]="Wall0000",e[e.Wall0001=9]="Wall0001",e[e.Wall0010=10]="Wall0010",e[e.Wall0011=11]="Wall0011",e[e.Wall0100=12]="Wall0100",e[e.Wall0101=13]="Wall0101",e[e.Wall0110=14]="Wall0110",e[e.Wall0111=15]="Wall0111",e[e.Wall1000=16]="Wall1000",e[e.Wall1001=17]="Wall1001",e[e.Wall1010=18]="Wall1010",e[e.Wall1011=19]="Wall1011",e[e.Wall1100=20]="Wall1100",e[e.Wall1101=21]="Wall1101",e[e.Wall1110=22]="Wall1110",e[e.Wall1111=23]="Wall1111",e[e.OneWayWindowE=24]="OneWayWindowE",e[e.OneWayWindowW=25]="OneWayWindowW",e[e.OneWayWindowN=26]="OneWayWindowN",e[e.OneWayWindowS=27]="OneWayWindowS",e[e.PortcullisNS=28]="PortcullisNS",e[e.PortcullisEW=29]="PortcullisEW",e[e.DoorNS=30]="DoorNS",e[e.DoorEW=31]="DoorEW",e[e.GardenDoorNS=32]="GardenDoorNS",e[e.GardenDoorEW=33]="GardenDoorEW",e))(L||{});class $r{constructor(t,o){this.sizeX=t,this.sizeY=o;const n=t*o;this.values=new Array(n);for(let r=0;r<n;++r)this.values[r]=this.emptyCell()}at(t,o){if(t<0||t>=this.sizeX||o<0||o>=this.sizeY)return this.emptyCell();const n=this.sizeX*o+t;return this.values[n]}atVec(t){return this.at(t[0],t[1])}index(t,o){return this.sizeX*o+t}indexVec(t){return this.index(t[0],t[1])}emptyCell(){return{type:1,moveCost:1/0,blocksPlayerMove:!1,blocksPlayerSight:!1,blocksSight:!1,blocksSound:!1,hidesPlayer:!1,isWindow:!1,lit:0,litAnim:0,litSrc:new Set,seen:!1,identified:!1}}}var Xe=(e=>(e[e.Relaxed=0]="Relaxed",e[e.Angry=1]="Angry",e[e.Alerted=2]="Alerted",e[e.Chasing=3]="Chasing",e[e.Unconscious=4]="Unconscious",e))(Xe||{}),M=(e=>(e[e.Chair=0]="Chair",e[e.Table=1]="Table",e[e.BedL=2]="BedL",e[e.BedR=3]="BedR",e[e.DrawersShort=4]="DrawersShort",e[e.DrawersTall=5]="DrawersTall",e[e.Bookshelf=6]="Bookshelf",e[e.Shelf=7]="Shelf",e[e.Stove=8]="Stove",e[e.Bush=9]="Bush",e[e.Coin=10]="Coin",e[e.Health=11]="Health",e[e.DoorNS=12]="DoorNS",e[e.DoorEW=13]="DoorEW",e[e.LockedDoorNS=14]="LockedDoorNS",e[e.LockedDoorEW=15]="LockedDoorEW",e[e.PortcullisNS=16]="PortcullisNS",e[e.PortcullisEW=17]="PortcullisEW",e[e.TorchUnlit=18]="TorchUnlit",e[e.TorchLit=19]="TorchLit",e[e.TorchCarry=20]="TorchCarry",e[e.PurseCarry=21]="PurseCarry",e[e.Key=22]="Key",e[e.KeyCarry=23]="KeyCarry",e[e.VaultTreasureBox=24]="VaultTreasureBox",e[e.EmptyVaultTreasureBox=25]="EmptyVaultTreasureBox",e[e.LootedVaultTreasureBox=26]="LootedVaultTreasureBox",e[e.Note=27]="Note",e[e.TreasureLock=28]="TreasureLock",e[e.TreasurePlinth=29]="TreasurePlinth",e[e.TreasureA=30]="TreasureA",e[e.TreasureB=31]="TreasureB",e[e.TreasureC=32]="TreasureC",e[e.TreasureD=33]="TreasureD",e[e.TreasureE=34]="TreasureE",e))(M||{});const je={0:!1,1:!1,2:!1,3:!1,4:!1,5:!1,6:!1,7:!1,8:!1,9:!1,10:!1,11:!1,12:!1,13:!1,14:!1,15:!1,16:!1,17:!1,18:!1,19:!1,20:!1,21:!1,22:!1,23:!1,24:!1,25:!1,26:!1,27:!1,28:!0,29:!1,30:!0,31:!0,32:!0,33:!0,34:!0};function Kr(e){switch(e){case 0:return 32;case 1:return 64;case 2:return 64;case 3:return 64;case 4:return 1/0;case 5:return 1/0;case 6:return 1/0;case 7:return 1/0;case 8:return 1/0;case 9:return 10;case 10:return 0;case 11:return 0;case 12:return 0;case 13:return 0;case 14:return 0;case 15:return 0;case 16:return 0;case 17:return 0;case 18:return 1/0;case 19:return 1/0;case 20:return 0;case 21:return 0;case 22:return 0;case 23:return 0;case 27:return 0;case 28:return 1/0;case 29:return 1/0;case 24:return 1/0;case 25:return 1/0;case 26:return 1/0;case 30:return 1/0;case 31:return 1/0;case 32:return 1/0;case 33:return 1/0;case 34:return 1/0}}const Qr=5,Zr=3,oo=7;class at{constructor(t,o){this.itemUsed=null,this.animation=null,this.torchAnimation=null,this.pickTarget=null,this.lightActive=!1,this.idle=!1,this.idleCursorAnimation=null,this.idleCursorType="orbs",this.pos=m.clone(t),this.dir=m.fromValues(0,-1),this.healthMax=o?Zr:Qr,this.health=this.healthMax,this.loot=0,this.noisy=!1,this.preNoisy=!1,this.noiseOffset=m.fromValues(0,0),this.noisyAnim=0,this.hasVaultKey=!1,this.damagedLastTurn=!1,this.turnsRemainingUnderwater=oo}applyDamage(t){this.health-=Math.min(t,this.health),this.damagedLastTurn=!0}hidden(t){return this.lightActive||t.guards.find(n=>n.mode==fe.ChaseVisibleTarget)!==void 0?!1:!!(t.cells.atVec(this.pos).hidesPlayer||t.cells.atVec(this.pos).type==2&&this.turnsRemainingUnderwater>0)}}const rn=[{lx:-1,ly:-1,rx:-1,ry:1,nx:-1,ny:0},{lx:-1,ly:1,rx:1,ry:1,nx:0,ny:1},{lx:1,ly:1,rx:1,ry:-1,nx:1,ny:0},{lx:1,ly:-1,rx:-1,ry:-1,nx:0,ny:-1}],sn=[{lx:-1,ly:-1,rx:-1,ry:-1,nx:-1,ny:-1},{lx:-1,ly:-1,rx:-1,ry:1,nx:-1,ny:0},{lx:-1,ly:1,rx:-1,ry:1,nx:-1,ny:1},{lx:-1,ly:1,rx:1,ry:1,nx:0,ny:1},{lx:1,ly:1,rx:1,ry:1,nx:1,ny:1},{lx:1,ly:1,rx:1,ry:-1,nx:1,ny:0},{lx:1,ly:-1,rx:1,ry:-1,nx:1,ny:-1},{lx:1,ly:-1,rx:-1,ry:-1,nx:0,ny:-1}];function We(e,t,o,n){return e*n>t*o}const mo=[{dx:1,dy:0,cost:2},{dx:-1,dy:0,cost:2},{dx:0,dy:1,cost:2},{dx:0,dy:-1,cost:2},{dx:-1,dy:-1,cost:3},{dx:1,dy:-1,cost:3},{dx:-1,dy:1,cost:3},{dx:1,dy:1,cost:3}];class Jr{constructor(t){this.cells=t,this.patrolRegions=[],this.patrolRoutes=[],this.items=[],this.guards=[],this.playerStartPos=m.create(),this.lightCount=0,this.numPreRevealedCells=0,this.backtrackingCoefficient=1,this.bookTitle=new Map,this.treasures=[],this.rooms=[],this.adjacencies=[]}hasLootAt(t){return this.items.some(o=>o.pos.equals(t)&&(o.type===10||o.type>=30||o.type===11||o.type===24))}collectLootAt(t){let o=[];const n=this.items.some(r=>r.type===28&&r.pos.equals(t));return this.items=this.items.filter(r=>r.pos.equals(t)&&(r.type===10||r.type===11||r.type>=30&&!n||r.type===24)?(o.push(r),!1):!0),o}collectAllLoot(){let t=0;this.items=this.items.filter(o=>o.type!=10?!0:(++t,!1));for(let o of this.guards)o.hasPurse&&(++t,o.hasPurse=!1);return t}identifyAdjacentCells(t){const o=Math.max(t[0]-1,0),n=Math.max(t[1]-1,0),r=Math.min(t[0]+2,this.cells.sizeX),s=Math.min(t[1]+2,this.cells.sizeY);for(let i=o;i<r;++i)for(let c=n;c<s;++c)this.cells.at(i,c).identified=!0}allSeen(){return!this.cells.values.some(t=>!t.seen)}numCells(){return this.cells.values.length}numCellsSeen(){let t=0;for(const o of this.cells.values)o.seen&&++t;return t}fractionRevealed(){return(this.numCellsSeen()-this.numPreRevealedCells)/(this.numCells()-this.numPreRevealedCells)}markAllSeen(){for(const t of this.cells.values)t.seen=!0,t.identified=!0}markAllUnseen(){for(const t of this.cells.values)t.seen=!1,t.identified=!1}recomputeVisibility(t){this.recomputeVisibilityFromPos(t);const o=m.create();for(const n of nn)this.playerCanSeeInDirection(t,n)&&(m.add(o,t,n),this.recomputeVisibilityFromPos(o))}recomputeVisibilityFromPos(t){for(const o of rn)this.computeVisibility(t[0],t[1],t[0],t[1],o.lx,o.ly,o.rx,o.ry)}playerCanSeeInDirection(t,o){const n=m.create();return m.add(n,t,o),!(n[0]<0||n[1]<0||n[0]>=this.cells.sizeX||n[1]>=this.cells.sizeY||this.cells.at(n[0],n[1]).blocksPlayerSight)}computeVisibility(t,o,n,r,s,i,c,l){if(n<0||r<0||n>=this.cells.sizeX||r>=this.cells.sizeY)return;let f=n-t,d=r-o;if(f**2+d**2>400)return;f*=2,d*=2;const a=this.cells.at(n,r);if(a.seen=!0,!a.blocksPlayerSight){for(let u=0;u<2;++u)for(let h=0;h<2;++h){let p=n+2*u-1,y=r+2*h-1,g=f+2*u-1,x=d+2*h-1;p>=0&&y>=0&&p<this.cells.sizeX&&y<this.cells.sizeY&&!We(s,i,g,x)&&!We(g,x,c,l)&&(this.cells.at(p,y).seen=!0)}for(const u of rn){const h=f+u.lx,p=d+u.ly,y=f+u.rx,g=d+u.ry,[x,w]=We(s,i,h,p)?[s,i]:[h,p],[S,T]=We(c,l,y,g)?[y,g]:[c,l];We(S,T,x,w)&&this.computeVisibility(t,o,n+u.nx,r+u.ny,x,w,S,T)}}}computeLighting(t){const o=new Set;t!==null&&this.cells.atVec(t.pos).type>=8&&o.add(this.cells.atVec(t.pos));for(let r of this.guards){const s=this.cells.at(r.pos[0],r.pos[1]);s.type>=8&&o.add(s)}for(const r of this.cells.values)r.lit=0,r.litSrc.clear();let n=0;for(const r of this.items)r.type===19&&(this.castLight(r.pos,45,n,o),n++),r.type===8&&(this.castLight(r.pos,25,n,o),n++),r.type==18&&n++;for(const r of this.guards)r.hasTorch&&(r.mode!==fe.Unconscious&&this.castLight(r.pos,15,n,o),n++);t!==null&&t.lightActive&&this.castLight(t.pos,0,n,o),n++,this.lightCount=n}castLight(t,o,n,r){this.cells.at(t[0],t[1]).lit=1;for(const s of sn)this.castLightRecursive(t[0],t[1],t[0]+s.nx,t[1]+s.ny,s.lx,s.ly,s.rx,s.ry,o,n,r)}castLightRecursive(t,o,n,r,s,i,c,l,f,d,a){if(n<0||r<0||n>=this.cells.sizeX||r>=this.cells.sizeY)return;let u=n-t,h=r-o;if(u**2+h**2>f)return;const p=this.cells.at(n,r);if(!p.litSrc.has(d)){const y=u**2+h**2;p.lit+=1/(.5*y+1),p.lit=Math.min(p.lit,1),p.litSrc.add(d)}if(!(p.blocksSight&&!a.has(p))&&We(c,l,s,i)){u*=2,h*=2;for(const y of sn){const g=u+y.lx,x=h+y.ly,w=u+y.rx,S=h+y.ry,[T,I]=We(s,i,g,x)?[s,i]:[g,x],[D,R]=We(c,l,w,S)?[w,S]:[c,l];We(T,I,D,R)||this.castLightRecursive(t,o,n+y.nx,r+y.ny,T,I,D,R,f,d,a)}}}allLootCollected(){return this.items.find(t=>t.type==10)===void 0}isGuardAt(t,o){return this.guards.find(n=>n.hasMoved&&n.pos.equalsValues(t,o))!=null}isGuardAtVec(t){return this.guards.find(o=>o.hasMoved&&o.pos.equals(t))!=null}guardMoveCost(t,o){const n=this.cells.atVec(o).moveCost;return n===1/0?n:t[0]!=o[0]&&t[1]!=o[1]&&(this.cells.at(t[0],o[1]).moveCost>=64||this.cells.at(o[0],t[1]).moveCost>=64)?1/0:n}posNextBest(t,o){let n=1/0,r=m.clone(o);const s=m.fromValues(Math.max(0,o[0]-1),Math.max(0,o[1]-1)),i=m.fromValues(Math.min(this.cells.sizeX,o[0]+2),Math.min(this.cells.sizeY,o[1]+2));for(let c=s[0];c<i[0];++c)for(let l=s[1];l<i[1];++l){const f=t.get(c,l);if(f==1/0)continue;let d=m.fromValues(c,l);this.guardMoveCost(o,d)!=1/0&&(this.isGuardAtVec(d)||f<n&&(n=f,r=d))}return r}nextPositions(t,o){const n=m.fromValues(Math.max(0,o[0]-1),Math.max(0,o[1]-1)),r=m.fromValues(Math.min(this.cells.sizeX,o[0]+2),Math.min(this.cells.sizeY,o[1]+2)),s=[];for(let i=n[0];i<r[0];++i)for(let c=n[1];c<r[1];++c){const l=t.get(i,c);if(l===1/0)continue;let f=m.fromValues(i,c);if(this.guardMoveCost(o,f)===1/0)continue;const d=Math.abs(o[0]-f[0])+Math.abs(o[1]-f[1]);s.push([l,d,f])}return s.sort((i,c)=>i[0]!==c[0]?i[0]-c[0]:i[1]-c[1]),s.map(i=>i[2])}patrolPathIndexForResume(t,o,n){const r=this.computeDistancesToPosition(n,void 0);let s=o;for(let i=0;i<t.length;++i){const c=t[s],l=this.posNextBest(r,c),f=t[(s+t.length-1)%t.length],d=m.create();m.subtract(d,c,l);const a=m.create();if(m.subtract(a,c,f),m.dot(d,a)>0)break;s=(s+1)%t.length}return s}computeDistancesToPosition(t,o){return console.assert(t[0]>=0),console.assert(t[1]>=0),console.assert(t[0]<this.cells.sizeX),console.assert(t[1]<this.cells.sizeY),this.computeDistanceField([{priority:0,pos:m.clone(t)}],o)}computeDistancesToPositionSubrect(t,o,n,r,s){return console.assert(t[0]>=o),console.assert(t[1]>=n),console.assert(t[0]<r),console.assert(t[1]<s),this.computeDistanceFieldSubrect([{priority:0,pos:m.clone(t)}],o,n,r,s)}computeDistancesToAdjacentToPosition(t,o){const n=[];for(const r of nn){const s=m.clone(t).add(r);if(s[0]<0||s[1]<0||s[0]>=this.cells.sizeX||s[1]>=this.cells.sizeY)continue;const i=this.cells.atVec(s);i.moveCost!==1/0&&n.push({priority:i.moveCost,pos:s})}return this.computeDistanceField(n,o)}computeDistanceField(t,o){let n=this.cells.sizeX,r=this.cells.sizeY;const s=[],i=new po(n,r,1/0);for(const l of t)ot(s,l);let c=o===void 0?1:this.numNavigableSquaresInRect(o);for(;s.length>0&&c>0;){const l=go(s);if(!(l.priority>=i.get(l.pos[0],l.pos[1]))){i.set(l.pos[0],l.pos[1],l.priority),o!==void 0&&l.pos[0]>=o.posMin[0]&&l.pos[1]>=o.posMin[1]&&l.pos[0]<o.posMax[0]&&l.pos[1]<o.posMax[1]&&--c;for(const f of mo){const d=m.fromValues(l.pos[0]+f.dx,l.pos[1]+f.dy);if(d[0]<0||d[1]<0||d[0]>=n||d[1]>=r)continue;const a=this.guardMoveCost(l.pos,d);if(a==1/0)continue;const u=l.priority+a+f.cost;u<i.get(d[0],d[1])&&ot(s,{priority:u,pos:d})}}}return i}numNavigableSquaresInRect(t){let o=0;for(let n=t.posMin[0];n<t.posMax[0];++n)for(let r=t.posMin[1];r<t.posMax[1];++r)this.cells.at(n,r).moveCost!==1/0&&++o;return o}computeDistanceFieldSubrect(t,o,n,r,s){console.assert(o>=0),console.assert(n>=0),console.assert(r<=this.cells.sizeX),console.assert(s<=this.cells.sizeY);const i=r-o,c=s-n,l=[],f=new po(i,c,1/0);for(const d of t)ot(l,{priority:d.priority,pos:[d.pos[0]-o,d.pos[1]-n]});for(;l.length>0;){const d=go(l);if(d.priority>=f.get(d.pos[0],d.pos[1]))continue;f.set(d.pos[0],d.pos[1],d.priority);const a=m.fromValues(d.pos[0]+o,d.pos[1]+n);for(const u of mo){const h=m.fromValues(d.pos[0]+u.dx,d.pos[1]+u.dy);if(h[0]<0||h[1]<0||h[0]>=i||h[1]>=c)continue;const p=m.fromValues(h[0]+o,h[1]+n),y=this.guardMoveCost(a,p);if(y==1/0)continue;const g=d.priority+y+u.cost;g<f.get(h[0],h[1])&&ot(l,{priority:g,pos:h})}}return f}guardsInEarshot(t,o){const n=this.cells.sizeX,r=this.cells.sizeY,s=new Map;for(const f of this.guards)f.mode!==fe.Unconscious&&s.set(n*f.pos[1]+f.pos[0],f);const i=[],c=new po(n,r,1/0),l=[];for(ot(i,{priority:0,pos:t});i.length>0;){const f=go(i);if(f.priority>=c.get(f.pos[0],f.pos[1]))continue;c.set(f.pos[0],f.pos[1],f.priority);const d=s.get(n*f.pos[1]+f.pos[0]);d!==void 0&&l.push(d);for(const a of mo){const u=m.fromValues(f.pos[0]+a.dx,f.pos[1]+a.dy);if(u[0]<0||u[1]<0||u[0]>=n||u[1]>=r)continue;const h=f.priority+a.cost;h>o||this.cells.at(u[0],u[1]).blocksSound||h>=c.get(u[0],u[1])||ot(i,{priority:h,pos:u})}}return l}tryGetPosLookAt(t,o){const n=t[0],r=t[1];if(o){const s=this.items.filter(i=>Math.abs(i.pos[0]-n)<2&&Math.abs(i.pos[1]-r)<2&&(i.type===15||i.type===14));if(s.find(i=>i.pos[0]===n-1&&i.pos[1]===r))return m.fromValues(n+1,r);if(s.find(i=>i.pos[0]===n+1&&i.pos[1]===r))return m.fromValues(n-1,r);if(s.find(i=>i.pos[0]===n&&i.pos[1]===r-1))return m.fromValues(n,r+1);if(s.find(i=>i.pos[0]===n&&i.pos[1]===r+1))return m.fromValues(n,r-1);if(n>0&&this.cells.at(n-1,r).type===30)return m.fromValues(n+1,r);if(n<this.cells.sizeX-1&&this.cells.at(n+1,r).type===30)return m.fromValues(n-1,r);if(r>0&&this.cells.at(n,r-1).type===31)return m.fromValues(n,r+1);if(r<this.cells.sizeY-1&&this.cells.at(n,r+1).type==31)return m.fromValues(n,r-1)}if(n>0&&this.cells.at(n-1,r).type==25)return m.fromValues(n-1,r);if(n<this.cells.sizeX-1&&this.cells.at(n+1,r).type==24)return m.fromValues(n+1,r);if(r>0&&this.cells.at(n,r-1).type==27)return m.fromValues(n,r-1);if(r<this.cells.sizeY-1&&this.cells.at(n,r+1).type==26)return m.fromValues(n,r+1);if(this.items.find(s=>s.pos.equals(t)&&s.type===0)){const s=this.items.filter(i=>Math.abs(i.pos[0]-n)<2&&Math.abs(i.pos[1]-r)<2&&(i.type===1||i.type===19||i.type===18));if(s.find(i=>i.pos[0]===n-1&&i.pos[1]===r))return m.fromValues(n-1,r);if(s.find(i=>i.pos[0]===n+1&&i.pos[1]===r))return m.fromValues(n+1,r);if(s.find(i=>i.pos[0]===n&&i.pos[1]===r-1))return m.fromValues(n,r-1);if(s.find(i=>i.pos[0]===n&&i.pos[1]===r+1))return m.fromValues(n,r+1)}}}function Ye(e){return e>=24&&e<=27}function Eo(e){return e>=12&&e<=17}function go(e){const t=e[0];e[0]=e[e.length-1],e.pop();let o=0;const n=e.length;for(;;){let r=o;const s=2*o+1;s<n&&e[s].priority<e[r].priority&&(r=s);const i=s+1;if(i<n&&e[i].priority<e[r].priority&&(r=i),r==o)break;[e[o],e[r]]=[e[r],e[o]],o=r}return t}function ot(e,t){e.push(t);let o=e.length-1;for(;o>0;){const n=Math.floor((o-1)/2);if(e[o].priority>=e[n].priority)break;[e[o],e[n]]=[e[n],e[o]],o=n}}var Nt={exports:{}},es=Nt.exports,an;function ts(){return an||(an=1,function(e){(function(t,o,n){function r(l){var f=this,d=c();f.next=function(){var a=2091639*f.s0+f.c*23283064365386963e-26;return f.s0=f.s1,f.s1=f.s2,f.s2=a-(f.c=a|0)},f.c=1,f.s0=d(" "),f.s1=d(" "),f.s2=d(" "),f.s0-=d(l),f.s0<0&&(f.s0+=1),f.s1-=d(l),f.s1<0&&(f.s1+=1),f.s2-=d(l),f.s2<0&&(f.s2+=1),d=null}function s(l,f){return f.c=l.c,f.s0=l.s0,f.s1=l.s1,f.s2=l.s2,f}function i(l,f){var d=new r(l),a=f&&f.state,u=d.next;return u.int32=function(){return d.next()*4294967296|0},u.double=function(){return u()+(u()*2097152|0)*11102230246251565e-32},u.quick=u,a&&(typeof a=="object"&&s(a,d),u.state=function(){return s(d,{})}),u}function c(){var l=4022871197,f=function(d){d=String(d);for(var a=0;a<d.length;a++){l+=d.charCodeAt(a);var u=.02519603282416938*l;l=u>>>0,u-=l,u*=l,l=u>>>0,u-=l,l+=u*4294967296}return(l>>>0)*23283064365386963e-26};return f}o&&o.exports?o.exports=i:this.alea=i})(es,e)}(Nt)),Nt.exports}var Ft={exports:{}},os=Ft.exports,ln;function ns(){return ln||(ln=1,function(e){(function(t,o,n){function r(c){var l=this,f="";l.x=0,l.y=0,l.z=0,l.w=0,l.next=function(){var a=l.x^l.x<<11;return l.x=l.y,l.y=l.z,l.z=l.w,l.w^=l.w>>>19^a^a>>>8},c===(c|0)?l.x=c:f+=c;for(var d=0;d<f.length+64;d++)l.x^=f.charCodeAt(d)|0,l.next()}function s(c,l){return l.x=c.x,l.y=c.y,l.z=c.z,l.w=c.w,l}function i(c,l){var f=new r(c),d=l&&l.state,a=function(){return(f.next()>>>0)/4294967296};return a.double=function(){do var u=f.next()>>>11,h=(f.next()>>>0)/4294967296,p=(u+h)/(1<<21);while(p===0);return p},a.int32=f.next,a.quick=a,d&&(typeof d=="object"&&s(d,f),a.state=function(){return s(f,{})}),a}o&&o.exports?o.exports=i:this.xor128=i})(os,e)}(Ft)),Ft.exports}var Ot={exports:{}},rs=Ot.exports,un;function ss(){return un||(un=1,function(e){(function(t,o,n){function r(c){var l=this,f="";l.next=function(){var a=l.x^l.x>>>2;return l.x=l.y,l.y=l.z,l.z=l.w,l.w=l.v,(l.d=l.d+362437|0)+(l.v=l.v^l.v<<4^(a^a<<1))|0},l.x=0,l.y=0,l.z=0,l.w=0,l.v=0,c===(c|0)?l.x=c:f+=c;for(var d=0;d<f.length+64;d++)l.x^=f.charCodeAt(d)|0,d==f.length&&(l.d=l.x<<10^l.x>>>4),l.next()}function s(c,l){return l.x=c.x,l.y=c.y,l.z=c.z,l.w=c.w,l.v=c.v,l.d=c.d,l}function i(c,l){var f=new r(c),d=l&&l.state,a=function(){return(f.next()>>>0)/4294967296};return a.double=function(){do var u=f.next()>>>11,h=(f.next()>>>0)/4294967296,p=(u+h)/(1<<21);while(p===0);return p},a.int32=f.next,a.quick=a,d&&(typeof d=="object"&&s(d,f),a.state=function(){return s(f,{})}),a}o&&o.exports?o.exports=i:this.xorwow=i})(rs,e)}(Ot)),Ot.exports}var Ht={exports:{}},is=Ht.exports,cn;function as(){return cn||(cn=1,function(e){(function(t,o,n){function r(c){var l=this;l.next=function(){var d=l.x,a=l.i,u,h;return u=d[a],u^=u>>>7,h=u^u<<24,u=d[a+1&7],h^=u^u>>>10,u=d[a+3&7],h^=u^u>>>3,u=d[a+4&7],h^=u^u<<7,u=d[a+7&7],u=u^u<<13,h^=u^u<<9,d[a]=h,l.i=a+1&7,h};function f(d,a){var u,h=[];if(a===(a|0))h[0]=a;else for(a=""+a,u=0;u<a.length;++u)h[u&7]=h[u&7]<<15^a.charCodeAt(u)+h[u+1&7]<<13;for(;h.length<8;)h.push(0);for(u=0;u<8&&h[u]===0;++u);for(u==8?h[7]=-1:h[u],d.x=h,d.i=0,u=256;u>0;--u)d.next()}f(l,c)}function s(c,l){return l.x=c.x.slice(),l.i=c.i,l}function i(c,l){c==null&&(c=+new Date);var f=new r(c),d=l&&l.state,a=function(){return(f.next()>>>0)/4294967296};return a.double=function(){do var u=f.next()>>>11,h=(f.next()>>>0)/4294967296,p=(u+h)/(1<<21);while(p===0);return p},a.int32=f.next,a.quick=a,d&&(d.x&&s(d,f),a.state=function(){return s(f,{})}),a}o&&o.exports?o.exports=i:this.xorshift7=i})(is,e)}(Ht)),Ht.exports}var zt={exports:{}},ls=zt.exports,fn;function us(){return fn||(fn=1,function(e){(function(t,o,n){function r(c){var l=this;l.next=function(){var d=l.w,a=l.X,u=l.i,h,p;return l.w=d=d+1640531527|0,p=a[u+34&127],h=a[u=u+1&127],p^=p<<13,h^=h<<17,p^=p>>>15,h^=h>>>12,p=a[u]=p^h,l.i=u,p+(d^d>>>16)|0};function f(d,a){var u,h,p,y,g,x=[],w=128;for(a===(a|0)?(h=a,a=null):(a=a+"\0",h=0,w=Math.max(w,a.length)),p=0,y=-32;y<w;++y)a&&(h^=a.charCodeAt((y+32)%a.length)),y===0&&(g=h),h^=h<<10,h^=h>>>15,h^=h<<4,h^=h>>>13,y>=0&&(g=g+1640531527|0,u=x[y&127]^=h+g,p=u==0?p+1:0);for(p>=128&&(x[(a&&a.length||0)&127]=-1),p=127,y=4*128;y>0;--y)h=x[p+34&127],u=x[p=p+1&127],h^=h<<13,u^=u<<17,h^=h>>>15,u^=u>>>12,x[p]=h^u;d.w=g,d.X=x,d.i=p}f(l,c)}function s(c,l){return l.i=c.i,l.w=c.w,l.X=c.X.slice(),l}function i(c,l){c==null&&(c=+new Date);var f=new r(c),d=l&&l.state,a=function(){return(f.next()>>>0)/4294967296};return a.double=function(){do var u=f.next()>>>11,h=(f.next()>>>0)/4294967296,p=(u+h)/(1<<21);while(p===0);return p},a.int32=f.next,a.quick=a,d&&(d.X&&s(d,f),a.state=function(){return s(f,{})}),a}o&&o.exports?o.exports=i:this.xor4096=i})(ls,e)}(zt)),zt.exports}var Xt={exports:{}},cs=Xt.exports,hn;function fs(){return hn||(hn=1,function(e){(function(t,o,n){function r(c){var l=this,f="";l.next=function(){var a=l.b,u=l.c,h=l.d,p=l.a;return a=a<<25^a>>>7^u,u=u-h|0,h=h<<24^h>>>8^p,p=p-a|0,l.b=a=a<<20^a>>>12^u,l.c=u=u-h|0,l.d=h<<16^u>>>16^p,l.a=p-a|0},l.a=0,l.b=0,l.c=-1640531527,l.d=1367130551,c===Math.floor(c)?(l.a=c/4294967296|0,l.b=c|0):f+=c;for(var d=0;d<f.length+20;d++)l.b^=f.charCodeAt(d)|0,l.next()}function s(c,l){return l.a=c.a,l.b=c.b,l.c=c.c,l.d=c.d,l}function i(c,l){var f=new r(c),d=l&&l.state,a=function(){return(f.next()>>>0)/4294967296};return a.double=function(){do var u=f.next()>>>11,h=(f.next()>>>0)/4294967296,p=(u+h)/(1<<21);while(p===0);return p},a.int32=f.next,a.quick=a,d&&(typeof d=="object"&&s(d,f),a.state=function(){return s(f,{})}),a}o&&o.exports?o.exports=i:this.tychei=i})(cs,e)}(Xt)),Xt.exports}var Yt={exports:{}};const hs={},ds=Object.freeze(Object.defineProperty({__proto__:null,default:hs},Symbol.toStringTag,{value:"Module"})),ps=Er(ds);var ms=Yt.exports,dn;function gs(){return dn||(dn=1,function(e){(function(t,o,n){var r=256,s=6,i=52,c="random",l=n.pow(r,s),f=n.pow(2,i),d=f*2,a=r-1,u;function h(T,I,D){var R=[];I=I==!0?{entropy:!0}:I||{};var A=x(g(I.entropy?[T,S(o)]:T??w(),3),R),W=new p(R),C=function(){for(var k=W.g(s),U=l,G=0;k<f;)k=(k+G)*r,U*=r,G=W.g(1);for(;k>=d;)k/=2,U/=2,G>>>=1;return(k+G)/U};return C.int32=function(){return W.g(4)|0},C.quick=function(){return W.g(4)/4294967296},C.double=C,x(S(W.S),o),(I.pass||D||function(k,U,G,V){return V&&(V.S&&y(V,W),k.state=function(){return y(W,{})}),G?(n[c]=k,U):k})(C,A,"global"in I?I.global:this==n,I.state)}function p(T){var I,D=T.length,R=this,A=0,W=R.i=R.j=0,C=R.S=[];for(D||(T=[D++]);A<r;)C[A]=A++;for(A=0;A<r;A++)C[A]=C[W=a&W+T[A%D]+(I=C[A])],C[W]=I;(R.g=function(k){for(var U,G=0,V=R.i,Q=R.j,X=R.S;k--;)U=X[V=a&V+1],G=G*r+X[a&(X[V]=X[Q=a&Q+U])+(X[Q]=U)];return R.i=V,R.j=Q,G})(r)}function y(T,I){return I.i=T.i,I.j=T.j,I.S=T.S.slice(),I}function g(T,I){var D=[],R=typeof T,A;if(I&&R=="object")for(A in T)try{D.push(g(T[A],I-1))}catch{}return D.length?D:R=="string"?T:T+"\0"}function x(T,I){for(var D=T+"",R,A=0;A<D.length;)I[a&A]=a&(R^=I[a&A]*19)+D.charCodeAt(A++);return S(I)}function w(){try{var T;return u&&(T=u.randomBytes)?T=T(r):(T=new Uint8Array(r),(t.crypto||t.msCrypto).getRandomValues(T)),S(T)}catch{var I=t.navigator,D=I&&I.plugins;return[+new Date,t,D,t.screen,S(o)]}}function S(T){return String.fromCharCode.apply(0,T)}if(x(n.random(),o),e.exports){e.exports=h;try{u=ps}catch{}}else n["seed"+c]=h})(typeof self<"u"?self:ms,[],Math)}(Yt)),Yt.exports}var yo,pn;function ys(){if(pn)return yo;pn=1;var e=ts(),t=ns(),o=ss(),n=as(),r=us(),s=fs(),i=gs();return i.alea=e,i.xor128=t,i.xorwow=o,i.xorshift7=n,i.xor4096=r,i.tychei=s,yo=i,yo}var xs=ys();const xo=Ur(xs);class Ne{constructor(t=""){t!==""?(this.seed=t,this.rng=xo(t)):(this.seed="",this.rng=xo())}reset(){this.rng=xo(this.seed)}random(){return this.rng()}randomInRange(t){return Math.floor(this.rng()*t)}shuffleArray(t){for(let o=t.length-1;o>0;--o){let n=this.randomInRange(o+1),r=t[o];t[o]=t[n],t[n]=r}}}function vs(e){return Math.floor(Math.random()*e)}function Kt(e){for(let t=e.length-1;t>0;--t){let o=vs(t+1),n=e[t];e[t]=e[o],e[o]=n}}const no=5,ro=5,Qt=2,No=3,Ms=[[3,3,2,2,6,6],[3,5,2,5,6,12],[3,5,2,6,9,15],[3,5,2,6,12,18],[3,7,3,6,15,21],[3,7,3,6,18,24],[3,7,3,6,21,30],[5,7,4,6,24,36],[5,9,4,6,30,42],[7,9,5,9,35,63]];function ws(e){const t=Fo(10,100,e),o=3+e.randomInRange(2),n=5+e.randomInRange(2),r=7+e.randomInRange(3);return[t[o],t[n],t[r]]}function Fo(e,t,o,n){const r=[],s=4+o.randomInRange(3),i=s+2+o.randomInRange(7-s);let c=o.random()<.2?5:e;c>=s&&++c,c>=i&&++c;let l=e;l>=s&&++l,l>=i&&++l,l>=c&&++l;let f=o.random()<.5?E.Manor:E.ManorRed;for(let u=0;u<e;++u){const h=new Ne("lvl"+u+o.random());let p;u===9||u===c?p=E.Fortress:u===s||u===i?p=E.Mansion:u===l?p=E.Warrens:p=f,p===E.Manor||p===E.ManorRed?f=f===E.Manor?E.ManorRed:E.Manor:f=o.random()<.5?E.Manor:E.ManorRed;const[y,g]=Ss(u,p,h);r.push({levelType:p,level:u,numRoomsX:y,numRoomsY:g,totalLoot:0,rng:h,played:!1})}let d=0;for(const u of r){const h=u.numRoomsX*u.numRoomsY;d+=h}let a=0;for(const u of r){const h=u.numRoomsX*u.numRoomsY,p=Math.floor(t*h/d);a+=p,u.totalLoot=p}return r[r.length-1].totalLoot+=t-a,r}function Ss(e,t,o){let n,r,s,i,c,l;[n,r,s,i,c,l]=Ms[e];let f=n;for(let a=n;a<r;++a)o.random()<.5&&++f;let d=s;for(let a=s;a<i;++a)o.random()<.5&&++d;return(f&1)===0&&(f>n&&o.random()<.5?--f:++f),d=Math.min(Math.floor(l/f),d),d=Math.max(d,Math.ceil(c/f)),t===E.Mansion&&(f=Math.floor((f+1)/3+.5),d=Math.floor((d+1)/3+.5),f=Math.max(2,f),d=Math.max(2,d),f=Math.min(4,f),d=Math.min(4,d),f*=3,d*=3,f-=1,d-=1),[f,d]}function so(e){const t=e.rng;t.reset();const o=e.level,n=e.levelType;if(n===E.Warrens)return Is(o,e.numRoomsX,e.numRoomsY,e.totalLoot,t);const r=new he(e.numRoomsX,e.numRoomsY,!0);switch(n){case E.Manor:case E.ManorRed:Ls(r,t);break;case E.Mansion:Rs(r,t);break;case E.Fortress:As(r,t);break}const s=.75,i=.5,c=t.random()<.25,l=c,f=c,d=c,a=c,u=3,h=3,[p,y]=bs(e.numRoomsX,e.numRoomsY,no,ro,u,h,s,i,l,d,f,a,t),g=(e.numRoomsX&1)===1&&Ts(r);g&&Ds(p,y);const x=(e.numRoomsY&1)===1&&_s(r)&&(!g||t.random()<.5);x&&Ws(p,y),Nn(p,y,Qt,No);const[w,S]=On(r,p,y,n),T=t.randomInRange(24)>=o,R=Hn(g&&T,x&&T,p,y,w,S);zn(R),t.shuffleArray(R),Vs(w,R,o,n,t),ri(w,R,t),n===E.Fortress&&(Io(w),jn(w,o,n,t),Os(R,t)),Io(w),Xn(w),qn(w,o,n,t);const A=Fn(n,w);rr(n,R,A),sr(o,n,w,A,t),A.backtrackingCoefficient=Yn(w),A.playerStartPos=or(o,n,R,A);const W={path:Di(R,A),minRoomDepth:w[0].depth,maxRoomDepth:w[0].depth};ki(A,W.path,t),Wi(A),yr(A.cells),gr(A);let C;o<1?C=[]:o<2?C=Zn(A,w,t):(C=Jn(n,o,A,w,R,t),o>5&&ui(W,C));const k=A.items.find(V=>V.type===M.LockedDoorNS||V.type===M.LockedDoorEW)!==void 0;En(o,A,w,k,C,t);const U=C.length-(k?1:0),G=Math.min(Math.floor(o/3),Math.min(U,e.totalLoot));return cr(e.totalLoot-G,w,A,C,n,t),mr(A.bookTitle,w,A.items.filter(V=>V.type===M.Bookshelf),t),hr(A,w,t),dr(o,A,w,t),pr(o,A,C,G,k,t),Ui(A),A.computeLighting(null),A.recomputeVisibility(A.playerStartPos),A.rooms=w.map(V=>({posMin:V.posMin,posMax:V.posMax})),A.adjacencies=R,A}function Ts(e){const t=Math.floor(e.sizeX/2);for(let o=0;o<e.sizeY;++o)for(let n=0;n<t;++n)if(e.get(n,o)!==e.get(e.sizeX-1-n,o))return!1;return!0}function _s(e){const t=Math.floor(e.sizeY/2);for(let o=0;o<e.sizeX;++o)for(let n=0;n<t;++n)if(e.get(o,n)!==e.get(o,e.sizeY-1-n))return!1;return!0}function Ls(e,t){const o=e.sizeX,n=e.sizeY,r=Math.floor(o*n/4);for(let s=0;s<r;++s){const i=t.randomInRange(o),c=t.randomInRange(n);e.set(i,c,!1)}return(o&1)===1&&Ps(e),(n&1)===1&&t.random()<.125&&ks(e),e}function Rs(e,t){const o=Math.floor((e.sizeX+1)/3),n=Math.floor((e.sizeY+1)/3);e.fill(!1);for(let i=0;i<o;++i)for(let c=0;c<n;++c)for(let l=0;l<2;++l)for(let f=0;f<2;++f)e.set(3*i+l,3*c+f,!0);const r=[];for(let i=0;i<o;++i)for(let c=0;c<n;++c)r.push(i*n+c);const s=[];for(let i=1;i<o;++i)for(let c=0;c<n;++c){const l=(i-1)*n+c,f=i*n+c;s.push([l,f])}for(let i=0;i<o;++i)for(let c=1;c<n;++c){const l=i*n+(c-1),f=i*n+c;s.push([l,f])}t.shuffleArray(s);for(const i of s){const c=i[0],l=i[1],f=r[c],d=r[l],a=c%n,u=Math.floor(c/n),h=l%n,p=Math.floor(l/n);if(f===d)continue;for(let S=0;S<r.length;++S)r[S]===d&&(r[S]=f);const y=3*Math.min(u,p),g=3*Math.max(u,p)+2,x=3*Math.min(a,h),w=3*Math.max(a,h)+2;for(let S=y;S<g;++S)for(let T=x;T<w;++T)e.set(S,T,!0)}}function As(e,t){const o=t.random()<.25;for(let n=0;n<e.sizeX;++n)for(let r=0;r<e.sizeY;++r){const s=Math.min(n,e.sizeX-1-n),i=Math.min(r,e.sizeY-1-r),c=Math.min(s,i);e.set(n,r,c!==1||!o&&r>1&&s!==1)}}function Is(e,t,o,n,r){const s=t,i=o,c=new he(s-1,i,!1),l=new he(s,i-1,!1),f=new he(s,i,!1),d=new he(s,i,!0);for(let C=0;C<s;++C)for(let k=0;k<i-1;++k)r.random()<.125&&f.set(C,k,!0);for(let C=Math.floor(s*i/8);C>0;--C){const k=r.randomInRange(s),U=r.randomInRange(i-1);k>0&&k<s-1&&r.random()<.5&&(f.set(k,U,!0),d.set(k,U,!1))}for(let C=0;C<s-1;++C)c.set(C,i-1,!0);const a=[];for(let C=0;C<s;++C)for(let k=0;k<i-1;++k)f.get(C,k)||a.push([C,k]);r.shuffleArray(a);for(const C of a){if(f.get(C[0],C[1]))continue;const k=[];for(const[V,Q]of[[1,0],[0,1],[0,-1]]){const X=C[0]+V,ie=C[1]+Q;X<0||ie<0||X>=s||ie>=i||d.get(X,ie)&&k.push([V,Q])}if(k.length===0)continue;const[U,G]=k[r.randomInRange(k.length)];f.set(C[0],C[1],!0),U<0?(c.set(C[0]-1,C[1],!0),f.set(C[0]-1,C[1],!0)):U>0?(c.set(C[0],C[1],!0),f.set(C[0]+1,C[1],!0)):G<0?(l.set(C[0],C[1]-1,!0),f.set(C[0],C[1]-1,!0)):G>0&&(l.set(C[0],C[1],!0),f.set(C[0],C[1]+1,!0))}const[u,h,p]=Cs(d,c,l,r);Nn(h,p,1,No);const y=E.Warrens,[g,x]=On(u,h,p,y),T=Hn(!1,!1,h,p,g,x);zn(T),r.shuffleArray(T),ni(g,T,r),Hs(g,T,r),Io(g),Xn(g),qn(g,e,y,r);const I=Fn(y,g);for(const C of I.cells.values)C.type=L.GroundNormal;rr(y,T,I),sr(e,y,g,I,r),I.backtrackingCoefficient=Yn(g),I.playerStartPos=or(e,y,T,I),yr(I.cells),gr(I);let D;e<1?D=[]:e<2?D=Zn(I,g,r):D=Jn(y,e,I,g,T,r);const R=I.items.find(C=>C.type===M.LockedDoorNS||C.type===M.LockedDoorEW)!==void 0;En(e,I,g,R,D,r);const A=D.length-(R?1:0),W=Math.min(Math.floor(e/3),Math.min(A,n));return cr(n-W,g,I,D,y,r),mr(I.bookTitle,g,I.items.filter(C=>C.type===M.Bookshelf),r),hr(I,g,r),dr(e,I,g,r),pr(e,I,D,W,R,r),I.computeLighting(null),I.recomputeVisibility(I.playerStartPos),I.rooms=g.map(C=>({posMin:C.posMin,posMax:C.posMax})),I.adjacencies=T,I}function Cs(e,t,o,n){const r=e.sizeX,s=e.sizeY,i=.8,c=0,l=6,f=4,d=2+n.randomInRange(2),a=3+n.randomInRange(2),u=Array(r+1).fill(l);for(let R=Math.floor(u.length/2);R>0;--R){const A=n.randomInRange(u.length);u[A]+=1}{let R=-1;for(let A=0;A<u.length;++A){const W=R+u[A];u[A]=R,R=W}}const h=Array(s+1).fill(l);for(let R=Math.floor(h.length/2);R>0;--R){const A=n.randomInRange(h.length);h[A]+=1}h[0]+=1,h[h.length-1]+=1;{let R=-1;for(let A=0;A<h.length;++A){const W=R+h[A];h[A]=R,R=W}}const p=new Ue(r+1,s,0),y=new Ue(r,s+1,0),g=n.randomInRange(2);for(let R=0;R<=r;++R)for(let A=0;A<=s;++A){const W=A>0&&A<s&&(R>0&&o.get(R-1,A-1)||R<r&&o.get(R,A-1)),C=R>0&&R<r&&(A>0&&t.get(R-1,A-1)||A<s&&t.get(R-1,A)),k=R>=r?d:u[R+1]-u[R]-f,U=A>=s?a:h[A+1]-h[A]-f;if(W&&C){p.set(R,A,p.get(R,A-1)),y.set(R,A,y.get(R-1,A));continue}if(W||!C&&(n.random()<c?n.randomInRange(2)===0:(R+A+g&1)===0)){if(A<s&&p.set(R,A,A>0?p.get(R,A-1):n.randomInRange(k)+u[R]),R<r){let V=h[A];R<=0?V+=n.randomInRange(U):A===s?V=y.get(R-1,A):n.random()>=i?V+=n.randomInRange(U):(V+=n.randomInRange(U-1),V>=y.get(R-1,A)&&++V),y.set(R,A,V)}}else{if(A<s){let V=u[R];A<=0?V+=n.randomInRange(k):R===0||R===r?V=p.get(R,A-1):n.random()>=i?V+=n.randomInRange(k):(V+=n.randomInRange(k-1),V>=p.get(R,A-1)&&++V),p.set(R,A,V)}R<r&&y.set(R,A,R>0?y.get(R-1,A):n.randomInRange(U)+h[A])}}const x=r*2-1,w=s*2-1,S=new he(x,w,!1),T=new Ue(x+1,w,0),I=new Ue(x,w+1,0),D=2;for(let R=0;R<r;++R)for(let A=0;A<s;++A){const W=p.get(R,A),C=p.get(R+1,A)-D;T.set(2*R,2*A,W),T.set(2*R+1,2*A,C),A+1<s&&(T.set(2*R,2*A+1,W),T.set(2*R+1,2*A+1,C));const k=y.get(R,A),U=y.get(R,A+1)-D;I.set(2*R,2*A,k),I.set(2*R,2*A+1,U),R+1<r&&(I.set(2*R+1,2*A,k),I.set(2*R+1,2*A+1,U))}for(let R=0;R<r;++R)for(let A=0;A<s;++A)S.set(2*R,2*A,e.get(R,A));for(let R=1;R<x;R+=2)for(let A=0;A<w;++A)S.set(R,A,A&1?!1:t.get(Math.floor(R/2),Math.floor(A/2)));for(let R=0;R<x;++R)for(let A=1;A<w;A+=2)S.set(R,A,R&1?!1:o.get(Math.floor(R/2),Math.floor(A/2)));return[S,T,I]}function En(e,t,o,n,r,s){if(e<2)return;if(e<8){mn(e,t,o,n,r,s);return}const i=o.find(l=>l.roomType===5);if(i===void 0){mn(e,t,o,n,r,s);return}const c=[L.GroundGrass,L.GroundMarble,L.GroundWood];for(let l of i.edges)if(l.doorType===3){let f=l.origin;const d=l.roomLeft.roomType===5?l.roomRight:l.roomLeft;for(let a=0;a<l.length;a++){if(t.cells.atVec(f).type===L.DoorEW||t.cells.atVec(f).type===L.DoorNS){if(l.dir[0]===0)for(let u of[-1,1]){const h=f.add(new m(u,0));if(c.includes(t.cells.atVec(h).type)){r.push({path:[h],minRoomDepth:d.depth,maxRoomDepth:d.depth});return}}if(l.dir[1]===0)for(let u of[-1,1]){const h=f.add(new m(0,u));if(c.includes(t.cells.atVec(h).type)){r.push({path:[h],minRoomDepth:d.depth,maxRoomDepth:d.depth});return}}}f=f.add(l.dir)}}}function mn(e,t,o,n,r,s){const i=new he(t.cells.sizeX,t.cells.sizeY,!1);for(const l of r)for(const f of l.path)i.set(f[0],f[1],!0);for(const l of t.items)(l.type===M.Coin||l.type===M.Health||l.type>=M.TreasureA||l.type===M.Note)&&i.set(l.pos[0],l.pos[1],!0);const c=[];if(e>=4)for(const l of t.items){if(l.type!==M.Chair||i.get(l.pos[0],l.pos[1]))continue;let f=!1;for(const d of t.items){if(d.type!==M.Table)continue;const a=d.pos[0]-l.pos[0],u=d.pos[1]-l.pos[1];if(Math.abs(a)+Math.abs(u)===1){f=!0;break}}f&&c.push(l.pos)}for(const l of o){for(let f=l.posMin[0];f<l.posMax[0];++f)l.posMin[1]>0&&t.cells.at(f,l.posMin[1]-1).type==L.OneWayWindowS&&t.cells.at(f,l.posMin[1]).moveCost===0&&t.cells.at(f,l.posMin[1]+1).moveCost!==1/0&&!i.get(f,l.posMin[1])&&c.push(m.fromValues(f,l.posMin[1])),l.posMax[1]<t.cells.sizeY&&t.cells.at(f,l.posMax[1]).type==L.OneWayWindowN&&t.cells.at(f,l.posMax[1]-1).moveCost===0&&t.cells.at(f,l.posMax[1]-2).moveCost!==1/0&&!i.get(f,l.posMax[1]-1)&&c.push(m.fromValues(f,l.posMax[1]-1));for(let f=l.posMin[1];f<l.posMax[1];++f)l.posMin[0]>0&&t.cells.at(l.posMin[0]-1,f).type==L.OneWayWindowW&&t.cells.at(l.posMin[0],f).moveCost===0&&t.cells.at(l.posMin[0]+1,f).moveCost!==1/0&&!i.get(l.posMin[0],f)&&c.push(m.fromValues(l.posMin[0],f)),l.posMax[0]<t.cells.sizeX&&t.cells.at(l.posMax[0],f).type==L.OneWayWindowE&&t.cells.at(l.posMax[0]-1,f).moveCost===0&&t.cells.at(l.posMax[0]-2,f).moveCost!==1/0&&!i.get(l.posMax[0]-1,f)&&c.push(m.fromValues(l.posMax[0]-1,f))}if(c.length>0){const l=c[s.randomInRange(c.length)];for(const f of o)if(l[0]>=f.posMin[0]&&l[1]>=f.posMin[1]&&l[0]<f.posMax[0]&&l[1]<f.posMax[1]){const d=s.randomInRange(r.length+1);r.splice(d,0,{path:[m.clone(l)],minRoomDepth:f.depth,maxRoomDepth:f.depth});return}}}function bs(e,t,o,n,r,s,i,c,l,f,d,a,u){const h=new Ue(e+1,t,0),p=new Ue(e,t+1,0),y=u.randomInRange(2);for(let g=0;g<=e;++g)for(let x=0;x<=t;++x)if(u.random()<c?u.randomInRange(2)===0:(g+x+y&1)===0){if(x<t&&h.set(g,x,x>0?h.get(g,x-1):u.randomInRange(r)+o*g-1),g<e){let S=n*x-1;g<=0?S+=u.randomInRange(s):f&&x===0||a&&x===t?S=p.get(g-1,x):u.random()>=i?S+=u.randomInRange(s):(S+=u.randomInRange(s-1),S>=p.get(g-1,x)&&++S),p.set(g,x,S)}}else{if(x<t){let S=o*g-1;x<=0?S+=u.randomInRange(r):l&&g===0||d&&g===e?S=h.get(g,x-1):u.random()>=i?S+=u.randomInRange(r):(S+=u.randomInRange(r-1),S>=h.get(g,x-1)&&++S),h.set(g,x,S)}g<e&&p.set(g,x,g>0?p.get(g-1,x):u.randomInRange(s)+n*x-1)}return[h,p]}function Ps(e){const t=e.sizeX,o=e.sizeY;console.assert((t&1)===1);const n=(t-1)/2;for(let r=n+1;r<t;++r)for(let s=0;s<o;++s)e.set(r,s,e.get(t-1-r,s))}function ks(e){const t=e.sizeX,o=e.sizeY;console.assert((o&1)===1);const n=(o-1)/2;for(let r=0;r<t;++r)for(let s=n+1;s<o;++s)e.set(r,s,e.get(r,o-1-s))}function Ds(e,t){const o=t.sizeX,n=e.sizeY;console.assert(e.sizeX=o+1),console.assert(t.sizeY=n+1),console.assert((o&1)===1);const r=(o-1)/2,s=Math.floor((r+.5)*no+1);for(let i=r+1;i<o+1;++i)for(let c=0;c<n;++c)e.set(i,c,2*s-e.get(o-i,c));for(let i=r+1;i<o;++i)for(let c=0;c<n+1;++c)t.set(i,c,t.get(o-1-i,c))}function Ws(e,t){const o=t.sizeX,n=e.sizeY;console.assert(e.sizeX=o+1),console.assert(t.sizeY=n+1),console.assert((n&1)===1);const r=(n-1)/2,s=Math.floor((r+.5)*ro+1);for(let i=0;i<o+1;++i)for(let c=r+1;c<n;++c)e.set(i,c,e.get(i,n-1-c));for(let i=0;i<o;++i)for(let c=r+1;c<n+1;++c)t.set(i,c,2*s-t.get(i,n-c))}function Nn(e,t,o,n){const r=t.sizeX,s=e.sizeY;let i=Number.MIN_SAFE_INTEGER;for(let l=0;l<s;++l)i=Math.max(i,-e.get(0,l));i+=o;for(let l=0;l<r+1;++l)for(let f=0;f<s;++f)e.set(l,f,e.get(l,f)+i);let c=Number.MIN_SAFE_INTEGER;for(let l=0;l<r;++l)c=Math.max(c,-t.get(l,0));c+=n;for(let l=0;l<r;++l)for(let f=0;f<s+1;++f)t.set(l,f,t.get(l,f)+c)}function Fn(e,t){let o=0,n=0;for(const s of t)o=Math.max(o,s.posMax[0]),n=Math.max(n,s.posMax[1]);o+=1,n+=1,e!==E.Warrens?(o+=Qt,n+=Qt):(o+=1,n+=1);const r=new $r(o,n);return new Jr(r)}function On(e,t,o,n){const r=e.sizeX,s=e.sizeY,i=new Ue(r,s,0),c=[];c.push({roomType:0,group:0,depth:0,betweenness:0,privateRoom:!1,posMin:m.fromValues(0,0),posMax:m.fromValues(0,0),edges:[],gridX:-1,gridY:-1});const l=n===E.Mansion||n===E.Warrens?0:1;for(let f=0;f<r;++f)for(let d=0;d<s;++d){let a=c.length;i.set(f,d,a),c.push({roomType:e.get(f,d)?2:l,group:a,depth:0,betweenness:0,privateRoom:!1,posMin:m.fromValues(t.get(f,d)+1,o.get(f,d)+1),posMax:m.fromValues(t.get(f+1,d),o.get(f,d+1)),edges:[],gridX:f,gridY:d})}return[c,i]}function Hn(e,t,o,n,r,s){let i=s.sizeX,c=s.sizeY;const l=[];{const f=[];{const d=[];let a=0;for(let u=0;u<i;++u){let h=o.get(u,a),p=o.get(u+1,a),y=n.get(u,a);const g={origin:m.fromValues(h,y),dir:m.fromValues(1,0),length:p-h,roomLeft:r[s.get(u,a)],roomRight:r[0],nextMatching:null,door:!1,doorType:0};g.nextMatching=g,d.push(g),l.push(g)}f.push(d)}for(let d=1;d<c;++d){let a=function(y,g,x,w,S){if(x-g<=0)return;const T={origin:m.fromValues(g,y),dir:m.fromValues(1,0),length:x-g,roomLeft:r[w],roomRight:r[S],nextMatching:null,door:!1,doorType:0};T.nextMatching=T,u.push(T),l.push(T)};const u=[];let h=0,p=0;for(;h<o.sizeX&&p<o.sizeX;){const y=h<o.sizeX?o.get(h,d):1/0,g=p<o.sizeX?o.get(p,d-1):1/0,x=n.get(Math.max(0,Math.max(h,p)-1),d);if(y<g){const w=Math.min(g,h+1<o.sizeX?o.get(h+1,d):1/0),S=h>=s.sizeX?0:s.get(h,d),T=p<=0?0:s.get(p-1,d-1);a(x,y,w,S,T),++h}else{const w=Math.min(y,p+1<o.sizeX?o.get(p+1,d-1):1/0),S=h<=0?0:s.get(h-1,d),T=p>=s.sizeX?0:s.get(p,d-1);a(x,g,w,S,T),++p}}f.push(u)}{const d=[];let a=c;for(let u=0;u<i;++u){let h=o.get(u,a-1),p=o.get(u+1,a-1),y=n.get(u,a);const g={origin:m.fromValues(h,y),dir:m.fromValues(1,0),length:p-h,roomLeft:r[0],roomRight:r[s.get(u,a-1)],nextMatching:null,door:!1,doorType:0};g.nextMatching=g,d.push(g),l.push(g)}f.push(d)}if(e)for(let d=0;d<f.length;++d){let a=f[d],u=0,h=a.length-1;for(;u<=h;){let p=a[u],y=a[h];kt(p,y),u+=1,h-=1}}if(t){let d=0,a=f.length-1;for(;d<a;){let u=f[d],h=f[a];console.assert(u.length==h.length);for(let p=0;p<u.length;++p){let y=u[p],g=h[p];kt(y,g)}d+=1,a-=1}}}{let f=[];{const d=[];let a=0;for(let u=0;u<c;++u){let h=n.get(a,u),p=n.get(a,u+1),y=o.get(a,u);const g={origin:m.fromValues(y,h),dir:m.fromValues(0,1),length:p-h,roomLeft:r[0],roomRight:r[s.get(a,u)],nextMatching:null,door:!1,doorType:0};g.nextMatching=g,d.push(g),l.push(g)}f.push(d)}for(let d=1;d<i;++d){let a=function(y,g,x,w,S){if(x-g<=0)return;const T={origin:m.fromValues(y,g),dir:m.fromValues(0,1),length:x-g,roomLeft:r[w],roomRight:r[S],nextMatching:null,door:!1,doorType:0};T.nextMatching=T,u.push(T),l.push(T)};const u=[];let h=0,p=0;for(;h<n.sizeY&&p<n.sizeY;){const y=h<n.sizeY?n.get(d-1,h):1/0,g=p<n.sizeY?n.get(d,p):1/0,x=o.get(d,Math.max(0,Math.max(h,p)-1));if(y<g){const w=Math.min(g,h+1<n.sizeY?n.get(d-1,h+1):1/0),S=h>=s.sizeY?0:s.get(d-1,h),T=p<=0?0:s.get(d,p-1);a(x,y,w,S,T),++h}else{const w=Math.min(y,p+1<n.sizeY?n.get(d,p+1):1/0),S=h<=0?0:s.get(d-1,h-1),T=p>=s.sizeY?0:s.get(d,p);a(x,g,w,S,T),++p}}f.push(u)}{const d=[];let a=i;for(let u=0;u<c;++u){let h=n.get(a-1,u),p=n.get(a-1,u+1),y=o.get(a,u);const g={origin:m.fromValues(y,h),dir:m.fromValues(0,1),length:p-h,roomLeft:r[s.get(a-1,u)],roomRight:r[0],nextMatching:null,door:!1,doorType:0};g.nextMatching=g,d.push(g),l.push(g)}f.push(d)}if(t)for(let d=0;d<f.length;++d){let a=f[d],u=Math.floor(a.length/2);for(let h=0;h<u;++h){let p=a[h],y=a[a.length-1-h];kt(p,y)}}if(e){let d=0,a=f.length-1;for(;d<a;){let u=f[d],h=f[a];for(let p=0;p<u.length;++p){let y=u[p],g=h[p];kt(y,g)}d+=1,a-=1}}}return l}function kt(e,t){Ao(e).nextMatching=t,Ao(t).nextMatching=e}function Ao(e){let t=e;for(;t.nextMatching!==null&&t.nextMatching!==e;)t=t.nextMatching;return t}function vt(e){Ao(e).nextMatching=e.nextMatching,e.nextMatching=e}function Zt(e){const t=[];let o=e;for(;;){const n=o.nextMatching;if(t.push(o),n===null||n===e)break;o=n}return t}function zn(e){for(const t of e)t.roomLeft.edges.push(t),t.roomRight.edges.push(t)}function Vs(e,t,o,n,r){ke(e,t,c=>c.roomLeft.roomType===0&&c.roomRight.roomType===0),ke(e,t,c=>c.roomLeft.roomType===1&&c.roomRight.roomType===1),n===E.Fortress?ke(e,t,c=>c.roomLeft.roomType!==0&&c.roomRight.roomType!==0&&c.roomLeft.group!==c.roomRight.group):(ke(e,t,c=>c.roomLeft.roomType===2&&c.roomRight.roomType===2&&(c.roomLeft.group!==c.roomRight.group||r.random()<.4)),ke(e,t,c=>c.roomLeft.roomType!==0&&c.roomRight.roomType!==0&&c.roomLeft.roomType!==c.roomRight.roomType&&(c.roomLeft.group!==c.roomRight.group||r.random()<.4)));const s=Gs(t),i=Us(t);if(i!==void 0&&(i.door=!0,i.doorType=1,vt(i)),s>80||r.random()<.2){const c=Es(t);c!==void 0&&(c.door=!0,c.doorType=n!==E.Fortress&&(o<3||r.random()<.5)?2:3,vt(c))}if(s>120||r.random()<.2){const c=n!==E.Fortress&&o<3?2:3,l=Ns(t);if(l!==void 0)for(const d of Zt(l))d.door=!0,d.doorType=c;const f=Fs(t);if(f!==void 0)for(const d of Zt(f))d.door=!0,d.doorType=c}}function ke(e,t,o){const n=new Set;for(const r of t){if(n.has(r))continue;const s=Zt(r);for(const i of s)n.add(i);if(console.assert(s.every(i=>i.length===r.length)),!(r.length<2)&&o(r))for(const i of s)i.door||(i.door=!0,i.doorType=0,Bs(e,i.roomLeft.group,i.roomRight.group))}}function Bs(e,t,o){if(t!==o)for(const n of e)n.group===t&&(n.group=o)}function Gs(e){let t=0;for(const o of e)o.roomLeft.roomType===0!=(o.roomRight.roomType===0)&&(t+=o.length);return t}function Us(e){let t=1/0,o=-1/0;for(const s of e)s.roomLeft.roomType===0!=(s.roomRight.roomType===0)&&(t=Math.min(t,s.origin[0]),o=Math.max(o,s.origin[0]+s.dir[0]*(s.length+1)));const n=(t+o)/2;let r;for(const s of e)s.dir[0]!==0&&(s.length<3||s.roomLeft.roomType!==0&&s.roomRight.roomType===0&&(s.origin[0]>n||s.origin[0]+s.dir[0]*s.length<=n||r!==void 0&&s.origin[1]>r.origin[1]||(r=s)));return r}function Es(e){let t=1/0,o=-1/0;for(const i of e)i.roomLeft.roomType===0!=(i.roomRight.roomType===0)&&(t=Math.min(t,i.origin[0]),o=Math.max(o,i.origin[0]+i.dir[0]*(i.length+1)));const n=(t+o)/2;let r,s=1/0;for(const i of e){if(i.dir[0]===0||i.length<3||i.roomLeft.roomType!==0||i.roomRight.roomType===0)continue;const c=Math.max(0,Math.max(n-(i.origin[0]+i.dir[0]*i.length),i.origin[0]-n));(c<s||r!==void 0&&c===s&&i.origin[1]>r.origin[1])&&(s=c,r=i)}return r}function Ns(e){let t=1/0,o=-1/0;for(const i of e)i.roomLeft.roomType===0!=(i.roomRight.roomType===0)&&(t=Math.min(t,i.origin[1]),o=Math.max(o,i.origin[1]+i.dir[1]*(i.length+1)));const n=(t+o)/2;let r,s=1/0;for(const i of e){if(i.dir[1]===0||i.length<3||i.roomLeft.roomType!==0||i.roomRight.roomType===0)continue;const c=Math.max(0,Math.max(n-(i.origin[1]+i.dir[1]*(i.length+1)),i.origin[1]-n));(c<s||r!==void 0&&c===s&&(i.origin[0]<r.origin[0]||i.origin[0]===r.origin[0]&&i.origin[1]<r.origin[1]))&&(s=c,r=i)}return r}function Fs(e){let t=1/0,o=-1/0;for(const i of e)i.roomLeft.roomType===0!=(i.roomRight.roomType===0)&&(t=Math.min(t,i.origin[1]),o=Math.max(o,i.origin[1]+i.dir[1]*(i.length+1)));const n=(t+o)/2;let r,s=1/0;for(const i of e){if(i.dir[1]===0||i.length<3||i.roomLeft.roomType===0||i.roomRight.roomType!==0)continue;const c=Math.max(0,Math.max(n-(i.origin[1]+i.dir[1]*(i.length+1)),i.origin[1]-n));(c<s||r!==void 0&&c===s&&(i.origin[0]>r.origin[0]||i.origin[0]===r.origin[0]&&i.origin[1]<r.origin[1]))&&(s=c,r=i)}return r}function gn(e){return e.edges.reduce((t,o)=>t+(o.door?1:0),0)}function Os(e,t){for(const o of e){if(o.door||o.length<2)continue;const n=o.roomLeft,r=o.roomRight;if(n.roomType===0||n.roomType===5||r.roomType===0||r.roomType===5||gn(n)>1&&gn(r)>1||t.random()>=.4)continue;const s=Math.abs(n.depth-r.depth);o.door=!0,ye(n.roomType)&&ye(r.roomType)||s<2?o.doorType=0:o.doorType=3}}function Hs(e,t,o){ke(e,t,n=>n.roomLeft.roomType===0&&n.roomRight.roomType===0),ke(e,t,n=>n.roomLeft.roomType===1&&n.roomRight.roomType===1),ke(e,t,n=>n.roomLeft.roomType===2&&n.roomRight.roomType===2&&o.random()<.8),ke(e,t,n=>zs(n)&&(yn(n.roomLeft)||yn(n.roomRight))&&o.random()<.5),ke(e,t,n=>n.roomLeft.group!==n.roomRight.group)}function zs(e){return e.roomLeft.roomType===2!=(e.roomRight.roomType===2)}function yn(e){return!(e.roomType!==2||Xs(e,0))}function Xs(e,t){return e.edges.some(o=>o.door&&(o.roomLeft===e?o.roomRight.roomType:o.roomLeft.roomType)===t)}function Io(e){let t=e.length;const o=[];for(const n of e)n.roomType===0?n.depth=0:Ys(n)?(n.depth=1,o.push(n)):n.depth=t;for(let n=0;n<o.length;++n){const r=o[n],s=r.depth+1;for(const i of r.edges){if(!i.door)continue;const c=i.roomLeft==r?i.roomRight:i.roomLeft;c.depth>s&&(c.depth=s,o.push(c))}}}function Xn(e){for(const t of e)t.betweenness=0;for(const t of e){const o=new Map,n=new Map,r=new Map;for(const l of e)r.set(l,1/0),n.set(l,0),o.set(l,0);r.set(t,0),o.set(t,1);const s=[];s.push(t);const i=[];for(;;){const l=s.shift();if(l===void 0)break;i.push(l);const f=(r.get(l)??0)+1;for(const d of l.edges){if(!d.door)continue;const a=d.roomLeft===l?d.roomRight:d.roomLeft;a.roomType!==0&&(a.depth===1/0&&(a.depth=f,s.push(a)),a.depth===f&&o.set(a,(o.get(a)??0)+(o.get(l)??0)))}}const c=t.roomType===0?10:1;for(;;){const l=i.pop();if(l===void 0)break;const f=(r.get(l)??0)-1,d=o.get(l)??1,a=n.get(l)??0;for(const u of l.edges){if(!u.door)continue;const h=u.roomLeft===l?u.roomRight:u.roomLeft;if(r.get(h)!==f)continue;const y=(o.get(h)??0)/d*(1+a);n.set(h,y),l!==t&&(l.betweenness+=a*c)}}}}function Yn(e){const t=new Map;for(const s of e){t.set(s,new Map);for(const i of e)t.get(s).set(i,1/0)}for(const s of e){t.get(s).set(s,0);for(const i of s.edges){if(!i.door)continue;const c=i.roomLeft===s?i.roomRight:i.roomLeft;t.get(s).set(c,1)}}for(const s of e)for(const i of e)for(const c of e){const l=t.get(i).get(c),f=t.get(i).get(s),d=t.get(s).get(c);l>f+d&&t.get(i).set(c,f+d)}const o=new Set;let n=e[0],r=0;for(;o.size<e.length;){o.add(n);let s=n,i=1/0;for(const c of e)if(c!==n&&!o.has(c)){const l=t.get(n).get(c);l<i&&(s=c,i=l)}if(i===1/0)break;n=s,r+=i}return r/(e.length-1)}function Ys(e){for(const t of e.edges)if(t.door&&t.doorType!==3){if(t.roomLeft===e){if(t.roomRight.roomType===0)return!0}else if(t.roomLeft.roomType===0)return!0}return!1}function jn(e,t,o,n){const r=[];for(const s of e){if(s.roomType===0||t>=8&&s.depth<3||o===E.Fortress&&ye(s.roomType))continue;let i=0;for(const c of s.edges)c.door&&++i;i<=1&&r.push(s)}if(r.length>0){n.shuffleArray(r),r.sort((i,c)=>xn(i)-xn(c));const s=r[0];s.roomType=5;for(const i of s.edges)i.door&&(i.doorType=3)}}function qn(e,t,o,n){let r=0;for(const d of e)r=Math.max(r,d.depth);const s=e.length-1,i=Math.floor(s/4);let c=0,l=r;for(;l>0;){for(const d of e)d.roomType!=2&&d.roomType!=1||d.depth==l&&(d.roomType=d.roomType==2?4:3,d.privateRoom=!0,d.roomType==4&&(c+=1));if(c>=i)break;l-=1}for(;;){let d=!1;for(const a of e)if(a.roomType==3){for(const u of a.edges)if((u.roomLeft!=a?u.roomLeft:u.roomRight).roomType==1){a.roomType=1,a.privateRoom=!0,d=!0;break}}if(!d)break}t>4&&o!==E.Fortress&&jn(e,t,o,n);for(const d of e){if(d.roomType!==4)continue;const a=d.posMax[0]-d.posMin[0],u=d.posMax[1]-d.posMin[1];if(a<3&&u<3||a*u>25)continue;let h=0;for(const p of d.edges)p.door&&++h;h>2||(d.roomType=6)}if(o===E.Fortress)for(const d of nt(e,$s,1,n))d.roomType=15;if(s>=8)for(const d of nt(e,js,1,n))d.roomType=10;for(const d of nt(e,Ks,Math.ceil(e.length/21),n))d.roomType=7;for(const d of nt(e,Qs,Math.ceil(e.length/42),n))d.roomType=8;for(const d of nt(e,Zs,Math.ceil(e.length/42),n))d.roomType=9;let f=0;for(const d of e)(d.roomType===8||d.roomType===9)&&(f+=(d.posMax[0]-d.posMin[0])*(d.posMax[1]-d.posMin[1]));if(f>=30||t===9){const d=f>=60,a=t===9?2:1;for(const u of nt(e,qs,a,n))ye(u.roomType)?u.roomType=d?14:12:u.roomType=d?13:11}}function xn(e){return(e.posMax[0]-e.posMin[0])*(e.posMax[1]-e.posMin[1])}function nt(e,t,o,n){const r=e.filter(t);return n.shuffleArray(r),r.slice(0,o)}function js(e){if(e.roomType!==2&&e.roomType!==4)return!1;const t=e.posMax[0]-e.posMin[0],o=e.posMax[1]-e.posMin[1];return!(Math.min(t,o)<3||Math.max(t,o)>7||$n(e))}function $n(e){for(const t of e.edges)if(t.door){if(t.roomLeft===e&&t.roomRight.roomType===0)return!0;if(t.roomRight===e&&t.roomLeft.roomType===0)return!0}return!1}function qs(e){if(e.depth<2||e.roomType!==2&&e.roomType!==4&&e.roomType!==1&&e.roomType!==3&&e.roomType!==6)return!1;const t=e.posMax[0]-e.posMin[0];if((t&1)===0||t<3||t>7)return!1;const o=e.posMax[1]-e.posMin[1];return!((o&1)===0||o<3||o>7)}function $s(e){if(e.roomType!==2&&e.roomType!==4||e.depth<2||$n(e))return!1;const t=e.posMax[0]-e.posMin[0];if(t<3)return!1;const o=e.posMax[1]-e.posMin[1];if(o<3||t<4&&o<5||t<5&&o<4)return!1;if(t<o){if(we(e,0,-1)>0&&we(e,0,1)>0)return!1}else if(o<t){if(we(e,-1,0)>0&&we(e,1,0)>0)return!1}else if(we(e,0,-1)>0&&we(e,0,1)>0&&we(e,-1,0)>0&&we(e,1,0)>0)return!1;return!0}function Ks(e){return!(e.roomType!==2&&e.roomType!==4||e.posMax[0]-e.posMin[0]<5||e.posMax[1]-e.posMin[1]<5)}function Qs(e){if(e.roomType!==2)return!1;const t=e.posMax[0]-e.posMin[0],o=e.posMax[1]-e.posMin[1];return!(Math.min(t,o)<4||Math.max(t,o)<5)}function Zs(e){if(e.roomType!==4)return!1;const t=e.posMax[0]-e.posMin[0],o=e.posMax[1]-e.posMin[1];return!(Math.min(t,o)<4||Math.max(t,o)<5)}function Js(e,t,o){const n=[];for(const r of e){const s=r.roomLeft,i=r.roomRight;if(!r.door||s.roomType!==i.roomType||s===t||i===t)continue;if(r.dir[1]===0){if(r.length!==1+(s.posMax[0]-s.posMin[0])||r.length!==1+(i.posMax[0]-i.posMin[0]))continue}else if(r.length!==1+(s.posMax[1]-s.posMin[1])||r.length!==1+(i.posMax[1]-i.posMin[1]))continue;const c=Math.min(s.posMin[0],i.posMin[0]),l=Math.min(s.posMin[1],i.posMin[1]),f=Math.max(s.posMax[0],i.posMax[0]),d=Math.max(s.posMax[1],i.posMax[1]),a=f-c,u=d-l;if(a*u>no*ro*30)continue;const p=Math.max(a,u)/Math.min(a,u);s.roomType!==0&&p>2||n.push([r,p])}if(!(n.length<=0))return o.shuffleArray(n),n.sort((r,s)=>r[1]-s[1]),n[0][0]}function ei(e,t,o){const n=[];for(const r of e){const s=r.roomLeft,i=r.roomRight;if(s.roomType!==i.roomType||s===t||i===t)continue;if(r.dir[1]===0){if(r.length!==1+(s.posMax[0]-s.posMin[0])||r.length!==1+(i.posMax[0]-i.posMin[0]))continue}else if(r.length!==1+(s.posMax[1]-s.posMin[1])||r.length!==1+(i.posMax[1]-i.posMin[1]))continue;const c=Math.min(s.posMin[0],i.posMin[0]),l=Math.min(s.posMin[1],i.posMin[1]),f=Math.max(s.posMax[0],i.posMax[0]),d=Math.max(s.posMax[1],i.posMax[1]),a=f-c,u=d-l;if(a*u>no*ro*30)continue;const p=Math.max(a,u)/Math.min(a,u);s.roomType!==0&&s.roomType!==1&&p>(Math.min(a,u)>2?2:3)||n.push([r,p])}if(!(n.length<=0))return o.shuffleArray(n),n.sort((r,s)=>r[1]-s[1]),n[0][0]}function Kn(e,t,o){const n=o.roomLeft,r=o.roomRight;for(const c of r.edges)c!==o&&(n.edges.push(c),c.roomLeft===r?c.roomLeft=n:(console.assert(c.roomRight===r),c.roomRight=n));const s=m.fromValues(Math.min(n.posMin[0],r.posMin[0]),Math.min(n.posMin[1],r.posMin[1])),i=m.fromValues(Math.max(n.posMax[0],r.posMax[0]),Math.max(n.posMax[1],r.posMax[1]));for(m.copy(n.posMin,s),m.copy(n.posMax,i),n.depth=Math.min(n.depth,r.depth),vt(o),qe(t,o),qe(n.edges,o),qe(e,r);ti(t,n););}function ti(e,t){for(const o of t.edges)for(const n of t.edges){if(o===n||!oi(o,n))continue;const r=o.dir[0]>=0?Math.min(o.origin[0],n.origin[0]):Math.max(o.origin[0],n.origin[0]),s=o.dir[1]>=0?Math.min(o.origin[1],n.origin[1]):Math.max(o.origin[1],n.origin[1]),i=o.length+n.length;o.origin[0]=r,o.origin[1]=s,o.length=i,vt(o),vt(n),o.door=o.door||n.door,o.doorType=Math.max(o.doorType,n.doorType);const c=o.roomLeft===t?o.roomRight:o.roomLeft;return qe(t.edges,n),qe(c.edges,n),qe(e,n),!0}return!1}function oi(e,t){if(Math.abs(e.dir.dot(t.dir))!==1)return!1;const o=m.create();m.scaleAndAdd(o,e.origin,e.dir,e.length);const n=m.create();if(m.scaleAndAdd(n,t.origin,t.dir,t.length),t.roomLeft===e.roomLeft&&t.roomRight===e.roomRight){if(o.equals(t.origin))return!0;if(n.equals(e.origin))return!0}else if(t.roomLeft===e.roomRight&&t.roomRight===e.roomLeft){if(o.equals(n))return!0;if(e.origin.equals(t.origin))return!0}return!1}function qe(e,t){const o=e.indexOf(t);e.splice(o,1)}function ni(e,t,o){o.shuffleArray(t);for(let n=t.length;n>0;--n){const r=ei(t,e[0],o);if(r===void 0)break;Kn(e,t,r)}}function ri(e,t,o){o.shuffleArray(t);for(let n=2*Math.floor(e.length/12);n>0;--n){const r=Js(t,e[0],o);if(r===void 0)break;Kn(e,t,r)}}function Qn(e,t){const o=new Set;for(const f of e)f.roomType!==0&&f.roomType!==5&&o.add(f);const n=new Set,r=[];function s(f){r.push(f),n.add(f);const d=[...f.edges];t.shuffleArray(d);for(const a of d){if(!a.door)continue;const u=a.roomLeft===f?a.roomRight:a.roomLeft;n.has(u)||o.has(u)&&(s(u),r.push(f))}}const i=Array.from(o),c=i[t.randomInRange(i.length)];return s(c),--r.length,si(r)}function Zn(e,t,o){const n=Qn(t,o),r=er(n,e,o);return console.assert(r.length===1),r}function si(e){const t=[];for(const o of e)t.push({room:o,nodeNext:null,nodePrev:null,visited:!1});for(let o=0;o<e.length;++o)t[o].nodeNext=t[(o+1)%t.length],t[o].nodePrev=t[(o+t.length-1)%t.length];return t}function vn(e){for(const t of e)if(t.nodeNext!==null&&t.nodePrev!==null&&t.nodeNext.room===t.nodePrev.room)return t}function Jn(e,t,o,n,r,s){const i=r.filter(a=>a.door&&ht(e,a.roomLeft)&&ht(e,a.roomRight));s.shuffleArray(i);let c=[];const l=new Map,f=26-2*t;for(const a of i){const u=a.roomLeft,h=a.roomRight;let p=l.get(u);p===void 0&&(p=[],l.set(u,p));let y=l.get(h);y===void 0&&(y=[],l.set(h,y));const g=vn(p),x=vn(y);if(g)if(x){if(!ii(g,x,f))continue;const w={room:u,nodeNext:null,nodePrev:null,visited:!1},S={room:h,nodeNext:null,nodePrev:null,visited:!1},T=g.nodeNext,I=x.nodeNext;g.nodeNext=S,S.nodePrev=g,S.nodeNext=I,I!==null&&(I.nodePrev=S),x.nodeNext=w,w.nodePrev=x,w.nodeNext=T,T!==null&&(T.nodePrev=w),p.push(w),y.push(S),c.push(w),c.push(S),bo(g,x)||(s.random()<.5?wn(g,c,l):wn(x,c,l))}else{if(Re(g)+2>f)continue;const S={room:u,nodeNext:null,nodePrev:null,visited:!1},T={room:h,nodeNext:null,nodePrev:null,visited:!1},I=g.nodeNext;g.nodeNext=T,T.nodePrev=g,T.nodeNext=S,S.nodePrev=T,S.nodeNext=I,I!==null&&(I.nodePrev=S),p.push(S),y.push(T),c.push(S),c.push(T)}else if(x){if(Re(x)+2>f)continue;const S={room:u,nodeNext:null,nodePrev:null,visited:!1},T={room:h,nodeNext:null,nodePrev:null,visited:!1},I=x.nodeNext;x.nodeNext=S,S.nodePrev=x,S.nodeNext=T,T.nodePrev=S,T.nodeNext=I,I!==null&&(I.nodePrev=T),p.push(S),y.push(T),c.push(S),c.push(T)}else{const w={room:u,nodeNext:null,nodePrev:null,visited:!1},S={room:h,nodeNext:null,nodePrev:null,visited:!1};w.nodeNext=S,w.nodePrev=S,S.nodeNext=w,S.nodePrev=w,p.push(w),y.push(S),c.push(w),c.push(S)}}for(const a of n){if(!ht(e,a))continue;{const T=l.get(a);if(T!==void 0&&T.length>0)continue}const u=a.edges.filter(T=>T.door&&ht(e,T.roomLeft)&&ht(e,T.roomRight));if(u.length===0)continue;const h=u[s.randomInRange(u.length)],p=h.roomLeft,y=h.roomRight;let g=l.get(p);g===void 0&&(g=[],l.set(p,g));let x=l.get(y);x===void 0&&(x=[],l.set(y,x));const w={room:p,nodeNext:null,nodePrev:null,visited:!1},S={room:y,nodeNext:null,nodePrev:null,visited:!1};w.nodeNext=S,w.nodePrev=S,S.nodeNext=w,S.nodePrev=w,g.push(w),x.push(S),c.push(w),c.push(S)}for(const a of c)a.visited=!1;for(const a of c){if(a.visited)continue;if(Re(a)>2){vo(a);continue}let h=Number.MAX_SAFE_INTEGER;const p=[],y=a,g=a.nodeNext,x=y.room,w=g.room,S=l.get(x),T=l.get(w);for(const W of S){if(W===y)continue;const C=Re(W);C>h||(C<h&&(h=C,p.length=0),p.push([y,W]))}for(const W of T){if(W===g)continue;const C=Re(W);C>h||(C<h&&(h=C,p.length=0),p.push([g,W]))}if(p.length===0){vo(a);continue}const[I,D]=p[s.randomInRange(p.length)],R=I.nodePrev,A=D.nodePrev;R.nodeNext=D,D.nodePrev=R,A.nodeNext=I,I.nodePrev=A,vo(a)}for(const a of i){const u=a.roomLeft,h=a.roomRight;let p=l.get(u);p===void 0&&(p=[],l.set(u,p));let y=l.get(h);y===void 0&&(y=[],l.set(h,y));const g=Mn(p),x=Mn(y);if(g===void 0||x===void 0||bo(g,x))continue;const w=Re(g),S=Re(x);if(w>2&&S>2)continue;const T={room:u,nodeNext:null,nodePrev:null,visited:!1},I={room:h,nodeNext:null,nodePrev:null,visited:!1},D=g.nodeNext,R=x.nodePrev;g.nodeNext=x,x.nodePrev=g,R.nodeNext=I,I.nodePrev=R,I.nodeNext=T,T.nodePrev=I,T.nodeNext=D,D.nodePrev=T,p.push(T),y.push(I),c.push(T),c.push(I)}return t>=8&&(c=c.concat(Qn(n,s))),er(c,o,s)}function Mn(e){if(e===void 0)return;let t,o=Number.MAX_SAFE_INTEGER;for(const n of e){const r=Re(n);r<o&&(o=r,t=n)}return t}function ht(e,t){return!(t.roomType===5||t.roomType===0&&(e!==E.Warrens||t.gridX<0))}function ii(e,t,o){if(bo(e,t)){if(!ai(e,t)||Re(e)<=4)return!1}else{const n=Re(e),r=Re(t);if(n+r+2>o)return!1}return!0}function ai(e,t){let o=e.nodePrev,n=e.nodeNext;for(;;){if(o===n)return o===t;if(o===null||n===null||o===e||n===e||o.room!==n.room)return!1;o=o.nodePrev,n=n.nodeNext}}function wn(e,t,o){if(e.nodePrev!==null)for(e.nodePrev.nodeNext=null;;){const n=e.nodeNext;e.nodePrev=null,e.nodeNext=null,qe(t,e);const r=o.get(e.room);if(r!==void 0&&qe(r,e),n===null)break;e=n}}function li(e,t){const o=m.create();for(let n=t.length-1;n>0;--n){if(m.subtract(o,t[n],t[n-1]),o.equals(e))return!1;if(m.dot(o,e)<=0)return!0}return!1}function er(e,t,o){for(const r of e)r.visited=!1;const n=[];for(const r of e){if(r.visited)continue;if(r.nodeNext==null&&r.nodePrev==null){r.visited=!0;continue}const s=ci(r),i=[],c=new Set;for(let u=s;u!=null&&!u.visited;u=u.nodeNext){u.visited=!0;const h=u.nodeNext,p=u.nodePrev;if(h==null||p==null)continue;const y=u.room,g=h.room,x=p.room;c.add(y);const w=m.create();if(Jt(w,y,x,t),g===x){const I=fi(t,y),D=m.create();I.length>0?m.copy(D,I[o.randomInRange(I.length)]):tr(D,y,x,t);for(const W of Sn(t,y,w,D))i.push(W);i.push(m.clone(D));const A=t.tryGetPosLookAt(D,!1);if(A!==void 0){const W=m.create();m.subtract(W,A,D),li(W,i)&&i.push(m.clone(D))}i.push(m.clone(D)),i.push(m.clone(D)),m.copy(w,D)}const S=m.create();Jt(S,y,g,t);const T=Sn(t,y,w,S);for(const I of T)i.push(I)}const l=Co(i,o.randomInRange(i.length)),f=Array.from(c),d=f.reduce((u,h)=>Math.min(u,h.depth),1/0),a=f.reduce((u,h)=>Math.max(u,h.depth),0);n.push({path:l,minRoomDepth:d,maxRoomDepth:a})}return o.shuffleArray(n),n}function ui(e,t){const o=e.path.length;t.push({path:Co(e.path,Math.floor(o*.25)),minRoomDepth:e.minRoomDepth,maxRoomDepth:e.maxRoomDepth}),t.push({path:Co(e.path,Math.floor(o*.75)),minRoomDepth:e.minRoomDepth,maxRoomDepth:e.maxRoomDepth})}function Co(e,t){const o=[];for(let n=t;n<e.length;++n)o.push(e[n]);for(let n=0;n<t;++n)o.push(e[n]);return o}function ci(e){let t=e;for(;t.nodePrev!=null&&(t=t.nodePrev,t!=e););return t}function bo(e,t){let o=e;for(;;){if(o===t)return!0;if(o.nodeNext===null||(o=o.nodeNext,o===e))break}return!1}function Re(e){let t=0,o=e;for(;++t,!(o.nodeNext===null||(o=o.nodeNext,o===e)););return t}function vo(e){let t=e;for(;t.visited=!0,!(t.nodeNext===null||(t=t.nodeNext,t===e)););}function Jt(e,t,o,n){for(const r of t.edges)if(!((r.roomLeft!==t||r.roomRight!==o)&&(r.roomLeft!==o||r.roomRight!==t))){for(let s=1;s<r.length;++s){m.scaleAndAdd(e,r.origin,r.dir,s);const i=n.cells.atVec(e).type;if(i>=L.PortcullisNS&&i<=L.GardenDoorEW)return}for(let s=1;s<r.length;++s)if(m.scaleAndAdd(e,r.origin,r.dir,s),n.cells.atVec(e).type<=L.GroundTreasure)return;m.scaleAndAdd(e,r.origin,r.dir,Math.floor(r.length/2));return}m.zero(e)}function tr(e,t,o,n){for(const r of t.edges)if(r.roomLeft===t&&r.roomRight===o){const s=m.create();Jt(s,t,o,n);const i=m.fromValues(-r.dir[1],r.dir[0]);m.scaleAndAdd(e,s,i,2),n.cells.at(e[0],e[1]).moveCost!=0&&m.scaleAndAdd(e,s,i,1);return}else if(r.roomLeft===o&&r.roomRight===t){const s=m.create();Jt(s,t,o,n);const i=m.fromValues(r.dir[1],-r.dir[0]);m.scaleAndAdd(e,s,i,2),n.cells.at(e[0],e[1]).moveCost!=0&&m.scaleAndAdd(e,s,i,1);return}m.zero(e)}function or(e,t,o,n){let r;return t===E.Warrens?r=m.fromValues(Math.floor(n.cells.sizeX/2),1):(r=nr(o,n),e===0&&(r[0]-=Math.max(0,4-r[1]),r[1]=Math.max(0,r[1]-4))),r}function nr(e,t){let o;for(const i of e)i.door&&i.dir[0]!==0&&i.roomLeft.roomType!==0&&i.roomRight.roomType===0&&(o!==void 0&&i.origin[1]>o.origin[1]||(o=i));if(o===void 0)return m.fromValues(0,0);let n,r;o.roomLeft.roomType===0?(n=o.roomRight,r=o.roomLeft):(n=o.roomLeft,r=o.roomRight);const s=m.create();return tr(s,r,n,t),s}function fi(e,t){const o=[];for(let n=t.posMin[0];n<t.posMax[0];++n)t.posMin[1]>0&&e.cells.at(n,t.posMin[1]-1).type==L.OneWayWindowS&&e.cells.at(n,t.posMin[1]).moveCost===0&&o.push(m.fromValues(n,t.posMin[1])),t.posMax[1]<e.cells.sizeY&&e.cells.at(n,t.posMax[1]).type==L.OneWayWindowN&&e.cells.at(n,t.posMax[1]-1).moveCost===0&&o.push(m.fromValues(n,t.posMax[1]-1));for(let n=t.posMin[1];n<t.posMax[1];++n)t.posMin[0]>0&&e.cells.at(t.posMin[0]-1,n).type==L.OneWayWindowW&&e.cells.at(t.posMin[0],n).moveCost===0&&o.push(m.fromValues(t.posMin[0],n)),t.posMax[0]<e.cells.sizeX&&e.cells.at(t.posMax[0],n).type==L.OneWayWindowE&&e.cells.at(t.posMax[0]-1,n).moveCost===0&&o.push(m.fromValues(t.posMax[0]-1,n));if(o.length>0)return o;for(const n of e.items)n.type==M.Chair&&n.pos[0]>=t.posMin[0]&&n.pos[1]>=t.posMin[1]&&n.pos[0]<t.posMax[0]&&n.pos[1]<t.posMax[1]&&o.push(m.clone(n.pos));return o}function Sn(e,t,o,n){const r=Math.max(0,t.posMin[0]-1),s=Math.max(0,t.posMin[1]-1),i=Math.min(e.cells.sizeX,t.posMax[0]+1),c=Math.min(e.cells.sizeY,t.posMax[1]+1),l=e.computeDistancesToPositionSubrect(n,r,s,i,c),f=m.clone(o),d=[];for(;!f.equals(n);){d.push(m.clone(f));const a=hi(e,t,l,f);if(a.equals(f))break;m.copy(f,a)}return d}function hi(e,t,o,n){let r=1/0,s=m.clone(n);const i=Math.max(0,t.posMin[0]-1),c=Math.max(0,t.posMin[1]-1),l=Math.min(e.cells.sizeX,t.posMax[0]+1),f=Math.min(e.cells.sizeY,t.posMax[1]+1),d=m.fromValues(Math.max(i,n[0]-1),Math.max(c,n[1]-1)),a=m.fromValues(Math.min(l,n[0]+2),Math.min(f,n[1]+2));for(let u=d[0];u<a[0];++u)for(let h=d[1];h<a[1];++h){const p=o.get(u-i,h-c);if(p==1/0)continue;let y=m.fromValues(u,h);e.guardMoveCost(n,y)!=1/0&&p<r&&(r=p,s=y)}if(s.equals(n)){console.log("failed to proceed");for(let u=d[0];u<a[0];++u)for(let h=d[1];h<a[1];++h){const p=o.get(u-i,h-c);console.log(u,h,p)}}return s}const di=[L.OneWayWindowS,L.OneWayWindowE,L.OneWayWindowN,L.OneWayWindowW];function pi(e){return di[e[0]+2*Math.max(0,e[1])+1]}function rr(e,t,o){for(const r of t){const s=r.roomLeft.roomType,i=r.roomRight.roomType;if(!(ye(s)&&ye(i))&&!(s===0&&i===0))for(let c=0;c<r.length+1;++c){const l=m.create();m.scaleAndAdd(l,r.origin,r.dir,c),o.cells.atVec(l).type=L.Wall0000}}const n=new Set;for(const r of t){if(n.has(r))continue;const s=Zt(r);for(const i of s)n.add(i);for(const i of s){if(i.door)continue;const c=i.roomLeft.roomType,l=i.roomRight.roomType;if(c===5||l===5||c===0&&l===0)continue;const f=m.clone(i.dir);if(c===0!=(l===0))l==0&&m.negate(f,f);else if(ye(c)!==ye(l)){if(ye(l)){if(e===E.Fortress&&i.roomLeft.depth+1<i.roomRight.depth)continue;m.negate(f,f)}else if(e===E.Fortress&&i.roomRight.depth+1<i.roomLeft.depth)continue}else continue;const d=pi(f);if(e===E.Fortress&&(c===0||l===0)){if(i.length>2&&(i.length&1)===0){const a=m.clone(i.origin).scaleAndAdd(i.dir,i.length/2);o.cells.atVec(a).type=d}}else if(i.length===5){const a=m.clone(i.origin).scaleAndAdd(i.dir,2+(i.origin[0]+i.origin[1]&1));o.cells.atVec(a).type=d}else{const a=1+Math.floor(i.length/2)-(i.length&1);for(let u=2;u<a;u+=2){const h=m.clone(i.origin).scaleAndAdd(i.dir,u),p=m.clone(i.origin).scaleAndAdd(i.dir,i.length-u);o.cells.atVec(h).type=d,o.cells.atVec(p).type=d}}}for(const i of s){if(!i.door)continue;const c=Math.floor(i.length/2),l=m.clone(i.origin).scaleAndAdd(i.dir,c);let f=i.dir[0]==0,d=i.roomLeft.roomType,a=i.roomRight.roomType;d===0&&a===0||(i.doorType===1||i.doorType===2?(o.cells.atVec(l).type=f?L.PortcullisNS:L.PortcullisEW,B(o,l,f?M.PortcullisNS:M.PortcullisEW)):i.doorType===3?(o.cells.atVec(l).type=f?L.DoorNS:L.DoorEW,B(o,l,f?M.LockedDoorNS:M.LockedDoorEW)):ye(d)&&ye(a)?o.cells.atVec(l).type=f?L.GardenDoorNS:L.GardenDoorEW:ye(d)||ye(a)||!i.roomLeft.privateRoom||!i.roomRight.privateRoom||d===6!=(a===6)?(o.cells.atVec(l).type=f?L.DoorNS:L.DoorEW,B(o,l,f?M.DoorNS:M.DoorEW)):o.cells.atVec(l).type=f?L.DoorNS:L.DoorEW)}}}function sr(e,t,o,n,r){for(let s=1;s<o.length;++s){const i=o[s];let c;switch(i.roomType){case 0:c=t===E.Warrens?L.GroundNormal:L.GroundGrass;break;case 1:c=L.GroundGrass;break;case 2:c=L.GroundWood;break;case 3:c=L.GroundGrass;break;case 4:c=L.GroundMarble;break;case 5:c=L.GroundVault;break;case 6:c=L.GroundMarble;break;case 7:c=i.privateRoom?L.GroundMarble:L.GroundWood;break;case 8:c=L.GroundWood;break;case 9:c=L.GroundMarble;break;case 10:c=L.GroundWood;break;case 11:c=i.privateRoom?L.GroundMarble:L.GroundWood;break;case 12:c=L.GroundGrass;break;case 13:c=i.privateRoom?L.GroundMarble:L.GroundWood;break;case 14:c=L.GroundGrass;break;case 15:c=L.GroundWood;break}Ie(n,i.posMin[0],i.posMin[1],i.posMax[0],i.posMax[1],c),i.roomType===1||i.roomType===3?mi(n,i,e,r):i.roomType===2||i.roomType===4?gi(n,i,e,r):i.roomType===5?yi(n,i,r):i.roomType===6?xi(n,i,e,r):i.roomType===7?Ti(n,i,e,r):i.roomType===10?Mi(n,i,e,r):i.roomType===11?Tn(n,i,e,r):i.roomType===12?_n(n,i,e,r):i.roomType===13?Tn(n,i,e,r):i.roomType===14?_n(n,i,e,r):i.roomType===8||i.roomType===9?Li(n,i,e,r):i.roomType===15&&_i(n,i),c==L.GroundWood&&e>3&&Ri(n,i,r)}}function mi(e,t,o,n){const r=t.posMax[0]-t.posMin[0],s=t.posMax[1]-t.posMin[1];if(r>=5&&s>=5)Ie(e,t.posMin[0]+1,t.posMin[1]+1,t.posMax[0]-1,t.posMax[1]-1,L.GroundWater);else if(r>=2&&s>=2){const i=[M.Bush,M.Bush,M.Bush,M.Bush];r>2&&s>2&&i.push(J(o,n)),n.shuffleArray(i);const c=[m.fromValues(t.posMin[0],t.posMin[1]),m.fromValues(t.posMax[0]-1,t.posMin[1]),m.fromValues(t.posMin[0],t.posMax[1]-1),m.fromValues(t.posMax[0]-1,t.posMax[1]-1)];for(let l=0;l<c.length;++l){const f=c[l];e.cells.atVec(f).type===L.GroundGrass&&$(e,f,i[l])}}}function Dt(e,t){return t.random()<.25?M.Table:J(e,t)}function gi(e,t,o,n){const r=t.posMax[0]-t.posMin[0],s=t.posMax[1]-t.posMin[1];if(r>=5&&s>=5){if(t.roomType===4)r>s?r>7&&Ie(e,t.posMin[0]+3,t.posMin[1]+1,t.posMax[0]-3,t.posMax[1]-1,L.GroundWater):s>r?s>7&&Ie(e,t.posMin[0]+1,t.posMin[1]+3,t.posMax[0]-1,t.posMax[1]-3,L.GroundWater):r>=7?(Ie(e,t.posMin[0]+3,t.posMin[1]+1,t.posMax[0]-3,t.posMax[1]-1,L.GroundWater),Ie(e,t.posMin[0]+1,t.posMin[1]+3,t.posMax[0]-1,t.posMax[1]-3,L.GroundWater)):Ie(e,t.posMin[0]+1,t.posMin[1]+1,t.posMax[0]-1,t.posMax[1]-1,L.GroundWater);else if(r>s)for(let i=t.posMin[0]+3;i<t.posMax[0]-3;++i)B(e,m.fromValues(i,t.posMin[1]+1),M.Chair),B(e,m.fromValues(i,t.posMax[1]-2),M.Chair);else if(s>r)for(let i=t.posMin[1]+3;i<t.posMax[1]-3;++i)B(e,m.fromValues(t.posMin[0]+1,i),M.Chair),B(e,m.fromValues(t.posMax[0]-2,i),M.Chair);else r===5&&s===5&&(B(e,m.fromValues(t.posMin[0]+1,t.posMin[1]+1),M.Table),B(e,m.fromValues(t.posMin[0]+2,t.posMin[1]+1),M.Chair),B(e,m.fromValues(t.posMin[0]+1,t.posMin[1]+2),M.Chair),B(e,m.fromValues(t.posMax[0]-2,t.posMax[1]-2),J(o,n)));if(r>5||s>5){if(e.cells.at(t.posMin[0]+1,t.posMin[1]+1).type=L.Wall0000,e.cells.at(t.posMax[0]-2,t.posMin[1]+1).type=L.Wall0000,e.cells.at(t.posMin[0]+1,t.posMax[1]-2).type=L.Wall0000,e.cells.at(t.posMax[0]-2,t.posMax[1]-2).type=L.Wall0000,r>s){const i=Math.floor(s/2);B(e,m.fromValues(t.posMin[0]+1,t.posMin[1]+i),Dt(o,n)),B(e,m.fromValues(t.posMax[0]-2,t.posMax[1]-(i+1)),Dt(o,n))}else if(s>r){const i=Math.floor(r/2);B(e,m.fromValues(t.posMin[0]+i,t.posMin[1]+1),Dt(o,n)),B(e,m.fromValues(t.posMax[0]-(i+1),t.posMax[1]-2),Dt(o,n))}}}else if(r==5&&s>=3&&(t.roomType==2||n.random()<.33333)){const i=new Array(s-2).fill(M.Table);i.push(J(o,n)),n.shuffleArray(i);for(let c=1;c<s-1;++c)B(e,m.fromValues(t.posMin[0]+1,t.posMin[1]+c),M.Chair),B(e,m.fromValues(t.posMin[0]+2,t.posMin[1]+c),i[c-1]),B(e,m.fromValues(t.posMin[0]+3,t.posMin[1]+c),M.Chair)}else if(s==5&&r>=3&&(t.roomType==2||n.random()<.33333)){const i=new Array(r-2).fill(M.Table);i.push(J(o,n)),n.shuffleArray(i);for(let c=1;c<r-1;++c)B(e,m.fromValues(t.posMin[0]+c,t.posMin[1]+1),M.Chair),B(e,m.fromValues(t.posMin[0]+c,t.posMin[1]+2),i[c-1]),B(e,m.fromValues(t.posMin[0]+c,t.posMin[1]+3),M.Chair)}else if(r>s&&(s&1)==1&&n.random()<.66667){let i=Math.floor(t.posMin[1]+s/2);const c=t.roomType==2?M.Table:M.Chair,f=[J(o,n),c];n.shuffleArray(f),$(e,m.fromValues(t.posMin[0]+1,i),f[0]),$(e,m.fromValues(t.posMax[0]-2,i),f[1])}else if(s>r&&(r&1)==1&&n.random()<.66667){let i=Math.floor(t.posMin[0]+r/2);const c=t.roomType==2?M.Table:M.Chair,f=[J(o,n),c];n.shuffleArray(f),$(e,m.fromValues(i,t.posMin[1]+1),f[0]),$(e,m.fromValues(i,t.posMax[1]-2),f[1])}else if(r>=5&&s===3){let i=Math.floor(t.posMin[1]+s/2);$(e,m.fromValues(t.posMin[0]+1,i),J(o,n)),$(e,m.fromValues(t.posMax[0]-2,i),J(o,n))}else if(s>=5&&r===3){let i=Math.floor(t.posMin[0]+r/2);$(e,m.fromValues(i,t.posMin[1]+1),J(o,n)),$(e,m.fromValues(i,t.posMax[1]-2),J(o,n))}else if(r>=3&&s>=3){const i=t.roomType==2?M.Table:M.Chair,l=[J(o,n),i,i,i];n.shuffleArray(l),$(e,m.fromValues(t.posMin[0],t.posMin[1]),l[0]),$(e,m.fromValues(t.posMax[0]-1,t.posMin[1]),l[1]),$(e,m.fromValues(t.posMin[0],t.posMax[1]-1),l[2]),$(e,m.fromValues(t.posMax[0]-1,t.posMax[1]-1),l[3])}}function yi(e,t,o){const n=t.posMax[0]-t.posMin[0],r=t.posMax[1]-t.posMin[1],s=new he(n,r,!0),i=new he(n,r,!1),c=new he(n,r,!1),l=m.create(),f=m.create();for(const y of t.edges)for(let g=0;g<y.length;++g)if(m.scaleAndAdd(l,y.origin,y.dir,g),!(e.cells.atVec(l).type<L.PortcullisNS)){m.set(f,-y.dir[1],y.dir[0]);for(let x=-2;x<3;++x)m.scaleAndAdd(l,y.origin,y.dir,g),m.scaleAndAdd(l,l,f,x),l[0]>=t.posMin[0]&&l[1]>=t.posMin[1]&&l[0]<t.posMax[0]&&l[1]<t.posMax[1]&&i.set(l[0]-t.posMin[0],l[1]-t.posMin[1],!0)}if(n>=5&&r>=5){const y=[m.fromValues(t.posMin[0]+1,t.posMin[1]+1),m.fromValues(t.posMax[0]-2,t.posMin[1]+1),m.fromValues(t.posMin[0]+1,t.posMax[1]-2),m.fromValues(t.posMax[0]-2,t.posMax[1]-2)];if(!y.some(g=>i.get(g[0]-t.posMin[0],g[1]-t.posMin[1])))for(const g of y)e.cells.atVec(g).type=L.Wall0000}let d=!1,a=0,u=0;for(let y=0;y<n;++y)for(let g=0;g<r;++g){if(!ur(e.cells.at(y+t.posMin[0],g+t.posMin[1]).type)){c.set(y,g,!0),i.set(y,g,!0);continue}Je(e.cells,m.fromValues(y+t.posMin[0],g+t.posMin[1]))&&(d=!0,a=y,u=g)}if(!d)return;const h=[M.VaultTreasureBox,M.VaultTreasureBox,M.DrawersTall,M.DrawersShort,M.Chair,M.Table,M.Bookshelf,M.Shelf,M.TorchUnlit];o.shuffleArray(h);const p=[];for(let y=0;;y=(y+1)%h.length){for(let T=0;T<s.values.length;++T)s.values[T]=i.values[T]?0:1;ar(s,c,a,u),ir(s,c,p,t);const g=lr(s);if(g.length===0)break;const x=g[o.randomInRange(g.length)];console.assert(s.get(x[0],x[1])),console.assert(!c.get(x[0],x[1]));const w=h[y],S={pos:m.fromValues(x[0]+t.posMin[0],x[1]+t.posMin[1]),type:w,topLayer:je[w]};e.items.push(S),p.push(S),c.set(x[0],x[1],!0),i.set(x[0],x[1],!0),w===M.VaultTreasureBox&&(h.splice(y,1),--y)}}function xi(e,t,o,n){const r=t.posMax[0]-t.posMin[0],s=t.posMax[1]-t.posMin[1],i=new he(r,s,!0),c=new he(r,s,!1),l=new he(r,s,!1),f=new he(r,s,!1);let d,a;const u=m.create();for(let g=0;g<r;++g)for(let x=0;x<s;++x)u.set(g+t.posMin[0],x+t.posMin[1]),ur(e.cells.atVec(u).type)?Je(e.cells,u)&&(c.set(g,x,!0),l.set(g,x,!0),d=g,a=x):(f.set(g,x,!0),c.set(g,x,!0),l.set(g,x,!0)),(Oo(e.cells,u)||!jt(e,u))&&l.set(g,x,!0);if(d===void 0||a===void 0)return;const h=[];for(let g=t.posMin[0];g<t.posMax[0]-1;++g)for(let x=t.posMin[1];x<t.posMax[1];++x){const w=m.fromValues(g,x),S=m.fromValues(g+1,x);!Po(e.cells,w)&&!Po(e.cells,S)||Ln(e,w)||Ln(e,S)||Je(e.cells,w)||Je(e.cells,S)||r===2&&x!==t.posMin[1]&&x!==t.posMax[1]-1||h.push(w)}const p=[];if(h.length>0){const g=h[n.randomInRange(h.length)],x=m.fromValues(g[0]+1,g[1]),w={pos:m.clone(g),type:M.BedL,topLayer:je[M.BedL]},S={pos:m.clone(x),type:M.BedR,topLayer:je[M.BedR]};e.items.push(w),e.items.push(S),p.push(w);const T=g[0]-t.posMin[0],I=g[1]-t.posMin[1];f.set(T,I,!0),f.set(T+1,I,!0),c.set(T,I,!0),c.set(T+1,I,!0),l.set(T,I,!0),l.set(T+1,I,!0)}const y=[M.DrawersTall,M.DrawersShort,M.Chair,M.Chair,M.Table,M.Bookshelf,J(o,n)];n.shuffleArray(y);for(const g of y){const x=vi(g)?l:c;for(let I=0;I<i.values.length;++I)i.values[I]=x.values[I]?0:1;ar(i,f,d,a),ir(i,f,p,t);const w=lr(i);if(w.length===0)break;const S=w[n.randomInRange(w.length)];console.assert(i.get(S[0],S[1])),console.assert(!f.get(S[0],S[1]));const T={pos:m.fromValues(S[0]+t.posMin[0],S[1]+t.posMin[1]),type:g,topLayer:je[g]};e.items.push(T),p.push(T),f.set(S[0],S[1],!0),c.set(S[0],S[1],!0),l.set(S[0],S[1],!0)}}function vi(e){switch(e){case M.Bookshelf:case M.DrawersShort:case M.VaultTreasureBox:case M.EmptyVaultTreasureBox:case M.LootedVaultTreasureBox:case M.DrawersTall:case M.Shelf:case M.TorchUnlit:case M.TorchLit:case M.Stove:return!0;default:return!1}}function ir(e,t,o,n){const r=e.sizeX,s=e.sizeY;for(const i of o){const c=i.pos[0]-n.posMin[0],l=i.pos[1]-n.posMin[1],f=[];for(const[d,a]of[[1,0],[0,1],[-1,0],[0,-1]]){const u=c+d,h=l+a;u<0||h<0||u>=r||h>=s||t.get(u,h)||f.push([u,h])}if(i.type===M.BedL)for(const[d,a]of[[1,0],[0,1],[0,-1]]){const u=c+d+1,h=l+a;u<0||h<0||u>=r||h>=s||t.get(u,h)||f.push([u,h])}if(f.length===1){const[d,a]=f[0];e.set(d,a,!1)}}}function ar(e,t,o,n){const r=t.sizeX,s=t.sizeY;console.assert(e.sizeX===r),console.assert(e.sizeY===s),console.assert(o>=0),console.assert(n>=0),console.assert(o<r),console.assert(n<s),console.assert(!t.get(o,n));const i=new he(r,s,!1),c=new Ue(r,s,0),l=new Ue(r,s,0);function f(d,a,u,h,p){i.set(d,a,!0),c.set(d,a,u),l.set(d,a,u);let y=0,g=!1;for(const[w,S]of[[1,0],[0,1],[-1,0],[0,-1]]){const T=d+w,I=a+S;T<0||T>=r||I<0||I>=s||t.get(T,I)||(i.get(T,I)?(T!==h||I!==p)&&l.set(d,a,Math.min(l.get(d,a),c.get(T,I))):(f(T,I,u+1,d,a),++y,l.get(T,I)>=u&&(g=!0),l.set(d,a,Math.min(l.get(d,a),l.get(T,I)))))}h>=0?g&&e.set(d,a,!1):y>1&&e.set(d,a,!1)}f(o,n,0,-1,-1)}function Mi(e,t,o,n){const r=t.posMax[0]-t.posMin[0],s=t.posMax[1]-t.posMin[1];let i=[];const c=r>s||r===s&&Si(t)<=wi(t);if(c){for(let u=0;u<r;++u)i.push(m.fromValues(u+t.posMin[0],t.posMin[1])),i.push(m.fromValues(u+t.posMin[0],t.posMax[1]-1));const a=(t.posMin[0]+t.posMax[0])/2;i.sort((u,h)=>Math.abs(u[0]-a)-Math.abs(h[0]-a))}else{for(let u=0;u<s;++u)i.push(m.fromValues(t.posMin[0],u+t.posMin[1])),i.push(m.fromValues(t.posMax[0]-1,u+t.posMin[1]));const a=(t.posMin[1]+t.posMax[1])/2;i.sort((u,h)=>Math.abs(u[1]-a)-Math.abs(h[1]-a))}i=i.filter(a=>!Je(e.cells,a)&&Po(e.cells,a));let l=Mo(r*s/10,n),f=Mo(i.length/3,n),d=Mo(i.length/2,n);for(const a of i)Oo(e.cells,a)?d>0&&(B(e,a,M.Table),--d):l>0?(B(e,a,M.Stove),--l):d>0?(B(e,a,M.Table),--d):f>0&&(B(e,a,M.Shelf),--f);if(c){if(s>=5)for(let a=t.posMin[0]+1;a<t.posMax[0]-1;a+=2)for(let u=t.posMin[1]+2;u<t.posMax[1]-2;++u)B(e,m.fromValues(a,u),M.Table)}else if(r>=5)for(let a=t.posMin[1]+1;a<t.posMax[1]-1;a+=2)for(let u=t.posMin[0]+2;u<t.posMax[0]-2;++u)B(e,m.fromValues(u,a),M.Table)}function Tn(e,t,o,n){const r=t.posMax[0]-t.posMin[0],s=t.posMax[1]-t.posMin[1],i=t.posMin[0]+Math.floor((r-1)/2),c=t.posMin[1]+Math.floor((s-1)/2);Ie(e,i,c,i+1,c+1,L.GroundTreasure),B(e,m.fromValues(i,c),M.TreasurePlinth),t.roomType===13&&B(e,m.fromValues(i,c),M.TreasureLock),(r>=5||s>=5)&&($(e,m.fromValues(t.posMin[0],t.posMin[1]),J(o,n)),$(e,m.fromValues(t.posMax[0]-1,t.posMin[1]),J(o,n)),$(e,m.fromValues(t.posMin[0],t.posMax[1]-1),J(o,n)),$(e,m.fromValues(t.posMax[0]-1,t.posMax[1]-1),J(o,n)))}function _n(e,t,o,n){const r=t.posMax[0]-t.posMin[0],s=t.posMax[1]-t.posMin[1],i=t.posMin[0]+Math.floor((r-1)/2),c=t.posMin[1]+Math.floor((s-1)/2);r>3&&s>3?Ie(e,Math.max(t.posMin[0]+1,i-1),Math.max(t.posMin[1]+1,c-1),Math.min(t.posMax[0]-1,i+2),Math.min(t.posMax[1]-1,c+2),L.GroundVault):Ie(e,i,c,i+1,c+1,L.GroundTreasure),B(e,m.fromValues(i,c),M.TreasurePlinth),t.roomType===14&&B(e,m.fromValues(i,c),M.TreasureLock),(r>=5||s>=5)&&($(e,m.fromValues(t.posMin[0],t.posMin[1]),J(o,n)),$(e,m.fromValues(t.posMax[0]-1,t.posMin[1]),J(o,n)),$(e,m.fromValues(t.posMin[0],t.posMax[1]-1),J(o,n)),$(e,m.fromValues(t.posMax[0]-1,t.posMax[1]-1),J(o,n)))}function Mo(e,t){const o=e-Math.floor(e);return e=Math.floor(e),t.random()<o&&++e,e}function wi(e){let t=0;for(const o of e.edges)o.dir[0]===0&&o.door&&++t;return t}function Si(e){let t=0;for(const o of e.edges)o.dir[1]===0&&o.door&&++t;return t}function Ti(e,t,o,n){const r=t.posMin[0],s=t.posMin[1],i=t.posMax[0]-t.posMin[0],c=t.posMax[1]-t.posMin[1];if(i>=c){const l=s+Math.floor(c/2);if((i&1)==0){$(e,m.fromValues(r+1,l),J(o,n)),$(e,m.fromValues(r+i-2,l),J(o,n));for(let f=r+2;f<r+i-2;++f)B(e,m.fromValues(f,l-1),M.Chair),B(e,m.fromValues(f,l),M.Table),B(e,m.fromValues(f,l+1),M.Chair)}else{const f=r+(i-1)/2;$(e,m.fromValues(f,l),J(o,n));for(let d=r+1;d<f;++d)B(e,m.fromValues(d,l-1),M.Chair),B(e,m.fromValues(d,l),M.Table),B(e,m.fromValues(d,l+1),M.Chair);for(let d=f+1;d<r+i-1;++d)B(e,m.fromValues(d,l-1),M.Chair),B(e,m.fromValues(d,l),M.Table),B(e,m.fromValues(d,l+1),M.Chair)}}else{const l=r+Math.floor(i/2);if((c&1)==0){$(e,m.fromValues(l,s+1),J(o,n)),$(e,m.fromValues(l,s+c-2),J(o,n));for(let f=s+2;f<s+c-2;++f)B(e,m.fromValues(l-1,f),M.Chair),B(e,m.fromValues(l,f),M.Table),B(e,m.fromValues(l+1,f),M.Chair)}else{const f=s+(c-1)/2;$(e,m.fromValues(l,f),J(o,n));for(let d=s+1;d<f;++d)B(e,m.fromValues(l-1,d),M.Chair),B(e,m.fromValues(l,d),M.Table),B(e,m.fromValues(l+1,d),M.Chair);for(let d=f+1;d<s+c-1;++d)B(e,m.fromValues(l-1,d),M.Chair),B(e,m.fromValues(l,d),M.Table),B(e,m.fromValues(l+1,d),M.Chair)}}}function we(e,t,o){let n=0;for(const r of e.edges){if(!r.door)continue;let s=-r.dir[1],i=r.dir[0];r.roomLeft===e&&(s=-s,i=-i),s===t&&i===o&&++n}return n}function Wt(e,t,o){t=-t,o=-o;const n=m.fromValues(t,o),r=m.create(),s=m.create();t>0?m.set(s,e.posMin[0]-1,0):t<0?m.set(s,e.posMax[0],0):o>0?m.set(s,0,e.posMin[1]-1):m.set(s,0,e.posMax[1]);let i=1/0;for(const c of e.edges){if(!c.door)continue;m.scaleAndAdd(r,c.origin,c.dir,Math.floor(c.length/2)),m.subtract(r,r,s);const l=m.dot(n,r);i=Math.min(i,l)}return console.assert(i>=0),i}function _i(e,t,o,n){let r,s,i,c,l,f;t.posMax[1]-t.posMin[1]<t.posMax[0]-t.posMin[0]||we(t,0,-1)!==0&&we(t,0,1)!==0?(l=t.posMax[1]-t.posMin[1],f=t.posMax[0]-t.posMin[0],i=0,Wt(t,-1,0)>Wt(t,1,0)?(r=t.posMin[0],s=t.posMin[1],c=1):(r=t.posMax[0]-1,s=t.posMax[1]-1,c=-1)):(l=t.posMax[0]-t.posMin[0],f=t.posMax[1]-t.posMin[1],c=0,Wt(t,0,-1)>Wt(t,0,1)?(r=t.posMax[0]-1,s=t.posMin[1],i=-1):(r=t.posMin[0],s=t.posMax[1]-1,i=1));const d=m.fromValues(i,c),a=m.fromValues(c,-i),u=m.fromValues(r,s),h=m.create(),p=(l&1)!==0?1:2,y=Math.floor((l-p)/2);for(let g=0;g<f-1;++g)for(let x=0;x<p;++x)m.scaleAndAdd(h,u,d,y+x),m.scaleAndAdd(h,h,a,g),e.cells.atVec(h).type=L.GroundMarble;for(let g=0;g<p;++g)m.scaleAndAdd(h,u,d,y+g),B(e,h,M.Chair);if(m.scaleAndAdd(h,u,d,y-1),$(e,h,M.DrawersShort),m.scaleAndAdd(h,u,d,y+p),$(e,h,M.DrawersShort),l>4&&(m.scaleAndAdd(h,u,d,0),$(e,h,M.TorchLit),m.scaleAndAdd(h,u,d,l-1),$(e,h,M.TorchLit)),f>6)if(l>=5)for(let g=2;g<f-2;++g)m.scaleAndAdd(h,u,d,1),m.scaleAndAdd(h,h,a,g),$(e,h,M.Chair),m.scaleAndAdd(h,u,d,l-2),m.scaleAndAdd(h,h,a,g),$(e,h,M.Chair);else{if(we(t,-d[0],-d[1])===0)for(let g=2;g<f-2;++g)m.scaleAndAdd(h,u,d,0),m.scaleAndAdd(h,h,a,g),$(e,h,M.Chair);if(we(t,d[0],d[1])===0)for(let g=2;g<f-2;++g)m.scaleAndAdd(h,u,d,l-1),m.scaleAndAdd(h,h,a,g),$(e,h,M.Chair)}m.scaleAndAdd(h,u,d,0),m.scaleAndAdd(h,h,a,f-1),$(e,h,M.TorchLit),m.scaleAndAdd(h,u,d,l-1),m.scaleAndAdd(h,h,a,f-1),$(e,h,M.TorchLit)}function Li(e,t,o,n){const r=t.posMin[0],s=t.posMin[1],i=t.posMax[0]-t.posMin[0],c=t.posMax[1]-t.posMin[1];if(i>=c)if((i&1)===1)for(let l=1;l<i;l+=2)for(let f=1;f<c-1;++f)B(e,m.fromValues(r+l,s+f),M.Bookshelf);else{const l=i/2-1;for(let f=1;f<l;f+=2)for(let d=1;d<c-1;++d)B(e,m.fromValues(r+f,s+d),M.Bookshelf),B(e,m.fromValues(r+i-(f+1),s+d),M.Bookshelf);if((l&1)===1)for(let f=s+1;f<s+c-1;++f){let d=[void 0,void 0];f>s+1&&(f<s+c-2||c===4)?d=[M.Table,M.Chair]:d=[J(o,n),void 0],n.shuffleArray(d),d[0]!==void 0&&B(e,m.fromValues(r+l,f),d[0]),d[1]!==void 0&&B(e,m.fromValues(r+l+1,f),d[1])}}else if((c&1)===1)for(let l=1;l<c;l+=2)for(let f=1;f<i-1;++f)B(e,m.fromValues(r+f,s+l),M.Bookshelf);else{const l=c/2-1;for(let f=1;f<l;f+=2)for(let d=1;d<i-1;++d)B(e,m.fromValues(r+d,s+f),M.Bookshelf),B(e,m.fromValues(r+d,s+c-(f+1)),M.Bookshelf);if((l&1)===1)for(let f=r+1;f<r+i-1;++f){let d=[void 0,void 0];f>r+1&&(f<r+i-2||i===4)?d=[M.Table,M.Chair]:d=[J(o,n),void 0],n.shuffleArray(d),d[0]!==void 0&&B(e,m.fromValues(f,s+l),d[0]),d[1]!==void 0&&B(e,m.fromValues(f,s+l+1),d[1])}}}function lr(e){const t=[];for(let o=0;o<e.sizeX;++o)for(let n=0;n<e.sizeY;++n)e.get(o,n)&&t.push(m.fromValues(o,n));return t}function Ri(e,t,o){for(let n=t.posMin[0];n<t.posMax[0];++n)for(let r=t.posMin[1];r<t.posMax[1];++r){if(e.cells.at(n,r).type!=L.GroundWood||e.items.some(c=>c.pos[0]===n&&c.pos[1]===r&&c.type!==M.Coin)||Je(e.cells,m.fromValues(n,r))||o.random()>=.02)continue;const s=n>t.posMin[0]&&n<t.posMax[0]-1&&e.cells.at(n-1,r).type===L.GroundWood&&e.cells.at(n+1,r).type===L.GroundWood&&!e.items.some(c=>c.pos[0]===n-1&&c.pos[1]===r&&pt(c.type))&&!e.items.some(c=>c.pos[0]===n+1&&c.pos[1]===r&&pt(c.type)),i=r>t.posMin[1]&&r<t.posMax[1]-1&&e.cells.at(n,r-1).type===L.GroundWood&&e.cells.at(n,r+1).type===L.GroundWood&&!e.items.some(c=>c.pos[0]===n&&c.pos[1]===r-1&&pt(c.type))&&!e.items.some(c=>c.pos[0]===n&&c.pos[1]===r+1&&pt(c.type));(s||i)&&(e.cells.at(n,r).type=L.GroundWoodCreaky)}}function J(e,t){return e===0||t.random()<.05?M.TorchUnlit:M.TorchLit}function $(e,t,o){Je(e.cells,t)||(o==M.TorchUnlit||o==M.TorchLit)&&Oo(e.cells,t)||B(e,t,o)}function Je(e,t){let[o,n]=t;return e.at(o-1,n).type>=L.PortcullisNS||e.at(o+1,n).type>=L.PortcullisNS||e.at(o,n-1).type>=L.PortcullisNS||e.at(o,n+1).type>=L.PortcullisNS}function Oo(e,t){let[o,n]=t;return!!(Ye(e.at(o-1,n).type)||Ye(e.at(o+1,n).type)||Ye(e.at(o,n-1).type)||Ye(e.at(o,n+1).type))}function Po(e,t){let[o,n]=t;return!!(Vt(e.at(o-1,n).type)||Vt(e.at(o+1,n).type)||Vt(e.at(o,n-1).type)||Vt(e.at(o,n+1).type))}function ur(e){return e<L.Wall0000&&e!==L.GroundWater}function Vt(e){return e>=L.Wall0000&&e<=L.OneWayWindowS}function B(e,t,o){e.items.push({pos:m.clone(t),type:o,topLayer:je[o]})}function cr(e,t,o,n,r,s){const i=Ii(o),c=Ci(o,n);let l=0;for(const d of t)if(d.roomType===15){if(l>=e)break;dt(c,i,d.posMin,d.posMax,o,s)&&++l}for(const d of t){if(d.roomType!==5)continue;let a=s.randomInRange(3)+s.randomInRange(3);for(r===E.Fortress&&(a+=2);a>0&&(--a,!(l>=e));)dt(c,i,d.posMin,d.posMax,o,s)&&++l}for(const d of t){if(l>=e)break;if(d.roomType===0||d.roomType===5||(d.roomType===1||d.roomType===3)&&s.random()<.75)continue;let a=0;for(const u of d.edges)u.door&&(a+=1);a<2&&dt(c,i,d.posMin,d.posMax,o,s)&&++l}for(const d of t){if(l>=e)break;Vi(d.roomType)&&(s.random()<.5||dt(c,i,d.posMin,d.posMax,o,s)&&++l)}const f=t.filter(d=>d.roomType!==0&&!ye(d.roomType));s.shuffleArray(f);for(let d=0;d<1e3&&l<e;++d){const a=f[d%f.length];dt(c,i,a.posMin,a.posMax,o,s)&&++l}console.assert(l===e)}function fr(e){switch(e){case M.Chair:case M.Table:case M.DrawersShort:case M.DrawersTall:case M.Bookshelf:case M.Shelf:case M.Bush:return!0;default:return!1}}function Ai(e){return e===M.Table}function Ii(e){const t=new he(e.cells.sizeX,e.cells.sizeY,!1);for(const o of e.items)fr(o.type)&&t.set(o.pos[0],o.pos[1],!0);return t}function Ci(e,t){const o=new he(e.cells.sizeX,e.cells.sizeY,!1);for(let n=0;n<e.cells.sizeX;++n)for(let r=0;r<e.cells.sizeY;++r){const s=e.cells.at(n,r).type;(s===L.GroundWater||s>=L.Wall0000)&&o.set(n,r,!0)}for(const n of t)if(n.path.length===1)for(const r of n.path)o.set(r[0],r[1],!0);for(const n of e.items)fr(n.type)||o.set(n.pos[0],n.pos[1],!0);return o}function dt(e,t,o,n,r,s){const i=[];for(let l=o[0];l<n[0];++l)for(let f=o[1];f<n[1];++f)!e.get(l,f)&&t.get(l,f)&&i.push(m.fromValues(l,f));if(i.length===0){for(let l=o[0];l<n[0];++l)for(let f=o[1];f<n[1];++f)e.get(l,f)||i.push(m.fromValues(l,f));if(i.length===0)return!1}const c=i[s.randomInRange(i.length)];return B(r,c,M.Coin),e.set(c[0],c[1],!0),!0}function hr(e,t,o){const n=e.items.filter(s=>s.type===M.Bookshelf);o.shuffleArray(n);const r=new Map;for(const s of t){const i=[];for(const c of n)c.pos[0]>=s.posMin[0]&&c.pos[1]>=s.posMin[1]&&c.pos[0]<s.posMax[0]&&c.pos[1]<s.posMax[1]&&i.push(c);i.length>0&&r.set(s,i)}for(const s of e.items.filter(i=>i.type===M.TreasurePlinth)){const i=o.randomInRange(5);B(e,s.pos,M.TreasureA+i);const c={switches:[],numSwitchesUsed:0,posTreasure:m.clone(s.pos),stolen:!1};if(e.treasures.push(c),!e.items.some(h=>h.type===M.TreasureLock&&h.pos.equals(s.pos)))continue;const l=[];for(let h=3;h>0&&l.length===0;--h)for(const p of t){const y=r.get(p);y!==void 0&&y.length>=h&&l.push(y)}if(l.length===0){e.items=e.items.filter(h=>!(h.type===M.TreasureLock&&h.pos.equals(s.pos))),e.cells.atVec(s.pos).blocksPlayerMove=!1;continue}const f=l[o.randomInRange(l.length)];let d="";for(let h=Math.min(f.length,3);h>0;--h){const p=f.pop();d.length>0&&(d+=`
`);let g=e.bookTitle.get(p).split(" ")[0];g.endsWith(",")&&(g=g.substring(0,g.length-1)),d+=g,c.switches.push(m.clone(p.pos))}const a=new Set;for(const h of e.items)(h.type===M.Coin||h.type===M.Health||h.type===M.Note)&&a.add(h.pos[0]*e.cells.sizeY+h.pos[1]);let u=e.items.filter(h=>(h.type===M.DrawersShort||h.type===M.DrawersTall||h.type===M.Shelf)&&!a.has(h.pos[0]*e.cells.sizeY+h.pos[1]));if(u.length>0){const h=u[o.randomInRange(u.length)].pos,p={pos:m.clone(h),type:M.Note,topLayer:je[M.Note]};e.items.push(p),e.bookTitle.set(p,d)}}e.items.sort((s,i)=>s.type===M.TreasureLock&&i.type!==M.TreasureLock?1:s.type!==M.TreasureLock&&i.type===M.TreasureLock?-1:0)}function dr(e,t,o,n){if(e<1)return;let r=1+Math.floor((9-e)/4);wo([10],t,o,n)&&--r,r>0&&wo([10,7],t,o,n)&&--r;for(let s=10;s>0&&r>0;--s)wo([10,7,6],t,o,n)&&--r}function wo(e,t,o,n){const r=o.filter(s=>e.includes(s.roomType));if(r.length===0)return!1;for(let s=0;s<10;++s){const i=r[n.randomInRange(r.length)];if(bi(i.posMin,i.posMax,t,n))return!0}return!1}function bi(e,t,o,n){const r=[];for(let s=e[0];s<t[0];++s)for(let i=e[1];i<t[1];++i){const c=m.fromValues(s,i);Pi(c,o)&&r.push(c)}return r.length===0?!1:(B(o,r[n.randomInRange(r.length)],M.Health),!0)}function Pi(e,t){let o=t.cells.atVec(e).type;if(o===L.GroundWater||o>=L.Wall0000)return!1;let n=!1;for(const r of t.items)if(r.pos.equals(e)){if(!Ai(r.type))return!1;n=!0}return n}function Ie(e,t,o,n,r,s){for(let i=t;i<n;++i)for(let c=o;c<r;++c)e.cells.at(i,c).type=s}function ki(e,t,o){const n=e.cells.sizeX,r=e.cells.sizeY;for(const l of t)e.cells.atVec(l).type=L.GroundNormal;Ie(e,0,0,n,No,L.GroundNormal);const s=new he(e.cells.sizeX,e.cells.sizeY,!1),i=[],c=[m.clone(e.playerStartPos)];for(let l=0;l<c.length;++l){const f=c[l];if(!s.get(f[0],f[1])&&(s.set(f[0],f[1],!0),!(e.cells.atVec(f).type>=L.Wall0000))){e.cells.atVec(f).type===L.GroundGrass&&i.push(f);for(let d=-1;d<=1;++d)for(let a=-1;a<=1;++a){const u=m.fromValues(f[0]+d,f[1]+a);u[0]>=0&&u[1]>=0&&u[0]<e.cells.sizeX&&u[1]<e.cells.sizeY&&!s.get(u[0],u[1])&&c.push(u)}}}o.shuffleArray(i),i.length=Math.floor(i.length/3),s.fill(!1);for(const l of i)if(!s.get(l[0],l[1])){B(e,l,M.Bush);for(let f=Math.max(0,l[0]-1);f<Math.min(n,l[0]+2);++f)for(let d=Math.max(0,l[1]-1);d<Math.min(r,l[1]+2);++d)s.set(f,d,!0)}}function jt(e,t){return e.cells.atVec(t).type>=L.Wall0000?!1:t[0]>=0&&e.cells.at(t[0]-1,t[1]).type>=L.Wall0000||t[1]>=0&&e.cells.at(t[0],t[1]-1).type>=L.Wall0000||t[0]+1<e.cells.sizeX&&e.cells.at(t[0]+1,t[1]).type>=L.Wall0000||t[1]+1<e.cells.sizeY&&e.cells.at(t[0],t[1]+1).type>=L.Wall0000}function Di(e,t){const o=[],n=nr(e,t),r=m.clone(n),s=m.fromValues(1,0);for(let i=t.cells.sizeX*t.cells.sizeY;i>0;--i){o.push(m.clone(r));const c=m.fromValues(-s[1],s[0]),l=m.fromValues(s[1],-s[0]);if(t.cells.at(r[0]+s[0],r[1]+s[1]).type>=L.Wall0000)if(t.cells.at(r[0]+c[0],r[1]+c[1]).type<L.Wall0000)m.copy(s,c);else if(t.cells.at(r[0]+l[0],r[1]+l[1]).type<L.Wall0000)m.copy(s,l);else break;else if(!jt(t,r))if(jt(t,m.fromValues(r[0]+c[0],r[1]+c[1])))m.copy(s,c);else if(jt(t,m.fromValues(r[0]+l[0],r[1]+l[1])))m.copy(s,l);else break;if(r.set(r[0]+s[0],r[1]+s[1]),r.equals(n)||r[0]<0||r[1]<0||r[0]>=t.cells.sizeX||r[1]>=t.cells.sizeY)break}return o}function Wi(e){let t=e.cells.sizeX-1,o=Math.floor(t/2);for(let n=Qt;n<o;n+=5)e.cells.at(n,1).type=L.Wall0000,e.cells.at(t-n,1).type=L.Wall0000}function Ln(e,t){for(const o of e.items)if(o.pos.equals(t))return!0;for(const o of e.guards)if(o.pos.equals(t))return!0;return!1}function ye(e){switch(e){case 1:case 3:case 12:case 14:return!0;case 0:case 2:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 13:case 15:return!1}}function Vi(e){return e===4||e===6}function pr(e,t,o,n,r,s){if(!(e<=0)){if(r&&o.length>0){let i=o.filter(a=>a.path.length>1&&a.minRoomDepth>0);i.length===0&&(i=[...o]),i.sort((a,u)=>a.minRoomDepth-u.minRoomDepth);const c=Math.floor(i.length/2),l=i[c];o=o.filter(a=>a!==l);const f=0,d=new Et(l.path,f);e>1&&s.randomInRange(5+e)<e&&(d.hasTorch=!0),d.hasVaultKey=!0,t.guards.push(d)}if(n>0&&e<4){const i=o.findIndex(c=>c.path.length<=1);if(i>=0){const c=o[i];o.splice(i,1);const l=0,f=new Et(c.path,l);e>1&&s.randomInRange(5+e)<e&&(f.hasTorch=!0),f.hasPurse=!0,n--,t.guards.push(f)}}for(const i of o){const l=new Et(i.path,0);e>1&&s.randomInRange(5+e)<e&&(i.path.length>1||!t.items.some(f=>f.pos.equals(i.path[0])))&&(l.hasTorch=!0),n>0&&(l.hasPurse=!0,n--),t.guards.push(l)}if(e===1){const i=t.items.filter(c=>c.type===M.PortcullisEW).sort((c,l)=>c.pos[1]-l.pos[1]);if(i.length>=1){const c=i[0].pos,l=t.guards[0];m.set(l.pos,c[0],c[1]+1),m.set(l.dir,0,-1),l.enterPatrolMode(t)}}console.assert(n===0)}}const Bi=["Alien","Aliens","Amulet","Amulets","Arm","Arms","Armor","Armor","Arrow","Arrows","Attack","Attacks","Aura","Aurae","Awakening","Awakenings","Axe","Axes","Bane","Banes","Battle-Axe","Battle-Axes","Blood","Bloods","Breath","Breaths","Captive","Captives","Castle","Castles","Catacomb","Catacombs","Cave","Caves","Chamber","Chambers","Champion","Champions","Child","Children","Citadel","Citadels","City","Cities","Claw","Claws","Cow","Cows","Crown","Crowns","Crusade","Crusades","Crystal","Crystals","Curse","Curses","Dagger","Daggers","Daughter","Daughters","Dawn","Dawn","Day","Days","Dungeon","Dungeons","Dragon","Dragons","Eye","Eyes","Field","Fields","Fire","Fires","Fist","Fists","Forest","Forests","Fortress","Fortresses","Fugitive","Fugitives","Game","Games","Gem","Gems","Guardian","Guardians","Hand","Hands","Helm","Helms","Horde","Hordes","Hour","Hours","Keep","Keeps","Key","Keys","Knight","Knights","Land","Lands","Legend","Legends","Lord","Lords","Master","Masters","Mercenary","Mercenaries","Mind","Minds","Mine","Mines","Minion","Minions","Mirror","Mirrors","Night","Nights","Moon","Moons","Omen","Omens","Orb","Orbs","Path","Paths","Pit","Pits","Plague","Plagues","Pool","Pools","Potion","Potions","Prince","Princes","Princess","Princesses","Prison","Prisons","Prisoner","Prisoners","Prophecy","Prophecies","Quest","Quests","Rampage","Rampages","Realm","Realms","Reaper","Reapers","Rebirth","Rebirths","Return","Returns","Revenge","Revenges","Ring","Rings","Rise","Rise","River","Rivers","Scroll","Scrolls","Serpent","Serpents","Servant","Servants","Shadow","Shadows","Shield","Shields","Sign","Signs","Siren","Sirens","Slave","Slaves","Son","Sons","Spawn","Spawn","Spear","Spears","Spell","Spells","Sphere","Spheres","Staff","Staves","Stronghold","Strongholds","Sword","Swords","Thief","Thieves","Threat","Threats","Throne","Thrones","Tower","Towers","Trail","Trails","Trial","Trials","Valley","Valleys","Wand","Wands","Warrior","Warriors","Weapon","Weapons","Wind","Winds","Witch","Witches","Wizard","Wizards"],Rn=["Adventure","Agony","the Ancients","Anger","Avenging","Battle","Beholding","Brilliance","Danger","Darkness","Death","Deception","Despair","Destiny","Destruction","Disease","Ecstacy","Enchantment","Enlightenment","Eternity","Evil","Falsehood","Famine","Fantasy","Fate","Fear","Flame","Foretelling","Forewarning","Fortune","Fury","Gallantry","Gingivitis","the Gods","Intrigue","Keeping","Legend","the Living Dead","Lore","Madness","Magic","Menace","Midnight","Might","Murder","Mystery","Power","Prophecy","Radiance","Rebellion","Reckoning","Remembrance","Shadow","Sickness","Strength","Suffering","Terror","Time","Truth","the Undead","the Universe","Unraveling","Valor","Vengeance","Venom","War"],Gi=["Administrative Law","Arbitrage","Attorney-Client Privilege","Attractive Nuisances","Bankruptcy","Civil Procedure","Community Property","Comparative Legal Traditions","Contract Law","Consideration","Corporate Finance","Corporate Taxation","Criminal Law","Cross-Examination","Damages","Discovery","Economics","Embezzlement","Estate Planning","Estoppel","Homicide","Income Taxation","Intangible Property","International Transactions","Intestate Succession","Probate","Promissory Estoppel","Property","Quid Pro Quo","Reckless Disregard","Regulatory Policy","Securities Regulation","Security Interests","Statutory Law","Torts","Trial Procedure","Wills, Trusts, and Estates"];function mr(e,t,o,n){const r=[...Gi];n.shuffleArray(r);let s=0;const i=[...Bi];n.shuffleArray(i);let c=0;const l=new Map;for(const f of t){const d=[];for(const a of o)a.pos[0]>=f.posMin[0]&&a.pos[1]>=f.posMin[1]&&a.pos[0]<f.posMax[0]&&a.pos[1]<f.posMax[1]&&d.push(a);d.length>0&&l.set(f,d)}for(const f of l){const d=f[0],a=f[1],u=m.create(),h=m.create();d.posMax[0]-d.posMin[0]>=d.posMax[1]-d.posMin[1]?(m.set(u,1,0),m.set(h,0,-1)):(m.set(u,0,-1),m.set(h,1,0)),a.sort((y,g)=>{let x=m.dot(u,y.pos),w=m.dot(u,g.pos);return x<w?-1:x>w?1:(x=m.dot(h,y.pos),w=m.dot(h,g.pos),x<w?-1:x>w?1:0)});const p=[];for(let y=0;y<a.length;++y){let g;if(d.privateRoom){const x=i[c];c=(c+1)%i.length;const w=Rn[n.randomInRange(Rn.length)];g=x+" of "+w}else g=r[s],s=(s+1)%r.length;p.push(g)}p.sort((y,g)=>y.localeCompare(g,void 0,{sensitivity:"base"}));for(let y=0;y<a.length;++y)e.set(a[y],p[y])}}function Ui(e){const t=new he(e.cells.sizeX,e.cells.sizeY,!1),o=[e.playerStartPos];for(let n=0;n<o.length;++n){const r=o[n];if(!t.get(r[0],r[1])&&(t.set(r[0],r[1],!0),e.cells.atVec(r).seen=!0,++e.numPreRevealedCells,!(e.cells.atVec(r).type>=L.Wall0000)))for(let s=-1;s<=1;++s)for(let i=-1;i<=1;++i){const c=m.fromValues(r[0]+s,r[1]+i);c[0]>=0&&c[1]>=0&&c[0]<e.cells.sizeX&&c[1]<e.cells.sizeY&&!t.get(c[0],c[1])&&o.push(c)}}}function pt(e){return e===M.DrawersTall||e===M.Bookshelf||e===M.Shelf||e===M.Stove||e===M.TreasureLock}function gr(e){let t=e.cells.sizeX,o=e.cells.sizeY;for(let n=0;n<t;++n)for(let r=0;r<o;++r){const s=e.cells.at(n,r),i=s.type,c=i>=L.Wall0000&&i<=L.Wall1111,l=Ye(i),f=i==L.GroundWater;s.moveCost=c||l?1/0:f?64:0,s.blocksPlayerMove=c,s.blocksPlayerSight=c&&i!==L.Wall0000,s.blocksSight=c,s.blocksSound=c,s.hidesPlayer=!1,s.isWindow=l}for(const n of e.items){let r=e.cells.atVec(n.pos),s=n.type;r.moveCost=Math.max(r.moveCost,Kr(s)),(s===M.DoorNS||s===M.DoorEW||s===M.LockedDoorNS||s===M.LockedDoorEW)&&(r.blocksPlayerSight=!0),(s===M.DoorNS||s===M.DoorEW||s===M.LockedDoorNS||s===M.LockedDoorEW||s===M.PortcullisNS||s===M.PortcullisEW||s===M.Bush||s===M.DrawersTall||s===M.Bookshelf||s===M.Shelf||s===M.Stove)&&(r.blocksSight=!0),(s===M.Table||s===M.Bush||s===M.BedL||s===M.BedR)&&(r.hidesPlayer=!0),pt(s)&&(r.blocksPlayerMove=!0)}}function yr(e){for(let t=0;t<e.sizeX;++t)for(let o=0;o<e.sizeY;++o)e.at(t,o).type==L.Wall0000&&(e.at(t,o).type=Ei(Ni(e,t,o)))}function Ei(e){return L.Wall0000+e}function Bt(e){return e>=L.Wall0000&&e<=L.DoorEW}function Ni(e,t,o){const n=e.sizeX,r=e.sizeY;let s=0;return o<r-1&&Bt(e.at(t,o+1).type)&&(s|=8),o>0&&Bt(e.at(t,o-1).type)&&(s|=4),t<n-1&&Bt(e.at(t+1,o).type)&&(s|=2),t>0&&Bt(e.at(t-1,o).type)&&(s|=1),s}class Fi{constructor(t,o,n,r){this.beginFrame=C=>{};const s=t.getContext("webgl2",{alpha:!1,depth:!1}),i=[r.image,o.image,n.image].map(C=>Hi(s,C));this.renderVignette=zi(s),this.terrainTileSet=o,this.entityTileSet=n,this.fontTileSet=r;const c=`#version 300 es
            in vec2 vPosition;
            in vec3 vTexcoord;
            in vec4 vColor;

            uniform mat4 uMatScreenFromWorld;

            out highp vec3 fTexcoord;
            out highp vec4 fColor;

            void main() {
                fTexcoord = vTexcoord;
                fColor = vColor;
                gl_Position = uMatScreenFromWorld * vec4(vPosition, 0, 1);
            }
        `,l=`#version 300 es
            in highp vec3 fTexcoord;
            in highp vec4 fColor;

            uniform highp sampler2DArray uOpacity;

            out lowp vec4 fragColor;

            void main() {
                fragColor = fColor * texture(uOpacity, fTexcoord);
            }
        `,f={vPosition:0,vTexcoord:1,vColor:2};function d(C,k,U){const G=C&255,V=C>>8&255,Q=C>>16&255,X=C>>24&255,ie=k&255,de=k>>8&255,Y=k>>16&255,me=k>>24&255,ut=Math.max(0,Math.min(255,Math.trunc(G+(ie-G)*U))),Wr=Math.max(0,Math.min(255,Math.trunc(V+(de-V)*U))),Vr=Math.max(0,Math.min(255,Math.trunc(Q+(Y-Q)*U))),Br=Math.max(0,Math.min(255,Math.trunc(X+(me-X)*U)));return ut+(Wr<<8)+(Vr<<16)+(Br<<24)}const a=xr(s,c,l,f),u=s.getUniformLocation(a,"uMatScreenFromWorld"),h=s.getUniformLocation(a,"uOpacity"),p=64,y=4*p,g=2*Float32Array.BYTES_PER_ELEMENT+2*Uint32Array.BYTES_PER_ELEMENT,x=g,w=new ArrayBuffer(y*g),S=new Float32Array(w),T=new Uint32Array(w),I=[1,1],D=s.createBuffer();let R=0;const A=le.create(),W=s.createVertexArray();s.bindVertexArray(W),s.enableVertexAttribArray(f.vPosition),s.enableVertexAttribArray(f.vTexcoord),s.enableVertexAttribArray(f.vColor),s.bindBuffer(s.ARRAY_BUFFER,D),s.vertexAttribPointer(f.vPosition,2,s.FLOAT,!1,g,0),s.vertexAttribPointer(f.vTexcoord,3,s.UNSIGNED_BYTE,!1,g,8),s.vertexAttribPointer(f.vColor,4,s.UNSIGNED_BYTE,!0,g,12),s.bufferData(s.ARRAY_BUFFER,w,s.DYNAMIC_DRAW),Oi(s,p),s.bindVertexArray(null),this.start=(C,k)=>{le.copy(A,C),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D_ARRAY,i[k])},this.addGlyph=(C,k,U,G,V)=>{if(V.textureIndex===void 0)return;R>=p&&this.flush(),U=C+(U-C)*I[0],G=k+(G-k)*I[1];const Q=V.color?V.color:4294967295,X=R*x,ie=V.textureIndex<<16;S[X+0]=C,S[X+1]=k,T[X+2]=ie+256,T[X+3]=Q,S[X+4]=U,S[X+5]=k,T[X+6]=ie+257,T[X+7]=Q,S[X+8]=C,S[X+9]=G,T[X+10]=ie,T[X+11]=Q,S[X+12]=U,S[X+13]=G,T[X+14]=ie+1,T[X+15]=Q,++R},this.addGlyphLit=(C,k,U,G,V,Q)=>{if(V.textureIndex===void 0)return;R>=p&&this.flush(),U=C+(U-C)*I[0],G=k+(G-k)*I[1];const X=V.color?V.color:4294967295,ie=V.unlitColor?V.unlitColor:4283453520,de=d(ie,X,Q**.25),Y=R*x,me=V.textureIndex<<16;S[Y+0]=C,S[Y+1]=k,T[Y+2]=me+256,T[Y+3]=de,S[Y+4]=U,S[Y+5]=k,T[Y+6]=me+257,T[Y+7]=de,S[Y+8]=C,S[Y+9]=G,T[Y+10]=me,T[Y+11]=de,S[Y+12]=U,S[Y+13]=G,T[Y+14]=me+1,T[Y+15]=de,++R},this.addGlyphLit4=(C,k,U,G,V,Q)=>{if(V.textureIndex===void 0)return;R>=p&&this.flush();const X=V.color?V.color:4294967295,ie=V.unlitColor?V.unlitColor:4283453520;function de(ut){return d(ie,X,ut**.25)}U=C+(U-C)*I[0],G=k+(G-k)*I[1];const Y=R*x,me=V.textureIndex<<16;S[Y+0]=C,S[Y+1]=k,T[Y+2]=me+256,T[Y+3]=de(Q[0]),S[Y+4]=U,S[Y+5]=k,T[Y+6]=me+257,T[Y+7]=de(Q[1]),S[Y+8]=C,S[Y+9]=G,T[Y+10]=me,T[Y+11]=de(Q[2]),S[Y+12]=U,S[Y+13]=G,T[Y+14]=me+1,T[Y+15]=de(Q[3]),++R},this.flush=()=>{R<=0||(s.useProgram(a),s.bindVertexArray(W),s.uniform1i(h,0),s.uniformMatrix4fv(u,!1,A),s.bindBuffer(s.ARRAY_BUFFER,D),s.bufferSubData(s.ARRAY_BUFFER,0,S,0),s.drawElements(s.TRIANGLES,6*R,s.UNSIGNED_SHORT,0),s.bindVertexArray(null),R=0)},this.beginFrame=C=>{s.viewport(0,0,C[0],C[1]),s.clear(s.COLOR_BUFFER_BIT)},s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),s.enable(s.BLEND),s.clearColor(0,0,0,1)}start(t,o){}addGlyph(t,o,n,r,s){}addGlyphLit(t,o,n,r,s,i){}addGlyphLit4(t,o,n,r,s,i){}flush(){}}function Oi(e,t){const o=new Uint16Array(t*6);for(let r=0;r<t;++r){let s=6*r,i=4*r;o[s+0]=i+0,o[s+1]=i+1,o[s+2]=i+2,o[s+3]=i+2,o[s+4]=i+1,o[s+5]=i+3}const n=e.createBuffer();return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n),e.bufferData(e.ELEMENT_ARRAY_BUFFER,o,e.STATIC_DRAW),n}function Hi(e,t){const s=t.naturalWidth/16,i=t.naturalHeight/16,c=4,l=s*c,f=i*c,d=document.createElement("canvas");d.width=l,d.height=f*256;const a=d.getContext("2d");a.imageSmoothingEnabled=!1;for(let y=0;y<16;++y)for(let g=0;g<16;++g){const x=g*s,w=y*i,S=0,T=(16*y+g)*f;a.drawImage(t,x,w,s,i,S,T,l,f)}const u=a.getImageData(0,0,d.width,d.height),h=new Uint8Array(u.data.buffer),p=e.createTexture();return e.bindTexture(e.TEXTURE_2D_ARRAY,p),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texImage3D(e.TEXTURE_2D_ARRAY,0,e.RGBA,l,f,256,0,e.RGBA,e.UNSIGNED_BYTE,h),e.generateMipmap(e.TEXTURE_2D_ARRAY),p}function An(e,t,o){const n=e.createShader(t);return e.shaderSource(n,o),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS)||(alert("An error occurred compiling the shaders: "+e.getShaderInfoLog(n)),e.deleteShader(n)),n}function xr(e,t,o,n){const r=An(e,e.VERTEX_SHADER,t),s=An(e,e.FRAGMENT_SHADER,o),i=e.createProgram();e.attachShader(i,r),e.attachShader(i,s);for(const c in n)e.bindAttribLocation(i,n[c],c);return e.linkProgram(i),e.getProgramParameter(i,e.LINK_STATUS)||alert("Unable to initialize the shader program: "+e.getProgramInfoLog(i)),i}function zi(e){const t=`#version 300 es
        in vec2 vPositionScreen;

        uniform mat4 uMatDiscFromScreen;

        out highp vec2 fPositionDisc;

        void main() {
            highp vec4 posScreen = vec4(vPositionScreen.xy, 0, 1);
            fPositionDisc = (uMatDiscFromScreen * posScreen).xy;
            gl_Position = posScreen;
        }
    `,o=`#version 300 es
        in highp vec2 fPositionDisc;

        uniform highp vec4 uColorInner;
        uniform highp vec4 uColorOuter;
        uniform highp float uRadiusInner;

        out lowp vec4 fragColor;

        void main() {
            highp float r = length(fPositionDisc);
            highp float u = smoothstep(uRadiusInner, 1.0, r);
            fragColor = mix(uColorInner, uColorOuter, u);
        }
    `,n={vPositionScreen:0},r=xr(e,t,o,n),s=e.getUniformLocation(r,"uMatDiscFromScreen"),i=e.getUniformLocation(r,"uColorInner"),c=e.getUniformLocation(r,"uColorOuter"),l=e.getUniformLocation(r,"uRadiusInner"),f=new Float32Array(6*2);{let u=function(p,y){f[h++]=p,f[h++]=y},h=0;u(-1,-1),u(1,-1),u(1,1),u(1,1),u(-1,1),u(-1,-1)}const d=e.createBuffer(),a=e.createVertexArray();return e.bindVertexArray(a),e.enableVertexAttribArray(n.vPositionScreen),e.bindBuffer(e.ARRAY_BUFFER,d),e.vertexAttribPointer(n.vPositionScreen,2,e.FLOAT,!1,0,0),e.bufferData(e.ARRAY_BUFFER,f,e.STATIC_DRAW),e.bindVertexArray(null),(u,h,p,y)=>{e.useProgram(r),e.uniformMatrix4fv(s,!1,u),e.uniform1f(l,h),e.uniform4fv(i,p),e.uniform4fv(c,y),e.bindVertexArray(a),e.drawArrays(e.TRIANGLES,0,6),e.bindVertexArray(null)}}const vr=4278190248,Be=4289243304,pe=4287660160,ce=4285550672,st=4284497984,In=4283760212,Cn=4294901332,ko=4283716862,Xi=4294857982,Yi=4283760382,ae=4291886846,_=4294967295,ji="/assets/entitytiles31color-C0L0guxm.png",qi="/assets/terraintiles31color-DG9JaUNl.png",$i="/assets/font-CR3eugiY.png";var Te=(e=>(e[e.Font=0]="Font",e[e.Terrain=1]="Terrain",e[e.Entity=2]="Entity",e))(Te||{});function Mr(){return Qi}function oe(){return Zi}function wr(){return Ki}function v(e){return e[1]*16+e[0]}const Ki={name:"Basic Font",imageSrc:$i,image:new Image,tileSize:[16,16],offset:[0,0],letterMap:[],background:{textureIndex:219,color:4279242768},heart:{textureIndex:3},air:{textureIndex:9}},b=4290816682,P=4291887103,q=4285876810,Z=4291884031,ze=4290962414,N=4290023568,Qi={name:"31 Color Terrain Tileset",imageSrc:qi,image:new Image,tileSize:[16,16],cellSize:[16,16],tileRatios:[1,1],offset:[0,0],flattenTexture:!0,terrainTiles:[{textureIndex:v([4,15]),color:Z,unlitColor:q},{textureIndex:v([8,14]),color:Z,unlitColor:q},{textureIndex:v([10,14]),color:Z,unlitColor:q},{textureIndex:v([2,14]),color:Z,unlitColor:q},{textureIndex:v([11,14]),color:ze,unlitColor:q},{textureIndex:v([11,15]),color:ze,unlitColor:q},{textureIndex:v([4,15]),color:Z,unlitColor:q},{textureIndex:v([4,14]),color:Z,unlitColor:q},{textureIndex:v([4,0]),color:P,unlitColor:b},{textureIndex:v([4,0]),color:P,unlitColor:b},{textureIndex:v([4,0]),color:P,unlitColor:b},{textureIndex:v([6,0]),color:P,unlitColor:b},{textureIndex:v([4,0]),color:P,unlitColor:b},{textureIndex:v([9,0]),color:P,unlitColor:b},{textureIndex:v([8,0]),color:P,unlitColor:b},{textureIndex:v([12,0]),color:P,unlitColor:b},{textureIndex:v([4,0]),color:P,unlitColor:b},{textureIndex:v([10,0]),color:P,unlitColor:b},{textureIndex:v([7,0]),color:P,unlitColor:b},{textureIndex:v([14,0]),color:P,unlitColor:b},{textureIndex:v([5,0]),color:P,unlitColor:b},{textureIndex:v([13,0]),color:P,unlitColor:b},{textureIndex:v([11,0]),color:P,unlitColor:b},{textureIndex:v([15,0]),color:P,unlitColor:b},{textureIndex:v([0,1]),color:P,unlitColor:b},{textureIndex:v([2,1]),color:P,unlitColor:b},{textureIndex:v([3,1]),color:P,unlitColor:b},{textureIndex:v([1,1]),color:P,unlitColor:b},{textureIndex:v([13,1]),color:P,unlitColor:b},{textureIndex:v([11,1]),color:P,unlitColor:b},{textureIndex:v([8,1]),color:P,unlitColor:b},{textureIndex:v([5,1]),color:P,unlitColor:b},{textureIndex:v([8,14]),color:Z,unlitColor:q},{textureIndex:v([8,14]),color:Z,unlitColor:q}],redWallTerrainTiles:[{textureIndex:v([4,15]),color:Z,unlitColor:q},{textureIndex:v([8,14]),color:Z,unlitColor:q},{textureIndex:v([10,14]),color:Z,unlitColor:q},{textureIndex:v([2,15]),color:Z,unlitColor:q},{textureIndex:v([10,14]),color:ze,unlitColor:q},{textureIndex:v([10,15]),color:ze,unlitColor:q},{textureIndex:v([4,15]),color:Z,unlitColor:q},{textureIndex:v([4,14]),color:Z,unlitColor:q},{textureIndex:v([4,2]),color:P,unlitColor:b},{textureIndex:v([4,2]),color:P,unlitColor:b},{textureIndex:v([4,2]),color:P,unlitColor:b},{textureIndex:v([6,2]),color:P,unlitColor:b},{textureIndex:v([4,2]),color:P,unlitColor:b},{textureIndex:v([9,2]),color:P,unlitColor:b},{textureIndex:v([8,2]),color:P,unlitColor:b},{textureIndex:v([12,2]),color:P,unlitColor:b},{textureIndex:v([4,2]),color:P,unlitColor:b},{textureIndex:v([10,2]),color:P,unlitColor:b},{textureIndex:v([7,2]),color:P,unlitColor:b},{textureIndex:v([14,2]),color:P,unlitColor:b},{textureIndex:v([5,2]),color:P,unlitColor:b},{textureIndex:v([13,2]),color:P,unlitColor:b},{textureIndex:v([11,2]),color:P,unlitColor:b},{textureIndex:v([15,2]),color:P,unlitColor:b},{textureIndex:v([0,3]),color:P,unlitColor:b},{textureIndex:v([2,3]),color:P,unlitColor:b},{textureIndex:v([3,3]),color:P,unlitColor:b},{textureIndex:v([1,3]),color:P,unlitColor:b},{textureIndex:v([13,3]),color:P,unlitColor:b},{textureIndex:v([11,3]),color:P,unlitColor:b},{textureIndex:v([8,3]),color:P,unlitColor:b},{textureIndex:v([5,3]),color:P,unlitColor:b},{textureIndex:v([8,14]),color:Z,unlitColor:q},{textureIndex:v([8,14]),color:Z,unlitColor:q}],manseTerrainTiles:[{textureIndex:v([5,14]),color:Z,unlitColor:q},{textureIndex:v([9,15]),color:Z,unlitColor:q},{textureIndex:v([10,14]),color:Z,unlitColor:q},{textureIndex:v([0,14]),color:Z,unlitColor:q},{textureIndex:v([7,14]),color:ze,unlitColor:q},{textureIndex:v([7,15]),color:ze,unlitColor:q},{textureIndex:v([4,15]),color:Z,unlitColor:q},{textureIndex:v([3,14]),color:Z,unlitColor:q},{textureIndex:v([4,4]),color:P,unlitColor:b},{textureIndex:v([4,4]),color:P,unlitColor:b},{textureIndex:v([4,4]),color:P,unlitColor:b},{textureIndex:v([6,4]),color:P,unlitColor:b},{textureIndex:v([4,4]),color:P,unlitColor:b},{textureIndex:v([9,4]),color:P,unlitColor:b},{textureIndex:v([8,4]),color:P,unlitColor:b},{textureIndex:v([12,4]),color:P,unlitColor:b},{textureIndex:v([4,4]),color:P,unlitColor:b},{textureIndex:v([10,4]),color:P,unlitColor:b},{textureIndex:v([7,4]),color:P,unlitColor:b},{textureIndex:v([14,4]),color:P,unlitColor:b},{textureIndex:v([5,4]),color:P,unlitColor:b},{textureIndex:v([13,4]),color:P,unlitColor:b},{textureIndex:v([11,4]),color:P,unlitColor:b},{textureIndex:v([15,4]),color:P,unlitColor:b},{textureIndex:v([0,5]),color:P,unlitColor:b},{textureIndex:v([2,5]),color:P,unlitColor:b},{textureIndex:v([3,5]),color:P,unlitColor:b},{textureIndex:v([1,5]),color:P,unlitColor:b},{textureIndex:v([13,5]),color:P,unlitColor:b},{textureIndex:v([11,5]),color:P,unlitColor:b},{textureIndex:v([8,5]),color:P,unlitColor:b},{textureIndex:v([5,5]),color:P,unlitColor:b},{textureIndex:v([9,15]),color:Z,unlitColor:q},{textureIndex:v([9,15]),color:Z,unlitColor:q}],fortressTerrainTiles:[{textureIndex:v([5,15]),color:Z,unlitColor:q},{textureIndex:v([8,15]),color:Z,unlitColor:q},{textureIndex:v([10,14]),color:Z,unlitColor:q},{textureIndex:v([0,15]),color:Z,unlitColor:q},{textureIndex:v([6,14]),color:ze,unlitColor:q},{textureIndex:v([6,15]),color:ze,unlitColor:q},{textureIndex:v([5,14]),color:Z,unlitColor:q},{textureIndex:v([3,15]),color:Z,unlitColor:q},{textureIndex:v([4,6]),color:P,unlitColor:b},{textureIndex:v([4,6]),color:P,unlitColor:b},{textureIndex:v([4,6]),color:P,unlitColor:b},{textureIndex:v([6,6]),color:P,unlitColor:b},{textureIndex:v([4,6]),color:P,unlitColor:b},{textureIndex:v([9,6]),color:P,unlitColor:b},{textureIndex:v([8,6]),color:P,unlitColor:b},{textureIndex:v([12,6]),color:P,unlitColor:b},{textureIndex:v([4,6]),color:P,unlitColor:b},{textureIndex:v([10,6]),color:P,unlitColor:b},{textureIndex:v([7,6]),color:P,unlitColor:b},{textureIndex:v([14,6]),color:P,unlitColor:b},{textureIndex:v([5,6]),color:P,unlitColor:b},{textureIndex:v([13,6]),color:P,unlitColor:b},{textureIndex:v([11,6]),color:P,unlitColor:b},{textureIndex:v([15,6]),color:P,unlitColor:b},{textureIndex:v([0,7]),color:P,unlitColor:b},{textureIndex:v([2,7]),color:P,unlitColor:b},{textureIndex:v([3,7]),color:P,unlitColor:b},{textureIndex:v([1,7]),color:P,unlitColor:b},{textureIndex:v([13,7]),color:P,unlitColor:b},{textureIndex:v([11,7]),color:P,unlitColor:b},{textureIndex:v([8,7]),color:P,unlitColor:b},{textureIndex:v([5,7]),color:P,unlitColor:b},{textureIndex:v([8,15]),color:Z,unlitColor:q},{textureIndex:v([8,15]),color:Z,unlitColor:q}],ledgeTiles:[{textureIndex:v([0,11]),color:4285753415,unlitColor:4282922024},{textureIndex:v([1,11]),color:4285753415,unlitColor:4282922024},{textureIndex:v([2,11]),color:4285753415,unlitColor:4282922024},{textureIndex:v([3,11]),color:4285753415,unlitColor:4282922024}],waterAnimation:[{textureIndex:128,color:ae,unlitColor:pe},{textureIndex:129,color:ae,unlitColor:pe},{textureIndex:130,color:ae,unlitColor:pe},{textureIndex:131,color:ae,unlitColor:pe}],manseWaterAnimation:[{textureIndex:144,color:ae,unlitColor:pe},{textureIndex:145,color:ae,unlitColor:pe},{textureIndex:146,color:ae,unlitColor:pe},{textureIndex:147,color:ae,unlitColor:pe}],fortressWaterAnimation:[{textureIndex:160,color:pe,unlitColor:st},{textureIndex:161,color:pe,unlitColor:st},{textureIndex:162,color:pe,unlitColor:st},{textureIndex:163,color:pe,unlitColor:st}]},Zi={name:"31 Color Entity Tileset",imageSrc:ji,image:new Image,tileSize:[16,16],cellSize:[16,16],tileRatios:[1,1],offset:[0,0],flattenTexture:!0,unlitTile:{textureIndex:v([0,0])},namedTiles:{pickTarget:{textureIndex:188,color:4294967295},noise:{textureIndex:187,color:2164260863},crossHatch:{textureIndex:3,color:4294967295},patrolRoute:{textureIndex:31,color:4286644096},speechBubbleR:{textureIndex:183,color:4294967295},speechBubbleL:{textureIndex:184,color:4294967295},idleIndicator:{textureIndex:188,color:4294967295},playerHint:{textureIndex:185,color:4294967295},uiWindowTile:{textureIndex:32,color:4294967295},uiCreakyTile:{textureIndex:33,color:4294967295},treasureA:{textureIndex:160,color:4294967295},treasureB:{textureIndex:161,color:4294967295},treasureC:{textureIndex:162,color:4294967295},treasureD:{textureIndex:163,color:4294967295},treasureE:{textureIndex:164,color:4294967295},treasureV:{textureIndex:171,color:4294967295}},touchButtons:{menu:{textureIndex:v([11,1]),color:2701131775,unlitColor:822083583},up:{textureIndex:v([2,1]),color:2701131775,unlitColor:822083583},down:{textureIndex:v([3,1]),color:2701131775,unlitColor:822083583},left:{textureIndex:v([0,1]),color:2701131775,unlitColor:822083583},right:{textureIndex:v([1,1]),color:2701131775,unlitColor:822083583},wait:{textureIndex:v([4,1]),color:2701131775,unlitColor:822083583},jump:{textureIndex:v([5,1]),color:2701131775,unlitColor:822083583},bang:{textureIndex:v([13,1]),color:2701131775,unlitColor:822083583},menuAccept:{textureIndex:v([4,1]),color:2701131775,unlitColor:822083583},zoomOut:{textureIndex:v([6,1]),color:2701131775,unlitColor:822083583},zoomIn:{textureIndex:v([7,1]),color:2701131775,unlitColor:822083583},heal:{textureIndex:v([8,1]),color:2701131775,unlitColor:822083583},startLevel:{textureIndex:v([9,1]),color:2701131775,unlitColor:822083583},nextLevel:{textureIndex:v([9,1]),color:2701131775,unlitColor:822083583},forceRestart:{textureIndex:v([10,1]),color:2701131775,unlitColor:822083583},fullscreen:{textureIndex:v([14,1]),color:2701131775,unlitColor:822083583}},vaultGoldAnimationTiles:[{textureIndex:157,color:4294967295,unlitColor:4294967295},{textureIndex:173,color:4294967295,unlitColor:4294967295},{textureIndex:174,color:4294967295,unlitColor:4294967295},{textureIndex:175,color:4294967295,unlitColor:4294967295}],itemGlows:{[M.Coin]:{textureIndex:v([12,9]),color:2701131775,unlitColor:16777215},[M.TreasureA]:{textureIndex:v([5,9]),color:2701131775,unlitColor:16777215},[M.TreasureB]:{textureIndex:v([6,9]),color:2701131775,unlitColor:16777215},[M.TreasureC]:{textureIndex:v([7,9]),color:2701131775,unlitColor:16777215},[M.TreasureD]:{textureIndex:v([8,9]),color:2701131775,unlitColor:16777215},[M.TreasureE]:{textureIndex:v([9,9]),color:2701131775,unlitColor:16777215},[M.VaultTreasureBox]:{textureIndex:v([11,9]),color:2701131775,unlitColor:16777215}},itemTiles:[{textureIndex:v([3,13]),color:_,unlitColor:N},{textureIndex:v([4,13]),color:_,unlitColor:N},{textureIndex:v([7,14]),color:_,unlitColor:N},{textureIndex:v([8,14]),color:_,unlitColor:N},{textureIndex:v([10,14]),color:_,unlitColor:N},{textureIndex:v([9,14]),color:_,unlitColor:N},{textureIndex:v([7,12]),color:_,unlitColor:N},{textureIndex:v([5,12]),color:_,unlitColor:N},{textureIndex:v([14,14]),color:_,unlitColor:N},{textureIndex:v([6,15]),color:_,unlitColor:N},{textureIndex:v([5,13]),color:_,unlitColor:_},{textureIndex:v([15,11]),color:_,unlitColor:_},{textureIndex:v([2,4]),color:P,unlitColor:b},{textureIndex:v([0,4]),color:P,unlitColor:b},{textureIndex:v([3,4]),color:P,unlitColor:b},{textureIndex:v([1,4]),color:P,unlitColor:b},{textureIndex:v([6,4]),color:P,unlitColor:b},{textureIndex:v([4,4]),color:P,unlitColor:b},{textureIndex:v([0,13]),color:_,unlitColor:_},{textureIndex:v([1,13]),color:_,unlitColor:_},{textureIndex:v([15,13]),color:ae,unlitColor:ae},{textureIndex:v([0,15]),color:_,unlitColor:_},{textureIndex:v([6,13]),color:_,unlitColor:_},{textureIndex:v([1,15]),color:_,unlitColor:_},{textureIndex:v([11,10]),color:_,unlitColor:_},{textureIndex:v([10,10]),color:_,unlitColor:_},{textureIndex:v([10,10]),color:_,unlitColor:_},{textureIndex:v([15,7]),color:_,unlitColor:N},{textureIndex:v([8,13]),color:_,unlitColor:N},{textureIndex:v([7,13]),color:_,unlitColor:N},{textureIndex:v([5,10]),color:_,unlitColor:_},{textureIndex:v([6,10]),color:_,unlitColor:_},{textureIndex:v([7,10]),color:_,unlitColor:_},{textureIndex:v([8,10]),color:_,unlitColor:_},{textureIndex:v([9,10]),color:_,unlitColor:_}],redWallItemTiles:[{textureIndex:v([3,13]),color:_,unlitColor:N},{textureIndex:v([4,13]),color:_,unlitColor:N},{textureIndex:v([7,14]),color:_,unlitColor:N},{textureIndex:v([8,14]),color:_,unlitColor:N},{textureIndex:v([10,14]),color:_,unlitColor:N},{textureIndex:v([9,14]),color:_,unlitColor:N},{textureIndex:v([7,12]),color:_,unlitColor:N},{textureIndex:v([5,12]),color:_,unlitColor:N},{textureIndex:v([14,14]),color:_,unlitColor:N},{textureIndex:v([6,15]),color:_,unlitColor:N},{textureIndex:v([5,13]),color:_,unlitColor:_},{textureIndex:v([15,11]),color:_,unlitColor:_},{textureIndex:v([2,5]),color:P,unlitColor:b},{textureIndex:v([0,5]),color:P,unlitColor:b},{textureIndex:v([3,5]),color:P,unlitColor:b},{textureIndex:v([1,5]),color:P,unlitColor:b},{textureIndex:v([6,5]),color:P,unlitColor:b},{textureIndex:v([4,5]),color:P,unlitColor:b},{textureIndex:v([0,13]),color:_,unlitColor:_},{textureIndex:v([1,13]),color:_,unlitColor:_},{textureIndex:v([15,13]),color:ae,unlitColor:ae},{textureIndex:v([0,15]),color:_,unlitColor:_},{textureIndex:v([6,13]),color:_,unlitColor:_},{textureIndex:v([1,15]),color:_,unlitColor:_},{textureIndex:v([11,10]),color:_,unlitColor:_},{textureIndex:v([10,10]),color:_,unlitColor:_},{textureIndex:v([10,10]),color:_,unlitColor:_},{textureIndex:v([15,7]),color:_,unlitColor:N},{textureIndex:v([8,13]),color:_,unlitColor:N},{textureIndex:v([7,13]),color:_,unlitColor:N},{textureIndex:v([5,10]),color:_,unlitColor:_},{textureIndex:v([6,10]),color:_,unlitColor:_},{textureIndex:v([7,10]),color:_,unlitColor:_},{textureIndex:v([8,10]),color:_,unlitColor:_},{textureIndex:v([9,10]),color:_,unlitColor:_}],manseItemTiles:[{textureIndex:v([3,13]),color:_,unlitColor:N},{textureIndex:v([4,13]),color:_,unlitColor:N},{textureIndex:v([7,14]),color:_,unlitColor:N},{textureIndex:v([8,14]),color:_,unlitColor:N},{textureIndex:v([10,14]),color:_,unlitColor:N},{textureIndex:v([9,14]),color:_,unlitColor:N},{textureIndex:v([7,12]),color:_,unlitColor:N},{textureIndex:v([5,12]),color:_,unlitColor:N},{textureIndex:v([14,14]),color:_,unlitColor:N},{textureIndex:v([7,15]),color:_,unlitColor:N},{textureIndex:v([5,13]),color:_,unlitColor:_},{textureIndex:v([15,11]),color:_,unlitColor:_},{textureIndex:v([2,6]),color:P,unlitColor:b},{textureIndex:v([0,6]),color:P,unlitColor:b},{textureIndex:v([3,6]),color:P,unlitColor:b},{textureIndex:v([1,6]),color:P,unlitColor:b},{textureIndex:v([6,6]),color:P,unlitColor:b},{textureIndex:v([4,6]),color:P,unlitColor:b},{textureIndex:v([0,13]),color:_,unlitColor:_},{textureIndex:v([1,13]),color:_,unlitColor:_},{textureIndex:v([15,13]),color:ae,unlitColor:ae},{textureIndex:v([0,15]),color:_,unlitColor:_},{textureIndex:v([6,13]),color:_,unlitColor:_},{textureIndex:v([1,15]),color:_,unlitColor:_},{textureIndex:v([11,10]),color:_,unlitColor:_},{textureIndex:v([10,10]),color:_,unlitColor:_},{textureIndex:v([10,10]),color:_,unlitColor:_},{textureIndex:v([15,7]),color:_,unlitColor:N},{textureIndex:v([8,13]),color:_,unlitColor:N},{textureIndex:v([7,13]),color:_,unlitColor:N},{textureIndex:v([5,10]),color:_,unlitColor:_},{textureIndex:v([6,10]),color:_,unlitColor:_},{textureIndex:v([7,10]),color:_,unlitColor:_},{textureIndex:v([8,10]),color:_,unlitColor:_},{textureIndex:v([9,10]),color:_,unlitColor:_}],fortressItemTiles:[{textureIndex:v([3,13]),color:_,unlitColor:N},{textureIndex:v([4,13]),color:_,unlitColor:N},{textureIndex:v([7,14]),color:_,unlitColor:N},{textureIndex:v([8,14]),color:_,unlitColor:N},{textureIndex:v([10,14]),color:_,unlitColor:N},{textureIndex:v([9,14]),color:_,unlitColor:N},{textureIndex:v([7,12]),color:_,unlitColor:N},{textureIndex:v([5,12]),color:_,unlitColor:N},{textureIndex:v([14,14]),color:_,unlitColor:N},{textureIndex:v([8,15]),color:_,unlitColor:N},{textureIndex:v([5,13]),color:_,unlitColor:_},{textureIndex:v([15,11]),color:_,unlitColor:_},{textureIndex:v([2,7]),color:P,unlitColor:b},{textureIndex:v([0,7]),color:P,unlitColor:b},{textureIndex:v([3,7]),color:P,unlitColor:b},{textureIndex:v([1,7]),color:P,unlitColor:b},{textureIndex:v([6,7]),color:P,unlitColor:b},{textureIndex:v([4,7]),color:P,unlitColor:b},{textureIndex:v([0,13]),color:_,unlitColor:_},{textureIndex:v([1,13]),color:_,unlitColor:_},{textureIndex:v([12,13]),color:ae,unlitColor:ae},{textureIndex:v([0,15]),color:_,unlitColor:_},{textureIndex:v([6,13]),color:_,unlitColor:_},{textureIndex:v([1,15]),color:_,unlitColor:_},{textureIndex:v([11,10]),color:_,unlitColor:_},{textureIndex:v([10,10]),color:_,unlitColor:_},{textureIndex:v([10,10]),color:_,unlitColor:_},{textureIndex:v([15,7]),color:_,unlitColor:N},{textureIndex:v([8,13]),color:_,unlitColor:N},{textureIndex:v([7,13]),color:_,unlitColor:N},{textureIndex:v([5,10]),color:_,unlitColor:_},{textureIndex:v([6,10]),color:_,unlitColor:_},{textureIndex:v([7,10]),color:_,unlitColor:_},{textureIndex:v([8,10]),color:_,unlitColor:_},{textureIndex:v([9,10]),color:_,unlitColor:_}],npcTiles:[{textureIndex:v([9,8]),color:_,unlitColor:ce},{textureIndex:v([8,8]),color:_,unlitColor:ce},{textureIndex:v([10,8]),color:_,unlitColor:ce},{textureIndex:v([7,8]),color:_,unlitColor:ce},{textureIndex:v([9,8]),color:ce},{textureIndex:v([8,8]),color:ce},{textureIndex:v([10,8]),color:ce},{textureIndex:v([7,8]),color:ce},{textureIndex:v([9,8]),color:_,unlitColor:ce},{textureIndex:v([8,8]),color:_,unlitColor:ce},{textureIndex:v([10,8]),color:_,unlitColor:ce},{textureIndex:v([7,8]),color:_,unlitColor:ce},{textureIndex:v([6,8]),color:_,unlitColor:ce},{textureIndex:v([6,8]),color:_,unlitColor:ce},{textureIndex:v([6,8]),color:_,unlitColor:ce},{textureIndex:v([6,8]),color:_,unlitColor:ce}],playerTiles:{normal:{textureIndex:v([1,8]),color:_,unlitColor:Be},hidden:{textureIndex:v([0,8]),color:_,unlitColor:Be},right:{textureIndex:v([2,8]),color:_,unlitColor:Be},left:{textureIndex:v([3,8]),color:_,unlitColor:Be},down:{textureIndex:v([1,8]),color:_,unlitColor:Be},up:{textureIndex:v([4,8]),color:_,unlitColor:Be},dead:{textureIndex:v([5,8]),color:_,unlitColor:Be},litFace:{textureIndex:176,color:4294967295}},guardStateTiles:[{textureIndex:v([0,11])},{textureIndex:v([1,11])},{textureIndex:v([2,11])},{textureIndex:v([3,11])},{textureIndex:v([4,11])}],stoveAnimation:[{textureIndex:238,color:_,unlitColor:pe},{textureIndex:239,color:_,unlitColor:pe}],candleAnimation:[{textureIndex:224,color:ae,unlitColor:pe},{textureIndex:225,color:ae,unlitColor:pe},{textureIndex:226,color:ae,unlitColor:pe},{textureIndex:227,color:ae,unlitColor:pe},{textureIndex:208,color:ae,unlitColor:pe}],torchAnimation:[{textureIndex:220},{textureIndex:221},{textureIndex:222},{textureIndex:223},{textureIndex:223}],treasureGateAnimation:[{textureIndex:216},{textureIndex:200},{textureIndex:201},{textureIndex:202},{textureIndex:203}],playerTorchAnimation:[{textureIndex:217},{textureIndex:218},{textureIndex:219},{textureIndex:219}],achievementIcons:{achievementVictory:{textureIndex:75},achievementGhosty:{textureIndex:110},achievementZippy:{textureIndex:77},achievementHungry:{textureIndex:78},achievementThumpy:{textureIndex:79},achievementSofty:{textureIndex:91},achievementSteppy:{textureIndex:94},achievementHealthy:{textureIndex:107},achievementTreasure:{textureIndex:108},achievementMapping:{textureIndex:109},achievementFaceless:{textureIndex:76}},achievementIncompleteIcon:{textureIndex:63},achievementFailedIcon:{textureIndex:0}};var So={};/*!
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */var bn;function Ji(){return bn||(bn=1,function(e){(function(){var t=function(){this.init()};t.prototype={init:function(){var a=this||o;return a._counter=1e3,a._html5AudioPool=[],a.html5PoolSize=10,a._codecs={},a._howls=[],a._muted=!1,a._volume=1,a._canPlayEvent="canplaythrough",a._navigator=typeof window<"u"&&window.navigator?window.navigator:null,a.masterGain=null,a.noAudio=!1,a.usingWebAudio=!0,a.autoSuspend=!0,a.ctx=null,a.autoUnlock=!0,a._setup(),a},volume:function(a){var u=this||o;if(a=parseFloat(a),u.ctx||d(),typeof a<"u"&&a>=0&&a<=1){if(u._volume=a,u._muted)return u;u.usingWebAudio&&u.masterGain.gain.setValueAtTime(a,o.ctx.currentTime);for(var h=0;h<u._howls.length;h++)if(!u._howls[h]._webAudio)for(var p=u._howls[h]._getSoundIds(),y=0;y<p.length;y++){var g=u._howls[h]._soundById(p[y]);g&&g._node&&(g._node.volume=g._volume*a)}return u}return u._volume},mute:function(a){var u=this||o;u.ctx||d(),u._muted=a,u.usingWebAudio&&u.masterGain.gain.setValueAtTime(a?0:u._volume,o.ctx.currentTime);for(var h=0;h<u._howls.length;h++)if(!u._howls[h]._webAudio)for(var p=u._howls[h]._getSoundIds(),y=0;y<p.length;y++){var g=u._howls[h]._soundById(p[y]);g&&g._node&&(g._node.muted=a?!0:g._muted)}return u},stop:function(){for(var a=this||o,u=0;u<a._howls.length;u++)a._howls[u].stop();return a},unload:function(){for(var a=this||o,u=a._howls.length-1;u>=0;u--)a._howls[u].unload();return a.usingWebAudio&&a.ctx&&typeof a.ctx.close<"u"&&(a.ctx.close(),a.ctx=null,d()),a},codecs:function(a){return(this||o)._codecs[a.replace(/^x-/,"")]},_setup:function(){var a=this||o;if(a.state=a.ctx&&a.ctx.state||"suspended",a._autoSuspend(),!a.usingWebAudio)if(typeof Audio<"u")try{var u=new Audio;typeof u.oncanplaythrough>"u"&&(a._canPlayEvent="canplay")}catch{a.noAudio=!0}else a.noAudio=!0;try{var u=new Audio;u.muted&&(a.noAudio=!0)}catch{}return a.noAudio||a._setupCodecs(),a},_setupCodecs:function(){var a=this||o,u=null;try{u=typeof Audio<"u"?new Audio:null}catch{return a}if(!u||typeof u.canPlayType!="function")return a;var h=u.canPlayType("audio/mpeg;").replace(/^no$/,""),p=a._navigator?a._navigator.userAgent:"",y=p.match(/OPR\/(\d+)/g),g=y&&parseInt(y[0].split("/")[1],10)<33,x=p.indexOf("Safari")!==-1&&p.indexOf("Chrome")===-1,w=p.match(/Version\/(.*?) /),S=x&&w&&parseInt(w[1],10)<15;return a._codecs={mp3:!!(!g&&(h||u.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!h,opus:!!u.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!u.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!u.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(u.canPlayType('audio/wav; codecs="1"')||u.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!u.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!u.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(u.canPlayType("audio/x-m4a;")||u.canPlayType("audio/m4a;")||u.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(u.canPlayType("audio/x-m4b;")||u.canPlayType("audio/m4b;")||u.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(u.canPlayType("audio/x-mp4;")||u.canPlayType("audio/mp4;")||u.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!S&&u.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!S&&u.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!u.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(u.canPlayType("audio/x-flac;")||u.canPlayType("audio/flac;")).replace(/^no$/,"")},a},_unlockAudio:function(){var a=this||o;if(!(a._audioUnlocked||!a.ctx)){a._audioUnlocked=!1,a.autoUnlock=!1,!a._mobileUnloaded&&a.ctx.sampleRate!==44100&&(a._mobileUnloaded=!0,a.unload()),a._scratchBuffer=a.ctx.createBuffer(1,1,22050);var u=function(h){for(;a._html5AudioPool.length<a.html5PoolSize;)try{var p=new Audio;p._unlocked=!0,a._releaseHtml5Audio(p)}catch{a.noAudio=!0;break}for(var y=0;y<a._howls.length;y++)if(!a._howls[y]._webAudio)for(var g=a._howls[y]._getSoundIds(),x=0;x<g.length;x++){var w=a._howls[y]._soundById(g[x]);w&&w._node&&!w._node._unlocked&&(w._node._unlocked=!0,w._node.load())}a._autoResume();var S=a.ctx.createBufferSource();S.buffer=a._scratchBuffer,S.connect(a.ctx.destination),typeof S.start>"u"?S.noteOn(0):S.start(0),typeof a.ctx.resume=="function"&&a.ctx.resume(),S.onended=function(){S.disconnect(0),a._audioUnlocked=!0,document.removeEventListener("touchstart",u,!0),document.removeEventListener("touchend",u,!0),document.removeEventListener("click",u,!0),document.removeEventListener("keydown",u,!0);for(var T=0;T<a._howls.length;T++)a._howls[T]._emit("unlock")}};return document.addEventListener("touchstart",u,!0),document.addEventListener("touchend",u,!0),document.addEventListener("click",u,!0),document.addEventListener("keydown",u,!0),a}},_obtainHtml5Audio:function(){var a=this||o;if(a._html5AudioPool.length)return a._html5AudioPool.pop();var u=new Audio().play();return u&&typeof Promise<"u"&&(u instanceof Promise||typeof u.then=="function")&&u.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(a){var u=this||o;return a._unlocked&&u._html5AudioPool.push(a),u},_autoSuspend:function(){var a=this;if(!(!a.autoSuspend||!a.ctx||typeof a.ctx.suspend>"u"||!o.usingWebAudio)){for(var u=0;u<a._howls.length;u++)if(a._howls[u]._webAudio){for(var h=0;h<a._howls[u]._sounds.length;h++)if(!a._howls[u]._sounds[h]._paused)return a}return a._suspendTimer&&clearTimeout(a._suspendTimer),a._suspendTimer=setTimeout(function(){if(a.autoSuspend){a._suspendTimer=null,a.state="suspending";var p=function(){a.state="suspended",a._resumeAfterSuspend&&(delete a._resumeAfterSuspend,a._autoResume())};a.ctx.suspend().then(p,p)}},3e4),a}},_autoResume:function(){var a=this;if(!(!a.ctx||typeof a.ctx.resume>"u"||!o.usingWebAudio))return a.state==="running"&&a.ctx.state!=="interrupted"&&a._suspendTimer?(clearTimeout(a._suspendTimer),a._suspendTimer=null):a.state==="suspended"||a.state==="running"&&a.ctx.state==="interrupted"?(a.ctx.resume().then(function(){a.state="running";for(var u=0;u<a._howls.length;u++)a._howls[u]._emit("resume")}),a._suspendTimer&&(clearTimeout(a._suspendTimer),a._suspendTimer=null)):a.state==="suspending"&&(a._resumeAfterSuspend=!0),a}};var o=new t,n=function(a){var u=this;if(!a.src||a.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}u.init(a)};n.prototype={init:function(a){var u=this;return o.ctx||d(),u._autoplay=a.autoplay||!1,u._format=typeof a.format!="string"?a.format:[a.format],u._html5=a.html5||!1,u._muted=a.mute||!1,u._loop=a.loop||!1,u._pool=a.pool||5,u._preload=typeof a.preload=="boolean"||a.preload==="metadata"?a.preload:!0,u._rate=a.rate||1,u._sprite=a.sprite||{},u._src=typeof a.src!="string"?a.src:[a.src],u._volume=a.volume!==void 0?a.volume:1,u._xhr={method:a.xhr&&a.xhr.method?a.xhr.method:"GET",headers:a.xhr&&a.xhr.headers?a.xhr.headers:null,withCredentials:a.xhr&&a.xhr.withCredentials?a.xhr.withCredentials:!1},u._duration=0,u._state="unloaded",u._sounds=[],u._endTimers={},u._queue=[],u._playLock=!1,u._onend=a.onend?[{fn:a.onend}]:[],u._onfade=a.onfade?[{fn:a.onfade}]:[],u._onload=a.onload?[{fn:a.onload}]:[],u._onloaderror=a.onloaderror?[{fn:a.onloaderror}]:[],u._onplayerror=a.onplayerror?[{fn:a.onplayerror}]:[],u._onpause=a.onpause?[{fn:a.onpause}]:[],u._onplay=a.onplay?[{fn:a.onplay}]:[],u._onstop=a.onstop?[{fn:a.onstop}]:[],u._onmute=a.onmute?[{fn:a.onmute}]:[],u._onvolume=a.onvolume?[{fn:a.onvolume}]:[],u._onrate=a.onrate?[{fn:a.onrate}]:[],u._onseek=a.onseek?[{fn:a.onseek}]:[],u._onunlock=a.onunlock?[{fn:a.onunlock}]:[],u._onresume=[],u._webAudio=o.usingWebAudio&&!u._html5,typeof o.ctx<"u"&&o.ctx&&o.autoUnlock&&o._unlockAudio(),o._howls.push(u),u._autoplay&&u._queue.push({event:"play",action:function(){u.play()}}),u._preload&&u._preload!=="none"&&u.load(),u},load:function(){var a=this,u=null;if(o.noAudio){a._emit("loaderror",null,"No audio support.");return}typeof a._src=="string"&&(a._src=[a._src]);for(var h=0;h<a._src.length;h++){var p,y;if(a._format&&a._format[h])p=a._format[h];else{if(y=a._src[h],typeof y!="string"){a._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}p=/^data:audio\/([^;,]+);/i.exec(y),p||(p=/\.([^.]+)$/.exec(y.split("?",1)[0])),p&&(p=p[1].toLowerCase())}if(p||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),p&&o.codecs(p)){u=a._src[h];break}}if(!u){a._emit("loaderror",null,"No codec support for selected audio sources.");return}return a._src=u,a._state="loading",window.location.protocol==="https:"&&u.slice(0,5)==="http:"&&(a._html5=!0,a._webAudio=!1),new r(a),a._webAudio&&i(a),a},play:function(a,u){var h=this,p=null;if(typeof a=="number")p=a,a=null;else{if(typeof a=="string"&&h._state==="loaded"&&!h._sprite[a])return null;if(typeof a>"u"&&(a="__default",!h._playLock)){for(var y=0,g=0;g<h._sounds.length;g++)h._sounds[g]._paused&&!h._sounds[g]._ended&&(y++,p=h._sounds[g]._id);y===1?a=null:p=null}}var x=p?h._soundById(p):h._inactiveSound();if(!x)return null;if(p&&!a&&(a=x._sprite||"__default"),h._state!=="loaded"){x._sprite=a,x._ended=!1;var w=x._id;return h._queue.push({event:"play",action:function(){h.play(w)}}),w}if(p&&!x._paused)return u||h._loadQueue("play"),x._id;h._webAudio&&o._autoResume();var S=Math.max(0,x._seek>0?x._seek:h._sprite[a][0]/1e3),T=Math.max(0,(h._sprite[a][0]+h._sprite[a][1])/1e3-S),I=T*1e3/Math.abs(x._rate),D=h._sprite[a][0]/1e3,R=(h._sprite[a][0]+h._sprite[a][1])/1e3;x._sprite=a,x._ended=!1;var A=function(){x._paused=!1,x._seek=S,x._start=D,x._stop=R,x._loop=!!(x._loop||h._sprite[a][2])};if(S>=R){h._ended(x);return}var W=x._node;if(h._webAudio){var C=function(){h._playLock=!1,A(),h._refreshBuffer(x);var V=x._muted||h._muted?0:x._volume;W.gain.setValueAtTime(V,o.ctx.currentTime),x._playStart=o.ctx.currentTime,typeof W.bufferSource.start>"u"?x._loop?W.bufferSource.noteGrainOn(0,S,86400):W.bufferSource.noteGrainOn(0,S,T):x._loop?W.bufferSource.start(0,S,86400):W.bufferSource.start(0,S,T),I!==1/0&&(h._endTimers[x._id]=setTimeout(h._ended.bind(h,x),I)),u||setTimeout(function(){h._emit("play",x._id),h._loadQueue()},0)};o.state==="running"&&o.ctx.state!=="interrupted"?C():(h._playLock=!0,h.once("resume",C),h._clearTimer(x._id))}else{var k=function(){W.currentTime=S,W.muted=x._muted||h._muted||o._muted||W.muted,W.volume=x._volume*o.volume(),W.playbackRate=x._rate;try{var V=W.play();if(V&&typeof Promise<"u"&&(V instanceof Promise||typeof V.then=="function")?(h._playLock=!0,A(),V.then(function(){h._playLock=!1,W._unlocked=!0,u?h._loadQueue():h._emit("play",x._id)}).catch(function(){h._playLock=!1,h._emit("playerror",x._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),x._ended=!0,x._paused=!0})):u||(h._playLock=!1,A(),h._emit("play",x._id)),W.playbackRate=x._rate,W.paused){h._emit("playerror",x._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}a!=="__default"||x._loop?h._endTimers[x._id]=setTimeout(h._ended.bind(h,x),I):(h._endTimers[x._id]=function(){h._ended(x),W.removeEventListener("ended",h._endTimers[x._id],!1)},W.addEventListener("ended",h._endTimers[x._id],!1))}catch(Q){h._emit("playerror",x._id,Q)}};W.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(W.src=h._src,W.load());var U=window&&window.ejecta||!W.readyState&&o._navigator.isCocoonJS;if(W.readyState>=3||U)k();else{h._playLock=!0,h._state="loading";var G=function(){h._state="loaded",k(),W.removeEventListener(o._canPlayEvent,G,!1)};W.addEventListener(o._canPlayEvent,G,!1),h._clearTimer(x._id)}}return x._id},pause:function(a){var u=this;if(u._state!=="loaded"||u._playLock)return u._queue.push({event:"pause",action:function(){u.pause(a)}}),u;for(var h=u._getSoundIds(a),p=0;p<h.length;p++){u._clearTimer(h[p]);var y=u._soundById(h[p]);if(y&&!y._paused&&(y._seek=u.seek(h[p]),y._rateSeek=0,y._paused=!0,u._stopFade(h[p]),y._node))if(u._webAudio){if(!y._node.bufferSource)continue;typeof y._node.bufferSource.stop>"u"?y._node.bufferSource.noteOff(0):y._node.bufferSource.stop(0),u._cleanBuffer(y._node)}else(!isNaN(y._node.duration)||y._node.duration===1/0)&&y._node.pause();arguments[1]||u._emit("pause",y?y._id:null)}return u},stop:function(a,u){var h=this;if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"stop",action:function(){h.stop(a)}}),h;for(var p=h._getSoundIds(a),y=0;y<p.length;y++){h._clearTimer(p[y]);var g=h._soundById(p[y]);g&&(g._seek=g._start||0,g._rateSeek=0,g._paused=!0,g._ended=!0,h._stopFade(p[y]),g._node&&(h._webAudio?g._node.bufferSource&&(typeof g._node.bufferSource.stop>"u"?g._node.bufferSource.noteOff(0):g._node.bufferSource.stop(0),h._cleanBuffer(g._node)):(!isNaN(g._node.duration)||g._node.duration===1/0)&&(g._node.currentTime=g._start||0,g._node.pause(),g._node.duration===1/0&&h._clearSound(g._node))),u||h._emit("stop",g._id))}return h},mute:function(a,u){var h=this;if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"mute",action:function(){h.mute(a,u)}}),h;if(typeof u>"u")if(typeof a=="boolean")h._muted=a;else return h._muted;for(var p=h._getSoundIds(u),y=0;y<p.length;y++){var g=h._soundById(p[y]);g&&(g._muted=a,g._interval&&h._stopFade(g._id),h._webAudio&&g._node?g._node.gain.setValueAtTime(a?0:g._volume,o.ctx.currentTime):g._node&&(g._node.muted=o._muted?!0:a),h._emit("mute",g._id))}return h},volume:function(){var a=this,u=arguments,h,p;if(u.length===0)return a._volume;if(u.length===1||u.length===2&&typeof u[1]>"u"){var y=a._getSoundIds(),g=y.indexOf(u[0]);g>=0?p=parseInt(u[0],10):h=parseFloat(u[0])}else u.length>=2&&(h=parseFloat(u[0]),p=parseInt(u[1],10));var x;if(typeof h<"u"&&h>=0&&h<=1){if(a._state!=="loaded"||a._playLock)return a._queue.push({event:"volume",action:function(){a.volume.apply(a,u)}}),a;typeof p>"u"&&(a._volume=h),p=a._getSoundIds(p);for(var w=0;w<p.length;w++)x=a._soundById(p[w]),x&&(x._volume=h,u[2]||a._stopFade(p[w]),a._webAudio&&x._node&&!x._muted?x._node.gain.setValueAtTime(h,o.ctx.currentTime):x._node&&!x._muted&&(x._node.volume=h*o.volume()),a._emit("volume",x._id))}else return x=p?a._soundById(p):a._sounds[0],x?x._volume:0;return a},fade:function(a,u,h,p){var y=this;if(y._state!=="loaded"||y._playLock)return y._queue.push({event:"fade",action:function(){y.fade(a,u,h,p)}}),y;a=Math.min(Math.max(0,parseFloat(a)),1),u=Math.min(Math.max(0,parseFloat(u)),1),h=parseFloat(h),y.volume(a,p);for(var g=y._getSoundIds(p),x=0;x<g.length;x++){var w=y._soundById(g[x]);if(w){if(p||y._stopFade(g[x]),y._webAudio&&!w._muted){var S=o.ctx.currentTime,T=S+h/1e3;w._volume=a,w._node.gain.setValueAtTime(a,S),w._node.gain.linearRampToValueAtTime(u,T)}y._startFadeInterval(w,a,u,h,g[x],typeof p>"u")}}return y},_startFadeInterval:function(a,u,h,p,y,g){var x=this,w=u,S=h-u,T=Math.abs(S/.01),I=Math.max(4,T>0?p/T:p),D=Date.now();a._fadeTo=h,a._interval=setInterval(function(){var R=(Date.now()-D)/p;D=Date.now(),w+=S*R,w=Math.round(w*100)/100,S<0?w=Math.max(h,w):w=Math.min(h,w),x._webAudio?a._volume=w:x.volume(w,a._id,!0),g&&(x._volume=w),(h<u&&w<=h||h>u&&w>=h)&&(clearInterval(a._interval),a._interval=null,a._fadeTo=null,x.volume(h,a._id),x._emit("fade",a._id))},I)},_stopFade:function(a){var u=this,h=u._soundById(a);return h&&h._interval&&(u._webAudio&&h._node.gain.cancelScheduledValues(o.ctx.currentTime),clearInterval(h._interval),h._interval=null,u.volume(h._fadeTo,a),h._fadeTo=null,u._emit("fade",a)),u},loop:function(){var a=this,u=arguments,h,p,y;if(u.length===0)return a._loop;if(u.length===1)if(typeof u[0]=="boolean")h=u[0],a._loop=h;else return y=a._soundById(parseInt(u[0],10)),y?y._loop:!1;else u.length===2&&(h=u[0],p=parseInt(u[1],10));for(var g=a._getSoundIds(p),x=0;x<g.length;x++)y=a._soundById(g[x]),y&&(y._loop=h,a._webAudio&&y._node&&y._node.bufferSource&&(y._node.bufferSource.loop=h,h&&(y._node.bufferSource.loopStart=y._start||0,y._node.bufferSource.loopEnd=y._stop,a.playing(g[x])&&(a.pause(g[x],!0),a.play(g[x],!0)))));return a},rate:function(){var a=this,u=arguments,h,p;if(u.length===0)p=a._sounds[0]._id;else if(u.length===1){var y=a._getSoundIds(),g=y.indexOf(u[0]);g>=0?p=parseInt(u[0],10):h=parseFloat(u[0])}else u.length===2&&(h=parseFloat(u[0]),p=parseInt(u[1],10));var x;if(typeof h=="number"){if(a._state!=="loaded"||a._playLock)return a._queue.push({event:"rate",action:function(){a.rate.apply(a,u)}}),a;typeof p>"u"&&(a._rate=h),p=a._getSoundIds(p);for(var w=0;w<p.length;w++)if(x=a._soundById(p[w]),x){a.playing(p[w])&&(x._rateSeek=a.seek(p[w]),x._playStart=a._webAudio?o.ctx.currentTime:x._playStart),x._rate=h,a._webAudio&&x._node&&x._node.bufferSource?x._node.bufferSource.playbackRate.setValueAtTime(h,o.ctx.currentTime):x._node&&(x._node.playbackRate=h);var S=a.seek(p[w]),T=(a._sprite[x._sprite][0]+a._sprite[x._sprite][1])/1e3-S,I=T*1e3/Math.abs(x._rate);(a._endTimers[p[w]]||!x._paused)&&(a._clearTimer(p[w]),a._endTimers[p[w]]=setTimeout(a._ended.bind(a,x),I)),a._emit("rate",x._id)}}else return x=a._soundById(p),x?x._rate:a._rate;return a},seek:function(){var a=this,u=arguments,h,p;if(u.length===0)a._sounds.length&&(p=a._sounds[0]._id);else if(u.length===1){var y=a._getSoundIds(),g=y.indexOf(u[0]);g>=0?p=parseInt(u[0],10):a._sounds.length&&(p=a._sounds[0]._id,h=parseFloat(u[0]))}else u.length===2&&(h=parseFloat(u[0]),p=parseInt(u[1],10));if(typeof p>"u")return 0;if(typeof h=="number"&&(a._state!=="loaded"||a._playLock))return a._queue.push({event:"seek",action:function(){a.seek.apply(a,u)}}),a;var x=a._soundById(p);if(x)if(typeof h=="number"&&h>=0){var w=a.playing(p);w&&a.pause(p,!0),x._seek=h,x._ended=!1,a._clearTimer(p),!a._webAudio&&x._node&&!isNaN(x._node.duration)&&(x._node.currentTime=h);var S=function(){w&&a.play(p,!0),a._emit("seek",p)};if(w&&!a._webAudio){var T=function(){a._playLock?setTimeout(T,0):S()};setTimeout(T,0)}else S()}else if(a._webAudio){var I=a.playing(p)?o.ctx.currentTime-x._playStart:0,D=x._rateSeek?x._rateSeek-x._seek:0;return x._seek+(D+I*Math.abs(x._rate))}else return x._node.currentTime;return a},playing:function(a){var u=this;if(typeof a=="number"){var h=u._soundById(a);return h?!h._paused:!1}for(var p=0;p<u._sounds.length;p++)if(!u._sounds[p]._paused)return!0;return!1},duration:function(a){var u=this,h=u._duration,p=u._soundById(a);return p&&(h=u._sprite[p._sprite][1]/1e3),h},state:function(){return this._state},unload:function(){for(var a=this,u=a._sounds,h=0;h<u.length;h++)u[h]._paused||a.stop(u[h]._id),a._webAudio||(a._clearSound(u[h]._node),u[h]._node.removeEventListener("error",u[h]._errorFn,!1),u[h]._node.removeEventListener(o._canPlayEvent,u[h]._loadFn,!1),u[h]._node.removeEventListener("ended",u[h]._endFn,!1),o._releaseHtml5Audio(u[h]._node)),delete u[h]._node,a._clearTimer(u[h]._id);var p=o._howls.indexOf(a);p>=0&&o._howls.splice(p,1);var y=!0;for(h=0;h<o._howls.length;h++)if(o._howls[h]._src===a._src||a._src.indexOf(o._howls[h]._src)>=0){y=!1;break}return s&&y&&delete s[a._src],o.noAudio=!1,a._state="unloaded",a._sounds=[],a=null,null},on:function(a,u,h,p){var y=this,g=y["_on"+a];return typeof u=="function"&&g.push(p?{id:h,fn:u,once:p}:{id:h,fn:u}),y},off:function(a,u,h){var p=this,y=p["_on"+a],g=0;if(typeof u=="number"&&(h=u,u=null),u||h)for(g=0;g<y.length;g++){var x=h===y[g].id;if(u===y[g].fn&&x||!u&&x){y.splice(g,1);break}}else if(a)p["_on"+a]=[];else{var w=Object.keys(p);for(g=0;g<w.length;g++)w[g].indexOf("_on")===0&&Array.isArray(p[w[g]])&&(p[w[g]]=[])}return p},once:function(a,u,h){var p=this;return p.on(a,u,h,1),p},_emit:function(a,u,h){for(var p=this,y=p["_on"+a],g=y.length-1;g>=0;g--)(!y[g].id||y[g].id===u||a==="load")&&(setTimeout((function(x){x.call(this,u,h)}).bind(p,y[g].fn),0),y[g].once&&p.off(a,y[g].fn,y[g].id));return p._loadQueue(a),p},_loadQueue:function(a){var u=this;if(u._queue.length>0){var h=u._queue[0];h.event===a&&(u._queue.shift(),u._loadQueue()),a||h.action()}return u},_ended:function(a){var u=this,h=a._sprite;if(!u._webAudio&&a._node&&!a._node.paused&&!a._node.ended&&a._node.currentTime<a._stop)return setTimeout(u._ended.bind(u,a),100),u;var p=!!(a._loop||u._sprite[h][2]);if(u._emit("end",a._id),!u._webAudio&&p&&u.stop(a._id,!0).play(a._id),u._webAudio&&p){u._emit("play",a._id),a._seek=a._start||0,a._rateSeek=0,a._playStart=o.ctx.currentTime;var y=(a._stop-a._start)*1e3/Math.abs(a._rate);u._endTimers[a._id]=setTimeout(u._ended.bind(u,a),y)}return u._webAudio&&!p&&(a._paused=!0,a._ended=!0,a._seek=a._start||0,a._rateSeek=0,u._clearTimer(a._id),u._cleanBuffer(a._node),o._autoSuspend()),!u._webAudio&&!p&&u.stop(a._id,!0),u},_clearTimer:function(a){var u=this;if(u._endTimers[a]){if(typeof u._endTimers[a]!="function")clearTimeout(u._endTimers[a]);else{var h=u._soundById(a);h&&h._node&&h._node.removeEventListener("ended",u._endTimers[a],!1)}delete u._endTimers[a]}return u},_soundById:function(a){for(var u=this,h=0;h<u._sounds.length;h++)if(a===u._sounds[h]._id)return u._sounds[h];return null},_inactiveSound:function(){var a=this;a._drain();for(var u=0;u<a._sounds.length;u++)if(a._sounds[u]._ended)return a._sounds[u].reset();return new r(a)},_drain:function(){var a=this,u=a._pool,h=0,p=0;if(!(a._sounds.length<u)){for(p=0;p<a._sounds.length;p++)a._sounds[p]._ended&&h++;for(p=a._sounds.length-1;p>=0;p--){if(h<=u)return;a._sounds[p]._ended&&(a._webAudio&&a._sounds[p]._node&&a._sounds[p]._node.disconnect(0),a._sounds.splice(p,1),h--)}}},_getSoundIds:function(a){var u=this;if(typeof a>"u"){for(var h=[],p=0;p<u._sounds.length;p++)h.push(u._sounds[p]._id);return h}else return[a]},_refreshBuffer:function(a){var u=this;return a._node.bufferSource=o.ctx.createBufferSource(),a._node.bufferSource.buffer=s[u._src],a._panner?a._node.bufferSource.connect(a._panner):a._node.bufferSource.connect(a._node),a._node.bufferSource.loop=a._loop,a._loop&&(a._node.bufferSource.loopStart=a._start||0,a._node.bufferSource.loopEnd=a._stop||0),a._node.bufferSource.playbackRate.setValueAtTime(a._rate,o.ctx.currentTime),u},_cleanBuffer:function(a){var u=this,h=o._navigator&&o._navigator.vendor.indexOf("Apple")>=0;if(!a.bufferSource)return u;if(o._scratchBuffer&&a.bufferSource&&(a.bufferSource.onended=null,a.bufferSource.disconnect(0),h))try{a.bufferSource.buffer=o._scratchBuffer}catch{}return a.bufferSource=null,u},_clearSound:function(a){var u=/MSIE |Trident\//.test(o._navigator&&o._navigator.userAgent);u||(a.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var r=function(a){this._parent=a,this.init()};r.prototype={init:function(){var a=this,u=a._parent;return a._muted=u._muted,a._loop=u._loop,a._volume=u._volume,a._rate=u._rate,a._seek=0,a._paused=!0,a._ended=!0,a._sprite="__default",a._id=++o._counter,u._sounds.push(a),a.create(),a},create:function(){var a=this,u=a._parent,h=o._muted||a._muted||a._parent._muted?0:a._volume;return u._webAudio?(a._node=typeof o.ctx.createGain>"u"?o.ctx.createGainNode():o.ctx.createGain(),a._node.gain.setValueAtTime(h,o.ctx.currentTime),a._node.paused=!0,a._node.connect(o.masterGain)):o.noAudio||(a._node=o._obtainHtml5Audio(),a._errorFn=a._errorListener.bind(a),a._node.addEventListener("error",a._errorFn,!1),a._loadFn=a._loadListener.bind(a),a._node.addEventListener(o._canPlayEvent,a._loadFn,!1),a._endFn=a._endListener.bind(a),a._node.addEventListener("ended",a._endFn,!1),a._node.src=u._src,a._node.preload=u._preload===!0?"auto":u._preload,a._node.volume=h*o.volume(),a._node.load()),a},reset:function(){var a=this,u=a._parent;return a._muted=u._muted,a._loop=u._loop,a._volume=u._volume,a._rate=u._rate,a._seek=0,a._rateSeek=0,a._paused=!0,a._ended=!0,a._sprite="__default",a._id=++o._counter,a},_errorListener:function(){var a=this;a._parent._emit("loaderror",a._id,a._node.error?a._node.error.code:0),a._node.removeEventListener("error",a._errorFn,!1)},_loadListener:function(){var a=this,u=a._parent;u._duration=Math.ceil(a._node.duration*10)/10,Object.keys(u._sprite).length===0&&(u._sprite={__default:[0,u._duration*1e3]}),u._state!=="loaded"&&(u._state="loaded",u._emit("load"),u._loadQueue()),a._node.removeEventListener(o._canPlayEvent,a._loadFn,!1)},_endListener:function(){var a=this,u=a._parent;u._duration===1/0&&(u._duration=Math.ceil(a._node.duration*10)/10,u._sprite.__default[1]===1/0&&(u._sprite.__default[1]=u._duration*1e3),u._ended(a)),a._node.removeEventListener("ended",a._endFn,!1)}};var s={},i=function(a){var u=a._src;if(s[u]){a._duration=s[u].duration,f(a);return}if(/^data:[^;]+;base64,/.test(u)){for(var h=atob(u.split(",")[1]),p=new Uint8Array(h.length),y=0;y<h.length;++y)p[y]=h.charCodeAt(y);l(p.buffer,a)}else{var g=new XMLHttpRequest;g.open(a._xhr.method,u,!0),g.withCredentials=a._xhr.withCredentials,g.responseType="arraybuffer",a._xhr.headers&&Object.keys(a._xhr.headers).forEach(function(x){g.setRequestHeader(x,a._xhr.headers[x])}),g.onload=function(){var x=(g.status+"")[0];if(x!=="0"&&x!=="2"&&x!=="3"){a._emit("loaderror",null,"Failed loading audio file with status: "+g.status+".");return}l(g.response,a)},g.onerror=function(){a._webAudio&&(a._html5=!0,a._webAudio=!1,a._sounds=[],delete s[u],a.load())},c(g)}},c=function(a){try{a.send()}catch{a.onerror()}},l=function(a,u){var h=function(){u._emit("loaderror",null,"Decoding audio data failed.")},p=function(y){y&&u._sounds.length>0?(s[u._src]=y,f(u,y)):h()};typeof Promise<"u"&&o.ctx.decodeAudioData.length===1?o.ctx.decodeAudioData(a).then(p).catch(h):o.ctx.decodeAudioData(a,p,h)},f=function(a,u){u&&!a._duration&&(a._duration=u.duration),Object.keys(a._sprite).length===0&&(a._sprite={__default:[0,a._duration*1e3]}),a._state!=="loaded"&&(a._state="loaded",a._emit("load"),a._loadQueue())},d=function(){if(o.usingWebAudio){try{typeof AudioContext<"u"?o.ctx=new AudioContext:typeof webkitAudioContext<"u"?o.ctx=new webkitAudioContext:o.usingWebAudio=!1}catch{o.usingWebAudio=!1}o.ctx||(o.usingWebAudio=!1);var a=/iP(hone|od|ad)/.test(o._navigator&&o._navigator.platform),u=o._navigator&&o._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),h=u?parseInt(u[1],10):null;if(a&&h&&h<9){var p=/safari/.test(o._navigator&&o._navigator.userAgent.toLowerCase());o._navigator&&!p&&(o.usingWebAudio=!1)}o.usingWebAudio&&(o.masterGain=typeof o.ctx.createGain>"u"?o.ctx.createGainNode():o.ctx.createGain(),o.masterGain.gain.setValueAtTime(o._muted?0:o._volume,o.ctx.currentTime),o.masterGain.connect(o.ctx.destination)),o._setup()}};e.Howler=o,e.Howl=n,typeof ct<"u"?(ct.HowlerGlobal=t,ct.Howler=o,ct.Howl=n,ct.Sound=r):typeof window<"u"&&(window.HowlerGlobal=t,window.Howler=o,window.Howl=n,window.Sound=r)})();/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(o){var n=this;if(!n.ctx||!n.ctx.listener)return n;for(var r=n._howls.length-1;r>=0;r--)n._howls[r].stereo(o);return n},HowlerGlobal.prototype.pos=function(o,n,r){var s=this;if(!s.ctx||!s.ctx.listener)return s;if(n=typeof n!="number"?s._pos[1]:n,r=typeof r!="number"?s._pos[2]:r,typeof o=="number")s._pos=[o,n,r],typeof s.ctx.listener.positionX<"u"?(s.ctx.listener.positionX.setTargetAtTime(s._pos[0],Howler.ctx.currentTime,.1),s.ctx.listener.positionY.setTargetAtTime(s._pos[1],Howler.ctx.currentTime,.1),s.ctx.listener.positionZ.setTargetAtTime(s._pos[2],Howler.ctx.currentTime,.1)):s.ctx.listener.setPosition(s._pos[0],s._pos[1],s._pos[2]);else return s._pos;return s},HowlerGlobal.prototype.orientation=function(o,n,r,s,i,c){var l=this;if(!l.ctx||!l.ctx.listener)return l;var f=l._orientation;if(n=typeof n!="number"?f[1]:n,r=typeof r!="number"?f[2]:r,s=typeof s!="number"?f[3]:s,i=typeof i!="number"?f[4]:i,c=typeof c!="number"?f[5]:c,typeof o=="number")l._orientation=[o,n,r,s,i,c],typeof l.ctx.listener.forwardX<"u"?(l.ctx.listener.forwardX.setTargetAtTime(o,Howler.ctx.currentTime,.1),l.ctx.listener.forwardY.setTargetAtTime(n,Howler.ctx.currentTime,.1),l.ctx.listener.forwardZ.setTargetAtTime(r,Howler.ctx.currentTime,.1),l.ctx.listener.upX.setTargetAtTime(s,Howler.ctx.currentTime,.1),l.ctx.listener.upY.setTargetAtTime(i,Howler.ctx.currentTime,.1),l.ctx.listener.upZ.setTargetAtTime(c,Howler.ctx.currentTime,.1)):l.ctx.listener.setOrientation(o,n,r,s,i,c);else return f;return l},Howl.prototype.init=function(o){return function(n){var r=this;return r._orientation=n.orientation||[1,0,0],r._stereo=n.stereo||null,r._pos=n.pos||null,r._pannerAttr={coneInnerAngle:typeof n.coneInnerAngle<"u"?n.coneInnerAngle:360,coneOuterAngle:typeof n.coneOuterAngle<"u"?n.coneOuterAngle:360,coneOuterGain:typeof n.coneOuterGain<"u"?n.coneOuterGain:0,distanceModel:typeof n.distanceModel<"u"?n.distanceModel:"inverse",maxDistance:typeof n.maxDistance<"u"?n.maxDistance:1e4,panningModel:typeof n.panningModel<"u"?n.panningModel:"HRTF",refDistance:typeof n.refDistance<"u"?n.refDistance:1,rolloffFactor:typeof n.rolloffFactor<"u"?n.rolloffFactor:1},r._onstereo=n.onstereo?[{fn:n.onstereo}]:[],r._onpos=n.onpos?[{fn:n.onpos}]:[],r._onorientation=n.onorientation?[{fn:n.onorientation}]:[],o.call(this,n)}}(Howl.prototype.init),Howl.prototype.stereo=function(o,n){var r=this;if(!r._webAudio)return r;if(r._state!=="loaded")return r._queue.push({event:"stereo",action:function(){r.stereo(o,n)}}),r;var s=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof n>"u")if(typeof o=="number")r._stereo=o,r._pos=[o,0,0];else return r._stereo;for(var i=r._getSoundIds(n),c=0;c<i.length;c++){var l=r._soundById(i[c]);if(l)if(typeof o=="number")l._stereo=o,l._pos=[o,0,0],l._node&&(l._pannerAttr.panningModel="equalpower",(!l._panner||!l._panner.pan)&&t(l,s),s==="spatial"?typeof l._panner.positionX<"u"?(l._panner.positionX.setValueAtTime(o,Howler.ctx.currentTime),l._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),l._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):l._panner.setPosition(o,0,0):l._panner.pan.setValueAtTime(o,Howler.ctx.currentTime)),r._emit("stereo",l._id);else return l._stereo}return r},Howl.prototype.pos=function(o,n,r,s){var i=this;if(!i._webAudio)return i;if(i._state!=="loaded")return i._queue.push({event:"pos",action:function(){i.pos(o,n,r,s)}}),i;if(n=typeof n!="number"?0:n,r=typeof r!="number"?-.5:r,typeof s>"u")if(typeof o=="number")i._pos=[o,n,r];else return i._pos;for(var c=i._getSoundIds(s),l=0;l<c.length;l++){var f=i._soundById(c[l]);if(f)if(typeof o=="number")f._pos=[o,n,r],f._node&&((!f._panner||f._panner.pan)&&t(f,"spatial"),typeof f._panner.positionX<"u"?(f._panner.positionX.setValueAtTime(o,Howler.ctx.currentTime),f._panner.positionY.setValueAtTime(n,Howler.ctx.currentTime),f._panner.positionZ.setValueAtTime(r,Howler.ctx.currentTime)):f._panner.setPosition(o,n,r)),i._emit("pos",f._id);else return f._pos}return i},Howl.prototype.orientation=function(o,n,r,s){var i=this;if(!i._webAudio)return i;if(i._state!=="loaded")return i._queue.push({event:"orientation",action:function(){i.orientation(o,n,r,s)}}),i;if(n=typeof n!="number"?i._orientation[1]:n,r=typeof r!="number"?i._orientation[2]:r,typeof s>"u")if(typeof o=="number")i._orientation=[o,n,r];else return i._orientation;for(var c=i._getSoundIds(s),l=0;l<c.length;l++){var f=i._soundById(c[l]);if(f)if(typeof o=="number")f._orientation=[o,n,r],f._node&&(f._panner||(f._pos||(f._pos=i._pos||[0,0,-.5]),t(f,"spatial")),typeof f._panner.orientationX<"u"?(f._panner.orientationX.setValueAtTime(o,Howler.ctx.currentTime),f._panner.orientationY.setValueAtTime(n,Howler.ctx.currentTime),f._panner.orientationZ.setValueAtTime(r,Howler.ctx.currentTime)):f._panner.setOrientation(o,n,r)),i._emit("orientation",f._id);else return f._orientation}return i},Howl.prototype.pannerAttr=function(){var o=this,n=arguments,r,s,i;if(!o._webAudio)return o;if(n.length===0)return o._pannerAttr;if(n.length===1)if(typeof n[0]=="object")r=n[0],typeof s>"u"&&(r.pannerAttr||(r.pannerAttr={coneInnerAngle:r.coneInnerAngle,coneOuterAngle:r.coneOuterAngle,coneOuterGain:r.coneOuterGain,distanceModel:r.distanceModel,maxDistance:r.maxDistance,refDistance:r.refDistance,rolloffFactor:r.rolloffFactor,panningModel:r.panningModel}),o._pannerAttr={coneInnerAngle:typeof r.pannerAttr.coneInnerAngle<"u"?r.pannerAttr.coneInnerAngle:o._coneInnerAngle,coneOuterAngle:typeof r.pannerAttr.coneOuterAngle<"u"?r.pannerAttr.coneOuterAngle:o._coneOuterAngle,coneOuterGain:typeof r.pannerAttr.coneOuterGain<"u"?r.pannerAttr.coneOuterGain:o._coneOuterGain,distanceModel:typeof r.pannerAttr.distanceModel<"u"?r.pannerAttr.distanceModel:o._distanceModel,maxDistance:typeof r.pannerAttr.maxDistance<"u"?r.pannerAttr.maxDistance:o._maxDistance,refDistance:typeof r.pannerAttr.refDistance<"u"?r.pannerAttr.refDistance:o._refDistance,rolloffFactor:typeof r.pannerAttr.rolloffFactor<"u"?r.pannerAttr.rolloffFactor:o._rolloffFactor,panningModel:typeof r.pannerAttr.panningModel<"u"?r.pannerAttr.panningModel:o._panningModel});else return i=o._soundById(parseInt(n[0],10)),i?i._pannerAttr:o._pannerAttr;else n.length===2&&(r=n[0],s=parseInt(n[1],10));for(var c=o._getSoundIds(s),l=0;l<c.length;l++)if(i=o._soundById(c[l]),i){var f=i._pannerAttr;f={coneInnerAngle:typeof r.coneInnerAngle<"u"?r.coneInnerAngle:f.coneInnerAngle,coneOuterAngle:typeof r.coneOuterAngle<"u"?r.coneOuterAngle:f.coneOuterAngle,coneOuterGain:typeof r.coneOuterGain<"u"?r.coneOuterGain:f.coneOuterGain,distanceModel:typeof r.distanceModel<"u"?r.distanceModel:f.distanceModel,maxDistance:typeof r.maxDistance<"u"?r.maxDistance:f.maxDistance,refDistance:typeof r.refDistance<"u"?r.refDistance:f.refDistance,rolloffFactor:typeof r.rolloffFactor<"u"?r.rolloffFactor:f.rolloffFactor,panningModel:typeof r.panningModel<"u"?r.panningModel:f.panningModel};var d=i._panner;d||(i._pos||(i._pos=o._pos||[0,0,-.5]),t(i,"spatial"),d=i._panner),d.coneInnerAngle=f.coneInnerAngle,d.coneOuterAngle=f.coneOuterAngle,d.coneOuterGain=f.coneOuterGain,d.distanceModel=f.distanceModel,d.maxDistance=f.maxDistance,d.refDistance=f.refDistance,d.rolloffFactor=f.rolloffFactor,d.panningModel=f.panningModel}return o},Sound.prototype.init=function(o){return function(){var n=this,r=n._parent;n._orientation=r._orientation,n._stereo=r._stereo,n._pos=r._pos,n._pannerAttr=r._pannerAttr,o.call(this),n._stereo?r.stereo(n._stereo):n._pos&&r.pos(n._pos[0],n._pos[1],n._pos[2],n._id)}}(Sound.prototype.init),Sound.prototype.reset=function(o){return function(){var n=this,r=n._parent;return n._orientation=r._orientation,n._stereo=r._stereo,n._pos=r._pos,n._pannerAttr=r._pannerAttr,n._stereo?r.stereo(n._stereo):n._pos?r.pos(n._pos[0],n._pos[1],n._pos[2],n._id):n._panner&&(n._panner.disconnect(0),n._panner=void 0,r._refreshBuffer(n)),o.call(this)}}(Sound.prototype.reset);var t=function(o,n){n=n||"spatial",n==="spatial"?(o._panner=Howler.ctx.createPanner(),o._panner.coneInnerAngle=o._pannerAttr.coneInnerAngle,o._panner.coneOuterAngle=o._pannerAttr.coneOuterAngle,o._panner.coneOuterGain=o._pannerAttr.coneOuterGain,o._panner.distanceModel=o._pannerAttr.distanceModel,o._panner.maxDistance=o._pannerAttr.maxDistance,o._panner.refDistance=o._pannerAttr.refDistance,o._panner.rolloffFactor=o._pannerAttr.rolloffFactor,o._panner.panningModel=o._pannerAttr.panningModel,typeof o._panner.positionX<"u"?(o._panner.positionX.setValueAtTime(o._pos[0],Howler.ctx.currentTime),o._panner.positionY.setValueAtTime(o._pos[1],Howler.ctx.currentTime),o._panner.positionZ.setValueAtTime(o._pos[2],Howler.ctx.currentTime)):o._panner.setPosition(o._pos[0],o._pos[1],o._pos[2]),typeof o._panner.orientationX<"u"?(o._panner.orientationX.setValueAtTime(o._orientation[0],Howler.ctx.currentTime),o._panner.orientationY.setValueAtTime(o._orientation[1],Howler.ctx.currentTime),o._panner.orientationZ.setValueAtTime(o._orientation[2],Howler.ctx.currentTime)):o._panner.setOrientation(o._orientation[0],o._orientation[1],o._orientation[2])):(o._panner=Howler.ctx.createStereoPanner(),o._panner.pan.setValueAtTime(o._stereo,Howler.ctx.currentTime)),o._panner.connect(o._node),o._paused||o._parent.pause(o._id,!0).play(o._id,!0)}})()}(So)),So}var _e=Ji();const ea=new URL("/assets/Minstrel_Dance-X_vCE5oX.mp3",import.meta.url).href,ta=new URL("/assets/level-requirement-1-51Akcf6k.mp3",import.meta.url).href,oa=new URL("/assets/level-requirement-2-dBUrQWre.mp3",import.meta.url).href,na=new URL("/assets/lose-game-over-BJI1e-jw.mp3",import.meta.url).href,ra=new URL("/assets/Minstrel%20Dance%20Easter%20Egg-CaFPybPQ.mp3",import.meta.url).href,sa=new URL("/assets/footstep-wood-CAaq9hk4.mp3",import.meta.url).href,ia=new URL("/assets/footstep-tile-CLxXkglO.mp3",import.meta.url).href,aa=new URL("/assets/footstep-water-D5rjSR4q.mp3",import.meta.url).href,la=new URL("/assets/footstep-gravel-vO9Sbp5J.mp3",import.meta.url).href,ua=new URL("/assets/footstep-grass-B1MPBfL0.mp3",import.meta.url).href,ca=[new URL("/assets/creak-7-BMALNjdm.mp3",import.meta.url).href,new URL("/assets/creak-8-CULQRzou.mp3",import.meta.url).href,new URL("/assets/creak-9-Da723QtP.mp3",import.meta.url).href,new URL("/assets/creak-10-CAI3ZXT1.mp3",import.meta.url).href,new URL("/assets/creak-11-nZbq4BaO.mp3",import.meta.url).href,new URL("/assets/creak-12-yEEUndMI.mp3",import.meta.url).href],fa=[new URL("/assets/hit16.mp3-HI9sSH9B.flac",import.meta.url).href,new URL("/assets/hit17.mp3-wofnxBob.flac",import.meta.url).href,new URL("/assets/hit18.mp3-CL-HqelL.flac",import.meta.url).href,new URL("/assets/hit19.mp3-Bj5HXXaX.flac",import.meta.url).href,new URL("/assets/hit20.mp3-C2lDU7Zu.flac",import.meta.url).href,new URL("/assets/hit26.mp3-DIhyqtQe.flac",import.meta.url).href,new URL("/assets/hit27.mp3-Btc6doDb.flac",import.meta.url).href],ha=[new URL("/assets/hit26.mp3-DIhyqtQe.flac",import.meta.url).href],da=[new URL("/assets/coin-rattle-CbG-oBRs.mp3",import.meta.url).href],pa=[new URL("/assets/coin-Dce4gnif.mp3",import.meta.url).href,new URL("/assets/coin-2-BcLejo1B.mp3",import.meta.url).href,new URL("/assets/coin-3-BBhU8Azf.mp3",import.meta.url).href,new URL("/assets/coin-4-CelVFqgU.mp3",import.meta.url).href,new URL("/assets/coin-5-DHB1kDeZ.mp3",import.meta.url).href],ma=[new URL("/assets/grunt-BC482oMt.mp3",import.meta.url).href,new URL("/assets/grunt-2-imoQwLJd.mp3",import.meta.url).href,new URL("/assets/grunt-3-Du33tobN.mp3",import.meta.url).href,new URL("/assets/grunt-4-Dby3ZH7J.mp3",import.meta.url).href,new URL("/assets/grunt-5-CDyLt-qL.mp3",import.meta.url).href,new URL("/assets/grunt-6-Bq15K2kw.mp3",import.meta.url).href,new URL("/assets/grunt-7-CztSOZhR.mp3",import.meta.url).href,new URL("/assets/grunt-8-CY2xIZi5.mp3",import.meta.url).href],ga=[new URL("/assets/douse-CKaP5dpa.mp3",import.meta.url).href,new URL("/assets/douse-2-DW49UBJe.mp3",import.meta.url).href,new URL("/assets/douse-CKaP5dpa.mp3",import.meta.url).href,new URL("/assets/douse-4-BTpU24-m.mp3",import.meta.url).href],ya=[new URL("/assets/chiming-clock-short-DUcG5V6r.mp3",import.meta.url).href],xa=[new URL("/assets/ticking-clock-Dj08k1dg.mp3",import.meta.url).href],va=[new URL("/assets/eating-DF0VRIf2.mp3",import.meta.url).href],Ma=[new URL("/assets/grab-key-BqakT9pL.mp3",import.meta.url).href,new URL("/assets/grab-key-2-p1XAf2xb.mp3",import.meta.url).href],wa=[new URL("/assets/ignite-CoYN3Tcq.mp3",import.meta.url).href,new URL("/assets/ignite-2-B65LqdAF.mp3",import.meta.url).href],Sa=[new URL("/assets/hide-Rl8m43d-.mp3",import.meta.url).href,new URL("/assets/hide-2-CmzeYPtR.mp3",import.meta.url).href,new URL("/assets/hide-3-BT_y0wO8.mp3",import.meta.url).href,new URL("/assets/hide-4-DHH36ptO.mp3",import.meta.url).href,new URL("/assets/hide-5-B21Pubg5.mp3",import.meta.url).href,new URL("/assets/hide-6-DX89Qcop.mp3",import.meta.url).href],Ta=[new URL("/assets/gate-BtEvjVhM.mp3",import.meta.url).href,new URL("/assets/gate-2-D5_0QAOO.mp3",import.meta.url).href,new URL("/assets/gate-3-DQEXdbhi.mp3",import.meta.url).href,new URL("/assets/gate-4-bXWoeOTq.mp3",import.meta.url).href,new URL("/assets/gate-5-ByD8Fymg.mp3",import.meta.url).href],_a=[new URL("/assets/thump-NMw-fPHs.mp3",import.meta.url).href],La=[new URL("/assets/splash1-C_-cvewc.mp3",import.meta.url).href,new URL("/assets/splash2-BKNjMywr.mp3",import.meta.url).href],Ra=[new URL("/assets/water-ambient-XaTqHQGf.mp3",import.meta.url).href,new URL("/assets/water-ambient-2-CCvcrvYI.mp3",import.meta.url).href],Aa=[new URL("/assets/fire-BcAOoT2O.mp3",import.meta.url).href,new URL("/assets/fire-and-boil-ClIG_jTH.mp3",import.meta.url).href],Ia=[new URL("/assets/outdoor-ambient-OgyE9KC9.mp3",import.meta.url).href,new URL("/assets/outdoor-ambient-2-BJwc1fVg.mp3",import.meta.url).href,new URL("/assets/outdoor-ambient-3-CgS_ZTwF.mp3",import.meta.url).href,new URL("/assets/outdoor-ambient-4-D0igc8Oe.mp3",import.meta.url).href],Ca=[new URL("/assets/guard-door-Bt_L3DHl.mp3",import.meta.url).href],ba=[new URL("/assets/door-close-B0aPeWQQ.mp3",import.meta.url).href],Pa=[new URL("/assets/door-unlock-and-open-BrWf8oY0.mp3",import.meta.url).href],ka=[new URL("/assets/door-close-and-lock-2KewZtEX.mp3",import.meta.url).href],Da=[new URL("/assets/player-door-open-UoOMxi0z.mp3",import.meta.url).href],Wa=[new URL("/assets/player-door-close--cpAKYQn.mp3",import.meta.url).href],Va=[new URL("/assets/player-door-unlock-and-open-BRyYHg0C.mp3",import.meta.url).href],Ba=[new URL("/assets/player-door-close-and-lock-DGqkndlD.mp3",import.meta.url).href],Ga=[new URL("/assets/water-submerge-DQJre2qL.mp3",import.meta.url).href],Ua=[new URL("/assets/water-exit-9ReLTmSR.mp3",import.meta.url).href],Ea=[new URL("/assets/jump-CT8F7l0-.mp3",import.meta.url).href,new URL("/assets/jump-2-CkneFv42.mp3",import.meta.url).href],Na=[new URL("/assets/alarm-DZ8_2-0K.mp3",import.meta.url).href],Fa=[new URL("/assets/switch-progress-e_X3BJji.mp3",import.meta.url).href],Oa=[new URL("/assets/switch-reset-CmyMtVBd.mp3",import.meta.url).href],Ha=[new URL("/assets/switch-success-CoJkvAoY.mp3",import.meta.url).href],za=[new URL("/assets/too%20high-QJ7ack5Y.mp3",import.meta.url).href,new URL("/assets/too%20high-2-DlNvjkio.mp3",import.meta.url).href],Xa=[[new URL("/assets/Hmm-C7ZkarUW.mp3",import.meta.url).href,"Hmm..."],[new URL("/assets/What-Bln9AVwI.mp3",import.meta.url).href,"What?"],[new URL("/assets/hey-Cov-hThV.mp3",import.meta.url).href,"Hey!"],[new URL("/assets/hey-2-tLZjl9ZE.mp3",import.meta.url).href,"Hey!"],[new URL("/assets/hey-3-MyuXTOoE.mp3",import.meta.url).href,"Hey!"],[new URL("/assets/what%20was%20that-wFu791Lj.mp3",import.meta.url).href,"What was that?"],[new URL("/assets/what%20was%20that-2-BRK6ttcl.mp3",import.meta.url).href,"What was that?"],[new URL("/assets/what%20was%20that-3-DMCA4XZo.mp3",import.meta.url).href,"What was that?"],[new URL("/assets/what%20was%20that-4-BuBmq_nR.mp3",import.meta.url).href,"What was that?"],[new URL("/assets/what%20was%20that-5-KwPT1ZpE.mp3",import.meta.url).href,"What was that?"],[new URL("/assets/who%20goes%20there-D4BiDhSl.mp3",import.meta.url).href,"Who goes there?"],[new URL("/assets/huh-LtYQLjfL.mp3",import.meta.url).href,"Huh?"],[new URL("/assets/What-Bln9AVwI.mp3",import.meta.url).href,"What?"],[new URL("/assets/wha-DI1tn-wL.mp3",import.meta.url).href,"Wha..."],[new URL("/assets/wait-Ceym8vI_.mp3",import.meta.url).href,"Wait!"],[new URL("/assets/who%20there-BNUJzwes.mp3",import.meta.url).href,"Who's there?"],[new URL("/assets/what%20moved-C1GbJeBP.mp3",import.meta.url).href,"What moved?"],[new URL("/assets/what%20in%20the%20shadows-Co75AZl6.mp3",import.meta.url).href,`What's that
in the shadows?`],[new URL("/assets/shadow%20move-UFUH5jmr.mp3",import.meta.url).href,`Did that
shadow move?`],[new URL("/assets/see%20something-DiJIFbcA.mp3",import.meta.url).href,`I see
something!`],[new URL("/assets/hello-BHfx6UuV.mp3",import.meta.url).href,"Hello?"],[new URL("/assets/ugh-BcAL_Y4k.mp3",import.meta.url).href,"Uhh..."]],Ya=[[new URL("/assets/ahh-CLS7PVzo.mp3",import.meta.url).href,"Ahh..."],[new URL("/assets/aww-BANuivbv.mp3",import.meta.url).href,"Aww..."],[new URL("/assets/quiet%20out-CmEqXeyl.mp3",import.meta.url).href,"Quiet out..."],[new URL("/assets/rest%20me%20bones-yNtfsiZ5.mp3",import.meta.url).href,`Rest me old
bones...`]],ja=[[new URL("/assets/Hmm-C7ZkarUW.mp3",import.meta.url).href,"Hmm..."],[new URL("/assets/What-Bln9AVwI.mp3",import.meta.url).href,"What?"],[new URL("/assets/what%20was%20that-wFu791Lj.mp3",import.meta.url).href,"What was that?"],[new URL("/assets/quiet%20out-CmEqXeyl.mp3",import.meta.url).href,`Quiet out
there...`],[new URL("/assets/jumpy-BrPEIl8u.mp3",import.meta.url).href,"Jumpy tonight..."],[new URL("/assets/jumpin%20shadows-RLXQtrKg.mp3",import.meta.url).href,`Jumpin' at
shadows!`],[new URL("/assets/Hmm-C7ZkarUW.mp3",import.meta.url).href,"Hmm..."],[new URL("/assets/oh%20well-fF35M0IR.mp3",import.meta.url).href,"Oh well..."],[new URL("/assets/case%20of%20the%20jitters-DKrBy3px.mp3",import.meta.url).href,`I've got myself
a case of the
jitters...`],[new URL("/assets/must%20be%20seeing-BH6ttExY.mp3",import.meta.url).href,`I must be
seein' things...`],[new URL("/assets/what%20in%20my%20coffee-C23__c7x.mp3",import.meta.url).href,`What'd they put
in my coffee?`],[new URL("/assets/coffee%20too%20strong-DnYQZiMU.mp3",import.meta.url).href,`Coffee must be
too strong!`],[new URL("/assets/hmm%20nothing-Cu23hend.mp3",import.meta.url).href,`Hmm!
Nothing...`],[new URL("/assets/well%20I%20though%20I%20saw-DBTRixjG.mp3",import.meta.url).href,`Well, I thought
I saw something.`],[new URL("/assets/nothing-BQG_VzSe.mp3",import.meta.url).href,"Nothing..."],[new URL("/assets/hopefully%20nothing-CctyfS9-.mp3",import.meta.url).href,`Hopefully
nothing.`],[new URL("/assets/seeing%20things-BEcZG9pX.mp3",import.meta.url).href,`Seein' things,
I guess.`],[new URL("/assets/seeing%20things-BEcZG9pX.mp3",import.meta.url).href,`Seein' things,
I guess.`]],qa=[[new URL("/assets/Hmm-C7ZkarUW.mp3",import.meta.url).href,"Hmm..."],[new URL("/assets/What-Bln9AVwI.mp3",import.meta.url).href,"What?"],[new URL("/assets/what%20was%20that-wFu791Lj.mp3",import.meta.url).href,"What was that?"],[new URL("/assets/jumpy-BrPEIl8u.mp3",import.meta.url).href,"Jumpy tonight..."],[new URL("/assets/Hmm-C7ZkarUW.mp3",import.meta.url).href,"Hmm..."],[new URL("/assets/oh%20well-fF35M0IR.mp3",import.meta.url).href,"Oh well..."],[new URL("/assets/case%20of%20the%20jitters-DKrBy3px.mp3",import.meta.url).href,`I've got myself
a case of the
jitters...`],[new URL("/assets/must%20be%20seeing-BH6ttExY.mp3",import.meta.url).href,`I must be
seein' things...`],[new URL("/assets/what%20in%20my%20coffee-C23__c7x.mp3",import.meta.url).href,`What'd they put
in my coffee?`],[new URL("/assets/coffee%20too%20strong-DnYQZiMU.mp3",import.meta.url).href,`Coffee must be
too strong!`],[new URL("/assets/hmm%20nothing-Cu23hend.mp3",import.meta.url).href,`Hmm!
Nothing...`],[new URL("/assets/nothing-BQG_VzSe.mp3",import.meta.url).href,"Nothing..."],[new URL("/assets/hopefully%20nothing-CctyfS9-.mp3",import.meta.url).href,`Hopefully
nothing.`],[new URL("/assets/seeing%20things-BEcZG9pX.mp3",import.meta.url).href,`Seein' things,
I guess.`],[new URL("/assets/seeing%20things-BEcZG9pX.mp3",import.meta.url).href,`Seein' things,
I guess.`]],$a=[[new URL("/assets/Hmm-C7ZkarUW.mp3",import.meta.url).href,"Hmm..."],[new URL("/assets/What-Bln9AVwI.mp3",import.meta.url).href,"What?"],[new URL("/assets/what-2-BBrLBmQ-.mp3",import.meta.url).href,"What?"],[new URL("/assets/hey-Cov-hThV.mp3",import.meta.url).href,"Hey!"],[new URL("/assets/hey-2-tLZjl9ZE.mp3",import.meta.url).href,"Hey!"],[new URL("/assets/hey-3-MyuXTOoE.mp3",import.meta.url).href,"Hey!"],[new URL("/assets/what%20was%20that-wFu791Lj.mp3",import.meta.url).href,"What was that?"],[new URL("/assets/what%20was%20that-2-BRK6ttcl.mp3",import.meta.url).href,"What was that?"],[new URL("/assets/what%20was%20that-3-DMCA4XZo.mp3",import.meta.url).href,"What was that?"],[new URL("/assets/what%20was%20that-4-BuBmq_nR.mp3",import.meta.url).href,"What was that?"],[new URL("/assets/what%20was%20that-5-KwPT1ZpE.mp3",import.meta.url).href,"What was that?"],[new URL("/assets/huh-LtYQLjfL.mp3",import.meta.url).href,"Huh?"],[new URL("/assets/What-Bln9AVwI.mp3",import.meta.url).href,"What?"],[new URL("/assets/wha-DI1tn-wL.mp3",import.meta.url).href,"Wha..."],[new URL("/assets/wait-Ceym8vI_.mp3",import.meta.url).href,"Wait!"],[new URL("/assets/who%20there-BNUJzwes.mp3",import.meta.url).href,"Who's there?"],[new URL("/assets/hello-BHfx6UuV.mp3",import.meta.url).href,"Hello?"],[new URL("/assets/ugh-BcAL_Y4k.mp3",import.meta.url).href,"Uhh..."],[new URL("/assets/hark-DqdjTChn.mp3",import.meta.url).href,"Hark?"],[new URL("/assets/noise-4Zue0F2f.mp3",import.meta.url).href,"What was that noise?"],[new URL("/assets/noise-4Zue0F2f.mp3",import.meta.url).href,"What was that noise?"],[new URL("/assets/heard%20something-DO8-XpgU.mp3",import.meta.url).href,"I heard something..."],[new URL("/assets/heard%20something-DO8-XpgU.mp3",import.meta.url).href,"I heard something..."]],Ka=[[new URL("/assets/Hmm-C7ZkarUW.mp3",import.meta.url).href,"Hmm..."],[new URL("/assets/jumpy-BrPEIl8u.mp3",import.meta.url).href,"Jumpy tonight..."],[new URL("/assets/oh%20well-fF35M0IR.mp3",import.meta.url).href,"Oh well..."],[new URL("/assets/case%20of%20the%20jitters-DKrBy3px.mp3",import.meta.url).href,`I've got myself
a case of the
jitters...`],[new URL("/assets/what%20in%20my%20coffee-C23__c7x.mp3",import.meta.url).href,`What's in my
coffee today?`],[new URL("/assets/coffee%20too%20strong-DnYQZiMU.mp3",import.meta.url).href,`Coffee must be
too strong!`],[new URL("/assets/hmm%20nothing-Cu23hend.mp3",import.meta.url).href,`Hmm!
Nothing...`],[new URL("/assets/cant%20hear%20now-DnAVsnvu.mp3",import.meta.url).href,`Well, I can't
hear it now.`],[new URL("/assets/nothing-BQG_VzSe.mp3",import.meta.url).href,"Nothing..."],[new URL("/assets/hopefully%20nothing-CctyfS9-.mp3",import.meta.url).href,`Hopefully
nothing.`],[new URL("/assets/hearing%20things-DbJs2kfm.mp3",import.meta.url).href,`I must be
hearing things.`]],Qa=[[new URL("/assets/Hmm-C7ZkarUW.mp3",import.meta.url).href,"Hmm..."],[new URL("/assets/hey-Cov-hThV.mp3",import.meta.url).href,"Hey!"],[new URL("/assets/hey-2-tLZjl9ZE.mp3",import.meta.url).href,"Hey!"],[new URL("/assets/hey-3-MyuXTOoE.mp3",import.meta.url).href,"Hey!"],[new URL("/assets/What-Bln9AVwI.mp3",import.meta.url).href,"What?"],[new URL("/assets/noise%20again-BS1gWh7h.mp3",import.meta.url).href,`That noise
again?`],[new URL("/assets/someone%20there-DsSa4u76.mp3",import.meta.url).href,"Someone's there!"],[new URL("/assets/who%20could%20that%20be-DkOW9nc8.mp3",import.meta.url).href,`Who could
that be?`],[new URL("/assets/better%20check%20it%20out-CN5qjmao.mp3",import.meta.url).href,`Better check
it out.`],[new URL("/assets/better%20be%20rats-Bp_brJ-q.mp3",import.meta.url).href,`That better
be rats!`],[new URL("/assets/who%20that-B170zojY.mp3",import.meta.url).href,"Who is that?"],[new URL("/assets/come%20out%20come%20out-Bp17S-T7.mp3",import.meta.url).href,`Come out, come out
wherever you are!`]],Za=[[new URL("/assets/Hmm-C7ZkarUW.mp3",import.meta.url).href,"Hmm..."],[new URL("/assets/jumpin%20shadows-RLXQtrKg.mp3",import.meta.url).href,`Jumpin' at
shadows!`],[new URL("/assets/jumpy-BrPEIl8u.mp3",import.meta.url).href,"Jumpy!"],[new URL("/assets/oh%20well-fF35M0IR.mp3",import.meta.url).href,"Oh, well."],[new URL("/assets/guess%20nothing-gTwDYZep.mp3",import.meta.url).href,`Guess it was
nothing.`],[new URL("/assets/wonder%20it%20was-CxIIvYO9.mp3",import.meta.url).href,"Wonder what it was."],[new URL("/assets/back%20to%20post-NMOQWlob.mp3",import.meta.url).href,"Back to my post."],[new URL("/assets/quiet%20now-CDAPNRgN.mp3",import.meta.url).href,"All quiet now."],[new URL("/assets/sure%20I%20heard%20something-B5FnAjaO.mp3",import.meta.url).href,`I'm sure I
heard something.`],[new URL("/assets/not%20there%20anymore-aq63ZUK0.mp3",import.meta.url).href,"Not there anymore."],[new URL("/assets/probably%20nothing-DK9MBhYn.mp3",import.meta.url).href,"Probably nothing."],[new URL("/assets/hmm%20nothing-Cu23hend.mp3",import.meta.url).href,`Hmm!
Nothing.`],[new URL("/assets/i%20dont%20know%20why%20i%20work%20here-CXGbDiKJ.mp3",import.meta.url).href,`I don't know why
I work here.`],[new URL("/assets/waste%20of%20my%20time-p4xwjEuv.mp3",import.meta.url).href,"Waste of my time."],[new URL("/assets/why%20do%20I%20even%20try-DM9wXPt_.mp3",import.meta.url).href,`Why do I
even try?`],[new URL("/assets/at%20least%20Im%20not%20on%20cleaning%20duty-B_I_gWfg.mp3",import.meta.url).href,`At least I'm not
on cleaning duty.`],[new URL("/assets/at%20least%20my%20shift%20ends%20soon-6i1VHYlH.mp3",import.meta.url).href,`At least my
shift ends soon.`],[new URL("/assets/what%20do%20you%20want%20me%20to%20do%20about%20it-C-0WHtl1.mp3",import.meta.url).href,`What do you
want me to
do about it?`]],Ja=[[new URL("/assets/hey-3-MyuXTOoE.mp3",import.meta.url).href,"Hey!"],[new URL("/assets/What-Bln9AVwI.mp3",import.meta.url).href,"What?"],[new URL("/assets/coming-CMRSckJe.mp3",import.meta.url).href,"Coming!"],[new URL("/assets/to%20arms-BpBH1sEU.mp3",import.meta.url).href,"To arms!"]],el=[[new URL("/assets/torch-out-DtQeeDMv.mp3",import.meta.url).href,"That torch is out!"],[new URL("/assets/torch-out-2-1yfDp-KP.mp3",import.meta.url).href,`That light
burned out!`],[new URL("/assets/too-dark-jhqO3pNX.mp3",import.meta.url).href,`It's too dark
in here.`],[new URL("/assets/more-light-MEa0t7XL.mp3",import.meta.url).href,`Let's have
more light.`]],tl=[[new URL("/assets/that-better-BRplzD0F.mp3",import.meta.url).href,"That's better."],[new URL("/assets/there-we-go-BUUAne7t.mp3",import.meta.url).href,"There we go."],[new URL("/assets/where-was-i-JaSzek2j.mp3",import.meta.url).href,"Now where was I?"]],ol=[[new URL("/assets/whistle-DekXI6I9.mp3",import.meta.url).href,"(Whistle)"],[new URL("/assets/whistle-2-r9G5HdGQ.mp3",import.meta.url).href,"(Whistle)"],[new URL("/assets/whistle-3-DqZMxrBz.mp3",import.meta.url).href,"(Whistle)"],[new URL("/assets/get%20em-Rgr3k2F_.mp3",import.meta.url).href,"Get 'em!"],[new URL("/assets/intruder-B_y9S04L.mp3",import.meta.url).href,"Intruder!"],[new URL("/assets/oh%20no%20its%20a%20thief-BGrNQ6Ru.mp3",import.meta.url).href,`Oh no...
It's a thief!`],[new URL("/assets/we%20coming%20for%20you-CB176SDN.mp3",import.meta.url).href,`We're coming
for you!`],[new URL("/assets/coming%20for%20you-Bp3Ll7pT.mp3",import.meta.url).href,"Coming for you!"],[new URL("/assets/halt-BH5O4SmI.mp3",import.meta.url).href,"Halt!"],[new URL("/assets/see%20you-BgK5m5bw.mp3",import.meta.url).href,"We see you!"],[new URL("/assets/ill%20get%20you-HseDcWJD.mp3",import.meta.url).href,"I'll get you!"],[new URL("/assets/a%20goner-BqGlZQUN.mp3",import.meta.url).href,"You're a goner!"],[new URL("/assets/just%20you%20wait-DAH7nScd.mp3",import.meta.url).href,"Just you wait!"],[new URL("/assets/you%20wont%20get%20away-C1nfjt30.mp3",import.meta.url).href,"You won't get away!"],[new URL("/assets/no%20you%20dont-B1JslKM4.mp3",import.meta.url).href,"No you don't!"],[new URL("/assets/thief-BA8BUhhG.mp3",import.meta.url).href,"Thief!"],[new URL("/assets/thief-2-CCpUCQED.mp3",import.meta.url).href,"Thief!"],[new URL("/assets/thief-3-BnRAe4Gl.mp3",import.meta.url).href,"Thief!"],[new URL("/assets/after%20them-BBr-u45L.mp3",import.meta.url).href,"After them!"],[new URL("/assets/what%20is%20thy%20business-D8Mnyyw3.mp3",import.meta.url).href,`What is thy business
with this gold?`],[new URL("/assets/no%20mercy%20for%20the%20wicked-Dko2JXny.mp3",import.meta.url).href,`No mercy for
the wicked!`]],nl=[[new URL("/assets/must%20have%20run-Cg0hF6Fa.mp3",import.meta.url).href,`Must have
run off...`],[new URL("/assets/oh%20well-fF35M0IR.mp3",import.meta.url).href,"Oh, well..."],[new URL("/assets/where%20they%20go-CxPCM5pf.mp3",import.meta.url).href,"Where did they go?"],[new URL("/assets/his%20holiness-DjbDNNb_.mp3",import.meta.url).href,`His Holiness would
not be pleased!`],[new URL("/assets/the%20boss-h6KJ8xQT.mp3",import.meta.url).href,`The boss will
not be pleased!`],[new URL("/assets/huff%20puff%20give%20up-BH2LcPQj.mp3",import.meta.url).href,"I give up!"],[new URL("/assets/gone-DZ_WbIdv.mp3",import.meta.url).href,"Gone!"],[new URL("/assets/come%20back%20here-Djc5hKs6.mp3",import.meta.url).href,"Come back here!"],[new URL("/assets/rotten%20scoundrel-BMLguqvw.mp3",import.meta.url).href,"Rotten scoundrel!"],[new URL("/assets/aargh-Bbaf0JCx.mp3",import.meta.url).href,"Aargh!!"],[new URL("/assets/blast-BA-_oUjP.mp3",import.meta.url).href,"Blast!"],[new URL("/assets/dont%20come%20back-DIh3BbZI.mp3",import.meta.url).href,"Don't come back!"],[new URL("/assets/wont%20get%20away%20next%20time-J1ySfexg.mp3",import.meta.url).href,`You won't
get away
next time!`],[new URL("/assets/for%20his%20holiness-D810tn4L.mp3",import.meta.url).href,"For His Holiness!"],[new URL("/assets/lousy%20day%20at%20work-CS2zuFsZ.mp3",import.meta.url).href,`What a lousy day
at work!`],[new URL("/assets/i%20give%20up-DLVvfTMZ.mp3",import.meta.url).href,"I give up..."],[new URL("/assets/what%20do%20i%20do%20help%20me-Bk_DgZFF.mp3",import.meta.url).href,`What do I do?
Help me, help me...`],[new URL("/assets/guard%20rant-BUmwyoS6.mp3",import.meta.url).href,"(Guard rant)"]],rl=[[new URL("/assets/someone-smacked-me-BPsbxuKF.mp3",import.meta.url).href,"Someone smacked me!"],[new URL("/assets/someone-hit-me-BDrQjd7H.mp3",import.meta.url).href,"Someone hit me!"],[new URL("/assets/who-hit-me-DdVz0NOl.mp3",import.meta.url).href,"Who hit me!?"],[new URL("/assets/devils-hit-me-CBiXRRYo.mp3",import.meta.url).href,`Which of you
devils hit me!?`]],sl=[[new URL("/assets/have-guard-down-COQ37xDA.mp3",import.meta.url).href,"We have a guard down!"],[new URL("/assets/man-down-BBS4P-B_.mp3",import.meta.url).href,"Man down!"],[new URL("/assets/guard-down-Bo4zht5i.mp3",import.meta.url).href,"Guard down!"]],il=[[new URL("/assets/ahh-CLS7PVzo.mp3",import.meta.url).href,"Ahh..."]],al=[[new URL("/assets/must-have-intruder-Dr1HXIir.mp3",import.meta.url).href,`We must have
an intruder!`],[new URL("/assets/eye-out-D8mrSli_.mp3",import.meta.url).href,`I will keep
an eye out!`],[new URL("/assets/intruder-B_y9S04L.mp3",import.meta.url).href,"Intruder!"]],ll=[[new URL("/assets/take%20that-B2x6GJeK.mp3",import.meta.url).href,"Take that!!"],[new URL("/assets/oof-BpjrwP5Z.mp3",import.meta.url).href,"Oof!!"],[new URL("/assets/uh-rBoAPCqA.mp3",import.meta.url).href,"Ugg!!"],[new URL("/assets/ah-DdM1z4cg.mp3",import.meta.url).href,"Ahh!!"],[new URL("/assets/ah-2-Bz3TNfDi.mp3",import.meta.url).href,"Ahh!!"],[new URL("/assets/ha%20ya-BkXtSGsQ.mp3",import.meta.url).href,"Hi-yah!"],[new URL("/assets/ha%20ya-2-Divk_8FL.mp3",import.meta.url).href,"Hi-yah!"],[new URL("/assets/ha%20ya-3-YSNx4cR-.mp3",import.meta.url).href,"Hi-yah!"]],ul=[[new URL("/assets/Hmm-C7ZkarUW.mp3",import.meta.url).href,"Hmm..."],[new URL("/assets/What-Bln9AVwI.mp3",import.meta.url).href,"What?"],[new URL("/assets/hey-Cov-hThV.mp3",import.meta.url).href,"Hey!"],[new URL("/assets/hey-2-tLZjl9ZE.mp3",import.meta.url).href,"Hey!"],[new URL("/assets/hey-3-MyuXTOoE.mp3",import.meta.url).href,"Hey!"],[new URL("/assets/what%20was%20that-wFu791Lj.mp3",import.meta.url).href,"What was that?"],[new URL("/assets/what%20was%20that-2-BRK6ttcl.mp3",import.meta.url).href,"What was that?"],[new URL("/assets/what%20was%20that-3-DMCA4XZo.mp3",import.meta.url).href,"What was that?"],[new URL("/assets/what%20was%20that-4-BuBmq_nR.mp3",import.meta.url).href,"What was that?"],[new URL("/assets/what%20was%20that-5-KwPT1ZpE.mp3",import.meta.url).href,"What was that?"],[new URL("/assets/who%20goes%20there-D4BiDhSl.mp3",import.meta.url).href,"Who goes there?"],[new URL("/assets/huh-LtYQLjfL.mp3",import.meta.url).href,"Huh?"],[new URL("/assets/What-Bln9AVwI.mp3",import.meta.url).href,"What?"],[new URL("/assets/wha-DI1tn-wL.mp3",import.meta.url).href,"Wha..."],[new URL("/assets/wait-Ceym8vI_.mp3",import.meta.url).href,"Wait!"],[new URL("/assets/who%20there-BNUJzwes.mp3",import.meta.url).href,"Who's there?"],[new URL("/assets/hello-BHfx6UuV.mp3",import.meta.url).href,"Hello?"],[new URL("/assets/ugh-BcAL_Y4k.mp3",import.meta.url).href,"Uhh..."]],cl=[[new URL("/assets/dont-stay-lit-BOBt-044.mp3",import.meta.url).href,`They don't
stay lit!`],[new URL("/assets/paranoid-BWfcVW-h.mp3",import.meta.url).href,`That's enough to make
a guy paranoid!`],[new URL("/assets/should-relight-Zi52xOM_.mp3",import.meta.url).href,`Somebody should
relight that.`],[new URL("/assets/torch-burned-ByEbtu2d.mp3",import.meta.url).href,`That torch
burned out.`],[new URL("/assets/light-burned-CXeUwo8R.mp3",import.meta.url).href,`That light
burned out.`],[new URL("/assets/got-dark-C0m0TqEE.mp3",import.meta.url).href,"It got dark!"],[new URL("/assets/wish-torch-Bf0SUUfQ.mp3",import.meta.url).href,`Wish I had
a torch...`],[new URL("/assets/why-happen-BsZps00H.mp3",import.meta.url).href,`Why did that
happen?`]],fl=[[new URL("/assets/huh-LtYQLjfL.mp3",import.meta.url).href,"Huh?"],[new URL("/assets/What-Bln9AVwI.mp3",import.meta.url).href,"What?"],[new URL("/assets/hey-Cov-hThV.mp3",import.meta.url).href,"Hey!"],[new URL("/assets/hey-2-tLZjl9ZE.mp3",import.meta.url).href,"Hey!"],[new URL("/assets/hey-3-MyuXTOoE.mp3",import.meta.url).href,"Hey!"]],hl=[[new URL("/assets/someone-stole-Cl0PmbT3.mp3",import.meta.url).href,`Someone stole
the Treasure!`],[new URL("/assets/its-missing-WeiZdQ_J.mp3",import.meta.url).href,"It's missing!"],[new URL("/assets/who-took-it-C-KylDGk.mp3",import.meta.url).href,"Who took it?"],[new URL("/assets/boss-wont-like-Dqojs234.mp3",import.meta.url).href,`The boss won't
like this!`]],dl=[[new URL("/assets/huh-LtYQLjfL.mp3",import.meta.url).href,"Huh?"],[new URL("/assets/What-Bln9AVwI.mp3",import.meta.url).href,"What?"],[new URL("/assets/hey-Cov-hThV.mp3",import.meta.url).href,"Hey!"],[new URL("/assets/hey-2-tLZjl9ZE.mp3",import.meta.url).href,"Hey!"],[new URL("/assets/hey-3-MyuXTOoE.mp3",import.meta.url).href,"Hey!"]];class Pn{constructor(){this.activeHowls=[],this.activeLimit=2,this.fadeTime=1e3}setFadetime(t=1e3){return this.fadeTime=t,this}fade(t,o){return this.fadeTime>0?(t.fade(1,0,this.fadeTime,o),setTimeout(()=>t.stop(o),this.fadeTime)):t.stop(o),this}empty(){for(let t of this.activeHowls)this.fade(...t);return this.activeHowls=[],this}queue(t,o){if(this.activeHowls.unshift([t,o]),this.activeHowls.length>this.activeLimit){const n=this.activeHowls.pop();this.fade(...n)}return this.activeHowls=this.activeHowls.slice(0,this.activeLimit),this}}class z{constructor(t,o=null){this.howls=t.map(n=>new _e.Howl({src:[n]})),this.howlNum=0,this.soundPool=o,Kt(this.howls)}play(t,o=0,n=!1){const r=this.next();r.loop(n),r.volume(t),r.stereo(o);try{const s=r.play();return this.soundPool!==null&&this.soundPool.queue(r,s),s}catch(s){console.log(`Audio playback error ${r}`,s)}return-1}next(){return this.howlNum++,this.howlNum==this.howls.length&&(this.howlNum=0,Kt(this.howls)),this.howls[this.howlNum]}}class re{constructor(t,o=null){this.sounds=t.map(pl),this.soundNum=0,this.soundPool=o,this.mute=!1,Kt(this.sounds)}play(t,o=0){const n=this.next();if(!this.mute){n.sound.volume(t),n.sound.stereo(o);const r=n.sound.play();this.soundPool!==null&&this.soundPool.queue(n.sound,r)}return n}next(){const t=this.sounds[this.soundNum];return++this.soundNum,this.soundNum===this.sounds.length&&(this.soundNum=0,Kt(this.sounds)),t}}function pl(e){return{sound:new _e.Howl({src:[e[0]]}),subtitle:e[1]}}function ml(e,t,o,n){e.footstepWood=new z([sa]),e.footstepTile=new z([ia]),e.footstepWater=new z([aa]),e.footstepGravel=new z([la]),e.footstepGrass=new z([ua]),e.footstepCreaky=new z(ca),e.victorySong=new z([ea]),e.levelRequirementJingle=new z([ta],o),e.levelCompleteJingle=new z([oa],o),e.gameOverJingle=new z([na],o),e.easterEgg=new z([ra],o),e.hitPlayer=new z(fa),e.hitGuard=new z(ha),e.coin=new z(pa),e.coinRattle=new z(da),e.food=new z(va),e.grabKey=new z(Ma),e.clockChime=new z(ya),e.clockTick=new z(xa),e.doorOpen=new z(Ca),e.doorClose=new z(ba),e.doorOpenLocked=new z(Pa),e.doorCloseLocked=new z(ka),e.playerDoorOpen=new z(Da),e.playerDoorClose=new z(Wa),e.playerDoorOpenLocked=new z(Va),e.playerDoorCloseLocked=new z(Ba),e.grunt=new z(ma),e.douse=new z(ga),e.ignite=new z(wa),e.hide=new z(Sa),e.gate=new z(Ta),e.thump=new z(_a),e.splash=new z(La),e.waterEnter=new z(Ga),e.waterExit=new z(Ua),e.jump=new z(Ea),e.tooHigh=new z(za),e.treasureAlarm=new z(Na),e.switchProgress=new z(Fa),e.switchReset=new z(Oa),e.switchSuccess=new z(Ha),e.ambienceWater=new z(Ra,n),e.ambienceKitchen=new z(Aa,n),e.ambienceOutdoor=new z(Ia,n),t.guardInvestigate=new re(Qa,o),t.guardFinishInvestigating=new re(Za,o),t.guardSeeThief=new re(Xa),t.guardFinishLooking=new re(ja,o),t.guardFinishLookingAtLitTorch=new re(qa,o),t.guardChase=new re(ol,o),t.guardEndChase=new re(nl,o),t.guardHearGuard=new re(Ja,o),t.guardSpotDownedGuard=new re(dl,o),t.guardSeeUnlitTorch=new re(el,o),t.guardHearThief=new re($a,o),t.guardAwakesWarning=new re(rl,o),t.guardDownWarning=new re(sl,o),t.guardWarningResponse=new re(al,o),t.guardFinishListening=new re(Ka,o),t.guardFinishLightingTorch=new re(tl,o),t.guardDamage=new re(ll,o),t.guardStirring=new re(il,o),t.guardRest=new re(Ya,o),t.guardSeeTorchLit=new re(ul,o),t.guardSeeTorchDoused=new re(cl,o),t.guardSpotStolenTreasure=new re(fl,o),t.guardExamineStolenTreasure=new re(hl,o)}const gl={left:!1,right:!1,up:!1,down:!1,wait:!1,jump:!1,zoomIn:!1,zoomOut:!1,snapToPlayer:!1,menuAccept:!1,panUp:!1,panDown:!1,panLeft:!1,panRight:!1,menu:!1,menuBack:!1,menuToggle:!1,homePlay:!1,homeDaily:!1,homeStats:!1,homeAchievements:!1,homeOptions:!1,jumpToggle:!1,startLevel:!1,guardMute:!1,volumeMute:!1,volumeDown:!1,volumeUp:!1,forceRestart:!1,resetState:!1,seeAll:!1,collectLoot:!1,getKey:!1,markSeen:!1,guardSight:!1,guardPatrols:!1,roomAdjacencies:!1,nextLevel:!1,prevLevel:!1,fullscreen:!1,showSpeech:!1,idleCursorToggle:!1,showFPS:!1,devMenu:!1};var ne=null;const yl={"Alt+Comma":["prevLevel"],"Alt+KeyA":["seeAll"],"Alt+KeyB":["roomAdjacencies"],"Alt+KeyC":["collectLoot"],"Alt+KeyK":["getKey"],"Alt+KeyP":["guardPatrols"],"Alt+KeyR":["resetState"],"Alt+KeyS":["markSeen"],"Alt+KeyV":["guardSight"],"Alt+Period":["nextLevel"],"Alt+KeyF":["showFPS"],ArrowDown:["down"],ArrowLeft:["left"],ArrowRight:["right"],ArrowUp:["up"],BracketLeft:["zoomOut"],BracketRight:["zoomIn"],Digit0:["volumeMute"],Digit9:["guardMute"],Enter:["wait","menuAccept"],Equal:["volumeUp"],Escape:["menu","menuBack"],KeyA:["left","homeAchievements"],KeyC:["credits"],KeyD:["right","homeDaily","keyRepeatDelay"],KeyF:["jumpToggle","fullscreen"],KeyG:["guardMute"],KeyI:["idleCursorToggle"],KeyJ:["down","screenShakeEnabled"],KeyK:["up","keyRepeatRate"],KeyH:["left","helpControls"],KeyL:["right"],KeyM:["helpKey"],KeyN:["homeRestart","startLevel"],KeyO:["homeOptions"],KeyP:["homePlay"],KeyR:["homePlay"],KeyS:["down","homeStats","scorePopup"],KeyW:["up"],KeyX:["devMenu"],KeyZ:["wait","menuAccept"],Period:["wait","menuAccept"],Shift:["jump"],Slash:["menu","menuBack"],Space:["wait","menuAccept"],Minus:["volumeDown"],Numpad2:["down"],Numpad4:["left","menu"],Numpad6:["right","menuAccept"],Numpad8:["up"],Numpad5:["wait"],NumpadAdd:["jumpToggle"],NumpadEnter:["menuAccept"],Tab:["showSpeech"],"Control+ArrowDown":["panDown"],"Control+ArrowLeft":["panLeft"],"Control+ArrowRight":["panRight"],"Control+ArrowUp":["panUp"],"Control+KeyA":["panLeft"],"Control+KeyD":["panRight"],"Control+KeyH":["panLeft"],"Control+KeyJ":["panUp"],"Control+KeyK":["panDown"],"Control+KeyL":["panRight"],"Control+KeyR":["forceRestart"],"Control+KeyS":["panDown"],"Control+KeyW":["panUp"],"Control+Numpad2":["panDown"],"Control+Numpad4":["panLeft"],"Control+Numpad6":["panRight"],"Control+Numpad8":["panUp"],"Control+Z":["snapToPlayer"],"Control+Numpad5":["snapToPlayer"],"Control+Period":["snapToPlayer"],"Control+Space":["snapToPlayer"]};class te extends Array{constructor(t=0,o=0,n=0,r=0){super(t,o,n,r)}collide(t,o,n=0,r=0){return!(t+n<this[0]||o+r<this[1]||t>=this[0]+this[2]||o>=this[1]+this[3])}}class Ho{constructor(){this.currentFramePresses=new Set,this.controlStates={...gl},this.controlTimes={};for(const t in this.controlStates)this.controlTimes[t]=Date.now();window.addEventListener("blur",t=>{this.clearPressedAll()})}setPressed(t,o,n=!0){this.controlStates[t]=o,this.controlTimes[t]=Date.now(),n&&o&&this.currentFramePresses.add(t),ne=this}clearPressedAll(){for(const t in this.controlStates)this.controlStates[t]=!1}endFrame(){this.currentFramePresses.clear()}}class xl extends Ho{constructor(t=null){super(),t==null&&(t=yl),this.keyMap=t;let o=this;document.onkeydown=function(n){o.keyDownHandler(n)},document.onkeyup=function(n){o.keyUpHandler(n)}}getCode(t){let o=t.code;return t.altKey&&t.code!=="AltLeft"&&t.code!=="AltRight"&&(o="Alt+"+o),t.ctrlKey&&t.code!=="ControlLeft"&&t.code!=="ControlRight"&&(o="Control+"+o),(t.code=="AltLeft"||t.code=="AltRight")&&(o="Alt"),(t.code=="ShiftLeft"||t.code=="ShiftRight")&&(o="Shift"),(t.code=="ControlLeft"||t.code=="ControlRight")&&(o="Control"),o}updateModifierDown(t){for(let o in this.keyMap){const n=this.keyMap[o];for(let r of n)!o.includes(t)&&this.controlStates[r]&&(this.controlStates[r]=!1)}}updateModifierUp(t){for(let o in this.keyMap){const n=this.keyMap[o];for(let r of n)o.includes(t)&&this.controlStates[r]&&(this.controlStates[r]=!1)}}keyDownHandler(t){ne=this;const o=this.getCode(t);if(["Alt","Control"].includes(o)&&this.updateModifierDown(o),o in this.keyMap){t.preventDefault();const n=this.keyMap[o];for(let r of n)this.controlStates[r]||this.setPressed(r,!0)}}keyUpHandler(t){const o=this.getCode(t);if(["Alt","Control"].includes(o)&&this.updateModifierUp(o),o in this.keyMap){t.preventDefault();const n=this.keyMap[o];for(let r of n)this.setPressed(r,!1)}}}class vl extends Ho{constructor(t){super(),this.gamepad=t,this.thresh=.4,this.internalStates={...this.controlStates}}setPressed(t,o){this.internalStates[t]!=o&&(this.internalStates[t]=o,super.setPressed(t,o))}}class Ml{constructor(){window.addEventListener("gamepadconnected",t=>this.connected(t)),window.addEventListener("gamepaddisconnected",t=>this.disconnected(t)),this.gamepads={}}connected(t){this.gamepads[t.gamepad.index]=new vl(t.gamepad)}disconnected(t){this.gamepads[t.gamepad.index],delete this.gamepads[t.gamepad.index]}updateGamepadStates(){let t=navigator.getGamepads();if(t!=null)for(const o of t){if(o==null)continue;let n=this.gamepads[o.index];n.gamepad=o,n.setPressed("jump",se(o,0)),n.setPressed("wait",se(o,2)),n.setPressed("menuAccept",se(o,0)||se(o,2)),n.setPressed("zoomOut",se(o,6)&&!se(o,7)),n.setPressed("zoomIn",se(o,7)&&!se(o,6)),n.setPressed("menu",se(o,9)),n.setPressed("left",se(o,14)&&!se(o,12)&&!se(o,13)||o.axes[0]<-n.thresh&&Math.abs(o.axes[1])<.5*Math.abs(o.axes[0])),n.setPressed("right",se(o,15)&&!se(o,12)&&!se(o,13)||o.axes[0]>n.thresh&&Math.abs(o.axes[1])<.5*Math.abs(o.axes[0])),n.setPressed("up",se(o,12)&&!se(o,14)&&!se(o,15)||o.axes[1]<-n.thresh&&Math.abs(o.axes[0])<.5*Math.abs(o.axes[1])),n.setPressed("down",se(o,13)&&!se(o,14)&&!se(o,15)||o.axes[1]>n.thresh&&Math.abs(o.axes[0])<.5*Math.abs(o.axes[1])),n.setPressed("panLeft",o.axes[2]<-n.thresh),n.setPressed("panRight",o.axes[2]>n.thresh),n.setPressed("panUp",o.axes[3]<-n.thresh),n.setPressed("panDown",o.axes[3]>n.thresh),n.setPressed("snapToPlayer",se(o,5)),n.setPressed("showSpeech",se(o,4))}}}function se(e,t){return t<e.buttons.length&&e.buttons[t].pressed}class wl extends Ho{constructor(t){super(),this.mouseActive=!1,this.targetOnTouchDown=null,this.canvas=t,t.addEventListener("touchstart",o=>this.process_touchstart(o),!0),t.addEventListener("touchmove",o=>this.process_touchmove(o),!0),t.addEventListener("touchcancel",o=>this.process_touchend(o),!0),t.addEventListener("touchend",o=>this.process_touchend(o),!0),t.addEventListener("mousedown",o=>this.process_mousedown(o),!0),t.addEventListener("mouseup",o=>this.process_mouseup(o),!0),t.addEventListener("mousemove",o=>this.process_mousemove(o),!0),this.lastMotion={id:-1,active:!1,x0:0,y0:0,x:0,y:0},this.coreTouchTargets={up:{id:-1,rect:new te,touchXY:[0,0],tileInfo:null,mouseable:!1},down:{id:-1,rect:new te,touchXY:[0,0],tileInfo:null,mouseable:!1},left:{id:-1,rect:new te,touchXY:[0,0],tileInfo:null,mouseable:!1},right:{id:-1,rect:new te,touchXY:[0,0],tileInfo:null,mouseable:!1},wait:{id:-1,rect:new te,touchXY:[0,0],tileInfo:null,mouseable:!1},jump:{id:-1,rect:new te,touchXY:[0,0],tileInfo:null,mouseable:!1},menuAccept:{id:-1,rect:new te,touchXY:[0,0],tileInfo:null,mouseable:!1},pan:{id:-1,rect:new te,touchXY:[0,0],tileInfo:null,mouseable:!0},zoomIn:{id:-1,rect:new te,touchXY:[0,0],tileInfo:null,mouseable:!0},zoomOut:{id:-1,rect:new te,touchXY:[0,0],tileInfo:null,mouseable:!0},forceRestart:{id:-1,rect:new te,touchXY:[0,0],tileInfo:null,mouseable:!0},menuToggle:{id:-1,rect:new te,touchXY:[0,0],tileInfo:null,mouseable:!0},fullscreen:{id:-1,rect:new te,touchXY:[0,0],tileInfo:null,mouseable:!0}},this.touchTargets=this.coreTouchTargets}clearMotion(){this.lastMotion.active=!1,this.lastMotion.id=-1,this.lastMotion.x0=0,this.lastMotion.y0=0,this.lastMotion.x=0,this.lastMotion.y=0,this.targetOnTouchDown=null}updateCoreTouchTarget(t,o,n){const r=this.coreTouchTargets[t];r.rect=o,r.tileInfo=n;const s=this.canvas.getBoundingClientRect(),i=r.touchXY[0]-s.left,c=s.bottom-(r.touchXY[1]+1);r.rect.collide(i,c)||this.controlStates[t]&&r.id!=-1&&(this.setPressed(t,!1,!1),r.id=-1)}activateTouchTargets(t){let o;t===void 0?o=this.coreTouchTargets:o={...this.coreTouchTargets,...t};for(const[n,r]of Object.entries(this.touchTargets))n in o||(this.controlStates[n]=!1);this.touchTargets=o}process_mousedown(t){ne=this;const o=this.canvas.getBoundingClientRect(),n=t.clientX-o.left,r=o.bottom-(t.clientY+1);this.mouseActive=!0,this.lastMotion.id=-2,this.lastMotion.active=!1,this.lastMotion.x0=n,this.lastMotion.y0=r,this.lastMotion.x=n,this.lastMotion.y=r,this.targetOnTouchDown=null;for(const[s,i]of Object.entries(this.touchTargets)){if(!i.mouseable)continue;i.rect.collide(n,r)&&(i.touchXY=[t.clientX,t.clientY],i.id=-2,this.setPressed(s,!0),this.targetOnTouchDown=s)}t.preventDefault()}process_mousemove(t){ne=this,this.mouseActive=!0;const o=this.canvas.getBoundingClientRect(),n=t.clientX-o.left,r=o.bottom-(t.clientY+1);this.lastMotion.id==-2&&(this.lastMotion.active=!0,this.lastMotion.x=n,this.lastMotion.y=r);for(const[s,i]of Object.entries(this.touchTargets))i.mouseable&&i.id===-2&&(i.rect.collide(n,r)?i.touchXY=[t.clientX,t.clientY]:(this.setPressed(s,!1,!1),i.id=-1));t.preventDefault()}process_mouseup(t){for(const[o,n]of Object.entries(this.touchTargets))n.mouseable&&this.controlStates[o]&&(n.id=-1,this.setPressed(o,!1,!0),this.controlTimes[o]=0);this.clearMotion(),t.preventDefault()}process_touchstart(t){ne=this,this.mouseActive=!1,this.targetOnTouchDown=null;const o=this.canvas.getBoundingClientRect();for(let n of t.changedTouches){const r=n.clientX-o.left,s=o.bottom-(n.clientY+1);this.lastMotion.id=n.identifier,this.lastMotion.active=!1,this.lastMotion.x0=r,this.lastMotion.y0=s,this.lastMotion.x=r,this.lastMotion.y=s;for(const[i,c]of Object.entries(this.touchTargets))c.rect.collide(r,s)&&(c.touchXY=[n.clientX,n.clientY],c.id=n.identifier,this.targetOnTouchDown=i,this.setPressed(i,!0))}t.preventDefault()}process_touchmove(t){this.mouseActive=!1;const o=this.canvas.getBoundingClientRect();for(let n of t.changedTouches){const r=n.clientX-o.left,s=o.bottom-(n.clientY+1);this.lastMotion.id==n.identifier&&(this.lastMotion.active=!0,this.lastMotion.x=r,this.lastMotion.y=s);for(const[i,c]of Object.entries(this.touchTargets))c.id==n.identifier&&(c.rect.collide(r,s)?c.touchXY=[n.clientX,n.clientY]:(c.id=-1,this.setPressed(i,!1,!1)))}t.preventDefault()}process_touchend(t){this.mouseActive=!1;for(let o of t.changedTouches){for(const[n,r]of Object.entries(this.touchTargets))r.id==o.identifier&&(r.id=-1,this.setPressed(n,!1,!0),this.controlTimes[n]=0);this.lastMotion.id==o.identifier&&this.clearMotion()}t.preventDefault()}}var F=(e=>(e[e.HomeScreen=0]="HomeScreen",e[e.StatsScreen=1]="StatsScreen",e[e.AchievementsScreen=2]="AchievementsScreen",e[e.OptionsScreen=3]="OptionsScreen",e[e.HelpControls=4]="HelpControls",e[e.HelpKey=5]="HelpKey",e[e.Mansion=6]="Mansion",e[e.MansionComplete=7]="MansionComplete",e[e.Dead=8]="Dead",e[e.Win=9]="Win",e[e.DailyHub=10]="DailyHub",e[e.CreditsScreen=11]="CreditsScreen",e[e.DevScreen=12]="DevScreen",e))(F||{}),ge=(e=>(e[e.Indoor=0]="Indoor",e[e.Outdoor=1]="Outdoor",e[e.OutdoorWater=2]="OutdoorWater",e[e.Water=3]="Water",e[e.Kitchen=4]="Kitchen",e))(ge||{});let Rt=!1;function Sl(e){const t=document.getElementById("modalText");t.innerHTML=e;const o=document.getElementById("modalDialog");o.style.display="block",Rt=!0;const n=document.getElementById("modalCloseButton");n.onclick=()=>{io()}}function io(){const e=document.getElementById("modalDialog");e.style.display="none",Rt=!1}function zo(e,t){let o=Tl(e,t);Sl(o)}function Tl(e,t){if(e===null)return"No game played yet!";const o=e.numGhostedLevels,n=e.numSpottings,r=e.numInjuries,s=e.numKnockouts,i=e.totalScore,c=e.turns,l=e.numCompletedLevels,f=e.numLevels,d=l>=f,a=e.daily,u=a!==null?"📅 Daily run for "+a:"🎲 Random game",h=e.numLevels===0?"":d?"Completed mission in "+c+" turns.":"💀 Died on level "+(l+1)+" after "+c+" turns.";let p="";if(d&&a===null){let g;for(g in t)t[g].failed||(p+=t[g].unicodeBadge);p.length>0&&(p="Achievements: "+p+"<br>")}return`🏛️ LLLOOOT! 🏛️<br>${u}<br>${h}<br>Completed:   ${l} of ${f}<br>Ghosted:     ${o}<br>Spottings:   ${n}<br>Knockouts:   ${s}<br>Injuries:    ${r}<br>Total score: ${i}<br>${p}`}class Le{constructor(){this.pages=[],this.activePage=0,this.activePageData=[],this.highlightedAction=0,this.actionSequence=[],this.cachedPageText="",this.screenSize=m.create(),this.state=new Map,this.glyphs=[],this.maxLineLength=0,this.pixelsPerCharX=0,this.pixelsPerCharY=0,this.offsetX=0,this.offsetY=0,this.textW=8,this.textH=16,this.mat=le.create(),this.touchTargets={}}initAction(t){this.touchTargets[t]={id:-1,rect:new te(0,0,0,0),tileInfo:{},touchXY:[-1,-1],mouseable:!0}}parseImage(t,o,n,r){const s=t.slice(o+2).indexOf("#");if(s<0)return[t,o];const i=Number(t.slice(o+1,o+2+s));return Number.isNaN(i)?[t,o]:(this.glyphs.push([i,new te(o,r-n-.875,2,1)]),t=t.slice(0,o)+"  "+t.slice(o+3+s),[t,o+1])}parseButton(t,o,n,r){const s=o;let i,c;for(;;){if(i=t.slice(o).indexOf("|"),i<0)return[t,o];if(i+=o,c=t.slice(i+1).indexOf("]"),c<0)return[t,o];if(c+=i+1,o===i)break;t[o]==="#"&&([t,o]=this.parseImage(t,o,n,r)),o+=1}const l=t.slice(i+1,c);if(l!==void 0&&l!==""){l in this.touchTargets||this.initAction(l);const f=[s,o+1,n],[d,a]=[f[0],f[2]-1/8],[u,h]=[f[1],f[2]+1],p=this.touchTargets[l];p.rect=new te(d,r-h,u-d,h-a),this.actionSequence.push(l)}return t=t.slice(0,i)+t.slice(c),o=i,[t,o]}parseUI(t){let o=this.pages[this.activePage];for(const[r,s]of this.state)o=o.replace("$"+r+"$",s);if(o===this.cachedPageText&&this.screenSize.equals(t))return;this.cachedPageText=o,m.copy(this.screenSize,t),this.activePageData=o.split(`
`);const n=this.activePageData;this.glyphs.length=0,this.actionSequence=[],this.touchTargets={};for(let r=0;r<n.length;++r){let s=n[r],i=0;for(;i<s.length;){switch(s[i]){case"#":[s,i]=this.parseImage(s,i,r,n.length);break;case"[":[s,i]=this.parseButton(s,i,r,n.length);break}i+=1}n[r]=s}this.highlightedAction=Math.max(0,Math.min(this.actionSequence.length-1,this.highlightedAction)),this.maxLineLength=0;for(const r of this.activePageData)this.maxLineLength=Math.max(this.maxLineLength,r.length);this.updateScreenSize(t);for(let r in this.touchTargets){const s=this.touchTargets[r];s.rect[0]-=this.offsetX,s.rect[1]-=this.offsetY,s.rect[0]*=this.pixelsPerCharX,s.rect[1]*=this.pixelsPerCharY,s.rect[2]*=this.pixelsPerCharX,s.rect[3]*=this.pixelsPerCharY}}updateScreenSize(t){const o=He(t);this.pixelsPerCharX=this.textW*o,this.pixelsPerCharY=this.textH*o;const n=this.maxLineLength*this.pixelsPerCharX,r=this.activePageData.length*this.pixelsPerCharY,s=t[0]/this.pixelsPerCharX,i=t[1]/this.pixelsPerCharY;this.offsetX=Math.floor((t[0]-n)/-2)/this.pixelsPerCharX,this.offsetY=Math.floor((t[1]-r)/-2)/this.pixelsPerCharY,le.ortho(this.mat,this.offsetX,this.offsetX+s,this.offsetY,this.offsetY+i,1,-1)}render(t){const o=this.activePageData,n=this.mat,r=this.maxLineLength,s=4291829936,i=4279895062,c=4293849343,l=4286586976,f=4291829936,d=wr().background.textureIndex;t.start(n,Te.Font),t.addGlyph(-1.5,-.75,r+1.5,o.length+.75,{textureIndex:d,color:s}),t.addGlyph(-1,-.5,r+1,o.length+.5,{textureIndex:d,color:i}),t.flush();const a=le.create();le.ortho(a,0,this.screenSize[0],0,this.screenSize[1],1,-1),t.start(a,Te.Font);for(let u in this.touchTargets){ne!=null&&ne.controlStates[u]&&(this.highlightedAction=this.actionSequence.indexOf(u));const h=this.touchTargets[u].rect,y=this.highlightedAction<this.actionSequence.length&&this.actionSequence[this.highlightedAction]===u?f:l;t.addGlyph(h[0],h[1],h[0]+h[2],h[1]+h[3],{textureIndex:d,color:y})}t.flush(),t.start(n,Te.Entity);for(const u of this.glyphs){const h=u[1];t.addGlyph(h[0],h[1],h[2]+h[0],h[3]+h[1],{textureIndex:u[0],color:_})}t.flush(),t.start(n,Te.Font);for(let u=0;u<o.length;++u){const h=o.length-(1+u);for(let p=0;p<o[u].length;++p){const y=p;if(o[u]===" ")continue;const x=o[u].charCodeAt(p);t.addGlyph(y,h,y+1,h+1,{textureIndex:x,color:c})}}t.flush()}updateData(t){}update(t){}navigateUI(t){let o="";return t("up")?(this.highlightedAction--,this.highlightedAction<0&&(this.highlightedAction=this.actionSequence.length-1)):t("down")?(this.highlightedAction++,this.highlightedAction>=this.actionSequence.length&&(this.highlightedAction=0)):this.highlightedAction<this.actionSequence.length&&t("menuAccept")&&(o=this.actionSequence[this.highlightedAction]),o}onControls(t,o){}}class _l extends Le{constructor(){super(),this.pages=[`LLLOOOT!

$playRestartOrResume$
[H|helpControls]: Controls help
[M|helpKey]: Map key
[D|homeDaily]: Daily challenge
[O|homeOptions]: Options
[S|homeStats]: Statistics
[A|homeAchievements]: Achievements
[C|credits]: Credits$devMode$`],this.devSequence="LRLRUD",this.devSequenceCursor=0}update(t){const o=t.hasStartedGame?t.dailyRun!==null?`[R|homePlay]: Resume daily game
[N|homeRestart]: New game`:`[R|homePlay]: Resume game
[N|homeRestart]: New game`:`[P|homePlay]: Play game
`;this.state.set("playRestartOrResume",o),this.state.set("devMode",t.devMode?`
[X|devMenu]: Developer menu`:"")}onControls(t,o){const n=this.navigateUI(o);o("homePlay")||n=="homePlay"||o("menu")||n=="menu"||o("menuToggle")?(Oe(t),this.devSequenceCursor=0):o("devMenu")||n=="devMenu"?t.gameMode=F.DevScreen:o("homeRestart")||n=="homeRestart"?(t.rng=new Ne,t.dailyRun=null,Qe(t)):o("homeDaily")||n=="homeDaily"?t.gameMode=F.DailyHub:o("homeStats")||n=="homeStats"?t.gameMode=F.StatsScreen:o("homeAchievements")||n=="homeAchievements"?t.gameMode=F.AchievementsScreen:o("homeOptions")||n=="homeOptions"?t.gameMode=F.OptionsScreen:o("helpControls")||n=="helpControls"?t.gameMode=F.HelpControls:o("helpKey")||n=="helpKey"?t.gameMode=F.HelpKey:(o("credits")||n=="credits")&&(t.gameMode=F.CreditsScreen),o("left")&&this.updateCheatCode("L",t),o("right")&&this.updateCheatCode("R",t),o("up")&&this.updateCheatCode("U",t),o("down")&&this.updateCheatCode("D",t)}updateCheatCode(t,o){this.devSequence[this.devSequenceCursor]!==t&&(this.devSequenceCursor=0),this.devSequence[this.devSequenceCursor]===t&&++this.devSequenceCursor,this.devSequenceCursor>=this.devSequence.length&&(o.devMode=!o.devMode,this.devSequenceCursor=0)}}class Ll extends Le{constructor(){super(),this.pages=[`Developer Menu

[Alt+<|prevLevel]  Previous level
[Alt+>|nextLevel]  Next level
[Alt+C|collectLoot]  Collect loot 
[Alt+K|getKey]  Get key
[Alt+S|markSeen]  Mark mansion seen
[Alt+A|seeAll]  See entire map: $seeAll$
[Alt+P|guardPatrols]  See guard patrols: $guardPatrols$
[Alt+V|guardSight]  See guard sight: $guardSight$
[Alt+B|roomAdjacencies]  See rooms: $roomAdjacencies$
[Alt+F|showFPS]  Show FPS: $showFPS$

$message$

[Esc|menuBack]    Back to menu`],this.state.set("message","")}update(t){this.state.set("showFPS",t.fpsInfo.enabled?"Yes":"No"),this.state.set("seeAll",t.seeAll?"Yes":"No"),this.state.set("guardPatrols",t.seeGuardPatrols?"Yes":"No"),this.state.set("guardSight",t.seeGuardSight?"Yes":"No"),this.state.set("roomAdjacencies",t.seeRoomAdjacencies?"Yes":"No"),this.state.set("showFPS",t.fpsInfo.enabled?"Yes":"No")}onControls(t,o){const n=this.navigateUI(o);if(o("menuToggle"))Oe(t);else if(o("menuBack")||n=="menuBack")t.gameMode=F.HomeScreen,this.state.set("message","");else if(o("prevLevel")||n=="prevLevel")t.hasStartedGame?t.level>0&&(Mt(t),wt(t,t.level-1)):this.state.set("message","START GAME FIRST");else if(o("nextLevel")||n=="nextLevel")t.hasStartedGame?t.level<t.gameMapRoughPlans.length-1&&(Mt(t),wt(t,t.level+1)):this.state.set("message","START GAME FIRST");else if(o("collectLoot")||n=="collectLoot")if(t.hasStartedGame){const r=t.gameMap.collectAllLoot();t.player.loot+=r,t.lootStolen+=r,be(t)}else this.state.set("message","START GAME FIRST");else o("getKey")||n=="getKey"?t.player.hasVaultKey=!0:o("markSeen")||n=="markSeen"?t.hasStartedGame?(t.gameMap.markAllSeen(),be(t)):this.state.set("message","START GAME FIRST"):o("seeAll")||n=="seeAll"?(t.seeAll=!t.seeAll,this.state.set("message","")):o("guardSight")||n=="guardSight"?(t.seeGuardSight=!t.seeGuardSight,this.state.set("message","")):o("guardPatrols")||n=="guardPatrols"?(t.seeGuardPatrols=!t.seeGuardPatrols,this.state.set("message","")):o("roomAdjacencies")||n==="roomAdjacencies"?(t.seeRoomAdjacencies=!t.seeRoomAdjacencies,this.state.set("message","")):(o("showFPS")||n=="showFPS")&&(t.fpsInfo.enabled=!t.fpsInfo.enabled,this.state.set("message",""))}}class Rl extends Le{constructor(){super(...arguments),this.pages=[`Options

         Sound volume: $volumeLevel$%
[=|volumeUp]      Volume up
[-|volumeDown]      Volume down
[0|volumeMute]      Volume mute: $volumeMute$
[9|guardMute]      Guard mute: $guardMute$
[J|screenShakeEnabled]      Jolt screen: $screenShakeEnabled$
[K|keyRepeatRate]      Key repeat rate $keyRepeatRate$ms
[D|keyRepeatDelay]      Key repeat delay $keyRepeatDelay$ms
[Ctrl+R|forceRestart] Reset data

[Esc|menuBack]    Back to menu`]}update(t){this.state.set("volumeLevel",(t.soundVolume*100).toFixed(0)),this.state.set("volumeMute",t.volumeMute?"Yes":"No"),this.state.set("guardMute",t.guardMute?"Yes":"No"),this.state.set("screenShakeEnabled",t.screenShakeEnabled?"Yes":"No"),this.state.set("keyRepeatRate",t.keyRepeatRate.toString()),this.state.set("keyRepeatDelay",t.keyRepeatDelay.toString())}onControls(t,o){const n=this.navigateUI(o);if(o("menuToggle"))Oe(t);else if(o("menuBack")||n=="menuBack")t.gameMode=F.HomeScreen;else if(o("volumeUp")||n=="volumeUp"){const r=Math.min(1,t.soundVolume+.1);xt(t,r)}else if(o("volumeDown")||n=="volumeDown"){const r=Math.max(.1,t.soundVolume-.1);xt(t,r)}else o("volumeMute")||n=="volumeMute"?Bo(t,!t.volumeMute):o("guardMute")||n=="guardMute"?Go(t,!t.guardMute):o("screenShakeEnabled")||n==="screenShakeEnabled"?Nu(t,!t.screenShakeEnabled):o("keyRepeatRate")||n=="keyRepeatRate"?(t.keyRepeatRate-=50,t.keyRepeatRate<100&&(t.keyRepeatRate=400),window.localStorage.setItem("LLL/keyRepeatRate",t.keyRepeatRate.toString())):o("keyRepeatDelay")||n=="keyRepeatDelay"?(t.keyRepeatDelay-=50,t.keyRepeatDelay<100&&(t.keyRepeatDelay=500),window.localStorage.setItem("LLL/keyRepeatDelay",t.keyRepeatDelay.toString())):(o("forceRestart")||n=="forceRestart")&&(window.localStorage.clear(),t.persistedStats=br(),t.gameMode=F.HomeScreen,xt(t,1),Bo(t,!1),Go(t,!1))}}class Al extends Le{constructor(){super(...arguments),this.pages=[`Help: Keyboard Controls

  Move: Arrows / WASD / HJKL
  Wait: Space / Z / Period / Numpad5
  Leap/Run: Shift + move (unlimited!)
  Leap/Run (Toggle): F / Numpad+
  Zoom View: [ / ]
  Scroll View: Control + move
  Recenter View: Control + wait
  Volume: (Mute/Down/Up) 0 / - / =
  Guard Mute (Toggle): 9
  Show last speech: Tab

Disable NumLock if using numpad
Touch and gamepad also supported

[Esc|menuBack] Back to menu`,`Help: Touch Controls

  Move: #016# / #017# / #018# / #019#
  Wait: #020#
  Leap/Run: #21# + move (unlimited!)
  Zoom View: #22# / #23#
  Scroll View: Touch and drag
  Menu: #27#
  Navigate menu: #018# / #019# / #20#

Keyboard and gamepad also supported

[Esc|menuBack] Back to menu`,`Help: Gamepad Controls

  Move: Left Stick/Pad
  Wait: Button2
  Leap/Run: Button1 + move
  Zoom View: Left / Right trigger
  Scroll View: Right stick
  Recenter View: Right bumper
  Show last speech: Left bumper

Keyboard and touch also supported

[Esc|menuBack] Back to menu`]}update(t){this.activePage=ne===t.keyboardController?0:ne===t.touchController?t.touchController.mouseActive?0:1:2}onControls(t,o){const n=this.navigateUI(o);o("menuToggle")?Oe(t):(o("menuBack")||n=="menuBack")&&(t.gameMode=F.HomeScreen)}}const Il=oe().namedTiles.treasureA.textureIndex,Cl=oe().namedTiles.treasureB.textureIndex,bl=oe().namedTiles.treasureC.textureIndex,Pl=oe().namedTiles.treasureD.textureIndex,kl=oe().namedTiles.treasureE.textureIndex,Dl=oe().namedTiles.treasureV.textureIndex;class Wl extends Le{constructor(){super(...arguments),this.pages=[`Map Key

#${oe().playerTiles.normal.textureIndex}# Thief: You!
#${oe().npcTiles[3].textureIndex}# Guard: Avoid them!
#${oe().itemTiles[M.Coin].textureIndex}# Loot: Steal it!
#${oe().itemTiles[M.Bush].textureIndex}# Tree: Hiding place
#${oe().itemTiles[M.Table].textureIndex}# Table: Hiding place
#${oe().itemTiles[M.Chair].textureIndex}# Stool: Guards sit here
#${oe().itemTiles[M.TorchLit].textureIndex}# Torch: Douse it
#${oe().namedTiles.uiWindowTile.textureIndex}# Window: One-way escape
#${oe().namedTiles.uiCreakyTile.textureIndex}# Creaky floor: Alerts guards
Bonus loot: Steal it?
#${Il}##${Cl}##${bl}##${Pl}##${kl}##${Dl}#

[Esc|menuBack] Back to menu`]}update(t){}onControls(t,o){const n=this.navigateUI(o);o("menuToggle")?Oe(t):(o("menuBack")||n=="menuBack")&&(t.gameMode=F.HomeScreen)}}class Vl extends Le{constructor(){super(...arguments),this.pages=[`Credits

Made for 2023 Seven-Day Roguelike Challenge
Expanded Post-Jam Edition

by James McNeill and Damien Moore

Additional voices by Evan Moore
Additional assistance by Mike Gaffney
Testing by Mendi Carroll and Tom Elmer
Special thanks to Mendi Carroll

[Esc|menuBack] Back to menu`]}update(t){}onControls(t,o){const n=this.navigateUI(o);o("menuToggle")?Oe(t):(o("menuBack")||n=="menuBack")&&(t.gameMode=F.HomeScreen)}}class Bl extends Le{constructor(){super(...arguments),this.pages=[`The Daily Challenge

Play a new seeded game each day and 
compare results with your rivals.

$dailyStatus$
Plays:             $plays$
Wins:              $wins$
Best score:        $bestScore$

$playMode$
$timeLeft$

Last game played:  $lastPlayed$
Last score:        $lastScore$
[S|scorePopup] Score popup (for copy/paste)

[Esc|menuBack] Back to menu`]}timeToMidnightUTC(){const t=new Date,o=new Date(t);o.setUTCHours(24,0,0,0);const n=o.getTime()-t.getTime(),r=Math.floor(n/1e3%60),s=Math.floor(n/(1e3*60)%60);return Math.floor(n/(1e3*60*60)%24).toString().padStart(2,"0")+":"+s.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")}update(t){const o=t.persistedStats.lastPlayedDailyGame;if(t.persistedStats.currentDailyGameId!==Tt()&&(t.persistedStats.currentDailyGameId=Tt(),t.persistedStats.currentDailyPlays=0,t.persistedStats.currentDailyWins=0,t.persistedStats.currentDailyWinFirstTry=0,t.persistedStats.currentDailyBestScore=0,Zo(t.persistedStats)),o!==null&&t.persistedStats.currentDailyPlays>0){if(t.persistedStats.currentDailyWins===0)this.state.set("dailyStatus",t.persistedStats.currentDailyGameId+" game played");else if(t.persistedStats.currentDailyWinFirstTry===0)this.state.set("dailyStatus",t.persistedStats.currentDailyGameId+" game won");else{const s=oe().itemTiles[M.TorchLit].textureIndex;this.state.set("dailyStatus",t.persistedStats.currentDailyGameId+` game won first try #${s}#`)}this.state.set("timeLeft","Time to next game: "+this.timeToMidnightUTC()),this.state.set("playMode","[P|homePlay] Play it again")}else this.state.set("dailyStatus",t.persistedStats.currentDailyGameId+" game ready"),this.state.set("timeLeft","Time left to play: "+this.timeToMidnightUTC()),this.state.set("playMode","[P|homePlay] Play now");const n=(o==null?void 0:o.daily)??"None",r=(o==null?void 0:o.totalScore)??0;this.state.set("plays",t.persistedStats.currentDailyPlays.toString()),this.state.set("wins",t.persistedStats.currentDailyWins.toString()),this.state.set("lastPlayed",n),this.state.set("lastScore",r.toString()),this.state.set("bestScore",t.persistedStats.currentDailyBestScore.toString())}onControls(t,o){if(Rt)(o("menuAccept")||o("menuBack"))&&io();else{const n=this.navigateUI(o);o("menuToggle")?Oe(t):o("menuBack")||n=="menuBack"?t.gameMode=F.HomeScreen:o("homePlay")||n=="homePlay"?(Pr(t),t.hasStartedGame=!0):(o("scorePopup")||n=="scorePopup")&&zo(t.persistedStats.lastPlayedDailyGame,t.achievements)}}}class Gl extends Le{constructor(){super(...arguments),this.pages=[`Play Statistics

All games
Total plays:             $totalPlays$
Total wins:              $totalWins$
Total mansions ghosted:  $totalGhosts$
Best score:              $bestScore$

Daily games
Total plays:             $allDailyPlays$
Total wins:              $allDailyWins$
Total wins first try:    $allDailyWinsFirstTry$

[Esc|menuBack] Back to menu`]}update(t){this.state.set("totalPlays",t.persistedStats.totalPlays.toString()),this.state.set("totalWins",t.persistedStats.totalWins.toString()),this.state.set("totalGhosts",t.persistedStats.totalGhosts.toString()),this.state.set("bestScore",t.persistedStats.bestScore.toString()),this.state.set("allDailyPlays",t.persistedStats.allDailyPlays.toString()),this.state.set("allDailyWins",t.persistedStats.allDailyWins.toString()),this.state.set("allDailyWinsFirstTry",t.persistedStats.allDailyWinsFirstTry.toString())}onControls(t,o){const n=this.navigateUI(o);o("menuToggle")?Oe(t):(o("menuBack")||n=="menuBack")&&(t.gameMode=F.HomeScreen)}}class Ul extends Le{constructor(){super(...arguments),this.pages=[`Achievements

Earn achievements by meeting certain
requirements when you complete a game.

 $victoryAchieved$ Victory: winning is enough...
 $hungryAchieved$ Hungry: collect all food
 $treasureAchieved$ Looty: steal all bonus loot
 $healthyAchieved$ Healthy: take no damage
 $steppyAchieved$ Steppy: no leap where a step works
 $thumpyAchieved$ Thumpy: knock out all guards
 $softyAchieved$ Softy: no knockouts
 $mappingAchieved$ Looky: map 100% before looting anything
 $facelessAchieved$ Ghosty: ghost every level
 $zippyAchieved$ Zippy: under par time on every level
 $ghostyAchieved$ Mosty Ghosty: ghost with no knockouts

[Esc|menuBack] Back to menu`]}update(t){const o=oe().achievementIcons,n=`#${oe().achievementIncompleteIcon.textureIndex}#`,r=`#${oe().achievementFailedIcon.textureIndex}#`,s=t.dailyRun!==null;function i(c,l,f,d,a){const u=f>0?`#${a.textureIndex}#`:d.failed||s?r:n;c.state.set(l,u)}i(this,"victoryAchieved",t.persistedStats.achievementVictory,t.achievements.achievementVictory,o.achievementVictory),i(this,"ghostyAchieved",t.persistedStats.achievementGhosty,t.achievements.achievementGhosty,o.achievementGhosty),i(this,"zippyAchieved",t.persistedStats.achievementZippy,t.achievements.achievementZippy,o.achievementZippy),i(this,"hungryAchieved",t.persistedStats.achievementHungry,t.achievements.achievementHungry,o.achievementHungry),i(this,"thumpyAchieved",t.persistedStats.achievementThumpy,t.achievements.achievementThumpy,o.achievementThumpy),i(this,"softyAchieved",t.persistedStats.achievementSofty,t.achievements.achievementSofty,o.achievementSofty),i(this,"steppyAchieved",t.persistedStats.achievementSteppy,t.achievements.achievementSteppy,o.achievementSteppy),i(this,"healthyAchieved",t.persistedStats.achievementHealthy,t.achievements.achievementHealthy,o.achievementHealthy),i(this,"treasureAchieved",t.persistedStats.achievementTreasure,t.achievements.achievementTreasure,o.achievementTreasure),i(this,"mappingAchieved",t.persistedStats.achievementMapping,t.achievements.achievementMapping,o.achievementMapping),i(this,"facelessAchieved",t.persistedStats.achievementFaceless,t.achievements.achievementFaceless,o.achievementFaceless)}onControls(t,o){const n=this.navigateUI(o);o("menuToggle")?Oe(t):(o("menuBack")||n=="menuBack")&&(t.gameMode=F.HomeScreen)}}class El extends Le{constructor(){super(...arguments),this.pages=[`$levelType$ Looted! ($level$/$numLevels$)

 Loot:        $lootScore$$treasureScore$$foodScore$
 Ghost:       $ghostBonus$
 Speed:       $timeBonus$
 Total:       $levelScore$

 Cumulative:  $totalScore$

[N|startLevel]: Next`]}update(t){const o=Ct(t),n=Math.max(0,o-t.turns),r=t.lootStolen*10,s=_r(t),i=t.levelStats.extraFoodCollected*5,l=t.levelStats.numSpottings===0?r:0,f=r+s+i+n+l;this.state.set("levelType",qr(t.gameMapRoughPlans[t.level].levelType)),this.state.set("level",(t.level+1).toString()),this.state.set("numLevels",t.gameMapRoughPlans.length.toString()),this.state.set("lootScore",(t.lootStolen*10).toString()),this.state.set("treasureScore",cu(t)?`
 Bonus Loot:  `+s:""),this.state.set("foodScore",i>0?`
 Food:        `+i:""),this.state.set("timeBonus",n.toString()),this.state.set("ghostBonus",l.toString()),this.state.set("levelScore",f.toString()),this.state.set("totalScore",t.gameStats.totalScore.toString())}onControls(t,o){const n=this.navigateUI(o);(o("startLevel")||n=="startLevel")&&(t.level>=t.gameMapRoughPlans.length-1?fu(t):wt(t,t.level+1))}}class Nl extends Le{constructor(){super(...arguments),this.pages=[`         You are dead!

 Total Score:   $totalScore$

Statistics
 Completed:     $level$ of $numLevels$
 Total turns:   $totalTurns$
 Spottings:     $numSpottings$
 Injuries:      $numInjuries$
 Knockouts:     $numKnockouts$
 Ghosted:       $numGhostedLevels$

[N|homeRestart]:   New game
[S|scorePopup]:   Score popup (for copy/paste)
[Esc|menuBack]: Exit to home screen`]}update(t){this.state.set("level",t.gameStats.numCompletedLevels.toString()),this.state.set("numLevels",t.gameStats.numLevels.toString()),this.state.set("numGhostedLevels",t.gameStats.numGhostedLevels.toString()),this.state.set("totalScore",t.gameStats.totalScore.toString()),this.state.set("totalTurns",`${t.gameStats.turns}`),this.state.set("numSpottings",`${t.gameStats.numSpottings}`),this.state.set("numInjuries",`${t.gameStats.numInjuries}`),this.state.set("numKnockouts",`${t.gameStats.numKnockouts}`)}onControls(t,o){if(Rt)(o("menuAccept")||o("menuBack"))&&io();else{const n=this.navigateUI(o);o("homeRestart")||n=="homeRestart"?(t.rng=new Ne,t.dailyRun=null,Qe(t)):o("menuBack")||n=="menuBack"?(t.rng=new Ne,t.dailyRun=null,Qe(t),t.gameMode=F.HomeScreen,t.hasStartedGame=!1):(o("scorePopup")||n=="scorePopup")&&zo(t.gameStats,t.achievements)}}}class Fl extends Le{constructor(){super(...arguments),this.pages=[`Mission Complete!

 Total Score:   $totalScore$$achievements$

Statistics
 Completed:     $level$ of $numLevels$
 Total turns:   $totalTurns$
 Spottings:     $numSpottings$
 Injuries:      $numInjuries$
 Knockouts:     $numKnockouts$
 Ghosted:       $numGhostedLevels$

[N|homeRestart]:   New game
[S|scorePopup]:   Score popup (for copy/paste)
[Esc|menuBack]: Exit to home screen`],this.achievementsLine=void 0}update(t){if(this.state.set("level",t.gameStats.numCompletedLevels.toString()),this.state.set("numLevels",t.gameStats.numLevels.toString()),this.state.set("totalTurns",`${t.gameStats.turns}`),this.state.set("numSpottings",`${t.gameStats.numSpottings}`),this.state.set("numInjuries",`${t.gameStats.numInjuries}`),this.state.set("numKnockouts",`${t.gameStats.numKnockouts}`),this.state.set("numGhostedLevels",t.gameStats.numGhostedLevels.toString()),this.state.set("totalScore",t.gameStats.totalScore.toString()),this.achievementsLine===void 0){if(this.achievementsLine="",!t.dailyRun){let o;for(o in t.achievements)t.achievements[o].failed||(this.achievementsLine+=`#${oe().achievementIcons[o].textureIndex}#`);this.achievementsLine.length>0&&(this.achievementsLine=`
Achievements:  `+this.achievementsLine)}this.state.set("achievements",this.achievementsLine)}}onControls(t,o){if(Rt)(o("menuAccept")||o("menuBack"))&&io();else{const n=this.navigateUI(o);o("homeRestart")||n=="homeRestart"?(t.rng=new Ne,t.dailyRun=null,this.achievementsLine=void 0,Qe(t)):o("menuBack")||n=="menuBack"?(t.rng=new Ne,t.dailyRun=null,Qe(t),t.gameMode=F.HomeScreen,this.achievementsLine=void 0,t.hasStartedGame=!1):(o("scorePopup")||n=="scorePopup")&&zo(t.gameStats,t.achievements)}}}function Ol(){return{achievementVictory:new Hl,achievementHungry:new $l,achievementTreasure:new Ql,achievementHealthy:new Kl,achievementSteppy:new Yl,achievementThumpy:new jl,achievementSofty:new ql,achievementMapping:new Zl,achievementFaceless:new Jl,achievementZippy:new Xl,achievementGhosty:new zl}}class Pe{constructor(){this.failed=!1,this.unicodeBadge=""}update(t,o){o==="gameStart"&&(this.failed=!1)}}class Hl extends Pe{constructor(){super(...arguments),this.unicodeBadge="🏆"}update(t,o){super.update(t,o)}}class zl extends Pe{constructor(){super(...arguments),this.unicodeBadge="🐺"}update(t,o){super.update(t,o),o==="turnEnd"&&(t.levelStats.numSpottings>0||t.levelStats.numKnockouts>0)&&(this.failed=!0)}}class Xl extends Pe{constructor(){super(...arguments),this.unicodeBadge="🏃"}update(t,o){super.update(t,o),o==="turnEnd"&&t.turns>Ct(t)&&(this.failed=!0)}}class Yl extends Pe{constructor(){super(...arguments),this.unicodeBadge="🚶"}update(t,o){super.update(t,o),o==="turnEnd"&&t.levelStats.steppableLeaps>0&&(this.failed=!0)}}class jl extends Pe{constructor(){super(...arguments),this.unicodeBadge="👊"}update(t,o){super.update(t,o),o==="levelEnd"&&t.gameMap.guards.some(n=>n.mode!==fe.Unconscious)&&(this.failed=!0)}}class ql extends Pe{constructor(){super(...arguments),this.unicodeBadge="☮"}update(t,o){super.update(t,o),o==="levelEnd"&&t.levelStats.numKnockouts>0&&(this.failed=!0)}}class $l extends Pe{constructor(){super(...arguments),this.unicodeBadge="🥪"}update(t,o){super.update(t,o),o==="levelEnd"&&t.gameMap.items.some(n=>n.type===M.Health)&&(this.failed=!0)}}class Kl extends Pe{constructor(){super(...arguments),this.unicodeBadge="🤕"}update(t,o){super.update(t,o),o==="turnEnd"&&t.player.health<t.player.healthMax&&(this.failed=!0)}}class Ql extends Pe{constructor(){super(...arguments),this.unicodeBadge="💎"}update(t,o){super.update(t,o),o==="turnEnd"?t.gameMap.items.some(n=>n.type===M.EmptyVaultTreasureBox)&&(this.failed=!0):o==="levelEnd"&&t.gameMap.items.some(n=>n.type>=M.TreasureA||n.type===M.VaultTreasureBox||n.type===M.EmptyVaultTreasureBox)&&(this.failed=!0)}}class Zl extends Pe{constructor(){super(...arguments),this.unicodeBadge="🗺"}update(t,o){super.update(t,o),o==="turnEnd"&&!this.failed&&(t.lootStolen>0||t.treasureStolen>0||t.levelStats.extraFoodCollected>0)&&!t.gameMap.allSeen()&&(this.failed=!0)}}class Jl extends Pe{constructor(){super(...arguments),this.unicodeBadge="👻"}update(t,o){super.update(t,o),o==="turnEnd"&&t.levelStats.numSpottings>0&&(this.failed=!0)}}const eo={numGameMaps:10,totalGameLoot:100},Sr=0,gt=!1,eu=gt,Do=Mr(),j=oe(),et=wr(),Ae=document.querySelector("canvas");let Wo=Ae.clientWidth,Vo=Ae.clientHeight;window.onload=su;window.onclick=()=>{window.focus()};const At=8,Fe=16,tt=16,$e=16,lt=1.1892,kn=4,tu=-4,ou=16,Tr=.5,nu=`New Game: Ctrl+R
Menu: Esc/Slash`,ru=`Retry: Ctrl+R
Menu: Esc/Slash`;function su(){window.focus(),Promise.all([_o(et.imageSrc,et.image),_o(Do.imageSrc,Do.image),_o(j.imageSrc,j.image)]).then(iu)}function iu(e){document.body.addEventListener("keydown",a=>l()),Ae.addEventListener("mousedown",a=>l()),Ae.addEventListener("touchstart",a=>l()),window.addEventListener("gamepadconnected",a=>l());const t=new Fi(Ae,Do,j,et),o={},n={},r=new Pn,s=new Pn,i=new wl(Ae),c=Fu(o,n,r,s,i);function l(){if(Object.keys(c.sounds).length==0){ml(c.sounds,c.subtitledSounds,c.activeSoundPool,c.ambientSoundPool),_e.Howler.volume(c.soundVolume),_e.Howler.mute($t(c));for(const a in c.subtitledSounds)c.subtitledSounds[a].mute=c.guardMute}}window.addEventListener("blur",a=>{_e.Howler.mute($t(c))}),window.addEventListener("focus",a=>{_e.Howler.mute($t(c))});function f(){requestAnimationFrame(a=>kr(a,t,c))}new ResizeObserver(a=>{Wo=Ae.clientWidth,Vo=Ae.clientHeight,c.camera.snapped=!1,screen.orientation.unlock()}).observe(Ae),f()}function au(e){var r;if(e.gamepadManager.updateGamepadStates(),ne!==null){e.gameMode===F.Mansion?n(ne):(r=e.textWindows[e.gameMode])==null||r.onControls(e,o),e.touchController.endFrame(),e.keyboardController.endFrame();for(const s in e.gamepadManager.gamepads)e.gamepadManager.gamepads[s].endFrame()}function t(s){const i=Date.now();let c=!1;if(ne===null)return!1;const l=ne.controlStates;if(!(s in l))return!1;const f=e.keyRepeatActive===s?e.keyRepeatRate:e.keyRepeatDelay;return c=ne.currentFramePresses.has(s)||l[s]&&i-ne.controlTimes[s]>f,c&&(l[s]&&i-ne.controlTimes[s]>f&&(e.keyRepeatActive=s),ne.controlTimes[s]=i),!l[s]&&e.keyRepeatActive===s&&(e.keyRepeatActive=void 0),c}function o(s){let i=!1;if(ne===null)return!1;const c=ne.controlStates;return s in c?(i=ne.currentFramePresses.has(s),i&&ne.controlTimes[s]==Date.now(),i):!1}function n(s){if(s.controlStates.panLeft&&(e.camera.panning=!0,e.camera.position[0]-=1/e.camera.zoom),s.controlStates.panRight&&(e.camera.panning=!0,e.camera.position[0]+=1/e.camera.zoom),s.controlStates.panUp&&(e.camera.panning=!0,e.camera.position[1]+=1/e.camera.zoom),s.controlStates.panDown&&(e.camera.panning=!0,e.camera.position[1]-=1/e.camera.zoom),s.controlStates.snapToPlayer&&(e.camera.panning=!1),t("left"))e.leapToggleActive!==s.controlStates.jump?Ut(e,-1,0):ve(e,-1,0,0);else if(t("right"))e.leapToggleActive!==s.controlStates.jump?Ut(e,1,0):ve(e,1,0,0);else if(t("down"))e.leapToggleActive!==s.controlStates.jump?Ut(e,0,-1):ve(e,0,-1,0);else if(t("up"))e.leapToggleActive!==s.controlStates.jump?Ut(e,0,1):ve(e,0,1,0);else if(t("wait"))yu(e);else if(t("menu")||t("menuToggle"))e.player.health>0?e.gameMode=F.HomeScreen:e.gameMode=F.Dead;else if(t("jumpToggle"))e.leapToggleActive=!e.leapToggleActive;else if(t("seeAll"))e.devMode&&(e.seeAll=!e.seeAll);else if(t("collectLoot")){if(e.devMode){const i=e.gameMap.collectAllLoot();e.player.loot+=i,e.lootStolen+=i,be(e)}}else if(t("getKey")){if(e.devMode){e.player.hasVaultKey=!0;for(const i of e.gameMap.guards)i.hasVaultKey=!1}}else if(t("forceRestart"))e.dailyRun?Pr(e):(e.rng=new Ne,e.dailyRun=null,Qe(e));else if(t("nextLevel"))e.devMode&&e.level<e.gameMapRoughPlans.length-1&&(Mt(e),wt(e,e.level+1),e.camera.zoomed=!1);else if(t("resetState"))e.devMode&&zu(e);else if(t("prevLevel"))e.devMode&&e.level>0&&(Mt(e),wt(e,e.level-1),e.camera.zoomed=!1);else if(t("showFPS"))e.devMode&&(e.fpsInfo.enabled=!e.fpsInfo.enabled);else if(t("guardSight"))e.devMode&&(e.seeGuardSight=!e.seeGuardSight);else if(t("guardPatrols"))e.devMode&&(e.seeGuardPatrols=!e.seeGuardPatrols);else if(t("roomAdjacencies"))e.devMode&&(e.seeRoomAdjacencies=!e.seeRoomAdjacencies);else if(t("markSeen"))e.devMode&&(e.gameMap.markAllSeen(),be(e));else if(t("zoomIn"))Ou(e);else if(t("zoomOut"))Hu(e);else if(t("guardMute"))Go(e,!e.guardMute),e.popups.setNotification("Guard speech: "+(e.guardMute?"disabled":"enabled"),e.player,3,2);else if(t("idleCursorToggle")){switch(e.player.idleCursorType){case"orbs":e.player.idleCursorType="off";break;case"off":e.player.idleCursorType="orbs";break}e.player.idle=!1,e.idleTimer=2,e.popups.setNotification("Player idle cursor: "+e.player.idleCursorType,e.player,3,2)}else if(t("volumeMute"))Bo(e,!e.volumeMute),e.popups.setNotification("Sound: "+(e.volumeMute?"disabled":"enabled"),e.player,3,2);else if(t("volumeDown")){const i=Math.max(.1,e.soundVolume-.1);xt(e,i),e.popups.setNotification("Sound volume: "+Math.floor(e.soundVolume*100+.5)+"%",e.player,3,2)}else if(t("volumeUp")){const i=Math.min(1,e.soundVolume+.1);xt(e,i),e.popups.setNotification("Sound volume: "+Math.floor(e.soundVolume*100+.5)+"%",e.player,3,2)}else t("showSpeech")&&e.popups.toggleShow(e.player.pos)}}function Mt(e){if(e.gameMapRoughPlans[e.level].played)return;e.gameMapRoughPlans[e.level].played=!0;const t=e.levelStats.numSpottings===0,o=Ct(e),n=Math.max(0,o-e.turns),r=e.lootStolen*10,s=_r(e),i=e.levelStats.extraFoodCollected*5,c=t?r:0,l=r+s+i+n+c;e.gameStats.totalScore+=l,e.gameStats.turns=e.totalTurns,e.gameStats.numLevels=e.gameMapRoughPlans.length,e.gameStats.numCompletedLevels=e.level+1,e.gameStats.numGhostedLevels+=t?1:0,e.gameStats.numInjuries+=e.levelStats.damageTaken,e.gameStats.numKnockouts+=e.levelStats.numKnockouts,e.gameStats.numSpottings+=e.levelStats.numSpottings,e.gameStats.daily=e.dailyRun,e.gameStats.timeEnded=Date.now()}function lu(e){if(e.gameMapRoughPlans[e.level].played)return;e.gameMapRoughPlans[e.level].played=!0;const t=e.lootStolen*10+e.levelStats.extraFoodCollected*5;e.gameStats.totalScore+=t,e.gameStats.turns=e.totalTurns,e.gameStats.numLevels=e.gameMapRoughPlans.length,e.gameStats.numCompletedLevels=e.level,e.gameStats.numInjuries+=e.levelStats.damageTaken,e.gameStats.numKnockouts+=e.levelStats.numKnockouts,e.gameStats.numSpottings+=e.levelStats.numSpottings,e.gameStats.daily=e.dailyRun,e.gameStats.timeEnded=Date.now()}function Xo(e){e.numKnockouts=0,e.numSpottings=0,e.damageTaken=0,e.extraFoodCollected=0,e.steppableLeaps=0}function It(e,t){let o;for(o in e.achievements)e.achievements[o].update(e,t)}function uu(e){let t,o;for(t in e.achievements)t in e.persistedStats&&(o=t,e.achievements[t].failed||(e.persistedStats[o]++,K(o,e.persistedStats[o])))}function wt(e,t){if(e.level=t,e.level>=e.gameMapRoughPlans.length){Qe(e);return}e.popups.reset(),e.activeSoundPool.empty(),e.ambientSoundPool.empty(),e.gameMap=so(e.gameMapRoughPlans[e.level]),e.lightStates=new Array(e.gameMap.lightCount).fill(0),fo(e.gameMap,e),uo(e.gameMap,e),co(e.gameMap),e.hintMessage="",Ko(e),e.finishedLevel=!1,e.turns=0,e.lootStolen=0,e.treasureStolen=0,e.lootAvailable=e.gameMapRoughPlans[e.level].totalLoot,Xo(e.levelStats),m.copy(e.player.pos,e.gameMap.playerStartPos),e.player.dir=m.fromValues(0,-1),e.player.noisy=!1,e.player.preNoisy=!1,e.player.hasVaultKey=!1,e.player.damagedLastTurn=!1,e.player.turnsRemainingUnderwater=oo,e.player.animation=null,e.popups.reset(),e.camera=lo(e.gameMap.playerStartPos,e.zoomLevel),e.camera.zoomed=t!==0,e.gameMode=F.Mansion,e.hasEnteredMansion=!1,Lt(e),be(e),Ke(e,e.player.pos),bt(e)}function Ct(e){const o=(e.gameMap.numCells()-e.gameMap.numPreRevealedCells)*e.gameMap.backtrackingCoefficient,n=e.gameMap.guards.length,r=n/o,s=o/3.5,i=8*n+1e3*r;return 10*Math.ceil((s+i)/10)}function To(e,t){return e.reduce((o,n)=>o+(t(n)?1:0),0)}function cu(e){return!!(e.gameMap.treasures.length>0||e.gameMap.items.some(t=>t.type===M.VaultTreasureBox||t.type===M.EmptyVaultTreasureBox||t.type===M.LootedVaultTreasureBox))}function _r(e){const t=e.lootStolen*10,o=t/2,n=30;let r=0;return r+=t*To(e.gameMap.treasures,s=>s.stolen&&s.switches.length>0),r+=o*To(e.gameMap.treasures,s=>s.stolen&&s.switches.length<=0),r+=n*To(e.gameMap.items,s=>s.type===M.LootedVaultTreasureBox),r}const Dn=["Use darkness or hiding places to avoid guards","Escape out windows with Shift+Dir","Knock out adjacent, unaware guards with Shift+Dir","Pickpocket by following exactly for two turns","Zoom view with [ and ]","Bang walls to make noise with Dir, then Shift+Dir","'Ghost' by never being fully seen","Knock out spotting guard by leaping onto them"];function Lr(e){Mt(e),It(e,"levelEnd"),e.activeSoundPool.empty(),e.ambientSoundPool.empty(),_e.Howler.stop(),e.sounds.levelCompleteJingle.play(.35),e.levelStats.numSpottings===0&&(e.persistedStats.totalGhosts++,K("totalGhosts",e.persistedStats.totalGhosts)),e.level<Dn.length?e.hintMessage="Hint: "+Dn[e.level]:e.hintMessage="",e.gameMode=F.MansionComplete}function fu(e){_e.Howler.stop();const t=Math.random()<.1?"easterEgg":"victorySong";e.sounds[t].play(.5),e.persistedStats.totalWins++;const o=e.gameStats.totalScore;e.persistedStats.bestScore=Math.max(e.persistedStats.bestScore,o);const n={score:o,date:Tt(),turns:e.totalTurns,level:e.level+1};It(e,"gameEnd"),e.persistedStats.scores.push(n),e.dailyRun&&(e.persistedStats.currentDailyBestScore=Math.max(e.persistedStats.currentDailyBestScore,o),e.persistedStats.currentDailyWins++,e.persistedStats.currentDailyWinFirstTry=e.persistedStats.currentDailyPlays===1?1:e.persistedStats.currentDailyWinFirstTry,e.persistedStats.lastPlayedDailyGame=structuredClone(e.gameStats),e.persistedStats.allDailyWins++,e.persistedStats.allDailyWinsFirstTry+=e.persistedStats.currentDailyPlays===1?1:0),Zo(e.persistedStats),e.dailyRun||uu(e),e.gameMode=F.Win}function Wn(e,t){return e.gameMap.hasLootAt(t)&&!e.gameMap.items.find(o=>o.type===M.TreasureLock&&o.pos.equals(t))}function it(e,t,o){const n=e.gameMap.collectLootAt(t);if(n.length===0)return!1;let r=!1,s=!1;for(const i of n){let c=i.type,l=0,f=1;if(i.type===M.Coin)++e.player.loot,++e.lootStolen,r=!0;else if(i.type>=M.TreasureA){r=!0,++e.treasureStolen;for(const a of e.gameMap.treasures)a.posTreasure.equals(i.pos)&&(a.stolen=!0,e.gameMapRoughPlans[e.level].levelType===E.Fortress&&Ee(e.gameMap,e.player,e.popups,3,t[0]-e.player.pos[0],t[1]-e.player.pos[1],e.sounds,46,!0));l=.5}else if(i.type===M.VaultTreasureBox){r=!0,c=M.Coin,f=3,e.gameMap.items.push({type:M.LootedVaultTreasureBox,pos:m.clone(t),topLayer:!1});const a=new Ze(oe().vaultGoldAnimationTiles,.15,0,1);a.removeOnFinish=!0,e.particles.push({pos:m.clone(i.pos),animation:a}),Ee(e.gameMap,e.player,e.popups,3,t[0]-e.player.pos[0],t[1]-e.player.pos[1],e.sounds,46,!0)}else i.type===M.Health&&(Ar(e),e.player.health>=e.player.healthMax?++e.levelStats.extraFoodCollected:(++e.player.health,Ir(e,e.player.health-1)),s=!0);const d=ao(e.gameMapRoughPlans[e.level].levelType,j);for(let a=0;a<f;a++){const u={type:c,pos:m.clone(i.pos),topLayer:!1},h=m.create(),p=m.fromValues(o[0]-i.pos[0],o[1]-i.pos[1]+l),y=p.scale(.3333).add(m.fromValues(0,.5+l/2)),g=new ue([{pt0:h,pt1:y,duration:.1,fn:O.easeOutQuad},{pt0:y,pt1:p,duration:.1,fn:O.easeInQuad}],[d[c],d[c]]);g.time=-a*.2,g.removeOnFinish=!0,u.animation=g,e.particles.push(u)}}return r&&e.sounds.coin.play(1),s&&e.sounds.food.play(.25),!0}function hu(e,t){if((t[0]<0||t[0]>=e.gameMap.cells.sizeX||t[1]<0||t[1]>=e.gameMap.cells.sizeY)&&!e.finishedLevel)return!1;const o=e.gameMap.cells.atVec(t);if(o.blocksPlayerMove||$o(o.type))return!1;for(const n of e.gameMap.items.filter(r=>r.pos.equals(t)))switch(n.type){case M.DrawersShort:case M.VaultTreasureBox:case M.EmptyVaultTreasureBox:case M.LootedVaultTreasureBox:case M.TorchUnlit:case M.TorchLit:case M.PortcullisEW:case M.PortcullisNS:case M.TreasureLock:case M.TreasurePlinth:case M.TreasureA:case M.TreasureB:case M.TreasureC:case M.TreasureD:case M.TreasureE:return!1}return!e.gameMap.guards.find(n=>n.pos.equals(t))}function Yo(e,t){if((t[0]<0||t[0]>=e.gameMap.cells.sizeX||t[1]<0||t[1]>=e.gameMap.cells.sizeY)&&!e.finishedLevel)return!1;const o=e.gameMap.cells.atVec(t);return!(o.blocksPlayerMove||$o(o.type)||o.type===L.PortcullisNS||o.type===L.PortcullisEW||(o.type===L.DoorNS||o.type===L.DoorEW)&&e.gameMap.items.some(n=>n.pos.equals(t)&&Eo(n.type))||e.gameMap.items.some(n=>n.pos.equals(t)&&!Tu(n.type))||e.gameMap.guards.some(n=>n.pos.equals(t)&&!n.allowsMoveOntoFrom(e.player.pos)))}function bt(e){switch(e.ambientSoundPool.empty(),e.ambience){case ge.Indoor:break;case ge.Outdoor:e.sounds.ambienceOutdoor.play(1,0,!0);break;case ge.Kitchen:e.sounds.ambienceKitchen.play(1,0,!0);break;case ge.Water:e.sounds.ambienceWater.play(.5,0,!0);break;case ge.OutdoorWater:e.sounds.ambienceWater.play(.5,0,!0),e.sounds.ambienceOutdoor.play(1,0,!0);break}}function du(e){let t=1/0,o=1/0,n=1/0;const r=e.gameMap.items.filter(f=>f.type===M.Stove),s=10;function i(f,d,a,u){const h=[];for(let p of[[1,0],[0,1],[-1,0],[0,-1]]){const y=a.add(m.fromValues(p[0],p[1]));if(d.has(y[1]*f.sizeX+y[0]))continue;const g=f.atVec(y);g.type<=L.Wall0000&&(h.push(y),d.add(y[1]*f.sizeX+y[0]),g.type===L.GroundGrass&&t===1/0&&(t=s-u),g.type===L.GroundWater&&o===1/0&&(o=s-u),n===1/0&&r.find(w=>w.pos.equals(y))&&(n=s-u))}if(u>0&&n===1/0&&(t===1/0||o===1/0))for(let p of h)i(f,d,p,u-1)}i(e.gameMap.cells,new Set,e.player.pos,s);const c=Math.min(t,n,o),l=c===1/0?ge.Indoor:o<1/0&&t<1/0?ge.OutdoorWater:o<1/0?ge.Water:n<1/0?ge.Kitchen:c===t?ge.Outdoor:ge.Indoor;l!==e.ambience&&(e.ambience=l,bt(e))}function jo(e,t,o){if(e.player.pos.distance(e.oldPlayerPos)>1){const s=e.oldPlayerPos.add(e.player.pos).scale(.5);e.gameMap.cells.atVec(s)}if(du(e),o.hidesPlayer&&!t.hidesPlayer){e.sounds.hide.play(.2);return}const n=.5+Math.random()/2,r=t.type!==o.type;if(r){if(t.type===L.GroundWater){e.sounds.waterExit.play(.5*n);return}else if(o.type===L.GroundWater){e.sounds.waterEnter.play(.5*n);return}}if(o.type===L.DoorEW||o.type===L.DoorNS){const s=e.gameMap.items.find(i=>i.pos.equals(e.player.pos));s&&(s.type===M.DoorEW||s.type===M.DoorNS?e.sounds.playerDoorOpen.play(n):(s.type===M.LockedDoorEW||s.type===M.LockedDoorNS)&&e.sounds.playerDoorOpenLocked.play(n))}if(t.type===L.DoorEW||t.type===L.DoorNS){const s=e.gameMap.items.find(i=>i.pos.equals(e.oldPlayerPos));s&&(s.type===M.DoorEW||s.type===M.DoorNS?e.sounds.playerDoorClose.play(n):(s.type===M.LockedDoorEW||s.type===M.LockedDoorNS)&&e.sounds.playerDoorCloseLocked.play(n))}switch(o.type){case L.GroundWoodCreaky:e.sounds.footstepCreaky.play(.15*n);break;case L.GroundWood:(r||Math.random()>.9)&&e.sounds.footstepWood.play(.15*n);break;case L.GroundNormal:(r||Math.random()>.5)&&e.sounds.footstepGravel.play(.03*n);break;case L.GroundGrass:(r||Math.random()>.75)&&e.sounds.footstepGrass.play(.05*n);break;case L.GroundWater:(r||Math.random()>.6)&&e.sounds.footstepWater.play(.02*n);break;case L.GroundMarble:(r||Math.random()>.8)&&e.sounds.footstepTile.play(.05*n);break;case L.GroundVault:(r||Math.random()>.8)&&e.sounds.footstepTile.play(.05*n);break;default:(r||Math.random()>.8)&&e.sounds.footstepTile.play(.02*n);break}}function Ge(e,t,o){const n=m.create(),r=m.fromValues(t/4,o/4);e.player.animation=new ue([{pt0:n,pt1:r,duration:.05,fn:O.linear},{pt0:r,pt1:n,duration:.05,fn:O.linear}],[j.playerTiles.normal])}function yt(e,t,o){e.sounds.footstepTile.play(.1),Ge(e,t,o)}function to(e,t,o,n,r=0){let s=null;t.pickTarget=null,o.hasPurse&&(o.hasPurse=!1,t.loot+=1,e.lootStolen+=1,s={pos:m.clone(o.pos),type:M.Coin,topLayer:je[M.Coin]}),o.hasVaultKey&&(o.hasVaultKey=!1,t.hasVaultKey=!0,s={pos:m.clone(o.pos),type:M.Key,topLayer:je[M.Key]});const i=ao(e.gameMapRoughPlans[e.level].levelType,j);if(s){const c=m.create(),l=n.subtract(s.pos),f=l.scale(.3333).add(m.fromValues(0,.5)),d=r>0?new ue([{pt0:c,pt1:c,duration:.1,fn:O.easeOutQuad},{pt0:c,pt1:f,duration:.1,fn:O.easeOutQuad},{pt0:f,pt1:l,duration:.1,fn:O.easeInQuad}],[i[s.type],i[s.type],i[s.type]]):new ue([{pt0:c,pt1:f,duration:.1,fn:O.easeOutQuad},{pt0:f,pt1:l,duration:.1,fn:O.easeInQuad}],[i[s.type],i[s.type]]);d.removeOnFinish=!0,s.animation=d,e.particles.push(s),s.type===M.Key?e.sounds.grabKey.play(1):e.sounds.coin.play(1)}}function pu(e,t){const o=m.clone(t.pos),n=m.clone(e.player.pos),r=m.create();m.subtract(r,o,n),m.add(r,r,o);let s=!1;gu(e,r)&&(m.copy(r,n),s=!0),m.copy(t.pos,r),e.gameMap.cells.atVec(t.pos).type===L.GroundWater&&(t.modeTimeout=0);const i=m.clone(o).subtract(t.pos),c=m.create();let l;if(s)l=[{pt0:i,pt1:c,duration:.2,fn:O.easeOutQuad}];else{const f=m.fromValues(.5*(o[0]-t.pos[0]),.5*(o[1]-t.pos[1]));l=[{pt0:i,pt1:f,duration:.2,fn:O.easeInQuad},{pt0:f,pt1:c,duration:.1,fn:O.easeOutQuad}]}t.animation=new ue(l,[])}function mu(e,t){const o=m.clone(t.pos);m.copy(t.pos,e.player.pos);const n=m.clone(o).subtract(e.player.pos),r=m.create(),s=[{pt0:n,pt1:r,duration:.2,fn:O.easeOutQuad}];t.animation=new ue(s,[])}function gu(e,t){if(t[0]<0||t[1]<0||t[0]>=e.gameMap.cells.sizeX||t[1]>=e.gameMap.cells.sizeY||e.gameMap.cells.atVec(t).moveCost===1/0||e.gameMap.guards.find(o=>o.pos.equals(t)))return!0;for(const o of e.gameMap.items.filter(n=>n.pos.equals(t)))switch(o.type){case M.PortcullisEW:case M.PortcullisNS:return!0;case M.LockedDoorEW:case M.LockedDoorNS:if(!e.player.hasVaultKey)return!0;break}return!1}function St(e,t,o){e.screenShakeEnabled&&m.scaleAndAdd(e.camera.joltVelocity,e.camera.joltVelocity,m.fromValues(t,o),-8)}function Gt(e,t,o,n){if(n===1){e.player.preNoisy&&t===e.player.noiseOffset[0]&&o===e.player.noiseOffset[1]?(xe(e),e.player.pickTarget=null,Ge(e,t*1.25,o*1.25),St(e,t,o),Ee(e.gameMap,e.player,e.popups,4,t,o,e.sounds),Se(e),e.gameMapRoughPlans[e.level].level===0&&e.popups.setNotification(`Noise
attracts
people`,e.player.pos)):(e.player.preNoisy=!1,yt(e,t,o));return}const r=e.player.pos[0]+t,s=e.player.pos[1]+o,i=e.gameMap.items.find(d=>d.pos[0]===r&&d.pos[1]===s&&(d.type===M.Bookshelf||d.type===M.Note));if(i===void 0){e.player.preNoisy=!0,e.player.noiseOffset[0]=t,e.player.noiseOffset[1]=o,e.player.pickTarget=null,e.gameMapRoughPlans[e.level].level===0&&!e.experiencedPlayer&&!Ye(e.gameMap.cells.at(r,s).type)&&e.popups.setNotification(`Make Noise:
Shift+`+Ce(t,o),e.player.pos),yt(e,t,o);return}xe(e);const c=e.player.pickTarget!==i;if(e.player.pickTarget=c&&e.gameMap.treasures.some(d=>d.switches.some(a=>a.equals(i.pos)))?i:null,e.gameMap.cells.at(r,s).lit||(e.player.lightActive=!0),Ge(e,t,o),Se(e),e.player.preNoisy=!0,e.player.noiseOffset[0]=t,e.player.noiseOffset[1]=o,c){let d=e.gameMap.bookTitle.get(i);d===void 0&&(d="Untitled"),i.type===M.Bookshelf&&(d='"'+d+'"'),e.popups.setNotification(d,e.player.pos);return}let l;(d=>{d[d.None=0]="None",d[d.Completed=1]="Completed",d[d.Reset=2]="Reset",d[d.Advance=3]="Advance",d[d.Complete=4]="Complete"})(l||(l={}));let f=0;for(const d of e.gameMap.treasures){const a=d.switches.findIndex(u=>u.equals(i.pos));if(!(a<0))if(d.numSwitchesUsed>=d.switches.length)f=Math.max(f,1);else if(a===d.numSwitchesUsed)if(++d.numSwitchesUsed,d.numSwitchesUsed>=d.switches.length){const u=e.gameMap.items.filter(h=>h.type===M.TreasureLock&&h.pos.equals(d.posTreasure));e.gameMap.items=e.gameMap.items.filter(h=>!(h.type===M.TreasureLock&&h.pos.equals(d.posTreasure))),e.gameMap.cells.atVec(d.posTreasure).blocksPlayerMove=!1;for(let h of u){const p=new Ze(j.treasureGateAnimation,.3,0,1);p.removeOnFinish=!0,h.animation=p,e.particles.push(h)}f=Math.max(f,4)}else f=Math.max(f,3);else a===0?(d.numSwitchesUsed=1,f=Math.max(f,3)):(d.numSwitchesUsed=0,f=Math.max(f,2))}switch(f){case 0:break;case 1:case 2:e.sounds.switchReset.play(.5),e.popups.setNotification("(clunk)",e.player.pos);break;case 3:e.sounds.switchProgress.play(.5),e.popups.setNotification("(click)",e.player.pos);break;case 4:e.sounds.switchSuccess.play(.5),e.popups.setNotification("(rumble)",e.player.pos),St(e,t,o);break}}function yu(e){const t=e.player;if(t.health<=0){qo(e);return}t.idle=!1,e.idleTimer=5,e.camera.panning=!1,e.touchController.clearMotion(),xe(e),e.gameMap.identifyAdjacentCells(t.pos),t.pickTarget=null,t.preNoisy=!1,++e.numWaitMoves,Se(e),Ke(e,e.player.pos)}function ve(e,t,o,n){const r=e.player;if(r.health<=0){qo(e);return}n!==1&&(r.preNoisy=!1),r.idle=!1,e.idleTimer=5,e.camera.panning=!1,e.touchController.clearMotion();const s=m.clone(r.pos),i=m.fromValues(r.pos[0]+t,r.pos[1]+o);if(i[0]<0||i[0]>=e.gameMap.cells.sizeX||i[1]<0||i[1]>=e.gameMap.cells.sizeY){if(!e.finishedLevel)e.gameMap.fractionRevealed()<1?e.popups.setNotification(`Map and loot
before leaving`,e.player.pos):e.popups.setNotification(`Collect all loot
before leaving`,e.player.pos),yt(e,t,o);else{xe(e),Lr(e);const S=m.create(),T=m.clone(i).subtract(s);let I=S.add(T).scale(.5).add(m.fromValues(0,.0625));const D=[{pt0:S,pt1:I,duration:.1,fn:O.easeInQuad},{pt0:I,pt1:T,duration:.1,fn:O.easeOutQuad},{pt0:T,pt1:T,duration:o>0?.5:.1,fn:O.easeOutQuad}],R=t<0?j.playerTiles.left:t>0?j.playerTiles.right:o>0?j.playerTiles.up:j.playerTiles.down;r.animation=new ue(D,[R,R,R,R])}return}const c=e.gameMap.cells.atVec(i);if(c.blocksPlayerMove){Wn(e,i)?(xe(e),it(e,i,r.pos),r.pickTarget=null,Ge(e,t,o),Se(e)):(n===0&&e.gameMap.items.some(S=>S.type===M.TreasureLock&&S.pos.equals(i))&&e.popups.setNotification("Locked!",e.player.pos),Gt(e,t,o,n));return}if(c.type==L.OneWayWindowE&&i[0]<=s[0]||c.type==L.OneWayWindowW&&i[0]>=s[0]||c.type==L.OneWayWindowN&&i[1]<=s[1]||c.type==L.OneWayWindowS&&i[1]>=s[1]){e.popups.setNotification(`Window is
impassable
from here`,e.player.pos),e.gameMapRoughPlans[e.level].level===0&&setTimeout(()=>e.sounds.tooHigh.play(.3),250),Gt(e,t,o,n);return}if($o(c.type)){qt(e,t,o),e.gameMapRoughPlans[e.level].level===0&&setTimeout(()=>e.sounds.jump.play(.3),250),yt(e,t,o);return}for(const S of e.gameMap.items.filter(T=>T.pos.equals(i)))switch(S.type){case M.DrawersShort:case M.VaultTreasureBox:case M.EmptyVaultTreasureBox:case M.LootedVaultTreasureBox:case M.TreasurePlinth:Wn(e,i)?(xe(e),it(e,i,r.pos),r.pickTarget=null,Ge(e,t,o),Se(e)):Yo(e,m.fromValues(s[0]+2*t,s[1]+2*o))?qt(e,t,o):Gt(e,t,o,n);return;case M.TorchUnlit:xe(e),e.sounds.ignite.play(.08),S.type=M.TorchLit,r.pickTarget=null,r.itemUsed=S,Ge(e,t,o),Se(e);return;case M.TorchLit:xe(e),e.sounds.douse.play(.05),S.type=M.TorchUnlit,r.pickTarget=null,r.itemUsed=S,Ge(e,t,o),Se(e);return;case M.PortcullisEW:case M.PortcullisNS:n!==1&&qt(e,t,o),e.sounds.gate.play(.3),e.gameMapRoughPlans[e.level].level===0&&setTimeout(()=>e.sounds.jump.play(.3),1e3),Ge(e,t,o);return;case M.LockedDoorEW:case M.LockedDoorNS:if(!r.hasVaultKey){n===0&&e.popups.setNotification("Locked!",e.player.pos),Gt(e,t,o,n);return}break}const l=e.gameMap.guards.find(S=>S.pos.equals(i));if(l===void 0)xe(e),r.pickTarget=null;else if(l.mode===fe.Unconscious)xe(e),r.pickTarget=null,pu(e,l);else if(l.mode===fe.ChaseVisibleTarget){yt(e,t,o);return}else{xe(e);let S=!1;if((l.hasPurse||l.hasVaultKey)&&(r.pickTarget===l?S=!0:r.pickTarget=l),!l.allowsMoveOntoFrom(r.pos)){S&&to(e,r,l,s),Se(e),Ke(e,s);return}S&&to(e,r,l,i)}const f=r.hidden(e.gameMap)||e.gameMap.cells.atVec(r.pos).type===L.GroundWater;m.copy(r.pos,i),++e.numStepMoves,e.gameMap.identifyAdjacentCells(r.pos);const d=m.clone(s).subtract(i),a=m.create(),u=d.add(a).scale(.5).add(m.fromValues(0,.0625)),h=r.hidden(e.gameMap)||c.type===L.GroundWater;let p;if(l!==void 0&&l.mode===fe.Unconscious){const S=m.fromValues(.5*(s[0]-i[0]),.5*(s[1]-i[1]));p=[{pt0:d,pt1:S,duration:.2,fn:O.easeInQuad},{pt0:S,pt1:a,duration:.1,fn:O.easeOutQuad}]}else{const S=n===2?.05:.1;p=[{pt0:d,pt1:u,duration:S,fn:O.easeInQuad},{pt0:u,pt1:a,duration:S,fn:O.easeOutQuad},{pt0:a,pt1:a,duration:o>0&&!h?.5:.1,fn:O.easeOutQuad}],o>0&&!h&&p.push({pt0:a,pt1:a,duration:.1,fn:O.easeOutQuad})}const y=t<0?j.playerTiles.left:t>0?j.playerTiles.right:o>0?j.playerTiles.up:j.playerTiles.down,g=f?j.playerTiles.hidden:y,x=h?j.playerTiles.hidden:y,w=h?j.playerTiles.hidden:j.playerTiles.left;r.animation=new ue(p,[g,x,x,w]),it(e,r.pos,i),c.type===L.GroundWoodCreaky&&Ee(e.gameMap,r,e.popups,0,0,-1,e.sounds),Se(e),Ke(e,s),jo(e,e.gameMap.cells.atVec(s),c)}function Rr(e,t){const o=t[0]-e[0],n=t[1]-e[1];return Math.abs(o)+Math.abs(n)===1}function Ke(e,t){if(e.popups.isNotificationVisible())return;const o=e.gameMapRoughPlans[e.level].level;if(o===3){wu(e);return}if(e.experiencedPlayer)return;if(o===2&&!e.hasEnteredMansion&&e.player.pos.equals(e.gameMap.playerStartPos)){const i=m.create();m.copy(i,e.player.pos),i[1]+=1,e.popups.setNotificationHold("Zoom view: [ or ]",i);return}if(o===1&&!e.hasEnteredMansion){let i=1/0,c;for(const l of e.gameMap.guards){const f=m.squaredDistance(l.pos,e.player.pos);f<i&&(i=f,c=l)}c!==void 0&&i<16&&e.popups.setNotificationHold(`Wait: Z
or Period/Space`,c.pos);return}if(o!==0)return;const n=e.gameMap.items.find(i=>i.type===M.Coin&&Rr(i.pos,e.player.pos));if(n!==void 0){e.popups.setNotificationHold("Loot: "+Ce(n.pos[0]-e.player.pos[0],n.pos[1]-e.player.pos[1]),n.pos);return}const r=e.gameMap.allSeen(),s=e.lootStolen>=e.lootAvailable;if(r&&s){if(e.player.pos[0]===0&&t[0]!==0){e.popups.setNotificationHold("Exit: "+Ce(-1,0),e.player.pos);return}if(e.player.pos[0]===e.gameMap.cells.sizeX-1&&t[0]!==e.gameMap.cells.sizeX-1){e.popups.setNotificationHold("Exit: "+Ce(1,0),e.player.pos);return}if(e.player.pos[1]===0&&t[1]!==0){e.popups.setNotificationHold("Exit: "+Ce(0,-1),e.player.pos);return}if(e.player.pos[1]===e.gameMap.cells.sizeY-1&&t[1]!==e.gameMap.cells.sizeY-1){e.popups.setNotificationHold("Exit: "+Ce(0,1),e.player.pos);return}for(const[i,c,l]of[[1,0,L.OneWayWindowE],[-1,0,L.OneWayWindowW],[0,1,L.OneWayWindowN],[0,-1,L.OneWayWindowS]])if(e.gameMap.cells.at(e.player.pos[0]+i,e.player.pos[1]+c).type===l){qt(e,i,c);return}}if(e.gameMap.cells.atVec(e.player.pos).type==L.GroundWater){if(e.gameMap.cells.atVec(t).type!==L.GroundWater){e.popups.setNotification("Hide underwater",e.player.pos);return}if(e.player.turnsRemainingUnderwater===1){e.popups.setNotification(`Out of breath;
surfacing`,e.player.pos);return}}if(!e.player.pos.equals(t)){const i=e.gameMap.items.filter(c=>c.pos.equals(e.player.pos));if(i.some(c=>c.type===M.Bush)){e.popups.setNotification("Hide in bushes",e.player.pos);return}if(i.some(c=>c.type===M.Table)){e.popups.setNotification("Hide under tables",e.player.pos);return}if(i.some(c=>c.type===M.BedL||c.type===M.BedR)){e.popups.setNotification("Hide under beds",e.player.pos);return}}if(e.numLeapMoves===0&&!e.hasEnteredMansion){const i=e.gameMap.items.find(l=>l.type!==M.PortcullisEW&&l.type!==M.PortcullisNS?!1:m.squaredDistance(e.player.pos,l.pos)<2);if(i!==void 0){const l=i.pos[0]-e.player.pos[0],f=i.pos[1]-e.player.pos[1];_u(e,l,f);return}let c;for(const l of e.gameMap.items)l.type!==M.PortcullisEW&&l.type!==M.PortcullisNS||(c===void 0||c.pos[1]>l.pos[1])&&(c=l);if(c!==void 0){e.popups.setNotificationHold("Move: \x1B",c.pos);return}}if(!(r&&s)&&e.numLeapMoves<=1){const i=m.fromValues(Math.floor((e.player.pos[0]+t[0])/2),Math.floor((e.player.pos[1]+t[1])/2));if(e.gameMap.items.some(c=>c.pos.equals(i)&&c.type===M.PortcullisEW)){e.popups.setNotificationHold(`Leap over open
ground or low
furniture too`,e.player.pos);return}}}function qo(e){e.popups.setNotification(e.dailyRun?ru:nu,e.player.pos)}function xu(e){return e.gameMap.guards.some(t=>!Me(t.mode)&&t.mode!==fe.Unconscious)}function vu(e){const t=e.gameMap.items.reduce((n,r)=>n+(r.type===M.Coin?1:0),0),o=e.gameMap.guards.reduce((n,r)=>n+(r.hasPurse?1:0),0);return t===0&&o>0}function Mu(e,t){const o=t.pos[0]-e.player.pos[0],n=t.pos[1]-e.player.pos[1];if(!(Math.abs(o)===2&&n===0||o===0&&Math.abs(n)===2)||e.gameMap.cells.atVec(e.player.pos).type===L.GroundWater)return!1;const r=m.fromValues(e.player.pos[0]+o/2,e.player.pos[1]+n/2),s=e.gameMap.cells.atVec(r);return!(s.blocksPlayerMove||(s.type===L.DoorNS||s.type===L.DoorEW)&&e.gameMap.items.some(i=>i.pos.equals(r)&&Eo(i.type))||s.type==L.OneWayWindowE&&o<=0||s.type==L.OneWayWindowW&&o>=0||s.type==L.OneWayWindowN&&n<=0||s.type==L.OneWayWindowS&&n>=0||!Yo(e,t.pos))}function wu(e){if(e.lootStolen>=e.lootAvailable)return;const t=e.gameMap.allSeen(),o=vu(e);if(e.experiencedPlayer&&(!t||!o)||xu(e))return;const n=e.gameMap.guards.filter(s=>s.hasPurse);if(n.length===0)return;n.sort((s,i)=>m.squaredDistance(e.player.pos,s.pos)-m.squaredDistance(e.player.pos,i.pos));const r=n[0];if(Me(r.mode)&&Rr(e.player.pos,r.pos)){const s=r.pos[0]-e.player.pos[0],i=r.pos[1]-e.player.pos[1],c=m.fromValues(r.pos[0],Math.max(r.pos[1],e.player.pos[1])),l=e.player.pickTarget===r?"Loot: ":"Loot (1/2): ";e.popups.setNotificationHold(l+Ce(s,i)+`
Knockout: Shift+`+Ce(s,i),c);return}if(Mu(e,r)){const s=r.pos[0]-e.player.pos[0],i=r.pos[1]-e.player.pos[1],c=m.fromValues(r.pos[0],Math.max(r.pos[1],e.player.pos[1]));e.popups.setNotificationHold("Leap: Shift+"+Ce(s,i),c);return}t&&o&&e.popups.setNotificationHold("Loot",r.pos)}function Ut(e,t,o){const n=e.player;if(n.health<=0){qo(e);return}n.idle=!1,e.idleTimer=5,e.camera.panning=!1,e.touchController.clearMotion();const r=m.clone(n.pos),s=m.fromValues(n.pos[0]+t,n.pos[1]+o),i=m.fromValues(n.pos[0]+2*t,n.pos[1]+2*o),c=e.gameMap.cells.atVec(r),l=e.gameMap.cells.atVec(s),f=e.gameMap.cells.atVec(i),d=e.gameMap.guards.find(D=>D.pos.equals(s)&&D.mode!==fe.Unconscious);if(d){if(l.type===L.PortcullisEW||l.type===L.PortcullisNS||!n.hasVaultKey&&Vn(e.gameMap,s)){ve(e,t,o,1);return}else d.mode===fe.ChaseVisibleTarget?(mu(e,d),ve(e,t,o,1)):(xe(e),d.mode=fe.Unconscious,d.modeTimeout=Math.max(1,40-2*e.level)+e.rng.randomInRange(20),(d.hasPurse||d.hasVaultKey)&&to(e,n,d,r),n.pickTarget=null,++e.levelStats.numKnockouts,e.sounds.hitGuard.play(.25),Se(e),Ge(e,t,o),St(e,t,o));return}if(c.type===L.GroundWater){ve(e,t,o,1);return}if(i[0]<0||i[1]<0||i[0]>=e.gameMap.cells.sizeX||i[1]>=e.gameMap.cells.sizeY){ve(e,t,o,1);return}if(l.blocksPlayerMove){ve(e,t,o,1);return}if((l.type===L.DoorNS||l.type===L.DoorEW)&&e.gameMap.items.find(D=>D.pos.equals(s)&&Eo(D.type))){ve(e,t,o,1);return}if(l.type==L.OneWayWindowE&&i[0]<=r[0]||l.type==L.OneWayWindowW&&i[0]>=r[0]||l.type==L.OneWayWindowN&&i[1]<=r[1]||l.type==L.OneWayWindowS&&i[1]>=r[1]){ve(e,t,o,1);return}const a=hu(e,s),u=e.gameMap.guards.find(D=>D.pos.equals(i));if(!Yo(e,i)){a?u!==void 0&&u.overheadIcon()===Xe.Alerted&&f.type!==L.PortcullisEW&&f.type!==L.PortcullisNS&&(n.hasVaultKey||!Vn(e.gameMap,i))?Su(e,n,u,t,o,r,s,i):ve(e,t,o,2):ve(e,t,o,1);return}u===void 0||!(u.hasPurse||u.hasVaultKey)?n.pickTarget=null:n.pickTarget=u,xe(e),it(e,s,i);const h=e.gameMap.items.find(D=>D.pos.equals(s)&&D.type===M.TorchLit);if(h!==void 0?(e.sounds.douse.play(.05),h.type=M.TorchUnlit,n.itemUsed=h):a&&l.type!==L.GroundWoodCreaky&&++e.levelStats.steppableLeaps,i[0]<0||i[1]<0||i[0]>=e.gameMap.cells.sizeX||i[1]>=e.gameMap.cells.sizeY){Lr(e);const D=m.create(),R=m.clone(i).subtract(r);let A=D.add(R).scale(.5).add(m.fromValues(0,.25));const W=t<0?j.playerTiles.left:t>0?j.playerTiles.right:o>0?j.playerTiles.up:j.playerTiles.down,C=[{pt0:D,pt1:A,duration:.1,fn:O.easeInQuad},{pt0:A,pt1:R,duration:.1,fn:O.easeOutQuad},{pt0:R,pt1:R,duration:o>0?.5:.1,fn:O.easeOutQuad}];n.animation=new ue(C,[W,W,W]);return}m.copy(n.pos,i),++e.numLeapMoves,f.identified=!0;const p=m.clone(r).subtract(i),y=m.create();let g=p.add(y).scale(.5).add(m.fromValues(0,.25));const x=t<0?j.playerTiles.left:t>0?j.playerTiles.right:o>0?j.playerTiles.up:j.playerTiles.down,w=n.hidden(e.gameMap),S=[{pt0:p,pt1:g,duration:.1,fn:O.easeInQuad},{pt0:g,pt1:y,duration:.1,fn:O.easeOutQuad},{pt0:y,pt1:y,duration:o>0&&!w?.5:.1,fn:O.easeOutQuad}];o>0&&!w&&S.push({pt0:y,pt1:y,duration:.1,fn:O.easeOutQuad});const T=w?j.playerTiles.hidden:x;n.animation=new ue(S,[x,T,T,j.playerTiles.left]);const I=l.type===L.PortcullisNS||l.type===L.PortcullisEW;I?e.hasEnteredMansion=!0:e.gameMapRoughPlans[e.level].level===0&&!e.hasEnteredMansion&&(e.experiencedPlayer=!0),it(e,i,i),f.type===L.GroundWoodCreaky?Ee(e.gameMap,n,e.popups,0,0,-1,e.sounds):f.type===L.GroundWater&&Ee(e.gameMap,n,e.popups,1,0,0,e.sounds),Se(e),Ke(e,r),jo(e,e.gameMap.cells.atVec(r),f),I&&e.sounds.gate.play(.3)}function Su(e,t,o,n,r,s,i,c){xe(e),it(e,i,c),m.copy(t.pos,i),++e.numLeapMoves,o.mode=fe.Unconscious,o.modeTimeout=Math.max(1,40-2*e.level)+e.rng.randomInRange(20),(o.hasPurse||o.hasVaultKey)&&to(e,t,o,i,.15),t.pickTarget=null,++e.levelStats.numKnockouts,e.sounds.hitGuard.play(.25);const l=e.gameMap.cells.atVec(i);l.identified=!0;const f=m.clone(s).subtract(i),d=m.clone(c).subtract(i).scale(.5).add(m.fromValues(0,.25)),a=m.create(),u=n<0?j.playerTiles.left:n>0?j.playerTiles.right:r>0?j.playerTiles.up:j.playerTiles.down,h=t.hidden(e.gameMap),p=[{pt0:f,pt1:d,duration:.15,fn:O.easeInQuad},{pt0:d,pt1:a,duration:.1,fn:O.easeOutQuad},{pt0:a,pt1:a,duration:r>0&&!h?.5:.1,fn:O.easeOutQuad}];r>0&&!h&&p.push({pt0:a,pt1:a,duration:.1,fn:O.easeOutQuad});const y=h?j.playerTiles.hidden:u;t.animation=new ue(p,[u,y,y,j.playerTiles.left]),l.type===L.GroundWoodCreaky?Ee(e.gameMap,t,e.popups,0,0,-1,e.sounds):l.type===L.GroundWater&&Ee(e.gameMap,t,e.popups,1,0,0,e.sounds),St(e,n,r),Ee(e.gameMap,t,e.popups,2,n,r,e.sounds),Se(e),jo(e,e.gameMap.cells.atVec(s),l)}function Vn(e,t){return e.items.some(o=>o.pos.equals(t)&&(o.type===M.LockedDoorEW||o.type===M.LockedDoorNS))}function Tu(e){switch(e){case M.DrawersShort:case M.VaultTreasureBox:case M.EmptyVaultTreasureBox:case M.LootedVaultTreasureBox:case M.TorchUnlit:case M.TorchLit:case M.TreasureLock:case M.TreasurePlinth:case M.TreasureA:case M.TreasureB:case M.TreasureC:case M.TreasureD:case M.TreasureE:return!1;default:return!0}}function $o(e){switch(e){case L.OneWayWindowE:case L.OneWayWindowW:case L.OneWayWindowN:case L.OneWayWindowS:return!0;default:return!1}}function Ee(e,t,o,n,r,s,i,c=23,l=!1){switch(t.noisy=!0,t.noiseOffset[0]=r,t.noiseOffset[1]=s,n){case 0:i.footstepCreaky.play(.6),o.setNotification("Creak!",t.pos);break;case 1:i.splash.play(.5),o.setNotification("Splash!",t.pos);break;case 2:o.setNotification("Thud!",t.pos);break;case 3:i.treasureAlarm.play(1);const d=m.fromValues(t.pos[0]+r,t.pos[1]+s);o.setNotificationHold("ALARM! ALARM! ALARM!",d);break;case 4:i.thump.play(.5),o.setNotification("Thud!",t.pos);break}let f=!1;for(const d of e.guardsInEarshot(t.pos,c))d.heardThief=!0,f||(f=!0,d.heardThiefClosest=!0,d.heardAlarm=n===3),l&&(d.angry=!0,d.mode===fe.Unconscious&&(d.modeTimeout=0))}function xe(e){e.player.noisy=!1,e.player.damagedLastTurn=!1,e.player.itemUsed=null,e.player.lightActive=!1,e.popups.updateNotification()}function Se(e){const t=e.player.health;if(e.player.preNoisy=!1,++e.turns,++e.totalTurns,e.gameMap.cells.atVec(e.player.pos).type==L.GroundWater?e.player.turnsRemainingUnderwater>0&&(--e.player.turnsRemainingUnderwater,e.player.turnsRemainingUnderwater<=0&&e.sounds.waterExit.play(.25)):e.player.turnsRemainingUnderwater=oo,e.gameMap.computeLighting(e.player),Or(e),e.gameMap.recomputeVisibility(e.player.pos),Lt(e),be(e),t>e.player.health&&(e.sounds.hitPlayer.play(.5),e.player.health<=0)){setTimeout(()=>e.sounds.gameOverJingle.play(.5),1e3),lu(e),e.persistedStats.bestScore=Math.max(e.persistedStats.bestScore,e.gameStats.totalScore);const o={score:e.gameStats.totalScore,date:Tt(),turns:e.totalTurns,level:e.level+1};e.persistedStats.scores.push(o),e.dailyRun&&(e.persistedStats.currentDailyBestScore=Math.max(e.persistedStats.currentDailyBestScore,e.gameStats.totalScore),e.persistedStats.lastPlayedDailyGame=structuredClone(e.gameStats)),Zo(e.persistedStats)}It(e,"turnEnd")}function be(e){const t=e.gameMap.allSeen(),o=e.lootStolen>=e.lootAvailable;t&&o&&(e.finishedLevel||(e.sounds.levelRequirementJingle.play(.5),e.popups.setNotification("Escape!",e.player,3,5)),e.finishedLevel=!0);const n=Ct(e);if(e.level>0&&(e.turns===Math.floor(.75*n)||e.turns===n-10&&n>100)&&(e.popups.setNotification("Tick tock!",e.player,3,5),e.sounds.clockTick.play(1)),e.turns===n+1){const r=[];let s=!1;e.gameMap.items=e.gameMap.items.filter(i=>i.type===M.VaultTreasureBox?(r.push(i),s=!0,!1):!0);for(let i of r){e.gameMap.items.push({type:M.EmptyVaultTreasureBox,pos:i.pos,topLayer:!1});const c=new Ze(oe().vaultGoldAnimationTiles,.2,0,1);c.removeOnFinish=!0,e.particles.push({pos:m.clone(i.pos),animation:c})}s?(e.popups.setNotification(`Late!
Vaults were cleared.`,e.player,3,5),e.sounds.coinRattle.play(1),e.sounds.clockChime.play(.5)):e.level>0&&(e.popups.setNotification("Late!",e.player,3,5),e.sounds.clockChime.play(1))}}function qt(e,t,o){e.popups.setNotification("Leap: Shift+"+Ce(t,o),e.player.pos)}function _u(e,t,o){e.popups.setNotificationHold("Leap: Shift+"+Ce(t,o),e.player.pos)}function Ce(e,t){return e>0?"":e<0?"\x1B":t>0?"":t<0?"":"\x07"}function Ar(e){e.healthBarState.enlargeTimeRemaining=1}function Ir(e,t){t<0||t>=e.healthBarState.heartFlashRemaining.length||(e.healthBarState.heartFlashRemaining[t]=1,e.healthBarState.damageDisplayTimer=Tr,e.healthBarState.healing=t<e.player.health)}function Lu(e,t){e.healthBarState.damageDisplayTimer=Math.max(0,e.healthBarState.damageDisplayTimer-t),e.healthBarState.enlargeTimeRemaining=Math.max(0,e.healthBarState.enlargeTimeRemaining-t*1.5);let o=1;const n=.85;e.healthBarState.enlargeTimeRemaining>n?o=1-((e.healthBarState.enlargeTimeRemaining-n)/(1-n))**2:(o=e.healthBarState.enlargeTimeRemaining/n,o=o*o*(3-2*o)),e.healthBarState.size=1+o/2,o=t/1;for(let s=0;s<e.healthBarState.heartFlashRemaining.length;++s)e.healthBarState.heartFlashRemaining[s]=Math.max(0,e.healthBarState.heartFlashRemaining[s]-o)}function Ko(e){e.healthBarState.damageDisplayTimer=0,e.healthBarState.healing=!1,e.healthBarState.enlargeTimeRemaining=0,e.healthBarState.size=1,e.healthBarState.heartFlashRemaining.length=e.player.healthMax,e.healthBarState.heartFlashRemaining.fill(0)}function _o(e,t){return new Promise((o,n)=>{t.onload=()=>o(t),t.onerror=n,t.src=e})}function Qo(e,t,o,n){if(o.size==0)return e;if(!n)return 0;let r=0;for(let s of[...o])r+=t[s];return e**(1+r/o.size)}function Ru(e,t,o){for(let n=0;n<e.sizeX;n++)for(let r=0;r<e.sizeY;r++){const s=e.at(n,r);s.type<L.Wall0000||s.type>L.DoorEW?e.at(n,r).litAnim=Qo(s.lit,t,s.litSrc,o||s.seen):e.at(n,r).litAnim=0}}function Cr(e,t,o){const n=(o.at(e,t).lit?1:.1)/4,r=o.at(e-1,t-1).litAnim,s=o.at(e,t-1).litAnim,i=o.at(e+1,t-1).litAnim,c=o.at(e-1,t).litAnim,l=o.at(e,t).litAnim,f=o.at(e+1,t).litAnim,d=o.at(e-1,t+1).litAnim,a=o.at(e,t+1).litAnim,u=o.at(e+1,t+1).litAnim;return[n*(r+s+c+l),n*(i+s+f+l),n*(d+a+c+l),n*(u+a+f+l)]}function Au(e,t){for(const o in t.coreTouchTargets){if(!(o in t.controlStates))continue;const n=t.coreTouchTargets[o];if(!n.mouseable&&t.mouseActive||n.tileInfo===null||n.rect[2]===0||n.rect[3]===0)continue;const r=t.controlStates[o]?1:0;e.addGlyphLit(n.rect[0],n.rect[1],n.rect[0]+n.rect[2],n.rect[1]+n.rect[3],n.tileInfo,r)}e.flush()}function Iu(e,t){switch(e){case E.Manor:return t.waterAnimation;case E.ManorRed:return t.waterAnimation;case E.Mansion:return t.manseWaterAnimation;case E.Fortress:return t.fortressWaterAnimation;case E.Warrens:return t.waterAnimation}}function Cu(e,t){switch(e){case E.Manor:return t.terrainTiles;case E.ManorRed:return t.redWallTerrainTiles;case E.Mansion:return t.manseTerrainTiles;case E.Fortress:return t.fortressTerrainTiles;case E.Warrens:return t.redWallTerrainTiles}}function ao(e,t){switch(e){case E.Manor:return t.itemTiles;case E.ManorRed:return t.redWallItemTiles;case E.Mansion:return t.manseItemTiles;case E.Fortress:return t.fortressItemTiles;case E.Warrens:return t.redWallItemTiles}}function bu(e,t){const o=Cu(e.gameMapRoughPlans[e.level].levelType,t.terrainTileSet);for(let n=0;n<e.gameMap.cells.sizeX;++n)for(let r=e.gameMap.cells.sizeY-1;r>=0;--r){const s=e.gameMap.cells.at(n,r);if(!s.seen&&!e.seeAll)continue;let i=s.type;i==L.GroundWoodCreaky&&!(s.lit||s.identified)&&!e.seeAll&&(i=L.GroundWood);const c=Cr(n,r,e.gameMap.cells);let l=s.animation?s.animation.currentTile():o[i];if((i===L.DoorEW||i===L.DoorNS)&&!s.blocksSight&&l.textureIndex!==void 0&&(l={textureIndex:l.textureIndex+1,color:l.color,unlitColor:l.unlitColor}),t.addGlyphLit4(n,r,n+1,r+1,l,c),i===L.GroundWater){const f=t.terrainTileSet.ledgeTiles;let d=0;for(let a of[[0,1],[0,-1],[-1,0],[1,0]])e.gameMap.cells.at(n+a[0],r+a[1]).type!==L.GroundWater&&t.addGlyphLit4(n,r,n+1,r+1,f[d],c),d++}}}function Bn(e,t,o){const n=ao(e.gameMapRoughPlans[e.level].levelType,t.entityTileSet);for(const r of e.gameMap.items.filter(s=>s.topLayer===o)){let s=r.pos[0],i=r.pos[1];const c=e.gameMap.cells.at(s,i);if(!c.seen&&!e.seeAll)continue;const l=c.type,f=Cr(s,i,e.gameMap.cells);if(l===L.PortcullisEW||l===L.PortcullisNS)if(!e.gameMap.guards.find(d=>d.pos[0]===s&&d.pos[1]===i))t.addGlyphLit4(s,i,s+1,i+1,n[r.type],f);else{let d=n[r.type];d.textureIndex!==void 0&&(d={textureIndex:d.textureIndex+1,color:d.color,unlitColor:d.unlitColor}),t.addGlyphLit4(s,i,s+1,i+1,d,f)}else if(l===L.DoorEW||l===L.DoorNS)!e.gameMap.guards.find(d=>d.pos[0]===s&&d.pos[1]===i)&&!(e.player.pos[0]===s&&e.player.pos[1]===i)&&t.addGlyphLit4(s,i,s+1,i+1,n[r.type],f);else if(r.type>=M.TreasureA)t.addGlyph(s,i+.5,s+1,i+1.5,n[r.type]),r.animation&&t.addGlyph(s,i+.5,s+1,i+1.5,r.animation.currentTile());else if(r.type===M.VaultTreasureBox)t.addGlyph(s,i,s+1,i+1,n[r.type]),r.animation&&t.addGlyph(s,i,s+1,i+1,r.animation.currentTile());else if(r.type===M.Coin)t.addGlyph(s,i,s+1,i+1,n[r.type]),r.animation&&t.addGlyph(s,i,s+1,i+1,r.animation.currentTile());else{const d=r.animation?r.animation.currentTile():n[r.type];if(r.animation instanceof ue){const a=r.animation.offset;s+=a[0],i+=a[1]}t.addGlyphLit4(s,i,s+1,i+1,d,f)}}}function Pu(e,t,o){const n={textureIndex:4,color:4294967295,unlitColor:4294967295},r={textureIndex:4,color:4282401023,unlitColor:4294967295},s={textureIndex:4,color:4294967295,unlitColor:4294967295},i=1/16;for(const c of e){const l=c.posMin[0],f=c.posMin[1],d=c.posMax[0],a=c.posMax[1];o.addGlyph(l,f,d,f+i,n),o.addGlyph(l,a-i,d,a,n),o.addGlyph(l,f+i,l+i,a-i,n),o.addGlyph(d-i,f+i,d,a-i,n)}for(const c of t){const l=.5+c.origin[0],f=.5+c.origin[1],d=l+c.dir[0]*c.length,a=f+c.dir[1]*c.length,u=Math.abs(c.dir[0])*(1-i),h=Math.abs(c.dir[1])*(1-i),p=Math.min(l,d)+u-(.5-i),y=Math.min(f,a)+h-(.5-i),g=Math.max(l,d)-u+(.5-i),x=Math.max(f,a)-h+(.5-i),w=c.door?s:r;o.addGlyph(p,y,g,y+i,w),o.addGlyph(p,x-i,g,x,w),o.addGlyph(p,y+i,p+i,x-i,w),o.addGlyph(g-i,y+i,g,x-i,w)}}function ku(e,t){const o=e.gameMap.cells.sizeX,n=e.gameMap.cells.sizeY,r={textureIndex:0,color:_,unlitColor:_};t.addGlyph(-1,0,0,n,r),t.addGlyph(o,0,o+1,n,r),t.addGlyph(-1,-1,o+1,0,r),t.addGlyph(-1,n,o+1,n+1,r)}function Du(e,t){const o=e.player,n=o.animation,r=n&&n instanceof ue?n.offset:m.create(),s=o.pos[0]+r[0],i=o.pos[1]+r[1],c=o.pos[0],l=o.pos[1],f=e.gameMap.cells.at(c,l),d=Qo(f.lit,e.lightStates,f.litSrc,e.seeAll||f.seen),a=o.hidden(e.gameMap),u=o.health<=0;let h;if(n)h=n.currentTile();else{const g=t.entityTileSet.playerTiles;h=u?g.dead:a||f.type===L.GroundWater?g.hidden:g.normal}const p=[],y=structuredClone(h);if(!u){if(o.idle){if(o.idleCursorAnimation!==null&&o.idleCursorAnimation.length===1&&o.idleCursorAnimation[0]instanceof Un){const g=o.idleCursorAnimation[0].currentTile();t.addGlyphLit(c,l,c+1,l+1,g,1)}if(o.idleCursorAnimation!==null&&o.idleCursorAnimation.length>1){for(let g of o.idleCursorAnimation)if(g instanceof mt){const x=g.currentTile(),w=g.offset;w[1]>0?t.addGlyphLit(c+w[0],l+w[1]/4-.125,c+w[0]+1,l+w[1]/4+1-.125,x,1):p.push([c+w[0],l+w[1]/4-.125,c+w[0]+1,l+w[1]/4+1-.125,x,1])}}}o.damagedLastTurn?(y.color=ko,y.unlitColor=vr):a&&(y.color=ce,y.unlitColor=st)}if(t.addGlyphLit(s,i,s+1,i+1,y,d),a&&o.idle&&t.addGlyphLit(s,i,s+1,i+1,t.entityTileSet.playerTiles.litFace,.15),o.lightActive){const g=o.torchAnimation!==null?o.torchAnimation.currentTile():t.entityTileSet.itemTiles[M.TorchCarry];t.addGlyphLit(s,i,s+1,i+1,g,d)}for(let g of p)t.addGlyphLit(...g)}function Wu(e,t){var o;for(const n of e.gameMap.guards){let r=0+Eu(n.dir);const s=e.gameMap.cells.atVec(n.pos);let i=Qo(s.lit,e.lightStates,s.litSrc,e.seeAll||s.seen);const c=e.seeAll||s.seen||n.speaking;if(!c&&m.squaredDistance(e.player.pos,n.pos)>36)continue;!c&&n.mode!==fe.Unconscious?r+=4:n.mode===fe.Patrol&&!n.speaking&&s.lit==0?i=0:n.mode===fe.Unconscious?r+=12:r+=8;const l=structuredClone(t.entityTileSet.npcTiles[r]);n.mode===fe.Unconscious&&n.hidden(e.gameMap)&&(l.color=ce,l.unlitColor=st);const f=e.gameMap.items.find(p=>[M.PortcullisEW,M.PortcullisNS].includes(p.type)),d=f!==void 0&&f.pos.equals(n.pos)?.25:0;let a=((o=n.animation)==null?void 0:o.offset)??m.create();const u=n.pos[0]+a[0]+d,h=n.pos[1]+a[1];if(n.hasTorch||n.hasPurse||n.hasVaultKey){let p=u+n.dir[0]*.375+n.dir[1]*.375,y=h-.125;const g=n.mode!==fe.Unconscious&&n.torchAnimation?n.torchAnimation.currentTile():t.entityTileSet.itemTiles[M.TorchCarry];let x=u-n.dir[0]*.25+(n.dir[1]<0?.375:0),w=h-.125;const S=n.hasVaultKey?j.itemTiles[M.KeyCarry]:t.entityTileSet.itemTiles[M.PurseCarry];n.dir[1]>0?(n.hasTorch&&t.addGlyphLit(p,y,p+1,y+1,g,i),t.addGlyphLit(u,h,u+1,h+1,l,i),(n.hasPurse||n.hasVaultKey)&&t.addGlyphLit(x,w,x+1,w+1,S,i)):n.dir[1]<0?((n.hasPurse||n.hasVaultKey)&&t.addGlyphLit(x,w,x+1,w+1,S,i),t.addGlyphLit(u,h,u+1,h+1,l,i),n.hasTorch&&t.addGlyphLit(p,y,p+1,y+1,g,i)):(t.addGlyphLit(u,h,u+1,h+1,l,i),n.hasTorch&&t.addGlyphLit(p,y,p+1,y+1,g,i),(n.hasPurse||n.hasVaultKey)&&t.addGlyphLit(x,w,x+1,w+1,S,i))}else t.addGlyphLit(u,h,u+1,h+1,l,i)}}function Vu(e,t){for(let o of e.particles)if(o.animation&&(e.seeAll||e.gameMap.cells.atVec(o.pos).seen)){const n=o.animation,r=n instanceof ue||n instanceof mt?n.offset:m.create(),s=o.pos[0]+r[0],i=o.pos[1]+r[1],c=n.currentTile();(!(o.animation instanceof ue)||o.animation.time>=0)&&t.addGlyph(s,i,s+1,i+1,c)}}function Bu(e,t){var s;const o=e.player,n=t.entityTileSet.namedTiles.speechBubbleR,r=t.entityTileSet.namedTiles.speechBubbleL;for(const i of e.gameMap.guards){const c=e.gameMap.cells.atVec(i.pos);if(!(e.seeAll||c.seen||i.speaking)&&m.squaredDistance(e.player.pos,i.pos)>36)continue;let f=((s=i.animation)==null?void 0:s.offset)??m.create();const d=i.pos[0]+f[0],a=i.pos[1]+f[1];i.speaking&&!e.popups.isSpeechBubbleVisible()&&(i.dir[0]>=0?t.addGlyph(d+1,a,d+2,a+1,n):t.addGlyph(d-1,a,d,a+1,r));const u=i.overheadIcon();if(u!==Xe.Relaxed){const h=t.entityTileSet.guardStateTiles[u];t.addGlyph(d,a+.625,d+1,a+1.625,h)}if(i===o.pickTarget){const h=j.namedTiles.pickTarget;t.addGlyph(d,a+.625,d+1,a+1.625,h)}}if(o.preNoisy||o.noisy){const i=o.animation,c=i&&i instanceof ue?i.offset:m.create();if(Math.abs(c[0])<.5&&Math.abs(c[1])<.5){const l=o.pos[0]+o.noiseOffset[0]/2,f=o.pos[1]+o.noiseOffset[1]/2;if(o.preNoisy)t.addGlyph(l,f,l+1,f+1,j.namedTiles.pickTarget);else{const d=.0625*Math.sin(o.noisyAnim*Math.PI*2);t.addGlyph(l-d,f-d,l+1+d,f+1+d,j.namedTiles.noise)}}}}function Gu(e,t){if(!e.seeGuardSight)return;const o=e.gameMap.cells.sizeX,n=e.gameMap.cells.sizeY,r=new he(o,n,!1),s=m.create(),i=m.create();for(const c of e.gameMap.guards){const f=Math.max(0,Math.floor(c.pos[0]-10)),d=Math.min(o,Math.floor(c.pos[0]+10)+1),a=Math.max(0,Math.floor(c.pos[1]-10)),u=Math.min(n,Math.floor(c.pos[1]+10)+1);for(let h=a;h<u;++h)for(let p=f;p<d;++p){if(r.get(p,h))continue;m.set(s,p,h),m.subtract(i,s,c.pos);const y=e.gameMap.cells.atVec(s);!e.seeAll&&!y.seen||y.blocksPlayerMove||c.mode!==fe.ChaseVisibleTarget&&m.dot(c.dir,i)<0||m.squaredLen(i)>=c.sightCutoff(y.lit>0)&&!(i[0]===c.dir[0]*2&&i[1]===c.dir[1]*2)||y.hidesPlayer&&(Math.abs(i[0])>1||Math.abs(i[1])>1||Me(c.mode))||Lo(e.gameMap,c.pos,s)&&r.set(p,h,!0)}}for(let c=0;c<e.gameMap.cells.sizeY;++c)for(let l=0;l<e.gameMap.cells.sizeX;++l)r.get(l,c)&&t.addGlyph(l,c,l+1,c+1,j.namedTiles.crossHatch)}function Uu(e,t){if(e.seeGuardPatrols)for(const o of e.gameMap.guards)for(const n of o.patrolPath)t.addGlyph(n[0],n[1],n[0]+1,n[1]+1,j.namedTiles.patrolRoute)}function Eu(e){return e[1]>0?1:e[1]<0?3:e[0]>0?0:e[0]<0?2:3}function lo(e,t){const o={position:m.create(),velocity:m.create(),joltOffset:m.create(),joltVelocity:m.create(),zoom:t,zoomVelocity:0,scale:Math.pow(lt,t),anchor:m.create(),snapped:!1,zoomed:!1,panning:!1};return m.copy(o.position,e),m.zero(o.velocity),o}function xt(e,t){e.soundVolume=t,_e.Howler.volume(t),window.localStorage.setItem("LLL/soundVolume",t.toString())}function $t(e){return e.volumeMute||!document.hasFocus()}function Bo(e,t){e.volumeMute=t,_e.Howler.mute($t(e)),window.localStorage.setItem("LLL/volumeMute",t?"true":"false")}function Go(e,t){e.guardMute=t,window.localStorage.setItem("LLL/guardMute",t?"true":"false");for(const o in e.subtitledSounds)e.subtitledSounds[o].mute=t}function Nu(e,t){e.screenShakeEnabled=t,window.localStorage.setItem("LLL/screenShakeEnabled",t?"true":"false")}function ee(e){const t=window.localStorage.getItem("LLL/stat/"+e);if(t!=null&&t!=="undefined")return JSON.parse(String(t))}function K(e,t){const o=JSON.stringify(t);window.localStorage.setItem("LLL/stat/"+e,o)}function br(){return{scores:ee("highScores")??[],lastPlayedDailyGame:ee("lastPlayedDailyGame")??null,currentDailyGameId:ee("currentDailyGameId")??"",currentDailyPlays:ee("currentDailyPlays")??0,currentDailyWins:ee("currentDailyWins")??0,currentDailyBestScore:ee("currentDailyBestScore")??0,currentDailyWinFirstTry:ee("currentDailyWinFirstTry")??0,bestScore:ee("bestScore")??0,totalPlays:ee("totalPlays")??0,totalWins:ee("totalWins")??0,totalGhosts:ee("totalGhosts")??0,allDailyPlays:ee("allDailyPlays")??0,allDailyWins:ee("allDailyWins")??0,allDailyWinsFirstTry:ee("allDailyWinsFirstTry")??0,achievementGhosty:ee("achievementGhosty")??0,achievementZippy:ee("achievementZippy")??0,achievementHungry:ee("achievementHungry")??0,achievementThumpy:ee("achievementThumpy")??0,achievementSofty:ee("achievementSofty")??0,achievementNoisy:ee("achievementNoisy")??0,achievementLeapy:ee("achievementLeapy")??0,achievementSteppy:ee("achievementSteppy")??0,achievementHurty:ee("achievementHurty")??0,achievementVictory:ee("achievementVictory")??0,achievementHealthy:ee("achievementHealthy")??0,achievementTreasure:ee("achievementTreasure")??0,achievementMapping:ee("achievementMapping")??0,achievementFaceless:ee("achievementFaceless")??0}}function Zo(e){K("currentDailyGameId",e.currentDailyGameId),K("currentDailyPlays",e.currentDailyPlays),K("currentDailyWins",e.currentDailyWins),K("currentDailyBestScore",e.currentDailyBestScore),K("currentDailyWinFirstTry",e.currentDailyWinFirstTry),K("lastPlayedDailyGame",e.lastPlayedDailyGame),K("allDailyPlays",e.allDailyPlays),K("allDailyWins",e.allDailyWins),K("allDailyWinsFirstTry",e.allDailyWinsFirstTry),K("scores",e.scores),K("bestScore",e.bestScore),K("totalPlays",e.totalPlays),K("totalWins",e.totalWins),K("totalGhosts",e.totalGhosts),K("achievementGhosty",e.achievementGhosty),K("achievementZippy",e.achievementZippy),K("achievementHungry",e.achievementHungry),K("achievementThumpy",e.achievementThumpy),K("achievementSofty",e.achievementSofty),K("achievementNoisy",e.achievementNoisy),K("achievementLeapy",e.achievementLeapy),K("achievementSteppy",e.achievementSteppy),K("achievementHurty",e.achievementHurty),K("achievementHealthy",e.achievementHealthy),K("achievementTreasure",e.achievementTreasure),K("achievementMapping",e.achievementMapping),K("achievementFaceless",e.achievementFaceless)}function Fu(e,t,o,n,r){const s=new Ne,i=Sr,c=Fo(eo.numGameMaps,eo.totalGameLoot,s),l=so(c[i]),f=br();let d=parseInt(window.localStorage.getItem("LLL/keyRepeatRate")??"175");isNaN(d)&&(d=175);let a=parseInt(window.localStorage.getItem("LLL/keyRepeatDelay")??"250");isNaN(a)&&(a=250);let u=parseFloat(window.localStorage.getItem("LLL/soundVolume")??"1.0");isNaN(u)&&(u=1);let h=window.localStorage.getItem("LLL/volumeMute");const p=h===null?!1:h==="true";let y=window.localStorage.getItem("LLL/guardMute");const g=y===null?!1:y==="true";let x=window.localStorage.getItem("LLL/screenShakeEnabled");const w=x===null?!0:x==="true",S=new at(l.playerStartPos,!1),T={gameStats:{totalScore:0,turns:0,numLevels:0,numCompletedLevels:0,numGhostedLevels:0,numSpottings:0,numInjuries:0,numKnockouts:0,daily:null,timeStarted:0,timeEnded:0},persistedStats:f,levelStats:{numKnockouts:0,numSpottings:0,damageTaken:0,extraFoodCollected:0,steppableLeaps:0},achievements:Ol(),lightStates:Array(l.lightCount).fill(0),particles:[],tLast:void 0,dt:0,idleTimer:5,rng:s,fpsInfo:{enabled:!1,msgFPS:"FPS: --",frames:0,cumulativeTime:0,worstFrame:0,drops:0},devMode:gt,dailyRun:null,leapToggleActive:!1,healthBarState:{damageDisplayTimer:0,healing:!1,size:1,enlargeTimeRemaining:0,heartFlashRemaining:Array(S.healthMax).fill(0)},gameMode:F.HomeScreen,textWindows:{[F.HomeScreen]:new _l,[F.OptionsScreen]:new Rl,[F.StatsScreen]:new Gl,[F.AchievementsScreen]:new Ul,[F.DailyHub]:new Bl,[F.HelpControls]:new Al,[F.HelpKey]:new Wl,[F.MansionComplete]:new El,[F.Dead]:new Nl,[F.Win]:new Fl,[F.CreditsScreen]:new Vl,[F.DevScreen]:new Ll},player:S,ambience:ge.Outdoor,ambientSoundPool:n,oldPlayerPos:m.clone(l.playerStartPos),hintMessage:"",numStepMoves:0,numLeapMoves:0,numWaitMoves:0,numZoomMoves:0,hasEnteredMansion:!1,experiencedPlayer:gt,finishedLevel:!1,hasStartedGame:gt,zoomLevel:kn,seeAll:eu,seeGuardSight:!1,seeGuardPatrols:!1,seeRoomAdjacencies:!1,camera:lo(l.playerStartPos,kn),level:i,turns:0,totalTurns:0,lootStolen:0,lootAvailable:c[i].totalLoot,treasureStolen:0,gameMapRoughPlans:c,gameMap:l,sounds:e,subtitledSounds:t,activeSoundPool:o,soundVolume:u,guardMute:g,volumeMute:p,screenShakeEnabled:w,keyRepeatActive:void 0,keyRepeatRate:d,keyRepeatDelay:a,touchController:r,gamepadManager:new Ml,keyboardController:new xl,popups:new Gr};return fo(l,T),uo(l,T),co(l),Lt(T),be(T),Ke(T,T.player.pos),T}function Ou(e){e.zoomLevel=Math.min(ou,e.zoomLevel+1),e.camera.panning=!1,++e.numZoomMoves,be(e)}function Hu(e){e.zoomLevel=Math.max(tu,e.zoomLevel-1),e.camera.panning=!1,++e.numZoomMoves,be(e)}function uo(e,t){const o=t.gameMapRoughPlans[t.level].levelType,n=Mr();let r=1;for(let s of e.cells.values)s.type===L.GroundWater&&(s.animation=new Ze(Iu(o,n),1,r*1369%4),r++)}function co(e,t){for(let o of e.items){const n=oe().itemGlows[o.type];if(n!==void 0){const r=o.type===M.Coin?.75:1.25;o.animation=new Un(n,0,r)}}}function fo(e,t){let o=0;const n=oe();if(n.candleAnimation.length>=3){const r=n.stoveAnimation.slice(0,2).map(d=>[d,.5]),s=r[0][0],i=r[0][0],c=n.candleAnimation.slice(0,3).map(d=>[d,.5]),l=n.candleAnimation.at(-2),f=n.candleAnimation.at(-1);for(let d of e.items)d.type===M.Stove?(d.animation=new ft(rt.idle,o,t.lightStates,d,r,s,i),o++):d.type===M.TorchLit?(d.animation=new ft(rt.idle,o,t.lightStates,d,c,l,f),o++):d.type===M.TorchUnlit&&(d.animation=new ft(rt.off,o,t.lightStates,d,c,l,f),o++)}if(n.torchAnimation.length>=3){const r=n.torchAnimation.slice(0,3).map(c=>[c,.5]),s=n.torchAnimation.at(-2),i=n.torchAnimation.at(-1);for(let c of e.guards)c.hasTorch&&(c.torchAnimation=new ft(rt.idle,o,t.lightStates,null,r,s,i),o++)}if(n.playerTorchAnimation.length>=2){const r=n.playerTorchAnimation.slice(0,2).map(l=>[l,.5]),s=n.playerTorchAnimation.at(-2),i=n.playerTorchAnimation.at(-1),c=t.player;c.torchAnimation=new ft(rt.idle,o,t.lightStates,null,r,s,i),o++}}function Oe(e){e.gameMode=F.Mansion,e.hasStartedGame||(e.persistedStats.totalPlays++,K("totalPlays",e.persistedStats.totalPlays),e.hasStartedGame=!0),bt(e)}function Qe(e){const t=e.dailyRun!==null;t?e.gameMapRoughPlans=ws(e.rng):e.gameMapRoughPlans=Fo(eo.numGameMaps,eo.totalGameLoot,e.rng),e.level=Math.min(e.gameMapRoughPlans.length-1,Sr),e.persistedStats.totalPlays++,K("totalPlays",e.persistedStats.totalPlays),t&&(e.persistedStats.currentDailyPlays++,K("currentDailyPlays",e.persistedStats.currentDailyPlays),e.persistedStats.allDailyPlays++,K("allDailyPlays",e.persistedStats.allDailyPlays)),e.gameStats={totalScore:0,turns:0,numLevels:0,numCompletedLevels:0,numGhostedLevels:0,numSpottings:0,numInjuries:0,numKnockouts:0,daily:e.dailyRun,timeStarted:Date.now(),timeEnded:0};const o=so(e.gameMapRoughPlans[e.level]);e.player=new at(o.playerStartPos,t),e.lightStates=Array(o.lightCount).fill(0),fo(o,e),uo(o,e),co(o),e.gameMode=F.Mansion,e.hintMessage="",Ko(e),e.numStepMoves=0,e.numLeapMoves=0,e.numWaitMoves=0,e.numZoomMoves=0,e.hasEnteredMansion=!1,e.experiencedPlayer=t||gt,e.finishedLevel=!1,e.turns=0,e.totalTurns=0,e.lootStolen=0,e.lootAvailable=e.gameMapRoughPlans[e.level].totalLoot,e.treasureStolen=0,Xo(e.levelStats),It(e,"gameStart"),e.ambience=ge.Outdoor,e.camera=lo(o.playerStartPos,e.zoomLevel),e.gameMap=o,e.activeSoundPool.empty(),e.ambientSoundPool.empty(),e.popups.reset(),Lt(e),be(e),Ke(e,e.player.pos),_e.Howler.stop(),bt(e)}function Pr(e){let t=Tt();e.rng=new Ne("Daily "+t),e.dailyRun=t,Qe(e)}function zu(e){const t=so(e.gameMapRoughPlans[e.level]);e.player=new at(t.playerStartPos,e.dailyRun!==null),e.lightStates=Array(t.lightCount).fill(0),fo(t,e),uo(t,e),co(t),e.turns=0,e.totalTurns=0,e.lootStolen=0,e.lootAvailable=e.gameMapRoughPlans[e.level].totalLoot,e.treasureStolen=0,Xo(e.levelStats),It(e,"gameStart"),e.hintMessage="",Ko(e),e.finishedLevel=!1,e.ambience=ge.Outdoor,e.camera=lo(t.playerStartPos,e.zoomLevel),e.gameMap=t,e.popups.reset(),e.activeSoundPool.empty(),e.ambientSoundPool.empty(),Lt(e),be(e),Ke(e,e.player.pos),_e.Howler.stop(),bt(e),e.player.torchAnimation===null&&console.log("WARNING: No player torch added")}function Xu(e,t){const o=e.player;if(e.player.health<=0||e.gameMode!==F.Mansion||e.player.animation!==null||(e.idleTimer-=t,e.idleTimer>0))return;const n=m.create(),r=m.fromValues(-.125,0),s=m.fromValues(.125,0),i=m.fromValues(0,.125),c=o.hidden(e.gameMap),l=oe(),f=l.playerTiles;let d,a;c||Math.random()>.5?(d=[{pt0:n,pt1:i,duration:.1,fn:O.easeInQuad},{pt0:i,pt1:n,duration:.05,fn:O.easeOutQuad},{pt0:n,pt1:n,duration:.1,fn:O.easeOutQuad},{pt0:n,pt1:i,duration:.1,fn:O.easeInQuad},{pt0:i,pt1:n,duration:.05,fn:O.easeOutQuad}],a=c?[f.hidden]:[f.normal]):(d=[{pt0:n,pt1:r,duration:.1,fn:O.easeOutQuad},{pt0:r,pt1:r,duration:.5,fn:O.easeOutQuad},{pt0:r,pt1:n,duration:.1,fn:O.easeInQuad},{pt0:n,pt1:s,duration:.1,fn:O.easeOutQuad},{pt0:s,pt1:s,duration:.5,fn:O.easeOutQuad},{pt0:s,pt1:n,duration:.1,fn:O.easeInQuad}],a=[f.left,f.left,f.normal,f.right,f.right,f.normal]),o.animation=new ue(d,a),o.idle||(o.idleCursorType==="orbs"?o.idleCursorAnimation=[new mt(l.namedTiles.idleIndicator,.6,Math.PI,0,0),new mt(l.namedTiles.idleIndicator,.6,Math.PI,2*Math.PI/3,0),new mt(l.namedTiles.idleIndicator,.6,Math.PI,4*Math.PI/3,0)]:o.idleCursorAnimation=[]),o.idle=!0,e.idleTimer=5}function kr(e,t,o){const n=e/1e3,r=o.tLast===void 0?0:Math.min(1/30,n-o.tLast);o.dt=r,o.tLast=n,o.fpsInfo.enabled&&(o.fpsInfo.frames++,o.fpsInfo.cumulativeTime+=r,o.fpsInfo.worstFrame<r&&(o.fpsInfo.worstFrame=r),r>.017&&o.fpsInfo.drops++,o.fpsInfo.cumulativeTime>1&&(o.fpsInfo.msgFPS=`FPS: ${Math.round(o.fpsInfo.frames/o.fpsInfo.cumulativeTime*10)/10} (worst: ${Math.round(o.fpsInfo.worstFrame*1e3)}ms, # drops: ${o.fpsInfo.drops})`,o.fpsInfo.cumulativeTime=0,o.fpsInfo.frames=0,o.fpsInfo.worstFrame=0,o.fpsInfo.drops=0)),Ae.width=Wo,Ae.height=Vo;const s=m.fromValues(Wo,Vo);o.oldPlayerPos=m.clone(o.player.pos),au(o),o.camera.zoomed||(o.camera.zoomed=!0,Zu(o,s)),o.camera.snapped||(o.camera.panning=!1,o.camera.snapped=!0,Ju(o,s)),r>0&&Yu(o,s,r);const i=o.textWindows[o.gameMode];i!==void 0&&(i.update(o),i.parseUI(s)),$u(o.touchController,t,s,o),ju(t,s,o),requestAnimationFrame(c=>kr(c,t,o))}function Yu(e,t,o){var n,r,s,i,c;Qu(e,t,o),Xu(e,o),Lu(e,o),e.popups.animate(o),e.popups.currentSpeaker!==void 0&&(e.popups.currentSpeechAbove?e.player.pos[1]>e.popups.currentSpeaker.pos[1]&&(e.popups.currentSpeechAbove=!1):e.player.pos[1]<e.popups.currentSpeaker.pos[1]&&(e.popups.currentSpeechAbove=!0)),e.player.noisyAnim+=2*o,e.player.noisyAnim-=Math.floor(e.player.noisyAnim),e.player.animation&&e.player.animation.update(o)&&(e.player.animation=null),e.player.lightActive&&((n=e.player.torchAnimation)!=null&&n.update(o))&&(e.player.torchAnimation=null),e.player.idle&&e.player.idleCursorAnimation&&(e.player.idleCursorAnimation=e.player.idleCursorAnimation.filter(l=>!l.update(o)));for(let l of e.gameMap.cells.values)(r=l.animation)==null||r.update(o);for(let l of e.gameMap.items)(s=l.animation)==null||s.update(o);for(let l of e.gameMap.guards)(i=l.animation)!=null&&i.update(o)&&(l.animation=null),(c=l.torchAnimation)!=null&&c.update(o)&&(l.torchAnimation=null);if(e.gameMapRoughPlans[e.level].levelType===E.Fortress&&!e.oldPlayerPos.equals(e.player.pos)){const l=e.gameMap.items.find(f=>f.pos.equals(e.oldPlayerPos));if(l&&l.type===M.Bush){const f=ao(E.Fortress,oe())[l.type],d={...f},a={...f},u={...f};d.textureIndex=f.textureIndex?f.textureIndex+1:0,a.textureIndex=f.textureIndex?f.textureIndex+2:0,u.textureIndex=f.textureIndex?f.textureIndex+3:0,l.animation=new Ze([f,d,a,u,u,u,a,d,f],1,0,1)}}e.gameMap.items=e.gameMap.items.filter(l=>{var d;const f=(d=l.animation)==null?void 0:d.update(o);return f===!0&&(l.animation=void 0),(l instanceof ue||l instanceof Ze)&&l.removeOnFinish?f!==!0:!0}),e.particles=e.particles.filter(l=>{var d;const f=(d=l.animation)==null?void 0:d.update(o);return(l.animation instanceof ue||l.animation instanceof Ze)&&l.animation.removeOnFinish?f!==!0:!0})}function ju(e,t,o){e.beginFrame(t);const n=le.create();tc(o,t,n),Ru(o.gameMap.cells,o.lightStates,o.seeAll),e.start(n,Te.Terrain),bu(o,e),e.flush(),e.start(n,Te.Entity),Bn(o,e,!1),Gu(o,e),Uu(o,e),Wu(o,e),(o.gameMode!==F.MansionComplete&&o.gameMode!==F.Win||o.player.animation)&&Du(o,e),Bn(o,e,!0),o.seeRoomAdjacencies&&Pu(o.gameMap.rooms,o.gameMap.adjacencies,e),Vu(o,e),o.gameMode===F.Mansion&&Bu(o,e),ku(o,e),e.flush(),qu(o.player.health,o.player.healthMax,o.healthBarState.healing,o.healthBarState.damageDisplayTimer,e,t),(o.gameMode===F.Mansion||o.gameMode===F.MansionComplete)&&(oc(e,t,o),nc(e,t,o)),(o.gameMode===F.Mansion||o.gameMode===F.MansionComplete)&&rc(e,t,o);const r=o.textWindows[o.gameMode];if(r!==void 0&&r.render(e),sc(e,t,o),ne===o.touchController){const s=le.create();le.ortho(s,0,t[0],0,t[1],1,-1),e.start(s,Te.Entity),Au(e,o.touchController),e.flush()}}function qu(e,t,o,n,r,s){const i=Math.max(1,t-e)*Math.max(0,n)/Tr;if(i<=0)return;const c=o?0:1,l=o?1:0,f=o?1:0,d=[c,l,f,Math.min(1,i*.05)],a=[c,l,f,Math.min(1,i*.5)],u=.8,h=1.5,p=le.create();s[0]<s[1]?(p[0]=s[0]/s[1],p[5]=1):(p[0]=1,p[5]=s[1]/s[0]),p[0]/=h,p[5]/=h,p[10]=1,p[15]=1,r.renderVignette(p,u/h,d,a)}function $u(e,t,o,n){if(ne!==e)return;const r=n.textWindows[n.gameMode];if(e.lastMotion.id!==-1&&r===void 0&&e.targetOnTouchDown===null&&e.lastMotion.active){const s=e.lastMotion.x-e.lastMotion.x0,i=e.lastMotion.y-e.lastMotion.y0,c=s/(tt*n.camera.scale),l=i/($e*n.camera.scale);n.camera.panning=!0,n.camera.position[0]-=c-n.camera.anchor[0],n.camera.position[1]-=l-n.camera.anchor[1],n.camera.anchor[0]=c,n.camera.anchor[1]=l}else n.camera.anchor[0]=0,n.camera.anchor[1]=0;Ku(e,t,o,n),e.activateTouchTargets(r?r.touchTargets:void 0)}function Ku(e,t,o,n){const r=t.entityTileSet.touchButtons!==void 0?t.entityTileSet.touchButtons:{},s=Fe*He(o),i=0,c=s,l=o[0],f=o[1]-s,d=Math.min(80,Math.floor(Math.min(l,f)/5)),a=d,u=d,h=0,p=n.gameMode===F.Mansion,y=[{action:"menuToggle",rect:new te(i+h,c+f-u-h,a,u),tileInfo:r.menu,visible:!0},{action:"zoomIn",rect:new te(i+l-a-h,c+f-u-h,a,u),tileInfo:r.zoomIn,visible:p},{action:"zoomOut",rect:new te(i+l-a-h,c+f-2*u-h,a,u),tileInfo:r.zoomOut,visible:p},{action:"left",rect:new te(i+h,c+u+h,a,u),tileInfo:r.left,visible:!0},{action:"right",rect:new te(i+2*a+h,c+u+h,a,u),tileInfo:r.right,visible:!0},{action:"up",rect:new te(i+a+h,c+2*u+h,a,u),tileInfo:r.up,visible:!0},{action:"down",rect:new te(i+a+h,c+h,a,u),tileInfo:r.down,visible:!0},{action:"wait",rect:new te(i+a+h,c+u+h,a,u),tileInfo:r.wait,visible:p},{action:"jump",rect:new te(i+l-1.5*a-h,c+h,1.5*a,1.5*u),tileInfo:r.jump,visible:p},{action:"menuAccept",rect:new te(i+l-1.5*a-h,c+h,1.5*a,1.5*u),tileInfo:r.menuAccept,visible:!p}],g=new te;for(const x of y)e.updateCoreTouchTarget(x.action,x.visible?x.rect:g,x.tileInfo)}function Qu(e,t,o){const r=e.zoomLevel-e.camera.zoom,i=(2*-e.camera.zoomVelocity+r*8)*8,c=e.camera.zoomVelocity+i*o;e.camera.zoom+=(e.camera.zoomVelocity+c)*(.5*o),e.camera.zoomVelocity=c,e.camera.scale=Math.pow(lt,e.camera.zoom);const l=m.create();if(!e.camera.panning){const u=m.create(),h=Math.pow(lt,e.zoomLevel);Dr(m.fromValues(e.gameMap.cells.sizeX,e.gameMap.cells.sizeY),t,h,ne===e.touchController&&!e.touchController.mouseActive,u,e.player.pos);const p=m.create();m.subtract(p,u,e.camera.position);const y=m.create();m.negate(y,e.camera.velocity);const g=m.create();m.scale(g,p,8**2),m.scaleAndAdd(g,g,y,2*8),m.scaleAndAdd(l,e.camera.velocity,g,o)}m.scaleAndAdd(e.camera.position,e.camera.position,e.camera.velocity,.5*o),m.scaleAndAdd(e.camera.position,e.camera.position,l,.5*o),m.copy(e.camera.velocity,l);const f=24,d=m.create();m.scale(d,e.camera.joltOffset,-576),m.scaleAndAdd(d,d,e.camera.joltVelocity,-2*f);const a=m.create();m.scaleAndAdd(a,e.camera.joltVelocity,d,o),m.scaleAndAdd(e.camera.joltOffset,e.camera.joltOffset,e.camera.joltVelocity,.5*o),m.scaleAndAdd(e.camera.joltOffset,e.camera.joltOffset,a,.5*o),m.copy(e.camera.joltVelocity,a)}function Zu(e,t){const o=Fe*He(t),n=t[0]/tt,r=(t[1]-2*o)/$e,s=e.gameMap.cells.sizeX,i=e.gameMap.cells.sizeY;n*i<r*s?e.zoomLevel=Math.log(n/s)/Math.log(lt):e.zoomLevel=Math.log(r/i)/Math.log(lt),e.zoomLevel=Math.max(0,Math.floor(e.zoomLevel))}function Ju(e,t){e.camera.zoom=e.zoomLevel,e.camera.zoomVelocity=0,e.camera.scale=Math.pow(lt,e.camera.zoom),Dr(m.fromValues(e.gameMap.cells.sizeX,e.gameMap.cells.sizeY),t,e.camera.scale,ne===e.touchController&&!e.touchController.mouseActive,e.camera.position,e.player.pos),m.zero(e.camera.velocity),m.zero(e.camera.joltOffset),m.zero(e.camera.joltVelocity)}function Dr(e,t,o,n,r,s){const i=m.create(),c=m.create();ec(e,t,o,n,i,c),r[0]=Math.max(i[0],Math.min(c[0],s[0]+.5)),r[1]=Math.max(i[1],Math.min(c[1],s[1]+.5))}function ec(e,t,o,n,r,s){const i=Fe*He(t),c=t[0],l=t[1]-i,d=Math.min(80,Math.floor(Math.min(c,l)/5))/(Math.max(tt,$e)*o),a=c/(tt*o),u=l/($e*o);let h,p;h=a/2,p=e[0]-a/2,n&&c>l&&(h-=2*d,p+=2*d),h>p&&(h=p=e[0]/2);let y,g;y=u/2,g=e[1]-u/2,n&&c<=l&&(y-=2*d,g+=2*d),y>g&&(y=g=e[1]/2),r[0]=h,r[1]=y,s[0]=p,s[1]=g}function tc(e,t,o){const n=Fe*He(t),r=m.fromValues(t[0],t[1]-n),[s,i]=Jo(r,e.camera.scale),c=e.camera.position[0]+e.camera.joltOffset[0],l=e.camera.position[1]+e.camera.joltOffset[1],f=n/($e*e.camera.scale),d=c-s/2,a=l-i/2;le.ortho(o,d,d+s,a-f,a+i,1,-1)}function Jo(e,t){const o=tt*t,n=$e*t,r=e[0]/o,s=e[1]/n;return[r,s]}function He(e){const n=Math.max(1,e[0]/(At*56)),r=Math.max(1,e[1]/(Fe*25)),s=Math.min(n,r);return Math.floor(s*2)/2}function oc(e,t,o){if(!o.popups.isSpeechBubbleVisible()||o.popups.currentSpeaker===void 0)return;const n=o.popups.currentSpeech;if(n.length===0)return;const r=He(t),s=r*At,i=r*Fe,c=tt*o.camera.scale,l=$e*o.camera.scale,f=m.fromValues(t[0],t[1]-i),[d,a]=Jo(f,o.camera.scale),u=o.camera.position[0]+o.camera.joltOffset[0],h=o.camera.position[1]+o.camera.joltOffset[1],p=o.popups.currentSpeaker.posAnimated(),y=Math.floor((p[0]+.5-u+d/2)*c),g=Math.floor((p[1]+.5-h+a/2)*l)+i,x=n.split(`
`),w=x.reduce((Q,X)=>Math.max(Q,X.length),0),S=x.length,T=le.create();le.ortho(T,0,t[0],0,t[1],1,-1);const I=r*4,D=r*2,R=r*2,A=w*s+2*(I+R),W=S*i+2*(D+R),C=l*.625;let k=y-A/2,U=o.popups.currentSpeechAbove?1:-1,G=(W/2+C)*U+g-W/2;k=Math.max(k,0),k=Math.min(k,t[0]-A),G=Math.max(G,i),G=Math.min(G,t[1]-W),e.start(T,Te.Font),e.addGlyph(k,G,k+w*s+2*(I+R),G+S*i+2*(D+R),{textureIndex:219,color:4278716424}),e.addGlyph(k+R,G+R,k+w*s+2*I+R,G+S*i+2*D+R,{textureIndex:219,color:4291875024});let V=G+(S-1)*i+D+R;for(const Q of x){let X=Math.floor(k+I+R+(w-Q.length)*s/2);for(let ie=0;ie<Q.length;++ie){const de=Q.charCodeAt(ie);e.addGlyph(X,V,X+s,V+i,{textureIndex:de,color:4278716424}),X+=s}V-=i}e.flush()}function nc(e,t,o){if(!o.popups.isNotificationVisible())return;const n=o.popups.notification;if(n.length===0)return;const r=He(t),s=r*At,i=r*Fe,c=tt*o.camera.scale,l=$e*o.camera.scale,f=m.fromValues(t[0],t[1]-i),[d,a]=Jo(f,o.camera.scale),u=o.camera.position[0]+o.camera.joltOffset[0],h=o.camera.position[1]+o.camera.joltOffset[1],p=o.popups.notificationWorldPos,y=p instanceof at?p.animation?p.pos.add(p.animation.offset):p.pos:p,g=(y[0]+.5-u+d/2)*c,x=(y[1]+.5-h+a/2)*l+i,w=n.split(`
`),S=w.reduce((de,Y)=>Math.max(de,Y.length),0),T=w.length,I=le.create();le.ortho(I,0,t[0],0,t[1],1,-1);const D=r*8,R=r*4,A=S*s+2*D,W=T*i+2*R,C=l*.875;let k=g-A/2,G=(W+2*C)*(1/2)+x-W/2;const V=r*8;k=Math.max(k,V),k=Math.min(k,t[0]-(A+V)),G=Math.max(G,i+V),G=Math.min(G,t[1]-(W+V)),e.start(I,Te.Font);const Q=2953316360,X=4294967295;e.addGlyph(k,G,k+S*s+2*D,G+T*i+2*R,{textureIndex:219,color:Q});let ie=G+(T-1)*i+R;for(const de of w){let Y=k+D+(S-de.length)*s/2;for(let me=0;me<de.length;++me){const ut=de.charCodeAt(me);e.addGlyph(Y,ie,Y+s,ie+i,{textureIndex:ut,color:X}),Y+=s}ie-=i}e.flush()}function rc(e,t,o){const n=o.hintMessage;if(n.length===0)return;const r=1,s=.25,i=He(t),c=t[0]/(i*At),l=t[1]/(i*Fe),f=le.create(),d=(c-n.length)/-2,a=s+-2;le.ortho(f,d,c+d,a,l+a,1,-1);const u=2953316360,h=4294967295;e.start(f,Te.Font),e.addGlyph(-r,-s,n.length+r,1+s,{textureIndex:et.background.textureIndex,color:u,unlitColor:u}),Ve(e,0,n,h),e.flush()}function Gn(e,t,o){const n=e&255,r=e>>8&255,s=e>>16&255,i=e>>24&255,c=t&255,l=t>>8&255,f=t>>16&255,d=t>>24&255,a=Math.max(0,Math.min(255,Math.trunc(n+(c-n)*o))),u=Math.max(0,Math.min(255,Math.trunc(r+(l-r)*o))),h=Math.max(0,Math.min(255,Math.trunc(s+(f-s)*o))),p=Math.max(0,Math.min(255,Math.trunc(i+(d-i)*o)));return a+(u<<8)+(h<<16)+(p<<24)}function Ve(e,t,o,n){for(let r=0;r<o.length;++r){let s=o.charCodeAt(r);s===10&&(s=32),e.addGlyph(t,0,t+1,1,{textureIndex:s,color:n}),++t}}function sc(e,t,o){const n=He(t),r=t[0]/(n*At),s=t[1]/(n*Fe),i=le.create();le.ortho(i,0,r,0,s,1,-1),e.start(i,Te.Font),e.addGlyph(0,0,r,1,et.background);const c=(o.dailyRun?"Daily Lvl ":"Lvl ")+(o.level+1),l=Ct(o);let f=""+o.turns+"/"+l;const d=o.turns>l?ko:o.turns>.75*l?Yi:In;o.levelStats.numSpottings===0||(f+="!");const u=o.fpsInfo.enabled?o.fpsInfo.msgFPS:"",h=o.fpsInfo.enabled?2:1,p=c.length+f.length+u.length+h;let y=1;if(o.gameMap.cells.atVec(o.player.pos).type==L.GroundWater&&o.player.turnsRemainingUnderwater>0){const C=et.air.textureIndex;for(let k=0;k<oo-2;++k){const U=k<o.player.turnsRemainingUnderwater-1?Cn:ce;e.addGlyph(y,0,y+1,1,{textureIndex:C,color:U}),++y}}else{let C=o.healthBarState.size;const k=et.heart.textureIndex;for(let U=0;U<o.player.healthMax;++U){const G=o.healthBarState.heartFlashRemaining[U],V=U<o.player.health?Gn(vr,_,G):Gn(ce,ko,G);e.addGlyph(y,0,y+C,C,{textureIndex:k,color:V}),y+=C}}++y;const x="Leap";o.leapToggleActive&&Ve(e,y,x,In),y=o.player.healthMax+x.length+2;let w=r;const S=Math.floor(o.gameMap.fractionRevealed()*100),T=o.player.hasVaultKey?"Key ":"";let I="Map "+S+"% ",D="Loot "+o.lootStolen+"/"+(S<100?"?":o.lootAvailable)+" ",R=o.finishedLevel&&o.player.health>0&&o.gameMode===F.Mansion?"Escape! ":"";const A=w-(y+p+T.length+1);I.length+D.length+R.length>A&&(S<100?D="":I=""),I.length+D.length+R.length>A&&(D="",I=""),I.length+D.length+R.length>A&&(R=""),w-=D.length,Ve(e,w,D,Xi),w-=I.length,Ve(e,w,I,_),w-=T.length,Ve(e,w,T,Cn),w-=R.length,Ve(e,w,R,_);const W=(y+w-p)/2;Ve(e,W,c,Be),Ve(e,W+c.length+1,f,d),u!==""&&Ve(e,W+c.length+f.length+2,u,Be),e.flush()}function Tt(e=null,t=!0){const o=e??new Date,n=t?o.getUTCFullYear():o.getFullYear(),r=1+(t?o.getUTCMonth():o.getMonth()),s=t?o.getUTCDate():o.getDate(),i=String(n),c=String(r).padStart(2,"0"),l=String(s).padStart(2,"0");return`${i}/${c}/${l}`}
