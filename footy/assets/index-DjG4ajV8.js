var Lt=Object.defineProperty;var ot=s=>{throw TypeError(s)};var Vt=(s,t,e)=>t in s?Lt(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var b=(s,t,e)=>Vt(s,typeof t!="symbol"?t+"":t,e),jt=(s,t,e)=>t.has(s)||ot("Cannot "+e);var nt=(s,t,e)=>t.has(s)?ot("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(s):t.set(s,e);var G=(s,t,e)=>(jt(s,t,"access private method"),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(o){if(o.ep)return;o.ep=!0;const n=e(o);fetch(o.href,n)}})();var Z=1e-6,L=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var s=0,t=arguments.length;t--;)s+=arguments[t]*arguments[t];return Math.sqrt(s)});function _(){var s=new L(16);return L!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=0,s[12]=0,s[13]=0,s[14]=0),s[0]=1,s[5]=1,s[10]=1,s[15]=1,s}function Rt(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function H(s,t,e){var i=e[0],o=e[1],n=e[2],a,r,h,l,d,u,f,c,T,m,y,F;return t===s?(s[12]=t[0]*i+t[4]*o+t[8]*n+t[12],s[13]=t[1]*i+t[5]*o+t[9]*n+t[13],s[14]=t[2]*i+t[6]*o+t[10]*n+t[14],s[15]=t[3]*i+t[7]*o+t[11]*n+t[15]):(a=t[0],r=t[1],h=t[2],l=t[3],d=t[4],u=t[5],f=t[6],c=t[7],T=t[8],m=t[9],y=t[10],F=t[11],s[0]=a,s[1]=r,s[2]=h,s[3]=l,s[4]=d,s[5]=u,s[6]=f,s[7]=c,s[8]=T,s[9]=m,s[10]=y,s[11]=F,s[12]=a*i+d*o+T*n+t[12],s[13]=r*i+u*o+m*n+t[13],s[14]=h*i+f*o+y*n+t[14],s[15]=l*i+c*o+F*n+t[15]),s}function X(s,t,e){var i=e[0],o=e[1],n=e[2];return s[0]=t[0]*i,s[1]=t[1]*i,s[2]=t[2]*i,s[3]=t[3]*i,s[4]=t[4]*o,s[5]=t[5]*o,s[6]=t[6]*o,s[7]=t[7]*o,s[8]=t[8]*n,s[9]=t[9]*n,s[10]=t[10]*n,s[11]=t[11]*n,s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15],s}function bt(s,t,e){var i=Math.sin(e),o=Math.cos(e),n=t[4],a=t[5],r=t[6],h=t[7],l=t[8],d=t[9],u=t[10],f=t[11];return t!==s&&(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s[4]=n*o+l*i,s[5]=a*o+d*i,s[6]=r*o+u*i,s[7]=h*o+f*i,s[8]=l*o-n*i,s[9]=d*o-a*i,s[10]=u*o-r*i,s[11]=f*o-h*i,s}function Ht(s,t,e,i,o){var n=1/Math.tan(t/2),a;return s[0]=n/e,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=n,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=-1,s[12]=0,s[13]=0,s[15]=0,o!=null&&o!==1/0?(a=1/(i-o),s[10]=(o+i)*a,s[14]=2*o*i*a):(s[10]=-1,s[14]=-2*i),s}var zt=Ht;function Ut(s,t,e,i){var o,n,a,r,h,l,d,u,f,c,T=t[0],m=t[1],y=t[2],F=i[0],A=i[1],v=i[2],P=e[0],S=e[1],E=e[2];return Math.abs(T-P)<Z&&Math.abs(m-S)<Z&&Math.abs(y-E)<Z?Rt(s):(d=T-P,u=m-S,f=y-E,c=1/Math.hypot(d,u,f),d*=c,u*=c,f*=c,o=A*f-v*u,n=v*d-F*f,a=F*u-A*d,c=Math.hypot(o,n,a),c?(c=1/c,o*=c,n*=c,a*=c):(o=0,n=0,a=0),r=u*a-f*n,h=f*o-d*a,l=d*n-u*o,c=Math.hypot(r,h,l),c?(c=1/c,r*=c,h*=c,l*=c):(r=0,h=0,l=0),s[0]=o,s[1]=r,s[2]=d,s[3]=0,s[4]=n,s[5]=h,s[6]=u,s[7]=0,s[8]=a,s[9]=l,s[10]=f,s[11]=0,s[12]=-(o*T+n*m+a*y),s[13]=-(r*T+h*m+l*y),s[14]=-(d*T+u*m+f*y),s[15]=1,s)}function $(){var s=new L(3);return L!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function rt(s,t,e){var i=new L(3);return i[0]=s,i[1]=t,i[2]=e,i}function at(s,t,e){return s[0]=t[0]+e[0],s[1]=t[1]+e[1],s[2]=t[2]+e[2],s}function Ot(s,t){var e=t[0]-s[0],i=t[1]-s[1],o=t[2]-s[2];return e*e+i*i+o*o}(function(){var s=$();return function(t,e,i,o,n,a){var r,h;for(e||(e=3),i||(i=0),o?h=Math.min(o*e+i,t.length):h=t.length,r=i;r<h;r+=e)s[0]=t[r],s[1]=t[r+1],s[2]=t[r+2],n(s,s,a),t[r]=s[0],t[r+1]=s[1],t[r+2]=s[2];return t}})();function Ct(){var s=new L(2);return L!=Float32Array&&(s[0]=0,s[1]=0),s}function Nt(s,t){var e=new L(2);return e[0]=s,e[1]=t,e}function Gt(s,t,e){return s[0]=t[0]+e[0],s[1]=t[1]+e[1],s}(function(){var s=Ct();return function(t,e,i,o,n,a){var r,h;for(e||(e=2),i||(i=0),o?h=Math.min(o*e+i,t.length):h=t.length,r=i;r<h;r+=e)s[0]=t[r],s[1]=t[r+1],n(s,s,a),t[r]=s[0],t[r+1]=s[1];return t}})();class M extends Float32Array{constructor(t=0,e=0,i=0){super(3),this[0]=t,this[1]=e,this[2]=i}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}set x(t){this[0]=t}set y(t){this[1]=t}set z(t){this[2]=t}get c(){return new M(this[0],this[1],this[2])}zeroX(){return this[0]=0,this}zeroY(){return this[1]=0,this}zeroZ(){return this[2]=0,this}setFrom(t,e,i){return this[0]=t,this[1]=e,this[2]=i,this}add(t){return this[0]+=t[0],this[1]+=t[1],this[2]+=t[2],this}sub(t){return this[0]-=t[0],this[1]-=t[1],this[2]-=t[2],this}scale(t){return this[0]*=t,this[1]*=t,this[2]*=t,this}scaleAndAdd(t,e){return this[0]+=t[0]*e,this[1]+=t[1]*e,this[2]+=t[2]*e,this}normalize(){const t=Math.hypot(this[0],this[1],this[2]);return t>0?this.scale(1/t):this.setFrom(0,0,0)}dot(t){return this[0]*t[0]+this[1]*t[1]+this[2]*t[2]}cross(t){return new M(this[1]*t[2]-this[2]*t[1],this[2]*t[0]-this[0]*t[2],this[0]*t[1]-this[1]*t[0])}lenSq(){return this[0]**2+this[1]**2+this[2]**2}len(){return Math.hypot(this[0],this[1],this[2])}dist(t){return Math.hypot(this[0]-t[0],this[1]-t[1],this[2]-t[2])}copyFrom(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this}toArray(){return[this[0],this[1],this[2]]}static fromArray(t){return new M(t[0],t[1],t[2])}static direction(t,e){return new M(e[0]-t[0],e[1]-t[1],e[2]-t[2]).normalize()}lerp(t,e){return this[0]+=(t[0]-this[0])*e,this[1]+=(t[1]-this[1])*e,this[2]+=(t[2]-this[2])*e,this}lerpEased(t,e,i){const o=i?i(e):e;return this[0]+=(t[0]-this[0])*o,this[1]+=(t[1]-this[1])*o,this[2]+=(t[2]-this[2])*o,this}get xz(){return new I(this[0],this[2])}get xy(){return new I(this[0],this[1])}get yz(){return new I(this[1],this[2])}toDir(t){return this.sub(t).normalize()}moveTo(t,e,i=!1){const o=t[0]-this[0],n=t[1]-this[1],a=t[2]-this[2],r=Math.hypot(o,n,a);if(r<1e-5)return this;const h=i?e/r:Math.min(1,e/r);return this[0]+=o*h,this[1]+=n*h,this[2]+=a*h,this}moveDir(t,e){const i=t[0],o=t[1],n=t[2],a=Math.hypot(i,o,n);return a<1e-5?this:(this[0]+=i*e/a,this[1]+=o*e/a,this[2]+=n*e/a,this)}}class I extends Float32Array{constructor(t=0,e=0){super(2),this[0]=t,this[1]=e}get x(){return this[0]}get y(){return this[1]}set x(t){this[0]=t}set y(t){this[1]=t}get c(){return new I(this[0],this[1])}set(t,e){return this[0]=t,this[1]=e,this}add(t){return this[0]+=t[0],this[1]+=t[1],this}sub(t){return this[0]-=t[0],this[1]-=t[1],this}scale(t){return this[0]*=t,this[1]*=t,this}normalize(){const t=Math.hypot(this[0],this[1]);return t>0?this.scale(1/t):this.set(0,0)}dot(t){return this[0]*t[0]+this[1]*t[1]}lenSq(){return this[0]**2+this[1]**2}len(){return Math.sqrt(this.lenSq())}dist(t){return Math.hypot(this[0]-t[0],this[1]-t[1])}copyFrom(t){return this[0]=t[0],this[1]=t[1],this}toArray(){return[this[0],this[1]]}static fromArray(t){return new I(t[0],t[1])}static direction(t,e){return new I(e[0]-t[0],e[1]-t[1]).normalize()}lerp(t,e){return this[0]+=(t[0]-this[0])*e,this[1]+=(t[1]-this[1])*e,this}lerpEased(t,e,i=void 0){const o=i?i(e):e;return this[0]+=(t[0]-this[0])*o,this[1]+=(t[1]-this[1])*o,this[2]+=(t[2]-this[2])*o,this}toDir(t){return this.sub(t).normalize()}moveTo(t,e,i=!1){const o=t[0]-this[0],n=t[1]-this[1],a=Math.hypot(o,n);if(a<1e-5)return this;const r=i?e/a:Math.min(1,e/a);return this[0]+=o*r,this[1]+=n*r,this}moveDir(t,e){const i=t[0],o=t[1],n=Math.hypot(i,o);return n<1e-5?this:(this[0]+=i*e/n,this[1]+=o*e/n,this)}}const p=(s=0,t=0,e=0)=>new M(s,t,e),Xt=(s=0,t=0)=>new I(s,t),Yt=160,w=170,Q=Yt/2,g=w/2,D=6,Y=6,ht=.5,Wt=Object.freeze({home:[0,0,0],away:[0,0,w]}),qt=Object.freeze([p(-.5*D-Y,0,w),p(-.5*D,0,w),p(.5*D,0,w),p(.5*D+Y,0,w)]),Zt=Object.freeze([p(-.5*D-Y,0,0),p(-.5*D,0,0),p(.5*D,0,0),p(.5*D+Y,0,0)]),Kt=Object.freeze({Away:qt,Home:Zt});function ct(s){const t=s[0]/Q,e=(s[2]-g)/g;return t*t+e*e>1}function $t(s,t,e,i,o,n){const a=o-e,r=n-i;if(a===0&&r===0){const T=s-e,m=t-i;return T*T+m*m}const h=((s-e)*a+(t-i)*r)/(a*a+r*r),l=Math.max(0,Math.min(1,h)),d=e+l*a,u=i+l*r,f=s-d,c=t-u;return f*f+c*c}function Qt(s,t){const e=ct(s),i=ct(t);for(const o of["Away","Home"]){const n=Kt[o];if(i&&!e){if(o==="Away"){if(s[2]>w-10){const r=t[0];if(r>=-3&&r<=3)return"goalAway";if(r>=-9&&r<-3||r>3&&r<=9)return"behindAway"}}else if(o==="Home"&&s[2]<10){const r=t[0];if(r>=-3&&r<=3)return"goalHome";if(r>=-9&&r<-3||r>3&&r<=9)return"behindHome"}}const a=["outerLeftPost","innerLeftPost","innerRightPost","outerRightPost"];for(let r=0;r<n.length;r++){const h=n[r][0],l=n[r][2];if($t(h,l,s[0],s[2],t[0],t[2])<ht*ht)return`${a[r]}${o}`}}return!e&&i?"outOfBounds":null}function lt(s=!1){const e={fullForward:70,halfForward:35,halfBack:-35,fullBack:-70},i={LFP:-45,FF:0,RFP:45,LHF:-50,CHF:0,RHF:50,LHB:-50,CHB:0,RHB:50,LBP:-45,FB:0,RBP:45};function o(h,l){const d=h*Math.PI/180,u=Q*Math.sin(d)*(Math.abs(l)/g)-(s?2:-2),f=g+l*(s?-1:1);return p(u,0,f)}const n=-Q-4,a=h=>g+(s?1:-1)*h;return{LFP:o(i.LFP,e.fullForward-(s?10:-10)),FF:o(i.FF,e.fullForward),RFP:o(i.RFP,e.fullForward-(s?10:-10)),LHF:o(i.LHF,e.halfForward),CHF:o(i.CHF,e.halfForward),RHF:o(i.RHF,e.halfForward),LW:p(-25,0,g-(s?2:-2)),C:p(8,0,g-(s?-5:5)),RW:p(25,0,g-(s?2:-2)),LHB:o(i.LHB,e.halfBack),CHB:o(i.CHB,e.halfBack),RHB:o(i.RHB,e.halfBack),LBP:o(i.LBP,e.fullBack-(s?10:-10)),FB:o(i.FB,e.fullBack),RBP:o(i.RBP,e.fullBack-(s?10:-10)),Ruck:p(0,0,g-(s?10:-10)),RR:p(-10,0,g-(s?10:-10)),Rover:p(10,0,g-(s?10:-10)),Bench1:p(n,0,a(10)),Bench2:p(n,0,a(13)),Bench3:p(n,0,a(16)),Bench4:p(n,0,a(19)),Bench5:p(n,0,a(22))}}function Jt(s,t,e){let i=null,o=1/0;for(const n of t)if(n.team!==s.team){const a=n.pos.dist(e);a<o&&(o=a,i=n)}return i}class te{constructor(t,e,i){this.game=t,this.kicker=e,this.markPos=i.c,this.timer=0,this.finished=!1}update(t){this.timer+=t}enforce(t,e){return!1}cleanup(){}}class W extends te{constructor(t,e,i){super(t,e,i),this.defender=null,this.zone={center:p(0,0,0),radius:1},this.game=t,t=this.game,e=this.kicker;const o=e.team==="home"?0:w,n=p(0,0,o),a=i.c.sub(n).zeroY().normalize(),r=i.c,h=i.c;e.pos.copyFrom(h),e.jogVel.copyFrom(a).scale(e.jogSpeed),e.joltVel.setFrom(0,0,0),t.ball.carrier!==e&&t.ball.pickup(e),e.team==="home"&&(this.game.player=e),e.stateTimer=10/e.jogSpeed,this.defender=Jt(e,t.players,i),this.defender&&(this.defender.pos.copyFrom(r),this.defender.vel.setFrom(0,0,0),this.defender.jogVel.setFrom(0,0,0),this.defender.joltVel.setFrom(0,0,0),this.defender.actionState="standingMark",this.defender.stateTimer=10)}update(t){super.update(t);const{kicker:e,markPos:i,game:o}=this,n=!o.ball.carried,a=e.pos.c.sub(i);a[1]=0;const r=e.team==="home"?0:w,h=p(0,0,r).sub(i).zeroY().normalize(),l=a.dot(h),d=p(-h[2],0,h[0]),u=a.dot(d),f=l>.05||u>2;(n||f)&&(this.finished=!0)}enforce(t,e){const{kicker:i,defender:o,markPos:n}=this,a=i.pos,r=n.c.lerp(a,.5),h=n.dist(a)/2+5,l=t.pos.dist(r);if(t===o)return t.pos.copyFrom(o.pos),t.vel.setFrom(0,0,0),t.jogVel.setFrom(0,0,0),t.joltVel.setFrom(0,0,0),!1;if(l<h&&t!==i&&t!==o){const d=t.pos.dist(r),u=h-d;if(u>0){const f=t.pos.c.sub(r);f[1]=0,f.len()<.001?f.setFrom(Math.random()-.5,0,Math.random()-.5).normalize():f.normalize();const T=u<2?u*10:u*20;return t.joltVel.scaleAndAdd(f,T*e),t.pos.scaleAndAdd(t.joltVel,e),!0}}return!1}}function et(s){let t=BigInt(s)&0xFFFFFFFFFFFFFFFFn;return function(){t=t+0x9E3779B97F4A7C15n&0xFFFFFFFFFFFFFFFFn;let i=t;return i=(i^i>>30n)*0xBF58476D1CE4E5B9n&0xFFFFFFFFFFFFFFFFn,i=(i^i>>27n)*0x94D049BB133111EBn&0xFFFFFFFFFFFFFFFFn,i=i^i>>31n,i}}class O{constructor(){b(this,"_seed",0)}random(){return Math.random()}seed(t){throw new Error("Seeding is not available in the default PRNG class. You can set another with `eskv.rand.setPRNG`.")}getRandomInt(t,e=0){return e!=0?t+Math.floor(this.random()*(e-t)):Math.floor(this.random()*t)}getRandomPos(t,e){return[this.getRandomInt(t),this.getRandomInt(e)]}randomRange(t=0,e=1){return Math.floor(this.random()*(e-t+1))+t}randomFloat(t=0,e=1){return this.random()*(e-t)+t}shuffle(t){let e,i;for(let o=1;o<t.length;o++)i=this.randomRange(0,o),e=t[o],t[o]=t[i],t[i]=e;return t}choose(t){return t[Math.floor(this.random()*t.length)]}chooseN(t,e){let i=new Array(e),o=t.length,n=new Array(o);if(e>o)throw new RangeError("chooeN: more elements requested than available");for(;e--;){let a=Math.floor(this.random()*o);i[e]=t[a in n?n[a]:a],n[a]=--o in n?n[o]:o}return i}}function dt(s,t,e,i){return function(){s>>>=0,t>>>=0,e>>>=0,i>>>=0;var o=s+t|0;return s=t^t>>>9,t=e+(e<<3)|0,e=e<<21|e>>>11,i=i+1|0,o=o+i|0,e=e+o|0,(o>>>0)/4294967296}}function ft(s){return function(){var t=s+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function ut(s,t,e,i){return function(){var o=t<<9,n=t*5;return n=(n<<7|n>>>25)*9,e^=s,i^=t,t^=e,s^=i,e^=o,i=i<<11|i>>>21,(n>>>0)/4294967296}}function mt(s,t,e,i){return function(){s|=0,t|=0,e|=0,i|=0;var o=s-(t<<27|t>>>5)|0;return s=t^(e<<17|e>>>15),t=e+i|0,e=i+o|0,i=s+o|0,(i>>>0)/4294967296}}class Et extends O{constructor(){super(...arguments);b(this,"_seed",1);b(this,"d",3735928559);b(this,"xorSeed",Math.floor(Date.now())^this.d);b(this,"random",dt(2654435769,608135816,3084996962,this.xorSeed))}seed(e){this._seed=e,this.xorSeed=e^this.d;const i=et(this.xorSeed);this.random=dt(i(),i(),i(),i())}}class ee extends O{constructor(){super(...arguments);b(this,"_seed",1);b(this,"d",3735928559);b(this,"xorSeed",Math.floor(Date.now())^this.d);b(this,"random",ft(this.xorSeed))}seed(e){this._seed=e,this.xorSeed=e^this.d,this.random=ft(this.xorSeed)}}class se extends O{constructor(){super(...arguments);b(this,"_seed",1);b(this,"d",3735928559);b(this,"xorSeed",Math.floor(Date.now())^this.d);b(this,"random",ut(2654435769,608135816,3084996962,this.xorSeed))}seed(e){this._seed=e,this.xorSeed=e^this.d;const i=et(this.xorSeed);this.random=ut(i(),i(),i(),i())}}class ie extends O{constructor(){super(...arguments);b(this,"_seed",1);b(this,"d",3735928559);b(this,"xorSeed",Math.floor(Date.now())^this.d);b(this,"random",mt(2654435769,608135816,3084996962,this.xorSeed))}seed(e){this._seed=e,this.xorSeed=e^this.d;const i=et(this.xorSeed);this.random=mt(i(),i(),i(),i())}}var B=new Et;function oe(s){switch(s){case"Math.random":B=new O;return;case"sfc32":B=new Et;return;case"mulberry32":B=new ee;return;case"xoshiro128ss":B=new se;return;case"jsf32":B=new ie;return;default:throw Error(`Unknown PRNG ${s}`)}}function z(s,t=0){return B.getRandomInt(s,t)}function ne(s){return B.choose(s)}function re(s){return B.seed(s)}function ae(s){let t=5381;for(let e=0;e<s.length;e++)t=(t<<5)+t+s.charCodeAt(e),t=t&4294967295;return t>>>0}function he(s,t){const[e,i]=s.collideBounds(),[o,n]=t.collideBounds(),a=s.pos[0]-t.pos[0],r=s.pos[2]-t.pos[2],h=a*a+r*r,l=.5*e,d=.5*o,u=l+d,f=s.pos[1],c=s.pos[1]+i,T=t.pos[1],m=t.pos[1]+n,y=f<m&&c>T;return h<=u*u&&y}function pt(s){const t=s.collideBounds()[0]||1;return s.intent==="shepherd"||s.intent==="block"?t*1.4:s.intent==="crumb"||s.intent==="hangBack"?t*.8:t}function yt(s){switch(s){case"mark":return 1.3;case"block":return 1.4;case"spoil":return 1.1;case"shepherd":return 1.25;case"contestAnyway":return 1;case"crumb":return .7;case"hangBack":return .5;default:return 1}}class st{constructor(t){this.pos=p(t[0],t[1],t[2]),this.vel=p(0,0,0),this.width=1.6,this.height=2.4,this.usesGravity=!0,this.gravity=p(0,-9.8,0),this.bounce=0,this.floorY=0}setupForBoundary(t,e){}update(t,e){this.usesGravity&&this.vel.scaleAndAdd(this.gravity,t),this.pos.scaleAndAdd(this.vel,t),this.pos[1]<this.floorY&&(this.pos[1]=this.floorY,Math.abs(this.vel[1])>.5?this.vel[1]=-this.vel[1]*this.bounce:this.vel[1]=0)}render(t){t.renderSprite(this.pos,this.width,this.height,1,0)}collidesWith(t){return he(this,t)}collideBounds(){return[.5,1.8]}}const Tt={home:Object.freeze({idle:[[0,0,0]],run:[[1,0,0],[2,0,0],[3,0,0],[4,0,0],[5,0,0],[6,0,0]],kickRightFoot:[[1,0,0],[2,0,0]],kickLeftFoot:[[4,0,0],[5,0,0]],handpassRightHand:[[1,0,0],[0,0,0]],handpassLeftHand:[[4,0,0],[0,0,0]],jumpMark:[[1,0,0],[2,0,0],[0,0,0]],jumpSpoil:[[1,0,0],[2,0,0],[0,0,0]]}),away:Object.freeze({idle:[[0,4,0]],run:[[1,4,0],[2,4,0],[3,4,0],[4,4,0],[5,4,0],[6,4,0]],kickRightFoot:[[1,4,0],[2,4,0]],kickLeftFoot:[[4,4,0],[5,4,0]],handpassRightHand:[[1,4,0],[0,4,0]],handpassLeftHand:[[4,4,0],[0,4,0]],jumpMark:[[1,4,0],[2,4,0],[0,4,0]],jumpSpoil:[[1,4,0],[2,4,0],[0,4,0]]})},K=Object.freeze({swarthy:{front:[0,12,0],back:[0,13,0],headCount:4,bodyRowOffset:9},pasty:{front:[0,14,0],back:[0,15,0],headCount:3,bodyRowOffset:10},tan:{front:[0,16,0],back:[0,17,0],headCount:3,bodyRowOffset:11}}),ce=Object.freeze({home:{front:[0,5,0],back:[0,6,0]},away:{front:[0,7,0],back:[0,8,0]}}),le=Object.freeze({idle:[[0,0,0]],run:[[1,0,0],[2,0,0],[3,0,0],[4,0,0],[5,0,0],[6,0,0]],kickRightFoot:[[1,0,0],[2,0,0]],kickLeftFoot:[[4,0,0],[5,0,0]],handpassRightHand:[[1,0,0],[0,0,0]],handpassLeftHand:[[4,0,0],[0,0,0]],jumpMark:[[1,0,0],[2,0,0],[0,0,0]],jumpSpoil:[[1,0,0],[2,0,0],[0,0,0]]});class de extends st{constructor(t,e,i,o,n=!1){super(o),this.intent="idle",this.intentTarget=null,this.positionPos=M.fromArray(o),this.teamId=i,this.complexion=ne(["swarthy","pasty","tan"]),this.faceId=z(K[this.complexion].headCount),this.name=t,this.team=e,this.playing=n,this.width=1.6,this.height=2.4,this.aiming=!1,this.jogVel=p(0,0,0),this.joltVel=p(0,0,0),this.jogSpeed=5,this.joltSpeed=2,this.energy=10,this.energyRecovery=0,this.statsWeight=85+Math.random()*10,this.statsStrength=50+Math.random()*30,this.statsSpeed=10+Math.random()*5,this.statsJump=10,this.statsKickRange=45,this.statsHandpassRange=20,this.statsAgility=10,this.joltDecayRate=8,this.animations=Tt[e]??Tt.home,this.animState="idle",this.actionState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=8,this.stateTimer=0,this.animSprite=[[0,0,0]]}updateAI(t,e){const o=e.ball;let n=null;if(o.carried&&o.carrier===this)if(this.stateTimer+=t,this.stateTimer<1)n="run";else{let r=!1;for(const c of e.players)if(!(c===this||c.team===this.team)&&c.pos.dist(this.pos)<7){r=!0;break}const h=e.players.filter(c=>c.team===this.team&&c!==this);if(r){let c=null,T=-1/0;const m=p(0,0,this.team==="home"?-1:1);for(const y of h){if(y===this)continue;const F=this.pos.dist(y.pos);if(F>40)continue;let A=!1;for(const k of e.players)if(k.team!==this.team&&k.pos.dist(y.pos)<5){A=!0;break}if(A)continue;const v=this.pos.c.toDir(y.pos),P=m.c.dot(v),S=M.fromArray(y.vel);S[1]=0;const E=m.dot(S),R=Math.abs(F-15)*.2,x=15*P+2*E-R;x>T&&(T=x,c=y)}if(c){const y=c.pos.c.sub(this.pos),F=[y[0],y[2]];return this.tryDisposeBall(e,{kickReleased:!0,kickHeldTime:y.len()>20?.5:.1,aimTarget:F})??"run"}}const d=this.team==="home"?-5:w+5,u=0;if(Math.abs(this.pos[2]-d)<=this.statsKickRange){const c=p(u+(Math.random()-.5)*9,0,d).sub(this.pos),T=[c[0],c[2]];return this.tryDisposeBall(e,{kickReleased:!0,kickHeldTime:.4,aimTarget:T})??"run"}if(r||this.stateTimer>5){let c=null,T=-1/0;for(const m of h){const y=this.pos.dist(m.pos);if(y>this.statsKickRange)continue;const F=this.team==="home"?-1:1,A=(m.pos[2]-this.pos[2])*F,v=Math.abs(m.pos[0]-this.pos[0]),P=A-v-y;P>T&&(T=P,c=m)}if(c){const m=c.pos.c.sub(this.pos),y=[m[0],m[2]];return this.tryDisposeBall(e,{kickReleased:!0,kickHeldTime:.4,aimTarget:y})??"run"}}n="run"}let a=null;if(o.carried&&o.carrier===this){const r=this.team==="home"?-1:1,h=p(0,0,r);let l=p(0,0,0);for(const u of e.players){if(u===this||u.team===this.team)continue;const f=this.pos.c.sub(u.pos);f[1]=0;const c=f.len();if(c<5&&c>.5){const T=1/c;l.scaleAndAdd(f.normalize(),T)}}const d=h.c.add(l).normalize();a=this.pos.c.scaleAndAdd(d,10)}else if(o.carried)if(o.carrier&&o.carrier.team!==this.team&&e.chasers<3&&e.closestPlayers[this.team]===this||o.pos.dist(this.pos)<=15&&this.energy>0)a=o.pos.c,e.chasers++;else if(o.carrier&&o.carrier.team===this.team&&o.pos[2]>20&&o.pos[2]<w-20&&o.pos.dist(this.pos)<10&&this.energy>.3&&e.followers<3){e.followers++;const r=o.carrier.jogVel.c;r.len()<.01&&(r[2]=this.team==="home"?-1:1),r.normalize();const h=p(-r[2],0,r[0]).normalize();let l=0,d=12;switch(this.name){case"wing":l=12*(this.team==="home"?-1:1),d=15;break;case"forward":l=6,d=18;break;case"half-forward":case"half-back":l=4,d=10;break;case"center":case"mid":l=0,d=10;break;case"back":default:l=-6,d=8;break}a=o.carrier.pos.c.scaleAndAdd(r,d).scaleAndAdd(h,l)}else a=this.positionPos??this.pos;else if(o.pos[1]>.1||o.vel[1]>.1){const r=o.gravity[1]??-9.8,h=o.vel[1],l=o.pos[1],d=.5*r,u=h,f=l;let c=0;const T=u*u-4*d*f;if(T>=0&&Math.abs(d)>1e-5){const y=Math.sqrt(T),F=(-u+y)/(2*d),A=(-u-y)/(2*d);c=Math.max(F,A)}const m=o.pos.c.scaleAndAdd(o.vel,c);m[1]=0,m.dist(this.pos)<=35?a=m:a=this.positionPos??this.pos}else o.pos.dist(this.pos)<=25&&e.chasers<3?(a=o.pos,e.chasers++):a=this.positionPos??this.pos;if(a===this.positionPos&&this.positionPos.dist(this.pos)<=1&&(n="idle",this.actionState!=="idle"&&(this.stateTimer=0),this.jogVel.setFrom(0,0,0),this.joltVel.setFrom(0,0,0)),a===null&&n===null&&(a=Wt[this.team]),a&&n!=="idle"){const r=a.c.sub(this.pos).zeroY().normalize();if(r.len()>1e-4){this.joltVel.copyFrom(r).scale(this.joltSpeed);const h=this.jogVel.c.normalize();this.jogVel.len()>1e-4?(h.lerp(r,10*t).normalize(),this.jogVel.copyFrom(h).scale(this.jogSpeed)):this.jogVel.copyFrom(r).scale(this.jogSpeed)}}if(this.energy>0&&this.actionState!=="idle"?(this.vel.copyFrom(this.jogVel).add(this.joltVel),this.energy-=t):(this.vel.copyFrom(this.jogVel).scaleAndAdd(this.joltVel,.5),this.energyRecovery+=t,this.energyRecovery>=10&&(this.energy=10,this.energyRecovery=0)),this.joltVel.scale(Math.exp(-this.joltDecayRate*t)),this.checkPlayerCollisions(t,e),super.update(t,e),n===null&&(n=this.tryTackle(e)),!o.carried&&o.collidesWith(this)&&n===null){const r=o.lastTouchedType==="kick"&&!o.hasBounced&&o.lastTouchedBy!==this&&o.pos.dist(o.origin)>=15;return o.pickup(this),r?(e.setPiece=new W(e,this,this.pos.c),n="freeKick"):n="pickup",this.team==="home"&&(e.player=this,this.aiming=!1),n}return n||(n=this.vel.len()>1e-4?"run":"idle"),n}collideBounds(){return[.8,1.8]}get stunned(){return this.actionState==="tackle"||this.actionState==="tackled"}tryTackle(t){const e=t.ball;for(const i of t.players){if(i===this||!e.carried||e.carrier!==i||i.team===this.team||!this.collidesWith(i)||i.actionState==="tackleDisposal"||i.actionState==="freeKick")continue;const o=i.pos.c.sub(this.pos);o[1]=0,o.normalize();const n=1e-8,a=this.jogVel.c;if(a[1]=0,a.len()<n||a.c.normalize().dot(o)>.1)return this.stateTimer=1,i.actionState="tackleDisposal",i.stateTimer=.5,"tackle"}return null}updateHuman(t,e){const i=e.controls,o=e.ball;let{kickPressed:n,kickReleased:a,kickHeldTime:r,moveX:h,moveZ:l,aimTarget:d}=i.state;const u=1e-4;let f=null;if((h!==0||l!==0)&&!this.aiming){const c=p(h,0,l).normalize();if(p(h,0,l),c.len()>u){this.joltVel.copyFrom(c).scale(this.joltSpeed);const T=this.jogVel.c.normalize();this.jogVel.len()>u?(T.lerp(c,10*t).normalize(),this.jogVel.copyFrom(T).scale(this.jogSpeed)):this.jogVel.copyFrom(c).scale(this.jogSpeed)}}if(this.energy>0?(this.vel.copyFrom(this.jogVel).add(this.joltVel),this.energy-=t):(this.vel.copyFrom(this.jogVel).scaleAndAdd(this.joltVel,.5),this.energyRecovery+=t,this.energyRecovery>=10&&(this.energy=10,this.energyRecovery=0)),this.joltVel.scale(Math.exp(-this.joltDecayRate*t)),this.checkPlayerCollisions(t,e),super.update(t,e),o.carried&&o.carrier!==this&&n&&(f=this.tryTackle(e)),!o.carried&&o.collidesWith(this)&&f===null){const c=o.lastTouchedType==="kick"&&!o.hasBounced&&o.lastTouchedBy!==this&&o.pos.dist(o.origin)>=15;return o.pickup(this),c?(e.setPiece=new W(e,this,this.pos.c),f="freeKick"):f="pickup",this.team==="home"&&(e.player=this,this.aiming=!1),f}if(o.carried&&o.carrier===this&&f===null){if(n&&(this.aiming=!0,this.jogVel.len()<1e-5)){const c=p(0,0,this.team==="home"?0:w).sub(this.pos).normalize();this.jogVel.copyFrom(c).scale(this.jogSpeed)}f=this.tryDisposeBall(e,{kickReleased:i.state.kickReleased,kickHeldTime:i.state.kickHeldTime,aimTarget:i.state.aimTarget,moveVec:h!==0||l!==0?p(h,0,l):M.fromArray(this.jogVel)}),o.carried||(this.aiming=!1)}return this.updateAim(e),!f&&this.actionState!=="run"&&this.actionState!=="idle"&&(f=this.vel.len()>u?"run":"idle"),f}tryDisposeBall(t,e){const i=t.ball;if(!i.carried||i.carrier!==this)return null;const{kickReleased:o,kickHeldTime:n}=e;let{aimTarget:a}=e;if(!o)return null;const r=n<.25;if(r){const A=e.moveVec??this.jogVel.c;if(A.len()===0){const S=this.team==="home"?-1:1;A.setFrom(0,0,S)}A.normalize;let v=null,P=-1/0;for(const S of t.players){if(S.team!==this.team||S===this||S.stunned)continue;const E=S.pos.c.sub(this.pos),R=E.len();if(R>30)continue;const x=E.c.normalize(),k=A.dot(x);if(k<=0)continue;let C=0;for(const j of t.players){if(j.team===this.team||j===S||j.stunned)continue;j.pos.dist(S.pos)<=10&&C++}const q=.5*C,N=k*2-R/30-q;N>P&&(P=N,v=S)}if(v){const S=v.pos.c.sub(this.pos);a=[S[0],S[2]]}else a=[A[0]*10,A[2]*10]}if(!a)return null;const h=Xt(a[0],a[1]),l=h.len();if(l<.1)return null;const d=-this.gravity[1],u=(r?20:30)*Math.PI/180,f=Math.sin(2*u),c=Math.sqrt(l*d/f),T=p(h[0],0,h[1]).normalize(),m=p(T[0]*Math.cos(u),Math.sin(u),T[2]*Math.cos(u));return i.launch(m,c),i.lastTouchedType=r?"handpass":"kick",i.hasBounced=!1,this.stateTimer=.5,r?"handpass":"kick"}update(t,e){this.oldPos=this.pos.c;let i=!1;if(e.setPiece&&(i=e.setPiece.enforce(this,t)),e.ball.carried||(this.aiming=!1),!this.playing)return;if(this.actionState==="pickup"&&(this.actionState="run"),this.actionState==="freeKick"){this.stateTimer-=t,this.stateTimer<=0?(this.actionState="idle",this.stateTimer=0,this.jogVel[0]=0,this.jogVel[2]=0,e.setPiece):(e.setPiece===null||e.controls.state.moveX!==0||e.controls.state.moveZ!==0)&&(this.actionState="idle",this.stateTimer=0),this.vel.copyFrom(this.jogVel),super.update(t,e),this.updateAim(e),this.updateAnimation(t,null,e.ball);return}if(this.actionState==="standingMark"){this.stateTimer-=t,this.stateTimer<=0?(this.actionState="idle",this.stateTimer=0,this.jogVel[0]=0,this.jogVel[1]=0,e.setPiece):e.setPiece===null&&(this.actionState="idle",this.stateTimer=0),this.updateAim(e),this.updateAnimation(t,null,e.ball);return}if(this.actionState==="tackleDisposal"){if(this.stateTimer-=t,this.pos.scaleAndAdd(this.jogVel,t),e.player===this&&e.controls.state.kickReleased&&(this.tryDisposeBall(e,e.controls.state),this.actionState="handpass",this.stateTimer=.5),e.player!==this){const n=.5-this.stateTimer,a=.5+(this.statsStrength-50)*.01,r=n/a*(.5+(this.statsStrength-50)/100);Math.random()<r*t*2&&this.tryDisposeBall(e,{kickReleased:!0,kickHeldTime:.1,aimTarget:null,moveVec:p(0,0,0)})}if(this.stateTimer<=0){const n=e.ball;n.carried=!1,n.carrier=null,n.pos.copyFrom(this.pos),n.vel.copyFrom(this.vel.len()>.5?this.vel:p(Math.random()*2-1,0,Math.random()*2-1).normalize().scale(this.jogSpeed+this.joltSpeed)),n.lastTouchedType="spill",n.hasBounced=!1,this.actionState="tackled",this.stateTimer=1}this.updateAim(e),this.updateAnimation(t,null,e.ball);return}if(this.actionState==="tackled"||this.actionState==="tackle"||this.actionState==="kick"||this.actionState==="handpass"){this.actionState==="tackled"&&this.vel.scale(.8),this.stateTimer-=t,this.stateTimer<=0&&(this.actionState="idle",this.stateTimer=0),this.aiming&&(this.aiming=!1),super.update(t,e),this.updateAim(e),this.updateAnimation(t,null,e.ball);return}let o=null;i||(e.player===this?o=this.updateHuman(t,e):o=this.updateAI(t,e)),this.updateAnimation(t,o,e.ball),o!==null&&(this.actionState=o)}updateAim(t){if(this===t.player){const i=t.controls.state.aimTarget;if(this.aiming){const o=Nt(0,0);i&&Gt(o,o,i),t.aimTarget.setPosition([this.pos[0]+o[0],.002,this.pos[2]+o[1]])}else t.player===this&&t.aimTarget.setPosition(p(this.pos[0],.002,this.pos[2]+.8))}}updateAnimation(t,e,i){const o=this.animations[this.animState];if(o.length===0)return;this.animTimer+=t;const n=1/this.animFPS;this.animTimer>=n&&(this.animTimer-=n,this.animFrame=this.animFrame+1),e==="kick"&&(this.animState="kickRightFoot",this.animFrame=0,this.animTimer=0),this.animState==="run"&&this.vel.len()===0&&(this.animState="idle",this.animFrame=0,this.animTimer=0),this.animState==="idle"&&this.vel.len()!==0&&(this.animState="run",this.animFrame=0,this.animTimer=0);const a=this.animState==="run"||this.animState==="idle";this.animFrame>=o.length&&(this.animFrame=a?0:o.length-1,a||(this.animState="run",this.animFrame=0,this.animTimer=0));const r=ce.home.back.slice();r[0]+=this.teamId,this.team==="away"&&(r[1]+=2);const h=K[this.complexion].back.slice();h[0]+=this.faceId;const l=le[this.animState][this.animFrame].slice()??[0,0,0];l[1]+=K[this.complexion].bodyRowOffset,(this.vel[2]>0?"away":this.vel[2]<0?"home":this.pos[2]<i.pos[2]?"away":"home")==="away"&&(l[0]+=7,r[1]-=1,h[1]-=1),this.animSprite=[r,h,l]}render(t){const e=p(0,.005,.01);let i=1;for(let[o,n,a]of this.animSprite)t.renderSprite(this.pos.c.scaleAndAdd(e,i),this.width,this.height,o,n),i++}renderOrig(t){const[e,i,o]=this.animSprite;t.renderSprite(this.pos,this.width,this.height,e,i)}checkPlayerCollisions(t,e){if(this.actionState!=="freeKick")for(const i of e.players){if(i===this||!i.playing||i.actionState==="freeKick")continue;const o=this.pos.c.sub(i.pos);o[1]=0;const n=o.len(),a=pt(this),r=pt(i),l=(a+r)/2-n;if(l<=0)continue;n<1e-4?(o[0]=Math.random()-.5,o[2]=Math.random()-.5,o.normalize()):o.scale(1/n);const d=this.statsWeight*yt(this.intent),u=i.statsWeight*yt(i.intent),f=d+u,c=o.c.scale(l),T=c.c.scale(u/f),m=c.c.scale(d/f);this.pos[0]+=T[0],this.pos[2]+=T[2],i.pos[0]-=m[0],i.pos[2]-=m[2]}}setupForBoundary(t,e){t==="behindAway"&&this.team==="home"&&this.name==="FB"?(this.pos.setFrom(0,0,w-5),this.jogVel.setFrom(0,0,0),this.joltVel.setFrom(0,0,0),this.actionState="idle",this.stateTimer=0):t==="behindAway"&&this.team==="away"&&this.name==="FF"?this.pos.setFrom(0,0,w-25):t==="behindHome"&&this.team==="away"&&this.name==="FB"?(this.pos.setFrom(0,0,5),this.jogVel.setFrom(0,0,0),this.joltVel.setFrom(0,0,0),this.actionState="idle",this.stateTimer=0):t==="behindHome"&&this.team==="home"&&this.name==="FF"?this.pos.setFrom(0,0,25):this.pos.copyFrom(this.positionPos)}}class fe extends st{constructor(t){super(t),this.carried=!1,this.origin=p(0,0,0),this.carrier=null,this.width=1.6,this.height=2.4,this.bounce=.5,this.animations=Object.freeze({idle:[[0,1,0]],backSpin:[[1,1,0],[2,1,0],[3,1,0],[4,1,0],[5,1,0],[6,1,0],[7,1,0],[8,1,0]],forwardSpin:[[8,1,0],[7,1,0],[6,1,0],[5,1,0],[4,1,0],[3,1,0],[2,1,0],[1,1,0]],backSpinRight:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]],backSpinLeft:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinRight:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinLeft:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]]}),this.animState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=12,this.lastTouchedBy=null,this.lastTouchedType=null,this.hasBounced=!1}update(t,e){if(this.carried&&this.carrier){const i=this.carrier,o=i.vel[2]>0?1:i.vel[2]<0||i.team==="home"?-1:1,n=p(0,.5,.2*o);this.pos.copyFrom(this.carrier.pos).add(n),this.origin.copyFrom(this.pos)}else{const i=this.vel[1]<0;super.update(t,e),this.hasBounced=this.hasBounced||i&&this.vel[1]>0&&this.pos[1]<=this.floorY,this.pos[1]<=this.floorY&&(this.vel.scale(.97),this.origin.copyFrom(this.pos))}this.updateAnimation(t)}collideBounds(){return[.4,.5]}pickup(t){this.carried=!0,this.carrier=t,this.lastTouchedBy=t,this.lastTouchedType=null,this.hasBounced=!1,this.origin.copyFrom(this.pos);const e=t.vel[2]>0?1:t.vel[2]<0||t.team==="home"?-1:1;this.pos.copyFrom(t.pos).add(p(0,0,e*.2)),this.vel.setFrom(0,0,0)}launch(t,e,i="kick"){this.carried=!1,this.carrier=null,this.vel.copyFrom(t).scale(e),this.lastTouchedType=i,this.hasBounced=!1}updateAnimation(t){this.animTimer+=t;const e=1/this.animFPS;this.animTimer>=e&&(this.animTimer-=e,this.animFrame=this.animFrame+1);const i=this.animState;this.carried?this.animState="idle":this.lastTouchedType==="kick"&&!this.hasBounced?this.animState=this.vel[2]<0?"backSpin":"forwardSpin":this.lastTouchedType==="handpass"&&!this.hasBounced?this.animState=this.vel[2]<0?"backSpinRight":"forwardSpinLeft":this.hasBounced?Math.abs(this.vel[1])<.05&&this.pos[1]<=this.floorY+.01?this.animState="idle":this.animState=this.vel[2]<0?"forwardSpin":"backSpin":this.animState="idle",this.animState!==i&&(this.animFrame=0,this.animTimer=0);const o=this.animations[this.animState];o.length!==0&&this.animFrame>=o.length&&(this.animFrame=0)}render(t){var a;const e=(a=this.animations)==null?void 0:a[this.animState],[i,o,n]=(e==null?void 0:e[this.animFrame])??[0,1,void 0];t.renderSprite(this.pos,this.width,this.height,i,o);{const r=t.gl;r.useProgram(t.program),r.bindVertexArray(t.quadVao);const[h,l]=[2,3];t.setTileUV(h,l),r.uniform1i(t.uTiling,0);const d=_();H(d,d,[this.pos[0],.001,this.pos[2]]),bt(d,d,-Math.PI/2),X(d,d,[2,2,1]),r.uniformMatrix4fv(t.uModel,!1,d),r.drawElements(r.TRIANGLES,6,r.UNSIGNED_SHORT,0)}}setupForBoundary(t,e){if(this.carried=!1,this.carrier=null,t==="goalAway"||t==="goalHome")this.pos.setFrom(0,0,w/2),this.vel.setFrom(0,15,0),this.lastTouchedType="tap",this.lastTouchedBy=null,this.origin.copyFrom(this.pos);else if(t==="behindAway")this.pos.setFrom(0,0,w-6);else if(t==="behindHome")this.pos.setFrom(0,0,6);else{this.pos.copyFrom(e),this.pos.y=0;const i=p(0,w/2,w/2).toDir(this.pos);this.launch(i,15,"tap")}}}class ue{constructor(t=[0,.001,0]){this.pos=M.fromArray(t),this.size=2,this.spriteCoord=[0,3]}setPosition(t){this.pos[0]=t[0],this.pos[2]=t[2]}render(t){const e=t.gl;e.useProgram(t.program),e.bindVertexArray(t.quadVao);const[i,o]=this.spriteCoord;t.setTileUV(i,o),e.uniform1i(t.uTiling,0);const n=_();H(n,n,[this.pos[0],.002,this.pos[2]]),bt(n,n,-Math.PI/2),X(n,n,[this.size,this.size,1]),e.uniformMatrix4fv(t.uModel,!1,n),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0)}}function Ft(s,t,e){const i=(r,h)=>{const l=s.createShader(h);if(!l)throw new Error("Failed to create shader");if(s.shaderSource(l,r),s.compileShader(l),!s.getShaderParameter(l,s.COMPILE_STATUS))throw new Error(s.getShaderInfoLog(l));return l},o=i(t,s.VERTEX_SHADER),n=i(e,s.FRAGMENT_SHADER),a=s.createProgram();if(s.attachShader(a,o),s.attachShader(a,n),s.linkProgram(a),!s.getProgramParameter(a,s.LINK_STATUS))throw new Error(s.getProgramInfoLog(a));return a}async function me(s){const t=new Image;return t.src=s,await t.decode(),t}function pe(s,t,e,i=1){const a=s*2/1.6/i,r=t*2/2/i,h=[0,0,0,.5,.5],l=[];for(let d=0;d<=e;d++){const u=d/e*2*Math.PI,f=Math.cos(u)*s,c=Math.sin(u)*t,T=f/(s*2)*a+.5,m=c/(t*2)*r+.5;h.push(f,0,c,T,m),d>0&&l.push(0,d,d+1)}return{vertices:new Float32Array(h),indices:new Uint16Array(l)}}function ye(s=160,t=170,e=50,i=50,o=.4){const n=[],a=[];let r=0;const h=(m,y,F,A,v)=>{const P=F-m,S=A-y,E=Math.hypot(P,S),R=-S/E,x=P/E,k=v/2,C=m+R*k,q=y+x*k,N=m-R*k,j=y-x*k,it=F+R*k,Bt=A+x*k,Dt=F-R*k,It=A-x*k;n.push(C,0,q,it,0,Bt,Dt,0,It,N,0,j),a.push(r,r+1,r+2,r,r+2,r+3),r+=4},l=s/2,d=t/2,u=64;for(let m=0;m<u;m++){const y=m/u*2*Math.PI,F=(m+1)/u*2*Math.PI,A=Math.cos(y)*l,v=Math.sin(y)*d,P=Math.cos(F)*l,S=Math.sin(F)*d;h(A,v,P,S,o)}const f=[[-i/2,-i/2],[i/2,-i/2],[i/2,i/2],[-i/2,i/2]];for(let m=0;m<4;m++){const[y,F]=f[m],[A,v]=f[(m+1)%4];h(y,F,A,v,o)}function c(m){const y=m>0?-1:1,F=[];for(let A=0;A<=1e3;A++){const v=-Math.PI+A/1e3*2*Math.PI,P=Math.sin(v)*e,S=m+y*Math.cos(v)*e,E=P/l,R=S/d;E*E+R*R<=1&&F.push(v)}return F.length===0?[-Math.PI/3,Math.PI/3]:[F[0],F[F.length-1]]}const T=40;for(let m of[-t/2,t/2]){const y=m>0?-1:1,[F,A]=c(m);for(let v=0;v<T;v++){const P=F+v/T*(A-F),S=F+(v+1)/T*(A-F),E=Math.sin(P)*e,R=m+y*Math.cos(P)*e,x=Math.sin(S)*e,k=m+y*Math.cos(S)*e;h(E,R,x,k,o)}}return{vertices:new Float32Array(n),indices:new Uint16Array(a)}}const Te=`#version 300 es
    in vec3 a_position;
    in vec2 a_texcoord;
    uniform mat4 u_projection, u_view, u_model;
    out vec2 v_texcoord;
    void main() {
        gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
        v_texcoord = a_texcoord;
    }
`,Fe=`#version 300 es
    precision mediump float;

    uniform sampler2D u_texture;
    uniform vec4 u_tileUV;
    uniform bool u_tiling;

    in vec2 v_texcoord;
    out vec4 outColor;

    void main() {
        vec2 texCoord;
        if (u_tiling) {
            vec2 tileUV = mod(v_texcoord, 1.0);
            texCoord = mix(u_tileUV.xy, u_tileUV.zw, tileUV);
        } else {
            texCoord = mix(u_tileUV.xy, u_tileUV.zw, v_texcoord);
        }
        vec2 texelSize = 1.0 / vec2(textureSize(u_texture, 0));
        vec2 epsilon = 0.5 * texelSize;
        texCoord = clamp(texCoord, u_tileUV.xy + epsilon, u_tileUV.zw - epsilon);
        vec4 texColor = texture(u_texture, texCoord);

        if (texColor.a < 0.01) discard; // Skip fully transparent fragments

        outColor = texColor;
    }
`,Ae=`#version 300 es
    in vec3 a_position;
    uniform mat4 u_projection;
    uniform mat4 u_view;
    uniform mat4 u_model;
    void main() {
    gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
    }`,Se=`#version 300 es
    precision mediump float;
    out vec4 outColor;
    void main() {
    outColor = vec4(1, 1, 1, 1);
    }
`,kt=16,xt=24,At=512,St=768,J=0,tt=0,vt=kt+J,Pt=xt+tt,U=170,ve=80,wt=U/2;class Pe{constructor(t,e,i){this.gl=t,this.canvas=e,this.spriteSheet=i,this.sheetCols=32,this.sheetRows=32,this.program=Ft(t,Te,Fe),this.uProjection=t.getUniformLocation(this.program,"u_projection"),this.uView=t.getUniformLocation(this.program,"u_view"),this.uModel=t.getUniformLocation(this.program,"u_model"),this.uTileUV=t.getUniformLocation(this.program,"u_tileUV"),this.uTiling=t.getUniformLocation(this.program,"u_tiling"),this.uTexture=t.getUniformLocation(this.program,"u_texture"),this.aPos=t.getAttribLocation(this.program,"a_position"),this.aUV=t.getAttribLocation(this.program,"a_texcoord"),this.lineProgram=Ft(t,Ae,Se),this.lineProj=t.getUniformLocation(this.lineProgram,"u_projection"),this.lineView=t.getUniformLocation(this.lineProgram,"u_view"),this.lineModel=t.getUniformLocation(this.lineProgram,"u_model"),this.linePos=t.getAttribLocation(this.lineProgram,"a_position"),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.depthMask(!0);const o=new Float32Array([-.5,0,0,1,.5,0,1,1,.5,1,1,0,-.5,1,0,0]),n=new Uint16Array([0,1,2,0,2,3]);this.quadVao=t.createVertexArray(),t.bindVertexArray(this.quadVao);const a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,o,t.STATIC_DRAW),t.vertexAttribPointer(this.aPos,2,t.FLOAT,!1,16,0),t.enableVertexAttribArray(this.aPos),t.vertexAttribPointer(this.aUV,2,t.FLOAT,!1,16,8),t.enableVertexAttribArray(this.aUV);const r=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,r),t.bufferData(t.ELEMENT_ARRAY_BUFFER,n,t.STATIC_DRAW);const{vertices:h,indices:l}=pe(ve,wt,64,16);this.fieldVao=t.createVertexArray(),t.bindVertexArray(this.fieldVao);const d=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,d),t.bufferData(t.ARRAY_BUFFER,h,t.STATIC_DRAW),t.vertexAttribPointer(this.aPos,3,t.FLOAT,!1,20,0),t.enableVertexAttribArray(this.aPos),t.vertexAttribPointer(this.aUV,2,t.FLOAT,!1,20,12),t.enableVertexAttribArray(this.aUV);const u=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,u),t.bufferData(t.ELEMENT_ARRAY_BUFFER,l,t.STATIC_DRAW),this.fieldIndices=l.length,this.fieldLineMesh=ye(),this.lineVao=t.createVertexArray(),t.bindVertexArray(this.lineVao);const f=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,f),t.bufferData(t.ARRAY_BUFFER,this.fieldLineMesh.vertices,t.STATIC_DRAW);const c=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,c),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.fieldLineMesh.indices,t.STATIC_DRAW),t.vertexAttribPointer(this.linePos,3,t.FLOAT,!1,12,0),t.enableVertexAttribArray(this.linePos),this.goalPostPositions=[[-9,0,U],[-3,0,U],[3,0,U],[9,0,U],[-9,0,0],[-3,0,0],[3,0,0],[9,0,0]],t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.spriteSheet),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.texture),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),this.projection=_(),this.view=_(),this.model=_(),this.updateProjection()}updateProjection(){this.projection=_(),zt(this.projection,Math.PI/4,this.canvas.width/this.canvas.height,.1,1e3)}renderSprite(t,e,i,o,n){const{gl:a,program:r,quadVao:h,uModel:l,uTileUV:d,sheetCols:u,sheetRows:f}=this;a.useProgram(r),a.bindVertexArray(h);const c=_();H(c,c,t),X(c,c,[e,i,1]),a.uniformMatrix4fv(l,!1,c),this.setTileUV(o,n),a.uniform1i(this.uTiling,0),a.drawElements(a.TRIANGLES,6,a.UNSIGNED_SHORT,0)}setTileUV(t,e){const i=(t*vt+J/2)/At,o=(e*Pt+tt/2)/St,n=(t*vt+J/2+kt)/At,a=(e*Pt+tt/2+xt)/St;this.gl.uniform4f(this.uTileUV,i,o,n,a)}renderScene(t,e){const i=this.gl;i.viewport(0,0,this.canvas.width,this.canvas.height),i.clearColor(.2,.6,.2,1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);const o=rt(0,10,15),n=$();at(n,t.cameraTarget,o);const a=rt(0,0,-20),r=$();at(r,t.cameraTarget,a),Ut(this.view,n,r,[0,1,0]),i.useProgram(this.program),i.uniformMatrix4fv(this.uProjection,!1,this.projection),i.uniformMatrix4fv(this.uView,!1,this.view),i.activeTexture(i.TEXTURE0),i.uniform1i(this.uTexture,0),i.bindVertexArray(this.fieldVao),Rt(this.model),H(this.model,this.model,[0,0,wt]),i.uniformMatrix4fv(this.uModel,!1,this.model),this.setTileUV(0,2),i.uniform1i(this.uTiling,1),i.drawElements(i.TRIANGLES,this.fieldIndices,i.UNSIGNED_SHORT,0),i.useProgram(this.lineProgram),i.uniformMatrix4fv(this.lineProj,!1,this.projection),i.uniformMatrix4fv(this.lineView,!1,this.view);const d=_();H(d,this.model,[0,.001,0]),i.uniformMatrix4fv(this.lineModel,!1,d),i.bindVertexArray(this.lineVao),i.drawElements(i.TRIANGLES,this.fieldLineMesh.indices.length,i.UNSIGNED_SHORT,0),i.useProgram(this.program),i.bindVertexArray(this.quadVao),this.setTileUV(1,2),i.uniform1i(this.uTiling,1);for(let c=0;c<this.goalPostPositions.length;c++){const[T,m,y]=this.goalPostPositions[c],A=c%4===0||c%4===3?6:10,v=n[0]-T,P=n[2]-y,S=Math.sqrt(v*v+P*P),E=S>50?1.5:S>150?2:1,R=_();H(R,R,[T,m,y]),X(R,R,[E,A,1]),i.uniformMatrix4fv(this.uModel,!1,R),i.drawElements(i.TRIANGLES,6,i.UNSIGNED_SHORT,0)}i.bindVertexArray(this.quadVao);for(const c of e)c instanceof st&&c.render(this);t.aimTarget.render(this)}}var V,gt,Mt,_t;class we{constructor(t){nt(this,V);this.state={moveX:0,moveZ:0,kickPressed:!1,kickReleased:!1,kickHeldTime:0,aimTarget:null},this.keys={},this.lastKeys={},this.touchMove=null,this.touchAim=null,this.gamepadAimActive=!1,this.kPressTime=0,t.addEventListener("touchstart",G(this,V,gt).bind(this),{passive:!1}),t.addEventListener("touchmove",G(this,V,Mt).bind(this),{passive:!1}),t.addEventListener("touchend",G(this,V,_t).bind(this)),window.addEventListener("keydown",e=>this.keys[e.key.toLowerCase()]=!0),window.addEventListener("keyup",e=>this.keys[e.key.toLowerCase()]=!1)}endUpdate(){this.state.moveX=0,this.state.moveZ=0,this.state.kickPressed=!1,this.state.kickReleased=!1}update(t){var n;const e=!!this.keys.k,i=!!this.lastKeys.k;if(e&&!i&&(this.state.kickPressed=!0,this.kPressTime=0,this.state.aimTarget=[0,-10]),e?(this.kPressTime+=t,this.state.aimTarget&&(this.keys.a&&(this.state.aimTarget[0]-=30*t),this.keys.d&&(this.state.aimTarget[0]+=30*t),this.keys.w&&(this.state.aimTarget[1]-=30*t),this.keys.s&&(this.state.aimTarget[1]+=30*t))):(this.keys.a&&(this.state.moveX-=1),this.keys.d&&(this.state.moveX+=1),this.keys.w&&(this.state.moveZ-=1),this.keys.s&&(this.state.moveZ+=1)),!e&&i&&(this.state.kickReleased=!0),this.state.kickHeldTime=this.kPressTime,this.touchMove&&!this.touchAim&&(this.state.moveX=this.touchMove.dx/50,this.state.moveZ=this.touchMove.dy/50),this.touchAim){this.kPressTime+=t;const a=this.touchAim.dx,r=this.touchAim.dy,h=10;this.state.aimTarget=[-a/h,-r/h],this.state.kickHeldTime=this.kPressTime}const o=(n=navigator.getGamepads)==null?void 0:n.call(navigator)[0];if(o){this.state.moveX+=Math.abs(o.axes[0])>.1?o.axes[0]:0,this.state.moveZ+=Math.abs(o.axes[1])>.1?o.axes[1]:0;const a=o.axes[2]||0,r=o.axes[3]||0,h=Math.hypot(a,r);this.gamepadAimActive?(this.kPressTime+=t,this.state.kickHeldTime+=this.kPressTime,r>.025?this.state.aimTarget&&(this.state.aimTarget=[this.state.aimTarget[0]-a/h,this.state.aimTarget[1]-r/h]):(this.state.kickReleased=!0,this.gamepadAimActive=!1)):r>.025&&(this.state.aimTarget=[0,-10],this.state.kickHeldTime=this.kPressTime,this.state.kickPressed=!0,this.gamepadAimActive=!0)}this.lastKeys={...this.keys}}getState(){return this.state}}V=new WeakSet,gt=function(t){t.preventDefault();for(const e of t.changedTouches)e.clientX<window.innerWidth/2?this.touchMove={id:e.identifier,startX:e.clientX,startY:e.clientY,dx:0,dy:0}:(this.touchAim={id:e.identifier,startX:e.clientX,startY:e.clientY,dx:0,dy:0},this.state.kickPressed=!0,this.kPressTime=0)},Mt=function(t){t.preventDefault();for(const e of t.changedTouches)this.touchMove&&e.identifier===this.touchMove.id&&(this.touchMove.dx=e.clientX-this.touchMove.startX,this.touchMove.dy=e.clientY-this.touchMove.startY),this.touchAim&&e.identifier===this.touchAim.id&&(this.touchAim.dx=e.clientX-this.touchAim.startX,this.touchAim.dy=e.clientY-this.touchAim.startY)},_t=function(t){t.preventDefault();for(const e of t.changedTouches)this.touchAim&&e.identifier===this.touchAim.id&&(this.touchAim=null,this.state.kickReleased=!0),this.touchMove&&e.identifier===this.touchMove.id&&(this.touchMove=null)};class Re{constructor(t,e,i){if(this.glCanvas=t,this.uiCanvas=e,this.gl=t.getContext("webgl2"),!this.gl)throw new Error("WebGL2 not supported");this.currentContest=null,this.renderer=new Pe(this.gl,t,i),this.controls=new we(t),this.setPiece=null,this.entities=[],this.aimTarget=new ue([5,.001,w/2]),this.ball=new fe(p(0,0,w/2)),this.entities.push(this.ball),this.players=[],this.chasers=0,this.followers=0,this.homePositions=lt(),this.awayPositions=lt(!0),oe("mulberry32"),re(ae(`DATE ${Date.now()}`));for(let r=0;r<1e3;++r)z(20);const o=z(18);let n=z(18);for(;o===n;)n=z(18);console.log("teams",o,n);const a=[[this.homePositions,"home",o],[this.awayPositions,"away",n]];for(let[r,h,l]of a)for(const[d,u]of Object.entries(r)){const f=new de(d,h,l,u,!d.toLowerCase().startsWith("bench"));this.entities.push(f),this.players.push(f),d==="RR"&&h==="home"&&(this.player=f)}this.closestPlayers={home:null,away:null},this.cameraTarget=p(0,10,w/2),this.cameraPos=p(0,10,w/2+15),this.resize(),window.addEventListener("resize",()=>this.resize()),this.lastTime=performance.now()}start(){this.lastTime=performance.now(),requestAnimationFrame(this.loop.bind(this))}loop(t){var n,a;const e=(t-this.lastTime)/1e3,i=Math.min(e,1/30);this.lastTime=t,this.updateClosestPlayers(),this.controls.update(i),this.chasers=0,this.followers=0;const o=this.ball.pos.c;for(const r of this.entities)r.update(i,this);if(this.setPiece&&(this.setPiece.update(i),this.setPiece.finished&&(this.setPiece=null)),!this.setPiece){let r=Qt(o,this.ball.pos);if(r!==null){if(r==="goalAway"&&(this.ball.lastTouchedType!=="kick"||((n=this.ball.lastTouchedBy)==null?void 0:n.team)==="home")?r="behindAway":r==="goalHome"&&(this.ball.lastTouchedType!=="kick"||((a=this.ball.lastTouchedBy)==null?void 0:a.team)==="away")?r="behindHome":r==="innerLeftPostAway"||r==="innerRightPostAway"?r="behindAway":(r==="innerLeftPostHome"||r==="innerRightPostHome")&&(r="behindHome"),r==="behindAway"){const h=this.players.find(l=>l.name==="FB"&&l.team==="home");h&&(this.setPiece=new W(this,h,p(0,0,w-10)))}if(r==="behindHome"){const h=this.players.find(l=>l.name==="FB"&&l.team==="away");h&&(this.setPiece=new W(this,h,p(0,0,10)))}if(r==="goalAway"||r==="goalHome"||r==="outOfBounds")for(const h of this.entities)h.setupForBoundary(r,this.ball.pos)}}this.updateCameraTarget(),this.updatePlayerControl(),this.renderer.renderScene(this,this.entities),this.controls.endUpdate(),requestAnimationFrame(this.loop.bind(this))}updateClosestPlayers(){const t=this.ball,e={home:1/0,away:1/0},i={home:null,away:null};for(let o of this.players){const n=o.pos.dist(t.pos);n<e[o.team]&&(e[o.team]=n,i[o.team]=o)}this.closestPlayers=i}updatePlayerControl(){const t=this.players.filter(n=>n.team==="home"),e=this.ball.carrier;if(!e||e&&e.team==="home")return;let i=null,o=1/0;for(const n of t){if(n.actionState==="tackle")continue;const a=Ot(n.pos,e.pos),r=(Math.abs(n.positionPos[0]-this.ball.pos[0])<10?-10:0)+(n.energy<.3?-5:0)+(n.pos[2]>e.pos[2]?-10:0);a+r<o&&(i=n,o=a+r)}i&&i!==this.player&&(this.player=i,this.player.aiming=!1)}updateCameraTarget(){const t=this.ball,e=t.carrier,i=e?(e.team==="home",e.pos.c):t.pos.c;let o=e&&e.team==="home"?0:Math.max(40-i[2],15),n=-.2*i[0];i.add([n,0,o]);const a=this.cameraTarget.dist(i),r=Math.max(1/(1+3*a),.05);this.cameraTarget.lerp(i,r)}resize(){this.glCanvas.width=window.innerWidth,this.glCanvas.height=window.innerHeight,this.renderer.updateProjection()}}const be="/footy/assets/spritesheet-CSRnYgIO.png";function Ee(s){const t=document.getElementById("uicanvas");if(!t)throw console.error("UI Canvas element not found"),new Error("UI Canvas element not found");const e=document.getElementById("glcanvas");if(!e)throw console.error("WebGL2 Canvas element not found"),new Error("WebGL2 Canvas element not found");new Re(e,t,s).start()}me(be).then(s=>{if(!s.complete)throw console.error("Failed to load sprite sheet"),new Error("Sprite sheet not loaded");Ee(s)});
