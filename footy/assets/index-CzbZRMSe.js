var dt=s=>{throw TypeError(s)};var Ft=(s,t,e)=>t.has(s)||dt("Cannot "+e);var mt=(s,t,e)=>t.has(s)?dt("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(s):t.set(s,e);var et=(s,t,e)=>(Ft(s,t,"access private method"),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(o){if(o.ep)return;o.ep=!0;const a=e(o);fetch(o.href,a)}})();var ct=1e-6,C=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var s=0,t=arguments.length;t--;)s+=arguments[t]*arguments[t];return Math.sqrt(s)});function N(){var s=new C(16);return C!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=0,s[12]=0,s[13]=0,s[14]=0),s[0]=1,s[5]=1,s[10]=1,s[15]=1,s}function St(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function Q(s,t,e){var i=e[0],o=e[1],a=e[2],r,n,h,c,d,f,m,l,p,u,g,T;return t===s?(s[12]=t[0]*i+t[4]*o+t[8]*a+t[12],s[13]=t[1]*i+t[5]*o+t[9]*a+t[13],s[14]=t[2]*i+t[6]*o+t[10]*a+t[14],s[15]=t[3]*i+t[7]*o+t[11]*a+t[15]):(r=t[0],n=t[1],h=t[2],c=t[3],d=t[4],f=t[5],m=t[6],l=t[7],p=t[8],u=t[9],g=t[10],T=t[11],s[0]=r,s[1]=n,s[2]=h,s[3]=c,s[4]=d,s[5]=f,s[6]=m,s[7]=l,s[8]=p,s[9]=u,s[10]=g,s[11]=T,s[12]=r*i+d*o+p*a+t[12],s[13]=n*i+f*o+u*a+t[13],s[14]=h*i+m*o+g*a+t[14],s[15]=c*i+l*o+T*a+t[15]),s}function nt(s,t,e){var i=e[0],o=e[1],a=e[2];return s[0]=t[0]*i,s[1]=t[1]*i,s[2]=t[2]*i,s[3]=t[3]*i,s[4]=t[4]*o,s[5]=t[5]*o,s[6]=t[6]*o,s[7]=t[7]*o,s[8]=t[8]*a,s[9]=t[9]*a,s[10]=t[10]*a,s[11]=t[11]*a,s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15],s}function kt(s,t,e){var i=Math.sin(e),o=Math.cos(e),a=t[4],r=t[5],n=t[6],h=t[7],c=t[8],d=t[9],f=t[10],m=t[11];return t!==s&&(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s[4]=a*o+c*i,s[5]=r*o+d*i,s[6]=n*o+f*i,s[7]=h*o+m*i,s[8]=c*o-a*i,s[9]=d*o-r*i,s[10]=f*o-n*i,s[11]=m*o-h*i,s}function xt(s,t,e,i,o){var a=1/Math.tan(t/2),r;return s[0]=a/e,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=a,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=-1,s[12]=0,s[13]=0,s[15]=0,o!=null&&o!==1/0?(r=1/(i-o),s[10]=(o+i)*r,s[14]=2*o*i*r):(s[10]=-1,s[14]=-2*i),s}var Lt=xt;function Vt(s,t,e,i){var o,a,r,n,h,c,d,f,m,l,p=t[0],u=t[1],g=t[2],T=i[0],y=i[1],S=i[2],w=e[0],v=e[1],_=e[2];return Math.abs(p-w)<ct&&Math.abs(u-v)<ct&&Math.abs(g-_)<ct?St(s):(d=p-w,f=u-v,m=g-_,l=1/Math.hypot(d,f,m),d*=l,f*=l,m*=l,o=y*m-S*f,a=S*d-T*m,r=T*f-y*d,l=Math.hypot(o,a,r),l?(l=1/l,o*=l,a*=l,r*=l):(o=0,a=0,r=0),n=f*r-m*a,h=m*o-d*r,c=d*a-f*o,l=Math.hypot(n,h,c),l?(l=1/l,n*=l,h*=l,c*=l):(n=0,h=0,c=0),s[0]=o,s[1]=n,s[2]=d,s[3]=0,s[4]=a,s[5]=h,s[6]=f,s[7]=0,s[8]=r,s[9]=c,s[10]=m,s[11]=0,s[12]=-(o*p+a*u+r*g),s[13]=-(n*p+h*u+c*g),s[14]=-(d*p+f*u+m*g),s[15]=1,s)}function P(){var s=new C(3);return C!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function E(s){var t=new C(3);return t[0]=s[0],t[1]=s[1],t[2]=s[2],t}function H(s){var t=s[0],e=s[1],i=s[2];return Math.hypot(t,e,i)}function k(s,t,e){var i=new C(3);return i[0]=s,i[1]=t,i[2]=e,i}function A(s,t){return s[0]=t[0],s[1]=t[1],s[2]=t[2],s}function x(s,t,e,i){return s[0]=t,s[1]=e,s[2]=i,s}function z(s,t,e){return s[0]=t[0]+e[0],s[1]=t[1]+e[1],s[2]=t[2]+e[2],s}function J(s,t,e){return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s[2]=t[2]-e[2],s}function V(s,t,e){return s[0]=t[0]*e,s[1]=t[1]*e,s[2]=t[2]*e,s}function I(s,t,e,i){return s[0]=t[0]+e[0]*i,s[1]=t[1]+e[1]*i,s[2]=t[2]+e[2]*i,s}function Z(s,t){var e=t[0]-s[0],i=t[1]-s[1],o=t[2]-s[2];return Math.hypot(e,i,o)}function Bt(s,t){var e=t[0]-s[0],i=t[1]-s[1],o=t[2]-s[2];return e*e+i*i+o*o}function At(s){var t=s[0],e=s[1],i=s[2];return t*t+e*e+i*i}function R(s,t){var e=t[0],i=t[1],o=t[2],a=e*e+i*i+o*o;return a>0&&(a=1/Math.sqrt(a)),s[0]=t[0]*a,s[1]=t[1]*a,s[2]=t[2]*a,s}function W(s,t){return s[0]*t[0]+s[1]*t[1]+s[2]*t[2]}function at(s,t,e,i){var o=t[0],a=t[1],r=t[2];return s[0]=o+i*(e[0]-o),s[1]=a+i*(e[1]-a),s[2]=r+i*(e[2]-r),s}var U=J,D=Z,Dt=At;(function(){var s=P();return function(t,e,i,o,a,r){var n,h;for(e||(e=3),i||(i=0),o?h=Math.min(o*e+i,t.length):h=t.length,n=i;n<h;n+=e)s[0]=t[n],s[1]=t[n+1],s[2]=t[n+2],a(s,s,r),t[n]=s[0],t[n+1]=s[1],t[n+2]=s[2];return t}})();function It(){var s=new C(2);return C!=Float32Array&&(s[0]=0,s[1]=0),s}function it(s,t){var e=new C(2);return e[0]=s,e[1]=t,e}function ot(s,t,e){return s[0]=t[0]+e[0],s[1]=t[1]+e[1],s}function Rt(s){var t=s[0],e=s[1];return Math.hypot(t,e)}var ut=Rt;(function(){var s=It();return function(t,e,i,o,a,r){var n,h;for(e||(e=2),i||(i=0),o?h=Math.min(o*e+i,t.length):h=t.length,n=i;n<h;n+=e)s[0]=t[n],s[1]=t[n+1],a(s,s,r),t[n]=s[0],t[n+1]=s[1];return t}})();const Ht=160,b=170,lt=Ht/2,j=b/2,G=6,rt=6,pt=.5;function M(s,t,e){return k(s,t,e)}const jt=Object.freeze([M(-.5*G-rt,0,b),M(-.5*G,0,b),M(.5*G,0,b),M(.5*G+rt,0,b)]),Ut=Object.freeze([M(-.5*G-rt,0,0),M(-.5*G,0,0),M(.5*G,0,0),M(.5*G+rt,0,0)]),Ot=Object.freeze({Away:jt,Home:Ut});function gt(s){const t=s[0]/lt,e=(s[2]-j)/j;return t*t+e*e>1}function Ct(s,t,e,i,o,a){const r=o-e,n=a-i;if(r===0&&n===0){const p=s-e,u=t-i;return p*p+u*u}const h=((s-e)*r+(t-i)*n)/(r*r+n*n),c=Math.max(0,Math.min(1,h)),d=e+c*r,f=i+c*n,m=s-d,l=t-f;return m*m+l*l}function Nt(s,t){const e=gt(s),i=gt(t);for(const o of["Away","Home"]){const a=Ot[o];if(i&&!e){if(o==="Away"){if(s[2]>b-10){const n=t[0];if(n>=-3&&n<=3)return"goalAway";if(n>=-9&&n<-3||n>3&&n<=9)return"behindAway"}}else if(o==="Home"&&s[2]<10){const n=t[0];if(n>=-3&&n<=3)return"goalHome";if(n>=-9&&n<-3||n>3&&n<=9)return"behindHome"}}const r=["outerLeftPost","innerLeftPost","innerRightPost","outerRightPost"];for(let n=0;n<a.length;n++){const h=a[n][0],c=a[n][2];if(Ct(h,c,s[0],s[2],t[0],t[2])<pt*pt)return`${r[n]}${o}`}}return!e&&i?"outOfBounds":null}function Tt(s=!1){const e={fullForward:70,halfForward:35,halfBack:-35,fullBack:-70},i={LFP:-45,FF:0,RFP:45,LHF:-50,CHF:0,RHF:50,LHB:-50,CHB:0,RHB:50,LBP:-45,FB:0,RBP:45};function o(h,c){const d=h*Math.PI/180,f=lt*Math.sin(d)*(Math.abs(c)/j)-(s?2:-2),m=j+c*(s?-1:1);return M(f,0,m)}const a=-lt-4,r=h=>j+(s?1:-1)*h;return{LFP:o(i.LFP,e.fullForward-(s?10:-10)),FF:o(i.FF,e.fullForward),RFP:o(i.RFP,e.fullForward-(s?10:-10)),LHF:o(i.LHF,e.halfForward),CHF:o(i.CHF,e.halfForward),RHF:o(i.RHF,e.halfForward),LW:M(-25,0,j-(s?2:-2)),C:M(8,0,j-(s?-5:5)),RW:M(25,0,j-(s?2:-2)),LHB:o(i.LHB,e.halfBack),CHB:o(i.CHB,e.halfBack),RHB:o(i.RHB,e.halfBack),LBP:o(i.LBP,e.fullBack-(s?10:-10)),FB:o(i.FB,e.fullBack),RBP:o(i.RBP,e.fullBack-(s?10:-10)),Ruck:M(0,0,j-(s?10:-10)),RR:M(-10,0,j-(s?10:-10)),Rover:M(10,0,j-(s?10:-10)),Bench1:M(a,0,r(10)),Bench2:M(a,0,r(13)),Bench3:M(a,0,r(16)),Bench4:M(a,0,r(19)),Bench5:M(a,0,r(22))}}function zt(s,t,e){let i=null,o=1/0;for(const a of t)if(a.team!==s.team){const r=Z(a.pos,e);r<o&&(o=r,i=a)}return i}class Gt{constructor(t,e,i){this.game=t,this.kicker=e,this.markPos=E(i),this.timer=0,this.finished=!1}update(t){this.timer+=t}enforce(t,e){return!1}cleanup(){}}class ht extends Gt{constructor(t,e,i){super(t,e,i),this.defender=null,this.zone={center:P(),radius:1},this.game=t,this.setup()}setup(){const{game:t,kicker:e,markPos:i}=this,o=e.team==="home"?0:b,a=k(0,0,o),r=U(P(),i,a);r[1]=0,R(r,r);const n=12,h=10,c=E(i),d=I(P(),i,r,h);A(e.pos,d),A(e.vel,[0,0,0]),A(e.jogVel,[0,0,0]),A(e.joltVel,[0,0,0]),t.ball.carrier!==e&&t.ball.pickup(e),e.team==="home"&&(this.game.player=e),e.actionState="mark",e.stateTimer=1,this.defender=zt(e,t.players,i),this.defender&&(A(this.defender.pos,c),A(this.defender.vel,[0,0,0]),A(this.defender.jogVel,[0,0,0]),A(this.defender.joltVel,[0,0,0]),this.defender.actionState="mark",this.defender.stateTimer=10);for(const f of t.players){if(f===e||f===this.defender)continue;if(Z(f.pos,i)<n+1){const l=U(P(),f.pos,i);R(l,l),I(f.pos,i,l,n+1.5+Math.random()*2)}}}update(t){super.update(t);const{kicker:e,markPos:i,game:o}=this,a=!o.ball.carried,r=U(P(),e.pos,i);r[1]=0;const n=e.team==="home"?0:b,h=U(P(),[0,0,n],i);h[1]=0,R(h,h);const c=W(r,h),d=k(-h[2],0,h[0]),f=Math.abs(W(r,d)),m=c>.05||f>2;(a||m)&&(this.finished=!0)}enforce(t,e){const{kicker:i,defender:o,markPos:a}=this,r=i.pos,n=at(P(),a,r,.5),h=Z(a,r)/2+5,c=Z(t.pos,n);if(t===i){const d=i.actionState==="mark",f=c<=h+.5;return(d||f)&&(x(t.vel,0,0,0),x(t.jogVel,0,0,0),x(t.joltVel,0,0,0)),!1}if(t===o)return A(t.pos,o.pos),x(t.vel,0,0,0),x(t.jogVel,0,0,0),x(t.joltVel,0,0,0),!1;if(c<h&&t!==i&&t!==o){const d=Z(t.pos,n),f=h-d;if(f>0){const m=U(P(),t.pos,n);m[1]=0;const l=H(m);if(l<.001?(x(m,Math.random()-.5,0,Math.random()-.5),R(m,m)):V(m,m,1/l),f<2){const p=f*10;return I(t.joltVel,t.joltVel,m,p*e),t.vel[0]*=.5,t.vel[2]*=.5,!0}else return I(t.pos,n,m,h+1.5),x(t.vel,0,0,0),x(t.jogVel,0,0,0),x(t.joltVel,0,0,0),!0}}return!1}}function Xt(s,t){const e=s.pos[0]-t.pos[0],i=s.pos[1]-t.pos[1],o=s.pos[2]-t.pos[2],a=e*e+i*i+o*o,[r,n]=s.collideBounds(),[h,c]=t.collideBounds(),d=.5*ut(s.collideBounds()),f=.5*ut(t.collideBounds()),m=d+f;return a<=m*m}class ft{constructor(t){this.pos=t,this.vel=[0,0,0],this.width=1.6,this.height=2.4,this.usesGravity=!0,this.gravity=[0,-9.8,0],this.bounces=!1,this.restitution=.4,this.floorY=0}setupForBoundary(t,e){}update(t,e){this.usesGravity&&I(this.vel,this.vel,this.gravity,t),I(this.pos,this.pos,this.vel,t),this.pos[1]<this.floorY&&(this.pos[1]=this.floorY,this.bounces&&Math.abs(this.vel[1])>.5?this.vel[1]=-this.vel[1]*this.restitution:this.vel[1]=0)}render(t){t.renderSprite(this.pos,this.width,this.height,1,0)}collidesWith(t){return Xt(this,t)}collideBounds(){return[.5,1.8]}}const vt={home:Object.freeze({idle:[[0,0,0]],run:[[1,0,0],[2,0,0],[3,0,0],[4,0,0],[5,0,0],[6,0,0]],kickRightFoot:[[1,0,0],[2,0,0]],kickLeftFoot:[[4,0,0],[5,0,0]],handpassRightHand:[[1,0,0],[0,0,0]],handpassLeftHand:[[4,0,0],[0,0,0]],jumpMark:[[1,0,0],[2,0,0],[0,0,0]],jumpSpoil:[[1,0,0],[2,0,0],[0,0,0]]}),away:Object.freeze({idle:[[0,4,0]],run:[[1,4,0],[2,4,0],[3,4,0],[4,4,0],[5,4,0],[6,4,0]],kickRightFoot:[[1,4,0],[2,4,0]],kickLeftFoot:[[4,4,0],[5,4,0]],handpassRightHand:[[1,4,0],[0,4,0]],handpassLeftHand:[[4,4,0],[0,4,0]],jumpMark:[[1,4,0],[2,4,0],[0,4,0]],jumpSpoil:[[1,4,0],[2,4,0],[0,4,0]]})};class Yt extends ft{constructor(t,e,i,o=!1){super(i),this.positionPos=E(i),this.name=t,this.team=e,this.playing=o,this.width=1.6,this.height=2.4,this.aiming=!1,this.jogVel=k(0,0,0),this.joltVel=k(0,0,0),this.jogSpeed=5,this.joltSpeed=2,this.energy=10,this.energyRecovery=0,this.statsWeight=85+Math.random()*10,this.statsStrength=50+Math.random()*30,this.statsSpeed=10+Math.random()*5,this.statsJump=10,this.statsKickRange=45,this.statsHandpassRange=20,this.statsAgility=10,this.joltDecayRate=8,this.animations=vt[e]??vt.home,this.animState="idle",this.actionState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=8,this.stateTimer=0,this.animSprite=k(0,0,0)}updateAI(t,e){const o=e.ball;let a=null;if(o.carried&&o.carrier===this)if(this.stateTimer+=t,this.stateTimer<1)a="run";else{let n=!1;for(const l of e.players)if(!(l===this||l.team===this.team)&&D(l.pos,this.pos)<7){n=!0;break}const h=e.players.filter(l=>l.team===this.team&&l!==this);if(n){let l=null,p=-1/0;const u=k(0,0,this.team==="home"?-1:1);for(const g of h){if(g===this)continue;const T=D(this.pos,g.pos);if(T>40)continue;let y=!1;for(const F of e.players)if(F.team!==this.team&&D(F.pos,g.pos)<5){y=!0;break}if(y)continue;const S=P();J(S,g.pos,this.pos),R(S,S);const w=W(u,S),v=E(g.vel);v[1]=0;const _=W(u,v),L=Math.abs(T-15)*.2,B=15*w+2*_-L;B>p&&(p=B,l=g)}if(l){const g=U(P(),l.pos,this.pos),T=[g[0],g[2]];return this.tryDisposeBall(e,{kickReleased:!0,kickHeldTime:H(g)>20?.5:.1,aimTarget:T})??"run"}}const d=this.team==="home"?-5:b+5,f=0;if(Math.abs(this.pos[2]-d)<=this.statsKickRange){const l=k(f,0,d),p=(Math.random()-.5)*9;l[0]+=p;const u=U(P(),l,this.pos),g=[u[0],u[2]];return this.tryDisposeBall(e,{kickReleased:!0,kickHeldTime:.4,aimTarget:g})??"run"}if(n||this.stateTimer>5){let l=null,p=-1/0;for(const u of h){const g=D(this.pos,u.pos);if(g>this.statsKickRange)continue;const T=this.team==="home"?-1:1,y=(u.pos[2]-this.pos[2])*T,S=Math.abs(u.pos[0]-this.pos[0]),w=y-S-g;w>p&&(p=w,l=u)}if(l){const u=U(P(),l.pos,this.pos),g=[u[0],u[2]];return this.tryDisposeBall(e,{kickReleased:!0,kickHeldTime:.4,aimTarget:g})??"run"}}a="run"}let r=null;if(o.carried&&o.carrier===this){const n=this.team==="home"?-1:1,h=k(0,0,n);let c=P();for(const f of e.players){if(f===this||f.team===this.team)continue;const m=P();J(m,this.pos,f.pos),m[1]=0;const l=H(m);if(l<5&&l>.5){const p=1/l;R(m,m),I(c,c,m,p)}}const d=P();z(d,h,c),R(d,d),r=E(this.pos),I(r,r,d,10)}else if(o.carried)if(o.carrier&&o.carrier.team!==this.team&&e.chasers<3&&e.closestPlayers[this.team]===this||D(o.pos,this.pos)<=15&&this.energy>0)r=E(o.pos),e.chasers++;else if(o.carrier&&o.carrier.team===this.team&&o.pos[2]>20&&o.pos[2]<b-20&&D(o.pos,this.pos)<10&&this.energy>.3&&e.followers<3){e.followers++;const n=E(o.carrier.jogVel);H(n)<.01&&(n[2]=this.team==="home"?-1:1),R(n,n);const h=k(-n[2],0,n[0]);R(h,h);let c=0,d=12;switch(this.name){case"wing":c=12*(this.team==="home"?-1:1),d=15;break;case"forward":c=6,d=18;break;case"half-forward":case"half-back":c=4,d=10;break;case"center":case"mid":c=0,d=10;break;case"back":default:c=-6,d=8;break}const f=E(o.carrier.pos);I(f,f,n,d),I(f,f,h,c),r=f}else r=this.positionPos??this.pos;else if(o.pos[1]>.1||o.vel[1]>.1){const n=o.gravity[1]??-9.8,h=o.vel[1],c=o.pos[1],d=.5*n,f=h,m=c;let l=0;const p=f*f-4*d*m;if(p>=0&&Math.abs(d)>1e-5){const g=Math.sqrt(p),T=(-f+g)/(2*d),y=(-f-g)/(2*d);l=Math.max(T,y)}const u=P();I(u,o.pos,o.vel,l),u[1]=0,D(u,this.pos)<=35?r=u:r=this.positionPos??this.pos}else D(o.pos,this.pos)<=25?r=o.pos:r=this.positionPos??this.pos;if(r===this.positionPos&&D(this.positionPos,this.pos)<=1&&(a="idle",this.actionState!=="idle"&&(this.stateTimer=0),A(this.jogVel,[0,0,0]),A(this.joltVel,[0,0,0])),r&&a===null){const n=P();if(J(n,r,this.pos),n[1]=0,At(n)>1e-4){R(n,n),V(this.joltVel,n,this.joltSpeed);const c=P();H(this.jogVel)>1e-4?(R(c,this.jogVel),at(c,c,n,.15),R(c,c),V(this.jogVel,c,this.jogSpeed)):V(this.jogVel,n,this.jogSpeed)}}if(this.energy>0?(z(this.vel,this.jogVel,this.joltVel),this.energy-=t):(I(this.vel,this.jogVel,this.joltVel,.5),this.energyRecovery+=t,this.energyRecovery>=10&&(this.energy=10,this.energyRecovery=0)),V(this.joltVel,this.joltVel,Math.exp(-this.joltDecayRate*t)),this.checkPlayerCollisions(t,e),super.update(t,e),a===null)for(const n of e.players){if(n===this||!o.carried||o.carrier!==n||n.team===this.team||!this.collidesWith(n)||n.actionState==="tackleDisposal")continue;const h=U(P(),n.pos,this.pos);h[1]=0,R(h,h);const c=E(this.jogVel);if(c[1]=0,H(c)<1e-4||W(R(c,c),h)>.1){this.stateTimer=1,a="tackle",n.actionState="tackleDisposal",n.stateTimer=.5,console.log("Tackle from",this,"on",n,W(c,h));break}}if(!o.carried&&o.collidesWith(this)&&a===null){const n=o.lastTouchedType==="kick"&&!o.hasBounced&&o.lastTouchedBy!==this&&D(o.pos,o.origin)>=10;if(o.pickup(this),a=n?"mark":"pickup",n&&(e.setPiece=new ht(e,this,E(o.pos)),this.stateTimer=0),this.team==="home")return e.player=this,this.aiming=!1,null}return a||(a=H(this.vel)>1e-4?"run":"idle"),a}collideBounds(){return[.5,1.8]}get stunned(){return this.actionState==="tackle"||this.actionState==="tackled"}updateHuman(t,e){const i=e.controls,o=e.ball;let{kickPressed:a,kickReleased:r,kickHeldTime:n,moveX:h,moveZ:c,aimTarget:d}=i.state;const f=1e-4;let m=null;if((h!==0||c!==0)&&!this.aiming){const l=k(h,0,c);R(l,l);const p=k(h,0,c);if(Dt(p)>f){R(p,p),V(this.joltVel,p,this.joltSpeed);const u=P();H(this.jogVel)>f?(R(u,this.jogVel),at(u,u,l,.15),R(u,u),V(this.jogVel,u,this.jogSpeed)):V(this.jogVel,l,this.jogSpeed)}}if(this.energy>0?(z(this.vel,this.jogVel,this.joltVel),this.energy-=t):(z(this.vel,this.jogVel,V(this.joltVel,this.joltVel,.5)),this.energyRecovery+=t,this.energyRecovery>=10&&(this.energy=10,this.energyRecovery=0)),V(this.joltVel,this.joltVel,Math.exp(-this.joltDecayRate*t)),this.checkPlayerCollisions(t,e),super.update(t,e),!o.carried&&o.collidesWith(this)){const l=o.lastTouchedType==="kick"&&!o.hasBounced&&o.lastTouchedBy!==this;o.pickup(this),m=l?"mark":"pickup",l&&(e.setPiece=new ht(e,this,E(o.pos)),this.stateTimer=0,this.aiming=!1)}if(o.carried&&o.carrier===this&&(a&&(this.aiming=!0),m=this.tryDisposeBall(e,{kickReleased:i.state.kickReleased,kickHeldTime:i.state.kickHeldTime,aimTarget:i.state.aimTarget,moveVec:h!==0||c!==0?k(h,0,c):E(this.jogVel)}),o.carried||(this.aiming=!1)),this.aiming){const l=it(0,0);d&&ot(l,l,d),e.aimTarget.setPosition([this.pos[0]+l[0],.002,this.pos[2]+l[1]])}else e.aimTarget.setPosition(k(this.pos[0],.002,this.pos[2]+.8));return!m&&this.actionState!=="run"&&this.actionState!=="idle"&&(m=H(this.vel)>f?"run":"idle"),m}tryDisposeBall(t,e){const i=t.ball;if(!i.carried||i.carrier!==this)return null;const{kickReleased:o,kickHeldTime:a}=e;let{aimTarget:r}=e;if(!o)return null;const n=a<.25;if(n){const y=e.moveVec??E(this.jogVel);if(H(y)===0){const v=this.team==="home"?-1:1;x(y,0,0,v)}R(y,y);let S=null,w=-1/0;for(const v of t.players){if(v.team!==this.team||v===this||v.stunned)continue;const _=U(P(),v.pos,this.pos),L=H(_);if(L>30)continue;const B=R(P(),_),F=W(y,B);if(F<=0)continue;let K=0;for(const O of t.players){if(O.team===this.team||O===v||O.stunned)continue;Z(O.pos,v.pos)<=10&&K++}const $=.5*K,Y=F*2-L/30-$;Y>w&&(w=Y,S=v)}if(S){const v=U(P(),S.pos,this.pos);r=[v[0],v[2]]}else r=[y[0]*10,y[2]*10]}if(!r)return null;const h=it(0,0);ot(h,h,r);const c=Rt(h);if(c<.1)return null;const d=-this.gravity[1],f=(n?20:30)*Math.PI/180,m=Math.sin(2*f),l=Math.sqrt(c*d/m),p=k(h[0],0,h[1]);R(p,p);const u=k(p[0]*Math.cos(f),Math.sin(f),p[2]*Math.cos(f));return i.launch(u,l),i.lastTouchedType=n?"handpass":"kick",i.hasBounced=!1,this.stateTimer=.5,n?"handpass":"kick"}update(t,e){let i=!1;if(e.setPiece&&(i=e.setPiece.enforce(this,t)),e.ball.carried||(this.aiming=!1),!this.playing)return;if(this.actionState==="pickup"&&(this.actionState="run"),this.actionState==="mark")if(this.stateTimer-=t,this.stateTimer<=0||e.setPiece===null)this.actionState="idle",this.stateTimer=0;else{if(x(this.vel,0,0,0),x(this.jogVel,0,0,0),x(this.joltVel,0,0,0),this===e.player){const r=e.controls.state.aimTarget;if(this.aiming){const n=it(0,0);r&&ot(n,n,r),e.aimTarget.setPosition([this.pos[0]+n[0],.002,this.pos[2]+n[1]])}else e.player===this&&e.aimTarget.setPosition(k(this.pos[0],.002,this.pos[2]+.8))}this.updateAnimation(t,null,e.ball);return}if(this.actionState==="tackleDisposal"){if(A(this.vel,[0,0,0]),this.stateTimer-=t,e.player===this&&e.controls.state.kickReleased&&(this.tryDisposeBall(e,e.controls.state),this.actionState="handpass",this.stateTimer=.5),e.player!==this){const a=.5-this.stateTimer,r=.5+(this.statsStrength-50)*.01,n=a/r*(.5+(this.statsStrength-50)/100);Math.random()<n*t*2&&this.tryDisposeBall(e,{kickReleased:!0,kickHeldTime:.1,aimTarget:null,moveVec:P()})}if(this.stateTimer<=0){const a=e.ball;a.carried=!1,a.carrier=null,A(a.pos,this.pos),x(a.vel,0,0,0),a.lastTouchedType="spill",a.hasBounced=!1,this.actionState="tackled",this.stateTimer=1}if(this.updateAnimation(t,null,e.ball),this.aiming){const r=e.controls.state.aimTarget,n=it(0,0);r&&ot(n,n,r),e.aimTarget.setPosition([this.pos[0]+n[0],.002,this.pos[2]+n[1]])}else e.player===this&&e.aimTarget.setPosition(k(this.pos[0],.002,this.pos[2]+.8));return}if(this.actionState==="tackled"||this.actionState==="tackle"||this.actionState==="kick"||this.actionState==="handpass"){this.vel=k(0,0,0),this.stateTimer-=t,this.stateTimer<=0&&(this.actionState="idle",this.stateTimer=0),this.updateAnimation(t,null,e.ball),e.player===this&&e.aimTarget.setPosition(k(this.pos[0],.002,this.pos[2]+.8));return}let o=null;i||(e.player===this?o=this.updateHuman(t,e):o=this.updateAI(t,e)),this.updateAnimation(t,o,e.ball),o!==null&&(this.actionState=o)}updateAnimation(t,e,i){const o=this.animations[this.animState];if(o.length===0)return;this.animTimer+=t;const a=1/this.animFPS;this.animTimer>=a&&(this.animTimer-=a,this.animFrame=this.animFrame+1),e==="kick"&&(this.animState="kickRightFoot",this.animFrame=0,this.animTimer=0),this.animState==="run"&&D(this.vel,[0,0,0])===0&&(this.animState="idle",this.animFrame=0,this.animTimer=0),this.animState==="idle"&&D(this.vel,[0,0,0])!==0&&(this.animState="run",this.animFrame=0,this.animTimer=0);const r=this.animState==="run"||this.animState==="idle";this.animFrame>=o.length&&(this.animFrame=r?0:o.length-1,r||(this.animState="run",this.animFrame=0,this.animTimer=0));const n=this.animations[this.animState];this.animSprite=E(n[this.animFrame])??k(0,0,0),(this.vel[2]>0?"away":this.vel[2]<0?"home":this.pos[2]<i.pos[2]?"away":"home")==="away"&&(this.animSprite[0]+=7)}render(t){const[e,i,o]=this.animSprite;t.renderSprite(this.pos,this.width,this.height,e,i)}checkPlayerCollisions(t,e){for(const i of e.players)if(!(i===this||!i.playing)&&this.collidesWith(i)){const o=P();J(o,this.pos,i.pos),o[1]=0;const a=H(o);a<1e-4?(o[0]=Math.random()-.5,o[2]=Math.random()-.5,R(o,o)):V(o,o,1/a);const r=(this.width+i.width)/2-a;if(r<=0)continue;const n=this.statsWeight,h=i.statsWeight,c=n+h,d=P();V(d,o,r);const f=P(),m=P();V(f,d,h/c),V(m,d,n/c),this.pos[0]+=f[0],this.pos[2]+=f[2],i.pos[0]-=m[0],i.pos[2]-=m[2]}}setupForBoundary(t,e){t==="behindAway"&&this.team==="home"&&this.name==="FB"?(A(this.pos,[0,0,b-5]),A(this.jogVel,[0,0,0]),A(this.joltVel,[0,0,0]),this.actionState="idle",this.stateTimer=0):t==="behindAway"&&this.team==="away"&&this.name==="FF"?A(this.pos,[0,0,b-25]):t==="behindHome"&&this.team==="away"&&this.name==="FB"?(A(this.pos,[0,0,5]),A(this.jogVel,[0,0,0]),A(this.joltVel,[0,0,0]),this.actionState="idle",this.stateTimer=0):t==="behindHome"&&this.team==="home"&&this.name==="FF"?A(this.pos,[0,0,25]):A(this.pos,this.positionPos)}}class qt extends ft{constructor(t){super(t),this.carried=!1,this.origin=P(),this.carrier=null,this.width=1.6,this.height=2.4,this.bounces=!0,this.animations=Object.freeze({idle:[[0,1,0]],backSpin:[[1,1,0],[2,1,0],[3,1,0],[4,1,0],[5,1,0],[6,1,0],[7,1,0],[8,1,0]],forwardSpin:[[8,1,0],[7,1,0],[6,1,0],[5,1,0],[4,1,0],[3,1,0],[2,1,0],[1,1,0]],backSpinRight:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]],backSpinLeft:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinRight:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinLeft:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]]}),this.animState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=12,this.lastTouchedBy=null,this.lastTouchedType=null,this.hasBounced=!1}update(t,e){if(this.carried&&this.carrier){const i=this.carrier,o=i.vel[2]>0?1:i.vel[2]<0||i.team==="home"?-1:1,a=k(0,.5,.2*o),r=E(this.carrier.pos);z(this.pos,r,a),A(this.origin,this.pos)}else{const i=this.vel[1]<0;super.update(t,e),this.hasBounced=this.hasBounced||i&&this.vel[1]>0&&this.pos[1]<=this.floorY,this.pos[1]<=this.floorY&&(V(this.vel,this.vel,.97),A(this.origin,this.pos))}this.updateAnimation(t)}collideBounds(){return[.4,.5]}pickup(t){this.carried=!0,this.carrier=t,this.lastTouchedBy=t,this.lastTouchedType=null,this.hasBounced=!1,this.origin=E(this.pos);const e=t.vel[2]>0?1:t.vel[2]<0||t.team==="home"?-1:1;x(this.pos,t.pos[0],t.pos[1],t.pos[2]+e*.2),x(this.vel,0,0,0)}launch(t,e,i="kick"){this.carried=!1,this.carrier=null,V(this.vel,t,e),this.lastTouchedType=i,this.hasBounced=!1}updateAnimation(t){this.animTimer+=t;const e=1/this.animFPS;this.animTimer>=e&&(this.animTimer-=e,this.animFrame=this.animFrame+1);const i=this.animState;this.carried?this.animState="idle":this.lastTouchedType==="kick"&&!this.hasBounced?this.animState=this.vel[2]<0?"backSpin":"forwardSpin":this.lastTouchedType==="handpass"&&!this.hasBounced?this.animState=this.vel[2]<0?"backSpinRight":"forwardSpinLeft":this.hasBounced?Math.abs(this.vel[1])<.05&&this.pos[1]<=this.floorY+.01?this.animState="idle":this.animState=this.vel[2]<0?"forwardSpin":"backSpin":this.animState="idle",this.animState!==i&&(this.animFrame=0,this.animTimer=0);const o=this.animations[this.animState];o.length!==0&&this.animFrame>=o.length&&(this.animFrame=0)}render(t){var r;const e=(r=this.animations)==null?void 0:r[this.animState],[i,o,a]=(e==null?void 0:e[this.animFrame])??[0,1,void 0];t.renderSprite(this.pos,this.width,this.height,i,o);{const n=t.gl;n.useProgram(t.program),n.bindVertexArray(t.quadVao);const[h,c]=[2,3],d=h/t.sheetCols,f=c/t.sheetRows,m=(h+1)/t.sheetCols,l=(c+1)/t.sheetRows;n.uniform4f(t.uTileUV,d,f,m,l);const p=N();Q(p,p,[this.pos[0],.001,this.pos[2]]),kt(p,p,-Math.PI/2),nt(p,p,[2,2,1]),n.uniformMatrix4fv(t.uModel,!1,p),n.drawElements(n.TRIANGLES,6,n.UNSIGNED_SHORT,0)}}setupForBoundary(t,e){if(this.carried=!1,this.carrier=null,t==="goalAway"||t==="goalHome")A(this.pos,[0,0,b/2]),A(this.vel,[0,15,0]),this.lastTouchedType="tap",this.lastTouchedBy=null,this.origin=E(this.pos);else if(t==="behindAway")A(this.pos,[0,0,b-6]);else if(t==="behindHome")A(this.pos,[0,0,6]);else{this.pos[1]=0,A(this.pos,e);const i=P();I(i,[0,b/2,b/2],e,-1),R(i,i),this.launch(i,15,"tap")}}}class Wt{constructor(t=[0,.001,0]){this.pos=E(t),this.size=2,this.spriteCoord=[0,3]}setPosition(t){this.pos[0]=t[0],this.pos[2]=t[2]}render(t){const e=t.gl;e.useProgram(t.program),e.bindVertexArray(t.quadVao);const[i,o]=this.spriteCoord,a=i/t.sheetCols,r=o/t.sheetRows,n=(i+1)/t.sheetCols,h=(o+1)/t.sheetRows;e.uniform4f(t.uTileUV,a,r,n,h);const c=N();Q(c,c,[this.pos[0],.002,this.pos[2]]),kt(c,c,-Math.PI/2),nt(c,c,[this.size,this.size,1]),e.uniformMatrix4fv(t.uModel,!1,c),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0)}}function yt(s,t,e){const i=(n,h)=>{const c=s.createShader(h);if(!c)throw new Error("Failed to create shader");if(s.shaderSource(c,n),s.compileShader(c),!s.getShaderParameter(c,s.COMPILE_STATUS))throw new Error(s.getShaderInfoLog(c));return c},o=i(t,s.VERTEX_SHADER),a=i(e,s.FRAGMENT_SHADER),r=s.createProgram();if(s.attachShader(r,o),s.attachShader(r,a),s.linkProgram(r),!s.getProgramParameter(r,s.LINK_STATUS))throw new Error(s.getProgramInfoLog(r));return r}async function Zt(s){const t=new Image;return t.src=s,await t.decode(),t}function Kt(s,t,e,i=1){const r=s*2/1.6/i,n=t*2/2/i,h=[0,0,0,.5,.5],c=[];for(let d=0;d<=e;d++){const f=d/e*2*Math.PI,m=Math.cos(f)*s,l=Math.sin(f)*t,p=m/(s*2)*r+.5,u=l/(t*2)*n+.5;h.push(m,0,l,p,u),d>0&&c.push(0,d,d+1)}return{vertices:new Float32Array(h),indices:new Uint16Array(c)}}function $t(s=160,t=170,e=50,i=50,o=.4){const a=[],r=[];let n=0;const h=(u,g,T,y,S)=>{const w=T-u,v=y-g,_=Math.hypot(w,v),L=-v/_,B=w/_,F=S/2,K=u+L*F,$=g+B*F,Y=u-L*F,O=g-B*F,st=T+L*F,q=y+B*F,Mt=T-L*F,_t=y-B*F;a.push(K,0,$,st,0,q,Mt,0,_t,Y,0,O),r.push(n,n+1,n+2,n,n+2,n+3),n+=4},c=s/2,d=t/2,f=64;for(let u=0;u<f;u++){const g=u/f*2*Math.PI,T=(u+1)/f*2*Math.PI,y=Math.cos(g)*c,S=Math.sin(g)*d,w=Math.cos(T)*c,v=Math.sin(T)*d;h(y,S,w,v,o)}const m=[[-i/2,-i/2],[i/2,-i/2],[i/2,i/2],[-i/2,i/2]];for(let u=0;u<4;u++){const[g,T]=m[u],[y,S]=m[(u+1)%4];h(g,T,y,S,o)}function l(u){const g=u>0?-1:1,T=[];for(let y=0;y<=1e3;y++){const S=-Math.PI+y/1e3*2*Math.PI,w=Math.sin(S)*e,v=u+g*Math.cos(S)*e,_=w/c,L=v/d;_*_+L*L<=1&&T.push(S)}return T.length===0?[-Math.PI/3,Math.PI/3]:[T[0],T[T.length-1]]}const p=40;for(let u of[-t/2,t/2]){const g=u>0?-1:1,[T,y]=l(u);for(let S=0;S<p;S++){const w=T+S/p*(y-T),v=T+(S+1)/p*(y-T),_=Math.sin(w)*e,L=u+g*Math.cos(w)*e,B=Math.sin(v)*e,F=u+g*Math.cos(v)*e;h(_,L,B,F,o)}}return{vertices:new Float32Array(a),indices:new Uint16Array(r)}}const tt=170,Qt=80,Pt=tt/2;class Jt{constructor(t,e,i){this.gl=t,this.canvas=e,this.spriteSheet=i,this.sheetCols=32,this.sheetRows=32,this.setupMainProgram(),this.setupLineProgram(),this.setupSpriteGeometry(),this.setupField(),this.setupGoalposts(),this.setupCamera(),this.setupSpritesheet(),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL)}setupSpritesheet(){const t=this.gl;t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.spriteSheet),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.texture)}setupMainProgram(){const t=`#version 300 es
      in vec3 a_position;
      in vec2 a_texcoord;
      uniform mat4 u_projection, u_view, u_model;
      out vec2 v_texcoord;
      void main() {
        gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
        v_texcoord = a_texcoord;
      }`,e=`#version 300 es
precision mediump float;

uniform sampler2D u_texture;
uniform vec4 u_tileUV;

in vec2 v_texcoord;
out vec4 outColor;

void main() {
  vec2 tileUV = mod(v_texcoord, 1.0);
  vec2 texCoord = mix(u_tileUV.xy, u_tileUV.zw, tileUV);
  vec4 texColor = texture(u_texture, texCoord);

  if (texColor.a < 0.01) discard; // Skip fully transparent fragments

  outColor = texColor;
}
`;this.program=yt(this.gl,t,e),this.uProjection=this.gl.getUniformLocation(this.program,"u_projection"),this.uView=this.gl.getUniformLocation(this.program,"u_view"),this.uModel=this.gl.getUniformLocation(this.program,"u_model"),this.uTileUV=this.gl.getUniformLocation(this.program,"u_tileUV"),this.uTexture=this.gl.getUniformLocation(this.program,"u_texture"),this.aPos=this.gl.getAttribLocation(this.program,"a_position"),this.aUV=this.gl.getAttribLocation(this.program,"a_texcoord")}setupLineProgram(){const t=`#version 300 es
    in vec3 a_position;
    uniform mat4 u_projection;
    uniform mat4 u_view;
    uniform mat4 u_model;
    void main() {
    gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
    }`,e=`#version 300 es
    precision mediump float;
    out vec4 outColor;
    void main() {
    outColor = vec4(1, 1, 1, 1);
    }`;this.lineProgram=yt(this.gl,t,e),this.lineProj=this.gl.getUniformLocation(this.lineProgram,"u_projection"),this.lineView=this.gl.getUniformLocation(this.lineProgram,"u_view"),this.lineModel=this.gl.getUniformLocation(this.lineProgram,"u_model"),this.linePos=this.gl.getAttribLocation(this.lineProgram,"a_position")}setupSpriteGeometry(){const t=this.gl;t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.depthMask(!0);const e=new Float32Array([-.5,0,0,1,.5,0,1,1,.5,1,1,0,-.5,1,0,0]),i=new Uint16Array([0,1,2,0,2,3]);this.quadVao=this.gl.createVertexArray(),this.gl.bindVertexArray(this.quadVao);const o=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.aPos,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(this.aPos),this.gl.vertexAttribPointer(this.aUV,2,this.gl.FLOAT,!1,16,8),this.gl.enableVertexAttribArray(this.aUV);const a=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,a),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,i,this.gl.STATIC_DRAW)}setupField(){const t=this.gl,{vertices:e,indices:i}=Kt(Qt,Pt,64,16);this.fieldVao=this.gl.createVertexArray(),this.gl.bindVertexArray(this.fieldVao);const o=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.aPos,3,this.gl.FLOAT,!1,20,0),this.gl.enableVertexAttribArray(this.aPos),this.gl.vertexAttribPointer(this.aUV,2,this.gl.FLOAT,!1,20,12),this.gl.enableVertexAttribArray(this.aUV);const a=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,a),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,i,this.gl.STATIC_DRAW),this.fieldIndices=i.length,this.fieldLineMesh=$t(),this.lineVao=t.createVertexArray(),t.bindVertexArray(this.lineVao);const r=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,this.fieldLineMesh.vertices,t.STATIC_DRAW);const n=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.fieldLineMesh.indices,t.STATIC_DRAW),t.vertexAttribPointer(this.linePos,3,t.FLOAT,!1,12,0),t.enableVertexAttribArray(this.linePos)}setupGoalposts(){this.goalPostPositions=[[-9,0,tt],[-3,0,tt],[3,0,tt],[9,0,tt],[-9,0,0],[-3,0,0],[3,0,0],[9,0,0]]}setupCamera(){this.projection=N(),Lt(this.projection,Math.PI/4,this.canvas.width/this.canvas.height,.1,1e3),this.view=N(),this.model=N()}renderSprite(t,e,i,o,a){const{gl:r,program:n,quadVao:h,uModel:c,uTileUV:d,sheetCols:f,sheetRows:m}=this;r.useProgram(n),r.bindVertexArray(h);const l=N();Q(l,l,t),nt(l,l,[e,i,1]),r.uniformMatrix4fv(c,!1,l);const p=o/f,u=a/m,g=(o+1)/f,T=(a+1)/m;r.uniform4f(d,p,u,g,T),r.drawElements(r.TRIANGLES,6,r.UNSIGNED_SHORT,0)}renderScene(t,e){const i=this.gl;i.viewport(0,0,this.canvas.width,this.canvas.height),i.clearColor(.2,.6,.2,1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);const o=k(0,10,15),a=P();z(a,t.cameraTarget,o);const r=k(0,0,-20),n=P();z(n,t.cameraTarget,r),Vt(this.view,a,n,[0,1,0]),i.useProgram(this.program),i.uniformMatrix4fv(this.uProjection,!1,this.projection),i.uniformMatrix4fv(this.uView,!1,this.view),i.activeTexture(i.TEXTURE0),i.uniform1i(this.uTexture,0),i.bindVertexArray(this.fieldVao),St(this.model),Q(this.model,this.model,[0,0,Pt]),i.uniformMatrix4fv(this.uModel,!1,this.model);const h=0,c=2,d=h/this.sheetCols,f=c/this.sheetRows,m=(h+1)/this.sheetCols,l=(c+1)/this.sheetRows;i.uniform4f(this.uTileUV,d,f,m,l),i.drawElements(i.TRIANGLES,this.fieldIndices,i.UNSIGNED_SHORT,0),i.useProgram(this.lineProgram),i.uniformMatrix4fv(this.lineProj,!1,this.projection),i.uniformMatrix4fv(this.lineView,!1,this.view);const p=N();Q(p,this.model,[0,.001,0]),i.uniformMatrix4fv(this.lineModel,!1,p),i.bindVertexArray(this.lineVao),i.drawElements(i.TRIANGLES,this.fieldLineMesh.indices.length,i.UNSIGNED_SHORT,0),i.useProgram(this.program),i.bindVertexArray(this.quadVao);const u=1,g=2,T=u/this.sheetCols,y=g/this.sheetRows,S=(u+1)/this.sheetCols,w=(g+1)/this.sheetRows;i.uniform4f(this.uTileUV,T,y,S,w);for(let v=0;v<this.goalPostPositions.length;v++){const[_,L,B]=this.goalPostPositions[v],K=v%4===0||v%4===3?6:10,$=a[0]-_,Y=a[2]-B,O=Math.sqrt($*$+Y*Y),st=O>50?1.5:O>150?2:1,q=N();Q(q,q,[_,L,B]),nt(q,q,[st,K,1]),i.uniformMatrix4fv(this.uModel,!1,q),i.drawElements(i.TRIANGLES,6,i.UNSIGNED_SHORT,0)}i.bindVertexArray(this.quadVao);for(const v of e)v instanceof ft?v.render(this):this.renderSprite(v.pos,v.width,v.height,1,0);t.aimTarget.render(this)}}var X,wt,Et,bt;class ts{constructor(t){mt(this,X);this.state={moveX:0,moveZ:0,kickPressed:!1,kickReleased:!1,kickHeldTime:0,aimTarget:null},this.keys={},this.lastKeys={},this.touchMove=null,this.touchAim=null,this.kPressTime=0,t.addEventListener("touchstart",et(this,X,wt).bind(this),{passive:!1}),t.addEventListener("touchmove",et(this,X,Et).bind(this),{passive:!1}),t.addEventListener("touchend",et(this,X,bt).bind(this)),window.addEventListener("keydown",e=>this.keys[e.key.toLowerCase()]=!0),window.addEventListener("keyup",e=>this.keys[e.key.toLowerCase()]=!1)}endUpdate(){this.state.moveX=0,this.state.moveZ=0,this.state.kickPressed=!1,this.state.kickReleased=!1}update(t){var a;const e=!!this.keys.k,i=!!this.lastKeys.k;if(e&&!i&&(this.state.kickPressed=!0,this.kPressTime=0,this.state.aimTarget=[0,0]),e?(this.kPressTime+=t,this.state.aimTarget&&(this.keys.a&&(this.state.aimTarget[0]-=30*t),this.keys.d&&(this.state.aimTarget[0]+=30*t),this.keys.w&&(this.state.aimTarget[1]-=30*t),this.keys.s&&(this.state.aimTarget[1]+=30*t))):(this.keys.a&&(this.state.moveX-=1),this.keys.d&&(this.state.moveX+=1),this.keys.w&&(this.state.moveZ-=1),this.keys.s&&(this.state.moveZ+=1)),!e&&i&&(this.state.kickReleased=!0),this.state.kickHeldTime=this.kPressTime,this.touchMove&&!this.touchAim&&(this.state.moveX=this.touchMove.dx/50,this.state.moveZ=this.touchMove.dy/50),this.touchAim){this.kPressTime+=t;const r=this.touchAim.dx,n=this.touchAim.dy;console.log("Touch aim:",r,n);const h=10;this.state.aimTarget=[-r/h,-n/h],this.state.kickHeldTime=this.kPressTime}const o=(a=navigator.getGamepads)==null?void 0:a.call(navigator)[0];if(o){this.state.moveX+=o.axes[0]||0,this.state.moveZ+=-(o.axes[1]||0);const r=o.axes[2]||0,n=-(o.axes[3]||0),h=Math.hypot(r,n);h>.2&&(this.state.aimTarget=[r/h,n/h])}this.lastKeys={...this.keys}}getState(){return this.state}}X=new WeakSet,wt=function(t){t.preventDefault();for(const e of t.changedTouches)e.clientX<window.innerWidth/2?this.touchMove={id:e.identifier,startX:e.clientX,startY:e.clientY,dx:0,dy:0}:(this.touchAim={id:e.identifier,startX:e.clientX,startY:e.clientY,dx:0,dy:0},this.state.kickPressed=!0,this.kPressTime=0)},Et=function(t){t.preventDefault();for(const e of t.changedTouches)this.touchMove&&e.identifier===this.touchMove.id&&(this.touchMove.dx=e.clientX-this.touchMove.startX,this.touchMove.dy=e.clientY-this.touchMove.startY),this.touchAim&&e.identifier===this.touchAim.id&&(this.touchAim.dx=e.clientX-this.touchAim.startX,this.touchAim.dy=e.clientY-this.touchAim.startY)},bt=function(t){t.preventDefault();for(const e of t.changedTouches)this.touchAim&&e.identifier===this.touchAim.id&&(this.touchAim=null,this.state.kickReleased=!0),this.touchMove&&e.identifier===this.touchMove.id&&(this.touchMove=null)};class ss{constructor(t,e){if(this.canvas=t,this.gl=t.getContext("webgl2"),!this.gl)throw new Error("WebGL2 not supported");this.renderer=new Jt(this.gl,t,e),this.controls=new ts(t),this.setPiece=null,this.entities=[],this.aimTarget=new Wt([5,.001,b/2]),this.ball=new qt(k(0,0,b/2)),this.entities.push(this.ball),this.players=[],this.chasers=0,this.followers=0,this.homePositions=Tt(),this.awayPositions=Tt(!0);const i=[[this.homePositions,"home"],[this.awayPositions,"away"]];for(let[o,a]of i)for(const[r,n]of Object.entries(o)){const h=new Yt(r,a,n,!r.toLowerCase().startsWith("bench"));this.entities.push(h),this.players.push(h),r==="RR"&&a==="home"&&(this.player=h)}this.closestPlayers={home:null,away:null},this.cameraTarget=k(0,10,b/2),this.cameraPos=k(0,10,b/2+15),this.resize(),window.addEventListener("resize",()=>this.resize()),this.lastTime=performance.now()}start(){this.lastTime=performance.now(),requestAnimationFrame(this.loop.bind(this))}loop(t){var a,r;const e=(t-this.lastTime)/1e3,i=Math.min(e,1/30);this.lastTime=t,this.updateClosestPlayers(),this.controls.update(i),this.chasers=0,this.followers=0;const o=E(this.ball.pos);for(const n of this.entities)n.update(i,this);if(this.setPiece&&(this.setPiece.update(i),this.setPiece.finished&&(this.setPiece=null)),!this.setPiece){let n=Nt(o,this.ball.pos);if(n!==null){if(n==="goalAway"&&(this.ball.lastTouchedType!=="kick"||((a=this.ball.lastTouchedBy)==null?void 0:a.team)==="home")?n="behindAway":n==="goalHome"&&(this.ball.lastTouchedType!=="kick"||((r=this.ball.lastTouchedBy)==null?void 0:r.team)==="away")?n="behindHome":n==="innerLeftPostAway"||n==="innerRightPostAway"?n="behindAway":(n==="innerLeftPostHome"||n==="innerRightPostHome")&&(n="behindHome"),n==="behindAway"){const h=this.players.find(c=>c.name==="FB"&&c.team==="home");h&&(this.setPiece=new ht(this,h,k(0,0,b-10)))}if(n==="behindHome"){const h=this.players.find(c=>c.name==="FB"&&c.team==="away");h&&(this.setPiece=new ht(this,h,k(0,0,10)))}if(n==="goalAway"||n==="goalHome"||n==="outOfBounds")for(const h of this.entities)h.setupForBoundary(n,this.ball.pos)}}this.updateCameraTarget(),this.updatePlayerControl(),this.renderer.renderScene(this,this.entities),this.controls.endUpdate(),requestAnimationFrame(this.loop.bind(this))}updateClosestPlayers(){const t=this.ball,e={home:1/0,away:1/0},i={home:null,away:null};for(let o of this.players){const a=D(o.pos,t.pos);a<e[o.team]&&(e[o.team]=a,i[o.team]=o)}this.closestPlayers=i}updatePlayerControl(){const t=this.players.filter(a=>a.team==="home"),e=this.ball.carrier;if(!e||e&&e.team==="home")return;let i=null,o=1/0;for(const a of t){if(a.actionState==="tackle")continue;const r=Bt(a.pos,e.pos),n=(Math.abs(a.positionPos[0]-this.ball.pos[0])<10?-10:0)+(a.energy<.3?-5:0)+(a.pos[2]>e.pos[2]?-10:0);r+n<o&&(i=a,o=r+n)}i&&(this.player=i,this.player.aiming=!1)}updateCameraTarget(){const t=this.ball,e=t.carrier,i=e?(e.team==="home",E(e.pos)):E(t.pos);let o=e&&e.team==="home"?0:Math.max(40-i[2],15),a=-.2*i[0];z(i,i,[a,0,o]);const r=D(this.cameraTarget,i),n=Math.max(1/(1+3*r),.05);at(this.cameraTarget,this.cameraTarget,i,n)}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.renderer.setupCamera()}}const es="/footy/assets/spritesheet-erFZxRaO.png";function is(s){const t=document.getElementById("glcanvas");if(!t)throw console.error("Canvas element not found"),new Error("Canvas element not found");new ss(t,s).start()}Zt(es).then(s=>{if(!s.complete)throw console.error("Failed to load sprite sheet"),new Error("Sprite sheet not loaded");is(s)});
