var dt=e=>{throw TypeError(e)};var Ft=(e,t,s)=>t.has(e)||dt("Cannot "+s);var mt=(e,t,s)=>t.has(e)?dt("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s);var st=(e,t,s)=>(Ft(e,t,"access private method"),s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function s(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(o){if(o.ep)return;o.ep=!0;const r=s(o);fetch(o.href,r)}})();var at=1e-6,N=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});function z(){var e=new N(16);return N!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function St(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Q(e,t,s){var i=s[0],o=s[1],r=s[2],a,n,h,c,d,f,m,l,p,u,g,T;return t===e?(e[12]=t[0]*i+t[4]*o+t[8]*r+t[12],e[13]=t[1]*i+t[5]*o+t[9]*r+t[13],e[14]=t[2]*i+t[6]*o+t[10]*r+t[14],e[15]=t[3]*i+t[7]*o+t[11]*r+t[15]):(a=t[0],n=t[1],h=t[2],c=t[3],d=t[4],f=t[5],m=t[6],l=t[7],p=t[8],u=t[9],g=t[10],T=t[11],e[0]=a,e[1]=n,e[2]=h,e[3]=c,e[4]=d,e[5]=f,e[6]=m,e[7]=l,e[8]=p,e[9]=u,e[10]=g,e[11]=T,e[12]=a*i+d*o+p*r+t[12],e[13]=n*i+f*o+u*r+t[13],e[14]=h*i+m*o+g*r+t[14],e[15]=c*i+l*o+T*r+t[15]),e}function it(e,t,s){var i=s[0],o=s[1],r=s[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*o,e[5]=t[5]*o,e[6]=t[6]*o,e[7]=t[7]*o,e[8]=t[8]*r,e[9]=t[9]*r,e[10]=t[10]*r,e[11]=t[11]*r,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Pt(e,t,s){var i=Math.sin(s),o=Math.cos(s),r=t[4],a=t[5],n=t[6],h=t[7],c=t[8],d=t[9],f=t[10],m=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=r*o+c*i,e[5]=a*o+d*i,e[6]=n*o+f*i,e[7]=h*o+m*i,e[8]=c*o-r*i,e[9]=d*o-a*i,e[10]=f*o-n*i,e[11]=m*o-h*i,e}function xt(e,t,s,i,o){var r=1/Math.tan(t/2),a;return e[0]=r/s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,o!=null&&o!==1/0?(a=1/(i-o),e[10]=(o+i)*a,e[14]=2*o*i*a):(e[10]=-1,e[14]=-2*i),e}var Lt=xt;function Bt(e,t,s,i){var o,r,a,n,h,c,d,f,m,l,p=t[0],u=t[1],g=t[2],T=i[0],y=i[1],S=i[2],w=s[0],v=s[1],_=s[2];return Math.abs(p-w)<at&&Math.abs(u-v)<at&&Math.abs(g-_)<at?St(e):(d=p-w,f=u-v,m=g-_,l=1/Math.hypot(d,f,m),d*=l,f*=l,m*=l,o=y*m-S*f,r=S*d-T*m,a=T*f-y*d,l=Math.hypot(o,r,a),l?(l=1/l,o*=l,r*=l,a*=l):(o=0,r=0,a=0),n=f*a-m*r,h=m*o-d*a,c=d*r-f*o,l=Math.hypot(n,h,c),l?(l=1/l,n*=l,h*=l,c*=l):(n=0,h=0,c=0),e[0]=o,e[1]=n,e[2]=d,e[3]=0,e[4]=r,e[5]=h,e[6]=f,e[7]=0,e[8]=a,e[9]=c,e[10]=m,e[11]=0,e[12]=-(o*p+r*u+a*g),e[13]=-(n*p+h*u+c*g),e[14]=-(d*p+f*u+m*g),e[15]=1,e)}function k(){var e=new N(3);return N!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function M(e){var t=new N(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function H(e){var t=e[0],s=e[1],i=e[2];return Math.hypot(t,s,i)}function P(e,t,s){var i=new N(3);return i[0]=e,i[1]=t,i[2]=s,i}function A(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function x(e,t,s,i){return e[0]=t,e[1]=s,e[2]=i,e}function C(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e}function K(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2],e}function B(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e}function I(e,t,s,i){return e[0]=t[0]+s[0]*i,e[1]=t[1]+s[1]*i,e[2]=t[2]+s[2]*i,e}function W(e,t){var s=t[0]-e[0],i=t[1]-e[1],o=t[2]-e[2];return Math.hypot(s,i,o)}function Vt(e,t){var s=t[0]-e[0],i=t[1]-e[1],o=t[2]-e[2];return s*s+i*i+o*o}function At(e){var t=e[0],s=e[1],i=e[2];return t*t+s*s+i*i}function R(e,t){var s=t[0],i=t[1],o=t[2],r=s*s+i*i+o*o;return r>0&&(r=1/Math.sqrt(r)),e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function J(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function ot(e,t,s,i){var o=t[0],r=t[1],a=t[2];return e[0]=o+i*(s[0]-o),e[1]=r+i*(s[1]-r),e[2]=a+i*(s[2]-a),e}var U=K,D=W,Dt=At;(function(){var e=k();return function(t,s,i,o,r,a){var n,h;for(s||(s=3),i||(i=0),o?h=Math.min(o*s+i,t.length):h=t.length,n=i;n<h;n+=s)e[0]=t[n],e[1]=t[n+1],e[2]=t[n+2],r(e,e,a),t[n]=e[0],t[n+1]=e[1],t[n+2]=e[2];return t}})();function It(){var e=new N(2);return N!=Float32Array&&(e[0]=0,e[1]=0),e}function ht(e,t){var s=new N(2);return s[0]=e,s[1]=t,s}function ct(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e}function Rt(e){var t=e[0],s=e[1];return Math.hypot(t,s)}var ut=Rt;(function(){var e=It();return function(t,s,i,o,r,a){var n,h;for(s||(s=2),i||(i=0),o?h=Math.min(o*s+i,t.length):h=t.length,n=i;n<h;n+=s)e[0]=t[n],e[1]=t[n+1],r(e,e,a),t[n]=e[0],t[n+1]=e[1];return t}})();const Ht=160,b=170,lt=Ht/2,j=b/2,G=6,nt=6,pt=.5;function E(e,t,s){return P(e,t,s)}const jt=Object.freeze([E(-.5*G-nt,0,b),E(-.5*G,0,b),E(.5*G,0,b),E(.5*G+nt,0,b)]),Ut=Object.freeze([E(-.5*G-nt,0,0),E(-.5*G,0,0),E(.5*G,0,0),E(.5*G+nt,0,0)]),Ot=Object.freeze({Away:jt,Home:Ut});function gt(e){const t=e[0]/lt,s=(e[2]-j)/j;return t*t+s*s>1}function Ct(e,t,s,i,o,r){const a=o-s,n=r-i;if(a===0&&n===0){const p=e-s,u=t-i;return p*p+u*u}const h=((e-s)*a+(t-i)*n)/(a*a+n*n),c=Math.max(0,Math.min(1,h)),d=s+c*a,f=i+c*n,m=e-d,l=t-f;return m*m+l*l}function Nt(e,t){const s=gt(e),i=gt(t);for(const o of["Away","Home"]){const r=Ot[o];if(i&&!s){if(o==="Away"){if(e[2]>b-10){const n=t[0];if(n>=-3&&n<=3)return"goalAway";if(n>=-9&&n<-3||n>3&&n<=9)return"behindAway"}}else if(o==="Home"&&e[2]<10){const n=t[0];if(n>=-3&&n<=3)return"goalHome";if(n>=-9&&n<-3||n>3&&n<=9)return"behindHome"}}const a=["outerLeftPost","innerLeftPost","innerRightPost","outerRightPost"];for(let n=0;n<r.length;n++){const h=r[n][0],c=r[n][2];if(Ct(h,c,e[0],e[2],t[0],t[2])<pt*pt)return`${a[n]}${o}`}}return!s&&i?"outOfBounds":null}function Tt(e=!1){const s={fullForward:70,halfForward:35,halfBack:-35,fullBack:-70},i={LFP:-45,FF:0,RFP:45,LHF:-50,CHF:0,RHF:50,LHB:-50,CHB:0,RHB:50,LBP:-45,FB:0,RBP:45};function o(h,c){const d=h*Math.PI/180,f=lt*Math.sin(d)*(Math.abs(c)/j)-(e?2:-2),m=j+c*(e?-1:1);return E(f,0,m)}const r=-lt+2,a=h=>j+(e?1:-1)*h;return{LFP:o(i.LFP,s.fullForward-(e?10:-10)),FF:o(i.FF,s.fullForward),RFP:o(i.RFP,s.fullForward-(e?10:-10)),LHF:o(i.LHF,s.halfForward),CHF:o(i.CHF,s.halfForward),RHF:o(i.RHF,s.halfForward),LW:E(-25,0,j-(e?2:-2)),C:E(8,0,j-(e?-5:5)),RW:E(25,0,j-(e?2:-2)),LHB:o(i.LHB,s.halfBack),CHB:o(i.CHB,s.halfBack),RHB:o(i.RHB,s.halfBack),LBP:o(i.LBP,s.fullBack-(e?10:-10)),FB:o(i.FB,s.fullBack),RBP:o(i.RBP,s.fullBack-(e?10:-10)),Ruck:E(0,0,j-(e?10:-10)),RR:E(-10,0,j-(e?10:-10)),Rover:E(10,0,j-(e?10:-10)),Bench1:E(r,0,a(10)),Bench2:E(r,0,a(13)),Bench3:E(r,0,a(16)),Bench4:E(r,0,a(19)),Bench5:E(r,0,a(22))}}function zt(e,t,s){let i=null,o=1/0;for(const r of t)if(r.team!==e.team){const a=W(r.pos,s);a<o&&(o=a,i=r)}return i}class Gt{constructor(t,s,i){this.game=t,this.kicker=s,this.markPos=M(i),this.timer=0,this.finished=!1}update(t){this.timer+=t}enforce(t,s){return!1}cleanup(){}}class rt extends Gt{constructor(t,s,i){super(t,s,i),this.defender=null,this.zone={center:k(),radius:1},this.game=t,this.setup()}setup(){const{game:t,kicker:s,markPos:i}=this,o=s.team==="home"?0:b,r=P(0,0,o),a=U(k(),i,r);a[1]=0,R(a,a);const n=12,h=10,c=M(i),d=I(k(),i,a,h);A(s.pos,d),A(s.vel,[0,0,0]),A(s.jogVel,[0,0,0]),A(s.joltVel,[0,0,0]),t.ball.carrier!==s&&t.ball.pickup(s),s.team==="home"&&(this.game.player=s),s.actionState="mark",s.stateTimer=1,this.defender=zt(s,t.players,i),this.defender&&(A(this.defender.pos,c),A(this.defender.vel,[0,0,0]),A(this.defender.jogVel,[0,0,0]),A(this.defender.joltVel,[0,0,0]),this.defender.actionState="mark",this.defender.stateTimer=10);for(const f of t.players){if(f===s||f===this.defender)continue;if(W(f.pos,i)<n+1){const l=U(k(),f.pos,i);R(l,l),I(f.pos,i,l,n+1.5+Math.random()*2)}}}update(t){super.update(t);const{kicker:s,markPos:i,game:o}=this,r=!o.ball.carried,a=U(k(),s.pos,i);a[1]=0;const n=s.team==="home"?0:b,h=U(k(),[0,0,n],i);h[1]=0,R(h,h);const c=J(a,h),d=P(-h[2],0,h[0]),f=Math.abs(J(a,d)),m=c>.05||f>2;(r||m)&&(this.finished=!0)}enforce(t,s){const{kicker:i,defender:o,markPos:r}=this,a=i.pos,n=ot(k(),r,a,.5),h=W(r,a)/2+5,c=W(t.pos,n);if(t===i){const d=i.actionState==="mark",f=c<=h+.5;return(d||f)&&(x(t.vel,0,0,0),x(t.jogVel,0,0,0),x(t.joltVel,0,0,0)),!1}if(t===o)return A(t.pos,o.pos),x(t.vel,0,0,0),x(t.jogVel,0,0,0),x(t.joltVel,0,0,0),!1;if(c<h&&t!==i&&t!==o){const d=W(t.pos,n),f=h-d;if(f>0){const m=U(k(),t.pos,n);m[1]=0;const l=H(m);if(l<.001?(x(m,Math.random()-.5,0,Math.random()-.5),R(m,m)):B(m,m,1/l),f<2){const p=f*10;return I(t.joltVel,t.joltVel,m,p*s),t.vel[0]*=.5,t.vel[2]*=.5,!0}else return I(t.pos,n,m,h+1.5),x(t.vel,0,0,0),x(t.jogVel,0,0,0),x(t.joltVel,0,0,0),!0}}return!1}}function Xt(e,t){const s=e.pos[0]-t.pos[0],i=e.pos[1]-t.pos[1],o=e.pos[2]-t.pos[2],r=s*s+i*i+o*o,[a,n]=e.collideBounds(),[h,c]=t.collideBounds(),d=.5*ut(e.collideBounds()),f=.5*ut(t.collideBounds()),m=d+f;return r<=m*m}class ft{constructor(t){this.pos=t,this.vel=[0,0,0],this.width=1.6,this.height=2.4,this.usesGravity=!0,this.gravity=[0,-9.8,0],this.bounces=!1,this.restitution=.4,this.floorY=0}setupForBoundary(t,s){}update(t,s){this.usesGravity&&I(this.vel,this.vel,this.gravity,t),I(this.pos,this.pos,this.vel,t),this.pos[1]<this.floorY&&(this.pos[1]=this.floorY,this.bounces&&Math.abs(this.vel[1])>.5?this.vel[1]=-this.vel[1]*this.restitution:this.vel[1]=0)}render(t){t.renderSprite(this.pos,this.width,this.height,1,0)}collidesWith(t){return Xt(this,t)}collideBounds(){return[.5,1.8]}}const vt={home:Object.freeze({idle:[[0,0,0]],run:[[1,0,0],[2,0,0],[3,0,0],[4,0,0],[5,0,0],[6,0,0]],kickRightFoot:[[1,0,0],[2,0,0]],kickLeftFoot:[[4,0,0],[5,0,0]],handpassRightHand:[[1,0,0],[0,0,0]],handpassLeftHand:[[4,0,0],[0,0,0]],jumpMark:[[1,0,0],[2,0,0],[0,0,0]],jumpSpoil:[[1,0,0],[2,0,0],[0,0,0]]}),away:Object.freeze({idle:[[0,4,0]],run:[[1,4,0],[2,4,0],[3,4,0],[4,4,0],[5,4,0],[6,4,0]],kickRightFoot:[[1,4,0],[2,4,0]],kickLeftFoot:[[4,4,0],[5,4,0]],handpassRightHand:[[1,4,0],[0,4,0]],handpassLeftHand:[[4,4,0],[0,4,0]],jumpMark:[[1,4,0],[2,4,0],[0,4,0]],jumpSpoil:[[1,4,0],[2,4,0],[0,4,0]]})};class Yt extends ft{constructor(t,s,i,o=!1){super(i),this.positionPos=M(i),this.name=t,this.team=s,this.playing=o,this.width=1.6,this.height=2.4,this.aiming=!1,this.jogVel=P(0,0,0),this.joltVel=P(0,0,0),this.jogSpeed=5,this.joltSpeed=2,this.energy=10,this.energyRecovery=0,this.statsWeight=85+Math.random()*10,this.statsStrength=50+Math.random()*30,this.statsSpeed=10+Math.random()*5,this.statsJump=10,this.statsKickRange=45,this.statsHandpassRange=20,this.statsAgility=10,this.joltDecayRate=8,this.animations=vt[s]??vt.home,this.animState="idle",this.actionState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=8,this.stateTimer=0,this.animSprite=P(0,0,0)}updateAI(t,s){const o=s.ball;let r=null;if(o.carried&&o.carrier===this)if(this.stateTimer+=t,this.stateTimer<1)r="run";else{let n=!1;for(const l of s.players)if(!(l===this||l.team===this.team)&&D(l.pos,this.pos)<7){n=!0;break}const h=s.players.filter(l=>l.team===this.team&&l!==this);if(n){let l=null,p=-1/0;const u=P(0,0,this.team==="home"?-1:1);for(const g of h){if(g===this)continue;const T=D(this.pos,g.pos);if(T>40)continue;let y=!1;for(const F of s.players)if(F.team!==this.team&&D(F.pos,g.pos)<5){y=!0;break}if(y)continue;const S=k();K(S,g.pos,this.pos),R(S,S);const w=J(u,S),v=M(g.vel);v[1]=0;const _=J(u,v),L=Math.abs(T-15)*.2,V=15*w+2*_-L;V>p&&(p=V,l=g)}if(l){const g=U(k(),l.pos,this.pos),T=[g[0],g[2]];return this.tryDisposeBall(s,{kickReleased:!0,kickHeldTime:H(g)>20?.5:.1,aimTarget:T})??"run"}}const d=this.team==="home"?-5:b+5,f=0;if(Math.abs(this.pos[2]-d)<=this.statsKickRange){const l=P(f,0,d),p=(Math.random()-.5)*9;l[0]+=p;const u=U(k(),l,this.pos),g=[u[0],u[2]];return this.tryDisposeBall(s,{kickReleased:!0,kickHeldTime:.4,aimTarget:g})??"run"}if(n||this.stateTimer>5){let l=null,p=-1/0;for(const u of h){const g=D(this.pos,u.pos);if(g>this.statsKickRange)continue;const T=this.team==="home"?-1:1,y=(u.pos[2]-this.pos[2])*T,S=Math.abs(u.pos[0]-this.pos[0]),w=y-S-g;w>p&&(p=w,l=u)}if(l){const u=U(k(),l.pos,this.pos),g=[u[0],u[2]];return this.tryDisposeBall(s,{kickReleased:!0,kickHeldTime:.4,aimTarget:g})??"run"}}r="run"}let a=null;if(o.carried&&o.carrier===this){const n=this.team==="home"?-1:1,h=P(0,0,n);let c=k();for(const f of s.players){if(f===this||f.team===this.team)continue;const m=k();K(m,this.pos,f.pos),m[1]=0;const l=H(m);if(l<5&&l>.5){const p=1/l;R(m,m),I(c,c,m,p)}}const d=k();C(d,h,c),R(d,d),a=M(this.pos),I(a,a,d,10)}else if(o.carried)if(o.carrier&&o.carrier.team!==this.team&&D(o.pos,this.pos)<=15&&this.energy>0&&s.chasers<3)a=M(o.pos),s.chasers++;else if(o.carrier&&o.carrier.team===this.team&&D(o.pos,this.pos)>5&&this.energy>.3&&s.followers<3){s.followers++;const n=M(o.carrier.jogVel);H(n)<.01&&(n[2]=this.team==="home"?-1:1),R(n,n);const h=P(-n[2],0,n[0]);R(h,h);let c=0,d=12;switch(this.name){case"wing":c=12*(this.team==="home"?-1:1),d=15;break;case"forward":c=6,d=18;break;case"half-forward":case"half-back":c=4,d=10;break;case"center":case"mid":c=0,d=10;break;case"back":default:c=-6,d=8;break}const f=M(o.carrier.pos);I(f,f,n,d),I(f,f,h,c),a=f}else a=this.positionPos??this.pos;else if(o.pos[1]>.1||o.vel[1]>.1){const n=o.gravity[1]??-9.8,h=o.vel[1],c=o.pos[1],d=.5*n,f=h,m=c;let l=0;const p=f*f-4*d*m;if(p>=0&&Math.abs(d)>1e-5){const g=Math.sqrt(p),T=(-f+g)/(2*d),y=(-f-g)/(2*d);l=Math.max(T,y)}const u=k();I(u,o.pos,o.vel,l),u[1]=0,D(u,this.pos)<=35?a=u:a=this.positionPos??this.pos}else D(o.pos,this.pos)<=25?a=o.pos:a=this.positionPos??this.pos;if(a){const n=k();if(K(n,a,this.pos),n[1]=0,At(n)>1e-4){R(n,n),B(this.joltVel,n,this.joltSpeed);const c=k();H(this.jogVel)>1e-4?(R(c,this.jogVel),ot(c,c,n,.15),R(c,c),B(this.jogVel,c,this.jogSpeed)):B(this.jogVel,n,this.jogSpeed)}}this.energy>0?(C(this.vel,this.jogVel,this.joltVel),this.energy-=t):(I(this.vel,this.jogVel,this.joltVel,.5),this.energyRecovery+=t,this.energyRecovery>=10&&(this.energy=10,this.energyRecovery=0)),B(this.joltVel,this.joltVel,Math.exp(-this.joltDecayRate*t)),this.checkPlayerCollisions(t,s),super.update(t,s);for(const n of s.players){if(n===this||!o.carried||o.carrier!==n||n.team===this.team||!this.collidesWith(n)||n.actionState==="tackleDisposal")continue;const h=k();K(h,n.pos,this.pos),h[1]=0,R(h,h);const c=M(this.jogVel);if(c[1]=0,H(c)<1e-4)continue;R(c,c);const d=J(c,h),f=D(this.pos,n.pos);if(d>.5&&f<1.5){r="tackle",this.stateTimer=1,n.actionState="tackleDisposal",n.stateTimer=1;break}}if(!o.carried&&o.collidesWith(this)&&r===null){const n=o.lastTouchedType==="kick"&&!o.hasBounced&&o.lastTouchedBy!==this&&D(o.pos,o.origin)>=10;if(o.pickup(this),r=n?"mark":"pickup",n&&(s.setPiece=new rt(s,this,M(o.pos)),this.stateTimer=0),this.team==="home")return s.player=this,this.aiming=!1,null}return r||(r=H(this.vel)>1e-4?"run":"idle"),r}collideBounds(){return[.5,1.8]}get stunned(){return this.actionState==="tackle"||this.actionState==="tackled"}updateHuman(t,s){const i=s.controls,o=s.ball;let{kickPressed:r,kickReleased:a,kickHeldTime:n,moveX:h,moveZ:c,aimTarget:d}=i.state;const f=1e-4;let m=null;if((h!==0||c!==0)&&!this.aiming){const l=P(h,0,c);R(l,l);const p=P(h,0,c);if(Dt(p)>f){R(p,p),B(this.joltVel,p,this.joltSpeed);const u=k();H(this.jogVel)>f?(R(u,this.jogVel),ot(u,u,l,.15),R(u,u),B(this.jogVel,u,this.jogSpeed)):B(this.jogVel,l,this.jogSpeed)}}if(this.energy>0?(C(this.vel,this.jogVel,this.joltVel),this.energy-=t):(C(this.vel,this.jogVel,B(this.joltVel,this.joltVel,.5)),this.energyRecovery+=t,this.energyRecovery>=10&&(this.energy=10,this.energyRecovery=0)),B(this.joltVel,this.joltVel,Math.exp(-this.joltDecayRate*t)),this.checkPlayerCollisions(t,s),super.update(t,s),!o.carried&&o.collidesWith(this)){const l=o.lastTouchedType==="kick"&&!o.hasBounced&&o.lastTouchedBy!==this;o.pickup(this),m=l?"mark":"pickup",l&&(s.setPiece=new rt(s,this,M(o.pos)),this.stateTimer=0,this.aiming=!1)}if(o.carried&&o.carrier===this&&(r&&(this.aiming=!0),m=this.tryDisposeBall(s,{kickReleased:i.state.kickReleased,kickHeldTime:i.state.kickHeldTime,aimTarget:i.state.aimTarget,moveVec:h!==0||c!==0?P(h,0,c):M(this.jogVel)}),o.carried||(this.aiming=!1)),this.aiming){const l=ht(0,0);d&&ct(l,l,d),s.aimTarget.setPosition([this.pos[0]+l[0],.002,this.pos[2]+l[1]])}else s.aimTarget.setPosition(P(this.pos[0],.002,this.pos[2]+.8));return!m&&this.actionState!=="run"&&this.actionState!=="idle"&&(m=H(this.vel)>f?"run":"idle"),m}tryDisposeBall(t,s){const i=t.ball;if(!i.carried||i.carrier!==this)return null;const{kickReleased:o,kickHeldTime:r}=s;let{aimTarget:a}=s;if(!o)return null;const n=r<.25;if(n&&!a){const y=s.moveVec??M(this.jogVel);if(H(y)===0){const v=this.team==="home"?-1:1;x(y,0,0,v)}R(y,y);let S=null,w=-1/0;for(const v of t.players){if(v.team!==this.team||v===this||v.stunned)continue;const _=U(k(),v.pos,this.pos),L=H(_);if(L>30)continue;const V=R(k(),_),F=J(y,V);if(F<=0)continue;let Z=0;for(const O of t.players){if(O.team===this.team||O===v||O.stunned)continue;W(O.pos,v.pos)<=10&&Z++}const $=.5*Z,Y=F*2-L/30-$;Y>w&&(w=Y,S=v)}if(S){const v=U(k(),S.pos,this.pos);a=[v[0],v[2]]}else a=[y[0]*10,y[2]*10]}if(!a)return null;const h=ht(0,0);ct(h,h,a);const c=Rt(h);if(c<.1)return null;const d=-this.gravity[1],f=(n?12.5:30)*Math.PI/180,m=Math.sin(2*f),l=Math.sqrt(c*d/m),p=P(h[0],0,h[1]);R(p,p);const u=P(p[0]*Math.cos(f),Math.sin(f),p[2]*Math.cos(f));return i.launch(u,l),i.lastTouchedType=n?"handpass":"kick",i.hasBounced=!1,this.stateTimer=.5,n?"handpass":"kick"}update(t,s){let i=!1;if(s.setPiece&&(i=s.setPiece.enforce(this,t)),s.ball.carried||(this.aiming=!1),!this.playing)return;if(this.actionState==="pickup"&&(this.actionState="run"),this.actionState==="mark")if(this.stateTimer-=t,this.stateTimer<=0||s.setPiece===null)this.actionState="idle",this.stateTimer=0;else{if(x(this.vel,0,0,0),x(this.jogVel,0,0,0),x(this.joltVel,0,0,0),this===s.player){const a=s.controls.state.aimTarget;if(this.aiming){const n=ht(0,0);a&&ct(n,n,a),s.aimTarget.setPosition([this.pos[0]+n[0],.002,this.pos[2]+n[1]])}else s.aimTarget.setPosition(P(this.pos[0],.002,this.pos[2]+.8))}this.updateAnimation(t,null,s.ball);return}if(this.actionState==="tackleDisposal"){if(A(this.vel,[0,0,0]),this.stateTimer-=t,s.player===this&&s.controls.state.kickReleased&&(this.tryDisposeBall(s,s.controls.state),this.actionState="handpass",this.stateTimer=.5),s.player!==this){const r=.5-this.stateTimer,a=.5+(this.statsStrength-50)*.01,n=r/a*(.5+(this.statsStrength-50)/100);Math.random()<n*t*2&&this.tryDisposeBall(s,{kickReleased:!0,kickHeldTime:.1,aimTarget:null,moveVec:k()})}if(this.stateTimer<=0){const r=s.ball;r.carried=!1,r.carrier=null,A(r.pos,this.pos),x(r.vel,0,0,0),r.lastTouchedType="spill",r.hasBounced=!1,this.actionState="tackled",this.stateTimer=1}this.updateAnimation(t,null,s.ball),s.aimTarget.setPosition(P(this.pos[0],.002,this.pos[2]+.8));return}if(this.actionState==="tackled"||this.actionState==="tackle"||this.actionState==="kick"||this.actionState==="handpass"){this.vel=P(0,0,0),this.stateTimer-=t,this.stateTimer<=0&&(this.actionState="idle",this.stateTimer=0),this.updateAnimation(t,null,s.ball);return}let o=null;i||(s.player===this?o=this.updateHuman(t,s):o=this.updateAI(t,s)),this.updateAnimation(t,o,s.ball),o!==null&&(this.actionState=o)}updateAnimation(t,s,i){const o=this.animations[this.animState];if(o.length===0)return;this.animTimer+=t;const r=1/this.animFPS;this.animTimer>=r&&(this.animTimer-=r,this.animFrame=this.animFrame+1),s==="kick"&&(this.animState="kickRightFoot",this.animFrame=0,this.animTimer=0),this.animState==="run"&&D(this.vel,[0,0,0])===0&&(this.animState="idle",this.animFrame=0,this.animTimer=0),this.animState==="idle"&&D(this.vel,[0,0,0])!==0&&(this.animState="run",this.animFrame=0,this.animTimer=0);const a=this.animState==="run"||this.animState==="idle";this.animFrame>=o.length&&(this.animFrame=a?0:o.length-1,a||(this.animState="run",this.animFrame=0,this.animTimer=0));const n=this.animations[this.animState];this.animSprite=M(n[this.animFrame])??P(0,0,0),(this.vel[2]>0?"away":this.vel[2]<0?"home":this.pos[2]<i.pos[2]?"away":"home")==="away"&&(this.animSprite[0]+=7)}render(t){const[s,i,o]=this.animSprite;t.renderSprite(this.pos,this.width,this.height,s,i)}checkPlayerCollisions(t,s){for(const i of s.players)if(!(i===this||!i.playing)&&this.collidesWith(i)){const o=k();K(o,this.pos,i.pos),o[1]=0;const r=H(o);r<1e-4?(o[0]=Math.random()-.5,o[2]=Math.random()-.5,R(o,o)):B(o,o,1/r);const a=(this.width+i.width)/2-r;if(a<=0)continue;const n=this.statsWeight,h=i.statsWeight,c=n+h,d=k();B(d,o,a);const f=k(),m=k();B(f,d,h/c),B(m,d,n/c),this.pos[0]+=f[0],this.pos[2]+=f[2],i.pos[0]-=m[0],i.pos[2]-=m[2]}}setupForBoundary(t,s){t==="behindAway"&&this.team==="home"&&this.name==="FB"?(A(this.pos,[0,0,b-5]),A(this.jogVel,[0,0,0]),A(this.joltVel,[0,0,0]),this.actionState="idle",this.stateTimer=0):t==="behindAway"&&this.team==="away"&&this.name==="FF"?A(this.pos,[0,0,b-25]):t==="behindHome"&&this.team==="away"&&this.name==="FB"?(A(this.pos,[0,0,5]),A(this.jogVel,[0,0,0]),A(this.joltVel,[0,0,0]),this.actionState="idle",this.stateTimer=0):t==="behindHome"&&this.team==="home"&&this.name==="FF"?A(this.pos,[0,0,25]):A(this.pos,this.positionPos)}}class qt extends ft{constructor(t){super(t),this.carried=!1,this.origin=k(),this.carrier=null,this.width=1.6,this.height=2.4,this.bounces=!0,this.animations=Object.freeze({idle:[[0,1,0]],backSpin:[[1,1,0],[2,1,0],[3,1,0],[4,1,0],[5,1,0],[6,1,0],[7,1,0],[8,1,0]],forwardSpin:[[8,1,0],[7,1,0],[6,1,0],[5,1,0],[4,1,0],[3,1,0],[2,1,0],[1,1,0]],backSpinRight:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]],backSpinLeft:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinRight:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinLeft:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]]}),this.animState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=12,this.lastTouchedBy=null,this.lastTouchedType=null,this.hasBounced=!1}update(t,s){if(this.carried&&this.carrier){const i=P(0,.5,this.carrier.vel[2]>0?.2:-.2),o=M(this.carrier.pos);C(this.pos,o,i)}else{const i=this.vel[1]<0;super.update(t,s),this.hasBounced=this.hasBounced||i&&this.vel[1]>0&&this.pos[1]<=this.floorY,this.pos[1]<=this.floorY&&B(this.vel,this.vel,.97)}this.updateAnimation(t)}collideBounds(){return[.4,.5]}pickup(t){this.carried=!0,this.carrier=t,this.lastTouchedBy=t,this.lastTouchedType=null,this.hasBounced=!1,this.origin=M(this.pos),x(this.pos,t.pos[0],t.pos[1],t.pos[2]-1),x(this.vel,0,0,0)}launch(t,s,i="kick"){this.carried=!1,this.carrier=null,B(this.vel,t,s),this.lastTouchedType=i,this.hasBounced=!1}updateAnimation(t){this.animTimer+=t;const s=1/this.animFPS;this.animTimer>=s&&(this.animTimer-=s,this.animFrame=this.animFrame+1);const i=this.animState;this.carried?this.animState="idle":this.lastTouchedType==="kick"&&!this.hasBounced?this.animState=this.vel[2]<0?"backSpin":"forwardSpin":this.lastTouchedType==="handpass"&&!this.hasBounced?this.animState=this.vel[2]<0?"backSpinRight":"forwardSpinLeft":this.hasBounced?Math.abs(this.vel[1])<.05&&this.pos[1]<=this.floorY+.01?this.animState="idle":this.animState=this.vel[2]<0?"forwardSpin":"backSpin":this.animState="idle",this.animState!==i&&(this.animFrame=0,this.animTimer=0);const o=this.animations[this.animState];o.length!==0&&this.animFrame>=o.length&&(this.animFrame=0)}render(t){var a;const s=(a=this.animations)==null?void 0:a[this.animState],[i,o,r]=(s==null?void 0:s[this.animFrame])??[0,1,void 0];t.renderSprite(this.pos,this.width,this.height,i,o);{const n=t.gl;n.useProgram(t.program),n.bindVertexArray(t.quadVao);const[h,c]=[2,3],d=h/t.sheetCols,f=c/t.sheetRows,m=(h+1)/t.sheetCols,l=(c+1)/t.sheetRows;n.uniform4f(t.uTileUV,d,f,m,l);const p=z();Q(p,p,[this.pos[0],.001,this.pos[2]]),Pt(p,p,-Math.PI/2),it(p,p,[2,2,1]),n.uniformMatrix4fv(t.uModel,!1,p),n.drawElements(n.TRIANGLES,6,n.UNSIGNED_SHORT,0)}}setupForBoundary(t,s){if(this.carried=!1,this.carrier=null,t==="goalAway"||t==="goalHome")A(this.pos,[0,0,b/2]),A(this.vel,[0,15,0]),this.lastTouchedType="tap",this.lastTouchedBy=null,this.origin=M(this.pos);else if(t==="behindAway")A(this.pos,[0,0,b-6]);else if(t==="behindHome")A(this.pos,[0,0,6]);else{this.pos[1]=0,A(this.pos,s);const i=k();I(i,[0,b/2,b/2],s,-1),R(i,i),this.launch(i,15,"tap")}}}class Wt{constructor(t=[0,.001,0]){this.pos=M(t),this.size=2,this.spriteCoord=[0,3]}setPosition(t){this.pos[0]=t[0],this.pos[2]=t[2]}render(t){const s=t.gl;s.useProgram(t.program),s.bindVertexArray(t.quadVao);const[i,o]=this.spriteCoord,r=i/t.sheetCols,a=o/t.sheetRows,n=(i+1)/t.sheetCols,h=(o+1)/t.sheetRows;s.uniform4f(t.uTileUV,r,a,n,h);const c=z();Q(c,c,[this.pos[0],.002,this.pos[2]]),Pt(c,c,-Math.PI/2),it(c,c,[this.size,this.size,1]),s.uniformMatrix4fv(t.uModel,!1,c),s.drawElements(s.TRIANGLES,6,s.UNSIGNED_SHORT,0)}}function yt(e,t,s){const i=(n,h)=>{const c=e.createShader(h);if(!c)throw new Error("Failed to create shader");if(e.shaderSource(c,n),e.compileShader(c),!e.getShaderParameter(c,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(c));return c},o=i(t,e.VERTEX_SHADER),r=i(s,e.FRAGMENT_SHADER),a=e.createProgram();if(e.attachShader(a,o),e.attachShader(a,r),e.linkProgram(a),!e.getProgramParameter(a,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(a));return a}async function Zt(e){const t=new Image;return t.src=e,await t.decode(),t}function $t(e,t,s,i=1){const a=e*2/1.6/i,n=t*2/2/i,h=[0,0,0,.5,.5],c=[];for(let d=0;d<=s;d++){const f=d/s*2*Math.PI,m=Math.cos(f)*e,l=Math.sin(f)*t,p=m/(e*2)*a+.5,u=l/(t*2)*n+.5;h.push(m,0,l,p,u),d>0&&c.push(0,d,d+1)}return{vertices:new Float32Array(h),indices:new Uint16Array(c)}}function Kt(e=160,t=170,s=50,i=50,o=.4){const r=[],a=[];let n=0;const h=(u,g,T,y,S)=>{const w=T-u,v=y-g,_=Math.hypot(w,v),L=-v/_,V=w/_,F=S/2,Z=u+L*F,$=g+V*F,Y=u-L*F,O=g-V*F,et=T+L*F,q=y+V*F,Mt=T-L*F,_t=y-V*F;r.push(Z,0,$,et,0,q,Mt,0,_t,Y,0,O),a.push(n,n+1,n+2,n,n+2,n+3),n+=4},c=e/2,d=t/2,f=64;for(let u=0;u<f;u++){const g=u/f*2*Math.PI,T=(u+1)/f*2*Math.PI,y=Math.cos(g)*c,S=Math.sin(g)*d,w=Math.cos(T)*c,v=Math.sin(T)*d;h(y,S,w,v,o)}const m=[[-i/2,-i/2],[i/2,-i/2],[i/2,i/2],[-i/2,i/2]];for(let u=0;u<4;u++){const[g,T]=m[u],[y,S]=m[(u+1)%4];h(g,T,y,S,o)}function l(u){const g=u>0?-1:1,T=[];for(let y=0;y<=1e3;y++){const S=-Math.PI+y/1e3*2*Math.PI,w=Math.sin(S)*s,v=u+g*Math.cos(S)*s,_=w/c,L=v/d;_*_+L*L<=1&&T.push(S)}return T.length===0?[-Math.PI/3,Math.PI/3]:[T[0],T[T.length-1]]}const p=40;for(let u of[-t/2,t/2]){const g=u>0?-1:1,[T,y]=l(u);for(let S=0;S<p;S++){const w=T+S/p*(y-T),v=T+(S+1)/p*(y-T),_=Math.sin(w)*s,L=u+g*Math.cos(w)*s,V=Math.sin(v)*s,F=u+g*Math.cos(v)*s;h(_,L,V,F,o)}}return{vertices:new Float32Array(r),indices:new Uint16Array(a)}}const tt=170,Qt=80,kt=tt/2;class Jt{constructor(t,s,i){this.gl=t,this.canvas=s,this.spriteSheet=i,this.sheetCols=32,this.sheetRows=32,this.setupMainProgram(),this.setupLineProgram(),this.setupSpriteGeometry(),this.setupField(),this.setupGoalposts(),this.setupCamera(),this.setupSpritesheet(),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL)}setupSpritesheet(){const t=this.gl;t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.spriteSheet),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.texture)}setupMainProgram(){const t=`#version 300 es
      in vec3 a_position;
      in vec2 a_texcoord;
      uniform mat4 u_projection, u_view, u_model;
      out vec2 v_texcoord;
      void main() {
        gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
        v_texcoord = a_texcoord;
      }`,s=`#version 300 es
precision mediump float;

uniform sampler2D u_texture;
uniform vec4 u_tileUV;

in vec2 v_texcoord;
out vec4 outColor;

void main() {
  vec2 tileUV = mod(v_texcoord, 1.0);
  vec2 texCoord = mix(u_tileUV.xy, u_tileUV.zw, tileUV);
  vec4 texColor = texture(u_texture, texCoord);

  if (texColor.a < 0.01) discard; // Skip fully transparent fragments

  outColor = texColor;
}
`;this.program=yt(this.gl,t,s),this.uProjection=this.gl.getUniformLocation(this.program,"u_projection"),this.uView=this.gl.getUniformLocation(this.program,"u_view"),this.uModel=this.gl.getUniformLocation(this.program,"u_model"),this.uTileUV=this.gl.getUniformLocation(this.program,"u_tileUV"),this.uTexture=this.gl.getUniformLocation(this.program,"u_texture"),this.aPos=this.gl.getAttribLocation(this.program,"a_position"),this.aUV=this.gl.getAttribLocation(this.program,"a_texcoord")}setupLineProgram(){const t=`#version 300 es
    in vec3 a_position;
    uniform mat4 u_projection;
    uniform mat4 u_view;
    uniform mat4 u_model;
    void main() {
    gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
    }`,s=`#version 300 es
    precision mediump float;
    out vec4 outColor;
    void main() {
    outColor = vec4(1, 1, 1, 1);
    }`;this.lineProgram=yt(this.gl,t,s),this.lineProj=this.gl.getUniformLocation(this.lineProgram,"u_projection"),this.lineView=this.gl.getUniformLocation(this.lineProgram,"u_view"),this.lineModel=this.gl.getUniformLocation(this.lineProgram,"u_model"),this.linePos=this.gl.getAttribLocation(this.lineProgram,"a_position")}setupSpriteGeometry(){const t=this.gl;t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.depthMask(!0);const s=new Float32Array([-.5,0,0,1,.5,0,1,1,.5,1,1,0,-.5,1,0,0]),i=new Uint16Array([0,1,2,0,2,3]);this.quadVao=this.gl.createVertexArray(),this.gl.bindVertexArray(this.quadVao);const o=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o),this.gl.bufferData(this.gl.ARRAY_BUFFER,s,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.aPos,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(this.aPos),this.gl.vertexAttribPointer(this.aUV,2,this.gl.FLOAT,!1,16,8),this.gl.enableVertexAttribArray(this.aUV);const r=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,i,this.gl.STATIC_DRAW)}setupField(){const t=this.gl,{vertices:s,indices:i}=$t(Qt,kt,64,16);this.fieldVao=this.gl.createVertexArray(),this.gl.bindVertexArray(this.fieldVao);const o=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o),this.gl.bufferData(this.gl.ARRAY_BUFFER,s,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.aPos,3,this.gl.FLOAT,!1,20,0),this.gl.enableVertexAttribArray(this.aPos),this.gl.vertexAttribPointer(this.aUV,2,this.gl.FLOAT,!1,20,12),this.gl.enableVertexAttribArray(this.aUV);const r=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,i,this.gl.STATIC_DRAW),this.fieldIndices=i.length,this.fieldLineMesh=Kt(),this.lineVao=t.createVertexArray(),t.bindVertexArray(this.lineVao);const a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,this.fieldLineMesh.vertices,t.STATIC_DRAW);const n=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.fieldLineMesh.indices,t.STATIC_DRAW),t.vertexAttribPointer(this.linePos,3,t.FLOAT,!1,12,0),t.enableVertexAttribArray(this.linePos)}setupGoalposts(){this.goalPostPositions=[[-9,0,tt],[-3,0,tt],[3,0,tt],[9,0,tt],[-9,0,0],[-3,0,0],[3,0,0],[9,0,0]]}setupCamera(){this.projection=z(),Lt(this.projection,Math.PI/4,this.canvas.width/this.canvas.height,.1,1e3),this.view=z(),this.model=z()}renderSprite(t,s,i,o,r){const{gl:a,program:n,quadVao:h,uModel:c,uTileUV:d,sheetCols:f,sheetRows:m}=this;a.useProgram(n),a.bindVertexArray(h);const l=z();Q(l,l,t),it(l,l,[s,i,1]),a.uniformMatrix4fv(c,!1,l);const p=o/f,u=r/m,g=(o+1)/f,T=(r+1)/m;a.uniform4f(d,p,u,g,T),a.drawElements(a.TRIANGLES,6,a.UNSIGNED_SHORT,0)}renderScene(t,s){const i=this.gl;i.viewport(0,0,this.canvas.width,this.canvas.height),i.clearColor(.2,.6,.2,1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);const o=P(0,10,15),r=k();C(r,t.cameraTarget,o);const a=P(0,0,-20),n=k();C(n,t.cameraTarget,a),Bt(this.view,r,n,[0,1,0]),i.useProgram(this.program),i.uniformMatrix4fv(this.uProjection,!1,this.projection),i.uniformMatrix4fv(this.uView,!1,this.view),i.activeTexture(i.TEXTURE0),i.uniform1i(this.uTexture,0),i.bindVertexArray(this.fieldVao),St(this.model),Q(this.model,this.model,[0,0,kt]),i.uniformMatrix4fv(this.uModel,!1,this.model);const h=0,c=2,d=h/this.sheetCols,f=c/this.sheetRows,m=(h+1)/this.sheetCols,l=(c+1)/this.sheetRows;i.uniform4f(this.uTileUV,d,f,m,l),i.drawElements(i.TRIANGLES,this.fieldIndices,i.UNSIGNED_SHORT,0),i.useProgram(this.lineProgram),i.uniformMatrix4fv(this.lineProj,!1,this.projection),i.uniformMatrix4fv(this.lineView,!1,this.view);const p=z();Q(p,this.model,[0,.001,0]),i.uniformMatrix4fv(this.lineModel,!1,p),i.bindVertexArray(this.lineVao),i.drawElements(i.TRIANGLES,this.fieldLineMesh.indices.length,i.UNSIGNED_SHORT,0),i.useProgram(this.program),i.bindVertexArray(this.quadVao);const u=1,g=2,T=u/this.sheetCols,y=g/this.sheetRows,S=(u+1)/this.sheetCols,w=(g+1)/this.sheetRows;i.uniform4f(this.uTileUV,T,y,S,w);for(let v=0;v<this.goalPostPositions.length;v++){const[_,L,V]=this.goalPostPositions[v],Z=v%4===0||v%4===3?6:10,$=r[0]-_,Y=r[2]-V,O=Math.sqrt($*$+Y*Y),et=O>50?1.5:O>150?2:1,q=z();Q(q,q,[_,L,V]),it(q,q,[et,Z,1]),i.uniformMatrix4fv(this.uModel,!1,q),i.drawElements(i.TRIANGLES,6,i.UNSIGNED_SHORT,0)}i.bindVertexArray(this.quadVao);for(const v of s)v instanceof ft?v.render(this):this.renderSprite(v.pos,v.width,v.height,1,0);t.aimTarget.render(this)}}var X,wt,Et,bt;class te{constructor(t){mt(this,X);this.state={moveX:0,moveZ:0,kickPressed:!1,kickReleased:!1,kickHeldTime:0,aimTarget:null},this.keys={},this.lastKeys={},this.touchMove=null,this.touchAim=null,this.kPressTime=0,t.addEventListener("touchstart",st(this,X,wt).bind(this),{passive:!1}),t.addEventListener("touchmove",st(this,X,Et).bind(this),{passive:!1}),t.addEventListener("touchend",st(this,X,bt).bind(this)),window.addEventListener("keydown",s=>this.keys[s.key.toLowerCase()]=!0),window.addEventListener("keyup",s=>this.keys[s.key.toLowerCase()]=!1)}endUpdate(){this.state.moveX=0,this.state.moveZ=0,this.state.kickPressed=!1,this.state.kickReleased=!1}update(t){var r;const s=!!this.keys.k,i=!!this.lastKeys.k;if(s&&!i&&(this.state.kickPressed=!0,this.kPressTime=0,this.state.aimTarget=[0,0]),s?(this.kPressTime+=t,this.state.aimTarget&&(this.keys.a&&(this.state.aimTarget[0]-=30*t),this.keys.d&&(this.state.aimTarget[0]+=30*t),this.keys.w&&(this.state.aimTarget[1]-=30*t),this.keys.s&&(this.state.aimTarget[1]+=30*t))):(this.keys.a&&(this.state.moveX-=1),this.keys.d&&(this.state.moveX+=1),this.keys.w&&(this.state.moveZ-=1),this.keys.s&&(this.state.moveZ+=1)),!s&&i&&(this.state.kickReleased=!0),this.state.kickHeldTime=this.kPressTime,this.touchMove&&!this.touchAim&&(this.state.moveX=this.touchMove.dx/50,this.state.moveZ=this.touchMove.dy/50),this.touchAim){this.kPressTime+=t;const a=this.touchAim.dx,n=this.touchAim.dy;console.log("Touch aim:",a,n);const h=10;this.state.aimTarget=[-a/h,-n/h],this.state.kickHeldTime=this.kPressTime}const o=(r=navigator.getGamepads)==null?void 0:r.call(navigator)[0];if(o){this.state.moveX+=o.axes[0]||0,this.state.moveZ+=-(o.axes[1]||0);const a=o.axes[2]||0,n=-(o.axes[3]||0),h=Math.hypot(a,n);h>.2&&(this.state.aimTarget=[a/h,n/h])}this.lastKeys={...this.keys}}getState(){return this.state}}X=new WeakSet,wt=function(t){t.preventDefault();for(const s of t.changedTouches)s.clientX<window.innerWidth/2?this.touchMove={id:s.identifier,startX:s.clientX,startY:s.clientY,dx:0,dy:0}:(this.touchAim={id:s.identifier,startX:s.clientX,startY:s.clientY,dx:0,dy:0},this.state.kickPressed=!0,this.kPressTime=0)},Et=function(t){t.preventDefault();for(const s of t.changedTouches)this.touchMove&&s.identifier===this.touchMove.id&&(this.touchMove.dx=s.clientX-this.touchMove.startX,this.touchMove.dy=s.clientY-this.touchMove.startY),this.touchAim&&s.identifier===this.touchAim.id&&(this.touchAim.dx=s.clientX-this.touchAim.startX,this.touchAim.dy=s.clientY-this.touchAim.startY)},bt=function(t){t.preventDefault();for(const s of t.changedTouches)this.touchAim&&s.identifier===this.touchAim.id&&(this.touchAim=null,this.state.kickReleased=!0),this.touchMove&&s.identifier===this.touchMove.id&&(this.touchMove=null)};class ee{constructor(t,s){if(this.canvas=t,this.gl=t.getContext("webgl2"),!this.gl)throw new Error("WebGL2 not supported");this.renderer=new Jt(this.gl,t,s),this.controls=new te(t),this.setPiece=null,this.entities=[],this.aimTarget=new Wt([5,.001,b/2]),this.ball=new qt(P(0,0,b/2)),this.entities.push(this.ball),this.players=[],this.chasers=0,this.followers=0,this.homePositions=Tt(),this.awayPositions=Tt(!0);const i=[[this.homePositions,"home"],[this.awayPositions,"away"]];for(let[o,r]of i)for(const[a,n]of Object.entries(o)){const h=new Yt(a,r,n,!a.toLowerCase().startsWith("bench"));this.entities.push(h),this.players.push(h),a==="RR"&&r==="home"&&(this.player=h)}this.cameraTarget=P(0,10,b/2),this.cameraPos=P(0,10,b/2+15),this.resize(),window.addEventListener("resize",()=>this.resize()),this.lastTime=performance.now()}start(){this.lastTime=performance.now(),requestAnimationFrame(this.loop.bind(this))}loop(t){var r,a;const s=(t-this.lastTime)/1e3,i=Math.min(s,1/30);this.lastTime=t,this.controls.update(i),this.chasers=0,this.followers=0;const o=M(this.ball.pos);for(const n of this.entities)n.update(i,this);if(this.setPiece&&(this.setPiece.update(i),this.setPiece.finished&&(this.setPiece=null)),!this.setPiece){let n=Nt(o,this.ball.pos);if(n!==null){if(n==="goalAway"&&(this.ball.lastTouchedType!=="kick"||((r=this.ball.lastTouchedBy)==null?void 0:r.team)==="home")?n="behindAway":n==="goalHome"&&(this.ball.lastTouchedType!=="kick"||((a=this.ball.lastTouchedBy)==null?void 0:a.team)==="away")?n="behindHome":n==="innerLeftPostAway"||n==="innerRightPostAway"?n="behindAway":(n==="innerLeftPostHome"||n==="innerRightPostHome")&&(n="behindHome"),n==="behindAway"){const h=this.players.find(c=>c.name==="FB"&&c.team==="home");h&&(this.setPiece=new rt(this,h,P(0,0,b-10)))}if(n==="behindHome"){const h=this.players.find(c=>c.name==="FB"&&c.team==="away");h&&(this.setPiece=new rt(this,h,P(0,0,10)))}if(n==="goalAway"||n==="goalHome"||n==="outOfBounds")for(const h of this.entities)h.setupForBoundary(n,this.ball.pos)}}this.updateCameraTarget(),this.updatePlayerControl(),this.renderer.renderScene(this,this.entities),this.controls.endUpdate(),requestAnimationFrame(this.loop.bind(this))}updatePlayerControl(){const t=this.players.filter(r=>r.team==="home"),s=this.ball.carrier;if(!s||s&&s.team==="home")return;let i=null,o=1/0;for(const r of t){if(r.actionState==="tackle")continue;const a=Vt(r.pos,s.pos),n=(Math.abs(r.positionPos[0]-this.ball.pos[0])<10?-10:0)+(r.energy<.3?-5:0)+(r.pos[2]>s.pos[2]?-10:0);a+n<o&&(i=r,o=a+n)}i&&(this.player=i,this.player.aiming=!1)}updateCameraTarget(){const t=this.ball,s=t.carrier,i=P(0,0,25),o=s?s.team==="home"?s.pos:C(k(),s.pos,i):C(k(),t.pos,i),r=D(this.cameraTarget,o),a=Math.max(1/(1+3*r),.05);ot(this.cameraTarget,this.cameraTarget,o,a)}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.renderer.setupCamera()}}const se="/footy/assets/spritesheet-erFZxRaO.png";function ie(e){const t=document.getElementById("glcanvas");if(!t)throw console.error("Canvas element not found"),new Error("Canvas element not found");new ee(t,e).start()}Zt(se).then(e=>{if(!e.complete)throw console.error("Failed to load sprite sheet"),new Error("Sprite sheet not loaded");ie(e)});
