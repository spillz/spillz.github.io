var re=Object.defineProperty;var vt=h=>{throw TypeError(h)};var he=(h,t,e)=>t in h?re(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var m=(h,t,e)=>he(h,typeof t!="symbol"?t+"":t,e),oe=(h,t,e)=>t.has(h)||vt("Cannot "+e);var St=(h,t,e)=>t.has(h)?vt("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(h):t.set(h,e);var J=(h,t,e)=>(oe(h,t,"access private method"),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();var at=1e-6,X=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var h=0,t=arguments.length;t--;)h+=arguments[t]*arguments[t];return Math.sqrt(h)});function W(){var h=new X(16);return X!=Float32Array&&(h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[11]=0,h[12]=0,h[13]=0,h[14]=0),h[0]=1,h[5]=1,h[10]=1,h[15]=1,h}function Xt(h){return h[0]=1,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=1,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=1,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h}function G(h,t,e){var s=e[0],i=e[1],n=e[2],r,o,l,a,c,d,f,u,p,y,_,w;return t===h?(h[12]=t[0]*s+t[4]*i+t[8]*n+t[12],h[13]=t[1]*s+t[5]*i+t[9]*n+t[13],h[14]=t[2]*s+t[6]*i+t[10]*n+t[14],h[15]=t[3]*s+t[7]*i+t[11]*n+t[15]):(r=t[0],o=t[1],l=t[2],a=t[3],c=t[4],d=t[5],f=t[6],u=t[7],p=t[8],y=t[9],_=t[10],w=t[11],h[0]=r,h[1]=o,h[2]=l,h[3]=a,h[4]=c,h[5]=d,h[6]=f,h[7]=u,h[8]=p,h[9]=y,h[10]=_,h[11]=w,h[12]=r*s+c*i+p*n+t[12],h[13]=o*s+d*i+y*n+t[13],h[14]=l*s+f*i+_*n+t[14],h[15]=a*s+u*i+w*n+t[15]),h}function it(h,t,e){var s=e[0],i=e[1],n=e[2];return h[0]=t[0]*s,h[1]=t[1]*s,h[2]=t[2]*s,h[3]=t[3]*s,h[4]=t[4]*i,h[5]=t[5]*i,h[6]=t[6]*i,h[7]=t[7]*i,h[8]=t[8]*n,h[9]=t[9]*n,h[10]=t[10]*n,h[11]=t[11]*n,h[12]=t[12],h[13]=t[13],h[14]=t[14],h[15]=t[15],h}function Yt(h,t,e){var s=Math.sin(e),i=Math.cos(e),n=t[4],r=t[5],o=t[6],l=t[7],a=t[8],c=t[9],d=t[10],f=t[11];return t!==h&&(h[0]=t[0],h[1]=t[1],h[2]=t[2],h[3]=t[3],h[12]=t[12],h[13]=t[13],h[14]=t[14],h[15]=t[15]),h[4]=n*i+a*s,h[5]=r*i+c*s,h[6]=o*i+d*s,h[7]=l*i+f*s,h[8]=a*i-n*s,h[9]=c*i-r*s,h[10]=d*i-o*s,h[11]=f*i-l*s,h}function le(h,t,e,s,i){var n=1/Math.tan(t/2),r;return h[0]=n/e,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=n,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[11]=-1,h[12]=0,h[13]=0,h[15]=0,i!=null&&i!==1/0?(r=1/(s-i),h[10]=(i+s)*r,h[14]=2*i*s*r):(h[10]=-1,h[14]=-2*s),h}var ae=le;function ce(h,t,e,s){var i,n,r,o,l,a,c,d,f,u,p=t[0],y=t[1],_=t[2],w=s[0],b=s[1],T=s[2],M=e[0],x=e[1],F=e[2];return Math.abs(p-M)<at&&Math.abs(y-x)<at&&Math.abs(_-F)<at?Xt(h):(c=p-M,d=y-x,f=_-F,u=1/Math.hypot(c,d,f),c*=u,d*=u,f*=u,i=b*f-T*d,n=T*c-w*f,r=w*d-b*c,u=Math.hypot(i,n,r),u?(u=1/u,i*=u,n*=u,r*=u):(i=0,n=0,r=0),o=d*r-f*n,l=f*i-c*r,a=c*n-d*i,u=Math.hypot(o,l,a),u?(u=1/u,o*=u,l*=u,a*=u):(o=0,l=0,a=0),h[0]=i,h[1]=o,h[2]=c,h[3]=0,h[4]=n,h[5]=l,h[6]=d,h[7]=0,h[8]=r,h[9]=a,h[10]=f,h[11]=0,h[12]=-(i*p+n*y+r*_),h[13]=-(o*p+l*y+a*_),h[14]=-(c*p+d*y+f*_),h[15]=1,h)}function ft(){var h=new X(3);return X!=Float32Array&&(h[0]=0,h[1]=0,h[2]=0),h}function Tt(h,t,e){var s=new X(3);return s[0]=h,s[1]=t,s[2]=e,s}function xt(h,t,e){return h[0]=t[0]+e[0],h[1]=t[1]+e[1],h[2]=t[2]+e[2],h}function ue(h,t){var e=t[0]-h[0],s=t[1]-h[1],i=t[2]-h[2];return e*e+s*s+i*i}(function(){var h=ft();return function(t,e,s,i,n,r){var o,l;for(e||(e=3),s||(s=0),i?l=Math.min(i*e+s,t.length):l=t.length,o=s;o<l;o+=e)h[0]=t[o],h[1]=t[o+1],h[2]=t[o+2],n(h,h,r),t[o]=h[0],t[o+1]=h[1],t[o+2]=h[2];return t}})();function de(){var h=new X(2);return X!=Float32Array&&(h[0]=0,h[1]=0),h}function fe(h,t){var e=new X(2);return e[0]=h,e[1]=t,e}function me(h,t,e){return h[0]=t[0]+e[0],h[1]=t[1]+e[1],h}(function(){var h=de();return function(t,e,s,i,n,r){var o,l;for(e||(e=2),s||(s=0),i?l=Math.min(i*e+s,t.length):l=t.length,o=s;o<l;o+=e)h[0]=t[o],h[1]=t[o+1],n(h,h,r),t[o]=h[0],t[o+1]=h[1];return t}})();class j extends Float32Array{constructor(t=0,e=0,s=0){super(3),this[0]=t,this[1]=e,this[2]=s}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}set x(t){this[0]=t}set y(t){this[1]=t}set z(t){this[2]=t}get c(){return new j(this[0],this[1],this[2])}zeroX(){return this[0]=0,this}zeroY(){return this[1]=0,this}zeroZ(){return this[2]=0,this}setFrom(t,e,s){return this[0]=t,this[1]=e,this[2]=s,this}add(t){return this[0]+=t[0],this[1]+=t[1],this[2]+=t[2],this}sub(t){return this[0]-=t[0],this[1]-=t[1],this[2]-=t[2],this}scale(t){return this[0]*=t,this[1]*=t,this[2]*=t,this}scaleAndAdd(t,e){return this[0]+=t[0]*e,this[1]+=t[1]*e,this[2]+=t[2]*e,this}normalize(){const t=Math.hypot(this[0],this[1],this[2]);return t>0?this.scale(1/t):this.setFrom(0,0,0)}dot(t){return this[0]*t[0]+this[1]*t[1]+this[2]*t[2]}cross(t){return new j(this[1]*t[2]-this[2]*t[1],this[2]*t[0]-this[0]*t[2],this[0]*t[1]-this[1]*t[0])}lenSq(){return this[0]**2+this[1]**2+this[2]**2}len(){return Math.hypot(this[0],this[1],this[2])}dist(t){return Math.hypot(this[0]-t[0],this[1]-t[1],this[2]-t[2])}copyFrom(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this}toArray(){return[this[0],this[1],this[2]]}static fromArray(t){return new j(t[0],t[1],t[2])}static direction(t,e){return new j(e[0]-t[0],e[1]-t[1],e[2]-t[2]).normalize()}lerp(t,e){return this[0]+=(t[0]-this[0])*e,this[1]+=(t[1]-this[1])*e,this[2]+=(t[2]-this[2])*e,this}lerpEased(t,e,s){const i=s?s(e):e;return this[0]+=(t[0]-this[0])*i,this[1]+=(t[1]-this[1])*i,this[2]+=(t[2]-this[2])*i,this}get xz(){return new tt(this[0],this[2])}get xy(){return new tt(this[0],this[1])}get yz(){return new tt(this[1],this[2])}toDir(t){return this.sub(t).normalize()}moveTo(t,e,s=!1){const i=t[0]-this[0],n=t[1]-this[1],r=t[2]-this[2],o=Math.hypot(i,n,r);if(o<1e-5)return this;const l=s?e/o:Math.min(1,e/o);return this[0]+=i*l,this[1]+=n*l,this[2]+=r*l,this}moveDir(t,e){const s=t[0],i=t[1],n=t[2],r=Math.hypot(s,i,n);return r<1e-5?this:(this[0]+=s*e/r,this[1]+=i*e/r,this[2]+=n*e/r,this)}}let tt=class et extends Float32Array{constructor(t=0,e=0){super(2),this[0]=t,this[1]=e}get x(){return this[0]}get y(){return this[1]}set x(t){this[0]=t}set y(t){this[1]=t}get c(){return new et(this[0],this[1])}set(t,e){return this[0]=t,this[1]=e,this}add(t){return this[0]+=t[0],this[1]+=t[1],this}sub(t){return this[0]-=t[0],this[1]-=t[1],this}scale(t){return this[0]*=t,this[1]*=t,this}normalize(){const t=Math.hypot(this[0],this[1]);return t>0?this.scale(1/t):this.set(0,0)}dot(t){return this[0]*t[0]+this[1]*t[1]}lenSq(){return this[0]**2+this[1]**2}len(){return Math.sqrt(this.lenSq())}dist(t){return Math.hypot(this[0]-t[0],this[1]-t[1])}copyFrom(t){return this[0]=t[0],this[1]=t[1],this}toArray(){return[this[0],this[1]]}static fromArray(t){return new et(t[0],t[1])}static direction(t,e){return new et(e[0]-t[0],e[1]-t[1]).normalize()}lerp(t,e){return this[0]+=(t[0]-this[0])*e,this[1]+=(t[1]-this[1])*e,this}lerpEased(t,e,s=void 0){const i=s?s(e):e;return this[0]+=(t[0]-this[0])*i,this[1]+=(t[1]-this[1])*i,this[2]+=(t[2]-this[2])*i,this}toDir(t){return this.sub(t).normalize()}moveTo(t,e,s=!1){const i=t[0]-this[0],n=t[1]-this[1],r=Math.hypot(i,n);if(r<1e-5)return this;const o=s?e/r:Math.min(1,e/r);return this[0]+=i*o,this[1]+=n*o,this}moveDir(t,e){const s=t[0],i=t[1],n=Math.hypot(s,i);return n<1e-5?this:(this[0]+=s*e/n,this[1]+=i*e/n,this)}};const S=(h=0,t=0,e=0)=>new j(h,t,e),pe=(h=0,t=0)=>new tt(h,t),ye=160,A=170,mt=ye/2,I=A/2,V=6,st=6,Mt=.5,ge=Object.freeze({home:[0,0,0],away:[0,0,A]}),_e=Object.freeze([S(-.5*V-st,0,A),S(-.5*V,0,A),S(.5*V,0,A),S(.5*V+st,0,A)]),be=Object.freeze([S(-.5*V-st,0,0),S(-.5*V,0,0),S(.5*V,0,0),S(.5*V+st,0,0)]),we=Object.freeze({Away:_e,Home:be});function Pt(h){const t=h[0]/mt,e=(h[2]-I)/I;return t*t+e*e>1}function ve(h,t,e,s,i,n){const r=i-e,o=n-s;if(r===0&&o===0){const p=h-e,y=t-s;return p*p+y*y}const l=((h-e)*r+(t-s)*o)/(r*r+o*o),a=Math.max(0,Math.min(1,l)),c=e+a*r,d=s+a*o,f=h-c,u=t-d;return f*f+u*u}function Se(h,t){const e=Pt(h),s=Pt(t);for(const i of["Away","Home"]){const n=we[i];if(s&&!e){if(i==="Away"){if(h[2]>A-10){const o=t[0];if(o>=-3&&o<=3)return"goalAway";if(o>=-9&&o<-3||o>3&&o<=9)return"behindAway"}}else if(i==="Home"&&h[2]<10){const o=t[0];if(o>=-3&&o<=3)return"goalHome";if(o>=-9&&o<-3||o>3&&o<=9)return"behindHome"}}const r=["outerLeftPost","innerLeftPost","innerRightPost","outerRightPost"];for(let o=0;o<n.length;o++){const l=n[o][0],a=n[o][2];if(ve(l,a,h[0],h[2],t[0],t[2])<Mt*Mt)return`${r[o]}${i}`}}return!e&&s?"outOfBounds":null}function kt(h=!1){const e={fullForward:70,halfForward:35,halfBack:-35,fullBack:-70},s={LFP:-45,FF:0,RFP:45,LHF:-50,CHF:0,RHF:50,LHB:-50,CHB:0,RHB:50,LBP:-45,FB:0,RBP:45};function i(l,a){const c=l*Math.PI/180,d=mt*Math.sin(c)*(Math.abs(a)/I)-(h?2:-2),f=I+a*(h?-1:1);return S(d,0,f)}const n=-mt-4,r=l=>I+(h?1:-1)*l;return{LFP:i(s.LFP,e.fullForward-(h?10:-10)),FF:i(s.FF,e.fullForward),RFP:i(s.RFP,e.fullForward-(h?10:-10)),LHF:i(s.LHF,e.halfForward),CHF:i(s.CHF,e.halfForward),RHF:i(s.RHF,e.halfForward),LW:S(-25,0,I-(h?2:-2)),C:S(8,0,I-(h?-5:5)),RW:S(25,0,I-(h?2:-2)),LHB:i(s.LHB,e.halfBack),CHB:i(s.CHB,e.halfBack),RHB:i(s.RHB,e.halfBack),LBP:i(s.LBP,e.fullBack-(h?10:-10)),FB:i(s.FB,e.fullBack),RBP:i(s.RBP,e.fullBack-(h?10:-10)),Ruck:S(0,0,I-(h?10:-10)),RR:S(-10,0,I-(h?10:-10)),Rover:S(10,0,I-(h?10:-10)),Bench1:S(n,0,r(10)),Bench2:S(n,0,r(13)),Bench3:S(n,0,r(16)),Bench4:S(n,0,r(19)),Bench5:S(n,0,r(22))}}function Te(h,t,e){let s=null,i=1/0;for(const n of t)if(n.team!==h.team){const r=n.pos.dist(e);r<i&&(i=r,s=n)}return s}class xe{constructor(t,e,s){this.game=t,this.kicker=e,this.markPos=s.c,this.timer=0,this.finished=!1}update(t){this.timer+=t}enforce(t,e){return!1}cleanup(){}}class nt extends xe{constructor(t,e,s){super(t,e,s),this.defender=null,this.zone={center:S(0,0,0),radius:1},this.game=t,t=this.game,e=this.kicker;const i=e.team==="home"?0:A,n=S(0,0,i),r=s.c.sub(n).zeroY().normalize(),o=s.c,l=s.c;e.pos.copyFrom(l),e.jogVel.copyFrom(r).scale(e.jogSpeed),e.joltVel.setFrom(0,0,0),t.ball.carrier!==e&&t.ball.pickup(e),e.team==="home"&&(this.game.player=e),e.stateTimer=10/e.jogSpeed,this.defender=Te(e,t.players,s),this.defender&&(this.defender.pos.copyFrom(o),this.defender.vel.setFrom(0,0,0),this.defender.jogVel.setFrom(0,0,0),this.defender.joltVel.setFrom(0,0,0),this.defender.actionState="standingMark",this.defender.stateTimer=10)}update(t){super.update(t);const{kicker:e,markPos:s,game:i}=this,n=!i.ball.carried,r=e.pos.c.sub(s);r[1]=0;const o=e.team==="home"?0:A,l=S(0,0,o).sub(s).zeroY().normalize(),a=r.dot(l),c=S(-l[2],0,l[0]),d=r.dot(c),f=a>.05||d>2;(n||f)&&(this.finished=!0)}enforce(t,e){const{kicker:s,defender:i,markPos:n}=this,r=s.pos,o=n.c.lerp(r,.5),l=n.dist(r)/2+5,a=t.pos.dist(o);if(t===i)return t.pos.copyFrom(i.pos),t.vel.setFrom(0,0,0),t.jogVel.setFrom(0,0,0),t.joltVel.setFrom(0,0,0),!1;if(a<l&&t!==s&&t!==i){const c=t.pos.dist(o),d=l-c;if(d>0){const f=t.pos.c.sub(o);f[1]=0,f.len()<.001?f.setFrom(Math.random()-.5,0,Math.random()-.5).normalize():f.normalize();const p=d<2?d*10:d*20;return t.joltVel.scaleAndAdd(f,p*e),t.pos.scaleAndAdd(t.joltVel,e),!0}}return!1}}function gt(h){let t=BigInt(h)&0xFFFFFFFFFFFFFFFFn;return function(){t=t+0x9E3779B97F4A7C15n&0xFFFFFFFFFFFFFFFFn;let s=t;return s=(s^s>>30n)*0xBF58476D1CE4E5B9n&0xFFFFFFFFFFFFFFFFn,s=(s^s>>27n)*0x94D049BB133111EBn&0xFFFFFFFFFFFFFFFFn,s=s^s>>31n,s}}class ${constructor(){m(this,"_seed",0)}random(){return Math.random()}seed(t){throw new Error("Seeding is not available in the default PRNG class. You can set another with `eskv.rand.setPRNG`.")}getRandomInt(t,e=0){return e!=0?t+Math.floor(this.random()*(e-t)):Math.floor(this.random()*t)}getRandomPos(t,e){return[this.getRandomInt(t),this.getRandomInt(e)]}randomRange(t=0,e=1){return Math.floor(this.random()*(e-t+1))+t}randomFloat(t=0,e=1){return this.random()*(e-t)+t}shuffle(t){let e,s;for(let i=1;i<t.length;i++)s=this.randomRange(0,i),e=t[i],t[i]=t[s],t[s]=e;return t}choose(t){return t[Math.floor(this.random()*t.length)]}chooseN(t,e){let s=new Array(e),i=t.length,n=new Array(i);if(e>i)throw new RangeError("chooeN: more elements requested than available");for(;e--;){let r=Math.floor(this.random()*i);s[e]=t[r in n?n[r]:r],n[r]=--i in n?n[i]:i}return s}}function Ft(h,t,e,s){return function(){h>>>=0,t>>>=0,e>>>=0,s>>>=0;var i=h+t|0;return h=t^t>>>9,t=e+(e<<3)|0,e=e<<21|e>>>11,s=s+1|0,i=i+s|0,e=e+i|0,(i>>>0)/4294967296}}function Dt(h){return function(){var t=h+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function At(h,t,e,s){return function(){var i=t<<9,n=t*5;return n=(n<<7|n>>>25)*9,e^=h,s^=t,t^=e,h^=s,e^=i,s=s<<11|s>>>21,(n>>>0)/4294967296}}function Lt(h,t,e,s){return function(){h|=0,t|=0,e|=0,s|=0;var i=h-(t<<27|t>>>5)|0;return h=t^(e<<17|e>>>15),t=e+s|0,e=s+i|0,s=h+i|0,(s>>>0)/4294967296}}class Nt extends ${constructor(){super(...arguments);m(this,"_seed",1);m(this,"d",3735928559);m(this,"xorSeed",Math.floor(Date.now())^this.d);m(this,"random",Ft(2654435769,608135816,3084996962,this.xorSeed))}seed(e){this._seed=e,this.xorSeed=e^this.d;const s=gt(this.xorSeed);this.random=Ft(s(),s(),s(),s())}}class Me extends ${constructor(){super(...arguments);m(this,"_seed",1);m(this,"d",3735928559);m(this,"xorSeed",Math.floor(Date.now())^this.d);m(this,"random",Dt(this.xorSeed))}seed(e){this._seed=e,this.xorSeed=e^this.d,this.random=Dt(this.xorSeed)}}class Pe extends ${constructor(){super(...arguments);m(this,"_seed",1);m(this,"d",3735928559);m(this,"xorSeed",Math.floor(Date.now())^this.d);m(this,"random",At(2654435769,608135816,3084996962,this.xorSeed))}seed(e){this._seed=e,this.xorSeed=e^this.d;const s=gt(this.xorSeed);this.random=At(s(),s(),s(),s())}}class ke extends ${constructor(){super(...arguments);m(this,"_seed",1);m(this,"d",3735928559);m(this,"xorSeed",Math.floor(Date.now())^this.d);m(this,"random",Lt(2654435769,608135816,3084996962,this.xorSeed))}seed(e){this._seed=e,this.xorSeed=e^this.d;const s=gt(this.xorSeed);this.random=Lt(s(),s(),s(),s())}}var H=new Nt;function Fe(h){switch(h){case"Math.random":H=new $;return;case"sfc32":H=new Nt;return;case"mulberry32":H=new Me;return;case"xoshiro128ss":H=new Pe;return;case"jsf32":H=new ke;return;default:throw Error(`Unknown PRNG ${h}`)}}function Z(h,t=0){return H.getRandomInt(h,t)}function De(h,t){return H.getRandomPos(h,t)}function Ae(h=0,t=1){return H.randomFloat(h,t)}function Le(h){return H.choose(h)}function Ce(h){return H.seed(h)}function Ee(h){let t=5381;for(let e=0;e<h.length;e++)t=(t<<5)+t+h.charCodeAt(e),t=t&4294967295;return t>>>0}function ze(h,t){const[e,s]=h.collideBounds(),[i,n]=t.collideBounds(),r=h.pos[0]-t.pos[0],o=h.pos[2]-t.pos[2],l=r*r+o*o,a=.5*e,c=.5*i,d=a+c,f=h.pos[1],u=h.pos[1]+s,p=t.pos[1],y=t.pos[1]+n,_=f<y&&u>p;return l<=d*d&&_}function Ct(h){const t=h.collideBounds()[0]||1;return h.intent==="shepherd"||h.intent==="block"?t*1.4:h.intent==="crumb"||h.intent==="hangBack"?t*.8:t}function Et(h){switch(h){case"mark":return 1.3;case"block":return 1.4;case"spoil":return 1.1;case"shepherd":return 1.25;case"contestAnyway":return 1;case"crumb":return .7;case"hangBack":return .5;default:return 1}}class _t{constructor(t){this.pos=S(t[0],t[1],t[2]),this.vel=S(0,0,0),this.width=1.6,this.height=2.4,this.usesGravity=!0,this.gravity=S(0,-9.8,0),this.bounce=0,this.floorY=0}setupForBoundary(t,e){}update(t,e){this.usesGravity&&this.vel.scaleAndAdd(this.gravity,t),this.pos.scaleAndAdd(this.vel,t),this.pos[1]<this.floorY&&(this.pos[1]=this.floorY,Math.abs(this.vel[1])>.5?this.vel[1]=-this.vel[1]*this.bounce:this.vel[1]=0)}render(t){t.renderSprite(this.pos,this.width,this.height,1,0)}collidesWith(t){return ze(this,t)}collideBounds(){return[.5,1.8]}}const zt={home:Object.freeze({idle:[[0,0,0]],run:[[1,0,0],[2,0,0],[3,0,0],[4,0,0],[5,0,0],[6,0,0]],kickRightFoot:[[1,0,0],[2,0,0]],kickLeftFoot:[[4,0,0],[5,0,0]],handpassRightHand:[[1,0,0],[0,0,0]],handpassLeftHand:[[4,0,0],[0,0,0]],jumpMark:[[1,0,0],[2,0,0],[0,0,0]],jumpSpoil:[[1,0,0],[2,0,0],[0,0,0]]}),away:Object.freeze({idle:[[0,4,0]],run:[[1,4,0],[2,4,0],[3,4,0],[4,4,0],[5,4,0],[6,4,0]],kickRightFoot:[[1,4,0],[2,4,0]],kickLeftFoot:[[4,4,0],[5,4,0]],handpassRightHand:[[1,4,0],[0,4,0]],handpassLeftHand:[[4,4,0],[0,4,0]],jumpMark:[[1,4,0],[2,4,0],[0,4,0]],jumpSpoil:[[1,4,0],[2,4,0],[0,4,0]]})},ct=Object.freeze({swarthy:{front:[0,12,0],back:[0,13,0],headCount:4,bodyRowOffset:9},pasty:{front:[0,14,0],back:[0,15,0],headCount:3,bodyRowOffset:10},tan:{front:[0,16,0],back:[0,17,0],headCount:3,bodyRowOffset:11}}),Re=Object.freeze({home:{front:[0,5,0],back:[0,6,0]},away:{front:[0,7,0],back:[0,8,0]}}),Ie=Object.freeze({idle:[[0,0,0]],run:[[1,0,0],[2,0,0],[3,0,0],[4,0,0],[5,0,0],[6,0,0]],kickRightFoot:[[1,0,0],[2,0,0]],kickLeftFoot:[[4,0,0],[5,0,0]],handpassRightHand:[[1,0,0],[0,0,0]],handpassLeftHand:[[4,0,0],[0,0,0]],jumpMark:[[1,0,0],[2,0,0],[0,0,0]],jumpSpoil:[[1,0,0],[2,0,0],[0,0,0]]});class Be extends _t{constructor(t,e,s,i,n=!1){super(i),this.intent="idle",this.intentTarget=null,this.positionPos=j.fromArray(i),this.teamId=s,this.complexion=Le(["swarthy","pasty","tan"]),this.faceId=Z(ct[this.complexion].headCount),this.name=t,this.team=e,this.playing=n,this.width=1.6,this.height=2.4,this.aiming=!1,this.jogVel=S(0,0,0),this.joltVel=S(0,0,0),this.jogSpeed=5,this.joltSpeed=2,this.energy=10,this.energyRecovery=0,this.statsWeight=85+Math.random()*10,this.statsStrength=50+Math.random()*30,this.statsSpeed=10+Math.random()*5,this.statsJump=10,this.statsKickRange=45,this.statsHandpassRange=20,this.statsAgility=10,this.joltDecayRate=8,this.animations=zt[e]??zt.home,this.animState="idle",this.actionState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=8,this.stateTimer=0,this.animSprite=[[0,0,0]]}updateAI(t,e){const i=e.ball;let n=null;if(i.carried&&i.carrier===this)if(this.stateTimer+=t,this.stateTimer<1)n="run";else{let o=!1;for(const u of e.players)if(!(u===this||u.team===this.team)&&u.pos.dist(this.pos)<7){o=!0;break}const l=e.players.filter(u=>u.team===this.team&&u!==this);if(o){let u=null,p=-1/0;const y=S(0,0,this.team==="home"?-1:1);for(const _ of l){if(_===this)continue;const w=this.pos.dist(_.pos);if(w>40)continue;let b=!1;for(const L of e.players)if(L.team!==this.team&&L.pos.dist(_.pos)<5){b=!0;break}if(b)continue;const T=this.pos.c.toDir(_.pos),M=y.c.dot(T),x=j.fromArray(_.vel);x[1]=0;const F=y.dot(x),v=Math.abs(w-15)*.2,k=15*M+2*F-v;k>p&&(p=k,u=_)}if(u){const _=u.pos.c.sub(this.pos),w=[_[0],_[2]];return this.tryDisposeBall(e,{kickReleased:!0,kickHeldTime:_.len()>20?.5:.1,aimTarget:w})??"run"}}const c=this.team==="home"?-5:A+5,d=0;if(Math.abs(this.pos[2]-c)<=this.statsKickRange){const u=S(d+(Math.random()-.5)*9,0,c).sub(this.pos),p=[u[0],u[2]];return this.tryDisposeBall(e,{kickReleased:!0,kickHeldTime:.4,aimTarget:p})??"run"}if(o||this.stateTimer>5){let u=null,p=-1/0;for(const y of l){const _=this.pos.dist(y.pos);if(_>this.statsKickRange)continue;const w=this.team==="home"?-1:1,b=(y.pos[2]-this.pos[2])*w,T=Math.abs(y.pos[0]-this.pos[0]),M=b-T-_;M>p&&(p=M,u=y)}if(u){const y=u.pos.c.sub(this.pos),_=[y[0],y[2]];return this.tryDisposeBall(e,{kickReleased:!0,kickHeldTime:.4,aimTarget:_})??"run"}}n="run"}let r=null;if(i.carried&&i.carrier===this){const o=this.team==="home"?-1:1,l=S(0,0,o);let a=S(0,0,0);for(const d of e.players){if(d===this||d.team===this.team)continue;const f=this.pos.c.sub(d.pos);f[1]=0;const u=f.len();if(u<5&&u>.5){const p=1/u;a.scaleAndAdd(f.normalize(),p)}}const c=l.c.add(a).normalize();r=this.pos.c.scaleAndAdd(c,10)}else if(i.carried)if(i.carrier&&i.carrier.team!==this.team&&e.chasers<3&&e.closestPlayers[this.team]===this||i.pos.dist(this.pos)<=15&&this.energy>0)r=i.pos.c,e.chasers++;else if(i.carrier&&i.carrier.team===this.team&&i.pos[2]>20&&i.pos[2]<A-20&&i.pos.dist(this.pos)<10&&this.energy>.3&&e.followers<3){e.followers++;const o=i.carrier.jogVel.c;o.len()<.01&&(o[2]=this.team==="home"?-1:1),o.normalize();const l=S(-o[2],0,o[0]).normalize();let a=0,c=12;switch(this.name){case"wing":a=12*(this.team==="home"?-1:1),c=15;break;case"forward":a=6,c=18;break;case"half-forward":case"half-back":a=4,c=10;break;case"center":case"mid":a=0,c=10;break;case"back":default:a=-6,c=8;break}r=i.carrier.pos.c.scaleAndAdd(o,c).scaleAndAdd(l,a)}else r=this.positionPos??this.pos;else if(i.pos[1]>.1||i.vel[1]>.1){const o=i.gravity[1]??-9.8,l=i.vel[1],a=i.pos[1],c=.5*o,d=l,f=a;let u=0;const p=d*d-4*c*f;if(p>=0&&Math.abs(c)>1e-5){const _=Math.sqrt(p),w=(-d+_)/(2*c),b=(-d-_)/(2*c);u=Math.max(w,b)}const y=i.pos.c.scaleAndAdd(i.vel,u);y[1]=0,y.dist(this.pos)<=35?r=y:r=this.positionPos??this.pos}else i.pos.dist(this.pos)<=25&&e.chasers<3?(r=i.pos,e.chasers++):r=this.positionPos??this.pos;if(r===this.positionPos&&this.positionPos.dist(this.pos)<=1&&(n="idle",this.actionState!=="idle"&&(this.stateTimer=0),this.jogVel.setFrom(0,0,0),this.joltVel.setFrom(0,0,0)),r===null&&n===null&&(r=ge[this.team]),r&&n!=="idle"){const o=r.c.sub(this.pos).zeroY().normalize();if(o.len()>1e-4){this.joltVel.copyFrom(o).scale(this.joltSpeed);const l=this.jogVel.c.normalize();this.jogVel.len()>1e-4?(l.lerp(o,10*t).normalize(),this.jogVel.copyFrom(l).scale(this.jogSpeed)):this.jogVel.copyFrom(o).scale(this.jogSpeed)}}if(this.energy>0&&this.actionState!=="idle"?(this.vel.copyFrom(this.jogVel).add(this.joltVel),this.energy-=t):(this.vel.copyFrom(this.jogVel).scaleAndAdd(this.joltVel,.5),this.energyRecovery+=t,this.energyRecovery>=10&&(this.energy=10,this.energyRecovery=0)),this.joltVel.scale(Math.exp(-this.joltDecayRate*t)),this.checkPlayerCollisions(t,e),super.update(t,e),n===null&&(n=this.tryTackle(e)),!i.carried&&i.collidesWith(this)&&n===null){const o=i.lastTouchedType==="kick"&&!i.hasBounced&&i.lastTouchedBy!==this&&i.pos.dist(i.origin)>=15;return i.pickup(this),o?(e.setPiece=new nt(e,this,this.pos.c),n="freeKick"):n="pickup",this.team==="home"&&(e.player=this,this.aiming=!1),n}return n||(n=this.vel.len()>1e-4?"run":"idle"),n}collideBounds(){return[.8,1.8]}get stunned(){return this.actionState==="tackle"||this.actionState==="tackled"}tryTackle(t){const e=t.ball;for(const s of t.players){if(s===this||!e.carried||e.carrier!==s||s.team===this.team||!this.collidesWith(s)||s.actionState==="tackleDisposal"||s.actionState==="freeKick")continue;const i=s.pos.c.sub(this.pos);i[1]=0,i.normalize();const n=1e-8,r=this.jogVel.c;if(r[1]=0,r.len()<n||r.c.normalize().dot(i)>.1)return this.stateTimer=1,s.actionState="tackleDisposal",s.stateTimer=.5,"tackle"}return null}updateHuman(t,e){const s=e.controls,i=e.ball;let{kickPressed:n,kickReleased:r,kickHeldTime:o,moveX:l,moveZ:a,aimTarget:c}=s.state;const d=1e-4;let f=null;if((l!==0||a!==0)&&!this.aiming){const u=S(l,0,a).normalize();if(S(l,0,a),u.len()>d){this.joltVel.copyFrom(u).scale(this.joltSpeed);const p=this.jogVel.c.normalize();this.jogVel.len()>d?(p.lerp(u,10*t).normalize(),this.jogVel.copyFrom(p).scale(this.jogSpeed)):this.jogVel.copyFrom(u).scale(this.jogSpeed)}}if(this.energy>0?(this.vel.copyFrom(this.jogVel).add(this.joltVel),this.energy-=t):(this.vel.copyFrom(this.jogVel).scaleAndAdd(this.joltVel,.5),this.energyRecovery+=t,this.energyRecovery>=10&&(this.energy=10,this.energyRecovery=0)),this.joltVel.scale(Math.exp(-this.joltDecayRate*t)),this.checkPlayerCollisions(t,e),super.update(t,e),i.carried&&i.carrier!==this&&n&&(f=this.tryTackle(e)),!i.carried&&i.collidesWith(this)&&f===null){const u=i.lastTouchedType==="kick"&&!i.hasBounced&&i.lastTouchedBy!==this&&i.pos.dist(i.origin)>=15;return i.pickup(this),u?(e.setPiece=new nt(e,this,this.pos.c),f="freeKick"):f="pickup",this.team==="home"&&(e.player=this,this.aiming=!1),f}if(i.carried&&i.carrier===this&&f===null){if(n&&(this.aiming=!0,this.jogVel.len()<1e-5)){const u=S(0,0,this.team==="home"?0:A).sub(this.pos).normalize();this.jogVel.copyFrom(u).scale(this.jogSpeed)}f=this.tryDisposeBall(e,{kickReleased:s.state.kickReleased,kickHeldTime:s.state.kickHeldTime,aimTarget:s.state.aimTarget,moveVec:l!==0||a!==0?S(l,0,a):j.fromArray(this.jogVel)}),i.carried||(this.aiming=!1)}return this.updateAim(e),!f&&this.actionState!=="run"&&this.actionState!=="idle"&&(f=this.vel.len()>d?"run":"idle"),f}tryDisposeBall(t,e){const s=t.ball;if(!s.carried||s.carrier!==this)return null;const{kickReleased:i,kickHeldTime:n}=e;let{aimTarget:r}=e;if(!i)return null;const o=n<.25;if(o){const b=e.moveVec??this.jogVel.c;if(b.len()===0){const x=this.team==="home"?-1:1;b.setFrom(0,0,x)}b.normalize;let T=null,M=-1/0;for(const x of t.players){if(x.team!==this.team||x===this||x.stunned)continue;const F=x.pos.c.sub(this.pos),v=F.len();if(v>30)continue;const k=F.c.normalize(),L=b.dot(k);if(L<=0)continue;let B=0;for(const U of t.players){if(U.team===this.team||U===x||U.stunned)continue;U.pos.dist(x.pos)<=10&&B++}const lt=.5*B,Q=L*2-v/30-lt;Q>M&&(M=Q,T=x)}if(T){const x=T.pos.c.sub(this.pos);r=[x[0],x[2]]}else r=[b[0]*10,b[2]*10]}if(!r)return null;const l=pe(r[0],r[1]),a=l.len();if(a<.1)return null;const c=-this.gravity[1],d=(o?20:30)*Math.PI/180,f=Math.sin(2*d),u=Math.sqrt(a*c/f),p=S(l[0],0,l[1]).normalize(),y=S(p[0]*Math.cos(d),Math.sin(d),p[2]*Math.cos(d));return s.launch(y,u),s.lastTouchedType=o?"handpass":"kick",s.hasBounced=!1,this.stateTimer=.5,o?"handpass":"kick"}update(t,e){this.oldPos=this.pos.c;let s=!1;if(e.setPiece&&(s=e.setPiece.enforce(this,t)),e.ball.carried||(this.aiming=!1),!this.playing)return;if(this.actionState==="pickup"&&(this.actionState="run"),this.actionState==="freeKick"){this.stateTimer-=t,this.stateTimer<=0?(this.actionState="idle",this.stateTimer=0,this.jogVel[0]=0,this.jogVel[2]=0,e.setPiece):(e.setPiece===null||e.controls.state.moveX!==0||e.controls.state.moveZ!==0)&&(this.actionState="idle",this.stateTimer=0),this.vel.copyFrom(this.jogVel),super.update(t,e),this.updateAim(e),this.updateAnimation(t,null,e.ball);return}if(this.actionState==="standingMark"){this.stateTimer-=t,this.stateTimer<=0?(this.actionState="idle",this.stateTimer=0,this.jogVel[0]=0,this.jogVel[1]=0,e.setPiece):e.setPiece===null&&(this.actionState="idle",this.stateTimer=0),this.updateAim(e),this.updateAnimation(t,null,e.ball);return}if(this.actionState==="tackleDisposal"){if(this.stateTimer-=t,this.pos.scaleAndAdd(this.jogVel,t),e.player===this&&e.controls.state.kickReleased&&(this.tryDisposeBall(e,e.controls.state),this.actionState="handpass",this.stateTimer=.5),e.player!==this){const n=.5-this.stateTimer,r=.5+(this.statsStrength-50)*.01,o=n/r*(.5+(this.statsStrength-50)/100);Math.random()<o*t*2&&this.tryDisposeBall(e,{kickReleased:!0,kickHeldTime:.1,aimTarget:null,moveVec:S(0,0,0)})}if(this.stateTimer<=0){const n=e.ball;n.carried=!1,n.carrier=null,n.pos.copyFrom(this.pos),n.vel.copyFrom(this.vel.len()>.5?this.vel:S(Math.random()*2-1,0,Math.random()*2-1).normalize().scale(this.jogSpeed+this.joltSpeed)),n.lastTouchedType="spill",n.hasBounced=!1,this.actionState="tackled",this.stateTimer=1}this.updateAim(e),this.updateAnimation(t,null,e.ball);return}if(this.actionState==="tackled"||this.actionState==="tackle"||this.actionState==="kick"||this.actionState==="handpass"){this.actionState==="tackled"&&this.vel.scale(.8),this.stateTimer-=t,this.stateTimer<=0&&(this.actionState="idle",this.stateTimer=0),this.aiming&&(this.aiming=!1),super.update(t,e),this.updateAim(e),this.updateAnimation(t,null,e.ball);return}let i=null;s||(e.player===this?i=this.updateHuman(t,e):i=this.updateAI(t,e)),this.updateAnimation(t,i,e.ball),i!==null&&(this.actionState=i)}updateAim(t){if(this===t.player){const s=t.controls.state.aimTarget;if(this.aiming){const i=fe(0,0);s&&me(i,i,s),t.aimTarget.setPosition([this.pos[0]+i[0],.002,this.pos[2]+i[1]])}else t.player===this&&t.aimTarget.setPosition(S(this.pos[0],.002,this.pos[2]+.8))}}updateAnimation(t,e,s){const i=this.animations[this.animState];if(i.length===0)return;this.animTimer+=t;const n=1/this.animFPS;this.animTimer>=n&&(this.animTimer-=n,this.animFrame=this.animFrame+1),e==="kick"&&(this.animState="kickRightFoot",this.animFrame=0,this.animTimer=0),this.animState==="run"&&this.vel.len()===0&&(this.animState="idle",this.animFrame=0,this.animTimer=0),this.animState==="idle"&&this.vel.len()!==0&&(this.animState="run",this.animFrame=0,this.animTimer=0);const r=this.animState==="run"||this.animState==="idle";this.animFrame>=i.length&&(this.animFrame=r?0:i.length-1,r||(this.animState="run",this.animFrame=0,this.animTimer=0));const o=Re.home.back.slice();o[0]+=this.teamId,this.team==="away"&&(o[1]+=2);const l=ct[this.complexion].back.slice();l[0]+=this.faceId;const a=Ie[this.animState][this.animFrame].slice()??[0,0,0];a[1]+=ct[this.complexion].bodyRowOffset,(this.vel[2]>0?"away":this.vel[2]<0?"home":this.pos[2]<s.pos[2]?"away":"home")==="away"&&(a[0]+=7,o[1]-=1,l[1]-=1),this.animSprite=[o,l,a]}render(t){const e=S(0,.005,.01);let s=1;for(let[i,n,r]of this.animSprite)t.renderSprite(this.pos.c.scaleAndAdd(e,s),this.width,this.height,i,n),s++}renderOrig(t){const[e,s,i]=this.animSprite;t.renderSprite(this.pos,this.width,this.height,e,s)}checkPlayerCollisions(t,e){if(this.actionState!=="freeKick")for(const s of e.players){if(s===this||!s.playing||s.actionState==="freeKick")continue;const i=this.pos.c.sub(s.pos);i[1]=0;const n=i.len(),r=Ct(this),o=Ct(s),a=(r+o)/2-n;if(a<=0)continue;n<1e-4?(i[0]=Math.random()-.5,i[2]=Math.random()-.5,i.normalize()):i.scale(1/n);const c=this.statsWeight*Et(this.intent),d=s.statsWeight*Et(s.intent),f=c+d,u=i.c.scale(a),p=u.c.scale(d/f),y=u.c.scale(c/f);this.pos[0]+=p[0],this.pos[2]+=p[2],s.pos[0]-=y[0],s.pos[2]-=y[2]}}setupForBoundary(t,e){t==="behindAway"&&this.team==="home"&&this.name==="FB"?(this.pos.setFrom(0,0,A-5),this.jogVel.setFrom(0,0,0),this.joltVel.setFrom(0,0,0),this.actionState="idle",this.stateTimer=0):t==="behindAway"&&this.team==="away"&&this.name==="FF"?this.pos.setFrom(0,0,A-25):t==="behindHome"&&this.team==="away"&&this.name==="FB"?(this.pos.setFrom(0,0,5),this.jogVel.setFrom(0,0,0),this.joltVel.setFrom(0,0,0),this.actionState="idle",this.stateTimer=0):t==="behindHome"&&this.team==="home"&&this.name==="FF"?this.pos.setFrom(0,0,25):this.pos.copyFrom(this.positionPos)}}class He extends _t{constructor(t){super(t),this.carried=!1,this.origin=S(0,0,0),this.carrier=null,this.width=1.6,this.height=2.4,this.bounce=.5,this.animations=Object.freeze({idle:[[0,1,0]],backSpin:[[1,1,0],[2,1,0],[3,1,0],[4,1,0],[5,1,0],[6,1,0],[7,1,0],[8,1,0]],forwardSpin:[[8,1,0],[7,1,0],[6,1,0],[5,1,0],[4,1,0],[3,1,0],[2,1,0],[1,1,0]],backSpinRight:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]],backSpinLeft:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinRight:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinLeft:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]]}),this.animState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=12,this.lastTouchedBy=null,this.lastTouchedType=null,this.hasBounced=!1}update(t,e){if(this.carried&&this.carrier){const s=this.carrier,i=s.vel[2]>0?1:s.vel[2]<0||s.team==="home"?-1:1,n=S(0,.5,.2*i);this.pos.copyFrom(this.carrier.pos).add(n),this.origin.copyFrom(this.pos)}else{const s=this.vel[1]<0;super.update(t,e),this.hasBounced=this.hasBounced||s&&this.vel[1]>0&&this.pos[1]<=this.floorY,this.pos[1]<=this.floorY&&(this.vel.scale(.97),this.origin.copyFrom(this.pos))}this.updateAnimation(t)}collideBounds(){return[.4,.5]}pickup(t){this.carried=!0,this.carrier=t,this.lastTouchedBy=t,this.lastTouchedType=null,this.hasBounced=!1,this.origin.copyFrom(this.pos);const e=t.vel[2]>0?1:t.vel[2]<0||t.team==="home"?-1:1;this.pos.copyFrom(t.pos).add(S(0,0,e*.2)),this.vel.setFrom(0,0,0)}launch(t,e,s="kick"){this.carried=!1,this.carrier=null,this.vel.copyFrom(t).scale(e),this.lastTouchedType=s,this.hasBounced=!1}updateAnimation(t){this.animTimer+=t;const e=1/this.animFPS;this.animTimer>=e&&(this.animTimer-=e,this.animFrame=this.animFrame+1);const s=this.animState;this.carried?this.animState="idle":this.lastTouchedType==="kick"&&!this.hasBounced?this.animState=this.vel[2]<0?"backSpin":"forwardSpin":this.lastTouchedType==="handpass"&&!this.hasBounced?this.animState=this.vel[2]<0?"backSpinRight":"forwardSpinLeft":this.hasBounced?Math.abs(this.vel[1])<.05&&this.pos[1]<=this.floorY+.01?this.animState="idle":this.animState=this.vel[2]<0?"forwardSpin":"backSpin":this.animState="idle",this.animState!==s&&(this.animFrame=0,this.animTimer=0);const i=this.animations[this.animState];i.length!==0&&this.animFrame>=i.length&&(this.animFrame=0)}render(t){var r;const e=(r=this.animations)==null?void 0:r[this.animState],[s,i,n]=(e==null?void 0:e[this.animFrame])??[0,1,void 0];t.renderSprite(this.pos,this.width,this.height,s,i);{const o=t.gl;o.useProgram(t.program),o.bindVertexArray(t.quadVao);const[l,a]=[2,3];t.setTileUV(l,a),o.uniform1i(t.uTiling,0);const c=W();G(c,c,[this.pos[0],.001,this.pos[2]]),Yt(c,c,-Math.PI/2),it(c,c,[2,2,1]),o.uniformMatrix4fv(t.uModel,!1,c),o.drawElements(o.TRIANGLES,6,o.UNSIGNED_SHORT,0)}}setupForBoundary(t,e){if(this.carried=!1,this.carrier=null,t==="goalAway"||t==="goalHome")this.pos.setFrom(0,0,A/2),this.vel.setFrom(0,15,0),this.lastTouchedType="tap",this.lastTouchedBy=null,this.origin.copyFrom(this.pos);else if(t==="behindAway")this.pos.setFrom(0,0,A-6);else if(t==="behindHome")this.pos.setFrom(0,0,6);else{this.pos.copyFrom(e),this.pos.y=0;const s=S(0,A/2,A/2).toDir(this.pos);this.launch(s,15,"tap")}}}class je{constructor(t=[0,.001,0]){this.pos=j.fromArray(t),this.size=2,this.spriteCoord=[0,3]}setPosition(t){this.pos[0]=t[0],this.pos[2]=t[2]}render(t){const e=t.gl;e.useProgram(t.program),e.bindVertexArray(t.quadVao);const[s,i]=this.spriteCoord;t.setTileUV(s,i),e.uniform1i(t.uTiling,0);const n=W();G(n,n,[this.pos[0],.002,this.pos[2]]),Yt(n,n,-Math.PI/2),it(n,n,[this.size,this.size,1]),e.uniformMatrix4fv(t.uModel,!1,n),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0)}}function Rt(h,t,e){const s=(o,l)=>{const a=h.createShader(l);if(!a)throw new Error("Failed to create shader");if(h.shaderSource(a,o),h.compileShader(a),!h.getShaderParameter(a,h.COMPILE_STATUS))throw new Error(h.getShaderInfoLog(a));return a},i=s(t,h.VERTEX_SHADER),n=s(e,h.FRAGMENT_SHADER),r=h.createProgram();if(h.attachShader(r,i),h.attachShader(r,n),h.linkProgram(r),!h.getProgramParameter(r,h.LINK_STATUS))throw new Error(h.getProgramInfoLog(r));return r}async function We(h){const t=new Image;return t.src=h,await t.decode(),t}function Oe(h,t,e,s=1){const r=h*2/1.6/s,o=t*2/2/s,l=[0,0,0,.5,.5],a=[];for(let c=0;c<=e;c++){const d=c/e*2*Math.PI,f=Math.cos(d)*h,u=Math.sin(d)*t,p=f/(h*2)*r+.5,y=u/(t*2)*o+.5;l.push(f,0,u,p,y),c>0&&a.push(0,c,c+1)}return{vertices:new Float32Array(l),indices:new Uint16Array(a)}}function Ve(h=160,t=170,e=50,s=50,i=.4){const n=[],r=[];let o=0;const l=(y,_,w,b,T)=>{const M=w-y,x=b-_,F=Math.hypot(M,x),v=-x/F,k=M/F,L=T/2,B=y+v*L,lt=_+k*L,Q=y-v*L,U=_-k*L,wt=w+v*L,ie=b+k*L,se=w-v*L,ne=b-k*L;n.push(B,0,lt,wt,0,ie,se,0,ne,Q,0,U),r.push(o,o+1,o+2,o,o+2,o+3),o+=4},a=h/2,c=t/2,d=64;for(let y=0;y<d;y++){const _=y/d*2*Math.PI,w=(y+1)/d*2*Math.PI,b=Math.cos(_)*a,T=Math.sin(_)*c,M=Math.cos(w)*a,x=Math.sin(w)*c;l(b,T,M,x,i)}const f=[[-s/2,-s/2],[s/2,-s/2],[s/2,s/2],[-s/2,s/2]];for(let y=0;y<4;y++){const[_,w]=f[y],[b,T]=f[(y+1)%4];l(_,w,b,T,i)}function u(y){const _=y>0?-1:1,w=[];for(let b=0;b<=1e3;b++){const T=-Math.PI+b/1e3*2*Math.PI,M=Math.sin(T)*e,x=y+_*Math.cos(T)*e,F=M/a,v=x/c;F*F+v*v<=1&&w.push(T)}return w.length===0?[-Math.PI/3,Math.PI/3]:[w[0],w[w.length-1]]}const p=40;for(let y of[-t/2,t/2]){const _=y>0?-1:1,[w,b]=u(y);for(let T=0;T<p;T++){const M=w+T/p*(b-w),x=w+(T+1)/p*(b-w),F=Math.sin(M)*e,v=y+_*Math.cos(M)*e,k=Math.sin(x)*e,L=y+_*Math.cos(x)*e;l(F,v,k,L,i)}}return{vertices:new Float32Array(n),indices:new Uint16Array(r)}}const Xe=`#version 300 es
    in vec3 a_position;
    in vec2 a_texcoord;
    uniform mat4 u_projection, u_view, u_model;
    out vec2 v_texcoord;
    void main() {
        gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
        v_texcoord = a_texcoord;
    }
`,Ye=`#version 300 es
    precision mediump float;

    uniform sampler2D u_texture;
    uniform vec4 u_tileUV;
    uniform bool u_tiling;

    in vec2 v_texcoord;
    out vec4 outColor;

    void main() {
        vec2 texCoord;
        if (u_tiling) {
            vec2 tileUV = mod(v_texcoord, 1.0);
            texCoord = mix(u_tileUV.xy, u_tileUV.zw, tileUV);
        } else {
            texCoord = mix(u_tileUV.xy, u_tileUV.zw, v_texcoord);
        }
        vec2 texelSize = 1.0 / vec2(textureSize(u_texture, 0));
        vec2 epsilon = 0.5 * texelSize;
        texCoord = clamp(texCoord, u_tileUV.xy + epsilon, u_tileUV.zw - epsilon);
        vec4 texColor = texture(u_texture, texCoord);

        if (texColor.a < 0.01) discard; // Skip fully transparent fragments

        outColor = texColor;
    }
`,Ne=`#version 300 es
    in vec3 a_position;
    uniform mat4 u_projection;
    uniform mat4 u_view;
    uniform mat4 u_model;
    void main() {
    gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
    }`,Ue=`#version 300 es
    precision mediump float;
    out vec4 outColor;
    void main() {
    outColor = vec4(1, 1, 1, 1);
    }
`,Ut=16,Gt=24,It=512,Bt=768,pt=0,yt=0,Ht=Ut+pt,jt=Gt+yt,K=170,Ge=80,Wt=K/2;class qe{constructor(t,e,s){this.gl=t,this.canvas=e,this.spriteSheet=s,this.sheetCols=32,this.sheetRows=32,this.program=Rt(t,Xe,Ye),this.uProjection=t.getUniformLocation(this.program,"u_projection"),this.uView=t.getUniformLocation(this.program,"u_view"),this.uModel=t.getUniformLocation(this.program,"u_model"),this.uTileUV=t.getUniformLocation(this.program,"u_tileUV"),this.uTiling=t.getUniformLocation(this.program,"u_tiling"),this.uTexture=t.getUniformLocation(this.program,"u_texture"),this.aPos=t.getAttribLocation(this.program,"a_position"),this.aUV=t.getAttribLocation(this.program,"a_texcoord"),this.lineProgram=Rt(t,Ne,Ue),this.lineProj=t.getUniformLocation(this.lineProgram,"u_projection"),this.lineView=t.getUniformLocation(this.lineProgram,"u_view"),this.lineModel=t.getUniformLocation(this.lineProgram,"u_model"),this.linePos=t.getAttribLocation(this.lineProgram,"a_position"),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.depthMask(!0);const i=new Float32Array([-.5,0,0,1,.5,0,1,1,.5,1,1,0,-.5,1,0,0]),n=new Uint16Array([0,1,2,0,2,3]);this.quadVao=t.createVertexArray(),t.bindVertexArray(this.quadVao);const r=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW),t.vertexAttribPointer(this.aPos,2,t.FLOAT,!1,16,0),t.enableVertexAttribArray(this.aPos),t.vertexAttribPointer(this.aUV,2,t.FLOAT,!1,16,8),t.enableVertexAttribArray(this.aUV);const o=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,o),t.bufferData(t.ELEMENT_ARRAY_BUFFER,n,t.STATIC_DRAW);const{vertices:l,indices:a}=Oe(Ge,Wt,64,16);this.fieldVao=t.createVertexArray(),t.bindVertexArray(this.fieldVao);const c=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,c),t.bufferData(t.ARRAY_BUFFER,l,t.STATIC_DRAW),t.vertexAttribPointer(this.aPos,3,t.FLOAT,!1,20,0),t.enableVertexAttribArray(this.aPos),t.vertexAttribPointer(this.aUV,2,t.FLOAT,!1,20,12),t.enableVertexAttribArray(this.aUV);const d=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,d),t.bufferData(t.ELEMENT_ARRAY_BUFFER,a,t.STATIC_DRAW),this.fieldIndices=a.length,this.fieldLineMesh=Ve(),this.lineVao=t.createVertexArray(),t.bindVertexArray(this.lineVao);const f=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,f),t.bufferData(t.ARRAY_BUFFER,this.fieldLineMesh.vertices,t.STATIC_DRAW);const u=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,u),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.fieldLineMesh.indices,t.STATIC_DRAW),t.vertexAttribPointer(this.linePos,3,t.FLOAT,!1,12,0),t.enableVertexAttribArray(this.linePos),this.goalPostPositions=[[-9,0,K],[-3,0,K],[3,0,K],[9,0,K],[-9,0,0],[-3,0,0],[3,0,0],[9,0,0]],t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.spriteSheet),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.texture),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),this.projection=W(),this.view=W(),this.model=W(),this.updateProjection()}updateProjection(){this.projection=W(),ae(this.projection,Math.PI/4,this.canvas.width/this.canvas.height,.1,1e3)}renderSprite(t,e,s,i,n){const{gl:r,program:o,quadVao:l,uModel:a,uTileUV:c,sheetCols:d,sheetRows:f}=this;r.useProgram(o),r.bindVertexArray(l);const u=W();G(u,u,t),it(u,u,[e,s,1]),r.uniformMatrix4fv(a,!1,u),this.setTileUV(i,n),r.uniform1i(this.uTiling,0),r.drawElements(r.TRIANGLES,6,r.UNSIGNED_SHORT,0)}setTileUV(t,e){const s=(t*Ht+pt/2)/It,i=(e*jt+yt/2)/Bt,n=(t*Ht+pt/2+Ut)/It,r=(e*jt+yt/2+Gt)/Bt;this.gl.uniform4f(this.uTileUV,s,i,n,r)}renderScene(t,e){const s=this.gl;s.viewport(0,0,this.canvas.width,this.canvas.height),s.clearColor(.2,.6,.2,1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT);const i=Tt(0,10,15),n=ft();xt(n,t.cameraTarget,i);const r=Tt(0,0,-20),o=ft();xt(o,t.cameraTarget,r),ce(this.view,n,o,[0,1,0]),s.useProgram(this.program),s.uniformMatrix4fv(this.uProjection,!1,this.projection),s.uniformMatrix4fv(this.uView,!1,this.view),s.activeTexture(s.TEXTURE0),s.uniform1i(this.uTexture,0),s.bindVertexArray(this.fieldVao),Xt(this.model),G(this.model,this.model,[0,0,Wt]),s.uniformMatrix4fv(this.uModel,!1,this.model),this.setTileUV(0,2),s.uniform1i(this.uTiling,1),s.drawElements(s.TRIANGLES,this.fieldIndices,s.UNSIGNED_SHORT,0),s.useProgram(this.lineProgram),s.uniformMatrix4fv(this.lineProj,!1,this.projection),s.uniformMatrix4fv(this.lineView,!1,this.view);const c=W();G(c,this.model,[0,.001,0]),s.uniformMatrix4fv(this.lineModel,!1,c),s.bindVertexArray(this.lineVao),s.drawElements(s.TRIANGLES,this.fieldLineMesh.indices.length,s.UNSIGNED_SHORT,0),s.useProgram(this.program),s.bindVertexArray(this.quadVao),this.setTileUV(1,2),s.uniform1i(this.uTiling,1);for(let u=0;u<this.goalPostPositions.length;u++){const[p,y,_]=this.goalPostPositions[u],b=u%4===0||u%4===3?6:10,T=n[0]-p,M=n[2]-_,x=Math.sqrt(T*T+M*M),F=x>50?1.5:x>150?2:1,v=W();G(v,v,[p,y,_]),it(v,v,[F,b,1]),s.uniformMatrix4fv(this.uModel,!1,v),s.drawElements(s.TRIANGLES,6,s.UNSIGNED_SHORT,0)}s.bindVertexArray(this.quadVao);for(const u of e)u instanceof _t&&u.render(this);t.aimTarget.render(this)}}var Y,qt,Zt,Kt;class Ze{constructor(t){St(this,Y);this.state={moveX:0,moveZ:0,kickPressed:!1,kickReleased:!1,kickHeldTime:0,aimTarget:null},this.keys={},this.lastKeys={},this.touchMove=null,this.touchAim=null,this.gamepadAimActive=!1,this.kPressTime=0,t.addEventListener("touchstart",J(this,Y,qt).bind(this),{passive:!1}),t.addEventListener("touchmove",J(this,Y,Zt).bind(this),{passive:!1}),t.addEventListener("touchend",J(this,Y,Kt).bind(this)),window.addEventListener("keydown",e=>this.keys[e.key.toLowerCase()]=!0),window.addEventListener("keyup",e=>this.keys[e.key.toLowerCase()]=!1)}endUpdate(){this.state.moveX=0,this.state.moveZ=0,this.state.kickPressed=!1,this.state.kickReleased=!1}update(t){var n;const e=!!this.keys.k,s=!!this.lastKeys.k;if(e&&!s&&(this.state.kickPressed=!0,this.kPressTime=0,this.state.aimTarget=[0,-10]),e?(this.kPressTime+=t,this.state.aimTarget&&(this.keys.a&&(this.state.aimTarget[0]-=30*t),this.keys.d&&(this.state.aimTarget[0]+=30*t),this.keys.w&&(this.state.aimTarget[1]-=30*t),this.keys.s&&(this.state.aimTarget[1]+=30*t))):(this.keys.a&&(this.state.moveX-=1),this.keys.d&&(this.state.moveX+=1),this.keys.w&&(this.state.moveZ-=1),this.keys.s&&(this.state.moveZ+=1)),!e&&s&&(this.state.kickReleased=!0),this.state.kickHeldTime=this.kPressTime,this.touchMove&&!this.touchAim&&(this.state.moveX=this.touchMove.dx/50,this.state.moveZ=this.touchMove.dy/50),this.touchAim){this.kPressTime+=t;const r=this.touchAim.dx,o=this.touchAim.dy,l=10;this.state.aimTarget=[-r/l,-o/l],this.state.kickHeldTime=this.kPressTime}const i=(n=navigator.getGamepads)==null?void 0:n.call(navigator)[0];if(i){this.state.moveX+=Math.abs(i.axes[0])>.1?i.axes[0]:0,this.state.moveZ+=Math.abs(i.axes[1])>.1?i.axes[1]:0;const r=i.axes[2]||0,o=i.axes[3]||0,l=Math.hypot(r,o);this.gamepadAimActive?(this.kPressTime+=t,this.state.kickHeldTime+=this.kPressTime,o>.025?this.state.aimTarget&&(this.state.aimTarget=[this.state.aimTarget[0]-r/l,this.state.aimTarget[1]-o/l]):(this.state.kickReleased=!0,this.gamepadAimActive=!1)):o>.025&&(this.state.aimTarget=[0,-10],this.state.kickHeldTime=this.kPressTime,this.state.kickPressed=!0,this.gamepadAimActive=!0)}this.lastKeys={...this.keys}}getState(){return this.state}}Y=new WeakSet,qt=function(t){t.preventDefault();for(const e of t.changedTouches)e.clientX<window.innerWidth/2?this.touchMove={id:e.identifier,startX:e.clientX,startY:e.clientY,dx:0,dy:0}:(this.touchAim={id:e.identifier,startX:e.clientX,startY:e.clientY,dx:0,dy:0},this.state.kickPressed=!0,this.kPressTime=0)},Zt=function(t){t.preventDefault();for(const e of t.changedTouches)this.touchMove&&e.identifier===this.touchMove.id&&(this.touchMove.dx=e.clientX-this.touchMove.startX,this.touchMove.dy=e.clientY-this.touchMove.startY),this.touchAim&&e.identifier===this.touchAim.id&&(this.touchAim.dx=e.clientX-this.touchAim.startX,this.touchAim.dy=e.clientY-this.touchAim.startY)},Kt=function(t){t.preventDefault();for(const e of t.changedTouches)this.touchAim&&e.identifier===this.touchAim.id&&(this.touchAim=null,this.state.kickReleased=!0),this.touchMove&&e.identifier===this.touchMove.id&&(this.touchMove=null)};class P extends Array{constructor(t=[0,0]){super(),this[0]=t[0],this[1]=t[1]}equals(t){return this.length===t.length&&this[0]===t[0]&&this[1]===t[1]}static random(t){return new P(De(t[0],t[1]))}add(t){return new P([this[0]+t[0],this[1]+t[1]])}sub(t){return new P([this[0]-t[0],this[1]-t[1]])}floor(){return new P([Math.floor(this[0]),Math.floor(this[1])])}ceil(){return new P([Math.floor(this[0]),Math.floor(this[1])])}scale(t){return new P([this[0]*t,this[1]*t])}mul(t){return new P([this[0]*t[0],this[1]*t[1]])}div(t){return new P([this[0]/t[0],this[1]/t[1]])}dot(t){return this[0]*t[0]+this[1]*t[1]}dist(t){return Math.hypot(this[0]-t[0],this[1]-t[1])}abs(){return new P([Math.abs(this[0]),Math.abs(this[1])])}sum(){return this[0]+this[1]}relativeTo(t){return this.sub(t.pos).div(t.size)}absoluteFrom(t){return this.mul(t.size).add(t.pos)}relativeToPS(t,e){return this.sub(t).scale(1/e)}absoluteFromPS(t,e){return this.scale(e).add(t)}set x(t){this[0]=t}set y(t){this[1]=t}get x(){return this[0]}get y(){return this[1]}}class z extends Array{constructor(t=null){if(super(),t===null){this[0]=0,this[1]=0,this[2]=0,this[3]=0;return}this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3]}set x(t){this[0]=t}set y(t){this[1]=t}set w(t){this[2]=t}set h(t){this[3]=t}set pos(t){this[0]=t[0],this[1]=t[1]}set size(t){this[2]=t[0],this[3]=t[1]}get size(){return new P([this[2],this[3]])}get pos(){return new P([this[0],this[1]])}get x(){return this[0]}get y(){return this[1]}get w(){return this[2]}get h(){return this[3]}get right(){return this[0]+this[2]}get bottom(){return this[1]+this[3]}get center_x(){return this[0]+this[2]/2}get center_y(){return this[1]+this[3]/2}get center(){return new P([this.center_x,this.center_y])}grow(t){return new z([this[0]-t,this[1]-t,this[2]+2*t,this[3]+2*t])}get flooredCenter(){return new P([Math.floor(this[0]+this[2]/2),Math.floor(this[1]+this[3]/2)])}translate(t){return new z([this.x+t[0],this.y+t[1],this.w,this.h])}shrinkBorders(t){return new z([this.x+t,this.y+t,this.w-t*2,this.h-t*2])}scaleBorders(t){return new z([this.x+this.w*(1-t)/2,this.y+this.h*(1-t)/2,this.w*t,this.h*t])}mult(t){return new z([this[0]*t,this[1]*t,this[2]*t,this[3]*t])}multXY(t){return new z([this[0]*t[0],this[1]*t[1],this[2]*t[0],this[3]*t[1]])}scale(t,e=!0){if(e){let s=[this[2]*t,this[3]*t];return new z([this[0]+.5*(this[2]-s[0]),this[1]+.5*(this[3]-s[1]),s[0],s[1]])}else{let s=[this[2]*t,this[3]*t];return new z([this[0],this[1],s[0],s[1]])}}collideRadius(t,e=null){let s=[this.center_x-t.center_x,this.center_y-t.center_y];return e===null&&(e=Math.min(this.w,this.h,t.w,t.h)/2),s[0]*s[0]+s[1]*s[1]<e*e}collide(t){return this.x<t.x+t.w&&this.x+this.w>t.x&&this.y<t.y+t.h&&this.h+this.y>t.y}contains(t){return this.x<=t.x&&this.y<=t.y&&this.x+this.w>=t.x+t.w&&this.y+this.h>=t.y+t.h}contact(t){return this.x<=t.x+t.w&&this.x+this.w>=t.x&&this.y<=t.y+t.h&&this.h+this.y>=t.y}contactRadius(t,e=null){let s=[this.center_x-t.center_x,this.center_y-t.center_y];return e===null&&(e=Math.min(this.w,this.h,t.w,t.h)),s[0]*s[0]+s[1]*s[1]<=e*e}}class ht extends Array{constructor(t=[0,0],e=void 0){e===void 0?super(t[0]*t[1]):super(...e),this.tileDim=new P(t),this.hidden=!1,this._cacheData=null}clone(){return new ht(this.tileDim,this)}get(t){return this[t[0]+t[1]*this.tileDim[0]]}set(t,e){this[t[0]+t[1]*this.tileDim[0]]=e}*iterBetween(t,e,s=0){var i,n,r,o;if([i,n]=t,[r,o]=e,!(Math.abs(o-n)==0&&Math.abs(r-i)==0))if(Math.abs(o-n)>Math.abs(r-i)){var l=(r-i)/(o-n);if(n>o)for(var a=n;a>=o;a--){var c=i+(a-n)*l;yield[c,a]}else for(var a=n;a<=o;a++){var c=i+(a-n)*l;yield[c,a]}}else{var l=(o-n)/(r-i);if(i>r)for(var d=i;d>=r;d--){var f=n+(d-i)*l;yield[d,f]}else for(var d=i;d<=r;d++){var f=n+(d-i)*l;yield[d,f]}}}*iterInBetween(t,e){var s,i,n,r;if([s,i]=t,[n,r]=e,!(Math.abs(r-i)==0&&Math.abs(n-s)==0))if(Math.abs(r-i)>Math.abs(n-s)){var o=(n-s)/(r-i);if(i>r)for(var l=i-1;l>r;l--){var a=Math.round(s+(l-i)*o);yield[a,l]}else for(var l=i+1;l<r;l++){var a=Math.round(s+(l-i)*o);yield[a,l]}}else{var o=(r-i)/(n-s);if(s>n)for(var a=s-1;a>n;a--){var l=Math.round(i+(a-s)*o);yield[a,l]}else for(var a=s+1;a<n;a++){var l=Math.round(i+(a-s)*o);yield[a,l]}}}*iterTypesBetween(t,e,s){for(var i of this.iterBetween(t,e))s.includes(this.get(i))&&(yield i)}*iterTypesInBetween(t,e,s){for(var i of this.iterInBetween(t,e))s.includes(this.get(i))&&(yield i)}hasTypesBetween(t,e,s){for(var i of this.iterTypesBetween(t,e,s))return!0;return!1}hasTypesInBetween(t,e,s){for(var i of this.iterTypesInBetween(t,e,s))return!0;return!1}*iterAll(t=null){const[e,s]=this.tileDim;if(t!==null)for(var i=t[1];i<Math.min(s,t[1]+t[3]);i++)for(var n=t[0];n<Math.min(e,t[0]+t[2]);n++)yield[n,i];else for(var i=0;i<s;i++)for(var n=0;n<e;n++)yield[n,i]}*iterTypes(t,e){for(var s of this.iterAll(e))t.includes(this.get(s))&&(yield s)}*iterAdjacent(t,e=!1){t=new P(t);const s=e?[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]]:[[0,-1],[1,0],[0,1],[-1,0]];for(let i of s){const n=t.add(i);n[0]>=0&&n[0]<this.tileDim[0]&&n[1]>=0&&n[1]<this.tileDim[1]&&(yield n)}}hasAdjacent(t,e,s=!1){for(let i of this.iterAdjacent(t,s))if(e.includes(this.get(i)))return!0;return!1}*iterInRange(t,e){var s,i;[s,i]=t;const[n,r]=this.tileDim;e==null&&(e=3);for(var o=Math.ceil(e),l=-o;l<o+1;l++)for(var a=-o;a<o+1;a++)if(a*a+l*l<=e*e){var c=s+a,d=i+l;0<=d&&d<r&&0<=c&&c<n&&(yield[c,d])}}*iterTypesInRange(t,e,s,i=null){for(var n of this.iterInRange(t,s))i!==null&&this.hasTypesBetween(t,n,i)||e.includes(this.get(n))&&(yield n)}numInRange(t,e,s,i=null){var n=0;for(var r of this.iterTypesInRange(t,e,s,i))n++;return n}*iterRectBoundary(t){const[e,s]=this.tileDim;let i=Math.min(Math.max(t.x,0),e),n=Math.min(Math.max(t.x+t.w,0),e),r=Math.min(Math.max(t.y,0),s),o=Math.min(Math.max(t.y+t.h,0),s);for(let l=i;l<n;l++)yield[l,r];for(let l=i;l<n;l++)yield[l,o];for(let l=r;l<o;l++)yield[i,l];for(let l=r;l<o;l++)yield[n,l]}*iterRect(t,e=!0){const[s,i]=this.tileDim;if(t instanceof z||(t=new z(t)),e&&(t.x<0||t.y<0||t.right>s||t.bottom>i))return;let n=Math.max(t.x,0),r=Math.min(t.x+t.w,s),o=Math.max(t.y,0),l=Math.min(t.y+t.h,i);for(let a=o;a<l;a++)for(let c=n;c<r;c++)yield[c,a]}numInRect(t,e,s=!0){let i=0;for(var n of this.iterRect(t,s))e.includes(this.get(n))&&i++;return i}}const C=8,q=48*(1/window.devicePixelRatio||1);function ut(h,t,e,s,i,n,r){let o=1;e<C&&(o=1/q,h.save(),h.scale(o,o)),h.fillStyle=r,h.font=(e>=C?e:Math.ceil(e/o))+"px "+s,n.x;let l=o*h.measureText(t).width;return e<C&&h.restore(),[l,2*e]}function Ot(h,t,e,s,i,n,r,o){let l=1;e<C&&(l=1/q,h.save(),h.scale(l,l)),h.fillStyle=o,h.font=(e>=C?e:Math.ceil(e/l))+"px "+s;let a=r.x,c=h.measureText(t),d=r.y;switch(i){case"left":break;case"center":a+=(r.w-l*c.width)/2;break;case"right":a+=r.w-l*c.width;break}switch(n){case"top":break;case"middle":d+=r.h/2;break;case"bottom":d+=r.h;break}let u={outText:[[t,a/l,d/l]],color:o,fontName:s,size:e,valign:n};return e<C&&h.restore(),u}function Ke(h,t,e=null){let s=1,i=t.size;switch(e==null&&(e=t.color),i<C&&(s=1/q,h.save(),h.scale(s,s)),t.valign){case"top":h.textBaseline="top";break;case"middle":h.textBaseline="middle";break;case"bottom":h.textBaseline="bottom";break}h.fillStyle=e,h.font=(i>=C?i:Math.ceil(i/s))+"px "+t.fontName;let[n,r,o]=t.outText[0];h.fillText(n,r,o),i<C&&h.restore()}function dt(h,t,e,s,i,n,r,o=!0){let l=1;e<C&&(l=1/q,h.save(),h.scale(l,l)),h.font=(e>=C?e:Math.ceil(e/l))+"px "+s;let a=0,c="",d=Math.min(Math.max(1,Math.ceil(t.length*n.w/h.measureText(t).width/l)),t.length);for(;t!=""||c!="";){if(c==""){let p=t.indexOf(`
`);p>=0?(c=t.slice(0,p),t=t.slice(p+1)):(c=t,t="")}let f=c.slice(0,d),u=l*h.measureText(f).width;if(u>n.w&&d>1)for(;u>n.w&&d>1;)d--,f=c.slice(0,d),u=l*h.measureText(f).width;if(u<n.w&&d<c.length){for(;u<n.w&&d<c.length;)d++,f=c.slice(0,d),u=l*h.measureText(f).width;u>n.w&&d--}if(o&&f[-1]!=""&&c[d]!=" "&&c[d]!="	"){let p=Math.max(f.lastIndexOf(" "),f.lastIndexOf("	"));p>=0&&(d-=f.length-p-1)}d=Math.max(1,d),f=c.slice(0,d),c=c.slice(d),o&&(c=c.trimStart()),a+=e}return a+=e,e<C&&h.restore(),[n.w,a]}function Vt(h,t,e,s,i,n,r,o,l=!0){let a=1;e<C&&(a=1/q,h.save(),h.scale(a,a)),h.fillStyle=o,h.font=(e>=C?e:Math.ceil(e/a))+"px "+s;let c=r.y,d=[],f="",u=Math.min(Math.max(1,Math.ceil(t.length*(r.w/h.measureText(t).width)/a)),t.length);for(;t!=""||f!="";){if(f==""){let M=t.indexOf(`
`);M>=0?(f=t.slice(0,M),t=t.slice(M+1)):(f=t,t="")}let w=r.x,b=f.slice(0,u),T=a*h.measureText(b).width;if(T>r.w&&u>1)for(;T>r.w&&u>1;)u--,b=f.slice(0,u),T=a*h.measureText(b).width;if(T<r.w&&u<f.length){for(;T<r.w&&u<f.length;)u++,b=f.slice(0,u),T=a*h.measureText(b).width;T>r.w&&u--}if(l&&u<f.length&&b[-1]!=""&&f[u]!=" "&&f[u]!="	"){let M=Math.max(b.lastIndexOf(" "),b.lastIndexOf("	"));M>=0&&(u-=b.length-M-1)}switch(u=Math.max(1,u),b=f.slice(0,u),f=f.slice(u),l&&(f=f.trimStart()),T=a*h.measureText(b).width,i){case"left":break;case"center":w+=(r.w-T)/2;break;case"right":w+=r.w-T;break}d.push([b,w/a,c/a]),c+=e}let p=c-r.y,y=0;switch(n){case"top":y=0;break;case"middle":y=(r.h-p)/2+e/2;break;case"bottom":y=r.h-p+e}let _={size:e,fontName:s,outText:d,off:y/a,color:o,valign:n};return e<C&&h.restore(),_}function $e(h,t,e=null){let s=1,i=t.size;switch(e===null&&(e=t.color),i<C&&(s=1/q,h.save(),h.scale(s,s)),t.valign){case"top":h.textBaseline="top";break;case"middle":h.textBaseline="middle";break;case"bottom":h.textBaseline="bottom";break}h.fillStyle=e,h.font=(i>=C?i:Math.ceil(i/s))+"px "+t.fontName;for(let n of t.outText)h.fillText(n[0],n[1],n[2]+(t.off??0));i<C&&h.restore()}const rt=(h,t,e)=>Math.min(Math.max(h,t),e);function Qe(h,t){return new P(h).dist(t)}function D(h){let t,e,s;return[t,e,s]=new N(h).scale(255).map(i=>Math.floor(i)),"#"+t.toString(16).padStart(2,"0")+e.toString(16).padStart(2,"0")+s.toString(16).padStart(2,"0")}class N extends Array{constructor(...t){t.length==1&&t[0]instanceof Array?super(...t[0]):super(...t)}static asRandomFloats(t,e=0,s=1){let i=new N(t);for(let n=0;n<i.length;n++)i[n]=Ae(e,s);return i}sum(){let t=0;return this.forEach(e=>t+=e),t}mean(){return this.sum()/this.length}max(){return Math.max.apply(null,this)}min(){return Math.min.apply(null,this)}vars(){let t=0;return this.forEach(e=>t+=e*e),(t-this.length*this.mean()^2)/(this.length-1)}var(){let t=0;return this.forEach(e=>t+=e*e),t/this.length-this.mean()^2}std(){return Math.sqrt(this.var())}add(t){let e=new N(this);if(t instanceof Array)for(let s=0;s<this.length;s++)e[s]+=t[s];else for(let s=0;s<this.length;s++)e[s]+=t;return e}mul(t){let e=new N(this);if(t instanceof Array)for(let s=0;s<this.length;s++)e[s]*=t[s];else for(let s=0;s<this.length;s++)e[s]*=t;return e}scale(t){const e=Array();for(let s of this)e.push(s*t);return e}dot(t){return this.mul(t).sum()}abs(){return Math.abs.apply(null,this)}lag(t){let e=new N;for(let s=-t;s<this.length-t;s++)s<0||s>=this.length?e.push(NaN):e.push(this[s]);return e}filter(t){return new N(super.filter(t))}dropNaN(){return this.filter(t=>!Number.isNaN(t))}}class O{constructor(t={}){m(this,"identifier",-1);m(this,"pos",[0,0]);m(this,"state","touch_up");m(this,"device","touch");m(this,"nativeObject",null);m(this,"nativeEvent",null);for(let e in t)this[e]=t[e]}copy(){return new O({pos:[...this.pos],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}asChildTouch(t){return new O({pos:[...t.toChild(this.pos)],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}get rect(){return new z([...this.pos,0,0])}set x(t){this.pos[0]=t}set y(t){this.pos[1]=t}get x(){return this.pos[0]}get y(){return this.pos[1]}get grabbed(){return g.get().inputHandler.grabbed}grab(t){g.get().inputHandler.grab(t)}ungrab(){g.get().inputHandler.ungrab()}}class Je{constructor(t){m(this,"grabbed",null);m(this,"mouseTouchEmulation",!0);m(this,"mouseev",null);m(this,"keyStates",{});this.app=t,this.canvas=t.canvas;let e=this.canvas,s=this;document.addEventListener("keydown",function(i){s.process_key(i,"key_down")},!0),document.addEventListener("keyup",function(i){s.process_key(i,"key_up")},!0),e.addEventListener("mousedown",function(i){s.process_mouse(i,"mouse_down")},!0),e.addEventListener("mousemove",function(i){s.process_mouse(i,"mouse_move")},!0),e.addEventListener("mouseout",function(i){s.process_mouse(i,"mouse_cancel")},!0),e.addEventListener("mouseup",function(i){s.process_mouse(i,"mouse_up")},!0),e.addEventListener("touchstart",function(i){s.process_touch(i,"touch_down")},!1),e.addEventListener("touchmove",function(i){s.process_touch(i,"touch_move")},!1),e.addEventListener("touchcancel",function(i){s.process_touch(i,"touch_cancel")},!1),e.addEventListener("touchend",function(i){s.process_touch(i,"touch_up")},!1),e.addEventListener("wheel",function(i){s.process_wheel(i,"wheel")},!0),window.history.replaceState(null,document.title,location.pathname+"#!/backbutton"),window.history.pushState(null,document.title,location.pathname),window.addEventListener("popstate",function(i){s.process_back(i,"back_button")},!1)}grab(t){this.grabbed=t}ungrab(){this.grabbed=null}isKeyUp(t){return t in this.keyStates&&this.keyStates[t]}isKeyDown(t){return t in this.keyStates&&this.keyStates[t]}process_key(t,e){this.app.requestFrameUpdate();const s=this.keyStates[t.key];e==="key_up"?this.keyStates[t.key]=!1:e==="key_down"&&(this.keyStates[t.key]=!0),this.app.emit(e,{states:this.keyStates,oldState:s,event:t})}process_touch(t,e){if(this.app.requestFrameUpdate(),this.grabbed!==null)for(let s of t.changedTouches){let i=this.grabbed.appToChild([s.clientX,s.clientY]),n=new O({pos:i,state:e,nativeObject:s,nativeEvent:t,identifier:s.identifier});this.grabbed.emit(e,n)}else for(let s of t.changedTouches){let i=new O({pos:this.app.toChild([s.clientX,s.clientY]),state:e,nativeObject:s,nativeEvent:t,identifier:s.identifier});this.app.childEmit(e,i,!0)}t.preventDefault()}process_back(t,e){location.hash==="#!/backbutton"&&(history.replaceState(null,document.title,location.pathname),this.app.childEmit("back_button",t))}process_mouse(t,e){if(this.app.requestFrameUpdate(),this.mouseev=t,t.preventDefault(),this.mouseTouchEmulation){let s={mouse_up:"touch_up",mouse_down:"touch_down",mouse_move:"touch_move",mouse_cancel:"touch_cancel"};if(t.buttons!==1&&e!=="mouse_up")return;if(this.grabbed!==null){let i=[t.clientX,t.clientY],n=this.grabbed.appToChild(i),r=new O({pos:n,state:s[e],nativeObject:t,identifier:-1});this.grabbed.emit(s[e],r)}else{let i=new O({pos:this.app.toChild([t.clientX,t.clientY]),state:s[e],nativeObject:t,identifier:-1});this.app.childEmit(s[e],i,!0)}}else this.grabbed!==null?this.grabbed.emit(e,t):this.app.childEmit(e,t,!0)}process_wheel(t,e){if(this.mouseev!=null){if(this.app.requestFrameUpdate(),this.grabbed!=null){let s=this.grabbed.appToChild([this.mouseev.clientX,this.mouseev.clientY]),i=new O({pos:s,state:e,nativeObject:t});return this.grabbed.emit(e,i)}else{let s=new O({pos:this.app.toChild([this.mouseev.clientX,this.mouseev.clientY]),state:e,nativeObject:t});this.app.childEmit(e,s,!0)}t.preventDefault()}}vibrate(t,e,s){window.navigator.vibrate(s)}}function ti(h,t,e,s){if(typeof t=="string"||t instanceof String){if(h.startsWith("on_"))return new Function("resources","parent","root",`return function(event, object, value) {${t}}`).bind(e)(g.resources,e.parent,s);if(t.trim().startsWith("(")&&t.indexOf("=>")<t.indexOf(`
`)){const a=new Function("resources","parent","root",`return ${t}`).bind(e)(g.resources,e.parent,s);return a.markupMethod=!0,a}const i=new Set;let n=0;if(t[0]!=="'"&&t[0]!=='"')for(let a of t.matchAll(/(?!\.)\b([a-z]\w*)\.([a-z_]\w*)\b/ig)){const c=a[1];c!=="this"&&c!=="parent"&&c!=="root"&&c!=="resources"&&i.add(c),n++}if(n===0)return new Function("resources",`return ${t};`)(g.resources);const r=[...i].join(", "),o=`return function (${r}) { return ${t} }`,l=new Function("resources","parent","root",o)(g.resources,e.parent,s).bind(e);return l.text=`(${r}) => ${t}`,l}return t}function $t(h,t,e){const s={},i=h.constructor.name,r={...g.rules.get(i),...t};for(let o in r){const l=r[o];if(o==="children"&&l instanceof Array){const a=[];for(let c of l)if(c instanceof Object&&"cls"in c){const[d,f]=g.classes[c.cls],u=new d;$t(u,c,e),a.push(u)}else throw Error(`Unknown child class ${c} on clsName ${i}`);h instanceof g?h.baseWidget.children=a:h.children=a}else if(o!=="cls")try{s[o]=ti(o,l,h,e)}catch{s[o]=l}}h.updateProperties(s,!1)}class ei{constructor(t,e=0,s=null){this.elapsed=0,this.timer=t,this.triggered=!1,this.callback=s,e>0&&this.tick(e)}finished(){return this.elapsed>=this.timer}tick(t){return this.elapsed>=this.timer?(this.triggered&&(this.triggered=!1),!1):(this.elapsed+=t,this.elapsed>=this.timer?(this.callback!=null&&this.callback("timer",this),this.triggered=!0,!0):!1)}reset(t=-1,e=0){this.triggered=!1,t>=0&&(this.timer=t),e>0&&this.tick(e)}}class ii{constructor(){this.rules=new Map}add(t,e,s=!0){let i=this.rules.get(t);if(i&&!s)for(let n in i)i[n]=e[n];else this.rules.set(t,e)}get(t){return this.rules.get(t)??{}}remove(t){return this.rules.delete(t)}}class si{constructor(t,e,s){this.listener=t,this.event=e,this.callback=s}}class ni{constructor(){this.connections=new Map}bind(t,e,s,i){let n=new si(t,s,i),r=this.connections.get(e);r?r.add(n):this.connections.set(e,new Set([n]))}emit(t,e,s){const i=this.connections.get(t);if(!i)return!1;for(let n of i)if(n.event===e&&n.callback(e,t,s))return!0;return!1}disconnect(t){this.connections.delete(t);for(let e of this.connections.keys()){const s=[],i=this.connections.get(e);if(i){for(let n of i)n.listener===t&&s.push(n);s.forEach(n=>i.delete(n))}}}}class R extends z{constructor(e=null){super();m(this,"bgColor",null);m(this,"outlineColor",null);m(this,"_animation",null);m(this,"_layoutNotify",!1);m(this,"hints",{});return this.parent=null,this._processTouches=!1,this._deferredProps=null,this._children=[],this._needsLayout=!0,e!=null&&this.updateProperties(e),new Proxy(this,{set(s,i,n,r){return typeof i=="string"&&(["x","y","w","h","children","rect"].includes(i)||i[0]=="_")?Reflect.set(s,i,n,r):(Reflect.set(s,i,n,r),typeof i=="string"&&Reflect.apply(s.emit,r,[i,n]),!0)}})}set rect(e){this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this._needsLayout=!0}get rect(){return new z([this[0],this[1],this[2],this[3]])}deferredProperties(e){let s=this._deferredProps;this._deferredProps=null;for(let i in s)if(!i.startsWith("on_")&&!i.startsWith("_")&&typeof s[i]=="function"){let n=s[i],r,o;[r,o]=(n.text??n.toString()).split("=>"),r=r.replace("(","").replace(")","").split(",").map(d=>d.trim());let l=r.map(d=>e.findById(d)),a={};for(let d of r)a[d]=e.findById(d);const c=/(\w+)\.(\w+)/g;for(let d of o.matchAll(c)){let f,u;if([u,f]=d.slice(1),u==="this")this.bind(f,(p,y,_)=>{try{this[i]=n(...l)}catch(w){console.log("Dynamic binding error",this,i,w)}});else if(u in a)try{a[u].bind(f,(p,y,_)=>{try{this[i]=n(...l)}catch(w){console.log("Dynamic binding error",this,i,w)}})}catch(p){console.log(`Warning: ${u} cannot be bound on`,this,`
property`,i,`
error`,p)}}try{this[i]=n(...l)}catch(d){console.log("Dynamic binding error",this,i,d)}}}updateProperties(e,s=!0){s&&$t(this,{},this);for(let i in e)!i.startsWith("on_")&&!i.startsWith("_")&&typeof e[i]=="function"&&!("markupMethod"in e[i])?this._deferredProps=e:this[i]=e[i]}bind(e,s,i=null){g.get()._eventManager.bind(i,this,e,s)}emit(e,s){return"on_"+e in this&&this["on_"+e](e,this,s)?!0:g.get()._eventManager.emit(this,e,s)}*iter(e=!0,s=!0){if(yield this,!!e)for(let i of this._children)yield*i.iter(...arguments)}*iterParents(){this.parent!==null&&(yield this.parent,this.parent!=g.get()&&(yield*this.parent.iterParents()))}findById(e){for(let s of this.iter(!0,!1))if("id"in s&&s.id==e)return s;return null}*iterByPropertyValue(e,s){for(let i of this.iter(!0,!1))e in i&&i[e]==s&&(yield i)}getTransformRecurse(e=!1,s=null){let i=this!==s&&this.parent!==null?this.parent.getTransformRecurse(!0,s):new DOMMatrix;if(!e)return i;let n=this.getTransform();return n?i.multiply(n):i}getTransform(){return null}applyTransform(e,s=!1,i=!1,n=!1,r=null){let o=i?this.getTransformRecurse(n,r):this.getTransform();if(!o)return e;s&&(o=o.inverse());let l=o.transformPoint(new DOMPoint(e.x,e.y));return new P([l.x,l.y])}appToWidget(e,s=!0){if(this.parent){let i=this.parent.getTransformRecurse().inverse().transformPoint(new DOMPoint(e[0],e[1]));return new P([i.x,i.y])}return e}appToChild(e,s=!0){let i=this.getTransformRecurse().inverse().transformPoint(new DOMPoint(e[0],e[1]));return new P([i.x,i.y])}toChild(e){let s=this.getTransform();if(!s)return e;let i=s.inverse().transformPoint(new DOMPoint(e[0],e[1]));return new P([i.x,i.y])}addChild(e,s=-1){s==-1?this._children.push(e):this._children=[...this._children.slice(0,s),e,...this._children.slice(s)],this.emit("child_added",e),e.parent=this,this._needsLayout=!0}removeChild(e,s=!0){this._children=this.children.filter(i=>i!=e),s&&g.get()._eventManager.disconnect(e),this.emit("child_removed",e),e.parent=null,this._needsLayout=!0}get children(){return this._children}set children(e){for(let s of this._children)this.emit("child_removed",s),s.parent=null,this._needsLayout=!0;this._children=[];for(let s of e)this.addChild(s)}set x(e){this._needsLayout=!0,this[0]=e}set center_x(e){this._needsLayout=!0,this[0]=e-this[2]/2}set right(e){this._needsLayout=!0,this[0]=e-this[2]}set y(e){this._needsLayout=!0,this[1]=e}set center_y(e){this._needsLayout=!0,this[1]=e-this[3]/2}set bottom(e){this._needsLayout=!0,this[1]=e-this[3]}set w(e){this._needsLayout=!0,this[2]=e}set h(e){this._needsLayout=!0,this[3]=e}get x(){return this[0]}get center_x(){return this[0]+this[2]/2}get right(){return this[0]+this[2]}get y(){return this[1]}get center_y(){return this[1]+this[3]/2}get bottom(){return this[1]+this[3]}get w(){return this[2]}get h(){return this[3]}on_wheel(e,s,i){for(let n=this._children.length-1;n>=0;n--)if(this._children[n].emit(e,i))return!0;return!1}on_touch_down(e,s,i){let n=this.getTransform();if(n){let r=i.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];for(let l=this._children.length-1;l>=0;l--)if(this._children[l].emit(e,r))return!0}else for(let r=this._children.length-1;r>=0;r--)if(this._children[r].emit(e,i))return!0;return!1}on_touch_up(e,s,i){let n=this.getTransform();if(n){let r=i.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];for(let l=this._children.length-1;l>=0;l--)if(this._children[l].emit(e,r))return!0}else for(let r=this._children.length-1;r>=0;r--)if(this._children[r].emit(e,i))return!0;return!1}on_touch_move(e,s,i){let n=this.getTransform();if(n){let r=i.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];for(let l=this._children.length-1;l>=0;l--)if(this._children[l].emit(e,r))return!0}else for(let r=this._children.length-1;r>=0;r--)if(this._children[r].emit(e,i))return!0;return!1}on_touch_cancel(e,s,i){let n=this.getTransform();if(n){let r=i.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];for(let l=this._children.length-1;l>=0;l--)if(this._children[l].emit(e,r))return!0}else for(let r=this._children.length-1;r>=0;r--)if(this._children[r].emit(e,i))return!0;return!1}on_back_button(e,s,i){return!1}getMetric(e,s,i,n=null,r=null){let o=g.get();if(i===null)return e[s];let l=0,a="relative";for(n=n??this.w,r=r??this.h;;){if(i.constructor==String){let c=i.slice(-2);if(c=="ww"){l=+i.slice(0,-2)*e.w;break}if(c=="wh"){l=+i.slice(0,-2)*e.h;break}if(c=="aw"){l=+i.slice(0,-2)*o.dimW,a="absolute";break}if(c=="ah"){l=+i.slice(0,-2)*o.dimH,a="absolute";break}let d=i.slice(-1);if(d=="w"){l=+i.slice(0,-1)*n;break}if(d=="h"){l=+i.slice(0,-1)*r;break}l=+i;break}if(s=="w"||s=="x"||s=="center_x"||s=="right"){l=+i;break}l=+i;break}return a=="relative"&&(["x","center_x","right"].includes(s)&&(l+=this.x),["y","center_y","bottom"].includes(s)&&(l+=this.y)),l}applyHintMetric(e,s,i,n=null,r=null){let o=g.get();if(i===null)return;let l=0,a="relative";for(n=n??this.w,r=r??this.h;;){if(i.constructor==String){let c=i.slice(-2);if(c=="ww"){l=+i.slice(0,-2)*e.w;break}if(c=="wh"){l=+i.slice(0,-2)*e.h;break}if(c=="aw"){l=+i.slice(0,-2)*o.dimW,a="absolute";break}if(c=="ah"){l=+i.slice(0,-2)*o.dimH,a="absolute";break}let d=i.slice(-1);if(d=="w"){l=+i.slice(0,-1)*n;break}if(d=="h"){l=+i.slice(0,-1)*r;break}l=+i;break}if(s=="w"||s=="x"||s=="center_x"||s=="right"){l=+i*n;break}l=+i*r;break}a=="relative"&&(["x","center_x","right"].includes(s)&&(l+=this.x),["y","center_y","bottom"].includes(s)&&(l+=this.y)),e[s]=l}applyHints(e,s=null,i=null){let n=e.hints;s=s??this.w,i=i??this.h,"w"in n&&n.w!=null&&n.w.constructor==String&&n.w.slice(-2)=="wh"?(n.h!==void 0&&this.applyHintMetric(e,"h",n.h,s,i),n.w!==void 0&&this.applyHintMetric(e,"w",n.w,s,i)):(n.w!==void 0&&this.applyHintMetric(e,"w",n.w,s,i),n.h!==void 0&&this.applyHintMetric(e,"h",n.h,s,i));for(let r in n)r!="w"&&r!="h"&&this.applyHintMetric(e,r,n[r],s,i)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;for(let e of this.children)this.applyHints(e),e.layoutChildren()}_draw(e,s,i){this.draw(e,s);let n=this.getTransform();if(n){s.save(),s.transform(n.a,n.b,n.c,n.d,n.e,n.f);for(let r of this._children)r._draw(e,s,i);s.restore();return}for(let r of this._children)r._draw(e,s,i)}draw(e,s){let i=this.rect;if(s.beginPath(),s.rect(i[0],i[1],i[2],i[3]),this.bgColor!=null){const n=s.fillStyle;s.fillStyle=this.bgColor,s.fill(),s.fillStyle=n}if(this.outlineColor!=null){let n=s.lineWidth;s.lineWidth=1/e.tileSize;const r=s.strokeStyle;s.strokeStyle=this.outlineColor,s.stroke(),s.lineWidth=n,s.strokeStyle=r}}update(e,s){this._deferredProps!=null&&this.deferredProperties(e),this._animation!=null&&(this._animation.update(e,s),e.requestFrameUpdate()),this._needsLayout&&(this.layoutChildren(),e.requestFrameUpdate());for(let i of this._children)i.update(e,s)}}const E=class E extends R{static registerClass(t,e,s){E.classes[t]=[e,s]}constructor(t=null){if(E.appInstance!=null)return E.appInstance;super(),E.appInstance=this,window.app=this,this._eventManager=new ni,this.id="app",this.w=-1,this.h=-1,this._baseWidget=new R({hints:{x:0,y:0,w:1,h:1}}),this._baseWidget.parent=this,this._modalWidgets=[],this._udpateActive=!0,this.pixelSize=1,this.integerTileSize=!1,this.exactDimensions=!1,this.prefDimW=32,this.prefDimH=16,this.dimW=this.prefDimW,this.dimH=this.prefDimH,this.tileSize=this.getTileScale()*this.pixelSize,this.canvasName="canvas",this.canvas=null,this.offsetX=0,this.offsetY=0,this.shakeX=0,this.shakeY=0,this.shakeAmount=0,this.timer_tick=null,this.timers=[],this.continuousFrameUpdates=!1,this._requestedFrameUpdate=!1,t&&this.updateProperties(t)}get baseWidget(){return this._baseWidget}addTimer(t,e){let s=new ei(t,0,e);return this.timers.push(s),s}removeTimer(t){this.timers=this.timers.filter(e=>e!=t)}addModal(t){this._modalWidgets.push(t),this._needsLayout=!0}removeModal(t){this._modalWidgets=this._modalWidgets.filter(e=>e!=t)}static get(){return E.appInstance||(E.appInstance=new E),E.appInstance}start(){let t=this;this.setupCanvas(),this.inputHandler=new Je(this),window.onresize=()=>t.updateWindowSize(),this.updateWindowSize(),setTimeout(()=>this._start(),1)}_start(){this.update()}childEmit(t,e,s=!1){if(s&&this._modalWidgets.length>0)return this._modalWidgets[this._modalWidgets.length-1].emit(t,e);if(this._baseWidget.emit(t,e))return!0;for(let i of this._modalWidgets)if(i.emit(t,e))return!0;return!1}*iter(t=!0,e=!0){yield this,yield*this._baseWidget.iter(...arguments);for(let s of this._modalWidgets)yield*s.iter(...arguments)}findById(t){for(let e of this.iter(!0,!1))if("id"in e&&e.id==t)return e;return null}*iterByPropertyValue(t,e){for(let s of this.iter(!0,!1))t in s&&s[t]===e&&(yield s)}update(){this._udpateActive=!0,this._requestedFrameUpdate=!1;let t=15,e=Date.now();this.timer_tick!=null&&(t=Math.min(e-this.timer_tick,30)),(this.timers.length>0||this._needsLayout)&&this.requestFrameUpdate();for(let s of this.timers)s.tick(t);this._needsLayout&&this.layoutChildren();for(let s of E.resources.values())s.update(this,t);this._baseWidget.update(this,t);for(let s of this._modalWidgets)s.update(this,t);this.ctx&&this._draw(this,this.ctx,t),this.continuousFrameUpdates&&this.requestFrameUpdate(),this.timer_tick=e,this._requestedFrameUpdate&&window.requestAnimationFrame(()=>this.update()),this._udpateActive=!1}requestFrameUpdate(){this._requestedFrameUpdate||(this._udpateActive?this._requestedFrameUpdate=!0:(this._udpateActive=!0,window.requestAnimationFrame(()=>this.update())))}_draw(t,e,s){if(!this.canvas)return;e.clearRect(0,0,this.canvas.width,this.canvas.height),this.shakeX=0,this.shakeY=0,this.screenShake(),e.save();let i=this.getTransform();i&&e.transform(i.a,i.b,i.c,i.d,i.e,i.f),this._baseWidget._draw(t,e,s);for(let n of this._modalWidgets)n._draw(t,e,s);e.restore()}getTransform(t=!0){return new DOMMatrix().translate(this.offsetX+this.shakeX,this.offsetY+this.shakeY).scale(this.tileSize,this.tileSize)}on_prefDimW(t,e,s){this.updateWindowSize()}on_prefDimH(t,e,s){this.updateWindowSize()}on_tileSize(t,e,s){this.prefDimH<0&&this.prefDimW<0&&this.updateWindowSize()}updateWindowSize(){this.x=0,this.y=0,this.w=window.innerWidth,this.h=window.innerHeight,(this.prefDimH>=0||this.prefDimW>=0)&&(this.tileSize=this.getTileScale()),this.fitDimensionsToTileSize(this.tileSize),this.setupCanvas();try{screen.orientation.unlock()}catch{}this._needsLayout=!0,this.requestFrameUpdate()}getTileScale(){let t=this.h,e=this.w,s=1/this.pixelSize;return this.prefDimW<0&&this.prefDimH<0?this.tileSize>0&&(s=this.tileSize/this.pixelSize):this.prefDimW<0?s=t/this.prefDimH/this.pixelSize:this.prefDimH<0?s=e/this.prefDimW/this.pixelSize:s=Math.min(t/this.prefDimH/this.pixelSize,e/this.prefDimW/this.pixelSize),this.integerTileSize&&s>1&&(s=Math.floor(s)),s*this.pixelSize}fitDimensionsToTileSize(t){let e=this.h,s=this.w;if(this.exactDimensions){this.prefDimW<0&&this.prefDimH<0?(this.dimW=s/this.tileSize,this.dimH=e/this.tileSize):this.prefDimH<0?(this.dimW=this.prefDimW,this.dimH=e/this.tileSize):this.prefDimW<0?(this.dimW=s/this.tileSize,this.dimH=this.prefDimH):(this.dimH=this.prefDimH,this.dimW=this.prefDimW);return}this.dimH=Math.floor(e/t),this.dimW=Math.floor(s/t)}setupCanvas(){this.canvas=document.querySelector(this.canvasName),this.canvas&&(this.canvas.width=this.w,this.canvas.height=this.h,this.ctx=this.canvas.getContext("2d"),this.ctx&&(this.ctx.imageSmoothingEnabled=!1,this.offsetX=Math.floor((this.w-this.tileSize*this.dimW)/2),this.offsetY=Math.floor((this.h-this.tileSize*this.dimH)/2)))}applyHints(t){super.applyHints(t,this.dimW,this.dimH)}screenShake(){this.shakeAmount&&this.shakeAmount--;let t=Math.random()*Math.PI*2;this.shakeX=Math.round(Math.cos(t)*this.shakeAmount),this.shakeY=Math.round(Math.sin(t)*this.shakeAmount)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.applyHints(this._baseWidget),this._baseWidget.layoutChildren();for(let t of this._modalWidgets)this.applyHints(t),t.layoutChildren()}};m(E,"appInstance",null),m(E,"rules",new ii),m(E,"resources",new Map),m(E,"classes",{});let g=E;class ot extends R{constructor(e=null){super();m(this,"fontSize",null);m(this,"sizeGroup","");m(this,"clip",!1);m(this,"ignoreSizeForGroup",!1);m(this,"fontName",'"Nimbus Mono PS", "Courier New", monospace');m(this,"text","");m(this,"wrap",!1);m(this,"wrapAtWord",!0);m(this,"align","center");m(this,"valign","middle");m(this,"color","white");this._textData=null,e!==null&&this.updateProperties(e)}on_align(e,s,i){this._needsLayout=!0}on_valign(e,s,i){this._needsLayout=!0}on_wrap(e,s,i){this._needsLayout=!0}on_wrapAtWord(e,s,i){this._needsLayout=!0}on_text(e,s,i){this._needsLayout=!0}on_fontSize(e,s,i){this._needsLayout=!0}on_fontName(e,s,i){this._needsLayout=!0}layoutChildren(){let s=g.get().ctx;if(!s)return;let i=this.fontSize===null?null:this.getMetric(this,"fontSize",this.fontSize);if("h"in this.hints&&this.hints.h==null&&i!==null&&(this[3]=this.wrap?dt(s,this.text,i,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[1]:ut(s,this.text,i,this.fontName,this.align=="center",this.rect,this.color)[1]),"w"in this.hints&&this.hints.w==null&&i!==null&&(this[2]=this.wrap?dt(s,this.text,i,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[0]:ut(s,this.text,i,this.fontName,this.align=="center",this.rect,this.color)[0]),i=i===null?this.h/2:i,this.fontSize===null&&this.rect.w!==void 0){let n=0,r,o;for(;n<50;){if(this.wrap?[r,o]=dt(s,this.text,i,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord):[r,o]=ut(s,this.text,i,this.fontName,this.align=="center",this.rect,this.color),(this.h>=o||"h"in this.hints&&this.hints.h==null||i<.01)&&(this.w>=r||"w"in this.hints&&this.hints.w==null)){"h"in this.hints&&this.hints.h==null&&(this.h=o),"w"in this.hints&&this.hints.w==null&&(this.w=r);break}const l=Math.min(1.1,this.w/r,this.h/o);this.wrap?i*=l**.5:i*=l**1.1,n++}i===void 0&&(i=.001*g.get().h)}this.sizeGroup!==""?(this._bestFontSize=i,this._textData=null):this.wrap?this._textData=Vt(s,this.text,i,this.fontName,this.align,this.valign,this.rect,this.color,this.wrapAtWord):this._textData=Ot(s,this.text,i,this.fontName,this.align,this.valign,this.rect,this.color),super.layoutChildren()}sizeToGroup(e){if(this._bestFontSize===void 0)return;let s=1/0;for(let i of g.get().iterByPropertyValue("sizeGroup",this.sizeGroup))s>i._bestFontSize&&!i.ignoreSizeForGroup&&(s=i._bestFontSize);if(s>0)for(let i of g.get().iterByPropertyValue("sizeGroup",this.sizeGroup)){const n=i.clip||!i.ignoreSizeForGroup?s:i._bestFontSize;i.wrap?i._textData=Vt(e,i.text,n,i.fontName,i.align,i.valign,i.rect,i.color,i.wrapAtWord):i._textData=Ot(e,i.text,n,i.fontName,i.align,i.valign,i.rect,i.color)}}draw(e,s){if(super.draw(e,s),this.clip){s.save();const i=this.rect;s.rect(i.x,i.y,i.w,i.h),s.clip()}!this._textData&&this.sizeGroup!==""&&this.sizeToGroup(s),this._textData&&(this.wrap?$e(s,this._textData,this.color):Ke(s,this._textData,this.color)),this.clip&&s.restore()}}class ri extends ot{constructor(e=null){super();m(this,"bgColor",D([.5,.5,.5]));m(this,"selectColor",D([.7,.7,.8]));m(this,"disableColor1",D([.2,.2,.2]));m(this,"disableColor2",D([.4,.4,.4]));m(this,"disable",!1);e!==null&&this.updateProperties(e)}on_touch_down(e,s,i){return super.on_touch_down(e,s,i)?!0:!this.disable&&this.collide(i.rect)?(i.grab(this),this._touching=!0,!0):!1}on_touch_up(e,s,i){return super.on_touch_up(e,s,i)?!0:i.grabbed!=this?!1:(i.ungrab(),!this.disable&&this.collide(i.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(e,s,i){return super.on_touch_move(e,s,i)?!0:(i.grabbed==this&&!this.disable&&(this._touching=this.collide(i.rect)),!1)}draw(e,s){let i=this.bgColor,n=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(e,s),this.bgColor=i,this.color=n}}class hi extends R{constructor(e=null){super();m(this,"color",D([.8,.8,.8]));m(this,"bgColor",D([.5,.5,.5]));m(this,"selectColor",D([.7,.7,.8]));m(this,"disableColor1",D([.2,.2,.2]));m(this,"disableColor2",D([.4,.4,.4]));m(this,"disable",!1);e!==null&&this.updateProperties(e)}on_touch_down(e,s,i){return super.on_touch_down(e,s,i)?!0:!this.disable&&this.collide(i.rect)?(i.grab(this),this._touching=!0,!0):!1}on_touch_up(e,s,i){return super.on_touch_up(e,s,i)?!0:i.grabbed!=this?!1:(i.ungrab(),!this.disable&&this.collide(i.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(e,s,i){return super.on_touch_move(e,s,i)?!0:(i.grabbed==this&&!this.disable&&(this._touching=this.collide(i.rect)),!1)}draw(e,s){let i=this.bgColor,n=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(e,s),this.bgColor=i,this.color=n}}class Qt extends ot{constructor(e=null){super();m(this,"bgColor",D([.5,.5,.5]));m(this,"pressColor",D([.7,.7,.7]));m(this,"selectColor",D([.7,.7,.8]));m(this,"disableColor1",D([.2,.2,.2]));m(this,"disableColor2",D([.4,.4,.4]));m(this,"disable",!1);m(this,"_press",!1);m(this,"group",null);m(this,"singleSelect",!0);e!==null&&this.updateProperties(e)}get press(){return this._press}set press(e){this._press=e}on_touch_down(e,s,i){return super.on_touch_down(e,s,i)?!0:!this.disable&&this.collide(i.rect)?(i.grab(this),this._touching=!0,!0):!1}on_touch_up(e,s,i){if(i.grabbed!==this)return!1;if(i.ungrab(),this._touching=!1,this.collide(i.rect)){if(this.group===null||!this.singleSelect)this.press=!this.press;else{if(this.parent!==null)for(let n of this.parent.iterByPropertyValue("group",this.group))n!==this&&(n._press=!1);this.press=!0}return!0}return!1}on_touch_move(e,s,i){return i.grabbed===this?(this._touching=this.collide(i.rect),!0):!1}draw(e,s){let i=this.bgColor,n=this.color;this.press&&(this.bgColor=this.pressColor),this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(e,s),this.bgColor=i,this.color=n}}class oi extends R{constructor(e=null){super();m(this,"selectColor",D([.7,.7,.8]));m(this,"color",D([.6,.6,.6]));m(this,"bgColor",D([.5,.5,.5]));m(this,"disableColor1",D([.2,.2,.2]));m(this,"disableColor2",D([.3,.3,.3]));m(this,"disable",!1);m(this,"check",!1);m(this,"group",null);e!==null&&this.updateProperties(e)}on_touch_down(e,s,i){return super.on_touch_down(e,s,i)?!0:!this.disable&&this.collide(i.rect)?(i.grab(this),this._touching=!0,!0):!1}on_touch_up(e,s,i){if(super.on_touch_up(e,s,i))return!0;if(this.parent===null||i.grabbed!=this)return!1;if(i.ungrab(),!this.disable&&this.collide(i.rect)){if(this._touching=!1,this.group==null)this.check=!this.check;else{for(let n of this.parent.iterByPropertyValue("group",this.group))n!=this&&(n.check=!1);this.check=!0}return!0}return!1}on_touch_move(e,s,i){return super.on_touch_move(e,s,i)?!0:i.grabbed==this&&!this.disable?(this._touching=this.collide(i.rect),!0):!1}draw(e,s){if(this.group!=null){let r=this.rect;r.w=r.h=.5*Math.min(r.w,r.h),r.x=this.x+(this.w-r.w)/2,r.y=this.y+(this.h-r.h)/2;let o=g.get().tileSize,l=g.get().ctx;if(!l)return;l.strokeStyle=this.disable?this.disableColor1:this.bgColor,l.lineWidth=1/o,l.beginPath(),l.arc(r.center_x,r.center_y,r.w/2,0,2*Math.PI),l.stroke(),(this._touching||this.disable)&&(l.fillStyle=this.disable?this.disableColor1:this.selectColor,l.fill()),this.check&&(l.fillStyle=this.disable?this.disableColor2:this.color,l.beginPath(),l.arc(r.center_x,r.center_y,r.w/3,0,2*Math.PI),l.fill());return}let i=this.rect;i.w=i.h=.5*Math.min(i.w,i.h),i.x=this.x+(this.w-i.w)/2,i.y=this.y+(this.h-i.h)/2;let n=e.tileSize;s.beginPath(),s.strokeStyle=this.bgColor,this.disable&&(s.strokeStyle=this.disableColor1),s.lineWidth=1/n,s.rect(i[0],i[1],i[2],i[3]),s.stroke(),this._touching&&(s.fillStyle=this.selectColor,s.fill()),this.check&&(s.strokeStyle=this.color,this.disable&&(s.strokeStyle=this.disableColor2),s.beginPath(),s.lineWidth=i.w/5,s.moveTo(i.x,i.y),s.lineTo(i.right,i.bottom),s.moveTo(i.right,i.y),s.lineTo(i.x,i.bottom),s.stroke())}}class li extends R{constructor(e=null){super();m(this,"selectColor",D([.7,.7,.8]));m(this,"color",D([.6,.6,.6]));m(this,"bgColor",D([.4,.4,.4]));m(this,"disableColor1",D([.2,.2,.2]));m(this,"disableColor2",D([.3,.3,.3]));m(this,"disable",!1);m(this,"min",0);m(this,"max",1);m(this,"curMax",1);m(this,"unboundedStopMultiple",10);m(this,"exponentialSlider",!1);m(this,"step",null);m(this,"orientation","horizontal");m(this,"value",0);m(this,"sliderSize",.2);e!==null&&this.updateProperties(e)}setValue(e){let s=this.max??this.curMax,i=0;this.orientation=="horizontal"&&(i=rt((e.rect.x-this.x-this.w*this.sliderSize/2)/(this.w*(1-this.sliderSize)),0,1)),this.orientation=="vertical"&&(i=rt((e.rect.y-this.y-this.h*this.sliderSize/2)/(this.h*(1-this.sliderSize)),0,1)),this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?i=i>.5?s/this.unboundedStopMultiple+(i-.5)/.5*(s-s/this.unboundedStopMultiple):this.min+i/.5*(s/this.unboundedStopMultiple-this.min):i=this.min+(s-this.min)*i,this.step!=null&&(i=Math.round(i/this.step)*this.step),this.value=i}on_touch_down(e,s,i){return super.on_touch_down(e,s,i)?!0:!this.disable&&this.collide(i.rect)?(i.grab(this),this._touch=!0,this.setValue(i),!0):!1}updateMax(){this.max===null&&(this.curMax=this.unboundedStopMultiple*this.value)}on_touch_up(e,s,i){return i.grabbed!=this?super.on_touch_up(e,s,i):(i.ungrab(),!this.disable&&this.collide(i.rect)&&(this._touching=!1,this.setValue(i)),this.updateMax(),!0)}on_touch_move(e,s,i){return i.grabbed!==this?super.on_touch_move(e,s,i):(this.disable||(this._touching=this.collide(i.rect),this.setValue(i)),!1)}draw(e,s){let i=e.tileSize,n=this.rect;if(this.orientation=="horizontal"){n.w-=this.sliderSize*this.w,n.x+=this.sliderSize/2*this.w;let r=Math.min(this.sliderSize/2*this.w,this.h/2)/2;s.strokeStyle=this.disable?this.disableColor1:this.bgColor,s.beginPath(),s.lineWidth=4/i,s.moveTo(n.x,n.center_y),s.lineTo(n.right,n.center_y),s.stroke();let o=this.max??this.curMax,l;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?l=this.value>o/this.unboundedStopMultiple?(.5+.5*(this.value-o/this.unboundedStopMultiple)/(o-o/this.unboundedStopMultiple))*n.w:.5*(this.value-this.min)/(o/this.unboundedStopMultiple-this.min)*n.w:l=(this.value-this.min)/(o-this.min)*n.w,s.strokeStyle=this.disable?this.disableColor2:this.bgColor,s.beginPath(),s.arc(n.x+l,n.center_y,r,0,2*Math.PI),s.stroke(),s.fillStyle=this.color,(this._touching||this.disable)&&(s.fillStyle=this.disable?this.disableColor1:this.selectColor),s.fill()}if(this.orientation=="vertical"){n.h-=this.sliderSize*this.h,n.y+=this.sliderSize/2*this.h;let r=Math.min(this.sliderSize/2*this.h,this.w/2)/2;s.strokeStyle=this.disable?this.disableColor1:this.bgColor,s.beginPath(),s.lineWidth=4/i,s.moveTo(n.center_x,n.y),s.lineTo(n.center_x,n.bottom),s.stroke();let o=this.max??this.curMax,l;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?l=this.value>o/this.unboundedStopMultiple?(.5+.5*(this.value-o/this.unboundedStopMultiple)/(o-o/this.unboundedStopMultiple))*n.h:.5*(this.value-this.min)/(o/this.unboundedStopMultiple-this.min)*n.h:l=(this.value-this.min)/(o-this.min)*n.h,s.strokeStyle=this.disable?this.disableColor2:this.bgColor,s.beginPath(),s.arc(n.center_x,n.y+l,r,0,2*Math.PI),s.stroke(),s.fillStyle=this.color,(this._touching||this.disable)&&(s.fillStyle=this.disable?this.disableColor1:this.selectColor),s.fill()}}}class ai extends ot{constructor(e={}){super();m(this,"_activeDOMInput",null);m(this,"focus",!0);m(this,"disable",!1);m(this,"_inputSanitizer");this._textData=null,e!==null&&this.updateProperties(e)}on_touch_down(e,s,i){return super.on_touch_down(e,s,i)?!0:!this.disable&&this.collide(i.rect)?(i.grab(this),this._touching=!0,!0):(this.clearDOM(),!1)}on_touch_up(e,s,i){return super.on_touch_up(e,s,i)?!0:i.grabbed!=this?!1:!this.disable&&this.collide(i.rect)?(this._touching=!1,this.addDOMInput(),!0):(this.clearDOM(),!1)}on_layout(e,s,i){this.clearDOM()}DOMInputRect(){let e=this.rect,s=this.getTransformRecurse(),i=new z,n=s.transformPoint(new DOMPoint(e.x,e.y)),r=s.transformPoint(new DOMPoint(e.right,e.bottom));return[i.x,i.y]=[n.x,n.y],[i.w,i.h]=[r.x,r.y],i.w-=i.x,i.h-=i.y,i}addDOMInput(){if(!this._textData)return;g.get();let e=document.getElementById("eskvapp");if(!e)return;let s=this.wrap?"textarea":"input",i=document.createElement(s);if(!(i instanceof HTMLInputElement)&&!(i instanceof HTMLTextAreaElement))return;let n,r=this.DOMInputRect(),o=this.color!=null?this.color:"white",l=this.bgColor!=null?this.bgColor:"black";i.style.color=o,n=this._textData.size/this.h*r.h/this._textData.outText.length,s=="textarea"&&this._textData.outText.length,i.value=this.text,n=(Math.floor(n*100)/100).toString()+"px",i.style.fontSize=n,i.style.backgroundColor=l,i.style.top=(Math.floor(r.y*100)/100).toString()+"px",i.style.left=(Math.floor(r.x*100)/100).toString()+"px",i.style.width=(Math.floor(r.w*100)/100).toString()+"px",i.style.height=(Math.floor(r.h*100)/100).toString()+"px",i.style.fontFamily=this.fontName,this._activeDOMInput=i,e.appendChild(i),i.addEventListener("focusout",a=>this.clearDOM()),i.focus(),i.select(),this.focus=!0}clearDOM(){if(this._activeDOMInput!=null){this.text=this._inputSanitizer?this._inputSanitizer(this._activeDOMInput.value,this):this._activeDOMInput.value;let e=this._activeDOMInput;this._activeDOMInput=null,e.remove(),this.focus=!1,this._needsLayout=!0;let s=g.get().inputHandler;(s==null?void 0:s.grabbed)===this&&s.ungrab()}}layoutChildren(){if(super.layoutChildren(),this._activeDOMInput!=null){let e=this.DOMInputRect(),s=this._activeDOMInput;s.style.top=(Math.floor(e.y*100)/100).toString()+"px",s.style.left=(Math.floor(e.x*100)/100).toString()+"px",s.style.width=(Math.floor(e.w*100)/100).toString()+"px",s.style.height=(Math.floor(e.h*100)/100).toString()+"px"}}}class ci extends R{constructor(e=null){super();m(this,"bgColor",null);m(this,"outlineColor",null);m(this,"src",null);m(this,"lockAspect",!0);m(this,"scaleToFit",!0);m(this,"antiAlias",!0);m(this,"angle",0);m(this,"anchor","center");m(this,"mirror",!1);this.image=new Image,e!==null&&this.updateProperties(e),this.src&&(this.image.src=this.src)}on_src(e,s,i){this.src?this.image.src=this.src:this.image.src=""}layoutChildren(){this._layoutNotify&&this.emit("layout",null);let e=g.get();"w"in this.hints&&this.hints.w==null&&(this[2]=this.image.width/e.tileSize),"h"in this.hints&&this.hints.h==null&&(this[3]=this.image.height/e.tileSize),this._needsLayout=!1,super.layoutChildren()}draw(e,s){if(super.draw(e,s),!this.image.complete||this.image.naturalHeight==0)return;let i=this.rect;if(this.scaleToFit||(i.x+=i.w/2-this.image.width/2/e.tileSize,i.y+=i.h/2-this.image.height/2/e.tileSize,i.w=this.image.width/e.tileSize,i.h=this.image.height/e.tileSize),this.lockAspect){let r=this.image.height/this.image.width,o=i.h/i.w,l=i.h,a=i.w;r<o&&(l=i.w*r),r>o&&(a=i.h/r),i.x+=i.w/2-a/2,i.y+=i.h/2-l/2,i.w=a,i.h=l}s.save(),s.imageSmoothingEnabled=this.antiAlias;let n=this.anchor;n=="center"?n=[i.w/2,i.h/2]:n=[n[0]*i.w,n[1]*i.h],this.mirror&&s.scale(-1,1),s.translate(i.x+n[0],i.y+n[1]),this.angle!=0&&s.rotate(this.angle),s.translate(-n[0],-n[1]),s.drawImage(this.image,0,0,this.image.width,this.image.height,0,0,i.w,i.h),s.restore()}}class bt extends R{constructor(e=null){super();m(this,"spacingX",0);m(this,"spacingY",0);m(this,"paddingX",0);m(this,"paddingY",0);m(this,"orientation","vertical");m(this,"order","forward");e!==null&&this.updateProperties(e)}*iterChildren(){if(this.order==="forward")for(let e of this._children)yield e;else for(let e=this._children.length-1;e>=0;e--)yield this._children[e]}on_numX(e,s,i){this._needsLayout=!0}on_numY(e,s,i){this._needsLayout=!0}on_spacingX(e,s,i){this._needsLayout=!0}on_spacingY(e,s,i){this._needsLayout=!0}on_paddingX(e,s,i){this._needsLayout=!0}on_paddingY(e,s,i){this._needsLayout=!0}on_orientation(e,s,i){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let e=this.getMetric(this,"spacingX",this.spacingX),s=this.getMetric(this,"spacingY",this.spacingY),i=this.getMetric(this,"paddingX",this.paddingX),n=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation==="vertical"){let r=this.children.length,o=this.h-s*(r-1)-2*n,l=this.w-2*i,a=0;for(let p of this.iterChildren())p.w=l,this.applyHints(p,l,o),"h"in p.hints&&(p.hints.h===null&&p.layoutChildren(),a+=p.h,r--);let c=(o-a)/r,d=l;(r===0&&o>0||c<0)&&(n=(o-a)/2);let f=this.y+n,u=this.x+i;for(let p of this.iterChildren())p.y=f,"w"in p.hints||(p.w=d),"h"in p.hints||(p.h=c),!("x"in p.hints)&&!("center_x"in p.hints)&&!("right"in p.hints)&&(p.x=u,l!==p.w&&(p.x+=(l-p.w)/2)),p.layoutChildren(),f+=s+p.h;if(r===0&&"h"in this.hints&&this.hints.h===null){const p=this[3];this[3]=f+2*n-this.y,Math.abs(p-this[3])>1e-6&&(g.get()._needsLayout=!0)}return}if(this.orientation==="horizontal"){let r=this.children.length,o=this.h-2*n,l=this.w-e*(r-1)-2*i,a=0;for(let p of this.iterChildren())p.h=o,this.applyHints(p,l,o),"w"in p.hints&&(p.hints.w===null&&p.layoutChildren(),a+=p.w,r--);let c=o,d=(l-a)/r;(r===0&&l>0||d<0)&&(i=(l-a)/2);let f=this.y+n,u=this.x+i;for(let p of this.iterChildren())p.x=u,"w"in p.hints||(p.w=d),"h"in p.hints||(p.h=c),!("y"in p.hints)&&!("center_y"in p.hints)&&!("bottom"in p.hints)&&(p.y=f,o!==p.h&&(p.y+=(o-p.h)/2)),p.layoutChildren(),u+=e+p.w;if(r==0&&"w"in this.hints&&this.hints.w==null){const p=this[2];this[2]=u+2*i-this.x,Math.abs(p-this[2])>1e-6&&(g.get()._needsLayout=!0)}}}}class Jt extends R{constructor(e=null){super();m(this,"activePage",0);e!==null&&this.updateProperties(e)}on_wheel(e,s,i){const n=this.children[this.activePage]??void 0;return!!(n!==void 0&&n.emit(e,i))}on_touch_down(e,s,i){let n=this.getTransform();if(n){let r=i.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(e,r))return!0}else{const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(e,i))return!0}return!1}on_touch_up(e,s,i){let n=this.getTransform();if(n){let r=i.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(e,r))return!0}else{const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(e,i))return!0}return!1}on_touch_move(e,s,i){let n=this.getTransform();if(n){let r=i.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(e,r))return!0}else{const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(e,i))return!0}return!1}on_touch_cancel(e,s,i){let n=this.getTransform();if(n){let r=i.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(e,r))return!0}else{const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(e,i))return!0}return!1}on_activePage(e,s,i){this._needsLayout=!0}_draw(e,s,i){this.draw(e,s);let n=this.getTransform();if(n){s.save(),s.transform(n.a,n.b,n.c,n.d,n.e,n.f);let o=this.children[this.activePage]??void 0;o!==void 0&&o._draw(e,s,i),s.restore();return}let r=this.children[this.activePage]??void 0;r!==void 0&&r._draw(e,s,i)}}class ui extends Jt{constructor(e=null){super();m(this,"tabHeightHint","1");m(this,"tabGroupName","tabbedNotebookGroup");this.buttonBox=new bt({orientation:"horizontal",hints:{h:this.tabHeightHint,w:null}}),this.buttonScroller=new te({id:"_scrollview",hints:{h:this.tabHeightHint,w:1},children:[this.buttonBox]}),this._children=[this.buttonScroller],this.buttonScroller.parent=this,e!==null&&this.updateProperties(e),this.updateButtons()}on_tabHeightHint(e,s,i){this.buttonBox.hints.h=this.tabHeightHint}on_child_added(e,s,i){this.updateButtons()}on_child_removed(e,s,i){this.updateButtons()}on_wheel(e,s,i){const n=this._children[0]??void 0;if(n!==void 0&&n.emit(e,i))return!0;const r=this.children[this.activePage]??void 0;return!!(r!==void 0&&r.emit(e,i))}on_touch_down(e,s,i){let n=this.getTransform();if(n){let r=i.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];const l=this._children[0]??void 0;if(l!==void 0&&l.emit(e,r))return!0;const a=this.children[this.activePage]??void 0;if(a!==void 0&&a.emit(e,r))return!0}else{const r=this._children[0]??void 0;if(r!==void 0&&r.emit(e,i))return!0;const o=this.children[this.activePage]??void 0;if(o!==void 0&&o.emit(e,i))return!0}return!1}on_touch_up(e,s,i){let n=this.getTransform();if(n){let r=i.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];const l=this._children[0]??void 0;if(l!==void 0&&l.emit(e,r))return!0;const a=this.children[this.activePage]??void 0;if(a!==void 0&&a.emit(e,r))return!0}else{const r=this._children[0]??void 0;if(r!==void 0&&r.emit(e,i))return!0;const o=this.children[this.activePage]??void 0;if(o!==void 0&&o.emit(e,i))return!0}return!1}on_touch_move(e,s,i){let n=this.getTransform();if(n){let r=i.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];const l=this._children[0]??void 0;if(l!==void 0&&l.emit(e,r))return!0;const a=this.children[this.activePage]??void 0;if(a!==void 0&&a.emit(e,r))return!0}else{const r=this._children[0]??void 0;if(r!==void 0&&r.emit(e,i))return!0;const o=this.children[this.activePage]??void 0;if(o!==void 0&&o.emit(e,i))return!0}return!1}on_touch_cancel(e,s,i){let n=this.getTransform();if(n){let r=i.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];const l=this._children[0]??void 0;if(l!==void 0&&l.emit(e,r))return!0;const a=this.children[this.activePage]??void 0;if(a!==void 0&&a.emit(e,r))return!0}else{const r=this._children[0]??void 0;if(r!==void 0&&r.emit(e,i))return!0;const o=this.children[this.activePage]??void 0;if(o!==void 0&&o.emit(e,i))return!0}return!1}get children(){return this._children.slice(1)}set children(e){for(let s of this._children.slice(1))this.emit("child_removed",s),s.parent=null,this._needsLayout=!0,this.updateButtons();this._children=this._children.slice(0,1);for(let s of e)this.addChild(s)}updateButtons(){this.buttonBox.children=[];let e=0;for(let s of this.children){const i=new Qt({text:s.name??String(e+1),group:this.tabGroupName,singleSelect:!0,press:this.activePage===e,fontSize:"0.5",hints:{h:null,w:null}});i.bind("press",(n,r,o)=>{this.activePage=this.buttonBox.children.findIndex(l=>l===r)}),this.buttonBox.addChild(i),e++}}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;const e=this._children[0];this.applyHints(e),e.x=this.x,e.y=this.y,e.layoutChildren();const s=this.h-e.h,i=this.w;for(let n of this.children)n.y=this.y+e.h,n.x=this.x,n.w=i,n.h=s,n.layoutChildren()}_draw(e,s,i){this.draw(e,s);let n=this.getTransform();if(n){s.save(),s.transform(n.a,n.b,n.c,n.d,n.e,n.f);let l=this._children[0]??void 0;l!==void 0&&l._draw(e,s,i);let a=this.children[this.activePage]??void 0;a!==void 0&&a._draw(e,s,i),s.restore();return}let r=this._children[0]??void 0;r!==void 0&&r._draw(e,s,i);let o=this.children[this.activePage]??void 0;o!==void 0&&o._draw(e,s,i)}}class di extends R{constructor(e=null){super();m(this,"numX",1);m(this,"numY",1);m(this,"spacingX",0);m(this,"spacingY",0);m(this,"paddingX",0);m(this,"paddingY",0);m(this,"orientation","horizontal");e!==null&&this.updateProperties(e)}on_numX(e,s,i){this._needsLayout=!0}on_numY(e,s,i){this._needsLayout=!0}on_spacingX(e,s,i){this._needsLayout=!0}on_spacingY(e,s,i){this._needsLayout=!0}on_paddingX(e,s,i){this._needsLayout=!0}on_paddingY(e,s,i){this._needsLayout=!0}on_orientation(e,s,i){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let e=this.getMetric(this,"spacingX",this.spacingX),s=this.getMetric(this,"spacingY",this.spacingY),i=this.getMetric(this,"paddingX",this.paddingX),n=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation=="horizontal"){let r=this.numX,o=Math.ceil(this.children.length/this.numX),l=this.h-s*(o-1)-2*n,a=this.w-e*(r-1)-2*i,c=new Array(r).fill(0),d=new Array(o).fill(0),f=0,u=0,p=0;for(let v of this.children)this.applyHints(v,a,l),"w"in v.hints&&(c[u]=Math.max(v.w,c[u])),"h"in v.hints&&(d[f]=Math.max(v.h,d[f])),(p+1)%r==0?(f++,u=0):u++,p++;let y=0,_=0,w=0,b=0;for(let v of c)y+=v,v>0&&w++;for(let v of d)_+=v,v>0&&b++;let T=o>b?(l-_)/(o-b):0,M=r>w?(a-y)/(r-w):0,x=this.y+n,F=this.x+i;f=0,u=0;for(let v=0;v<this.children.length;v++){let k=this.children[v],L=c[u]==0?M:c[u],B=d[f]==0?T:d[f];"w"in k.hints||(k.w=L),"h"in k.hints||(k.h=B),k.x=F,k.y=x,k.layoutChildren(),(v+1)%r==0?(F=this.x+i,x+=s+B,u=0,f++):(F+=e+L,u++)}return}else{let r=Math.ceil(this.children.length/this.numY),o=this.numY,l=this.h-s*(o-1)-2*n,a=this.w-e*(r-1)-2*i,c=new Array(r).fill(0),d=new Array(o).fill(0),f=0,u=0,p=0;for(let v of this.children)this.applyHints(v,a,l),"w"in v.hints&&(c[u]=Math.max(v.w,c[u])),"h"in v.hints&&(d[f]=Math.max(v.h,d[f])),(p+1)%o==0?(u++,f=0):f++,p++;let y=0,_=0,w=0,b=0;for(let v of c)y+=v,v>0&&w++;for(let v of d)_+=v,v>0&&b++;let T=o>b?(l-_)/(o-b):0,M=r>w?(a-y)/(r-w):0,x=this.y+n,F=this.x+i;f=0,u=0;for(let v=0;v<this.children.length;v++){let k=this.children[v],L=c[u]==0?M:c[u],B=d[f]==0?T:d[f];"w"in k.hints||(k.w=L),"h"in k.hints||(k.h=B),k.x=F,k.y=x,k.layoutChildren(),(v+1)%o==0?(x=this.y+n,F+=e+L,f=0,u++):(x+=s+B,f++)}}}}class te extends R{constructor(e=null){super();m(this,"_scrollX",0);m(this,"_scrollY",0);m(this,"scrollX",0);m(this,"scrollY",0);m(this,"scrollW",!0);m(this,"scrollH",!0);m(this,"wAlign","center");m(this,"hAlign","top");m(this,"uiZoom",!0);m(this,"uiMove",!0);m(this,"zoom",1);m(this,"vel",null);m(this,"velCutoff",1e-5);m(this,"velDecay",.95);m(this,"unboundedH",!1);m(this,"unboundedW",!1);m(this,"_zoomCenter",null);e!==null&&this.updateProperties(e),this._processTouches=!0,this._oldTouch=null,this._lastDist=null}on_child_added(e,s,i){this.children.length==1&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0,i.bind("rect",(n,r,o)=>this._needsLayout=!0),i.bind("w",(n,r,o)=>this._needsLayout=!0),i.bind("h",(n,r,o)=>this._needsLayout=!0))}on_child_removed(e,s,i){this.children.length==0&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.children[0][0]=0,this.children[0][1]=0,this.scrollW||(this.children[0][2]=this.w),this.scrollH||(this.children[0][3]=this.h);for(let e of this.children)e.layoutChildren()}fitToClient(){this.zoom=Math.min(this.w/this.children[0].w,this.h/this.children[0].h),this.scrollX=.5*this.scrollableW,this.scrollY=.5*this.scrollableH}on_uiZoom(e,s,i){this._needsLayout=!0}on_hAlign(e,s,i){this._needsLayout=!0}on_vAlign(e,s,i){this._needsLayout=!0}*iter(e=!0,s=!0){if(yield this,!!e)if(s)for(let i of this._children)this.contains(i)&&(yield*i.iter(...arguments));else for(let i of this._children)yield*i.iter(...arguments)}on_scrollW(e,s,i){this._needsLayout=!0,this.scrollX=0}on_scrollH(e,s,i){this._needsLayout=!0,this.scrollY=0}on_scrollX(e,s,i){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedW){this._scrollX=this.scrollX;return}let n=0;switch(this.wAlign){case"center":n=.5*this.scrollableW;break;case"right":n=1*this.scrollableW}this._scrollX=this.scrollableW<=0||this.scrollableW>=this.children[0].w?n:i,this._scrollX=rt(i,0,this.scrollableW)}on_scrollY(e,s,i){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedH){this._scrollY=this.scrollY;return}let n=0;switch(this.hAlign){case"middle":n=.5*this.scrollableH;break;case"bottom":n=1*this.scrollableH}this._scrollY=this.scrollableH<=0||this.scrollableH>=this.children[0].h?n:i,this._scrollY=rt(i,0,this.scrollableH)}update(e,s){if(super.update(e,s),this.vel!==null){this.scrollX+=this.vel.x*s,this.scrollY+=this.vel.y*s,this.vel=this.vel.scale(this.velDecay**(s/30));let i=this.vel.abs();i.x<=this.velCutoff/this.zoom&&i.y<=this.velCutoff/this.zoom&&(this.vel=null)}}getTransform(){const e=g.get().tileSize;return new DOMMatrix().translate(Math.floor((this.x-this._scrollX*this.zoom)*e)/e,Math.floor((this.y-this._scrollY*this.zoom)*e)/e).scale(this.zoom,this.zoom)}on_touch_down(e,s,i){this.vel=null;let n=i.rect;if(this._lastDist=null,this.collide(n)){let r=Date.now(),o=i.asChildTouch(this);return this._oldTouch=[o.x,o.y,o.identifier,r,null],super.on_touch_down(e,s,i)||i.grab(this),!0}return!1}on_touch_up(e,s,i){if(i.grabbed!==this)return!1;if(this._oldTouch!=null){let n=this._oldTouch[4],r=new P([this._oldTouch[0],this._oldTouch[1]]),o=i.asChildTouch(this),l=Math.max(Date.now()-this._oldTouch[3],1),a=this.scrollableW>0||this.unboundedW?(o.x-r.x)/l:0,c=this.scrollableH>0||this.unboundedH?(o.y-r.y)/l:0;this.vel=new P([-a,-c]),n&&(this.vel=this.vel.add(n).scale(.5))}return this._oldTouch=null,this._lastDist=null,this._zoomCenter=null,i.ungrab(),!1}on_touch_move(e,s,i){if(i.grabbed!==this)return!1;let n=i.rect;if(this.collide(n)){let r=i.asChildTouch(this);if((this.uiMove&&i.nativeEvent==null||i.nativeEvent instanceof TouchEvent&&i.nativeEvent.touches.length==1)&&this._oldTouch!=null&&i.identifier==this._oldTouch[2]){this.scrollW&&(this.scrollX=this.scrollableW==0?0:this._scrollX+(this._oldTouch[0]-r.x)),this.scrollH&&(this.scrollY=this.scrollableH==0?0:this._scrollY+(this._oldTouch[1]-r.y));let o=i.asChildTouch(this),l=this._oldTouch,a=Date.now(),c=new P([0,0]),d=new P([0,0]);if(l!=null){let u=Math.max(a-l[3],1),p=this.scrollableW>0||this.unboundedW?(o.x-r.x)/u:0,y=this.scrollableH>0||this.unboundedH?(o.y-r.y)/u:0;c=new P([p,y]),d=l[4]!==null?l[4]:d}let f=c.abs().sum()===0?c:c.add(d).scale(.5);this._oldTouch=[o.x,o.y,i.identifier,a,f]}if(this.uiZoom&&i.nativeEvent&&i.nativeEvent instanceof TouchEvent&&i.nativeEvent.touches.length==2){let o=i.nativeEvent.touches[0],l=i.nativeEvent.touches[1],a=Qe([o.clientX,o.clientY],[l.clientX,l.clientY]);if(this._lastDist!=null){let c=this._scrollX+this.w/this.zoom/2,d=this._scrollY+this.h/this.zoom/2,f=[o.clientX,o.clientY],u=[l.clientX,l.clientY],p=this.appToChild(f),y=this.appToChild(u),_=[(p[0]+y[0])/2,(p[1]+y[1])/2];this._zoomCenter===null&&(this._zoomCenter=new P(_));let w=this.zoom*a/this._lastDist,b=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(w,b);let T=this.appToChild(f),M=this.appToChild(u),x=[(T[0]+M[0])/2,(T[1]+M[1])/2];this.scrollX=c+_[0]-x[0]-this.w/this.zoom/2,this.scrollY=d+_[1]-x[1]-this.h/this.zoom/2}this._lastDist=a}}return!1}on_touch_cancel(e,s,i){return this._lastDist=null,i.grabbed===this?(i.ungrab(),!0):!!super.on_touch_cancel(e,s,i)}on_wheel(e,s,i){let n=g.get();if(!n.inputHandler)return!0;let r=this._scrollX+this.w/this.zoom/2,o=this._scrollY+this.h/this.zoom/2,l=i.nativeObject;if(!this.collide(i.rect)&&(!this.unboundedW||!this.unboundedH)||!(l instanceof WheelEvent))return!1;if(this.uiZoom&&n.inputHandler.isKeyDown("Control")){let a=i.asChildTouch(this);a.pos[0],a.pos[1];let c=this.zoom*Math.exp(-l.deltaY/n.h),d=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(c,d);let f=i.asChildTouch(this);return f.pos[0],f.pos[1],this.scrollX=this.scrollableW==0&&!this.unboundedW?0:r-this.w/this.zoom/2,this.scrollY=this.scrollableH==0&&!this.unboundedH?0:o-this.h/this.zoom/2,this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}else{if(this.uiMove&&this.scrollW&&n.inputHandler.isKeyDown("Shift"))return this.scrollX+=this.scrollableW==0&&!this.unboundedW?0:this.w/this.zoom*(l.deltaY/n.w),this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),!0;if(this.uiMove&&this.scrollH)return this.scrollY+=this.scrollableH==0&&!this.unboundedH?0:this.h/this.zoom*(l.deltaY/n.h),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}return!1}get scrollableW(){return this.children.length==0?0:this.unboundedW?this.children[0].w-this.w/this.zoom:Math.max(this.children[0].w-this.w/this.zoom,0)}get scrollableH(){return this.children.length==0?0:this.unboundedH?this.children[0].h-this.h/this.zoom:Math.max(this.children[0].h-this.h/this.zoom,0)}_draw(e,s,i){this.draw(e,s);let n=this.rect;n[0]=Math.floor(n[0]*e.tileSize*e.pixelSize)/(e.tileSize*e.pixelSize),n[1]=Math.floor(n[1]*e.tileSize*e.pixelSize)/(e.tileSize*e.pixelSize),n[2]=Math.floor(n[2]*e.tileSize*e.pixelSize)/(e.tileSize*e.pixelSize),n[3]=Math.floor(n[3]*e.tileSize*e.pixelSize)/(e.tileSize*e.pixelSize),s.save(),s.beginPath(),s.rect(n[0],n[1],n[2],n[3]),s.clip();let r=this.getTransform();r&&s.transform(r.a,r.b,r.c,r.d,r.e,r.f),this.children[0]._draw(e,s,i),s.restore()}}class fi extends bt{constructor(e=null){super();m(this,"closeOnTouchOutside",!0);m(this,"bgColor","slate");m(this,"outlineColor","gray");m(this,"dim",!0);m(this,"dimScale",.8);e!==null&&this.updateProperties(e)}get visible(){return g.get()._modalWidgets.indexOf(this)>=0}popup(){if(this.parent==null){let e=g.get();return this.parent=e,e.addModal(this),!0}return!1}close(e=0){if(this.parent!=null){this.emit("close",e);let s=g.get();return this.parent=null,s.removeModal(this),!0}return!1}on_touch_down(e,s,i){return this.closeOnTouchOutside&&!this.collide(i.rect)?(this.close(),!0):super.on_touch_down(e,s,i)}draw(e,s){if(this.dim){let i=g.get().baseWidget.rect,n=g.get().ctx;if(!n)return;n.fillStyle="rgba(0,0,0,"+this.dimScale+")",n.rect(i[0],i[1],i[2],i[3]),n.fill(),super.draw(e,n)}}}class mi extends Array{constructor(t,e){super();for(let s=0;s<t.length;++s)e[s]?this.push(t[s],e[s][0],e[s][1]):this.push(t[s],0,0)}*iter(){for(let t=0;t<this.length/3;t++)yield[this[t*3],this[t*3+1],this[t*3+2]]}}class pi extends R{constructor(e={}){super();m(this,"spriteSheet",null);m(this,"frames",[]);m(this,"timePerFrame",30);m(this,"timeLeft",0);m(this,"activeFrame",0);m(this,"id","");m(this,"facing",0);m(this,"flipX",!1);m(this,"flipY",!1);m(this,"oneShot",!1);e&&this.updateProperties(e)}update(e,s){if(super.update(e,s),this.timeLeft-=s,this.timeLeft<=0){if(this.oneShot&&this.activeFrame===this.frames.length-1){this.timeLeft=1/0,this.emit("animationComplete",this.activeFrame);return}this.activeFrame++,this.activeFrame>=this.frames.length&&(this.activeFrame=0),this.timeLeft+=this.timePerFrame}this.frames.length>0&&this.timeLeft!==1/0&&e.requestFrameUpdate()}restart(){this.activeFrame=0,this.timeLeft=this.timePerFrame}on_frames(e,s,i){this.restart()}get frame(){return this.frames[this.activeFrame]??-1}draw(e,s){var r;if(this.spriteSheet===null||!((r=this.spriteSheet.sheet)!=null&&r.complete))return;const i=Math.floor(this.x*this.spriteSheet.spriteSize)/this.spriteSheet.spriteSize,n=Math.floor(this.y*this.spriteSheet.spriteSize)/this.spriteSheet.spriteSize;if(s.translate(i,n),s.scale(this.w,this.h),this.frame instanceof mi)for(let[o,l,a]of this.frame.iter())this.spriteSheet.drawIndexed(s,o,0,0,this.facing,this.flipX,l,a);else this.spriteSheet.drawIndexed(s,this.frame,0,0,this.facing,this.flipX);s.scale(1/this.w,1/this.h),s.translate(-i,-n)}}class ee extends R{constructor(t={}){super(),this.defaultValue=-1,this._data=new ht,this._vLayer=null,this._aLayer=null,this._cacheTileDim=new P,this.tileDim=new P,this.hints={w:null,h:null},this.spriteSheet=null,this.clipRegion=null,this.alphaValue=.5,this.useCache=!0,t&&this.updateProperties(t)}serialize(){const t={};return t._data=this._data.slice(),t.tileDim=this.tileDim.slice(),t.spriteSheet=Array(...g.resources.keys()).find(e=>g.resources[e]===this.spriteSheet)??null,t}get(t){return this._data.get(t)}set(t,e){this._data.set(t,e),this._data._cacheData=null}get data(){return this._data}deserialize(t){this.tileDim=new P(t.tileDim??[0,0]);const e=t._data;for(let s=0;s<e.length;s++)this._data[s]=e[s];this.spriteSheet=g.resources[t.spriteSheet]??null,this._data._cacheData=null}on_tileDim(t,e,s){this.resizeData(),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new P(this.tileDim)}resizeData(){let t=[];for(let s=0;s<this._cacheTileDim[1];s++)for(let i=0;i<this._cacheTileDim[0];i++)t.push(this.get([i,s]));this._data.tileDim=new P(this.tileDim),this._data.length=this.tileDim[0]*this.tileDim[1],this._data.fill(this.defaultValue);let e=0;for(let s=0;s<this._cacheTileDim[1];s++)for(let i=0;i<this._cacheTileDim[0];i++)i<this.tileDim[0]&&s<this.tileDim[1]&&this.set([i,s],t[e]),++e;this._data._cacheData=null}draw(t,e){if(super.draw(t,e),this.spriteSheet===null||!this.spriteSheet.sheet.complete||!this.spriteSheet.sheet.complete||this.spriteSheet.sheet.naturalHeight==0)return;let[s,i]=[0,0],[n,r]=this.tileDim;if(this.clipRegion&&([s,i]=this.clipRegion.pos,[n,r]=this.clipRegion.pos.add(this.clipRegion.size).add([1,1]),s=Math.min(Math.max(s,0),this.tileDim[0]),n=Math.min(Math.max(n,0),this.tileDim[0]),i=Math.min(Math.max(i,0),this.tileDim[1]),r=Math.min(Math.max(r,0),this.tileDim[1])),Math.floor(this.spriteSheet.sheet.width/this.spriteSheet.spriteSize),Math.floor(this.spriteSheet.sheet.height/this.spriteSheet.spriteSize),this.useCache){if(this._data._cacheData===null&&this.cacheCanvas(),this._data._cacheData===null)return;const o=this.spriteSheet.spriteSize;if(e.drawImage(this._data._cacheData,o*s,o*i,o*(n-s),o*(r-i),this.x+s,this.y+i,n-s,r-i),this._aLayer===null&&this._vLayer===null)for(let l=s;l<n;l++)for(let a=i;a<r;a++){let c=l+a*this.tileDim[0],d=this._data[c];d<-1&&this.spriteSheet.drawIndexed(e,d,l+this.x,a+this.y)}else if(this._aLayer&&this._vLayer){const l=this._aLayer,a=this._vLayer,c=e.globalAlpha,d=this._data;for(let f=s;f<n;f++)for(let u=i;u<r;u++){let p=f+u*this.tileDim[0],y=d[p];y<-1&&a[p]>0&&(l[p]===0?(e.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(e,y,f+this.x,u+this.y),e.globalAlpha=c):this.spriteSheet.drawIndexed(e,y,f+this.x,u+this.y))}}}else if(this._aLayer===null&&this._vLayer===null)for(let o=s;o<n;o++)for(let l=i;l<r;l++){let a=o+l*this.tileDim[0],c=this._data[a];this.spriteSheet.drawIndexed(e,c,o+this.x,l+this.y)}else if(this._aLayer&&this._vLayer){const o=this._aLayer,l=this._vLayer,a=e.globalAlpha,c=this._data;for(let d=s;d<n;d++)for(let f=i;f<r;f++){let u=d+f*this.tileDim[0],p=c[u];p!==-1&&l[u]>0&&(o[u]===0?(e.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(e,p,d+this.x,f+this.y),e.globalAlpha=a):this.spriteSheet.drawIndexed(e,p,d+this.x,f+this.y))}}}clearCache(){this.data._cacheData=null}cacheCanvas(){if(this._data._cacheData=null,!this.spriteSheet||!this.spriteSheet.sheet||this.tileDim[0]<=0||this.tileDim[1]<=0)return;const t=new OffscreenCanvas(this.tileDim[0]*this.spriteSheet.spriteSize,this.tileDim[1]*this.spriteSheet.spriteSize),e=t.getContext("2d");if(!e)return;e.scale(this.spriteSheet.spriteSize,this.spriteSheet.spriteSize);let[s,i]=[0,0],[n,r]=this.tileDim;if(this._aLayer===null&&this._vLayer===null)for(let o=s;o<n;o++)for(let l=i;l<r;l++){let a=o+l*this.tileDim[0],c=this._data[a];c>=0&&this.spriteSheet.drawIndexed(e,c,o,l)}else if(this._aLayer&&this._vLayer){const o=this._aLayer,l=this._vLayer,a=e.globalAlpha,c=this._data;for(let d=s;d<n;d++)for(let f=i;f<r;f++){let u=d+f*this.tileDim[0],p=c[u];p>=0&&l[u]>0&&(o[u]===0?(e.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(e,p,d,f),e.globalAlpha=a):this.spriteSheet.drawIndexed(e,p,d,f))}}this._data._cacheData=t}}class yi extends ee{constructor(t={}){super(),this._layerData=[this._data],this.numLayers=1,this.activeLayer=0,this.visibilityLayer=-1,this.alphaLayer=-1,t&&this.updateProperties(t)}on_alphaLayer(t,e,s){this._aLayer=this.alphaLayer>=0?this._layerData[this.alphaLayer]:null}on_visibilityLayer(t,e,s){this._vLayer=this.visibilityLayer>=0?this._layerData[this.visibilityLayer]:null}serialize(){const t={},e=[];for(let s of this._layerData)e.push(s.slice());return t._layerData=e,t.activeLayer=this.activeLayer,t.numLayers=this.numLayers,t.tileDim=this.tileDim.slice(),t.spriteSheet=Array(...g.resources.keys()).find(s=>g.resources[s]===this.spriteSheet)??null,t}deserialize(t){this.numLayers=t.numLayers,this.activeLayer=t.activeLayer,this.tileDim=new P(t.tileDim??[0,0]);const e=t._layerData.length;this._layerData.length=e;for(let s=0;s<e;s++){const i=this._layerData[s],n=t._layerData[s];for(let r=0;r<n.lenth;r++)i[r]=n[r]}this.spriteSheet=g.resources[t.spriteSheet]??null,this.clearCache()}on_tileDim(t,e,s){if("_layerData"in this){for(let i of this._layerData)this._data=i,this.resizeData();this.activeLayer>=0&&(this._data=this._layerData[this.activeLayer]),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new P(this.tileDim)}}on_numLayers(t,e,s){const i=this._layerData.length;this._layerData.length=this.numLayers;for(let n=i;n<this.numLayers;n++){const r=new ht(this.tileDim).fill(this.defaultValue);this._layerData[n]=r}this.activeLayer>=this.numLayers&&(this.activeLayer=this.numLayers-1)}on_activeLayer(t,e,s){this._data=this._layerData[this.activeLayer]}get layer(){return this._layerData}getFromLayer(t,e){return this._layerData[t][e[0]+e[1]*this.tileDim[0]]}setInLayer(t,e,s){this._layerData[t][e[0]+e[1]*this.tileDim[0]]=s,this._layerData[t]._cacheData=null}clearCache(){for(let t of this._layerData)t._cacheData=null}draw(t,e){for(let s of this._layerData)s.hidden||(this._data=s,super.draw(t,e));this._data=this._layerData[this.activeLayer]}}g.registerClass("Widget",R,"");g.registerClass("App",g,"");g.registerClass("Label",ot,"");g.registerClass("Button",ri,"");g.registerClass("ToggleButton",Qt,"");g.registerClass("BasicButton",hi,"");g.registerClass("TextInput",ai,"");g.registerClass("CheckBox",oi,"");g.registerClass("Slider",li,"");g.registerClass("ImageWidget",ci,"");g.registerClass("BoxLayout",bt,"");g.registerClass("GridLayout",di,"");g.registerClass("ScrollView",te,"");g.registerClass("ModalView",fi,"");g.registerClass("Notebook",Jt,"");g.registerClass("TabbedNotebook",ui,"");g.registerClass("SpriteWidget",pi,"");g.registerClass("TileMap",ee,"");g.registerClass("LayeredTileMap",yi,"");class gi extends g{constructor(t,e,s){if(super({}),this.glCanvas=t,this.uiCanvas=e,this.gl=t.getContext("webgl2"),!this.gl)throw new Error("WebGL2 not supported");this.currentContest=null,this.renderer=new qe(this.gl,t,s),this.controls=new Ze(t),this.setPiece=null,this.entities=[],this.aimTarget=new je([5,.001,A/2]),this.ball=new He(S(0,0,A/2)),this.entities.push(this.ball),this.players=[],this.chasers=0,this.followers=0,this.homePositions=kt(),this.awayPositions=kt(!0),Fe("mulberry32"),Ce(Ee(`DATE ${Date.now()}`));for(let o=0;o<1e3;++o)Z(20);const i=Z(18);let n=Z(18);for(;i===n;)n=Z(18);console.log("teams",i,n);const r=[[this.homePositions,"home",i],[this.awayPositions,"away",n]];for(let[o,l,a]of r)for(const[c,d]of Object.entries(o)){const f=new Be(c,l,a,d,!c.toLowerCase().startsWith("bench"));this.entities.push(f),this.players.push(f),c==="RR"&&l==="home"&&(this.player=f)}this.closestPlayers={home:null,away:null},this.cameraTarget=S(0,10,A/2),this.cameraPos=S(0,10,A/2+15),this.resize(),window.addEventListener("resize",()=>this.resize()),this.lastTime=performance.now()}start(){this.lastTime=performance.now(),requestAnimationFrame(this.loop.bind(this))}loop(t){var n,r;const e=(t-this.lastTime)/1e3,s=Math.min(e,1/30);this.lastTime=t,this.updateClosestPlayers(),this.controls.update(s),this.chasers=0,this.followers=0;const i=this.ball.pos.c;for(const o of this.entities)o.update(s,this);if(this.setPiece&&(this.setPiece.update(s),this.setPiece.finished&&(this.setPiece=null)),!this.setPiece){let o=Se(i,this.ball.pos);if(o!==null){if(o==="goalAway"&&(this.ball.lastTouchedType!=="kick"||((n=this.ball.lastTouchedBy)==null?void 0:n.team)==="home")?o="behindAway":o==="goalHome"&&(this.ball.lastTouchedType!=="kick"||((r=this.ball.lastTouchedBy)==null?void 0:r.team)==="away")?o="behindHome":o==="innerLeftPostAway"||o==="innerRightPostAway"?o="behindAway":(o==="innerLeftPostHome"||o==="innerRightPostHome")&&(o="behindHome"),o==="behindAway"){const l=this.players.find(a=>a.name==="FB"&&a.team==="home");l&&(this.setPiece=new nt(this,l,S(0,0,A-10)))}if(o==="behindHome"){const l=this.players.find(a=>a.name==="FB"&&a.team==="away");l&&(this.setPiece=new nt(this,l,S(0,0,10)))}if(o==="goalAway"||o==="goalHome"||o==="outOfBounds")for(const l of this.entities)l.setupForBoundary(o,this.ball.pos)}}this.updateCameraTarget(),this.updatePlayerControl(),this.renderer.renderScene(this,this.entities),this.controls.endUpdate(),requestAnimationFrame(this.loop.bind(this))}updateClosestPlayers(){const t=this.ball,e={home:1/0,away:1/0},s={home:null,away:null};for(let i of this.players){const n=i.pos.dist(t.pos);n<e[i.team]&&(e[i.team]=n,s[i.team]=i)}this.closestPlayers=s}updatePlayerControl(){const t=this.players.filter(n=>n.team==="home"),e=this.ball.carrier;if(!e||e&&e.team==="home")return;let s=null,i=1/0;for(const n of t){if(n.actionState==="tackle")continue;const r=ue(n.pos,e.pos),o=(Math.abs(n.positionPos[0]-this.ball.pos[0])<10?-10:0)+(n.energy<.3?-5:0)+(n.pos[2]>e.pos[2]?-10:0);r+o<i&&(s=n,i=r+o)}s&&s!==this.player&&(this.player=s,this.player.aiming=!1)}updateCameraTarget(){const t=this.ball,e=t.carrier,s=e?(e.team==="home",e.pos.c):t.pos.c;let i=e&&e.team==="home"?0:Math.max(40-s[2],15),n=-.2*s[0];s.add([n,0,i]);const r=this.cameraTarget.dist(s),o=Math.max(1/(1+3*r),.05);this.cameraTarget.lerp(s,o)}resize(){this.glCanvas.width=window.innerWidth,this.glCanvas.height=window.innerHeight,this.renderer.updateProjection()}}const _i="/footy/assets/spritesheet-CSRnYgIO.png";function bi(h){const t=document.getElementById("uicanvas");if(!t)throw console.error("UI Canvas element not found"),new Error("UI Canvas element not found");const e=document.getElementById("glcanvas");if(!e)throw console.error("WebGL2 Canvas element not found"),new Error("WebGL2 Canvas element not found");new gi(e,t,h).start()}We(_i).then(h=>{if(!h.complete)throw console.error("Failed to load sprite sheet"),new Error("Sprite sheet not loaded");bi(h)});
