var lt=e=>{throw TypeError(e)};var Ft=(e,t,s)=>t.has(e)||lt("Cannot "+s);var ft=(e,t,s)=>t.has(e)?lt("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s);var st=(e,t,s)=>(Ft(e,t,"access private method"),s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function s(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(o){if(o.ep)return;o.ep=!0;const a=s(o);fetch(o.href,a)}})();var rt=1e-6,O=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});function C(){var e=new O(16);return O!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function Pt(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function $(e,t,s){var i=s[0],o=s[1],a=s[2],r,n,h,c,u,f,d,l,p,m,g,T;return t===e?(e[12]=t[0]*i+t[4]*o+t[8]*a+t[12],e[13]=t[1]*i+t[5]*o+t[9]*a+t[13],e[14]=t[2]*i+t[6]*o+t[10]*a+t[14],e[15]=t[3]*i+t[7]*o+t[11]*a+t[15]):(r=t[0],n=t[1],h=t[2],c=t[3],u=t[4],f=t[5],d=t[6],l=t[7],p=t[8],m=t[9],g=t[10],T=t[11],e[0]=r,e[1]=n,e[2]=h,e[3]=c,e[4]=u,e[5]=f,e[6]=d,e[7]=l,e[8]=p,e[9]=m,e[10]=g,e[11]=T,e[12]=r*i+u*o+p*a+t[12],e[13]=n*i+f*o+m*a+t[13],e[14]=h*i+d*o+g*a+t[14],e[15]=c*i+l*o+T*a+t[15]),e}function it(e,t,s){var i=s[0],o=s[1],a=s[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*o,e[5]=t[5]*o,e[6]=t[6]*o,e[7]=t[7]*o,e[8]=t[8]*a,e[9]=t[9]*a,e[10]=t[10]*a,e[11]=t[11]*a,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function kt(e,t,s){var i=Math.sin(s),o=Math.cos(s),a=t[4],r=t[5],n=t[6],h=t[7],c=t[8],u=t[9],f=t[10],d=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=a*o+c*i,e[5]=r*o+u*i,e[6]=n*o+f*i,e[7]=h*o+d*i,e[8]=c*o-a*i,e[9]=u*o-r*i,e[10]=f*o-n*i,e[11]=d*o-h*i,e}function xt(e,t,s,i,o){var a=1/Math.tan(t/2),r;return e[0]=a/s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,o!=null&&o!==1/0?(r=1/(i-o),e[10]=(o+i)*r,e[14]=2*o*i*r):(e[10]=-1,e[14]=-2*i),e}var Vt=xt;function Lt(e,t,s,i){var o,a,r,n,h,c,u,f,d,l,p=t[0],m=t[1],g=t[2],T=i[0],y=i[1],P=i[2],E=s[0],v=s[1],_=s[2];return Math.abs(p-E)<rt&&Math.abs(m-v)<rt&&Math.abs(g-_)<rt?Pt(e):(u=p-E,f=m-v,d=g-_,l=1/Math.hypot(u,f,d),u*=l,f*=l,d*=l,o=y*d-P*f,a=P*u-T*d,r=T*f-y*u,l=Math.hypot(o,a,r),l?(l=1/l,o*=l,a*=l,r*=l):(o=0,a=0,r=0),n=f*r-d*a,h=d*o-u*r,c=u*a-f*o,l=Math.hypot(n,h,c),l?(l=1/l,n*=l,h*=l,c*=l):(n=0,h=0,c=0),e[0]=o,e[1]=n,e[2]=u,e[3]=0,e[4]=a,e[5]=h,e[6]=f,e[7]=0,e[8]=r,e[9]=c,e[10]=d,e[11]=0,e[12]=-(o*p+a*m+r*g),e[13]=-(n*p+h*m+c*g),e[14]=-(u*p+f*m+d*g),e[15]=1,e)}function S(){var e=new O(3);return O!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function w(e){var t=new O(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function j(e){var t=e[0],s=e[1],i=e[2];return Math.hypot(t,s,i)}function A(e,t,s){var i=new O(3);return i[0]=e,i[1]=t,i[2]=s,i}function k(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function N(e,t,s,i){return e[0]=t,e[1]=s,e[2]=i,e}function z(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e}function J(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2],e}function F(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e}function I(e,t,s,i){return e[0]=t[0]+s[0]*i,e[1]=t[1]+s[1]*i,e[2]=t[2]+s[2]*i,e}function Q(e,t){var s=t[0]-e[0],i=t[1]-e[1],o=t[2]-e[2];return Math.hypot(s,i,o)}function Bt(e,t){var s=t[0]-e[0],i=t[1]-e[1],o=t[2]-e[2];return s*s+i*i+o*o}function At(e){var t=e[0],s=e[1],i=e[2];return t*t+s*s+i*i}function R(e,t){var s=t[0],i=t[1],o=t[2],a=s*s+i*i+o*o;return a>0&&(a=1/Math.sqrt(a)),e[0]=t[0]*a,e[1]=t[1]*a,e[2]=t[2]*a,e}function W(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function ot(e,t,s,i){var o=t[0],a=t[1],r=t[2];return e[0]=o+i*(s[0]-o),e[1]=a+i*(s[1]-a),e[2]=r+i*(s[2]-r),e}var H=J,L=Q,jt=j,It=At;(function(){var e=S();return function(t,s,i,o,a,r){var n,h;for(s||(s=3),i||(i=0),o?h=Math.min(o*s+i,t.length):h=t.length,n=i;n<h;n+=s)e[0]=t[n],e[1]=t[n+1],e[2]=t[n+2],a(e,e,r),t[n]=e[0],t[n+1]=e[1],t[n+2]=e[2];return t}})();function Dt(){var e=new O(2);return O!=Float32Array&&(e[0]=0,e[1]=0),e}function dt(e,t){var s=new O(2);return s[0]=e,s[1]=t,s}function ut(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e}function Rt(e){var t=e[0],s=e[1];return Math.hypot(t,s)}var mt=Rt;(function(){var e=Dt();return function(t,s,i,o,a,r){var n,h;for(s||(s=2),i||(i=0),o?h=Math.min(o*s+i,t.length):h=t.length,n=i;n<h;n+=s)e[0]=t[n],e[1]=t[n+1],a(e,e,r),t[n]=e[0],t[n+1]=e[1];return t}})();const Ht=160,b=170,ht=Ht/2,D=b/2,G=6,nt=6,pt=.5;function M(e,t,s){return A(e,t,s)}const Ut=Object.freeze([M(-.5*G-nt,0,b),M(-.5*G,0,b),M(.5*G,0,b),M(.5*G+nt,0,b)]),Ot=Object.freeze([M(-.5*G-nt,0,0),M(-.5*G,0,0),M(.5*G,0,0),M(.5*G+nt,0,0)]),Ct=Object.freeze({Away:Ut,Home:Ot});function gt(e){const t=e[0]/ht,s=(e[2]-D)/D;return t*t+s*s>1}function Nt(e,t,s,i,o,a){const r=o-s,n=a-i;if(r===0&&n===0){const p=e-s,m=t-i;return p*p+m*m}const h=((e-s)*r+(t-i)*n)/(r*r+n*n),c=Math.max(0,Math.min(1,h)),u=s+c*r,f=i+c*n,d=e-u,l=t-f;return d*d+l*l}function zt(e,t){const s=gt(e),i=gt(t);for(const o of["Away","Home"]){const a=Ct[o];if(i&&!s){if(o==="Away"){if(e[2]>b-10){const n=t[0];if(n>=-3&&n<=3)return"goalAway";if(n>=-9&&n<-3||n>3&&n<=9)return"behindAway"}}else if(o==="Home"&&e[2]<10){const n=t[0];if(n>=-3&&n<=3)return"goalHome";if(n>=-9&&n<-3||n>3&&n<=9)return"behindHome"}}const r=["outerLeftPost","innerLeftPost","innerRightPost","outerRightPost"];for(let n=0;n<a.length;n++){const h=a[n][0],c=a[n][2];if(Nt(h,c,e[0],e[2],t[0],t[2])<pt*pt)return`${r[n]}${o}`}}return!s&&i?"outOfBounds":null}function Tt(e=!1){const s={fullForward:70,halfForward:35,halfBack:-35,fullBack:-70},i={LFP:-45,FF:0,RFP:45,LHF:-50,CHF:0,RHF:50,LHB:-50,CHB:0,RHB:50,LBP:-45,FB:0,RBP:45};function o(h,c){const u=h*Math.PI/180,f=ht*Math.sin(u)*(Math.abs(c)/D)-(e?2:-2),d=D+c*(e?-1:1);return M(f,0,d)}const a=-ht-4,r=h=>D+(e?1:-1)*h;return{LFP:o(i.LFP,s.fullForward-(e?10:-10)),FF:o(i.FF,s.fullForward),RFP:o(i.RFP,s.fullForward-(e?10:-10)),LHF:o(i.LHF,s.halfForward),CHF:o(i.CHF,s.halfForward),RHF:o(i.RHF,s.halfForward),LW:M(-25,0,D-(e?2:-2)),C:M(8,0,D-(e?-5:5)),RW:M(25,0,D-(e?2:-2)),LHB:o(i.LHB,s.halfBack),CHB:o(i.CHB,s.halfBack),RHB:o(i.RHB,s.halfBack),LBP:o(i.LBP,s.fullBack-(e?10:-10)),FB:o(i.FB,s.fullBack),RBP:o(i.RBP,s.fullBack-(e?10:-10)),Ruck:M(0,0,D-(e?10:-10)),RR:M(-10,0,D-(e?10:-10)),Rover:M(10,0,D-(e?10:-10)),Bench1:M(a,0,r(10)),Bench2:M(a,0,r(13)),Bench3:M(a,0,r(16)),Bench4:M(a,0,r(19)),Bench5:M(a,0,r(22))}}function Gt(e,t,s){let i=null,o=1/0;for(const a of t)if(a.team!==e.team){const r=Q(a.pos,s);r<o&&(o=r,i=a)}return i}class Xt{constructor(t,s,i){this.game=t,this.kicker=s,this.markPos=w(i),this.timer=0,this.finished=!1}update(t){this.timer+=t}enforce(t,s){return!1}cleanup(){}}class at extends Xt{constructor(t,s,i){super(t,s,i),this.defender=null,this.zone={center:S(),radius:1},this.game=t,this.setup()}setup(){const{game:t,kicker:s,markPos:i}=this,o=s.team==="home"?0:b,a=A(0,0,o),r=H(S(),i,a);r[1]=0,R(r,r);const n=w(i),h=w(i);k(s.pos,h),F(s.jogVel,r,s.jogSpeed),k(s.joltVel,[0,0,0]),t.ball.carrier!==s&&t.ball.pickup(s),s.team==="home"&&(this.game.player=s),s.stateTimer=10/s.jogSpeed,this.defender=Gt(s,t.players,i),this.defender&&(k(this.defender.pos,n),k(this.defender.vel,[0,0,0]),k(this.defender.jogVel,[0,0,0]),k(this.defender.joltVel,[0,0,0]),this.defender.actionState="standingMark",this.defender.stateTimer=10)}update(t){super.update(t);const{kicker:s,markPos:i,game:o}=this,a=!o.ball.carried,r=H(S(),s.pos,i);r[1]=0;const n=s.team==="home"?0:b,h=H(S(),[0,0,n],i);h[1]=0,R(h,h);const c=W(r,h),u=A(-h[2],0,h[0]),f=Math.abs(W(r,u)),d=c>.05||f>2;(a||d)&&(this.finished=!0)}enforce(t,s){const{kicker:i,defender:o,markPos:a}=this,r=i.pos,n=ot(S(),a,r,.5),h=Q(a,r)/2+5,c=Q(t.pos,n);if(t===o)return k(t.pos,o.pos),N(t.vel,0,0,0),N(t.jogVel,0,0,0),N(t.joltVel,0,0,0),!1;if(c<h&&t!==i&&t!==o){const u=Q(t.pos,n),f=h-u;if(f>0){const d=H(S(),t.pos,n);d[1]=0;const l=j(d);if(l<.001?(N(d,Math.random()-.5,0,Math.random()-.5),R(d,d)):F(d,d,1/l),f<2){const p=f*10;return I(t.joltVel,t.joltVel,d,p*s),I(t.pos,t.pos,t.joltVel,s),!0}else{const p=f*20;return I(t.joltVel,t.joltVel,d,p*s),I(t.pos,t.pos,t.joltVel,s),!0}}}return!1}}function Yt(e,t){const s=e.pos[0]-t.pos[0],i=e.pos[1]-t.pos[1],o=e.pos[2]-t.pos[2],a=s*s+i*i+o*o,[r,n]=e.collideBounds(),[h,c]=t.collideBounds(),u=.5*mt(e.collideBounds()),f=.5*mt(t.collideBounds()),d=u+f;return a<=d*d}class ct{constructor(t){this.pos=t,this.vel=[0,0,0],this.width=1.6,this.height=2.4,this.usesGravity=!0,this.gravity=[0,-9.8,0],this.bounces=!1,this.restitution=.4,this.floorY=0}setupForBoundary(t,s){}update(t,s){this.usesGravity&&I(this.vel,this.vel,this.gravity,t),I(this.pos,this.pos,this.vel,t),this.pos[1]<this.floorY&&(this.pos[1]=this.floorY,this.bounces&&Math.abs(this.vel[1])>.5?this.vel[1]=-this.vel[1]*this.restitution:this.vel[1]=0)}render(t){t.renderSprite(this.pos,this.width,this.height,1,0)}collidesWith(t){return Yt(this,t)}collideBounds(){return[.5,1.8]}}const vt={home:Object.freeze({idle:[[0,0,0]],run:[[1,0,0],[2,0,0],[3,0,0],[4,0,0],[5,0,0],[6,0,0]],kickRightFoot:[[1,0,0],[2,0,0]],kickLeftFoot:[[4,0,0],[5,0,0]],handpassRightHand:[[1,0,0],[0,0,0]],handpassLeftHand:[[4,0,0],[0,0,0]],jumpMark:[[1,0,0],[2,0,0],[0,0,0]],jumpSpoil:[[1,0,0],[2,0,0],[0,0,0]]}),away:Object.freeze({idle:[[0,4,0]],run:[[1,4,0],[2,4,0],[3,4,0],[4,4,0],[5,4,0],[6,4,0]],kickRightFoot:[[1,4,0],[2,4,0]],kickLeftFoot:[[4,4,0],[5,4,0]],handpassRightHand:[[1,4,0],[0,4,0]],handpassLeftHand:[[4,4,0],[0,4,0]],jumpMark:[[1,4,0],[2,4,0],[0,4,0]],jumpSpoil:[[1,4,0],[2,4,0],[0,4,0]]})};class qt extends ct{constructor(t,s,i,o=!1){super(i),this.positionPos=w(i),this.name=t,this.team=s,this.playing=o,this.width=1.6,this.height=2.4,this.aiming=!1,this.jogVel=A(0,0,0),this.joltVel=A(0,0,0),this.jogSpeed=5,this.joltSpeed=2,this.energy=10,this.energyRecovery=0,this.statsWeight=85+Math.random()*10,this.statsStrength=50+Math.random()*30,this.statsSpeed=10+Math.random()*5,this.statsJump=10,this.statsKickRange=45,this.statsHandpassRange=20,this.statsAgility=10,this.joltDecayRate=8,this.animations=vt[s]??vt.home,this.animState="idle",this.actionState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=8,this.stateTimer=0,this.animSprite=A(0,0,0)}updateAI(t,s){const o=s.ball;let a=null;if(o.carried&&o.carrier===this)if(this.stateTimer+=t,this.stateTimer<1)a="run";else{let n=!1;for(const l of s.players)if(!(l===this||l.team===this.team)&&L(l.pos,this.pos)<7){n=!0;break}const h=s.players.filter(l=>l.team===this.team&&l!==this);if(n){let l=null,p=-1/0;const m=A(0,0,this.team==="home"?-1:1);for(const g of h){if(g===this)continue;const T=L(this.pos,g.pos);if(T>40)continue;let y=!1;for(const x of s.players)if(x.team!==this.team&&L(x.pos,g.pos)<5){y=!0;break}if(y)continue;const P=S();J(P,g.pos,this.pos),R(P,P);const E=W(m,P),v=w(g.vel);v[1]=0;const _=W(m,v),V=Math.abs(T-15)*.2,B=15*E+2*_-V;B>p&&(p=B,l=g)}if(l){const g=H(S(),l.pos,this.pos),T=[g[0],g[2]];return this.tryDisposeBall(s,{kickReleased:!0,kickHeldTime:j(g)>20?.5:.1,aimTarget:T})??"run"}}const u=this.team==="home"?-5:b+5,f=0;if(Math.abs(this.pos[2]-u)<=this.statsKickRange){const l=A(f,0,u),p=(Math.random()-.5)*9;l[0]+=p;const m=H(S(),l,this.pos),g=[m[0],m[2]];return this.tryDisposeBall(s,{kickReleased:!0,kickHeldTime:.4,aimTarget:g})??"run"}if(n||this.stateTimer>5){let l=null,p=-1/0;for(const m of h){const g=L(this.pos,m.pos);if(g>this.statsKickRange)continue;const T=this.team==="home"?-1:1,y=(m.pos[2]-this.pos[2])*T,P=Math.abs(m.pos[0]-this.pos[0]),E=y-P-g;E>p&&(p=E,l=m)}if(l){const m=H(S(),l.pos,this.pos),g=[m[0],m[2]];return this.tryDisposeBall(s,{kickReleased:!0,kickHeldTime:.4,aimTarget:g})??"run"}}a="run"}let r=null;if(o.carried&&o.carrier===this){const n=this.team==="home"?-1:1,h=A(0,0,n);let c=S();for(const f of s.players){if(f===this||f.team===this.team)continue;const d=S();J(d,this.pos,f.pos),d[1]=0;const l=j(d);if(l<5&&l>.5){const p=1/l;R(d,d),I(c,c,d,p)}}const u=S();z(u,h,c),R(u,u),r=w(this.pos),I(r,r,u,10)}else if(o.carried)if(o.carrier&&o.carrier.team!==this.team&&s.chasers<3&&s.closestPlayers[this.team]===this||L(o.pos,this.pos)<=15&&this.energy>0)r=w(o.pos),s.chasers++;else if(o.carrier&&o.carrier.team===this.team&&o.pos[2]>20&&o.pos[2]<b-20&&L(o.pos,this.pos)<10&&this.energy>.3&&s.followers<3){s.followers++;const n=w(o.carrier.jogVel);j(n)<.01&&(n[2]=this.team==="home"?-1:1),R(n,n);const h=A(-n[2],0,n[0]);R(h,h);let c=0,u=12;switch(this.name){case"wing":c=12*(this.team==="home"?-1:1),u=15;break;case"forward":c=6,u=18;break;case"half-forward":case"half-back":c=4,u=10;break;case"center":case"mid":c=0,u=10;break;case"back":default:c=-6,u=8;break}const f=w(o.carrier.pos);I(f,f,n,u),I(f,f,h,c),r=f}else r=this.positionPos??this.pos;else if(o.pos[1]>.1||o.vel[1]>.1){const n=o.gravity[1]??-9.8,h=o.vel[1],c=o.pos[1],u=.5*n,f=h,d=c;let l=0;const p=f*f-4*u*d;if(p>=0&&Math.abs(u)>1e-5){const g=Math.sqrt(p),T=(-f+g)/(2*u),y=(-f-g)/(2*u);l=Math.max(T,y)}const m=S();I(m,o.pos,o.vel,l),m[1]=0,L(m,this.pos)<=35?r=m:r=this.positionPos??this.pos}else L(o.pos,this.pos)<=25?r=o.pos:r=this.positionPos??this.pos;if(r===this.positionPos&&L(this.positionPos,this.pos)<=1&&(a="idle",this.actionState!=="idle"&&(this.stateTimer=0),k(this.jogVel,[0,0,0]),k(this.joltVel,[0,0,0])),r&&a===null){const n=S();if(J(n,r,this.pos),n[1]=0,At(n)>1e-4){R(n,n),F(this.joltVel,n,this.joltSpeed);const c=S();j(this.jogVel)>1e-4?(R(c,this.jogVel),ot(c,c,n,.15),R(c,c),F(this.jogVel,c,this.jogSpeed)):F(this.jogVel,n,this.jogSpeed)}}if(this.energy>0?(z(this.vel,this.jogVel,this.joltVel),this.energy-=t):(I(this.vel,this.jogVel,this.joltVel,.5),this.energyRecovery+=t,this.energyRecovery>=10&&(this.energy=10,this.energyRecovery=0)),F(this.joltVel,this.joltVel,Math.exp(-this.joltDecayRate*t)),this.checkPlayerCollisions(t,s),super.update(t,s),a===null)for(const n of s.players){if(n===this||!o.carried||o.carrier!==n||n.team===this.team||!this.collidesWith(n)||n.actionState==="tackleDisposal"||n.actionState==="freeKick")continue;const h=H(S(),n.pos,this.pos);h[1]=0,R(h,h);const c=w(this.jogVel);if(c[1]=0,j(c)<1e-4||W(R(c,c),h)>.1){this.stateTimer=1,a="tackle",n.actionState="tackleDisposal",n.stateTimer=.5,console.log("Tackle from",this,"on",n,W(c,h));break}}if(!o.carried&&o.collidesWith(this)&&a===null){const n=o.lastTouchedType==="kick"&&!o.hasBounced&&o.lastTouchedBy!==this&&L(o.pos,o.origin)>=10;return o.pickup(this),n?(s.setPiece=new at(s,this,w(this.pos)),a="freeKick"):a="pickup",this.team==="home"&&(s.player=this,this.aiming=!1),a}return a||(a=j(this.vel)>1e-4?"run":"idle"),a}collideBounds(){return[.5,1.8]}get stunned(){return this.actionState==="tackle"||this.actionState==="tackled"}updateHuman(t,s){const i=s.controls,o=s.ball;let{kickPressed:a,kickReleased:r,kickHeldTime:n,moveX:h,moveZ:c,aimTarget:u}=i.state;const f=1e-4;let d=null;if((h!==0||c!==0)&&!this.aiming){const l=A(h,0,c);R(l,l);const p=A(h,0,c);if(It(p)>f){R(p,p),F(this.joltVel,p,this.joltSpeed);const m=S();j(this.jogVel)>f?(R(m,this.jogVel),ot(m,m,l,.15),R(m,m),F(this.jogVel,m,this.jogSpeed)):F(this.jogVel,l,this.jogSpeed)}}if(this.energy>0?(z(this.vel,this.jogVel,this.joltVel),this.energy-=t):(z(this.vel,this.jogVel,F(this.joltVel,this.joltVel,.5)),this.energyRecovery+=t,this.energyRecovery>=10&&(this.energy=10,this.energyRecovery=0)),F(this.joltVel,this.joltVel,Math.exp(-this.joltDecayRate*t)),this.checkPlayerCollisions(t,s),super.update(t,s),!o.carried&&o.collidesWith(this)){const l=o.lastTouchedType==="kick"&&!o.hasBounced&&o.lastTouchedBy!==this&&L(o.pos,o.origin)>=10;return o.pickup(this),l?(s.setPiece=new at(s,this,w(this.pos)),d="freeKick"):d="pickup",this.team==="home"&&(s.player=this,this.aiming=!1),d}if(o.carried&&o.carrier===this){if(a){this.aiming=!0;const l=A(0,0,this.team==="home"?0:b);if(jt(this.jogVel)<1e-4){const p=S();H(p,l,this.pos),R(p,p),F(this.jogVel,p,this.jogSpeed)}}d=this.tryDisposeBall(s,{kickReleased:i.state.kickReleased,kickHeldTime:i.state.kickHeldTime,aimTarget:i.state.aimTarget,moveVec:h!==0||c!==0?A(h,0,c):w(this.jogVel)}),o.carried||(this.aiming=!1)}return this.updateAim(s),!d&&this.actionState!=="run"&&this.actionState!=="idle"&&(d=j(this.vel)>f?"run":"idle"),d}tryDisposeBall(t,s){const i=t.ball;if(!i.carried||i.carrier!==this)return null;const{kickReleased:o,kickHeldTime:a}=s;let{aimTarget:r}=s;if(!o)return null;const n=a<.25;if(n){const y=s.moveVec??w(this.jogVel);if(j(y)===0){const v=this.team==="home"?-1:1;N(y,0,0,v)}R(y,y);let P=null,E=-1/0;for(const v of t.players){if(v.team!==this.team||v===this||v.stunned)continue;const _=H(S(),v.pos,this.pos),V=j(_);if(V>30)continue;const B=R(S(),_),x=W(y,B);if(x<=0)continue;let Z=0;for(const U of t.players){if(U.team===this.team||U===v||U.stunned)continue;Q(U.pos,v.pos)<=10&&Z++}const K=.5*Z,Y=x*2-V/30-K;Y>E&&(E=Y,P=v)}if(P){const v=H(S(),P.pos,this.pos);r=[v[0],v[2]]}else r=[y[0]*10,y[2]*10]}if(!r)return null;const h=dt(0,0);ut(h,h,r);const c=Rt(h);if(c<.1)return null;const u=-this.gravity[1],f=(n?20:30)*Math.PI/180,d=Math.sin(2*f),l=Math.sqrt(c*u/d),p=A(h[0],0,h[1]);R(p,p);const m=A(p[0]*Math.cos(f),Math.sin(f),p[2]*Math.cos(f));return i.launch(m,l),i.lastTouchedType=n?"handpass":"kick",i.hasBounced=!1,this.stateTimer=.5,n?"handpass":"kick"}update(t,s){let i=!1;if(s.setPiece&&(i=s.setPiece.enforce(this,t)),s.ball.carried||(this.aiming=!1),!this.playing)return;if(this.actionState==="pickup"&&(this.actionState="run"),this.actionState==="freeKick"){this.stateTimer-=t,this.stateTimer<=0?(this.actionState="idle",this.stateTimer=0,this.jogVel[0]=0,this.jogVel[2]=0,s.setPiece):(s.setPiece===null||s.controls.state.moveX!==0||s.controls.state.moveZ!==0)&&(this.actionState="idle",this.stateTimer=0),k(this.vel,this.jogVel),super.update(t,s),this.updateAim(s),this.updateAnimation(t,null,s.ball);return}if(this.actionState==="standingMark"){this.stateTimer-=t,this.stateTimer<=0?(this.actionState="idle",this.stateTimer=0,this.jogVel[0]=0,this.jogVel[1]=0,s.setPiece):s.setPiece===null&&(this.actionState="idle",this.stateTimer=0),this.updateAim(s),this.updateAnimation(t,null,s.ball);return}if(this.actionState==="tackleDisposal"){if(k(this.vel,[0,0,0]),this.stateTimer-=t,s.player===this&&s.controls.state.kickReleased&&(this.tryDisposeBall(s,s.controls.state),this.actionState="handpass",this.stateTimer=.5),s.player!==this){const a=.5-this.stateTimer,r=.5+(this.statsStrength-50)*.01,n=a/r*(.5+(this.statsStrength-50)/100);Math.random()<n*t*2&&this.tryDisposeBall(s,{kickReleased:!0,kickHeldTime:.1,aimTarget:null,moveVec:S()})}if(this.stateTimer<=0){const a=s.ball;a.carried=!1,a.carrier=null,k(a.pos,this.pos),N(a.vel,0,0,0),a.lastTouchedType="spill",a.hasBounced=!1,this.actionState="tackled",this.stateTimer=1}this.updateAim(s),this.updateAnimation(t,null,s.ball);return}if(this.actionState==="tackled"||this.actionState==="tackle"||this.actionState==="kick"||this.actionState==="handpass"){this.vel=A(0,0,0),this.stateTimer-=t,this.stateTimer<=0&&(this.actionState="idle",this.stateTimer=0),this.aiming&&(this.aiming=!1),this.updateAim(s),this.updateAnimation(t,null,s.ball);return}let o=null;i||(s.player===this?o=this.updateHuman(t,s):o=this.updateAI(t,s)),this.updateAnimation(t,o,s.ball),o!==null&&(this.actionState=o)}updateAim(t){if(this===t.player){const i=t.controls.state.aimTarget;if(this.aiming){const o=dt(0,0);i&&ut(o,o,i),t.aimTarget.setPosition([this.pos[0]+o[0],.002,this.pos[2]+o[1]])}else t.player===this&&t.aimTarget.setPosition(A(this.pos[0],.002,this.pos[2]+.8))}}updateAnimation(t,s,i){const o=this.animations[this.animState];if(o.length===0)return;this.animTimer+=t;const a=1/this.animFPS;this.animTimer>=a&&(this.animTimer-=a,this.animFrame=this.animFrame+1),s==="kick"&&(this.animState="kickRightFoot",this.animFrame=0,this.animTimer=0),this.animState==="run"&&L(this.vel,[0,0,0])===0&&(this.animState="idle",this.animFrame=0,this.animTimer=0),this.animState==="idle"&&L(this.vel,[0,0,0])!==0&&(this.animState="run",this.animFrame=0,this.animTimer=0);const r=this.animState==="run"||this.animState==="idle";this.animFrame>=o.length&&(this.animFrame=r?0:o.length-1,r||(this.animState="run",this.animFrame=0,this.animTimer=0));const n=this.animations[this.animState];this.animSprite=w(n[this.animFrame])??A(0,0,0),(this.vel[2]>0?"away":this.vel[2]<0?"home":this.pos[2]<i.pos[2]?"away":"home")==="away"&&(this.animSprite[0]+=7)}render(t){const[s,i,o]=this.animSprite;t.renderSprite(this.pos,this.width,this.height,s,i)}checkPlayerCollisions(t,s){if(this.actionState!=="freeKick"){for(const i of s.players)if(!(i===this||!i.playing||i.actionState==="freeKick")&&this.collidesWith(i)){const o=S();J(o,this.pos,i.pos),o[1]=0;const a=j(o);a<1e-4?(o[0]=Math.random()-.5,o[2]=Math.random()-.5,R(o,o)):F(o,o,1/a);const r=(this.width+i.width)/2-a;if(r<=0)continue;const n=this.statsWeight,h=i.statsWeight,c=n+h,u=S();F(u,o,r);const f=S(),d=S();F(f,u,h/c),F(d,u,n/c),this.pos[0]+=f[0],this.pos[2]+=f[2],i.pos[0]-=d[0],i.pos[2]-=d[2]}}}setupForBoundary(t,s){t==="behindAway"&&this.team==="home"&&this.name==="FB"?(k(this.pos,[0,0,b-5]),k(this.jogVel,[0,0,0]),k(this.joltVel,[0,0,0]),this.actionState="idle",this.stateTimer=0):t==="behindAway"&&this.team==="away"&&this.name==="FF"?k(this.pos,[0,0,b-25]):t==="behindHome"&&this.team==="away"&&this.name==="FB"?(k(this.pos,[0,0,5]),k(this.jogVel,[0,0,0]),k(this.joltVel,[0,0,0]),this.actionState="idle",this.stateTimer=0):t==="behindHome"&&this.team==="home"&&this.name==="FF"?k(this.pos,[0,0,25]):k(this.pos,this.positionPos)}}class Wt extends ct{constructor(t){super(t),this.carried=!1,this.origin=S(),this.carrier=null,this.width=1.6,this.height=2.4,this.bounces=!0,this.animations=Object.freeze({idle:[[0,1,0]],backSpin:[[1,1,0],[2,1,0],[3,1,0],[4,1,0],[5,1,0],[6,1,0],[7,1,0],[8,1,0]],forwardSpin:[[8,1,0],[7,1,0],[6,1,0],[5,1,0],[4,1,0],[3,1,0],[2,1,0],[1,1,0]],backSpinRight:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]],backSpinLeft:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinRight:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinLeft:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]]}),this.animState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=12,this.lastTouchedBy=null,this.lastTouchedType=null,this.hasBounced=!1}update(t,s){if(this.carried&&this.carrier){const i=this.carrier,o=i.vel[2]>0?1:i.vel[2]<0||i.team==="home"?-1:1,a=A(0,.5,.2*o),r=w(this.carrier.pos);z(this.pos,r,a),k(this.origin,this.pos)}else{const i=this.vel[1]<0;super.update(t,s),this.hasBounced=this.hasBounced||i&&this.vel[1]>0&&this.pos[1]<=this.floorY,this.pos[1]<=this.floorY&&(F(this.vel,this.vel,.97),k(this.origin,this.pos))}this.updateAnimation(t)}collideBounds(){return[.4,.5]}pickup(t){this.carried=!0,this.carrier=t,this.lastTouchedBy=t,this.lastTouchedType=null,this.hasBounced=!1,this.origin=w(this.pos);const s=t.vel[2]>0?1:t.vel[2]<0||t.team==="home"?-1:1;N(this.pos,t.pos[0],t.pos[1],t.pos[2]+s*.2),N(this.vel,0,0,0)}launch(t,s,i="kick"){this.carried=!1,this.carrier=null,F(this.vel,t,s),this.lastTouchedType=i,this.hasBounced=!1}updateAnimation(t){this.animTimer+=t;const s=1/this.animFPS;this.animTimer>=s&&(this.animTimer-=s,this.animFrame=this.animFrame+1);const i=this.animState;this.carried?this.animState="idle":this.lastTouchedType==="kick"&&!this.hasBounced?this.animState=this.vel[2]<0?"backSpin":"forwardSpin":this.lastTouchedType==="handpass"&&!this.hasBounced?this.animState=this.vel[2]<0?"backSpinRight":"forwardSpinLeft":this.hasBounced?Math.abs(this.vel[1])<.05&&this.pos[1]<=this.floorY+.01?this.animState="idle":this.animState=this.vel[2]<0?"forwardSpin":"backSpin":this.animState="idle",this.animState!==i&&(this.animFrame=0,this.animTimer=0);const o=this.animations[this.animState];o.length!==0&&this.animFrame>=o.length&&(this.animFrame=0)}render(t){var r;const s=(r=this.animations)==null?void 0:r[this.animState],[i,o,a]=(s==null?void 0:s[this.animFrame])??[0,1,void 0];t.renderSprite(this.pos,this.width,this.height,i,o);{const n=t.gl;n.useProgram(t.program),n.bindVertexArray(t.quadVao);const[h,c]=[2,3],u=h/t.sheetCols,f=c/t.sheetRows,d=(h+1)/t.sheetCols,l=(c+1)/t.sheetRows;n.uniform4f(t.uTileUV,u,f,d,l);const p=C();$(p,p,[this.pos[0],.001,this.pos[2]]),kt(p,p,-Math.PI/2),it(p,p,[2,2,1]),n.uniformMatrix4fv(t.uModel,!1,p),n.drawElements(n.TRIANGLES,6,n.UNSIGNED_SHORT,0)}}setupForBoundary(t,s){if(this.carried=!1,this.carrier=null,t==="goalAway"||t==="goalHome")k(this.pos,[0,0,b/2]),k(this.vel,[0,15,0]),this.lastTouchedType="tap",this.lastTouchedBy=null,this.origin=w(this.pos);else if(t==="behindAway")k(this.pos,[0,0,b-6]);else if(t==="behindHome")k(this.pos,[0,0,6]);else{this.pos[1]=0,k(this.pos,s);const i=S();I(i,[0,b/2,b/2],s,-1),R(i,i),this.launch(i,15,"tap")}}}class Zt{constructor(t=[0,.001,0]){this.pos=w(t),this.size=2,this.spriteCoord=[0,3]}setPosition(t){this.pos[0]=t[0],this.pos[2]=t[2]}render(t){const s=t.gl;s.useProgram(t.program),s.bindVertexArray(t.quadVao);const[i,o]=this.spriteCoord,a=i/t.sheetCols,r=o/t.sheetRows,n=(i+1)/t.sheetCols,h=(o+1)/t.sheetRows;s.uniform4f(t.uTileUV,a,r,n,h);const c=C();$(c,c,[this.pos[0],.002,this.pos[2]]),kt(c,c,-Math.PI/2),it(c,c,[this.size,this.size,1]),s.uniformMatrix4fv(t.uModel,!1,c),s.drawElements(s.TRIANGLES,6,s.UNSIGNED_SHORT,0)}}function yt(e,t,s){const i=(n,h)=>{const c=e.createShader(h);if(!c)throw new Error("Failed to create shader");if(e.shaderSource(c,n),e.compileShader(c),!e.getShaderParameter(c,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(c));return c},o=i(t,e.VERTEX_SHADER),a=i(s,e.FRAGMENT_SHADER),r=e.createProgram();if(e.attachShader(r,o),e.attachShader(r,a),e.linkProgram(r),!e.getProgramParameter(r,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(r));return r}async function Kt(e){const t=new Image;return t.src=e,await t.decode(),t}function $t(e,t,s,i=1){const r=e*2/1.6/i,n=t*2/2/i,h=[0,0,0,.5,.5],c=[];for(let u=0;u<=s;u++){const f=u/s*2*Math.PI,d=Math.cos(f)*e,l=Math.sin(f)*t,p=d/(e*2)*r+.5,m=l/(t*2)*n+.5;h.push(d,0,l,p,m),u>0&&c.push(0,u,u+1)}return{vertices:new Float32Array(h),indices:new Uint16Array(c)}}function Qt(e=160,t=170,s=50,i=50,o=.4){const a=[],r=[];let n=0;const h=(m,g,T,y,P)=>{const E=T-m,v=y-g,_=Math.hypot(E,v),V=-v/_,B=E/_,x=P/2,Z=m+V*x,K=g+B*x,Y=m-V*x,U=g-B*x,et=T+V*x,q=y+B*x,Mt=T-V*x,_t=y-B*x;a.push(Z,0,K,et,0,q,Mt,0,_t,Y,0,U),r.push(n,n+1,n+2,n,n+2,n+3),n+=4},c=e/2,u=t/2,f=64;for(let m=0;m<f;m++){const g=m/f*2*Math.PI,T=(m+1)/f*2*Math.PI,y=Math.cos(g)*c,P=Math.sin(g)*u,E=Math.cos(T)*c,v=Math.sin(T)*u;h(y,P,E,v,o)}const d=[[-i/2,-i/2],[i/2,-i/2],[i/2,i/2],[-i/2,i/2]];for(let m=0;m<4;m++){const[g,T]=d[m],[y,P]=d[(m+1)%4];h(g,T,y,P,o)}function l(m){const g=m>0?-1:1,T=[];for(let y=0;y<=1e3;y++){const P=-Math.PI+y/1e3*2*Math.PI,E=Math.sin(P)*s,v=m+g*Math.cos(P)*s,_=E/c,V=v/u;_*_+V*V<=1&&T.push(P)}return T.length===0?[-Math.PI/3,Math.PI/3]:[T[0],T[T.length-1]]}const p=40;for(let m of[-t/2,t/2]){const g=m>0?-1:1,[T,y]=l(m);for(let P=0;P<p;P++){const E=T+P/p*(y-T),v=T+(P+1)/p*(y-T),_=Math.sin(E)*s,V=m+g*Math.cos(E)*s,B=Math.sin(v)*s,x=m+g*Math.cos(v)*s;h(_,V,B,x,o)}}return{vertices:new Float32Array(a),indices:new Uint16Array(r)}}const tt=170,Jt=80,St=tt/2;class te{constructor(t,s,i){this.gl=t,this.canvas=s,this.spriteSheet=i,this.sheetCols=32,this.sheetRows=32,this.setupMainProgram(),this.setupLineProgram(),this.setupSpriteGeometry(),this.setupField(),this.setupGoalposts(),this.setupCamera(),this.setupSpritesheet(),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL)}setupSpritesheet(){const t=this.gl;t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.spriteSheet),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.texture)}setupMainProgram(){const t=`#version 300 es
      in vec3 a_position;
      in vec2 a_texcoord;
      uniform mat4 u_projection, u_view, u_model;
      out vec2 v_texcoord;
      void main() {
        gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
        v_texcoord = a_texcoord;
      }`,s=`#version 300 es
precision mediump float;

uniform sampler2D u_texture;
uniform vec4 u_tileUV;

in vec2 v_texcoord;
out vec4 outColor;

void main() {
  vec2 tileUV = mod(v_texcoord, 1.0);
  vec2 texCoord = mix(u_tileUV.xy, u_tileUV.zw, tileUV);
  vec4 texColor = texture(u_texture, texCoord);

  if (texColor.a < 0.01) discard; // Skip fully transparent fragments

  outColor = texColor;
}
`;this.program=yt(this.gl,t,s),this.uProjection=this.gl.getUniformLocation(this.program,"u_projection"),this.uView=this.gl.getUniformLocation(this.program,"u_view"),this.uModel=this.gl.getUniformLocation(this.program,"u_model"),this.uTileUV=this.gl.getUniformLocation(this.program,"u_tileUV"),this.uTexture=this.gl.getUniformLocation(this.program,"u_texture"),this.aPos=this.gl.getAttribLocation(this.program,"a_position"),this.aUV=this.gl.getAttribLocation(this.program,"a_texcoord")}setupLineProgram(){const t=`#version 300 es
    in vec3 a_position;
    uniform mat4 u_projection;
    uniform mat4 u_view;
    uniform mat4 u_model;
    void main() {
    gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
    }`,s=`#version 300 es
    precision mediump float;
    out vec4 outColor;
    void main() {
    outColor = vec4(1, 1, 1, 1);
    }`;this.lineProgram=yt(this.gl,t,s),this.lineProj=this.gl.getUniformLocation(this.lineProgram,"u_projection"),this.lineView=this.gl.getUniformLocation(this.lineProgram,"u_view"),this.lineModel=this.gl.getUniformLocation(this.lineProgram,"u_model"),this.linePos=this.gl.getAttribLocation(this.lineProgram,"a_position")}setupSpriteGeometry(){const t=this.gl;t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.depthMask(!0);const s=new Float32Array([-.5,0,0,1,.5,0,1,1,.5,1,1,0,-.5,1,0,0]),i=new Uint16Array([0,1,2,0,2,3]);this.quadVao=this.gl.createVertexArray(),this.gl.bindVertexArray(this.quadVao);const o=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o),this.gl.bufferData(this.gl.ARRAY_BUFFER,s,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.aPos,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(this.aPos),this.gl.vertexAttribPointer(this.aUV,2,this.gl.FLOAT,!1,16,8),this.gl.enableVertexAttribArray(this.aUV);const a=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,a),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,i,this.gl.STATIC_DRAW)}setupField(){const t=this.gl,{vertices:s,indices:i}=$t(Jt,St,64,16);this.fieldVao=this.gl.createVertexArray(),this.gl.bindVertexArray(this.fieldVao);const o=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o),this.gl.bufferData(this.gl.ARRAY_BUFFER,s,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.aPos,3,this.gl.FLOAT,!1,20,0),this.gl.enableVertexAttribArray(this.aPos),this.gl.vertexAttribPointer(this.aUV,2,this.gl.FLOAT,!1,20,12),this.gl.enableVertexAttribArray(this.aUV);const a=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,a),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,i,this.gl.STATIC_DRAW),this.fieldIndices=i.length,this.fieldLineMesh=Qt(),this.lineVao=t.createVertexArray(),t.bindVertexArray(this.lineVao);const r=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,this.fieldLineMesh.vertices,t.STATIC_DRAW);const n=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.fieldLineMesh.indices,t.STATIC_DRAW),t.vertexAttribPointer(this.linePos,3,t.FLOAT,!1,12,0),t.enableVertexAttribArray(this.linePos)}setupGoalposts(){this.goalPostPositions=[[-9,0,tt],[-3,0,tt],[3,0,tt],[9,0,tt],[-9,0,0],[-3,0,0],[3,0,0],[9,0,0]]}setupCamera(){this.projection=C(),Vt(this.projection,Math.PI/4,this.canvas.width/this.canvas.height,.1,1e3),this.view=C(),this.model=C()}renderSprite(t,s,i,o,a){const{gl:r,program:n,quadVao:h,uModel:c,uTileUV:u,sheetCols:f,sheetRows:d}=this;r.useProgram(n),r.bindVertexArray(h);const l=C();$(l,l,t),it(l,l,[s,i,1]),r.uniformMatrix4fv(c,!1,l);const p=o/f,m=a/d,g=(o+1)/f,T=(a+1)/d;r.uniform4f(u,p,m,g,T),r.drawElements(r.TRIANGLES,6,r.UNSIGNED_SHORT,0)}renderScene(t,s){const i=this.gl;i.viewport(0,0,this.canvas.width,this.canvas.height),i.clearColor(.2,.6,.2,1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);const o=A(0,10,15),a=S();z(a,t.cameraTarget,o);const r=A(0,0,-20),n=S();z(n,t.cameraTarget,r),Lt(this.view,a,n,[0,1,0]),i.useProgram(this.program),i.uniformMatrix4fv(this.uProjection,!1,this.projection),i.uniformMatrix4fv(this.uView,!1,this.view),i.activeTexture(i.TEXTURE0),i.uniform1i(this.uTexture,0),i.bindVertexArray(this.fieldVao),Pt(this.model),$(this.model,this.model,[0,0,St]),i.uniformMatrix4fv(this.uModel,!1,this.model);const h=0,c=2,u=h/this.sheetCols,f=c/this.sheetRows,d=(h+1)/this.sheetCols,l=(c+1)/this.sheetRows;i.uniform4f(this.uTileUV,u,f,d,l),i.drawElements(i.TRIANGLES,this.fieldIndices,i.UNSIGNED_SHORT,0),i.useProgram(this.lineProgram),i.uniformMatrix4fv(this.lineProj,!1,this.projection),i.uniformMatrix4fv(this.lineView,!1,this.view);const p=C();$(p,this.model,[0,.001,0]),i.uniformMatrix4fv(this.lineModel,!1,p),i.bindVertexArray(this.lineVao),i.drawElements(i.TRIANGLES,this.fieldLineMesh.indices.length,i.UNSIGNED_SHORT,0),i.useProgram(this.program),i.bindVertexArray(this.quadVao);const m=1,g=2,T=m/this.sheetCols,y=g/this.sheetRows,P=(m+1)/this.sheetCols,E=(g+1)/this.sheetRows;i.uniform4f(this.uTileUV,T,y,P,E);for(let v=0;v<this.goalPostPositions.length;v++){const[_,V,B]=this.goalPostPositions[v],Z=v%4===0||v%4===3?6:10,K=a[0]-_,Y=a[2]-B,U=Math.sqrt(K*K+Y*Y),et=U>50?1.5:U>150?2:1,q=C();$(q,q,[_,V,B]),it(q,q,[et,Z,1]),i.uniformMatrix4fv(this.uModel,!1,q),i.drawElements(i.TRIANGLES,6,i.UNSIGNED_SHORT,0)}i.bindVertexArray(this.quadVao);for(const v of s)v instanceof ct?v.render(this):this.renderSprite(v.pos,v.width,v.height,1,0);t.aimTarget.render(this)}}var X,wt,Et,bt;class ee{constructor(t){ft(this,X);this.state={moveX:0,moveZ:0,kickPressed:!1,kickReleased:!1,kickHeldTime:0,aimTarget:null},this.keys={},this.lastKeys={},this.touchMove=null,this.touchAim=null,this.kPressTime=0,t.addEventListener("touchstart",st(this,X,wt).bind(this),{passive:!1}),t.addEventListener("touchmove",st(this,X,Et).bind(this),{passive:!1}),t.addEventListener("touchend",st(this,X,bt).bind(this)),window.addEventListener("keydown",s=>this.keys[s.key.toLowerCase()]=!0),window.addEventListener("keyup",s=>this.keys[s.key.toLowerCase()]=!1)}endUpdate(){this.state.moveX=0,this.state.moveZ=0,this.state.kickPressed=!1,this.state.kickReleased=!1}update(t){var a;const s=!!this.keys.k,i=!!this.lastKeys.k;if(s&&!i&&(this.state.kickPressed=!0,this.kPressTime=0,this.state.aimTarget=[0,0]),s?(this.kPressTime+=t,this.state.aimTarget&&(this.keys.a&&(this.state.aimTarget[0]-=30*t),this.keys.d&&(this.state.aimTarget[0]+=30*t),this.keys.w&&(this.state.aimTarget[1]-=30*t),this.keys.s&&(this.state.aimTarget[1]+=30*t))):(this.keys.a&&(this.state.moveX-=1),this.keys.d&&(this.state.moveX+=1),this.keys.w&&(this.state.moveZ-=1),this.keys.s&&(this.state.moveZ+=1)),!s&&i&&(this.state.kickReleased=!0),this.state.kickHeldTime=this.kPressTime,this.touchMove&&!this.touchAim&&(this.state.moveX=this.touchMove.dx/50,this.state.moveZ=this.touchMove.dy/50),this.touchAim){this.kPressTime+=t;const r=this.touchAim.dx,n=this.touchAim.dy;console.log("Touch aim:",r,n);const h=10;this.state.aimTarget=[-r/h,-n/h],this.state.kickHeldTime=this.kPressTime}const o=(a=navigator.getGamepads)==null?void 0:a.call(navigator)[0];if(o){this.state.moveX+=o.axes[0]||0,this.state.moveZ+=-(o.axes[1]||0);const r=o.axes[2]||0,n=-(o.axes[3]||0),h=Math.hypot(r,n);h>.2&&(this.state.aimTarget=[r/h,n/h])}this.lastKeys={...this.keys}}getState(){return this.state}}X=new WeakSet,wt=function(t){t.preventDefault();for(const s of t.changedTouches)s.clientX<window.innerWidth/2?this.touchMove={id:s.identifier,startX:s.clientX,startY:s.clientY,dx:0,dy:0}:(this.touchAim={id:s.identifier,startX:s.clientX,startY:s.clientY,dx:0,dy:0},this.state.kickPressed=!0,this.kPressTime=0)},Et=function(t){t.preventDefault();for(const s of t.changedTouches)this.touchMove&&s.identifier===this.touchMove.id&&(this.touchMove.dx=s.clientX-this.touchMove.startX,this.touchMove.dy=s.clientY-this.touchMove.startY),this.touchAim&&s.identifier===this.touchAim.id&&(this.touchAim.dx=s.clientX-this.touchAim.startX,this.touchAim.dy=s.clientY-this.touchAim.startY)},bt=function(t){t.preventDefault();for(const s of t.changedTouches)this.touchAim&&s.identifier===this.touchAim.id&&(this.touchAim=null,this.state.kickReleased=!0),this.touchMove&&s.identifier===this.touchMove.id&&(this.touchMove=null)};class se{constructor(t,s){if(this.canvas=t,this.gl=t.getContext("webgl2"),!this.gl)throw new Error("WebGL2 not supported");this.renderer=new te(this.gl,t,s),this.controls=new ee(t),this.setPiece=null,this.entities=[],this.aimTarget=new Zt([5,.001,b/2]),this.ball=new Wt(A(0,0,b/2)),this.entities.push(this.ball),this.players=[],this.chasers=0,this.followers=0,this.homePositions=Tt(),this.awayPositions=Tt(!0);const i=[[this.homePositions,"home"],[this.awayPositions,"away"]];for(let[o,a]of i)for(const[r,n]of Object.entries(o)){const h=new qt(r,a,n,!r.toLowerCase().startsWith("bench"));this.entities.push(h),this.players.push(h),r==="RR"&&a==="home"&&(this.player=h)}this.closestPlayers={home:null,away:null},this.cameraTarget=A(0,10,b/2),this.cameraPos=A(0,10,b/2+15),this.resize(),window.addEventListener("resize",()=>this.resize()),this.lastTime=performance.now()}start(){this.lastTime=performance.now(),requestAnimationFrame(this.loop.bind(this))}loop(t){var a,r;const s=(t-this.lastTime)/1e3,i=Math.min(s,1/30);this.lastTime=t,this.updateClosestPlayers(),this.controls.update(i),this.chasers=0,this.followers=0;const o=w(this.ball.pos);for(const n of this.entities)n.update(i,this);if(this.setPiece&&(this.setPiece.update(i),this.setPiece.finished&&(this.setPiece=null)),!this.setPiece){let n=zt(o,this.ball.pos);if(n!==null){if(n==="goalAway"&&(this.ball.lastTouchedType!=="kick"||((a=this.ball.lastTouchedBy)==null?void 0:a.team)==="home")?n="behindAway":n==="goalHome"&&(this.ball.lastTouchedType!=="kick"||((r=this.ball.lastTouchedBy)==null?void 0:r.team)==="away")?n="behindHome":n==="innerLeftPostAway"||n==="innerRightPostAway"?n="behindAway":(n==="innerLeftPostHome"||n==="innerRightPostHome")&&(n="behindHome"),n==="behindAway"){const h=this.players.find(c=>c.name==="FB"&&c.team==="home");h&&(this.setPiece=new at(this,h,A(0,0,b-10)))}if(n==="behindHome"){const h=this.players.find(c=>c.name==="FB"&&c.team==="away");h&&(this.setPiece=new at(this,h,A(0,0,10)))}if(n==="goalAway"||n==="goalHome"||n==="outOfBounds")for(const h of this.entities)h.setupForBoundary(n,this.ball.pos)}}this.updateCameraTarget(),this.updatePlayerControl(),this.renderer.renderScene(this,this.entities),this.controls.endUpdate(),requestAnimationFrame(this.loop.bind(this))}updateClosestPlayers(){const t=this.ball,s={home:1/0,away:1/0},i={home:null,away:null};for(let o of this.players){const a=L(o.pos,t.pos);a<s[o.team]&&(s[o.team]=a,i[o.team]=o)}this.closestPlayers=i}updatePlayerControl(){const t=this.players.filter(a=>a.team==="home"),s=this.ball.carrier;if(!s||s&&s.team==="home")return;let i=null,o=1/0;for(const a of t){if(a.actionState==="tackle")continue;const r=Bt(a.pos,s.pos),n=(Math.abs(a.positionPos[0]-this.ball.pos[0])<10?-10:0)+(a.energy<.3?-5:0)+(a.pos[2]>s.pos[2]?-10:0);r+n<o&&(i=a,o=r+n)}i&&(this.player=i,this.player.aiming=!1)}updateCameraTarget(){const t=this.ball,s=t.carrier,i=s?(s.team==="home",w(s.pos)):w(t.pos);let o=s&&s.team==="home"?0:Math.max(40-i[2],15),a=-.2*i[0];z(i,i,[a,0,o]);const r=L(this.cameraTarget,i),n=Math.max(1/(1+3*r),.05);ot(this.cameraTarget,this.cameraTarget,i,n)}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.renderer.setupCamera()}}const ie="/footy/assets/spritesheet-erFZxRaO.png";function oe(e){const t=document.getElementById("glcanvas");if(!t)throw console.error("Canvas element not found"),new Error("Canvas element not found");new se(t,e).start()}Kt(ie).then(e=>{if(!e.complete)throw console.error("Failed to load sprite sheet"),new Error("Sprite sheet not loaded");oe(e)});
