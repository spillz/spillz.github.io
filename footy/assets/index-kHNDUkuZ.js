var __defProp=Object.defineProperty;var __typeError=msg=>{throw TypeError(msg)};var __defNormalProp=(obj,key,value)=>key in obj?__defProp(obj,key,{enumerable:!0,configurable:!0,writable:!0,value}):obj[key]=value;var __publicField=(obj,key,value)=>__defNormalProp(obj,typeof key!="symbol"?key+"":key,value),__accessCheck=(obj,member,msg)=>member.has(obj)||__typeError("Cannot "+msg);var __privateAdd=(obj,member,value)=>member.has(obj)?__typeError("Cannot add the same private member more than once"):member instanceof WeakSet?member.add(obj):member.set(obj,value);var __privateMethod=(obj,member,method)=>(__accessCheck(obj,member,"access private method"),method);(function(){const relList=document.createElement("link").relList;if(relList&&relList.supports&&relList.supports("modulepreload"))return;for(const link of document.querySelectorAll('link[rel="modulepreload"]'))processPreload(link);new MutationObserver(mutations=>{for(const mutation of mutations)if(mutation.type==="childList")for(const node of mutation.addedNodes)node.tagName==="LINK"&&node.rel==="modulepreload"&&processPreload(node)}).observe(document,{childList:!0,subtree:!0});function getFetchOpts(link){const fetchOpts={};return link.integrity&&(fetchOpts.integrity=link.integrity),link.referrerPolicy&&(fetchOpts.referrerPolicy=link.referrerPolicy),link.crossOrigin==="use-credentials"?fetchOpts.credentials="include":link.crossOrigin==="anonymous"?fetchOpts.credentials="omit":fetchOpts.credentials="same-origin",fetchOpts}function processPreload(link){if(link.ep)return;link.ep=!0;const fetchOpts=getFetchOpts(link);fetch(link.href,fetchOpts)}})();var EPSILON=1e-6,ARRAY_TYPE=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var y=0,i=arguments.length;i--;)y+=arguments[i]*arguments[i];return Math.sqrt(y)});function create$2(){var out=new ARRAY_TYPE(16);return ARRAY_TYPE!=Float32Array&&(out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[11]=0,out[12]=0,out[13]=0,out[14]=0),out[0]=1,out[5]=1,out[10]=1,out[15]=1,out}function identity(out){return out[0]=1,out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[5]=1,out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[10]=1,out[11]=0,out[12]=0,out[13]=0,out[14]=0,out[15]=1,out}function translate(out,a,v){var x=v[0],y=v[1],z=v[2],a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23;return a===out?(out[12]=a[0]*x+a[4]*y+a[8]*z+a[12],out[13]=a[1]*x+a[5]*y+a[9]*z+a[13],out[14]=a[2]*x+a[6]*y+a[10]*z+a[14],out[15]=a[3]*x+a[7]*y+a[11]*z+a[15]):(a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],out[0]=a00,out[1]=a01,out[2]=a02,out[3]=a03,out[4]=a10,out[5]=a11,out[6]=a12,out[7]=a13,out[8]=a20,out[9]=a21,out[10]=a22,out[11]=a23,out[12]=a00*x+a10*y+a20*z+a[12],out[13]=a01*x+a11*y+a21*z+a[13],out[14]=a02*x+a12*y+a22*z+a[14],out[15]=a03*x+a13*y+a23*z+a[15]),out}function scale(out,a,v){var x=v[0],y=v[1],z=v[2];return out[0]=a[0]*x,out[1]=a[1]*x,out[2]=a[2]*x,out[3]=a[3]*x,out[4]=a[4]*y,out[5]=a[5]*y,out[6]=a[6]*y,out[7]=a[7]*y,out[8]=a[8]*z,out[9]=a[9]*z,out[10]=a[10]*z,out[11]=a[11]*z,out[12]=a[12],out[13]=a[13],out[14]=a[14],out[15]=a[15],out}function rotateX(out,a,rad){var s=Math.sin(rad),c=Math.cos(rad),a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11];return a!==out&&(out[0]=a[0],out[1]=a[1],out[2]=a[2],out[3]=a[3],out[12]=a[12],out[13]=a[13],out[14]=a[14],out[15]=a[15]),out[4]=a10*c+a20*s,out[5]=a11*c+a21*s,out[6]=a12*c+a22*s,out[7]=a13*c+a23*s,out[8]=a20*c-a10*s,out[9]=a21*c-a11*s,out[10]=a22*c-a12*s,out[11]=a23*c-a13*s,out}function perspectiveNO(out,fovy,aspect,near,far){var f=1/Math.tan(fovy/2),nf;return out[0]=f/aspect,out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[5]=f,out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[11]=-1,out[12]=0,out[13]=0,out[15]=0,far!=null&&far!==1/0?(nf=1/(near-far),out[10]=(far+near)*nf,out[14]=2*far*near*nf):(out[10]=-1,out[14]=-2*near),out}var perspective=perspectiveNO;function lookAt(out,eye,center,up){var x0,x1,x2,y0,y1,y2,z0,z1,z2,len,eyex=eye[0],eyey=eye[1],eyez=eye[2],upx=up[0],upy=up[1],upz=up[2],centerx=center[0],centery=center[1],centerz=center[2];return Math.abs(eyex-centerx)<EPSILON&&Math.abs(eyey-centery)<EPSILON&&Math.abs(eyez-centerz)<EPSILON?identity(out):(z0=eyex-centerx,z1=eyey-centery,z2=eyez-centerz,len=1/Math.hypot(z0,z1,z2),z0*=len,z1*=len,z2*=len,x0=upy*z2-upz*z1,x1=upz*z0-upx*z2,x2=upx*z1-upy*z0,len=Math.hypot(x0,x1,x2),len?(len=1/len,x0*=len,x1*=len,x2*=len):(x0=0,x1=0,x2=0),y0=z1*x2-z2*x1,y1=z2*x0-z0*x2,y2=z0*x1-z1*x0,len=Math.hypot(y0,y1,y2),len?(len=1/len,y0*=len,y1*=len,y2*=len):(y0=0,y1=0,y2=0),out[0]=x0,out[1]=y0,out[2]=z0,out[3]=0,out[4]=x1,out[5]=y1,out[6]=z1,out[7]=0,out[8]=x2,out[9]=y2,out[10]=z2,out[11]=0,out[12]=-(x0*eyex+x1*eyey+x2*eyez),out[13]=-(y0*eyex+y1*eyey+y2*eyez),out[14]=-(z0*eyex+z1*eyey+z2*eyez),out[15]=1,out)}function create$1(){var out=new ARRAY_TYPE(3);return ARRAY_TYPE!=Float32Array&&(out[0]=0,out[1]=0,out[2]=0),out}function squaredDistance(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2];return x*x+y*y+z*z}(function(){var vec=create$1();return function(a,stride,offset,count,fn,arg){var i,l;for(stride||(stride=3),offset||(offset=0),count?l=Math.min(count*stride+offset,a.length):l=a.length,i=offset;i<l;i+=stride)vec[0]=a[i],vec[1]=a[i+1],vec[2]=a[i+2],fn(vec,vec,arg),a[i]=vec[0],a[i+1]=vec[1],a[i+2]=vec[2];return a}})();function create(){var out=new ARRAY_TYPE(2);return ARRAY_TYPE!=Float32Array&&(out[0]=0,out[1]=0),out}function fromValues(x,y){var out=new ARRAY_TYPE(2);return out[0]=x,out[1]=y,out}function add(out,a,b){return out[0]=a[0]+b[0],out[1]=a[1]+b[1],out}(function(){var vec=create();return function(a,stride,offset,count,fn,arg){var i,l;for(stride||(stride=2),offset||(offset=0),count?l=Math.min(count*stride+offset,a.length):l=a.length,i=offset;i<l;i+=stride)vec[0]=a[i],vec[1]=a[i+1],fn(vec,vec,arg),a[i]=vec[0],a[i+1]=vec[1];return a}})();class Vec3 extends Float32Array{constructor(x=0,y=0,z=0){super(3),this[0]=x,this[1]=y,this[2]=z}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}set x(v){this[0]=v}set y(v){this[1]=v}set z(v){this[2]=v}get c(){return new Vec3(this[0],this[1],this[2])}zeroX(){return this[0]=0,this}zeroY(){return this[1]=0,this}zeroZ(){return this[2]=0,this}setFrom(x,y,z){return this[0]=x,this[1]=y,this[2]=z,this}add(v){return this[0]+=v[0],this[1]+=v[1],this[2]+=v[2],this}sub(v){return this[0]-=v[0],this[1]-=v[1],this[2]-=v[2],this}scale(s){return this[0]*=s,this[1]*=s,this[2]*=s,this}scaleAndAdd(v,s){return this[0]+=v[0]*s,this[1]+=v[1]*s,this[2]+=v[2]*s,this}normalize(){const len=Math.hypot(this[0],this[1],this[2]);return len>0?this.scale(1/len):this.setFrom(0,0,0)}dot(v){return this[0]*v[0]+this[1]*v[1]+this[2]*v[2]}cross(v){return new Vec3(this[1]*v[2]-this[2]*v[1],this[2]*v[0]-this[0]*v[2],this[0]*v[1]-this[1]*v[0])}lenSq(){return this[0]**2+this[1]**2+this[2]**2}len(){return Math.hypot(this[0],this[1],this[2])}dist(v){return Math.hypot(this[0]-v[0],this[1]-v[1],this[2]-v[2])}copyFrom(v){return this[0]=v[0],this[1]=v[1],this[2]=v[2],this}toArray(){return[this[0],this[1],this[2]]}static fromArray(arr){return new Vec3(arr[0],arr[1],arr[2])}static direction(from,to){return new Vec3(to[0]-from[0],to[1]-from[1],to[2]-from[2]).normalize()}lerp(to,t){return this[0]+=(to[0]-this[0])*t,this[1]+=(to[1]-this[1])*t,this[2]+=(to[2]-this[2])*t,this}lerpEased(target,t,easing){const te=easing?easing(t):t;return this[0]+=(target[0]-this[0])*te,this[1]+=(target[1]-this[1])*te,this[2]+=(target[2]-this[2])*te,this}get xz(){return new Vec2$1(this[0],this[2])}get xy(){return new Vec2$1(this[0],this[1])}get yz(){return new Vec2$1(this[1],this[2])}toDir(target){return this.sub(target).normalize()}moveTo(target,amount,overRun=!1){const dx=target[0]-this[0],dy=target[1]-this[1],dz=target[2]-this[2],dist2=Math.hypot(dx,dy,dz);if(dist2<1e-5)return this;const f=overRun?amount/dist2:Math.min(1,amount/dist2);return this[0]+=dx*f,this[1]+=dy*f,this[2]+=dz*f,this}moveDir(dir,amount){const dx=dir[0],dy=dir[1],dz=dir[2],dist2=Math.hypot(dx,dy,dz);return dist2<1e-5?this:(this[0]+=dx*amount/dist2,this[1]+=dy*amount/dist2,this[2]+=dz*amount/dist2,this)}}let Vec2$1=class Vec2 extends Float32Array{constructor(x=0,y=0){super(2),this[0]=x,this[1]=y}get x(){return this[0]}get y(){return this[1]}set x(v){this[0]=v}set y(v){this[1]=v}get c(){return new Vec2(this[0],this[1])}set(x,y){return this[0]=x,this[1]=y,this}add(v){return this[0]+=v[0],this[1]+=v[1],this}sub(v){return this[0]-=v[0],this[1]-=v[1],this}scale(s){return this[0]*=s,this[1]*=s,this}normalize(){const len=Math.hypot(this[0],this[1]);return len>0?this.scale(1/len):this.set(0,0)}dot(v){return this[0]*v[0]+this[1]*v[1]}lenSq(){return this[0]**2+this[1]**2}len(){return Math.sqrt(this.lenSq())}dist(v){return Math.hypot(this[0]-v[0],this[1]-v[1])}copyFrom(v){return this[0]=v[0],this[1]=v[1],this}toArray(){return[this[0],this[1]]}static fromArray(arr){return new Vec2(arr[0],arr[1])}static direction(from,to){return new Vec2(to[0]-from[0],to[1]-from[1]).normalize()}lerp(to,t){return this[0]+=(to[0]-this[0])*t,this[1]+=(to[1]-this[1])*t,this}lerpEased(target,t,easing=void 0){const te=easing?easing(t):t;return this[0]+=(target[0]-this[0])*te,this[1]+=(target[1]-this[1])*te,this[2]+=(target[2]-this[2])*te,this}toDir(target){return this.sub(target).normalize()}moveTo(target,amount,overRun=!1){const dx=target[0]-this[0],dy=target[1]-this[1],dist2=Math.hypot(dx,dy);if(dist2<1e-5)return this;const f=overRun?amount/dist2:Math.min(1,amount/dist2);return this[0]+=dx*f,this[1]+=dy*f,this}moveDir(dir,amount){const dx=dir[0],dy=dir[1],dist2=Math.hypot(dx,dy);return dist2<1e-5?this:(this[0]+=dx*amount/dist2,this[1]+=dy*amount/dist2,this)}};const v3=(x=0,y=0,z=0)=>new Vec3(x,y,z),v2=(x=0,y=0)=>new Vec2$1(x,y),FIELD_WIDTH=160,FIELD_LENGTH$1=170,FIELD_RADIUS_X$1=FIELD_WIDTH/2,FIELD_RADIUS_Z$1=FIELD_LENGTH$1/2,GOAL_WIDTH=6,BEHIND_WIDTH=6,POST_THICKNESS=.5,goals=Object.freeze({home:[0,0,0],away:[0,0,FIELD_LENGTH$1]}),GOAL_POSTS_NORTH=Object.freeze([v3(-.5*GOAL_WIDTH-BEHIND_WIDTH,0,FIELD_LENGTH$1),v3(-.5*GOAL_WIDTH,0,FIELD_LENGTH$1),v3(.5*GOAL_WIDTH,0,FIELD_LENGTH$1),v3(.5*GOAL_WIDTH+BEHIND_WIDTH,0,FIELD_LENGTH$1)]),GOAL_POSTS_SOUTH=Object.freeze([v3(-.5*GOAL_WIDTH-BEHIND_WIDTH,0,0),v3(-.5*GOAL_WIDTH,0,0),v3(.5*GOAL_WIDTH,0,0),v3(.5*GOAL_WIDTH+BEHIND_WIDTH,0,0)]),GOAL_POSTS=Object.freeze({Away:GOAL_POSTS_NORTH,Home:GOAL_POSTS_SOUTH});function isOutOfBounds(pos){const xNorm=pos[0]/FIELD_RADIUS_X$1,zNorm=(pos[2]-FIELD_RADIUS_Z$1)/FIELD_RADIUS_Z$1;return xNorm*xNorm+zNorm*zNorm>1}function pointToSegmentDistanceSq(px,pz,x0,z0,x1,z1){const dx=x1-x0,dz=z1-z0;if(dx===0&&dz===0){const dxp2=px-x0,dzp2=pz-z0;return dxp2*dxp2+dzp2*dzp2}const t=((px-x0)*dx+(pz-z0)*dz)/(dx*dx+dz*dz),clampedT=Math.max(0,Math.min(1,t)),closestX=x0+clampedT*dx,closestZ=z0+clampedT*dz,dxp=px-closestX,dzp=pz-closestZ;return dxp*dxp+dzp*dzp}function checkBoundaryCrossing(before,after){const iobBefore=isOutOfBounds(before),iobAfter=isOutOfBounds(after);for(const tag of["Away","Home"]){const posts=GOAL_POSTS[tag];if(iobAfter&&!iobBefore){if(tag==="Away"){if(before[2]>FIELD_LENGTH$1-10){const x=after[0];if(x>=-3&&x<=3)return"goalAway";if(x>=-9&&x<-3||x>3&&x<=9)return"behindAway"}}else if(tag==="Home"&&before[2]<10){const x=after[0];if(x>=-3&&x<=3)return"goalHome";if(x>=-9&&x<-3||x>3&&x<=9)return"behindHome"}}const postLabels=["outerLeftPost","innerLeftPost","innerRightPost","outerRightPost"];for(let i=0;i<posts.length;i++){const px=posts[i][0],pz=posts[i][2];if(pointToSegmentDistanceSq(px,pz,before[0],before[2],after[0],after[2])<POST_THICKNESS*POST_THICKNESS)return`${postLabels[i]}${tag}`}}return!iobBefore&&iobAfter?"outOfBounds":null}function generateFieldPositions(flip=!1){const r={fullForward:70,halfForward:35,halfBack:-35,fullBack:-70},angleMap={LFP:-45,FF:0,RFP:45,LHF:-50,CHF:0,RHF:50,LHB:-50,CHB:0,RHB:50,LBP:-45,FB:0,RBP:45};function setPos(angle,radius){const angleRad=angle*Math.PI/180,x=FIELD_RADIUS_X$1*Math.sin(angleRad)*(Math.abs(radius)/FIELD_RADIUS_Z$1)-(flip?2:-2),z=FIELD_RADIUS_Z$1+radius*(flip?-1:1);return v3(x,0,z)}const benchX=-FIELD_RADIUS_X$1-4,benchZ=offset=>FIELD_RADIUS_Z$1+(flip?1:-1)*offset;return{LFP:setPos(angleMap.LFP,r.fullForward-(flip?10:-10)),FF:setPos(angleMap.FF,r.fullForward),RFP:setPos(angleMap.RFP,r.fullForward-(flip?10:-10)),LHF:setPos(angleMap.LHF,r.halfForward),CHF:setPos(angleMap.CHF,r.halfForward),RHF:setPos(angleMap.RHF,r.halfForward),LW:v3(-25,0,FIELD_RADIUS_Z$1-(flip?2:-2)),C:v3(8,0,FIELD_RADIUS_Z$1-(flip?-5:5)),RW:v3(25,0,FIELD_RADIUS_Z$1-(flip?2:-2)),LHB:setPos(angleMap.LHB,r.halfBack),CHB:setPos(angleMap.CHB,r.halfBack),RHB:setPos(angleMap.RHB,r.halfBack),LBP:setPos(angleMap.LBP,r.fullBack-(flip?10:-10)),FB:setPos(angleMap.FB,r.fullBack),RBP:setPos(angleMap.RBP,r.fullBack-(flip?10:-10)),Ruck:v3(0,0,FIELD_RADIUS_Z$1-(flip?10:-10)),RR:v3(-10,0,FIELD_RADIUS_Z$1-(flip?10:-10)),Rover:v3(10,0,FIELD_RADIUS_Z$1-(flip?10:-10)),Bench1:v3(benchX,0,benchZ(10)),Bench2:v3(benchX,0,benchZ(13)),Bench3:v3(benchX,0,benchZ(16)),Bench4:v3(benchX,0,benchZ(19)),Bench5:v3(benchX,0,benchZ(22))}}function findClosestOpponent(kicker,players,markPos){let closest=null,minDist=1/0;for(const p of players)if(p.team!==kicker.team){const d=p.pos.dist(markPos);d<minDist&&(minDist=d,closest=p)}return closest}class SetPiece{constructor(game,kicker,markPos){this.game=game,this.kicker=kicker,this.markPos=markPos.c,this.timer=0,this.finished=!1}update(dt){this.timer+=dt}enforce(player,dt){return!1}cleanup(){}}class MarkSetPiece extends SetPiece{constructor(game,kicker,markPos){super(game,kicker,markPos),this.defender=null,this.zone={center:v3(0,0,0),radius:1},this.game=game,game=this.game,kicker=this.kicker;const goalZ=kicker.team==="home"?0:FIELD_LENGTH$1,goalPos=v3(0,0,goalZ),dir=markPos.c.sub(goalPos).zeroY().normalize(),kickerDistance=15,defenderPos=markPos.c,kickerPos=markPos.c;kicker.pos.copyFrom(kickerPos),kicker.jogVel.copyFrom(dir).scale(kicker.jogSpeed),kicker.joltVel.setFrom(0,0,0),game.ball.carrier!==kicker&&game.ball.pickup(kicker),kicker.team==="home"&&(this.game.player=kicker),kicker.stateTimer=kickerDistance/kicker.jogSpeed,this.defender=findClosestOpponent(kicker,game.players,markPos),this.defender&&(this.defender.pos.copyFrom(defenderPos),this.defender.vel.setFrom(0,0,0),this.defender.jogVel.setFrom(0,0,0),this.defender.joltVel.setFrom(0,0,0),this.defender.actionState="standingMark",this.defender.stateTimer=10)}update(dt){super.update(dt);const{kicker,markPos,game}=this,disposed=!game.ball.carried,markToKicker=kicker.pos.c.sub(markPos);markToKicker[1]=0;const goalZ=kicker.team==="home"?0:FIELD_LENGTH$1,goalDir=v3(0,0,goalZ).sub(markPos).zeroY().normalize(),forwardDist=markToKicker.dot(goalDir),lateralVec=v3(-goalDir[2],0,goalDir[0]),lateralDist=markToKicker.dot(lateralVec),playedOn=forwardDist>.05||lateralDist>2;(disposed||playedOn)&&(this.finished=!0)}enforce(player,dt){const{kicker,defender,markPos}=this,kickerPos=kicker.pos,center=markPos.c.lerp(kickerPos,.5),radius=markPos.dist(kickerPos)/2+5,dist2=player.pos.dist(center);if(player===defender)return player.pos.copyFrom(defender.pos),player.vel.setFrom(0,0,0),player.jogVel.setFrom(0,0,0),player.joltVel.setFrom(0,0,0),!1;if(dist2<radius&&player!==kicker&&player!==defender){const dist3=player.pos.dist(center),overlap=radius-dist3;if(overlap>0){const toOutside=player.pos.c.sub(center);toOutside[1]=0,toOutside.len()<.001?toOutside.setFrom(Math.random()-.5,0,Math.random()-.5).normalize():toOutside.normalize();const pushStrength=overlap<2?overlap*10:overlap*20;return player.joltVel.scaleAndAdd(toOutside,pushStrength*dt),player.pos.scaleAndAdd(player.joltVel,dt),!0}}return!1}}function splitmix64(seed){let state=BigInt(seed)&0xFFFFFFFFFFFFFFFFn;return function(){state=state+0x9E3779B97F4A7C15n&0xFFFFFFFFFFFFFFFFn;let z=state;return z=(z^z>>30n)*0xBF58476D1CE4E5B9n&0xFFFFFFFFFFFFFFFFn,z=(z^z>>27n)*0x94D049BB133111EBn&0xFFFFFFFFFFFFFFFFn,z=z^z>>31n,z}}class PRNG{constructor(){__publicField(this,"_seed",0)}random(){return Math.random()}seed(seed){throw new Error("Seeding is not available in the default PRNG class. You can set another with `eskv.rand.setPRNG`.")}getRandomInt(m1,m2=0){return m2!=0?m1+Math.floor(this.random()*(m2-m1)):Math.floor(this.random()*m1)}getRandomPos(maxX,maxY){return[this.getRandomInt(maxX),this.getRandomInt(maxY)]}randomRange(min=0,max=1){return Math.floor(this.random()*(max-min+1))+min}randomFloat(min=0,max=1){return this.random()*(max-min)+min}shuffle(arr){let temp,r;for(let i=1;i<arr.length;i++)r=this.randomRange(0,i),temp=arr[i],arr[i]=arr[r],arr[r]=temp;return arr}choose(array){return array[Math.floor(this.random()*array.length)]}chooseN(arr,n){let result=new Array(n),len=arr.length,taken=new Array(len);if(n>len)throw new RangeError("chooeN: more elements requested than available");for(;n--;){let x=Math.floor(this.random()*len);result[n]=arr[x in taken?taken[x]:x],taken[x]=--len in taken?taken[len]:len}return result}}function sfc32(a,b,c,d){return function(){a>>>=0,b>>>=0,c>>>=0,d>>>=0;var t=a+b|0;return a=b^b>>>9,b=c+(c<<3)|0,c=c<<21|c>>>11,d=d+1|0,t=t+d|0,c=c+t|0,(t>>>0)/4294967296}}function mulberry32(a){return function(){var t=a+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function xoshiro128ss(a,b,c,d){return function(){var t=b<<9,r=b*5;return r=(r<<7|r>>>25)*9,c^=a,d^=b,b^=c,a^=d,c^=t,d=d<<11|d>>>21,(r>>>0)/4294967296}}function jsf32(a,b,c,d){return function(){a|=0,b|=0,c|=0,d|=0;var t=a-(b<<27|b>>>5)|0;return a=b^(c<<17|c>>>15),b=c+d|0,c=d+t|0,d=a+t|0,(d>>>0)/4294967296}}class PRNG_sfc32 extends PRNG{constructor(){super(...arguments);__publicField(this,"_seed",1);__publicField(this,"d",3735928559);__publicField(this,"xorSeed",Math.floor(Date.now())^this.d);__publicField(this,"random",sfc32(2654435769,608135816,3084996962,this.xorSeed))}seed(seed){this._seed=seed,this.xorSeed=seed^this.d;const sm=splitmix64(this.xorSeed);this.random=sfc32(sm(),sm(),sm(),sm())}}class PRNG_mulberry32 extends PRNG{constructor(){super(...arguments);__publicField(this,"_seed",1);__publicField(this,"d",3735928559);__publicField(this,"xorSeed",Math.floor(Date.now())^this.d);__publicField(this,"random",mulberry32(this.xorSeed))}seed(seed){this._seed=seed,this.xorSeed=seed^this.d,this.random=mulberry32(this.xorSeed)}}class PRNG_xoshiro128ss extends PRNG{constructor(){super(...arguments);__publicField(this,"_seed",1);__publicField(this,"d",3735928559);__publicField(this,"xorSeed",Math.floor(Date.now())^this.d);__publicField(this,"random",xoshiro128ss(2654435769,608135816,3084996962,this.xorSeed))}seed(seed){this._seed=seed,this.xorSeed=seed^this.d;const sm=splitmix64(this.xorSeed);this.random=xoshiro128ss(sm(),sm(),sm(),sm())}}class PRNG_jsf32 extends PRNG{constructor(){super(...arguments);__publicField(this,"_seed",1);__publicField(this,"d",3735928559);__publicField(this,"xorSeed",Math.floor(Date.now())^this.d);__publicField(this,"random",jsf32(2654435769,608135816,3084996962,this.xorSeed))}seed(seed){this._seed=seed,this.xorSeed=seed^this.d;const sm=splitmix64(this.xorSeed);this.random=jsf32(sm(),sm(),sm(),sm())}}var defaultPRNG=new PRNG_sfc32;function setPRNG(name){switch(name){case"Math.random":defaultPRNG=new PRNG;return;case"sfc32":defaultPRNG=new PRNG_sfc32;return;case"mulberry32":defaultPRNG=new PRNG_mulberry32;return;case"xoshiro128ss":defaultPRNG=new PRNG_xoshiro128ss;return;case"jsf32":defaultPRNG=new PRNG_jsf32;return;default:throw Error(`Unknown PRNG ${name}`)}}function getRandomInt(m1,m2=0){return defaultPRNG.getRandomInt(m1,m2)}function getRandomPos(max1,max2){return defaultPRNG.getRandomPos(max1,max2)}function randomFloat(min=0,max=1){return defaultPRNG.randomFloat(min,max)}function choose(array){return defaultPRNG.choose(array)}function setSeed(seed){return defaultPRNG.seed(seed)}function stringToSeed(str){let hash=5381;for(let i=0;i<str.length;i++)hash=(hash<<5)+hash+str.charCodeAt(i),hash=hash&4294967295;return hash>>>0}function collidesCylindrical(a,b){const[aw,ah]=a.collideBounds(),[bw,bh]=b.collideBounds(),dx=a.pos[0]-b.pos[0],dz=a.pos[2]-b.pos[2],horizDistSq=dx*dx+dz*dz,ra=.5*aw,rb=.5*bw,combinedR=ra+rb,aBottom=a.pos[1],aTop=a.pos[1]+ah,bBottom=b.pos[1],bTop=b.pos[1]+bh,verticalOverlap=aBottom<bTop&&aTop>bBottom;return horizDistSq<=combinedR*combinedR&&verticalOverlap}function getEffectiveCollisionRadius(player){const base=player.collideBounds()[0]||1;return player.intent==="shepherd"||player.intent==="block"?base*1.4:player.intent==="crumb"||player.intent==="hangBack"?base*.8:base}function getIntentWeightBias(intent){switch(intent){case"mark":return 1.3;case"block":return 1.4;case"spoil":return 1.1;case"shepherd":return 1.25;case"contestAnyway":return 1;case"crumb":return .7;case"hangBack":return .5;default:return 1}}class Entity{constructor(pos){this.pos=v3(pos[0],pos[1],pos[2]),this.vel=v3(0,0,0),this.width=1.6,this.height=2.4,this.usesGravity=!0,this.gravity=v3(0,-9.8,0),this.bounce=0,this.floorY=0}setupForBoundary(side,pos){}update(dt,game){this.usesGravity&&this.vel.scaleAndAdd(this.gravity,dt),this.pos.scaleAndAdd(this.vel,dt),this.pos[1]<this.floorY&&(this.pos[1]=this.floorY,Math.abs(this.vel[1])>.5?this.vel[1]=-this.vel[1]*this.bounce:this.vel[1]=0)}render(renderer){renderer.renderSprite(this.pos,this.width,this.height,1,0)}collidesWith(e){return collidesCylindrical(this,e)}collideBounds(){return[.5,1.8]}}const playerAnimationSets={home:Object.freeze({idle:[[0,0,0]],run:[[1,0,0],[2,0,0],[3,0,0],[4,0,0],[5,0,0],[6,0,0]],kickRightFoot:[[1,0,0],[2,0,0]],kickLeftFoot:[[4,0,0],[5,0,0]],handpassRightHand:[[1,0,0],[0,0,0]],handpassLeftHand:[[4,0,0],[0,0,0]],jumpMark:[[1,0,0],[2,0,0],[0,0,0]],jumpSpoil:[[1,0,0],[2,0,0],[0,0,0]]}),away:Object.freeze({idle:[[0,4,0]],run:[[1,4,0],[2,4,0],[3,4,0],[4,4,0],[5,4,0],[6,4,0]],kickRightFoot:[[1,4,0],[2,4,0]],kickLeftFoot:[[4,4,0],[5,4,0]],handpassRightHand:[[1,4,0],[0,4,0]],handpassLeftHand:[[4,4,0],[0,4,0]],jumpMark:[[1,4,0],[2,4,0],[0,4,0]],jumpSpoil:[[1,4,0],[2,4,0],[0,4,0]]})},teams=Object.freeze({0:"Carlton",1:"West Coast",2:"Sydney",3:"Brisbane",4:"West Melbourne",5:"Collingwood",6:"Hawthorne",7:"Geelong",8:"Adelaide",9:"Fremantle",10:"Western Sydney",11:"Port Adelaide",12:"Melbourne",13:"Saint Kilda",14:"North Melbourne",15:"Essendon",16:"Richmond",17:"Gold Coast"}),teamAbbrevs=Object.freeze({0:"CRL",1:"WCO",2:"SYD",3:"BRS",4:"WME",5:"COL",6:"HAW",7:"GEL",8:"ADL",9:"FRM",10:"WSY",11:"PAD",12:"MEL",13:"STK",14:"NME",15:"ESS",16:"RCH",17:"GCO"}),personAnimationSets=Object.freeze({ruddy:{front:[0,12,0],back:[0,13,0],headCount:4,bodyRowOffset:9},pasty:{front:[0,14,0],back:[0,15,0],headCount:3,bodyRowOffset:10},swarthy:{front:[0,16,0],back:[0,17,0],headCount:3,bodyRowOffset:11}}),uniformAnimationSets=Object.freeze({home:{front:[0,5,0],back:[0,6,0]},away:{front:[0,7,0],back:[0,8,0]}}),bodyAnimationSets=Object.freeze({idle:[[0,0,0]],run:[[1,0,0],[2,0,0],[3,0,0],[4,0,0],[5,0,0],[6,0,0]],kickRightFoot:[[1,0,0],[2,0,0]],kickLeftFoot:[[4,0,0],[5,0,0]],handpassRightHand:[[1,0,0],[0,0,0]],handpassLeftHand:[[4,0,0],[0,0,0]],jumpMark:[[1,0,0],[2,0,0],[0,0,0]],jumpSpoil:[[1,0,0],[2,0,0],[0,0,0]]});class Player extends Entity{constructor(name,team,teamId,pos,playing=!1){super(pos),this.intent="idle",this.intentTarget=null,this.positionPos=Vec3.fromArray(pos),this.teamId=teamId,this.complexion=choose(["ruddy","pasty","swarthy"]),this.faceId=getRandomInt(personAnimationSets[this.complexion].headCount),this.name=name,this.team=team,this.playing=playing,this.width=1.6,this.height=2.4,this.aiming=!1,this.jogVel=v3(0,0,0),this.joltVel=v3(0,0,0),this.jogSpeed=5,this.joltSpeed=2,this.energy=10,this.energyRecovery=0,this.statsWeight=85+Math.random()*10,this.statsStrength=50+Math.random()*30,this.statsSpeed=10+Math.random()*5,this.statsJump=10,this.statsKickRange=45,this.statsHandpassRange=20,this.statsAgility=10,this.joltDecayRate=8,this.animations=playerAnimationSets[team]??playerAnimationSets.home,this.animState="idle",this.actionState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=8,this.stateTimer=0,this.animSprite=[[0,0,0]]}updateAI(dt,game){const ball=game.ball;let newActionState=null;if(ball.carried&&ball.carrier===this)if(this.stateTimer+=dt,this.stateTimer<1)newActionState="run";else{let underPressure=!1;for(const p of game.players)if(!(p===this||p.team===this.team)&&p.pos.dist(this.pos)<7){underPressure=!0;break}const teammates=game.players.filter(p=>p.team===this.team&&p!==this);if(underPressure){let best=null,bestScore=-1/0;const forwardVec=v3(0,0,this.team==="home"?-1:1);for(const t of teammates){if(t===this)continue;const d=this.pos.dist(t.pos);if(d>40)continue;let contested=!1;for(const p of game.players)if(p.team!==this.team&&p.pos.dist(t.pos)<5){contested=!0;break}if(contested)continue;const toTeammate=this.pos.c.toDir(t.pos),dirAlign=forwardVec.c.dot(toTeammate),teammateVel=Vec3.fromArray(t.vel);teammateVel[1]=0;const teammateAlign=forwardVec.dot(teammateVel),distancePenalty=Math.abs(d-15)*.2,score=15*dirAlign+2*teammateAlign-distancePenalty;score>bestScore&&(bestScore=score,best=t)}if(best){const delta=best.pos.c.sub(this.pos),aimTarget=[delta[0],delta[2]];return this.tryDisposeBall(game,{kickReleased:!0,kickHeldTime:delta.len()>20?.5:.1,aimTarget})??"run"}}const goalZ=this.team==="home"?-5:FIELD_LENGTH$1+5,goalX=0;if(Math.abs(this.pos[2]-goalZ)<=this.statsKickRange){const delta=v3(goalX+(Math.random()-.5)*9,0,goalZ).sub(this.pos),aimTarget=[delta[0],delta[2]];return this.tryDisposeBall(game,{kickReleased:!0,kickHeldTime:.4,aimTarget})??"run"}if(underPressure||this.stateTimer>5){let best=null,bestScore=-1/0;for(const t of teammates){const d=this.pos.dist(t.pos);if(d>this.statsKickRange)continue;const towardGoalZ=this.team==="home"?-1:1,dz=(t.pos[2]-this.pos[2])*towardGoalZ,dx=Math.abs(t.pos[0]-this.pos[0]),score=dz-dx-d;score>bestScore&&(bestScore=score,best=t)}if(best){const delta=best.pos.c.sub(this.pos),aimTarget=[delta[0],delta[2]];return this.tryDisposeBall(game,{kickReleased:!0,kickHeldTime:.4,aimTarget})??"run"}}newActionState="run"}let target=null;if(ball.carried&&ball.carrier===this){const towardGoalZ=this.team==="home"?-1:1,baseDir=v3(0,0,towardGoalZ);let avoidanceVec=v3(0,0,0);for(const other of game.players){if(other===this||other.team===this.team)continue;const offset=this.pos.c.sub(other.pos);offset[1]=0;const dist2=offset.len();if(dist2<5&&dist2>.5){const strength=1/dist2;avoidanceVec.scaleAndAdd(offset.normalize(),strength)}}const combined=baseDir.c.add(avoidanceVec).normalize();target=this.pos.c.scaleAndAdd(combined,10)}else if(ball.carried)if(ball.carrier&&ball.carrier.team!==this.team&&game.chasers<3&&game.closestPlayers[this.team]===this||ball.pos.dist(this.pos)<=15&&this.energy>0)target=ball.pos.c,game.chasers++;else if(ball.carrier&&ball.carrier.team===this.team&&ball.pos[2]>20&&ball.pos[2]<FIELD_LENGTH$1-20&&ball.pos.dist(this.pos)<10&&this.energy>.3&&game.followers<3){game.followers++;const forward=ball.carrier.jogVel.c;forward.len()<.01&&(forward[2]=this.team==="home"?-1:1),forward.normalize();const lateral=v3(-forward[2],0,forward[0]).normalize();let lateralOffset=0,forwardOffset=12;switch(this.name){case"wing":lateralOffset=12*(this.team==="home"?-1:1),forwardOffset=15;break;case"forward":lateralOffset=6,forwardOffset=18;break;case"half-forward":case"half-back":lateralOffset=4,forwardOffset=10;break;case"center":case"mid":lateralOffset=0,forwardOffset=10;break;case"back":default:lateralOffset=-6,forwardOffset=8;break}target=ball.carrier.pos.c.scaleAndAdd(forward,forwardOffset).scaleAndAdd(lateral,lateralOffset)}else target=this.positionPos??this.pos;else if(ball.pos[1]>.1||ball.vel[1]>.1){const gravity=ball.gravity[1]??-9.8,vy=ball.vel[1],y=ball.pos[1],a=.5*gravity,b=vy,c=y;let tGround=0;const discriminant=b*b-4*a*c;if(discriminant>=0&&Math.abs(a)>1e-5){const sqrtD=Math.sqrt(discriminant),t1=(-b+sqrtD)/(2*a),t2=(-b-sqrtD)/(2*a);tGround=Math.max(t1,t2)}const predicted=ball.pos.c.scaleAndAdd(ball.vel,tGround);predicted[1]=0,predicted.dist(this.pos)<=35?target=predicted:target=this.positionPos??this.pos}else ball.pos.dist(this.pos)<=25&&game.chasers<3?(target=ball.pos,game.chasers++):target=this.positionPos??this.pos;if(target===this.positionPos&&this.positionPos.dist(this.pos)<=1&&(newActionState="idle",this.actionState!=="idle"&&(this.stateTimer=0),this.jogVel.setFrom(0,0,0),this.joltVel.setFrom(0,0,0)),target===null&&newActionState===null&&(target=goals[this.team]),target&&newActionState!=="idle"){const dir=target.c.sub(this.pos).zeroY().normalize();if(dir.len()>1e-4){this.joltVel.copyFrom(dir).scale(this.joltSpeed);const jogDirDelta=this.jogVel.c.normalize();this.jogVel.len()>1e-4?(jogDirDelta.lerp(dir,10*dt).normalize(),this.jogVel.copyFrom(jogDirDelta).scale(this.jogSpeed)):this.jogVel.copyFrom(dir).scale(this.jogSpeed)}}if(this.energy>0&&this.actionState!=="idle"?(this.vel.copyFrom(this.jogVel).add(this.joltVel),this.energy-=dt):(this.vel.copyFrom(this.jogVel).scaleAndAdd(this.joltVel,.5),this.energyRecovery+=dt,this.energyRecovery>=10&&(this.energy=10,this.energyRecovery=0)),this.joltVel.scale(Math.exp(-this.joltDecayRate*dt)),this.checkPlayerCollisions(dt,game),super.update(dt,game),newActionState===null&&(newActionState=this.tryTackle(game)),!ball.carried&&ball.collidesWith(this)&&newActionState===null){const isMark=ball.lastTouchedType==="kick"&&!ball.hasBounced&&ball.lastTouchedBy!==this&&ball.pos.dist(ball.origin)>=15;return ball.pickup(this),isMark?(game.setPiece=new MarkSetPiece(game,this,this.pos.c),newActionState="freeKick"):newActionState="pickup",this.team==="home"&&(game.player=this,this.aiming=!1),newActionState}return newActionState||(newActionState=this.vel.len()>1e-4?"run":"idle"),newActionState}collideBounds(){return[.8,1.8]}get stunned(){return this.actionState==="tackle"||this.actionState==="tackled"}tryTackle(game){const ball=game.ball;for(const other of game.players){if(other===this||!ball.carried||ball.carrier!==other||other.team===this.team||!this.collidesWith(other)||other.actionState==="tackleDisposal"||other.actionState==="freeKick")continue;const toTarget=other.pos.c.sub(this.pos);toTarget[1]=0,toTarget.normalize();const EPSILON2=1e-8,facing=this.jogVel.c;if(facing[1]=0,facing.len()<EPSILON2||facing.c.normalize().dot(toTarget)>.1)return this.stateTimer=1,other.actionState="tackleDisposal",other.stateTimer=.5,"tackle"}return null}updateHuman(dt,game){const controls=game.controls,ball=game.ball;let{kickPressed,kickReleased,kickHeldTime,moveX,moveZ,aimTarget}=controls.state;const EPSILON2=1e-4;let newActionState=null;if((moveX!==0||moveZ!==0)&&!this.aiming){const dir=v3(moveX,0,moveZ).normalize();if(v3(moveX,0,moveZ),dir.len()>EPSILON2){this.joltVel.copyFrom(dir).scale(this.joltSpeed);const jogDirDelta=this.jogVel.c.normalize();this.jogVel.len()>EPSILON2?(jogDirDelta.lerp(dir,10*dt).normalize(),this.jogVel.copyFrom(jogDirDelta).scale(this.jogSpeed)):this.jogVel.copyFrom(dir).scale(this.jogSpeed)}}if(this.energy>0?(this.vel.copyFrom(this.jogVel).add(this.joltVel),this.energy-=dt):(this.vel.copyFrom(this.jogVel).scaleAndAdd(this.joltVel,.5),this.energyRecovery+=dt,this.energyRecovery>=10&&(this.energy=10,this.energyRecovery=0)),this.joltVel.scale(Math.exp(-this.joltDecayRate*dt)),this.checkPlayerCollisions(dt,game),super.update(dt,game),ball.carried&&ball.carrier!==this&&kickPressed&&(newActionState=this.tryTackle(game)),!ball.carried&&ball.collidesWith(this)&&newActionState===null){const isMark=ball.lastTouchedType==="kick"&&!ball.hasBounced&&ball.lastTouchedBy!==this&&ball.pos.dist(ball.origin)>=15;return ball.pickup(this),isMark?(game.setPiece=new MarkSetPiece(game,this,this.pos.c),newActionState="freeKick"):newActionState="pickup",this.team==="home"&&(game.player=this,this.aiming=!1),newActionState}if(ball.carried&&ball.carrier===this&&newActionState===null){if(kickPressed&&(this.aiming=!0,this.jogVel.len()<1e-5)){const goalDir=v3(0,0,this.team==="home"?0:FIELD_LENGTH$1).sub(this.pos).normalize();this.jogVel.copyFrom(goalDir).scale(this.jogSpeed)}newActionState=this.tryDisposeBall(game,{kickReleased:controls.state.kickReleased,kickHeldTime:controls.state.kickHeldTime,aimTarget:controls.state.aimTarget,moveVec:moveX!==0||moveZ!==0?v3(moveX,0,moveZ):Vec3.fromArray(this.jogVel)}),ball.carried||(this.aiming=!1)}return this.updateAim(game),!newActionState&&this.actionState!=="run"&&this.actionState!=="idle"&&(newActionState=this.vel.len()>EPSILON2?"run":"idle"),newActionState}tryDisposeBall(game,input){const ball=game.ball;if(!ball.carried||ball.carrier!==this)return null;const{kickReleased,kickHeldTime}=input;let{aimTarget}=input;if(!kickReleased)return null;const isHandpass=kickHeldTime<.25;if(isHandpass){const moveVec=input.moveVec??this.jogVel.c;if(moveVec.len()===0){const forwardZ=this.team==="home"?-1:1;moveVec.setFrom(0,0,forwardZ)}moveVec.normalize;let bestTarget=null,bestScore=-1/0;for(const p of game.players){if(p.team!==this.team||p===this||p.stunned)continue;const toPlayer=p.pos.c.sub(this.pos),dist3=toPlayer.len();if(dist3>30)continue;const dirToPlayer=toPlayer.c.normalize(),alignment=moveVec.dot(dirToPlayer);if(alignment<=0)continue;let nearbyOpponents=0;for(const o of game.players){if(o.team===this.team||o===p||o.stunned)continue;o.pos.dist(p.pos)<=10&&nearbyOpponents++}const dangerPenalty=.5*nearbyOpponents,score=alignment*2-dist3/30-dangerPenalty;score>bestScore&&(bestScore=score,bestTarget=p)}if(bestTarget){const delta=bestTarget.pos.c.sub(this.pos);aimTarget=[delta[0],delta[2]]}else aimTarget=[moveVec[0]*10,moveVec[2]*10]}if(!aimTarget)return null;const aim=v2(aimTarget[0],aimTarget[1]),dist2=aim.len();if(dist2<.1)return null;const gravity=-this.gravity[1],angleRad=(isHandpass?20:30)*Math.PI/180,sin2θ=Math.sin(2*angleRad),speed=Math.sqrt(dist2*gravity/sin2θ),dirXZ=v3(aim[0],0,aim[1]).normalize(),aimDir=v3(dirXZ[0]*Math.cos(angleRad),Math.sin(angleRad),dirXZ[2]*Math.cos(angleRad));return ball.launch(aimDir,speed),ball.lastTouchedType=isHandpass?"handpass":"kick",ball.hasBounced=!1,this.stateTimer=.5,isHandpass?"handpass":"kick"}update(dt,game){this.oldPos=this.pos.c;let setPieceBlocked=!1;if(game.setPiece&&(setPieceBlocked=game.setPiece.enforce(this,dt)),game.ball.carried||(this.aiming=!1),!this.playing)return;if(this.actionState==="pickup"&&(this.actionState="run"),this.actionState==="freeKick"){this.stateTimer-=dt,this.stateTimer<=0?(this.actionState="idle",this.stateTimer=0,this.jogVel[0]=0,this.jogVel[2]=0,game.setPiece):(game.setPiece===null||game.controls.state.moveX!==0||game.controls.state.moveZ!==0)&&(this.actionState="idle",this.stateTimer=0),this.vel.copyFrom(this.jogVel),super.update(dt,game),this.updateAim(game),this.updateAnimation(dt,null,game.ball);return}if(this.actionState==="standingMark"){this.stateTimer-=dt,this.stateTimer<=0?(this.actionState="idle",this.stateTimer=0,this.jogVel[0]=0,this.jogVel[1]=0,game.setPiece):game.setPiece===null&&(this.actionState="idle",this.stateTimer=0),this.updateAim(game),this.updateAnimation(dt,null,game.ball);return}if(this.actionState==="tackleDisposal"){if(this.stateTimer-=dt,this.pos.scaleAndAdd(this.jogVel,dt),game.player===this&&game.controls.state.kickReleased&&(this.tryDisposeBall(game,game.controls.state),this.actionState="handpass",this.stateTimer=.5),game.player!==this){const t=.5-this.stateTimer,grace=.5+(this.statsStrength-50)*.01,chance=t/grace*(.5+(this.statsStrength-50)/100);Math.random()<chance*dt*2&&this.tryDisposeBall(game,{kickReleased:!0,kickHeldTime:.1,aimTarget:null,moveVec:v3(0,0,0)})}if(this.stateTimer<=0){const ball=game.ball;ball.carried=!1,ball.carrier=null,ball.pos.copyFrom(this.pos),ball.vel.copyFrom(this.vel.len()>.5?this.vel:v3(Math.random()*2-1,0,Math.random()*2-1).normalize().scale(this.jogSpeed+this.joltSpeed)),ball.lastTouchedType="spill",ball.hasBounced=!1,this.actionState="tackled",this.stateTimer=1}this.updateAim(game),this.updateAnimation(dt,null,game.ball);return}if(this.actionState==="tackled"||this.actionState==="tackle"||this.actionState==="kick"||this.actionState==="handpass"){this.actionState==="tackled"&&this.vel.scale(.8),this.stateTimer-=dt,this.stateTimer<=0&&(this.actionState="idle",this.stateTimer=0),this.aiming&&(this.aiming=!1),super.update(dt,game),this.updateAim(game),this.updateAnimation(dt,null,game.ball);return}let stateTriggered=null;setPieceBlocked||(game.player===this?stateTriggered=this.updateHuman(dt,game):stateTriggered=this.updateAI(dt,game)),this.updateAnimation(dt,stateTriggered,game.ball),stateTriggered!==null&&(this.actionState=stateTriggered)}updateAim(game){if(this===game.player){const aimTarget=game.controls.state.aimTarget;if(this.aiming){const aim=fromValues(0,0);aimTarget&&add(aim,aim,aimTarget),game.aimTarget.setPosition([this.pos[0]+aim[0],.02,this.pos[2]+aim[1]])}else game.player===this&&game.aimTarget.setPosition(v3(this.pos[0],.02,this.pos[2]+.8))}}updateAnimation(dt,stateTriggered,ball){const sequence=this.animations[this.animState];if(sequence.length===0)return;this.animTimer+=dt;const frameDuration=1/this.animFPS;this.animTimer>=frameDuration&&(this.animTimer-=frameDuration,this.animFrame=this.animFrame+1),stateTriggered==="kick"&&(this.animState="kickRightFoot",this.animFrame=0,this.animTimer=0),this.animState==="run"&&this.vel.len()===0&&(this.animState="idle",this.animFrame=0,this.animTimer=0),this.animState==="idle"&&this.vel.len()!==0&&(this.animState="run",this.animFrame=0,this.animTimer=0);const loop=this.animState==="run"||this.animState==="idle";this.animFrame>=sequence.length&&(this.animFrame=loop?0:sequence.length-1,loop||(this.animState="run",this.animFrame=0,this.animTimer=0));const uniformFrame=uniformAnimationSets.home.back.slice();uniformFrame[0]+=this.teamId,this.team==="away"&&(uniformFrame[1]+=2);const headFrame=personAnimationSets[this.complexion].back.slice();headFrame[0]+=this.faceId;const bodyFrame=bodyAnimationSets[this.animState][this.animFrame].slice()??[0,0,0];bodyFrame[1]+=personAnimationSets[this.complexion].bodyRowOffset,(this.vel[2]>0?"away":this.vel[2]<0?"home":this.pos[2]<ball.pos[2]?"away":"home")==="away"&&(bodyFrame[0]+=7,uniformFrame[1]-=1,headFrame[1]-=1),this.animSprite=[uniformFrame,headFrame,bodyFrame]}render(renderer){const zFudge=v3(0,.005,.01);let s=1;for(let[col,row,flags]of this.animSprite)renderer.renderSprite(this.pos.c.scaleAndAdd(zFudge,s),this.width,this.height,col,row),s++}renderOrig(renderer){const[col,row,flags]=this.animSprite;renderer.renderSprite(this.pos,this.width,this.height,col,row)}checkPlayerCollisions(dt,game){if(this.actionState!=="freeKick")for(const other of game.players){if(other===this||!other.playing||other.actionState==="freeKick")continue;const offset=this.pos.c.sub(other.pos);offset[1]=0;const len=offset.len(),r1=getEffectiveCollisionRadius(this),r2=getEffectiveCollisionRadius(other),overlap=(r1+r2)/2-len;if(overlap<=0)continue;len<1e-4?(offset[0]=Math.random()-.5,offset[2]=Math.random()-.5,offset.normalize()):offset.scale(1/len);const w1=this.statsWeight*getIntentWeightBias(this.intent),w2=other.statsWeight*getIntentWeightBias(other.intent),total=w1+w2,push=offset.c.scale(overlap),pushThis=push.c.scale(w2/total),pushOther=push.c.scale(w1/total);this.pos[0]+=pushThis[0],this.pos[2]+=pushThis[2],other.pos[0]-=pushOther[0],other.pos[2]-=pushOther[2]}}setupForBoundary(side,pos){side==="behindAway"&&this.team==="home"&&this.name==="FB"?(this.pos.setFrom(0,0,FIELD_LENGTH$1-5),this.jogVel.setFrom(0,0,0),this.joltVel.setFrom(0,0,0),this.actionState="idle",this.stateTimer=0):side==="behindAway"&&this.team==="away"&&this.name==="FF"?this.pos.setFrom(0,0,FIELD_LENGTH$1-25):side==="behindHome"&&this.team==="away"&&this.name==="FB"?(this.pos.setFrom(0,0,5),this.jogVel.setFrom(0,0,0),this.joltVel.setFrom(0,0,0),this.actionState="idle",this.stateTimer=0):side==="behindHome"&&this.team==="home"&&this.name==="FF"?this.pos.setFrom(0,0,25):this.pos.copyFrom(this.positionPos)}}class Ball extends Entity{constructor(pos){super(pos),this.carried=!1,this.origin=v3(0,0,0),this.carrier=null,this.width=1.6,this.height=2.4,this.bounce=.5,this.animations=Object.freeze({idle:[[0,1,0]],backSpin:[[1,1,0],[2,1,0],[3,1,0],[4,1,0],[5,1,0],[6,1,0],[7,1,0],[8,1,0]],forwardSpin:[[8,1,0],[7,1,0],[6,1,0],[5,1,0],[4,1,0],[3,1,0],[2,1,0],[1,1,0]],backSpinRight:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]],backSpinLeft:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinRight:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinLeft:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]]}),this.animState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=12,this.lastTouchedBy=null,this.lastTouchedType=null,this.hasBounced=!1}update(dt,game){if(this.carried&&this.carrier){const carrier=this.carrier,dirZ=carrier.vel[2]>0?1:carrier.vel[2]<0||carrier.team==="home"?-1:1,offset=v3(0,.5,.2*dirZ);this.pos.copyFrom(this.carrier.pos).add(offset),this.origin.copyFrom(this.pos)}else{const falling=this.vel[1]<0;super.update(dt,game),this.hasBounced=this.hasBounced||falling&&this.vel[1]>0&&this.pos[1]<=this.floorY,this.pos[1]<=this.floorY&&(this.vel.scale(.97),this.origin.copyFrom(this.pos))}this.updateAnimation(dt)}collideBounds(){return[.4,.5]}pickup(carrier){this.carried=!0,this.carrier=carrier,this.lastTouchedBy=carrier,this.lastTouchedType=null,this.hasBounced=!1,this.origin.copyFrom(this.pos);const dirZ=carrier.vel[2]>0?1:carrier.vel[2]<0||carrier.team==="home"?-1:1;this.pos.copyFrom(carrier.pos).add(v3(0,0,dirZ*.2)),this.vel.setFrom(0,0,0)}launch(direction,speed,type="kick"){this.carried=!1,this.carrier=null,this.vel.copyFrom(direction).scale(speed),this.lastTouchedType=type,this.hasBounced=!1}updateAnimation(dt){this.animTimer+=dt;const frameDuration=1/this.animFPS;this.animTimer>=frameDuration&&(this.animTimer-=frameDuration,this.animFrame=this.animFrame+1);const prevState=this.animState;this.carried?this.animState="idle":this.lastTouchedType==="kick"&&!this.hasBounced?this.animState=this.vel[2]<0?"backSpin":"forwardSpin":this.lastTouchedType==="handpass"&&!this.hasBounced?this.animState=this.vel[2]<0?"backSpinRight":"forwardSpinLeft":this.hasBounced?Math.abs(this.vel[1])<.05&&this.pos[1]<=this.floorY+.01?this.animState="idle":this.animState=this.vel[2]<0?"forwardSpin":"backSpin":this.animState="idle",this.animState!==prevState&&(this.animFrame=0,this.animTimer=0);const sequence=this.animations[this.animState];sequence.length!==0&&this.animFrame>=sequence.length&&(this.animFrame=0)}render(renderer){var _a;const sequence=(_a=this.animations)==null?void 0:_a[this.animState],[col,row,flags]=(sequence==null?void 0:sequence[this.animFrame])??[0,1,void 0];renderer.renderSprite(this.pos,this.width,this.height,col,row);{const gl=renderer.gl;gl.useProgram(renderer.program),gl.bindVertexArray(renderer.quadVao);const[col2,row2]=[2,3];renderer.setTileUV(col2,row2),gl.uniform1i(renderer.uTilingU,0),gl.uniform1i(renderer.uTilingV,0);const model=create$2();translate(model,model,[this.pos[0],.001,this.pos[2]]),rotateX(model,model,-Math.PI/2),scale(model,model,[2,2,1]),gl.uniformMatrix4fv(renderer.uModel,!1,model),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)}}setupForBoundary(side,pos){if(this.carried=!1,this.carrier=null,side==="goalAway"||side==="goalHome")this.pos.setFrom(0,0,FIELD_LENGTH$1/2),this.vel.setFrom(0,15,0),this.lastTouchedType="tap",this.lastTouchedBy=null,this.origin.copyFrom(this.pos);else if(side==="behindAway")this.pos.setFrom(0,0,FIELD_LENGTH$1-6);else if(side==="behindHome")this.pos.setFrom(0,0,6);else{this.pos.copyFrom(pos),this.pos.y=0;const dir=v3(0,FIELD_LENGTH$1/2,FIELD_LENGTH$1/2).toDir(this.pos);this.launch(dir,15,"tap")}}}class AimTarget{constructor(pos=[0,.001,0]){this.pos=Vec3.fromArray(pos),this.size=2,this.spriteCoord=[0,3]}setPosition(newPos){this.pos[0]=newPos[0],this.pos[2]=newPos[2]}render(renderer){const gl=renderer.gl;gl.useProgram(renderer.program),gl.bindVertexArray(renderer.quadVao);const[col,row]=this.spriteCoord;renderer.setTileUV(col,row),gl.uniform1i(renderer.uTilingU,0),gl.uniform1i(renderer.uTilingV,0);const model=create$2();translate(model,model,[this.pos[0],.02,this.pos[2]]),rotateX(model,model,-Math.PI/2),scale(model,model,[this.size,this.size,1]),gl.uniformMatrix4fv(renderer.uModel,!1,model),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)}}function createShaderProgram(gl,vsSource,fsSource){const compile=(src,type)=>{const shader=gl.createShader(type);if(!shader)throw new Error("Failed to create shader");if(gl.shaderSource(shader,src),gl.compileShader(shader),!gl.getShaderParameter(shader,gl.COMPILE_STATUS))throw new Error(gl.getShaderInfoLog(shader));return shader},vs=compile(vsSource,gl.VERTEX_SHADER),fs=compile(fsSource,gl.FRAGMENT_SHADER),program=gl.createProgram();if(gl.attachShader(program,vs),gl.attachShader(program,fs),gl.linkProgram(program),!gl.getProgramParameter(program,gl.LINK_STATUS))throw new Error(gl.getProgramInfoLog(program));return program}async function loadImage(url){const image=new Image;return image.src=url,await image.decode(),image}function createFieldEllipseMesh(radiusX,radiusZ,segments,tileScale=1){const uvRepeatX=radiusX*2/1.6/tileScale,uvRepeatZ=radiusZ*2/2/tileScale,vertices=[0,0,0,.5,.5],indices=[];for(let i=0;i<=segments;i++){const angle=i/segments*2*Math.PI,x=Math.cos(angle)*radiusX,z=Math.sin(angle)*radiusZ,u=x/(radiusX*2)*uvRepeatX+.5,v=z/(radiusZ*2)*uvRepeatZ+.5;vertices.push(x,0,z,u,v),i>0&&indices.push(0,i,i+1)}return{vertices:new Float32Array(vertices),indices:new Uint16Array(indices)}}function createFieldLineMesh(W=160,L=170,arcR=50,CS=50,thickness=.4){const verts=[],indices=[];let index=0;function pushLineStrip(x0List,z0List,x1List,z1List){const startIndex=index;for(let i=0;i<x0List.length;i++)verts.push(x0List[i],0,z0List[i]),verts.push(x1List[i],0,z1List[i]),index+=2;for(let i=0;i<x0List.length-1;i++){const i0=startIndex+i*2,i1=i0+1,i2=i0+2,i3=i0+3;indices.push(i0,i1,i2,i2,i1,i3)}}function lineSegment(x0,z0,x1,z1,thickness2){const dx=x1-x0,dz=z1-z0,len=Math.hypot(dx,dz),nx=-dz/len,nz=dx/len,t=thickness2/2,x0a=x0+nx*t,z0a=z0+nz*t,x0b=x0-nx*t,z0b=z0-nz*t,x1a=x1+nx*t,z1a=z1+nz*t,x1b=x1-nx*t,z1b=z1-nz*t;pushLineStrip([x0a,x1a],[z0a,z1a],[x0b,x1b],[z0b,z1b])}function ringSegment(cx,cz,r,thickness2,steps){const r0=r-thickness2/2,r1=r+thickness2/2,x0s=[],z0s=[],x1s=[],z1s=[];for(let i=0;i<=steps;i++){const a2=i/steps*2*Math.PI;x0s.push(cx+Math.cos(a2)*r0),z0s.push(cz+Math.sin(a2)*r0),x1s.push(cx+Math.cos(a2)*r1),z1s.push(cz+Math.sin(a2)*r1)}pushLineStrip(x0s,z0s,x1s,z1s)}const a=W/2,b=L/2;{const x0s=[],z0s=[],x1s=[],z1s=[];for(let i=0;i<=64;i++){const theta=i/64*2*Math.PI,x=Math.cos(theta),z=Math.sin(theta);x0s.push(x*(a-thickness/2)),z0s.push(z*(b-thickness/2)),x1s.push(x*(a+thickness/2)),z1s.push(z*(b+thickness/2))}pushLineStrip(x0s,z0s,x1s,z1s)}const pts=[[-CS/2,-CS/2],[CS/2,-CS/2],[CS/2,CS/2],[-CS/2,CS/2]];for(let i=0;i<4;i++){const[x0,z0]=pts[i],[x1,z1]=pts[(i+1)%4];lineSegment(x0,z0,x1,z1,thickness)}function findValidArcAngles(goalZ){const towardCenter=goalZ>0?-1:1,validAngles=[];for(let i=0;i<=1e3;i++){const theta=-Math.PI+i/1e3*2*Math.PI,x=Math.sin(theta)*arcR,z=goalZ+towardCenter*Math.cos(theta)*arcR,normX=x/a,normZ=z/b;normX*normX+normZ*normZ<=1&&validAngles.push(theta)}return validAngles.length===0?[-Math.PI/3,Math.PI/3]:[validAngles[0],validAngles[validAngles.length-1]]}for(let goalZ of[-L/2,L/2]){const towardCenter=goalZ>0?-1:1,[thetaStart,thetaEnd]=findValidArcAngles(goalZ),arcSteps=40,r0=arcR-thickness/2,r1=arcR+thickness/2,x0s=[],z0s=[],x1s=[],z1s=[];for(let i=0;i<=arcSteps;i++){const t=thetaStart+i/arcSteps*(thetaEnd-thetaStart),xInner=Math.sin(t)*r0,zInner=goalZ+towardCenter*Math.cos(t)*r0,xOuter=Math.sin(t)*r1,zOuter=goalZ+towardCenter*Math.cos(t)*r1;x0s.push(xInner),z0s.push(zInner),x1s.push(xOuter),z1s.push(zOuter)}pushLineStrip(x0s,z0s,x1s,z1s)}const GS_W=6.4,GS_L=9;for(let zSign of[-1,1]){const z=zSign*(L/2),z0=z,z1=z-zSign*GS_L,x0=-GS_W/2,x1=GS_W/2;lineSegment(x0,z0,x1,z0,thickness),lineSegment(x1,z0,x1,z1,thickness),lineSegment(x1,z1,x0,z1,thickness),lineSegment(x0,z1,x0,z0,thickness)}return ringSegment(0,0,3,thickness,48),ringSegment(0,0,10,thickness,64),lineSegment(-10,0,10,0,thickness),{vertices:new Float32Array(verts),indices:new Uint16Array(indices)}}function createFenceMesh(radiusX,radiusZ,offset=3.5,segments=128){const verts=[],indices=[],rX=radiusX+offset,rZ=radiusZ+offset,height=2.4,uScale=1/2;for(let i=0;i<=segments;i++){const theta=i/segments*2*Math.PI,x=Math.cos(theta)*rX,z=Math.sin(theta)*rZ,u=i*uScale;verts.push(x,0,z,u,1),verts.push(x,height,z,u,0)}for(let i=0;i<segments;i++){const base=i*2;indices.push(base,base+1,base+2),indices.push(base+2,base+1,base+3)}return{fenceVertices:new Float32Array(verts),fenceIndices:new Uint16Array(indices)}}function createStadiumMesh(rx0,rz0,rx1,rz1,h0,h1,segments=64){const verts=[],indices=[],avgRadius=(rx0+rz0+rx1+rz1)/4,uPerSegment=2*Math.PI*avgRadius/segments/3.2,vMax=Math.abs(h1-h0)/4.8;for(let i=0;i<=segments;i++){const theta=i/segments*2*Math.PI,cos=Math.cos(theta),sin=Math.sin(theta),x0=cos*rx0,z0=sin*rz0,x1=cos*rx1,z1=sin*rz1,u=i*uPerSegment;verts.push(x0,h0,z0,u,vMax),verts.push(x1,h1,z1,u,0)}for(let i=0;i<segments;i++){const base=i*2;indices.push(base,base+1,base+2),indices.push(base+2,base+1,base+3)}return{vertices:new Float32Array(verts),indices:new Uint16Array(indices)}}function createEllipticalStadiumRoofMesh(rx0,rz0,rx1,rz1,h1,segments=64){const verts=[],indices=[],h2=h1+5,h3=h2+4,rxMid=.5*(rx0+rx1),rzMid=.5*(rz0+rz1),rxInner=rxMid,rzInner=rzMid,tileU=3.2,tileV=4.8,avgRadius=.5*(rx1+rz1),uPerSegment=2*Math.PI*avgRadius/segments/tileU,vSlope=(h2-h1)/tileV,vDome=(h3-h2)/tileV;for(let i=0;i<=segments;i++){const theta=i/segments*2*Math.PI,cos=Math.cos(theta),sin=Math.sin(theta),u=i*uPerSegment,x1=cos*rx1,z1=sin*rz1,x2=cos*rxMid,z2=sin*rzMid,x3=cos*rxInner,z3=sin*rzInner;verts.push(x1,h1,z1,u,vSlope+vDome),verts.push(x2,h2,z2,u,vDome),verts.push(x3,h3,z3,u,0)}for(let i=0;i<segments;i++){const b=i*3;indices.push(b,b+1,b+3),indices.push(b+3,b+1,b+4),indices.push(b+1,b+2,b+4),indices.push(b+4,b+2,b+5)}return{vertices:new Float32Array(verts),indices:new Uint16Array(indices)}}function createAimTrajectoryMesh(start,velocity,gravity=-9.8,segments=32,width=.5){const verts=[],indices=[],y0=start[1],vy=velocity[1],g=gravity,disc=vy*vy-2*g*y0;if(disc<0)return{vertices:new Float32Array,indices:new Uint16Array};const t_flight=(-vy-Math.sqrt(disc))/g,dt=t_flight/segments,horizVel=[velocity[0],velocity[2]],horizLen=Math.hypot(...horizVel),nx=-horizVel[1]/horizLen,nz=horizVel[0]/horizLen;for(let i=0;i<=segments;i++){const t=i*dt,x=start[0]+velocity[0]*t,y=start[1]+velocity[1]*t+.5*g*t*t,z=start[2]+velocity[2]*t,taper=.2+.8*(t/t_flight),dynamicHalfW=width/2*taper,xL=x+nx*dynamicHalfW,zL=z+nz*dynamicHalfW,xR=x-nx*dynamicHalfW,zR=z-nz*dynamicHalfW;verts.push(xL,y,zL),verts.push(xR,y,zR)}const vertCount=verts.length/3;for(let i=0;i<vertCount-2;i+=2)indices.push(i,i+1,i+2),indices.push(i+2,i+1,i+3);return{vertices:new Float32Array(verts),indices:new Uint16Array(indices)}}function computeKickVelocity(player,aimTarget,isHandpass=!1){const gravity=-player.gravity[1],angleRad=(isHandpass?20:30)*Math.PI/180,aim=v3(aimTarget[0],0,aimTarget[1]),dist2=aim.len();if(dist2<.1)return null;const sin2θ=Math.sin(2*angleRad),speed=Math.sqrt(dist2*gravity/sin2θ),dirXZ=aim.c.normalize();return v3(dirXZ[0]*Math.cos(angleRad),Math.sin(angleRad),dirXZ[2]*Math.cos(angleRad)).scale(speed)}const vertexSrc=`#version 300 es
    in vec3 a_position;
    in vec2 a_texcoord;
    uniform mat4 u_projection, u_view, u_model;
    out vec2 v_texcoord;
    void main() {
        gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
        v_texcoord = a_texcoord;
    }
`,fragSrc=`#version 300 es
precision mediump float;

uniform sampler2D u_texture;
uniform vec4 u_tileUV;
uniform bool u_tilingU;
uniform bool u_tilingV;

in vec2 v_texcoord;
out vec4 outColor;

void main() {
    vec2 tileUV = v_texcoord;

    if (u_tilingU) tileUV.x = fract(tileUV.x);
    if (u_tilingV) tileUV.y = fract(tileUV.y);

    vec2 texCoord = mix(u_tileUV.xy, u_tileUV.zw, tileUV);

    vec2 texelSize = 1.0 / vec2(textureSize(u_texture, 0));
    vec2 epsilon = 0.5 * texelSize;
    texCoord = clamp(texCoord, u_tileUV.xy + epsilon, u_tileUV.zw - epsilon);

    vec4 texColor = texture(u_texture, texCoord);
    if (texColor.a < 0.01) discard;

    outColor = texColor;
}
`,lineVertSrc=`#version 300 es
    in vec3 a_position;
    uniform mat4 u_projection;
    uniform mat4 u_view;
    uniform mat4 u_model;
    void main() {
        gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
    }`,lineFragSrc=`#version 300 es
    precision mediump float;
    uniform vec4 u_color;
    out vec4 out_color;
    void main() {
        out_color = u_color;
    }
`,SPRITE_WIDTH=16,SPRITE_HEIGHT=24,SHEET_WIDTH=512,SHEET_HEIGHT=768,SPRITE_PAD_X=0,SPRITE_PAD_Y=0,STRIDE_WIDTH=SPRITE_WIDTH+SPRITE_PAD_X,STRIDE_HEIGHT=SPRITE_HEIGHT+SPRITE_PAD_Y,FIELD_LENGTH=170,FIELD_RADIUS_X=80,FIELD_RADIUS_Z=FIELD_LENGTH/2;class Renderer{constructor(gl,canvas,spriteSheet){this.gl=gl,this.canvas=canvas,this.spriteSheet=spriteSheet,this.sheetCols=32,this.sheetRows=32,this.program=createShaderProgram(gl,vertexSrc,fragSrc),this.uProjection=gl.getUniformLocation(this.program,"u_projection"),this.uView=gl.getUniformLocation(this.program,"u_view"),this.uModel=gl.getUniformLocation(this.program,"u_model"),this.uTileUV=gl.getUniformLocation(this.program,"u_tileUV"),this.uTilingU=gl.getUniformLocation(this.program,"u_tilingU"),this.uTilingV=gl.getUniformLocation(this.program,"u_tilingV"),this.uTexture=gl.getUniformLocation(this.program,"u_texture"),this.aPos=gl.getAttribLocation(this.program,"a_position"),this.aUV=gl.getAttribLocation(this.program,"a_texcoord"),this.lineProgram=createShaderProgram(gl,lineVertSrc,lineFragSrc),this.lineProj=gl.getUniformLocation(this.lineProgram,"u_projection"),this.lineView=gl.getUniformLocation(this.lineProgram,"u_view"),this.lineModel=gl.getUniformLocation(this.lineProgram,"u_model"),this.linePos=gl.getAttribLocation(this.lineProgram,"a_position"),this.uLineColor=gl.getUniformLocation(this.lineProgram,"u_color"),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!0);const verts=new Float32Array([-.5,0,0,1,.5,0,1,1,.5,1,1,0,-.5,1,0,0]),indicesSprite=new Uint16Array([0,1,2,0,2,3]);this.quadVao=gl.createVertexArray(),gl.bindVertexArray(this.quadVao);const vboSprite=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vboSprite),gl.bufferData(gl.ARRAY_BUFFER,verts,gl.STATIC_DRAW),gl.vertexAttribPointer(this.aPos,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(this.aPos),gl.vertexAttribPointer(this.aUV,2,gl.FLOAT,!1,16,8),gl.enableVertexAttribArray(this.aUV);const eboSprite=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,eboSprite),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,indicesSprite,gl.STATIC_DRAW);const{vertices,indices}=createFieldEllipseMesh(FIELD_RADIUS_X,FIELD_RADIUS_Z,64,16);this.fieldVao=gl.createVertexArray(),gl.bindVertexArray(this.fieldVao);const vboField=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vboField),gl.bufferData(gl.ARRAY_BUFFER,vertices,gl.STATIC_DRAW),gl.vertexAttribPointer(this.aPos,3,gl.FLOAT,!1,20,0),gl.enableVertexAttribArray(this.aPos),gl.vertexAttribPointer(this.aUV,2,gl.FLOAT,!1,20,12),gl.enableVertexAttribArray(this.aUV);const eboField=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,eboField),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,indices,gl.STATIC_DRAW),this.fieldIndices=indices.length,this.fieldLineMesh=createFieldLineMesh(),this.lineVao=gl.createVertexArray(),gl.bindVertexArray(this.lineVao);const vboLine=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vboLine),gl.bufferData(gl.ARRAY_BUFFER,this.fieldLineMesh.vertices,gl.STATIC_DRAW);const eboLine=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,eboLine),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.fieldLineMesh.indices,gl.STATIC_DRAW),gl.vertexAttribPointer(this.linePos,3,gl.FLOAT,!1,12,0),gl.enableVertexAttribArray(this.linePos);const GOAL_WIDTH2=6.8;this.goalPostPositions=[[-3*GOAL_WIDTH2/2,0,FIELD_LENGTH],[-GOAL_WIDTH2/2,0,FIELD_LENGTH],[GOAL_WIDTH2/2,0,FIELD_LENGTH],[3*GOAL_WIDTH2/2,0,FIELD_LENGTH],[-3*GOAL_WIDTH2/2,0,0],[-GOAL_WIDTH2/2,0,0],[GOAL_WIDTH2/2,0,0],[3*GOAL_WIDTH2/2,0,0]];const{fenceVertices,fenceIndices}=createFenceMesh(FIELD_RADIUS_X,FIELD_RADIUS_Z);this.fenceVao=gl.createVertexArray(),gl.bindVertexArray(this.fenceVao);const vbo=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vbo),gl.bufferData(gl.ARRAY_BUFFER,fenceVertices,gl.STATIC_DRAW),gl.vertexAttribPointer(this.aPos,3,gl.FLOAT,!1,20,0),gl.enableVertexAttribArray(this.aPos),gl.vertexAttribPointer(this.aUV,2,gl.FLOAT,!1,20,12),gl.enableVertexAttribArray(this.aUV);const ebo=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,ebo),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,fenceIndices,gl.STATIC_DRAW),this.fenceIndices=fenceIndices.length;const radiusFenceX=FIELD_RADIUS_X+3.5,radiusFenceZ=FIELD_RADIUS_Z+3.5,stadiumMesh=createStadiumMesh(radiusFenceX+.5,radiusFenceZ+.5,radiusFenceX+30,radiusFenceZ+30,0,20);this.stadiumVao=gl.createVertexArray(),gl.bindVertexArray(this.stadiumVao);const vboStadium=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vboStadium),gl.bufferData(gl.ARRAY_BUFFER,stadiumMesh.vertices,gl.STATIC_DRAW),gl.vertexAttribPointer(this.aPos,3,gl.FLOAT,!1,20,0),gl.enableVertexAttribArray(this.aPos),gl.vertexAttribPointer(this.aUV,2,gl.FLOAT,!1,20,12),gl.enableVertexAttribArray(this.aUV);const eboStadium=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,eboStadium),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,stadiumMesh.indices,gl.STATIC_DRAW),this.stadiumIndices=stadiumMesh.indices.length;const roofMesh=createEllipticalStadiumRoofMesh(radiusFenceX+.5,radiusFenceZ+.5,radiusFenceX+30,radiusFenceZ+30,20);this.stadiumRoofVao=gl.createVertexArray(),gl.bindVertexArray(this.stadiumRoofVao);const vboRoof=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vboRoof),gl.bufferData(gl.ARRAY_BUFFER,roofMesh.vertices,gl.STATIC_DRAW),gl.vertexAttribPointer(this.aPos,3,gl.FLOAT,!1,20,0),gl.enableVertexAttribArray(this.aPos),gl.vertexAttribPointer(this.aUV,2,gl.FLOAT,!1,20,12),gl.enableVertexAttribArray(this.aUV);const eboRoof=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,eboRoof),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,roofMesh.indices,gl.STATIC_DRAW),this.stadiumRoofIndices=roofMesh.indices.length,gl.bindVertexArray(null),this.trajVao=gl.createVertexArray(),this.trajVbo=gl.createBuffer(),this.trajEbo=gl.createBuffer();const maxPoints=128;gl.bindVertexArray(this.trajVao),gl.bindBuffer(gl.ARRAY_BUFFER,this.trajVbo);const maxVertices=maxPoints*2;gl.bufferData(gl.ARRAY_BUFFER,maxVertices*12,gl.DYNAMIC_DRAW),gl.vertexAttribPointer(this.linePos,3,gl.FLOAT,!1,12,0),gl.enableVertexAttribArray(this.linePos),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.trajEbo),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,6*(maxPoints-1)*Uint16Array.BYTES_PER_ELEMENT,gl.DYNAMIC_DRAW),gl.pixelStorei(gl.UNPACK_ALIGNMENT,1),gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1),this.texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,this.texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this.spriteSheet),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,this.texture),gl.enable(gl.DEPTH_TEST),gl.depthFunc(gl.LEQUAL),this.fovy=45*Math.PI/180,this.projection=create$2(),this.view=create$2(),this.model=create$2(),this.updateProjection()}updateProjection(){this.projection=create$2(),perspective(this.projection,this.fovy,this.canvas.width/this.canvas.height,.1,1e3)}renderSprite(pos,width,height,col,row){const{gl,program,quadVao,uModel,uTileUV,sheetCols,sheetRows}=this;gl.useProgram(program),gl.bindVertexArray(quadVao);const model=create$2();translate(model,model,pos),scale(model,model,[width,height,1]),gl.uniformMatrix4fv(uModel,!1,model),this.setTileUV(col,row),gl.uniform1i(this.uTilingU,0),gl.uniform1i(this.uTilingV,0),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)}setTileUV(col,row,tileWidthPx=SPRITE_WIDTH,tileHeightPx=SPRITE_HEIGHT){const u0=(col*STRIDE_WIDTH+SPRITE_PAD_X/2)/SHEET_WIDTH,v0=(row*STRIDE_HEIGHT+SPRITE_PAD_Y/2)/SHEET_HEIGHT,u1=(col*STRIDE_WIDTH+SPRITE_PAD_X/2+tileWidthPx)/SHEET_WIDTH,v1=(row*STRIDE_HEIGHT+SPRITE_PAD_Y/2+tileHeightPx)/SHEET_HEIGHT;this.gl.uniform4f(this.uTileUV,u0,v0,u1,v1)}getApproxVisibleFieldWidthAtZ(cameraPos,zWorld){const aspect=this.canvas.width/this.canvas.height,fov=Math.PI/4;return 2*(cameraPos[2]-zWorld)*Math.tan(fov/2)*aspect}renderScene(game,entities){const gl=this.gl;gl.viewport(0,0,this.canvas.width,this.canvas.height),gl.clearColor(.2,.6,.2,1),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),lookAt(this.view,game.cameraPos,game.cameraTarget,[0,1,0]),gl.useProgram(this.program),gl.uniformMatrix4fv(this.uProjection,!1,this.projection),gl.uniformMatrix4fv(this.uView,!1,this.view),gl.activeTexture(gl.TEXTURE0),gl.uniform1i(this.uTexture,0),gl.bindVertexArray(this.fieldVao),identity(this.model),translate(this.model,this.model,[0,0,FIELD_RADIUS_Z]),gl.uniformMatrix4fv(this.uModel,!1,this.model),this.setTileUV(0,2),gl.uniform1i(this.uTilingU,1),gl.uniform1i(this.uTilingV,1),gl.drawElements(gl.TRIANGLES,this.fieldIndices,gl.UNSIGNED_SHORT,0),gl.enable(gl.CULL_FACE),gl.cullFace(gl.FRONT),gl.frontFace(gl.CCW),gl.uniformMatrix4fv(this.uModel,!1,this.model),gl.bindVertexArray(this.stadiumVao),this.setTileUV(7,2),gl.uniform1i(this.uTilingU,1),gl.uniform1i(this.uTilingV,1),gl.drawElements(gl.TRIANGLES,this.stadiumIndices,gl.UNSIGNED_SHORT,0),this.setTileUV(8,2),gl.uniform1i(this.uTilingU,1),gl.uniform1i(this.uTilingV,1),gl.bindVertexArray(this.stadiumRoofVao),gl.drawElements(gl.TRIANGLES,this.stadiumRoofIndices,gl.UNSIGNED_SHORT,0),gl.disable(gl.CULL_FACE),gl.bindVertexArray(this.fenceVao),this.setTileUV(3,2,48,24),gl.uniform1i(this.uTilingU,1),gl.uniform1i(this.uTilingV,0),gl.drawElements(gl.TRIANGLES,this.fenceIndices,gl.UNSIGNED_SHORT,0),gl.useProgram(this.lineProgram),gl.uniform4f(this.uLineColor,1,1,1,1),gl.uniformMatrix4fv(this.lineProj,!1,this.projection),gl.uniformMatrix4fv(this.lineView,!1,this.view);const model=create$2();translate(model,this.model,[0,.01,0]),gl.uniformMatrix4fv(this.lineModel,!1,model),gl.bindVertexArray(this.lineVao),gl.drawElements(gl.TRIANGLES,this.fieldLineMesh.indices.length,gl.UNSIGNED_SHORT,0),gl.useProgram(this.program),gl.bindVertexArray(this.quadVao),this.setTileUV(1,2),gl.uniform1i(this.uTilingU,0),gl.uniform1i(this.uTilingV,1);for(let i=0;i<this.goalPostPositions.length;i++){const[x,y,z]=this.goalPostPositions[i],baseHeight=i%4===0||i%4===3?6:10,dx=game.cameraPos[0]-x,dz=game.cameraPos[2]-z,dist2=Math.sqrt(dx*dx+dz*dz),scaleLOD=dist2>50?1.5:dist2>150?2:1,postModel=create$2();translate(postModel,postModel,[x,y,z]),scale(postModel,postModel,[scaleLOD,baseHeight,1]),gl.uniformMatrix4fv(this.uModel,!1,postModel),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)}gl.bindVertexArray(this.quadVao);for(const entity of entities)entity instanceof Entity&&entity.render(this);const aimTarget=game.controls.getState().aimTarget;if(game.player&&game.player.aiming&&aimTarget!==null){game.aimTarget.render(this);const vel=computeKickVelocity(game.player,aimTarget,!1);if(!vel)return;const pos=game.player.pos.c,mesh=createAimTrajectoryMesh(pos,vel,-9.8,32);gl.useProgram(this.lineProgram),gl.uniform4f(this.uLineColor,1,1,1,.1),gl.uniformMatrix4fv(this.lineProj,!1,this.projection),gl.uniformMatrix4fv(this.lineView,!1,this.view);const model2=create$2();translate(model2,model2,[0,.01,0]),gl.uniformMatrix4fv(this.lineModel,!1,model2),gl.bindVertexArray(this.trajVao),gl.bindBuffer(gl.ARRAY_BUFFER,this.trajVbo),gl.bufferSubData(gl.ARRAY_BUFFER,0,mesh.vertices),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.trajEbo),gl.bufferSubData(gl.ELEMENT_ARRAY_BUFFER,0,mesh.indices),gl.drawElements(gl.TRIANGLES,mesh.indices.length,gl.UNSIGNED_SHORT,0)}}}var _InputManager_instances,onTouchStart_fn,onTouchMove_fn,onTouchEnd_fn;class InputManager{constructor(canvas){__privateAdd(this,_InputManager_instances);this.state={moveX:0,moveZ:0,kickPressed:!1,kickReleased:!1,menuPressed:!1,kickHeldTime:0,aimTarget:null},this.keys={},this.lastKeys={},this.touchMove=null,this.touchAim=null,this.gamepadAimActive=!1,this.kPressTime=0,canvas.addEventListener("touchstart",__privateMethod(this,_InputManager_instances,onTouchStart_fn).bind(this),{passive:!1}),canvas.addEventListener("touchmove",__privateMethod(this,_InputManager_instances,onTouchMove_fn).bind(this),{passive:!1}),canvas.addEventListener("touchend",__privateMethod(this,_InputManager_instances,onTouchEnd_fn).bind(this)),window.addEventListener("keydown",e=>this.keys[e.key.toLowerCase()]=!0),window.addEventListener("keyup",e=>this.keys[e.key.toLowerCase()]=!1)}endUpdate(){this.state.moveX=0,this.state.moveZ=0,this.state.kickPressed=!1,this.state.kickReleased=!1,this.state.menuPressed=!1}update(dt){var _a;const kDown=!!this.keys.k,kPrev=!!this.lastKeys.k;if(this.state.menuPressed=this.keys.escape&&!this.lastKeys.escape,kDown&&!kPrev&&(this.state.kickPressed=!0,this.kPressTime=0,this.state.aimTarget=[0,-10]),kDown?(this.kPressTime+=dt,this.state.aimTarget&&(this.keys.a&&(this.state.aimTarget[0]-=30*dt),this.keys.d&&(this.state.aimTarget[0]+=30*dt),this.keys.w&&(this.state.aimTarget[1]-=30*dt),this.keys.s&&(this.state.aimTarget[1]+=30*dt))):(this.keys.a&&(this.state.moveX-=1),this.keys.d&&(this.state.moveX+=1),this.keys.w&&(this.state.moveZ-=1),this.keys.s&&(this.state.moveZ+=1)),!kDown&&kPrev&&(this.state.kickReleased=!0),this.state.kickHeldTime=this.kPressTime,this.touchMove&&!this.touchAim&&(this.state.moveX=this.touchMove.dx/50,this.state.moveZ=this.touchMove.dy/50),this.touchAim){this.kPressTime+=dt;const dx=this.touchAim.dx,dz=this.touchAim.dy,mag=10;this.state.aimTarget=[-dx/mag,-dz/mag],this.state.kickHeldTime=this.kPressTime}const gp=(_a=navigator.getGamepads)==null?void 0:_a.call(navigator)[0];if(gp){this.state.moveX+=Math.abs(gp.axes[0])>.1?gp.axes[0]:0,this.state.moveZ+=Math.abs(gp.axes[1])>.1?gp.axes[1]:0;const aimX=gp.axes[2]||0,aimZ=gp.axes[3]||0,aimMag=Math.hypot(aimX,aimZ);this.gamepadAimActive?(this.kPressTime+=dt,this.state.kickHeldTime+=this.kPressTime,aimZ>.025?this.state.aimTarget&&(this.state.aimTarget=[this.state.aimTarget[0]-aimX/aimMag,this.state.aimTarget[1]-aimZ/aimMag]):(this.state.kickReleased=!0,this.gamepadAimActive=!1)):aimZ>.025&&(this.state.aimTarget=[0,-10],this.state.kickHeldTime=this.kPressTime,this.state.kickPressed=!0,this.gamepadAimActive=!0)}this.lastKeys={...this.keys}}getState(){return this.state}}_InputManager_instances=new WeakSet,onTouchStart_fn=function(e){e.preventDefault();for(const t of e.changedTouches)t.clientX<window.innerWidth/2?this.touchMove={id:t.identifier,startX:t.clientX,startY:t.clientY,dx:0,dy:0}:(this.touchAim={id:t.identifier,startX:t.clientX,startY:t.clientY,dx:0,dy:0},this.state.kickPressed=!0,this.kPressTime=0)},onTouchMove_fn=function(e){e.preventDefault();for(const t of e.changedTouches)this.touchMove&&t.identifier===this.touchMove.id&&(this.touchMove.dx=t.clientX-this.touchMove.startX,this.touchMove.dy=t.clientY-this.touchMove.startY),this.touchAim&&t.identifier===this.touchAim.id&&(this.touchAim.dx=t.clientX-this.touchAim.startX,this.touchAim.dy=t.clientY-this.touchAim.startY)},onTouchEnd_fn=function(e){e.preventDefault();for(const t of e.changedTouches)this.touchAim&&t.identifier===this.touchAim.id&&(this.touchAim=null,this.state.kickReleased=!0),this.touchMove&&t.identifier===this.touchMove.id&&(this.touchMove=null)};class Vec22 extends Array{constructor(vec=[0,0]){super(),this[0]=vec[0],this[1]=vec[1]}equals(vec){return this.length===vec.length&&this[0]===vec[0]&&this[1]===vec[1]}static random(vec){return new Vec22(getRandomPos(vec[0],vec[1]))}add(vec){return new Vec22([this[0]+vec[0],this[1]+vec[1]])}sub(vec){return new Vec22([this[0]-vec[0],this[1]-vec[1]])}floor(){return new Vec22([Math.floor(this[0]),Math.floor(this[1])])}ceil(){return new Vec22([Math.floor(this[0]),Math.floor(this[1])])}scale(scalar){return new Vec22([this[0]*scalar,this[1]*scalar])}mul(vec){return new Vec22([this[0]*vec[0],this[1]*vec[1]])}div(vec){return new Vec22([this[0]/vec[0],this[1]/vec[1]])}dot(vec){return this[0]*vec[0]+this[1]*vec[1]}dist(vec){return Math.hypot(this[0]-vec[0],this[1]-vec[1])}abs(){return new Vec22([Math.abs(this[0]),Math.abs(this[1])])}sum(){return this[0]+this[1]}relativeTo(rect){return this.sub(rect.pos).div(rect.size)}absoluteFrom(rect){return this.mul(rect.size).add(rect.pos)}relativeToPS(pos,sz){return this.sub(pos).scale(1/sz)}absoluteFromPS(pos,sz){return this.scale(sz).add(pos)}set x(val){this[0]=val}set y(val){this[1]=val}get x(){return this[0]}get y(){return this[1]}}class Rect extends Array{constructor(rect=null){if(super(),rect===null){this[0]=0,this[1]=0,this[2]=0,this[3]=0;return}this[0]=rect[0],this[1]=rect[1],this[2]=rect[2],this[3]=rect[3]}set x(val){this[0]=val}set y(val){this[1]=val}set w(val){this[2]=val}set h(val){this[3]=val}set pos(vec){this[0]=vec[0],this[1]=vec[1]}set size(vec){this[2]=vec[0],this[3]=vec[1]}get size(){return new Vec22([this[2],this[3]])}get pos(){return new Vec22([this[0],this[1]])}get x(){return this[0]}get y(){return this[1]}get w(){return this[2]}get h(){return this[3]}get right(){return this[0]+this[2]}get bottom(){return this[1]+this[3]}get center_x(){return this[0]+this[2]/2}get center_y(){return this[1]+this[3]/2}get center(){return new Vec22([this.center_x,this.center_y])}grow(amount){return new Rect([this[0]-amount,this[1]-amount,this[2]+2*amount,this[3]+2*amount])}get flooredCenter(){return new Vec22([Math.floor(this[0]+this[2]/2),Math.floor(this[1]+this[3]/2)])}translate(pos){return new Rect([this.x+pos[0],this.y+pos[1],this.w,this.h])}shrinkBorders(value){return new Rect([this.x+value,this.y+value,this.w-value*2,this.h-value*2])}scaleBorders(scale2){return new Rect([this.x+this.w*(1-scale2)/2,this.y+this.h*(1-scale2)/2,this.w*scale2,this.h*scale2])}mult(scalar){return new Rect([this[0]*scalar,this[1]*scalar,this[2]*scalar,this[3]*scalar])}multXY(vec){return new Rect([this[0]*vec[0],this[1]*vec[1],this[2]*vec[0],this[3]*vec[1]])}scale(scalar,centered=!0){if(centered){let news=[this[2]*scalar,this[3]*scalar];return new Rect([this[0]+.5*(this[2]-news[0]),this[1]+.5*(this[3]-news[1]),news[0],news[1]])}else{let news=[this[2]*scalar,this[3]*scalar];return new Rect([this[0],this[1],news[0],news[1]])}}collideRadius(rect,radius=null){let d=[this.center_x-rect.center_x,this.center_y-rect.center_y];return radius===null&&(radius=Math.min(this.w,this.h,rect.w,rect.h)/2),d[0]*d[0]+d[1]*d[1]<radius*radius}collide(rect){return this.x<rect.x+rect.w&&this.x+this.w>rect.x&&this.y<rect.y+rect.h&&this.h+this.y>rect.y}contains(rect){return this.x<=rect.x&&this.y<=rect.y&&this.x+this.w>=rect.x+rect.w&&this.y+this.h>=rect.y+rect.h}contact(rect){return this.x<=rect.x+rect.w&&this.x+this.w>=rect.x&&this.y<=rect.y+rect.h&&this.h+this.y>=rect.y}contactRadius(rect,radius=null){let d=[this.center_x-rect.center_x,this.center_y-rect.center_y];return radius===null&&(radius=Math.min(this.w,this.h,rect.w,rect.h)),d[0]*d[0]+d[1]*d[1]<=radius*radius}}class Grid2D extends Array{constructor(tileDim=[0,0],initialData=void 0){initialData===void 0?super(tileDim[0]*tileDim[1]):super(...initialData),this.tileDim=new Vec22(tileDim),this.hidden=!1,this._cacheData=null}clone(){return new Grid2D(this.tileDim,this)}get(pos){return this[pos[0]+pos[1]*this.tileDim[0]]}set(pos,val){this[pos[0]+pos[1]*this.tileDim[0]]=val}*iterBetween(pos1,pos2,tol=0){var x1,y1,x2,y2;if([x1,y1]=pos1,[x2,y2]=pos2,!(Math.abs(y2-y1)==0&&Math.abs(x2-x1)==0))if(Math.abs(y2-y1)>Math.abs(x2-x1)){var slope=(x2-x1)/(y2-y1);if(y1>y2)for(var y=y1;y>=y2;y--){var xa=x1+(y-y1)*slope;yield[xa,y]}else for(var y=y1;y<=y2;y++){var xa=x1+(y-y1)*slope;yield[xa,y]}}else{var slope=(y2-y1)/(x2-x1);if(x1>x2)for(var x=x1;x>=x2;x--){var ya=y1+(x-x1)*slope;yield[x,ya]}else for(var x=x1;x<=x2;x++){var ya=y1+(x-x1)*slope;yield[x,ya]}}}*iterInBetween(pos1,pos2){var x1,y1,x2,y2;if([x1,y1]=pos1,[x2,y2]=pos2,!(Math.abs(y2-y1)==0&&Math.abs(x2-x1)==0))if(Math.abs(y2-y1)>Math.abs(x2-x1)){var slope=(x2-x1)/(y2-y1);if(y1>y2)for(var y=y1-1;y>y2;y--){var x=Math.round(x1+(y-y1)*slope);yield[x,y]}else for(var y=y1+1;y<y2;y++){var x=Math.round(x1+(y-y1)*slope);yield[x,y]}}else{var slope=(y2-y1)/(x2-x1);if(x1>x2)for(var x=x1-1;x>x2;x--){var y=Math.round(y1+(x-x1)*slope);yield[x,y]}else for(var x=x1+1;x<x2;x++){var y=Math.round(y1+(x-x1)*slope);yield[x,y]}}}*iterTypesBetween(pos1,pos2,types){for(var pos of this.iterBetween(pos1,pos2))types.includes(this.get(pos))&&(yield pos)}*iterTypesInBetween(pos1,pos2,types){for(var pos of this.iterInBetween(pos1,pos2))types.includes(this.get(pos))&&(yield pos)}hasTypesBetween(pos1,pos2,types){for(var pos of this.iterTypesBetween(pos1,pos2,types))return!0;return!1}hasTypesInBetween(pos1,pos2,types){for(var pos of this.iterTypesInBetween(pos1,pos2,types))return!0;return!1}*iterAll(sub_rect=null){const[tw,th]=this.tileDim;if(sub_rect!==null)for(var y=sub_rect[1];y<Math.min(th,sub_rect[1]+sub_rect[3]);y++)for(var x=sub_rect[0];x<Math.min(tw,sub_rect[0]+sub_rect[2]);x++)yield[x,y];else for(var y=0;y<th;y++)for(var x=0;x<tw;x++)yield[x,y]}*iterTypes(types,sub_rect){for(var pos of this.iterAll(sub_rect))types.includes(this.get(pos))&&(yield pos)}*iterAdjacent(pos,diagonal=!1){pos=new Vec22(pos);const dirs=diagonal?[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]]:[[0,-1],[1,0],[0,1],[-1,0]];for(let dir of dirs){const npos=pos.add(dir);npos[0]>=0&&npos[0]<this.tileDim[0]&&npos[1]>=0&&npos[1]<this.tileDim[1]&&(yield npos)}}hasAdjacent(pos,types,diagonal=!1){for(let npos of this.iterAdjacent(pos,diagonal))if(types.includes(this.get(npos)))return!0;return!1}*iterInRange(pos,radius){var x,y;[x,y]=pos;const[tw,th]=this.tileDim;radius==null&&(radius=3);for(var rad=Math.ceil(radius),yoff=-rad;yoff<rad+1;yoff++)for(var xoff=-rad;xoff<rad+1;xoff++)if(xoff*xoff+yoff*yoff<=radius*radius){var x0=x+xoff,y0=y+yoff;0<=y0&&y0<th&&0<=x0&&x0<tw&&(yield[x0,y0])}}*iterTypesInRange(pos,types,radius,blocker_types=null){for(var pos0 of this.iterInRange(pos,radius))blocker_types!==null&&this.hasTypesBetween(pos,pos0,blocker_types)||types.includes(this.get(pos0))&&(yield pos0)}numInRange(pos,types,radius,blocker_types=null){var num=0;for(var pos0 of this.iterTypesInRange(pos,types,radius,blocker_types))num++;return num}*iterRectBoundary(rect){const[tw,th]=this.tileDim;let xl=Math.min(Math.max(rect.x,0),tw),xu=Math.min(Math.max(rect.x+rect.w,0),tw),yl=Math.min(Math.max(rect.y,0),th),yu=Math.min(Math.max(rect.y+rect.h,0),th);for(let x0=xl;x0<xu;x0++)yield[x0,yl];for(let x0=xl;x0<xu;x0++)yield[x0,yu];for(let y0=yl;y0<yu;y0++)yield[xl,y0];for(let y0=yl;y0<yu;y0++)yield[xu,y0]}*iterRect(rect,mustFit=!0){const[tw,th]=this.tileDim;if(rect instanceof Rect||(rect=new Rect(rect)),mustFit&&(rect.x<0||rect.y<0||rect.right>tw||rect.bottom>th))return;let xl=Math.max(rect.x,0),xu=Math.min(rect.x+rect.w,tw),yl=Math.max(rect.y,0),yu=Math.min(rect.y+rect.h,th);for(let y0=yl;y0<yu;y0++)for(let x0=xl;x0<xu;x0++)yield[x0,y0]}numInRect(rect,targets,mustFit=!0){let num=0;for(var pos of this.iterRect(rect,mustFit))targets.includes(this.get(pos))&&num++;return num}}const minFontSize=8,scaleFactor=48*(1/window.devicePixelRatio||1);function sizeText(ctx,text,size,fontName,centered,rect,color){let scale2=1;size<minFontSize&&(scale2=1/scaleFactor,ctx.save(),ctx.scale(scale2,scale2)),ctx.fillStyle=color,ctx.font=(size>=minFontSize?size:Math.ceil(size/scale2))+"px "+fontName,rect.x;let w=scale2*ctx.measureText(text).width;return size<minFontSize&&ctx.restore(),[w,2*size]}function getTextData(ctx,text,size,fontName,halign,valign,rect,color){let scale2=1;size<minFontSize&&(scale2=1/scaleFactor,ctx.save(),ctx.scale(scale2,scale2)),ctx.fillStyle=color,ctx.font=(size>=minFontSize?size:Math.ceil(size/scale2))+"px "+fontName;let textX=rect.x,metrics=ctx.measureText(text),textY=rect.y;switch(halign){case"left":break;case"center":textX+=(rect.w-scale2*metrics.width)/2;break;case"right":textX+=rect.w-scale2*metrics.width;break}switch(valign){case"top":break;case"middle":textY+=rect.h/2;break;case"bottom":textY+=rect.h;break}let textData={outText:[[text,textX/scale2,textY/scale2]],color,fontName,size,valign};return size<minFontSize&&ctx.restore(),textData}function drawText(ctx,textData,color=null){let scale2=1,size=textData.size;switch(color==null&&(color=textData.color),size<minFontSize&&(scale2=1/scaleFactor,ctx.save(),ctx.scale(scale2,scale2)),textData.valign){case"top":ctx.textBaseline="top";break;case"middle":ctx.textBaseline="middle";break;case"bottom":ctx.textBaseline="bottom";break}ctx.fillStyle=color,ctx.font=(size>=minFontSize?size:Math.ceil(size/scale2))+"px "+textData.fontName;let[t,x,y]=textData.outText[0];ctx.fillText(t,x,y),size<minFontSize&&ctx.restore()}function sizeWrappedText(ctx,text,size,fontName,centered,rect,color,wordwrap=!0){let scale2=1;size<minFontSize&&(scale2=1/scaleFactor,ctx.save(),ctx.scale(scale2,scale2)),ctx.font=(size>=minFontSize?size:Math.ceil(size/scale2))+"px "+fontName;let h=0,paraText="",guess=Math.min(Math.max(1,Math.ceil(text.length*rect.w/ctx.measureText(text).width/scale2)),text.length);for(;text!=""||paraText!="";){if(paraText==""){let n=text.indexOf(`
`);n>=0?(paraText=text.slice(0,n),text=text.slice(n+1)):(paraText=text,text="")}let nextLine=paraText.slice(0,guess),w=scale2*ctx.measureText(nextLine).width;if(w>rect.w&&guess>1)for(;w>rect.w&&guess>1;)guess--,nextLine=paraText.slice(0,guess),w=scale2*ctx.measureText(nextLine).width;if(w<rect.w&&guess<paraText.length){for(;w<rect.w&&guess<paraText.length;)guess++,nextLine=paraText.slice(0,guess),w=scale2*ctx.measureText(nextLine).width;w>rect.w&&guess--}if(wordwrap&&nextLine[-1]!=""&&paraText[guess]!=" "&&paraText[guess]!="	"){let lastIndex=Math.max(nextLine.lastIndexOf(" "),nextLine.lastIndexOf("	"));lastIndex>=0&&(guess-=nextLine.length-lastIndex-1)}guess=Math.max(1,guess),nextLine=paraText.slice(0,guess),paraText=paraText.slice(guess),wordwrap&&(paraText=paraText.trimStart()),h+=size}return h+=size,size<minFontSize&&ctx.restore(),[rect.w,h]}function getWrappedTextData(ctx,text,size,fontName,halign,valign,rect,color,wordwrap=!0){let scale2=1;size<minFontSize&&(scale2=1/scaleFactor,ctx.save(),ctx.scale(scale2,scale2)),ctx.fillStyle=color,ctx.font=(size>=minFontSize?size:Math.ceil(size/scale2))+"px "+fontName;let y=rect.y,outText=[],paraText="",guess=Math.min(Math.max(1,Math.ceil(text.length*(rect.w/ctx.measureText(text).width)/scale2)),text.length);for(;text!=""||paraText!="";){if(paraText==""){let n=text.indexOf(`
`);n>=0?(paraText=text.slice(0,n),text=text.slice(n+1)):(paraText=text,text="")}let x=rect.x,nextLine=paraText.slice(0,guess),w=scale2*ctx.measureText(nextLine).width;if(w>rect.w&&guess>1)for(;w>rect.w&&guess>1;)guess--,nextLine=paraText.slice(0,guess),w=scale2*ctx.measureText(nextLine).width;if(w<rect.w&&guess<paraText.length){for(;w<rect.w&&guess<paraText.length;)guess++,nextLine=paraText.slice(0,guess),w=scale2*ctx.measureText(nextLine).width;w>rect.w&&guess--}if(wordwrap&&guess<paraText.length&&nextLine[-1]!=""&&paraText[guess]!=" "&&paraText[guess]!="	"){let lastIndex=Math.max(nextLine.lastIndexOf(" "),nextLine.lastIndexOf("	"));lastIndex>=0&&(guess-=nextLine.length-lastIndex-1)}switch(guess=Math.max(1,guess),nextLine=paraText.slice(0,guess),paraText=paraText.slice(guess),wordwrap&&(paraText=paraText.trimStart()),w=scale2*ctx.measureText(nextLine).width,halign){case"left":break;case"center":x+=(rect.w-w)/2;break;case"right":x+=rect.w-w;break}outText.push([nextLine,x/scale2,y/scale2]),y+=size}let h=y-rect.y,off=0;switch(valign){case"top":off=0;break;case"middle":off=(rect.h-h)/2+size/2;break;case"bottom":off=rect.h-h+size}let textData={size,fontName,outText,off:off/scale2,color,valign};return size<minFontSize&&ctx.restore(),textData}function drawWrappedText(ctx,textData,color=null){let scale2=1,size=textData.size;switch(color===null&&(color=textData.color),size<minFontSize&&(scale2=1/scaleFactor,ctx.save(),ctx.scale(scale2,scale2)),textData.valign){case"top":ctx.textBaseline="top";break;case"middle":ctx.textBaseline="middle";break;case"bottom":ctx.textBaseline="bottom";break}ctx.fillStyle=color,ctx.font=(size>=minFontSize?size:Math.ceil(size/scale2))+"px "+textData.fontName;for(let tdat of textData.outText)ctx.fillText(tdat[0],tdat[1],tdat[2]+(textData.off??0));size<minFontSize&&ctx.restore()}const clamp=(num,min,max)=>Math.min(Math.max(num,min),max);function dist(pos1,pos2){return new Vec22(pos1).dist(pos2)}function colorString(vec){let r,g,b;return[r,g,b]=new MathArray(vec).scale(255).map(x=>Math.floor(x)),"#"+r.toString(16).padStart(2,"0")+g.toString(16).padStart(2,"0")+b.toString(16).padStart(2,"0")}class MathArray extends Array{constructor(...arr){arr.length==1&&arr[0]instanceof Array?super(...arr[0]):super(...arr)}static asRandomFloats(size,low=0,high=1){let a=new MathArray(size);for(let i=0;i<a.length;i++)a[i]=randomFloat(low,high);return a}sum(){let s=0;return this.forEach(el=>s+=el),s}mean(){return this.sum()/this.length}max(){return Math.max.apply(null,this)}min(){return Math.min.apply(null,this)}vars(){let s=0;return this.forEach(el=>s+=el*el),(s-this.length*this.mean()^2)/(this.length-1)}var(){let s=0;return this.forEach(el=>s+=el*el),s/this.length-this.mean()^2}std(){return Math.sqrt(this.var())}add(arr2){let a=new MathArray(this);if(arr2 instanceof Array)for(let i=0;i<this.length;i++)a[i]+=arr2[i];else for(let i=0;i<this.length;i++)a[i]+=arr2;return a}mul(arr2){let a=new MathArray(this);if(arr2 instanceof Array)for(let i=0;i<this.length;i++)a[i]*=arr2[i];else for(let i=0;i<this.length;i++)a[i]*=arr2;return a}scale(scalar){const arr=Array();for(let val of this)arr.push(val*scalar);return arr}dot(arr2){return this.mul(arr2).sum()}abs(){return Math.abs.apply(null,this)}lag(k){let a=new MathArray;for(let i=-k;i<this.length-k;i++)i<0||i>=this.length?a.push(NaN):a.push(this[i]);return a}filter(func){return new MathArray(super.filter(func))}dropNaN(){return this.filter(el=>!Number.isNaN(el))}}class Touch{constructor(props={}){__publicField(this,"identifier",-1);__publicField(this,"pos",[0,0]);__publicField(this,"state","touch_up");__publicField(this,"device","touch");__publicField(this,"nativeObject",null);__publicField(this,"nativeEvent",null);for(let p in props)this[p]=props[p]}copy(){return new Touch({pos:[...this.pos],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}asChildTouch(widget){return new Touch({pos:[...widget.toChild(this.pos)],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}get rect(){return new Rect([...this.pos,0,0])}set x(value){this.pos[0]=value}set y(value){this.pos[1]=value}get x(){return this.pos[0]}get y(){return this.pos[1]}get grabbed(){return App.get().inputHandler.grabbed}grab(widget){App.get().inputHandler.grab(widget)}ungrab(){App.get().inputHandler.ungrab()}}class InputHandler{constructor(app){__publicField(this,"grabbed",null);__publicField(this,"mouseTouchEmulation",!0);__publicField(this,"mouseev",null);__publicField(this,"keyStates",{});this.app=app,this.canvas=app.canvas;let canvas=this.canvas,that=this;document.addEventListener("keydown",function(ev){that.process_key(ev,"key_down")},!0),document.addEventListener("keyup",function(ev){that.process_key(ev,"key_up")},!0),canvas.addEventListener("mousedown",function(ev){that.process_mouse(ev,"mouse_down")},!0),canvas.addEventListener("mousemove",function(ev){that.process_mouse(ev,"mouse_move")},!0),canvas.addEventListener("mouseout",function(ev){that.process_mouse(ev,"mouse_cancel")},!0),canvas.addEventListener("mouseup",function(ev){that.process_mouse(ev,"mouse_up")},!0),canvas.addEventListener("touchstart",function(ev){that.process_touch(ev,"touch_down")},!1),canvas.addEventListener("touchmove",function(ev){that.process_touch(ev,"touch_move")},!1),canvas.addEventListener("touchcancel",function(ev){that.process_touch(ev,"touch_cancel")},!1),canvas.addEventListener("touchend",function(ev){that.process_touch(ev,"touch_up")},!1),canvas.addEventListener("wheel",function(ev){that.process_wheel(ev,"wheel")},!0),window.history.replaceState(null,document.title,location.pathname+"#!/backbutton"),window.history.pushState(null,document.title,location.pathname),window.addEventListener("popstate",function(ev){that.process_back(ev,"back_button")},!1)}grab(widget){this.grabbed=widget}ungrab(){this.grabbed=null}isKeyUp(key){return key in this.keyStates&&this.keyStates[key]}isKeyDown(key){return key in this.keyStates&&this.keyStates[key]}process_key(ev,name){this.app.requestFrameUpdate();const oldKeyState=this.keyStates[ev.key];name==="key_up"?this.keyStates[ev.key]=!1:name==="key_down"&&(this.keyStates[ev.key]=!0),this.app.emit(name,{states:this.keyStates,oldState:oldKeyState,event:ev})}process_touch(ev,name){if(this.app.requestFrameUpdate(),this.grabbed!==null)for(let to of ev.changedTouches){let pos=this.grabbed.appToChild([to.clientX,to.clientY]),t=new Touch({pos,state:name,nativeObject:to,nativeEvent:ev,identifier:to.identifier});this.grabbed.emit(name,t)}else for(let to of ev.changedTouches){let t=new Touch({pos:this.app.toChild([to.clientX,to.clientY]),state:name,nativeObject:to,nativeEvent:ev,identifier:to.identifier});this.app.childEmit(name,t,!0)}ev.preventDefault()}process_back(ev,name){location.hash==="#!/backbutton"&&(history.replaceState(null,document.title,location.pathname),this.app.childEmit("back_button",ev))}process_mouse(ev,name){if(this.app.requestFrameUpdate(),this.mouseev=ev,ev.preventDefault(),this.mouseTouchEmulation){let mapping={mouse_up:"touch_up",mouse_down:"touch_down",mouse_move:"touch_move",mouse_cancel:"touch_cancel"};if(ev.buttons!==1&&name!=="mouse_up")return;if(this.grabbed!==null){let pos0=[ev.clientX,ev.clientY],pos=this.grabbed.appToChild(pos0),t=new Touch({pos,state:mapping[name],nativeObject:ev,identifier:-1});this.grabbed.emit(mapping[name],t)}else{let t=new Touch({pos:this.app.toChild([ev.clientX,ev.clientY]),state:mapping[name],nativeObject:ev,identifier:-1});this.app.childEmit(mapping[name],t,!0)}}else this.grabbed!==null?this.grabbed.emit(name,ev):this.app.childEmit(name,ev,!0)}process_wheel(ev,name){if(this.mouseev!=null){if(this.app.requestFrameUpdate(),this.grabbed!=null){let pos=this.grabbed.appToChild([this.mouseev.clientX,this.mouseev.clientY]),t=new Touch({pos,state:name,nativeObject:ev});return this.grabbed.emit(name,t)}else{let t=new Touch({pos:this.app.toChild([this.mouseev.clientX,this.mouseev.clientY]),state:name,nativeObject:ev});this.app.childEmit(name,t,!0)}ev.preventDefault()}}vibrate(intensity1,intensity2,duration){window.navigator.vibrate(duration)}}function evaluatedProperty(key,value,context,root){if(typeof value=="string"||value instanceof String){if(key.startsWith("on_"))return new Function("resources","parent","root",`return function(event, object, value) {${value}}`).bind(context)(App.resources,context.parent,root);if(value.trim().startsWith("(")&&value.indexOf("=>")<value.indexOf(`
`)){const func=new Function("resources","parent","root",`return ${value}`).bind(context)(App.resources,context.parent,root);return func.markupMethod=!0,func}const objs=new Set;let objCount=0;if(value[0]!=="'"&&value[0]!=='"')for(let m of value.matchAll(/(?!\.)\b([a-z]\w*)\.([a-z_]\w*)\b/ig)){const c=m[1];c!=="this"&&c!=="parent"&&c!=="root"&&c!=="resources"&&objs.add(c),objCount++}if(objCount===0)return new Function("resources",`return ${value};`)(App.resources);const objStr=[...objs].join(", "),functionBody=`return function (${objStr}) { return ${value} }`,dynamicFunc=new Function("resources","parent","root",functionBody)(App.resources,context.parent,root).bind(context);return dynamicFunc.text=`(${objStr}) => ${value}`,dynamicFunc}return value}function instanceClassData(widget,objectData,rootWidget){const props={},clsName=widget.constructor.name,merged={...App.rules.get(clsName),...objectData};for(let p in merged){const val=merged[p];if(p==="children"&&val instanceof Array){const ch=[];for(let c of val)if(c instanceof Object&&"cls"in c){const[cls,clsExtends]=App.classes[c.cls],childWidget=new cls;instanceClassData(childWidget,c,rootWidget),ch.push(childWidget)}else throw Error(`Unknown child class ${c} on clsName ${clsName}`);widget instanceof App?widget.baseWidget.children=ch:widget.children=ch}else if(p!=="cls")try{props[p]=evaluatedProperty(p,val,widget,rootWidget)}catch{props[p]=val}}widget.updateProperties(props,!1)}class Timer{constructor(time,initElapsed=0,callback=null){this.elapsed=0,this.timer=time,this.triggered=!1,this.callback=callback,initElapsed>0&&this.tick(initElapsed)}finished(){return this.elapsed>=this.timer}tick(millis){return this.elapsed>=this.timer?(this.triggered&&(this.triggered=!1),!1):(this.elapsed+=millis,this.elapsed>=this.timer?(this.callback!=null&&this.callback("timer",this),this.triggered=!0,!0):!1)}reset(time=-1,initElapsed=0){this.triggered=!1,time>=0&&(this.timer=time),initElapsed>0&&this.tick(initElapsed)}}class Rules{constructor(){this.rules=new Map}add(widgetClass,ruleProperties,replace=!0){let curRuleset=this.rules.get(widgetClass);if(curRuleset&&!replace)for(let p in curRuleset)curRuleset[p]=ruleProperties[p];else this.rules.set(widgetClass,ruleProperties)}get(widgetClass){return this.rules.get(widgetClass)??{}}remove(widgetClass){return this.rules.delete(widgetClass)}}class EventConnection{constructor(listener,event,callback){this.listener=listener,this.event=event,this.callback=callback}}class EventManager{constructor(){this.connections=new Map}bind(listener,emitter,event,callback){let conn=new EventConnection(listener,event,callback),conns=this.connections.get(emitter);conns?conns.add(conn):this.connections.set(emitter,new Set([conn]))}emit(emitter,event,data){const conns=this.connections.get(emitter);if(!conns)return!1;for(let conn of conns)if(conn.event===event&&conn.callback(event,emitter,data))return!0;return!1}disconnect(widget){this.connections.delete(widget);for(let emitter of this.connections.keys()){const deleteList=[],conns=this.connections.get(emitter);if(conns){for(let conn of conns)conn.listener===widget&&deleteList.push(conn);deleteList.forEach(conn=>conns.delete(conn))}}}}class Widget extends Rect{constructor(properties=null){super();__publicField(this,"bgColor",null);__publicField(this,"outlineColor",null);__publicField(this,"_animation",null);__publicField(this,"_layoutNotify",!1);__publicField(this,"hints",{});return this.parent=null,this._processTouches=!1,this._deferredProps=null,this._children=[],this._needsLayout=!0,properties!=null&&this.updateProperties(properties),new Proxy(this,{set(target,name,value,receiver){return typeof name=="string"&&(["x","y","w","h","children","rect"].includes(name)||name[0]=="_")?Reflect.set(target,name,value,receiver):(Reflect.set(target,name,value,receiver),typeof name=="string"&&Reflect.apply(target.emit,receiver,[name,value]),!0)}})}set rect(rect){this[0]=rect[0],this[1]=rect[1],this[2]=rect[2],this[3]=rect[3],this._needsLayout=!0}get rect(){return new Rect([this[0],this[1],this[2],this[3]])}deferredProperties(app){let properties=this._deferredProps;this._deferredProps=null;for(let p in properties)if(!p.startsWith("on_")&&!p.startsWith("_")&&typeof properties[p]=="function"){let func=properties[p],args,rval;[args,rval]=(func.text??func.toString()).split("=>"),args=args.replace("(","").replace(")","").split(",").map(a=>a.trim());let objs=args.map(a=>app.findById(a)),obmap={};for(let a of args)obmap[a]=app.findById(a);const re=/(\w+)\.(\w+)/g;for(let pat of rval.matchAll(re)){let pr,ob;if([ob,pr]=pat.slice(1),ob==="this")this.bind(pr,(evt,obj,data)=>{try{this[p]=func(...objs)}catch(error){}});else if(ob in obmap)try{obmap[ob].bind(pr,(evt,obj,data)=>{try{this[p]=func(...objs)}catch(error){}})}catch(error){`${ob}`}}try{this[p]=func(...objs)}catch(error){}}}updateProperties(properties,applyRuleData=!0){applyRuleData&&instanceClassData(this,{},this);for(let p in properties)!p.startsWith("on_")&&!p.startsWith("_")&&typeof properties[p]=="function"&&!("markupMethod"in properties[p])?this._deferredProps=properties:this[p]=properties[p]}bind(event,func,listener=null){App.get()._eventManager.bind(listener,this,event,func)}emit(event,data){return"on_"+event in this&&this["on_"+event](event,this,data)?!0:App.get()._eventManager.emit(this,event,data)}*iter(recursive=!0,inView=!0){if(yield this,!!recursive)for(let c of this._children)yield*c.iter(...arguments)}*iterParents(){this.parent!==null&&(yield this.parent,this.parent!=App.get()&&(yield*this.parent.iterParents()))}findById(id){for(let w of this.iter(!0,!1))if("id"in w&&w.id==id)return w;return null}*iterByPropertyValue(property,value){for(let w of this.iter(!0,!1))property in w&&w[property]==value&&(yield w)}getTransformRecurse(includeSelf=!1,widget=null){let transform=this!==widget&&this.parent!==null?this.parent.getTransformRecurse(!0,widget):new DOMMatrix;if(!includeSelf)return transform;let newT=this.getTransform();return newT?transform.multiply(newT):transform}getTransform(){return null}applyTransform(pt,invert=!1,recurse=!1,includeSelf=!1,firstWidget=null){let tx=recurse?this.getTransformRecurse(includeSelf,firstWidget):this.getTransform();if(!tx)return pt;invert&&(tx=tx.inverse());let dp=tx.transformPoint(new DOMPoint(pt.x,pt.y));return new Vec22([dp.x,dp.y])}appToWidget(pos,recurse=!0){if(this.parent){let pt=this.parent.getTransformRecurse().inverse().transformPoint(new DOMPoint(pos[0],pos[1]));return new Vec22([pt.x,pt.y])}return pos}appToChild(pos,recurse=!0){let pt=this.getTransformRecurse().inverse().transformPoint(new DOMPoint(pos[0],pos[1]));return new Vec22([pt.x,pt.y])}toChild(pos){let tx=this.getTransform();if(!tx)return pos;let pt=tx.inverse().transformPoint(new DOMPoint(pos[0],pos[1]));return new Vec22([pt.x,pt.y])}addChild(child,pos=-1){pos==-1?this._children.push(child):this._children=[...this._children.slice(0,pos),child,...this._children.slice(pos)],this.emit("child_added",child),child.parent=this,this._needsLayout=!0}removeChild(child,disconnect=!0){this._children=this.children.filter(c=>c!=child),disconnect&&App.get()._eventManager.disconnect(child),this.emit("child_removed",child),child.parent=null,this._needsLayout=!0}get children(){return this._children}set children(children){for(let c of this._children)this.emit("child_removed",c),c.parent=null,this._needsLayout=!0;this._children=[];for(let c of children)this.addChild(c)}set x(val){this._needsLayout=!0,this[0]=val}set center_x(val){this._needsLayout=!0,this[0]=val-this[2]/2}set right(val){this._needsLayout=!0,this[0]=val-this[2]}set y(val){this._needsLayout=!0,this[1]=val}set center_y(val){this._needsLayout=!0,this[1]=val-this[3]/2}set bottom(val){this._needsLayout=!0,this[1]=val-this[3]}set w(val){this._needsLayout=!0,this[2]=val}set h(val){this._needsLayout=!0,this[3]=val}get x(){return this[0]}get center_x(){return this[0]+this[2]/2}get right(){return this[0]+this[2]}get y(){return this[1]}get center_y(){return this[1]+this[3]/2}get bottom(){return this[1]+this[3]}get w(){return this[2]}get h(){return this[3]}on_wheel(event,object,wheel){for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,wheel))return!0;return!1}on_touch_down(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,t))return!0}else for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,touch))return!0;return!1}on_touch_up(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,t))return!0}else for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,touch))return!0;return!1}on_touch_move(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,t))return!0}else for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,touch))return!0;return!1}on_touch_cancel(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,t))return!0}else for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,touch))return!0;return!1}on_back_button(event,object,history2){return!1}getMetric(widget,target,rule,parentWidth=null,parentHeight=null){let app=App.get();if(rule===null)return widget[target];let value=0,base="relative";for(parentWidth=parentWidth??this.w,parentHeight=parentHeight??this.h;;){if(rule.constructor==String){let r2=rule.slice(-2);if(r2=="ww"){value=+rule.slice(0,-2)*widget.w;break}if(r2=="wh"){value=+rule.slice(0,-2)*widget.h;break}if(r2=="aw"){value=+rule.slice(0,-2)*app.dimW,base="absolute";break}if(r2=="ah"){value=+rule.slice(0,-2)*app.dimH,base="absolute";break}let r1=rule.slice(-1);if(r1=="w"){value=+rule.slice(0,-1)*parentWidth;break}if(r1=="h"){value=+rule.slice(0,-1)*parentHeight;break}value=+rule;break}if(target=="w"||target=="x"||target=="center_x"||target=="right"){value=+rule;break}value=+rule;break}return base=="relative"&&(["x","center_x","right"].includes(target)&&(value+=this.x),["y","center_y","bottom"].includes(target)&&(value+=this.y)),value}applyHintMetric(widget,target,rule,parentWidth=null,parentHeight=null){let app=App.get();if(rule===null)return;let value=0,base="relative";for(parentWidth=parentWidth??this.w,parentHeight=parentHeight??this.h;;){if(rule.constructor==String){let r2=rule.slice(-2);if(r2=="ww"){value=+rule.slice(0,-2)*widget.w;break}if(r2=="wh"){value=+rule.slice(0,-2)*widget.h;break}if(r2=="aw"){value=+rule.slice(0,-2)*app.dimW,base="absolute";break}if(r2=="ah"){value=+rule.slice(0,-2)*app.dimH,base="absolute";break}let r1=rule.slice(-1);if(r1=="w"){value=+rule.slice(0,-1)*parentWidth;break}if(r1=="h"){value=+rule.slice(0,-1)*parentHeight;break}value=+rule;break}if(target=="w"||target=="x"||target=="center_x"||target=="right"){value=+rule*parentWidth;break}value=+rule*parentHeight;break}base=="relative"&&(["x","center_x","right"].includes(target)&&(value+=this.x),["y","center_y","bottom"].includes(target)&&(value+=this.y)),widget[target]=value}applyHints(c,w=null,h=null){let hints=c.hints;w=w??this.w,h=h??this.h,"w"in hints&&hints.w!=null&&hints.w.constructor==String&&hints.w.slice(-2)=="wh"?(hints.h!==void 0&&this.applyHintMetric(c,"h",hints.h,w,h),hints.w!==void 0&&this.applyHintMetric(c,"w",hints.w,w,h)):(hints.w!==void 0&&this.applyHintMetric(c,"w",hints.w,w,h),hints.h!==void 0&&this.applyHintMetric(c,"h",hints.h,w,h));for(let ht in hints)ht!="w"&&ht!="h"&&this.applyHintMetric(c,ht,hints[ht],w,h)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;for(let c of this.children)this.applyHints(c),c.layoutChildren()}_draw(app,ctx,millis){this.draw(app,ctx);let transform=this.getTransform();if(transform){ctx.save(),ctx.transform(transform.a,transform.b,transform.c,transform.d,transform.e,transform.f);for(let c of this._children)c._draw(app,ctx,millis);ctx.restore();return}for(let c of this._children)c._draw(app,ctx,millis)}draw(app,ctx){let r=this.rect;if(ctx.beginPath(),ctx.rect(r[0],r[1],r[2],r[3]),this.bgColor!=null){const origFill=ctx.fillStyle;ctx.fillStyle=this.bgColor,ctx.fill(),ctx.fillStyle=origFill}if(this.outlineColor!=null){let lw=ctx.lineWidth;ctx.lineWidth=1/app.tileSize;const origStroke=ctx.strokeStyle;ctx.strokeStyle=this.outlineColor,ctx.stroke(),ctx.lineWidth=lw,ctx.strokeStyle=origStroke}}update(app,millis){this._deferredProps!=null&&this.deferredProperties(app),this._animation!=null&&(this._animation.update(app,millis),app.requestFrameUpdate()),this._needsLayout&&(this.layoutChildren(),app.requestFrameUpdate());for(let c of this._children)c.update(app,millis)}}const _App=class _App extends Widget{static registerClass(name,cls,baseClsName){_App.classes[name]=[cls,baseClsName]}constructor(props=null){if(_App.appInstance!=null)return _App.appInstance;super(),_App.appInstance=this,window.app=this,this._eventManager=new EventManager,this.id="app",this.canvas=null,this.canvasName="canvas",this.w=-1,this.h=-1,this._baseWidget=new Widget({hints:{x:0,y:0,w:1,h:1}}),this._baseWidget.parent=this,this._modalWidgets=[],this._udpateActive=!0,this.pixelSize=1,this.integerTileSize=!1,this.exactDimensions=!1,this.prefDimW=32,this.prefDimH=16,this.dimW=this.prefDimW,this.dimH=this.prefDimH,this.tileSize=this.getTileScale()*this.pixelSize,this.offsetX=0,this.offsetY=0,this.shakeX=0,this.shakeY=0,this.shakeAmount=0,this.timer_tick=null,this.timers=[],this.continuousFrameUpdates=!1,this._requestedFrameUpdate=!1,props&&this.updateProperties(props)}get baseWidget(){return this._baseWidget}addTimer(duration,callback){let t=new Timer(duration,0,callback);return this.timers.push(t),t}removeTimer(timer){this.timers=this.timers.filter(t=>t!=timer)}addModal(modal){this._modalWidgets.push(modal),this._needsLayout=!0}removeModal(modal){this._modalWidgets=this._modalWidgets.filter(m=>m!=modal)}static get(){return _App.appInstance||(_App.appInstance=new _App),_App.appInstance}start(){let that=this;this.setupCanvas(),this.inputHandler=new InputHandler(this),window.onresize=()=>that.updateWindowSize(),this.updateWindowSize(),setTimeout(()=>this._start(),1)}_start(){this.update()}childEmit(event,data,topModalOnly=!1){if(topModalOnly&&this._modalWidgets.length>0)return this._modalWidgets[this._modalWidgets.length-1].emit(event,data);if(this._baseWidget.emit(event,data))return!0;for(let mw of this._modalWidgets)if(mw.emit(event,data))return!0;return!1}*iter(recursive=!0,inView=!0){yield this,yield*this._baseWidget.iter(...arguments);for(let mw of this._modalWidgets)yield*mw.iter(...arguments)}findById(id){for(let w of this.iter(!0,!1))if("id"in w&&w.id==id)return w;return null}*iterByPropertyValue(property,value){for(let w of this.iter(!0,!1))property in w&&w[property]===value&&(yield w)}update(){this._requestedFrameUpdate=!1,this._udpateActive=!0;let millis=15,n_timer_tick=Date.now();this.timer_tick!=null&&(millis=Math.min(n_timer_tick-this.timer_tick,30)),(this.timers.length>0||this._needsLayout)&&this.requestFrameUpdate();for(let t of this.timers)t.tick(millis);this._needsLayout&&this.layoutChildren();for(let res of _App.resources.values())res.update(this,millis);this._baseWidget.update(this,millis);for(let mw of this._modalWidgets)mw.update(this,millis);this.ctx&&this._draw(this,this.ctx,millis),this.continuousFrameUpdates&&this.requestFrameUpdate(),this.timer_tick=n_timer_tick,this._udpateActive=!1,this._requestedFrameUpdate&&(this._requestedFrameUpdate=!1,this.requestFrameUpdate())}requestFrameUpdate(){this._requestedFrameUpdate||(this._udpateActive?this._requestedFrameUpdate=!0:(this._udpateActive=!0,window.requestAnimationFrame(()=>this.update())))}_draw(app,ctx,millis){if(!this.canvas)return;ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.shakeX=0,this.shakeY=0,this.screenShake(),ctx.save();let tx=this.getTransform();tx&&ctx.transform(tx.a,tx.b,tx.c,tx.d,tx.e,tx.f),this._baseWidget._draw(app,ctx,millis);for(let mw of this._modalWidgets)mw._draw(app,ctx,millis);ctx.restore()}getTransform(recurse=!0){return new DOMMatrix().translate(this.offsetX+this.shakeX,this.offsetY+this.shakeY).scale(this.tileSize,this.tileSize)}on_prefDimW(e,o,v){this.updateWindowSize()}on_prefDimH(e,o,v){this.updateWindowSize()}on_tileSize(e,o,v){this.prefDimH<0&&this.prefDimW<0&&this.updateWindowSize()}computeDeviceScale(){const dpr=window.devicePixelRatio||1,scale2=1080/(Math.min(window.innerWidth,window.innerHeight)*dpr);return Math.max(1,Math.min(scale2,3))}updateWindowSize(){this.x=0,this.y=0,this.w=window.innerWidth,this.h=window.innerHeight,this.pixelSize=this.computeDeviceScale(),this.w,this.h,(this.prefDimH>=0||this.prefDimW>=0)&&(this.tileSize=this.getTileScale()),this.fitDimensionsToTileSize(this.tileSize),this.canvas!==null&&this.setupCanvas();try{screen.orientation.unlock()}catch{}this._needsLayout=!0,this.requestFrameUpdate()}getTileScale(){let sh=this.h,sw=this.w,scale2=1/this.pixelSize;return this.prefDimW<0&&this.prefDimH<0?this.tileSize>0&&(scale2=this.tileSize/this.pixelSize):this.prefDimW<0?scale2=sh/this.prefDimH/this.pixelSize:this.prefDimH<0?scale2=sw/this.prefDimW/this.pixelSize:scale2=Math.min(sh/this.prefDimH/this.pixelSize,sw/this.prefDimW/this.pixelSize),this.integerTileSize&&scale2>1&&(scale2=Math.floor(scale2)),scale2*this.pixelSize}fitDimensionsToTileSize(scale2){let sh=this.h,sw=this.w;if(this.exactDimensions){this.prefDimW<0&&this.prefDimH<0?(this.dimW=sw/this.tileSize,this.dimH=sh/this.tileSize):this.prefDimH<0?(this.dimW=this.prefDimW,this.dimH=sh/this.tileSize):this.prefDimW<0?(this.dimW=sw/this.tileSize,this.dimH=this.prefDimH):(this.dimH=this.prefDimH,this.dimW=this.prefDimW);return}this.dimH=Math.floor(sh/scale2),this.dimW=Math.floor(sw/scale2)}setupCanvas(){const canvas=document.getElementById(this.canvasName);if(!(canvas instanceof HTMLCanvasElement))throw"No canvas element named "+this.canvasName;this.canvas=canvas,this.canvas.width=this.w,this.canvas.height=this.h,this.ctx=this.canvas.getContext("2d"),this.ctx&&(this.ctx.imageSmoothingEnabled=!1,this.offsetX=Math.floor((this.w-this.tileSize*this.dimW)/2),this.offsetY=Math.floor((this.h-this.tileSize*this.dimH)/2))}applyHints(c){super.applyHints(c,this.dimW,this.dimH)}screenShake(){this.shakeAmount&&this.shakeAmount--;let shakeAngle=Math.random()*Math.PI*2;this.shakeX=Math.round(Math.cos(shakeAngle)*this.shakeAmount),this.shakeY=Math.round(Math.sin(shakeAngle)*this.shakeAmount)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.applyHints(this._baseWidget),this._baseWidget.layoutChildren();for(let mw of this._modalWidgets)this.applyHints(mw),mw.layoutChildren()}};__publicField(_App,"appInstance",null),__publicField(_App,"rules",new Rules),__publicField(_App,"resources",new Map),__publicField(_App,"classes",{});let App=_App;class Label extends Widget{constructor(properties=null){super();__publicField(this,"fontSize",null);__publicField(this,"sizeGroup","");__publicField(this,"clip",!1);__publicField(this,"ignoreSizeForGroup",!1);__publicField(this,"fontName",'"Nimbus Mono PS", "Courier New", monospace');__publicField(this,"text","");__publicField(this,"wrap",!1);__publicField(this,"wrapAtWord",!0);__publicField(this,"align","center");__publicField(this,"valign","middle");__publicField(this,"color","white");this._textData=null,properties!==null&&this.updateProperties(properties)}on_align(e,object,v){this._needsLayout=!0}on_valign(e,object,v){this._needsLayout=!0}on_wrap(e,object,v){this._needsLayout=!0}on_wrapAtWord(e,object,v){this._needsLayout=!0}on_text(e,object,v){this._needsLayout=!0}on_fontSize(e,object,v){this._needsLayout=!0}on_fontName(e,object,v){this._needsLayout=!0}layoutChildren(){let ctx=App.get().ctx;if(!ctx)return;let fontSize=this.fontSize===null?null:this.getMetric(this,"fontSize",this.fontSize);if("h"in this.hints&&this.hints.h==null&&fontSize!==null&&(this[3]=this.wrap?sizeWrappedText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[1]:sizeText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color)[1]),"w"in this.hints&&this.hints.w==null&&fontSize!==null&&(this[2]=this.wrap?sizeWrappedText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[0]:sizeText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color)[0]),fontSize=fontSize===null?this.h/2:fontSize,this.fontSize===null&&this.rect.w!==void 0){let i=0,w,h;for(;i<50;){if(this.wrap?[w,h]=sizeWrappedText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord):[w,h]=sizeText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color),(this.h>=h||"h"in this.hints&&this.hints.h==null||fontSize<.01)&&(this.w>=w||"w"in this.hints&&this.hints.w==null)){"h"in this.hints&&this.hints.h==null&&(this.h=h),"w"in this.hints&&this.hints.w==null&&(this.w=w);break}const err=Math.min(1.1,this.w/w,this.h/h);this.wrap?fontSize*=err**.5:fontSize*=err**1.1,i++}fontSize===void 0&&(fontSize=.001*App.get().h)}this.sizeGroup!==""?(this._bestFontSize=fontSize,this._textData=null):this.wrap?this._textData=getWrappedTextData(ctx,this.text,fontSize,this.fontName,this.align,this.valign,this.rect,this.color,this.wrapAtWord):this._textData=getTextData(ctx,this.text,fontSize,this.fontName,this.align,this.valign,this.rect,this.color),super.layoutChildren()}sizeToGroup(ctx){if(this._bestFontSize===void 0)return;let fontSize=1/0;for(let lbl of App.get().iterByPropertyValue("sizeGroup",this.sizeGroup))fontSize>lbl._bestFontSize&&!lbl.ignoreSizeForGroup&&(fontSize=lbl._bestFontSize);if(fontSize>0)for(let lbl of App.get().iterByPropertyValue("sizeGroup",this.sizeGroup)){const fs=lbl.clip||!lbl.ignoreSizeForGroup?fontSize:lbl._bestFontSize;lbl.wrap?lbl._textData=getWrappedTextData(ctx,lbl.text,fs,lbl.fontName,lbl.align,lbl.valign,lbl.rect,lbl.color,lbl.wrapAtWord):lbl._textData=getTextData(ctx,lbl.text,fs,lbl.fontName,lbl.align,lbl.valign,lbl.rect,lbl.color)}}draw(app,ctx){if(super.draw(app,ctx),this.clip){ctx.save();const r=this.rect;ctx.rect(r.x,r.y,r.w,r.h),ctx.clip()}!this._textData&&this.sizeGroup!==""&&this.sizeToGroup(ctx),this._textData&&(this.wrap?drawWrappedText(ctx,this._textData,this.color):drawText(ctx,this._textData,this.color)),this.clip&&ctx.restore()}}class Button extends Label{constructor(properties=null){super();__publicField(this,"bgColor",colorString([.5,.5,.5]));__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.4,.4,.4]));__publicField(this,"disable",!1);properties!==null&&this.updateProperties(properties)}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,!0):!1}on_touch_up(event,object,touch){return super.on_touch_up(event,object,touch)?!0:touch.grabbed!=this?!1:(touch.ungrab(),!this.disable&&this.collide(touch.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(event,object,touch){return super.on_touch_move(event,object,touch)?!0:(touch.grabbed==this&&!this.disable&&(this._touching=this.collide(touch.rect)),!1)}draw(app,ctx){let saved=this.bgColor,saved2=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(app,ctx),this.bgColor=saved,this.color=saved2}}class BasicButton extends Widget{constructor(properties=null){super();__publicField(this,"color",colorString([.8,.8,.8]));__publicField(this,"bgColor",colorString([.5,.5,.5]));__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.4,.4,.4]));__publicField(this,"disable",!1);properties!==null&&this.updateProperties(properties)}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,!0):!1}on_touch_up(event,object,touch){return super.on_touch_up(event,object,touch)?!0:touch.grabbed!=this?!1:(touch.ungrab(),!this.disable&&this.collide(touch.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(event,object,touch){return super.on_touch_move(event,object,touch)?!0:(touch.grabbed==this&&!this.disable&&(this._touching=this.collide(touch.rect)),!1)}draw(app,ctx){let saved=this.bgColor,saved2=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(app,ctx),this.bgColor=saved,this.color=saved2}}class ToggleButton extends Label{constructor(props=null){super();__publicField(this,"bgColor",colorString([.5,.5,.5]));__publicField(this,"pressColor",colorString([.7,.7,.7]));__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.4,.4,.4]));__publicField(this,"disable",!1);__publicField(this,"_press",!1);__publicField(this,"group",null);__publicField(this,"singleSelect",!0);props!==null&&this.updateProperties(props)}get press(){return this._press}set press(value){this._press=value}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,!0):!1}on_touch_up(event,object,touch){if(touch.grabbed!==this)return!1;if(touch.ungrab(),this._touching=!1,this.collide(touch.rect)){if(this.group===null||!this.singleSelect)this.press=!this.press;else{if(this.parent!==null)for(let w of this.parent.iterByPropertyValue("group",this.group))w!==this&&(w._press=!1);this.press=!0}return!0}return!1}on_touch_move(event,object,touch){return touch.grabbed===this?(this._touching=this.collide(touch.rect),!0):!1}draw(app,ctx){let saved=this.bgColor,saved2=this.color;this.press&&(this.bgColor=this.pressColor),this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(app,ctx),this.bgColor=saved,this.color=saved2}}class CheckBox extends Widget{constructor(props=null){super();__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"color",colorString([.6,.6,.6]));__publicField(this,"bgColor",colorString([.5,.5,.5]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.3,.3,.3]));__publicField(this,"disable",!1);__publicField(this,"check",!1);__publicField(this,"group",null);props!==null&&this.updateProperties(props)}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,!0):!1}on_touch_up(event,object,touch){if(super.on_touch_up(event,object,touch))return!0;if(this.parent===null||touch.grabbed!=this)return!1;if(touch.ungrab(),!this.disable&&this.collide(touch.rect)){if(this._touching=!1,this.group==null)this.check=!this.check;else{for(let w of this.parent.iterByPropertyValue("group",this.group))w!=this&&(w.check=!1);this.check=!0}return!0}return!1}on_touch_move(event,object,touch){return super.on_touch_move(event,object,touch)?!0:touch.grabbed==this&&!this.disable?(this._touching=this.collide(touch.rect),!0):!1}draw(app,ctx){if(this.group!=null){let r2=this.rect;r2.w=r2.h=.5*Math.min(r2.w,r2.h),r2.x=this.x+(this.w-r2.w)/2,r2.y=this.y+(this.h-r2.h)/2;let ts2=App.get().tileSize,ctx2=App.get().ctx;if(!ctx2)return;ctx2.strokeStyle=this.disable?this.disableColor1:this.bgColor,ctx2.lineWidth=1/ts2,ctx2.beginPath(),ctx2.arc(r2.center_x,r2.center_y,r2.w/2,0,2*Math.PI),ctx2.stroke(),(this._touching||this.disable)&&(ctx2.fillStyle=this.disable?this.disableColor1:this.selectColor,ctx2.fill()),this.check&&(ctx2.fillStyle=this.disable?this.disableColor2:this.color,ctx2.beginPath(),ctx2.arc(r2.center_x,r2.center_y,r2.w/3,0,2*Math.PI),ctx2.fill());return}let r=this.rect;r.w=r.h=.5*Math.min(r.w,r.h),r.x=this.x+(this.w-r.w)/2,r.y=this.y+(this.h-r.h)/2;let ts=app.tileSize;ctx.beginPath(),ctx.strokeStyle=this.bgColor,this.disable&&(ctx.strokeStyle=this.disableColor1),ctx.lineWidth=1/ts,ctx.rect(r[0],r[1],r[2],r[3]),ctx.stroke(),this._touching&&(ctx.fillStyle=this.selectColor,ctx.fill()),this.check&&(ctx.strokeStyle=this.color,this.disable&&(ctx.strokeStyle=this.disableColor2),ctx.beginPath(),ctx.lineWidth=r.w/5,ctx.moveTo(r.x,r.y),ctx.lineTo(r.right,r.bottom),ctx.moveTo(r.right,r.y),ctx.lineTo(r.x,r.bottom),ctx.stroke())}}class Slider extends Widget{constructor(props=null){super();__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"color",colorString([.6,.6,.6]));__publicField(this,"bgColor",colorString([.4,.4,.4]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.3,.3,.3]));__publicField(this,"disable",!1);__publicField(this,"min",0);__publicField(this,"max",1);__publicField(this,"curMax",1);__publicField(this,"unboundedStopMultiple",10);__publicField(this,"exponentialSlider",!1);__publicField(this,"step",null);__publicField(this,"orientation","horizontal");__publicField(this,"value",0);__publicField(this,"sliderSize",.2);props!==null&&this.updateProperties(props)}setValue(touch){let max=this.max??this.curMax,value=0;this.orientation=="horizontal"&&(value=clamp((touch.rect.x-this.x-this.w*this.sliderSize/2)/(this.w*(1-this.sliderSize)),0,1)),this.orientation=="vertical"&&(value=clamp((touch.rect.y-this.y-this.h*this.sliderSize/2)/(this.h*(1-this.sliderSize)),0,1)),this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?value=value>.5?max/this.unboundedStopMultiple+(value-.5)/.5*(max-max/this.unboundedStopMultiple):this.min+value/.5*(max/this.unboundedStopMultiple-this.min):value=this.min+(max-this.min)*value,this.step!=null&&(value=Math.round(value/this.step)*this.step),this.value=value}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touch=!0,this.setValue(touch),!0):!1}updateMax(){this.max===null&&(this.curMax=this.unboundedStopMultiple*this.value)}on_touch_up(event,object,touch){return touch.grabbed!=this?super.on_touch_up(event,object,touch):(touch.ungrab(),!this.disable&&this.collide(touch.rect)&&(this._touching=!1,this.setValue(touch)),this.updateMax(),!0)}on_touch_move(event,object,touch){return touch.grabbed!==this?super.on_touch_move(event,object,touch):(this.disable||(this._touching=this.collide(touch.rect),this.setValue(touch)),!1)}draw(app,ctx){let ts=app.tileSize,r=this.rect;if(this.orientation=="horizontal"){r.w-=this.sliderSize*this.w,r.x+=this.sliderSize/2*this.w;let rad=Math.min(this.sliderSize/2*this.w,this.h/2)/2;ctx.strokeStyle=this.disable?this.disableColor1:this.bgColor,ctx.beginPath(),ctx.lineWidth=4/ts,ctx.moveTo(r.x,r.center_y),ctx.lineTo(r.right,r.center_y),ctx.stroke();let max=this.max??this.curMax,vPos;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?vPos=this.value>max/this.unboundedStopMultiple?(.5+.5*(this.value-max/this.unboundedStopMultiple)/(max-max/this.unboundedStopMultiple))*r.w:.5*(this.value-this.min)/(max/this.unboundedStopMultiple-this.min)*r.w:vPos=(this.value-this.min)/(max-this.min)*r.w,ctx.strokeStyle=this.disable?this.disableColor2:this.bgColor,ctx.beginPath(),ctx.arc(r.x+vPos,r.center_y,rad,0,2*Math.PI),ctx.stroke(),ctx.fillStyle=this.color,(this._touching||this.disable)&&(ctx.fillStyle=this.disable?this.disableColor1:this.selectColor),ctx.fill()}if(this.orientation=="vertical"){r.h-=this.sliderSize*this.h,r.y+=this.sliderSize/2*this.h;let rad=Math.min(this.sliderSize/2*this.h,this.w/2)/2;ctx.strokeStyle=this.disable?this.disableColor1:this.bgColor,ctx.beginPath(),ctx.lineWidth=4/ts,ctx.moveTo(r.center_x,r.y),ctx.lineTo(r.center_x,r.bottom),ctx.stroke();let max=this.max??this.curMax,vPos;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?vPos=this.value>max/this.unboundedStopMultiple?(.5+.5*(this.value-max/this.unboundedStopMultiple)/(max-max/this.unboundedStopMultiple))*r.h:.5*(this.value-this.min)/(max/this.unboundedStopMultiple-this.min)*r.h:vPos=(this.value-this.min)/(max-this.min)*r.h,ctx.strokeStyle=this.disable?this.disableColor2:this.bgColor,ctx.beginPath(),ctx.arc(r.center_x,r.y+vPos,rad,0,2*Math.PI),ctx.stroke(),ctx.fillStyle=this.color,(this._touching||this.disable)&&(ctx.fillStyle=this.disable?this.disableColor1:this.selectColor),ctx.fill()}}}class TextInput extends Label{constructor(properties={}){super();__publicField(this,"_activeDOMInput",null);__publicField(this,"focus",!0);__publicField(this,"disable",!1);__publicField(this,"_inputSanitizer");this._textData=null,properties!==null&&this.updateProperties(properties)}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,!0):(this.clearDOM(),!1)}on_touch_up(event,object,touch){return super.on_touch_up(event,object,touch)?!0:touch.grabbed!=this?!1:!this.disable&&this.collide(touch.rect)?(this._touching=!1,this.addDOMInput(),!0):(this.clearDOM(),!1)}on_layout(event,object,value){this.clearDOM()}DOMInputRect(){let r=this.rect,t=this.getTransformRecurse(),rt=new Rect,dp1=t.transformPoint(new DOMPoint(r.x,r.y)),dp2=t.transformPoint(new DOMPoint(r.right,r.bottom));return[rt.x,rt.y]=[dp1.x,dp1.y],[rt.w,rt.h]=[dp2.x,dp2.y],rt.w-=rt.x,rt.h-=rt.y,rt}addDOMInput(){if(!this._textData)return;App.get();let canvasdiv=document.getElementById("eskvapp");if(!canvasdiv)return;let type=this.wrap?"textarea":"input",inp=document.createElement(type);if(!(inp instanceof HTMLInputElement)&&!(inp instanceof HTMLTextAreaElement))return;let fs,rt=this.DOMInputRect(),color=this.color!=null?this.color:"white",bgColor=this.bgColor!=null?this.bgColor:"black";inp.style.color=color,fs=this._textData.size/this.h*rt.h/this._textData.outText.length,type=="textarea"&&this._textData.outText.length,inp.value=this.text,fs=(Math.floor(fs*100)/100).toString()+"px",inp.style.fontSize=fs,inp.style.backgroundColor=bgColor,inp.style.top=(Math.floor(rt.y*100)/100).toString()+"px",inp.style.left=(Math.floor(rt.x*100)/100).toString()+"px",inp.style.width=(Math.floor(rt.w*100)/100).toString()+"px",inp.style.height=(Math.floor(rt.h*100)/100).toString()+"px",inp.style.fontFamily=this.fontName,this._activeDOMInput=inp,canvasdiv.appendChild(inp),inp.addEventListener("focusout",event=>this.clearDOM()),inp.focus(),inp.select(),this.focus=!0}clearDOM(){if(this._activeDOMInput!=null){this.text=this._inputSanitizer?this._inputSanitizer(this._activeDOMInput.value,this):this._activeDOMInput.value;let inp=this._activeDOMInput;this._activeDOMInput=null,inp.remove(),this.focus=!1,this._needsLayout=!0;let iph=App.get().inputHandler;(iph==null?void 0:iph.grabbed)===this&&iph.ungrab()}}layoutChildren(){if(super.layoutChildren(),this._activeDOMInput!=null){let rt=this.DOMInputRect(),inp=this._activeDOMInput;inp.style.top=(Math.floor(rt.y*100)/100).toString()+"px",inp.style.left=(Math.floor(rt.x*100)/100).toString()+"px",inp.style.width=(Math.floor(rt.w*100)/100).toString()+"px",inp.style.height=(Math.floor(rt.h*100)/100).toString()+"px"}}}class ImageWidget extends Widget{constructor(props=null){super();__publicField(this,"bgColor",null);__publicField(this,"outlineColor",null);__publicField(this,"src",null);__publicField(this,"lockAspect",!0);__publicField(this,"scaleToFit",!0);__publicField(this,"antiAlias",!0);__publicField(this,"angle",0);__publicField(this,"anchor","center");__publicField(this,"mirror",!1);this.image=new Image,props!==null&&this.updateProperties(props),this.src&&(this.image.src=this.src)}on_src(event,object,data){this.src?this.image.src=this.src:this.image.src=""}layoutChildren(){this._layoutNotify&&this.emit("layout",null);let app=App.get();"w"in this.hints&&this.hints.w==null&&(this[2]=this.image.width/app.tileSize),"h"in this.hints&&this.hints.h==null&&(this[3]=this.image.height/app.tileSize),this._needsLayout=!1,super.layoutChildren()}draw(app,ctx){if(super.draw(app,ctx),!this.image.complete||this.image.naturalHeight==0)return;let r=this.rect;if(this.scaleToFit||(r.x+=r.w/2-this.image.width/2/app.tileSize,r.y+=r.h/2-this.image.height/2/app.tileSize,r.w=this.image.width/app.tileSize,r.h=this.image.height/app.tileSize),this.lockAspect){let srcAspect=this.image.height/this.image.width,dstAspect=r.h/r.w,rh=r.h,rw=r.w;srcAspect<dstAspect&&(rh=r.w*srcAspect),srcAspect>dstAspect&&(rw=r.h/srcAspect),r.x+=r.w/2-rw/2,r.y+=r.h/2-rh/2,r.w=rw,r.h=rh}ctx.save(),ctx.imageSmoothingEnabled=this.antiAlias;let anchor=this.anchor;anchor=="center"?anchor=[r.w/2,r.h/2]:anchor=[anchor[0]*r.w,anchor[1]*r.h],this.mirror&&ctx.scale(-1,1),ctx.translate(r.x+anchor[0],r.y+anchor[1]),this.angle!=0&&ctx.rotate(this.angle),ctx.translate(-anchor[0],-anchor[1]),ctx.drawImage(this.image,0,0,this.image.width,this.image.height,0,0,r.w,r.h),ctx.restore()}}class BoxLayout extends Widget{constructor(properties=null){super();__publicField(this,"spacingX",0);__publicField(this,"spacingY",0);__publicField(this,"paddingX",0);__publicField(this,"paddingY",0);__publicField(this,"orientation","vertical");__publicField(this,"order","forward");properties!==null&&this.updateProperties(properties)}*iterChildren(){if(this.order==="forward")for(let c of this._children)yield c;else for(let i=this._children.length-1;i>=0;i--)yield this._children[i]}on_numX(event,object,data){this._needsLayout=!0}on_numY(event,object,data){this._needsLayout=!0}on_spacingX(event,object,data){this._needsLayout=!0}on_spacingY(event,object,data){this._needsLayout=!0}on_paddingX(event,object,data){this._needsLayout=!0}on_paddingY(event,object,data){this._needsLayout=!0}on_orientation(event,object,data){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let spacingX=this.getMetric(this,"spacingX",this.spacingX),spacingY=this.getMetric(this,"spacingY",this.spacingY),paddingX=this.getMetric(this,"paddingX",this.paddingX),paddingY=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation==="vertical"){let num=this.children.length,h=this.h-spacingY*(num-1)-2*paddingY,w=this.w-2*paddingX,fixedh=0;for(let c of this.iterChildren())c.w=w,this.applyHints(c,w,h),"h"in c.hints&&(c.hints.h===null&&c.layoutChildren(),fixedh+=c.h,num--);let ch=(h-fixedh)/num,cw=w;(num===0&&h>0||ch<0)&&(paddingY=(h-fixedh)/2);let y=this.y+paddingY,x=this.x+paddingX;for(let c of this.iterChildren())c.y=y,"w"in c.hints||(c.w=cw),"h"in c.hints||(c.h=ch),!("x"in c.hints)&&!("center_x"in c.hints)&&!("right"in c.hints)&&(c.x=x,w!==c.w&&(c.x+=(w-c.w)/2)),c.layoutChildren(),y+=spacingY+c.h;if(num===0&&"h"in this.hints&&this.hints.h===null){const oldH=this[3];this[3]=y+2*paddingY-this.y,Math.abs(oldH-this[3])>1e-6&&(App.get()._needsLayout=!0)}return}if(this.orientation==="horizontal"){let num=this.children.length,h=this.h-2*paddingY,w=this.w-spacingX*(num-1)-2*paddingX,fixedw=0;for(let c of this.iterChildren())c.h=h,this.applyHints(c,w,h),"w"in c.hints&&(c.hints.w===null&&c.layoutChildren(),fixedw+=c.w,num--);let ch=h,cw=(w-fixedw)/num;(num===0&&w>0||cw<0)&&(paddingX=(w-fixedw)/2);let y=this.y+paddingY,x=this.x+paddingX;for(let c of this.iterChildren())c.x=x,"w"in c.hints||(c.w=cw),"h"in c.hints||(c.h=ch),!("y"in c.hints)&&!("center_y"in c.hints)&&!("bottom"in c.hints)&&(c.y=y,h!==c.h&&(c.y+=(h-c.h)/2)),c.layoutChildren(),x+=spacingX+c.w;if(num==0&&"w"in this.hints&&this.hints.w==null){const oldW=this[2];this[2]=x+2*paddingX-this.x,Math.abs(oldW-this[2])>1e-6&&(App.get()._needsLayout=!0)}}}}class Notebook extends Widget{constructor(properties=null){super();__publicField(this,"activePage",0);properties!==null&&this.updateProperties(properties)}on_wheel(event,object,wheel){const ch=this.children[this.activePage]??void 0;return!!(ch!==void 0&&ch.emit(event,wheel))}on_touch_down(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_up(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_move(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_cancel(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_activePage(e,o,v){this._needsLayout=!0}_draw(app,ctx,millis){this.draw(app,ctx);let transform=this.getTransform();if(transform){ctx.save(),ctx.transform(transform.a,transform.b,transform.c,transform.d,transform.e,transform.f);let w2=this.children[this.activePage]??void 0;w2!==void 0&&w2._draw(app,ctx,millis),ctx.restore();return}let w=this.children[this.activePage]??void 0;w!==void 0&&w._draw(app,ctx,millis)}}class TabbedNotebook extends Notebook{constructor(properties=null){super();__publicField(this,"tabHeightHint","1");__publicField(this,"tabGroupName","tabbedNotebookGroup");this.buttonBox=new BoxLayout({orientation:"horizontal",hints:{h:this.tabHeightHint,w:null}}),this.buttonScroller=new ScrollView({id:"_scrollview",hints:{h:this.tabHeightHint,w:1},children:[this.buttonBox]}),this._children=[this.buttonScroller],this.buttonScroller.parent=this,properties!==null&&this.updateProperties(properties),this.updateButtons()}on_tabHeightHint(e,o,v){this.buttonBox.hints.h=this.tabHeightHint}on_child_added(e,o,v){this.updateButtons()}on_child_removed(e,o,v){this.updateButtons()}on_wheel(event,object,wheel){const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,wheel))return!0;const ch=this.children[this.activePage]??void 0;return!!(ch!==void 0&&ch.emit(event,wheel))}on_touch_down(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,t))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,touch))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_up(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,t))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,touch))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_move(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,t))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,touch))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_cancel(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,t))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,touch))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}get children(){return this._children.slice(1)}set children(children){for(let c of this._children.slice(1))this.emit("child_removed",c),c.parent=null,this._needsLayout=!0,this.updateButtons();this._children=this._children.slice(0,1);for(let c of children)this.addChild(c)}updateButtons(){this.buttonBox.children=[];let i=0;for(let page of this.children){const tb=new ToggleButton({text:page.name??String(i+1),group:this.tabGroupName,singleSelect:!0,press:this.activePage===i,fontSize:"0.5",hints:{h:null,w:null}});tb.bind("press",(e,o,v)=>{this.activePage=this.buttonBox.children.findIndex(w=>w===o)}),this.buttonBox.addChild(tb),i++}}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;const bb=this._children[0];this.applyHints(bb),bb.x=this.x,bb.y=this.y,bb.layoutChildren();const h=this.h-bb.h,w=this.w;for(let c of this.children)c.y=this.y+bb.h,c.x=this.x,c.w=w,c.h=h,c.layoutChildren()}_draw(app,ctx,millis){this.draw(app,ctx);let transform=this.getTransform();if(transform){ctx.save(),ctx.transform(transform.a,transform.b,transform.c,transform.d,transform.e,transform.f);let bb2=this._children[0]??void 0;bb2!==void 0&&bb2._draw(app,ctx,millis);let w2=this.children[this.activePage]??void 0;w2!==void 0&&w2._draw(app,ctx,millis),ctx.restore();return}let bb=this._children[0]??void 0;bb!==void 0&&bb._draw(app,ctx,millis);let w=this.children[this.activePage]??void 0;w!==void 0&&w._draw(app,ctx,millis)}}class GridLayout extends Widget{constructor(properties=null){super();__publicField(this,"numX",1);__publicField(this,"numY",1);__publicField(this,"spacingX",0);__publicField(this,"spacingY",0);__publicField(this,"paddingX",0);__publicField(this,"paddingY",0);__publicField(this,"orientation","horizontal");properties!==null&&this.updateProperties(properties)}on_numX(event,object,string){this._needsLayout=!0}on_numY(event,object,string){this._needsLayout=!0}on_spacingX(event,object,string){this._needsLayout=!0}on_spacingY(event,object,string){this._needsLayout=!0}on_paddingX(event,object,string){this._needsLayout=!0}on_paddingY(event,object,string){this._needsLayout=!0}on_orientation(event,object,string){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let spacingX=this.getMetric(this,"spacingX",this.spacingX),spacingY=this.getMetric(this,"spacingY",this.spacingY),paddingX=this.getMetric(this,"paddingX",this.paddingX),paddingY=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation=="horizontal"){let numX=this.numX,numY=Math.ceil(this.children.length/this.numX),h=this.h-spacingY*(numY-1)-2*paddingY,w=this.w-spacingX*(numX-1)-2*paddingX,_colWidths=new Array(numX).fill(0),_rowHeights=new Array(numY).fill(0),r=0,c=0,i=0;for(let ch2 of this.children)this.applyHints(ch2,w,h),"w"in ch2.hints&&(_colWidths[c]=Math.max(ch2.w,_colWidths[c])),"h"in ch2.hints&&(_rowHeights[r]=Math.max(ch2.h,_rowHeights[r])),(i+1)%numX==0?(r++,c=0):c++,i++;let fixedW=0,fixedH=0,nfX=0,nfY=0;for(let cw2 of _colWidths)fixedW+=cw2,cw2>0&&nfX++;for(let rh of _rowHeights)fixedH+=rh,rh>0&&nfY++;let ch=numY>nfY?(h-fixedH)/(numY-nfY):0,cw=numX>nfX?(w-fixedW)/(numX-nfX):0,y=this.y+paddingY,x=this.x+paddingX;r=0,c=0;for(let i2=0;i2<this.children.length;i2++){let el=this.children[i2],cw0=_colWidths[c]==0?cw:_colWidths[c],ch0=_rowHeights[r]==0?ch:_rowHeights[r];"w"in el.hints||(el.w=cw0),"h"in el.hints||(el.h=ch0),el.x=x,el.y=y,el.layoutChildren(),(i2+1)%numX==0?(x=this.x+paddingX,y+=spacingY+ch0,c=0,r++):(x+=spacingX+cw0,c++)}return}else{let numX=Math.ceil(this.children.length/this.numY),numY=this.numY,h=this.h-spacingY*(numY-1)-2*paddingY,w=this.w-spacingX*(numX-1)-2*paddingX,_colWidths=new Array(numX).fill(0),_rowHeights=new Array(numY).fill(0),r=0,c=0,i=0;for(let ch2 of this.children)this.applyHints(ch2,w,h),"w"in ch2.hints&&(_colWidths[c]=Math.max(ch2.w,_colWidths[c])),"h"in ch2.hints&&(_rowHeights[r]=Math.max(ch2.h,_rowHeights[r])),(i+1)%numY==0?(c++,r=0):r++,i++;let fixedW=0,fixedH=0,nfX=0,nfY=0;for(let cw2 of _colWidths)fixedW+=cw2,cw2>0&&nfX++;for(let rh of _rowHeights)fixedH+=rh,rh>0&&nfY++;let ch=numY>nfY?(h-fixedH)/(numY-nfY):0,cw=numX>nfX?(w-fixedW)/(numX-nfX):0,y=this.y+paddingY,x=this.x+paddingX;r=0,c=0;for(let i2=0;i2<this.children.length;i2++){let el=this.children[i2],cw0=_colWidths[c]==0?cw:_colWidths[c],ch0=_rowHeights[r]==0?ch:_rowHeights[r];"w"in el.hints||(el.w=cw0),"h"in el.hints||(el.h=ch0),el.x=x,el.y=y,el.layoutChildren(),(i2+1)%numY==0?(y=this.y+paddingY,x+=spacingX+cw0,r=0,c++):(y+=spacingY+ch0,r++)}}}}class ScrollView extends Widget{constructor(properties=null){super();__publicField(this,"_scrollX",0);__publicField(this,"_scrollY",0);__publicField(this,"scrollX",0);__publicField(this,"scrollY",0);__publicField(this,"scrollW",!0);__publicField(this,"scrollH",!0);__publicField(this,"wAlign","center");__publicField(this,"hAlign","top");__publicField(this,"uiZoom",!0);__publicField(this,"uiMove",!0);__publicField(this,"zoom",1);__publicField(this,"vel",null);__publicField(this,"velCutoff",1e-5);__publicField(this,"velDecay",.95);__publicField(this,"unboundedH",!1);__publicField(this,"unboundedW",!1);__publicField(this,"_zoomCenter",null);properties!==null&&this.updateProperties(properties),this._processTouches=!0,this._oldTouch=null,this._lastDist=null}on_child_added(event,object,child){this.children.length==1&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0,child.bind("rect",(event2,obj,data)=>this._needsLayout=!0),child.bind("w",(event2,obj,data)=>this._needsLayout=!0),child.bind("h",(event2,obj,data)=>this._needsLayout=!0))}on_child_removed(event,object,child){this.children.length==0&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.children[0][0]=0,this.children[0][1]=0,this.scrollW||(this.children[0][2]=this.w),this.scrollH||(this.children[0][3]=this.h);for(let c of this.children)c.layoutChildren()}fitToClient(){this.zoom=Math.min(this.w/this.children[0].w,this.h/this.children[0].h),this.scrollX=.5*this.scrollableW,this.scrollY=.5*this.scrollableH}on_uiZoom(event,object,value){this._needsLayout=!0}on_hAlign(event,object,value){this._needsLayout=!0}on_vAlign(event,object,value){this._needsLayout=!0}*iter(recursive=!0,inView=!0){if(yield this,!!recursive)if(inView)for(let c of this._children)this.contains(c)&&(yield*c.iter(...arguments));else for(let c of this._children)yield*c.iter(...arguments)}on_scrollW(event,object,value){this._needsLayout=!0,this.scrollX=0}on_scrollH(event,object,value){this._needsLayout=!0,this.scrollY=0}on_scrollX(event,object,value){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedW){this._scrollX=this.scrollX;return}let align=0;switch(this.wAlign){case"center":align=.5*this.scrollableW;break;case"right":align=1*this.scrollableW}this._scrollX=this.scrollableW<=0||this.scrollableW>=this.children[0].w?align:value,this._scrollX=clamp(value,0,this.scrollableW)}on_scrollY(event,object,value){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedH){this._scrollY=this.scrollY;return}let align=0;switch(this.hAlign){case"middle":align=.5*this.scrollableH;break;case"bottom":align=1*this.scrollableH}this._scrollY=this.scrollableH<=0||this.scrollableH>=this.children[0].h?align:value,this._scrollY=clamp(value,0,this.scrollableH)}update(app,millis){if(super.update(app,millis),this.vel!==null){this.scrollX+=this.vel.x*millis,this.scrollY+=this.vel.y*millis,this.vel=this.vel.scale(this.velDecay**(millis/30));let a=this.vel.abs();a.x<=this.velCutoff/this.zoom&&a.y<=this.velCutoff/this.zoom&&(this.vel=null)}}getTransform(){const ts=App.get().tileSize;return new DOMMatrix().translate(Math.floor((this.x-this._scrollX*this.zoom)*ts)/ts,Math.floor((this.y-this._scrollY*this.zoom)*ts)/ts).scale(this.zoom,this.zoom)}on_touch_down(event,object,touch){this.vel=null;let r=touch.rect;if(this._lastDist=null,this.collide(r)){let millis=Date.now(),tl=touch.asChildTouch(this);return this._oldTouch=[tl.x,tl.y,tl.identifier,millis,null],super.on_touch_down(event,object,touch)||touch.grab(this),!0}return!1}on_touch_up(event,object,touch){if(touch.grabbed!==this)return!1;if(this._oldTouch!=null){let ovel=this._oldTouch[4],tl=new Vec22([this._oldTouch[0],this._oldTouch[1]]),tln=touch.asChildTouch(this),millis=Math.max(Date.now()-this._oldTouch[3],1),vx=this.scrollableW>0||this.unboundedW?(tln.x-tl.x)/millis:0,vy=this.scrollableH>0||this.unboundedH?(tln.y-tl.y)/millis:0;this.vel=new Vec22([-vx,-vy]),ovel&&(this.vel=this.vel.add(ovel).scale(.5))}return this._oldTouch=null,this._lastDist=null,this._zoomCenter=null,touch.ungrab(),!1}on_touch_move(event,object,touch){if(touch.grabbed!==this)return!1;let r=touch.rect;if(this.collide(r)){let tl=touch.asChildTouch(this);if((this.uiMove&&touch.nativeEvent==null||touch.nativeEvent instanceof TouchEvent&&touch.nativeEvent.touches.length==1)&&this._oldTouch!=null&&touch.identifier==this._oldTouch[2]){this.scrollW&&(this.scrollX=this.scrollableW==0?0:this._scrollX+(this._oldTouch[0]-tl.x)),this.scrollH&&(this.scrollY=this.scrollableH==0?0:this._scrollY+(this._oldTouch[1]-tl.y));let tln=touch.asChildTouch(this),ot=this._oldTouch,time=Date.now(),vel=new Vec22([0,0]),ovel=new Vec22([0,0]);if(ot!=null){let millis=Math.max(time-ot[3],1),vx=this.scrollableW>0||this.unboundedW?(tln.x-tl.x)/millis:0,vy=this.scrollableH>0||this.unboundedH?(tln.y-tl.y)/millis:0;vel=new Vec22([vx,vy]),ovel=ot[4]!==null?ot[4]:ovel}let nvel=vel.abs().sum()===0?vel:vel.add(ovel).scale(.5);this._oldTouch=[tln.x,tln.y,touch.identifier,time,nvel]}if(this.uiZoom&&touch.nativeEvent&&touch.nativeEvent instanceof TouchEvent&&touch.nativeEvent.touches.length==2){let t0=touch.nativeEvent.touches[0],t1=touch.nativeEvent.touches[1],d=dist([t0.clientX,t0.clientY],[t1.clientX,t1.clientY]);if(this._lastDist!=null){let scrollPosCenterW=this._scrollX+this.w/this.zoom/2,scrollPosCenterH=this._scrollY+this.h/this.zoom/2,touchPixelPos0=[t0.clientX,t0.clientY],touchPixelPos1=[t1.clientX,t1.clientY],scrollableTouchPosBefore0=this.appToChild(touchPixelPos0),scrollableTouchPosBefore1=this.appToChild(touchPixelPos1),sTargetCenterPosBefore=[(scrollableTouchPosBefore0[0]+scrollableTouchPosBefore1[0])/2,(scrollableTouchPosBefore0[1]+scrollableTouchPosBefore1[1])/2];this._zoomCenter===null&&(this._zoomCenter=new Vec22(sTargetCenterPosBefore));let zoom=this.zoom*d/this._lastDist,minZoom=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(zoom,minZoom);let scrollableTouchPosAfter0=this.appToChild(touchPixelPos0),scrollableTouchPosAfter1=this.appToChild(touchPixelPos1),sTargetCenterPosAfter=[(scrollableTouchPosAfter0[0]+scrollableTouchPosAfter1[0])/2,(scrollableTouchPosAfter0[1]+scrollableTouchPosAfter1[1])/2];this.scrollX=scrollPosCenterW+sTargetCenterPosBefore[0]-sTargetCenterPosAfter[0]-this.w/this.zoom/2,this.scrollY=scrollPosCenterH+sTargetCenterPosBefore[1]-sTargetCenterPosAfter[1]-this.h/this.zoom/2}this._lastDist=d}}return!1}on_touch_cancel(event,object,touch){return this._lastDist=null,touch.grabbed===this?(touch.ungrab(),!0):!!super.on_touch_cancel(event,object,touch)}on_wheel(event,object,touch){let app=App.get();if(!app.inputHandler)return!0;let sx=this._scrollX+this.w/this.zoom/2,sy=this._scrollY+this.h/this.zoom/2,wheel=touch.nativeObject;if(!this.collide(touch.rect)&&(!this.unboundedW||!this.unboundedH)||!(wheel instanceof WheelEvent))return!1;if(this.uiZoom&&app.inputHandler.isKeyDown("Control")){let loc=touch.asChildTouch(this);loc.pos[0],loc.pos[1];let zoom=this.zoom*Math.exp(-wheel.deltaY/app.h),minZoom=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(zoom,minZoom);let moc=touch.asChildTouch(this);return moc.pos[0],moc.pos[1],this.scrollX=this.scrollableW==0&&!this.unboundedW?0:sx-this.w/this.zoom/2,this.scrollY=this.scrollableH==0&&!this.unboundedH?0:sy-this.h/this.zoom/2,this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}else{if(this.uiMove&&this.scrollW&&app.inputHandler.isKeyDown("Shift"))return this.scrollX+=this.scrollableW==0&&!this.unboundedW?0:this.w/this.zoom*(wheel.deltaY/app.w),this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),!0;if(this.uiMove&&this.scrollH)return this.scrollY+=this.scrollableH==0&&!this.unboundedH?0:this.h/this.zoom*(wheel.deltaY/app.h),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}return!1}get scrollableW(){return this.children.length==0?0:this.unboundedW?this.children[0].w-this.w/this.zoom:Math.max(this.children[0].w-this.w/this.zoom,0)}get scrollableH(){return this.children.length==0?0:this.unboundedH?this.children[0].h-this.h/this.zoom:Math.max(this.children[0].h-this.h/this.zoom,0)}_draw(app,ctx,millis){this.draw(app,ctx);let r=this.rect;r[0]=Math.floor(r[0]*app.tileSize*app.pixelSize)/(app.tileSize*app.pixelSize),r[1]=Math.floor(r[1]*app.tileSize*app.pixelSize)/(app.tileSize*app.pixelSize),r[2]=Math.floor(r[2]*app.tileSize*app.pixelSize)/(app.tileSize*app.pixelSize),r[3]=Math.floor(r[3]*app.tileSize*app.pixelSize)/(app.tileSize*app.pixelSize),ctx.save(),ctx.beginPath(),ctx.rect(r[0],r[1],r[2],r[3]),ctx.clip();let newT=this.getTransform();newT&&ctx.transform(newT.a,newT.b,newT.c,newT.d,newT.e,newT.f),this.children[0]._draw(app,ctx,millis),ctx.restore()}}class ModalView extends BoxLayout{constructor(properties=null){super();__publicField(this,"closeOnTouchOutside",!0);__publicField(this,"bgColor","slate");__publicField(this,"outlineColor","gray");__publicField(this,"dim",!0);__publicField(this,"dimScale",.8);properties!==null&&this.updateProperties(properties)}get visible(){return App.get()._modalWidgets.indexOf(this)>=0}popup(){if(this.parent==null){let app=App.get();return this.parent=app,app.addModal(this),!0}return!1}close(exitVal=0){if(this.parent!=null){this.emit("close",exitVal);let app=App.get();return this.parent=null,app.removeModal(this),!0}return!1}on_touch_down(event,object,touch){return this.closeOnTouchOutside&&!this.collide(touch.rect)?(this.close(),!0):super.on_touch_down(event,object,touch)}draw(app,ctx){if(this.dim){let r=App.get().baseWidget.rect,ctx2=App.get().ctx;if(!ctx2)return;ctx2.fillStyle="rgba(0,0,0,"+this.dimScale+")",ctx2.rect(r[0],r[1],r[2],r[3]),ctx2.fill(),super.draw(app,ctx2)}}}class LayeredAnimationFrame extends Array{constructor(frames,offsets){super();for(let i=0;i<frames.length;++i)offsets[i]?this.push(frames[i],offsets[i][0],offsets[i][1]):this.push(frames[i],0,0)}*iter(){for(let i=0;i<this.length/3;i++)yield[this[i*3],this[i*3+1],this[i*3+2]]}}class SpriteWidget extends Widget{constructor(props={}){super();__publicField(this,"spriteSheet",null);__publicField(this,"frames",[]);__publicField(this,"timePerFrame",30);__publicField(this,"timeLeft",0);__publicField(this,"activeFrame",0);__publicField(this,"id","");__publicField(this,"facing",0);__publicField(this,"flipX",!1);__publicField(this,"flipY",!1);__publicField(this,"oneShot",!1);props&&this.updateProperties(props)}update(app,millis){if(super.update(app,millis),this.timeLeft-=millis,this.timeLeft<=0){if(this.oneShot&&this.activeFrame===this.frames.length-1){this.timeLeft=1/0,this.emit("animationComplete",this.activeFrame);return}this.activeFrame++,this.activeFrame>=this.frames.length&&(this.activeFrame=0),this.timeLeft+=this.timePerFrame}this.frames.length>0&&this.timeLeft!==1/0&&app.requestFrameUpdate()}restart(){this.activeFrame=0,this.timeLeft=this.timePerFrame}on_frames(e,o,v){this.restart()}get frame(){return this.frames[this.activeFrame]??-1}draw(app,ctx){var _a;if(this.spriteSheet===null||!((_a=this.spriteSheet.sheet)!=null&&_a.complete))return;const tx=Math.floor(this.x*this.spriteSheet.spriteSize)/this.spriteSheet.spriteSize,ty=Math.floor(this.y*this.spriteSheet.spriteSize)/this.spriteSheet.spriteSize;if(ctx.translate(tx,ty),ctx.scale(this.w,this.h),this.frame instanceof LayeredAnimationFrame)for(let[f,dx,dy]of this.frame.iter())this.spriteSheet.drawIndexed(ctx,f,0,0,this.facing,this.flipX,dx,dy);else this.spriteSheet.drawIndexed(ctx,this.frame,0,0,this.facing,this.flipX);ctx.scale(1/this.w,1/this.h),ctx.translate(-tx,-ty)}}class TileMap extends Widget{constructor(props={}){super(),this.defaultValue=-1,this._data=new Grid2D,this._vLayer=null,this._aLayer=null,this._cacheTileDim=new Vec22,this.tileDim=new Vec22,this.hints={w:null,h:null},this.spriteSheet=null,this.clipRegion=null,this.alphaValue=.5,this.useCache=!0,props&&this.updateProperties(props)}serialize(){const data={};return data._data=this._data.slice(),data.tileDim=this.tileDim.slice(),data.spriteSheet=Array(...App.resources.keys()).find(k=>App.resources[k]===this.spriteSheet)??null,data}get(pos){return this._data.get(pos)}set(pos,value){this._data.set(pos,value),this._data._cacheData=null}get data(){return this._data}deserialize(data){this.tileDim=new Vec22(data.tileDim??[0,0]);const _data=data._data;for(let i=0;i<_data.length;i++)this._data[i]=_data[i];this.spriteSheet=App.resources[data.spriteSheet]??null,this._data._cacheData=null}on_tileDim(evt,obj,val){this.resizeData(),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new Vec22(this.tileDim)}resizeData(){let cacheData=[];for(let y=0;y<this._cacheTileDim[1];y++)for(let x=0;x<this._cacheTileDim[0];x++)cacheData.push(this.get([x,y]));this._data.tileDim=new Vec22(this.tileDim),this._data.length=this.tileDim[0]*this.tileDim[1],this._data.fill(this.defaultValue);let i=0;for(let y=0;y<this._cacheTileDim[1];y++)for(let x=0;x<this._cacheTileDim[0];x++)x<this.tileDim[0]&&y<this.tileDim[1]&&this.set([x,y],cacheData[i]),++i;this._data._cacheData=null}draw(app,ctx){if(super.draw(app,ctx),this.spriteSheet===null||!this.spriteSheet.sheet.complete||!this.spriteSheet.sheet.complete||this.spriteSheet.sheet.naturalHeight==0)return;let[x0,y0]=[0,0],[x1,y1]=this.tileDim;if(this.clipRegion&&([x0,y0]=this.clipRegion.pos,[x1,y1]=this.clipRegion.pos.add(this.clipRegion.size).add([1,1]),x0=Math.min(Math.max(x0,0),this.tileDim[0]),x1=Math.min(Math.max(x1,0),this.tileDim[0]),y0=Math.min(Math.max(y0,0),this.tileDim[1]),y1=Math.min(Math.max(y1,0),this.tileDim[1])),Math.floor(this.spriteSheet.sheet.width/this.spriteSheet.spriteSize),Math.floor(this.spriteSheet.sheet.height/this.spriteSheet.spriteSize),this.useCache){if(this._data._cacheData===null&&this.cacheCanvas(),this._data._cacheData===null)return;const s=this.spriteSheet.spriteSize;if(ctx.drawImage(this._data._cacheData,s*x0,s*y0,s*(x1-x0),s*(y1-y0),this.x+x0,this.y+y0,x1-x0,y1-y0),this._aLayer===null&&this._vLayer===null)for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=this._data[p];ind<-1&&this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y)}else if(this._aLayer&&this._vLayer){const aL=this._aLayer,vL=this._vLayer,origAlpha=ctx.globalAlpha,dat=this._data;for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=dat[p];ind<-1&&vL[p]>0&&(aL[p]===0?(ctx.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y),ctx.globalAlpha=origAlpha):this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y))}}}else if(this._aLayer===null&&this._vLayer===null)for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=this._data[p];this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y)}else if(this._aLayer&&this._vLayer){const aL=this._aLayer,vL=this._vLayer,origAlpha=ctx.globalAlpha,dat=this._data;for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=dat[p];ind!==-1&&vL[p]>0&&(aL[p]===0?(ctx.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y),ctx.globalAlpha=origAlpha):this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y))}}}clearCache(){this.data._cacheData=null}cacheCanvas(){if(this._data._cacheData=null,!this.spriteSheet||!this.spriteSheet.sheet||this.tileDim[0]<=0||this.tileDim[1]<=0)return;const _cacheData=new OffscreenCanvas(this.tileDim[0]*this.spriteSheet.spriteSize,this.tileDim[1]*this.spriteSheet.spriteSize),cacheCtx=_cacheData.getContext("2d");if(!cacheCtx)return;cacheCtx.scale(this.spriteSheet.spriteSize,this.spriteSheet.spriteSize);let[x0,y0]=[0,0],[x1,y1]=this.tileDim;if(this._aLayer===null&&this._vLayer===null)for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=this._data[p];ind>=0&&this.spriteSheet.drawIndexed(cacheCtx,ind,x,y)}else if(this._aLayer&&this._vLayer){const aL=this._aLayer,vL=this._vLayer,origAlpha=cacheCtx.globalAlpha,dat=this._data;for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=dat[p];ind>=0&&vL[p]>0&&(aL[p]===0?(cacheCtx.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(cacheCtx,ind,x,y),cacheCtx.globalAlpha=origAlpha):this.spriteSheet.drawIndexed(cacheCtx,ind,x,y))}}this._data._cacheData=_cacheData}}class LayeredTileMap extends TileMap{constructor(props={}){super(),this._layerData=[this._data],this.numLayers=1,this.activeLayer=0,this.visibilityLayer=-1,this.alphaLayer=-1,props&&this.updateProperties(props)}on_alphaLayer(e,o,v){this._aLayer=this.alphaLayer>=0?this._layerData[this.alphaLayer]:null}on_visibilityLayer(e,o,v){this._vLayer=this.visibilityLayer>=0?this._layerData[this.visibilityLayer]:null}serialize(){const data={},layerCopy=[];for(let l of this._layerData)layerCopy.push(l.slice());return data._layerData=layerCopy,data.activeLayer=this.activeLayer,data.numLayers=this.numLayers,data.tileDim=this.tileDim.slice(),data.spriteSheet=Array(...App.resources.keys()).find(k=>App.resources[k]===this.spriteSheet)??null,data}deserialize(data){this.numLayers=data.numLayers,this.activeLayer=data.activeLayer,this.tileDim=new Vec22(data.tileDim??[0,0]);const n=data._layerData.length;this._layerData.length=n;for(let i=0;i<n;i++){const lout=this._layerData[i],lin=data._layerData[i];for(let j=0;j<lin.lenth;j++)lout[j]=lin[j]}this.spriteSheet=App.resources[data.spriteSheet]??null,this.clearCache()}on_tileDim(evt,obj,val){if("_layerData"in this){for(let l of this._layerData)this._data=l,this.resizeData();this.activeLayer>=0&&(this._data=this._layerData[this.activeLayer]),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new Vec22(this.tileDim)}}on_numLayers(evt,obj,val){const oldLen=this._layerData.length;this._layerData.length=this.numLayers;for(let i=oldLen;i<this.numLayers;i++){const layer=new Grid2D(this.tileDim).fill(this.defaultValue);this._layerData[i]=layer}this.activeLayer>=this.numLayers&&(this.activeLayer=this.numLayers-1)}on_activeLayer(evt,obj,val){this._data=this._layerData[this.activeLayer]}get layer(){return this._layerData}getFromLayer(layer,pos){return this._layerData[layer][pos[0]+pos[1]*this.tileDim[0]]}setInLayer(layer,pos,val){this._layerData[layer][pos[0]+pos[1]*this.tileDim[0]]=val,this._layerData[layer]._cacheData=null}clearCache(){for(let l of this._layerData)l._cacheData=null}draw(app,ctx){for(let l of this._layerData)l.hidden||(this._data=l,super.draw(app,ctx));this._data=this._layerData[this.activeLayer]}}App.registerClass("Widget",Widget,"");App.registerClass("App",App,"");App.registerClass("Label",Label,"");App.registerClass("Button",Button,"");App.registerClass("ToggleButton",ToggleButton,"");App.registerClass("BasicButton",BasicButton,"");App.registerClass("TextInput",TextInput,"");App.registerClass("CheckBox",CheckBox,"");App.registerClass("Slider",Slider,"");App.registerClass("ImageWidget",ImageWidget,"");App.registerClass("BoxLayout",BoxLayout,"");App.registerClass("GridLayout",GridLayout,"");App.registerClass("ScrollView",ScrollView,"");App.registerClass("ModalView",ModalView,"");App.registerClass("Notebook",Notebook,"");App.registerClass("TabbedNotebook",TabbedNotebook,"");App.registerClass("SpriteWidget",SpriteWidget,"");App.registerClass("TileMap",TileMap,"");App.registerClass("LayeredTileMap",LayeredTileMap,"");class FPS extends Label{constructor(){super(...arguments);__publicField(this,"_counter",0);__publicField(this,"_frames",0);__publicField(this,"_worst",300);__publicField(this,"_tref",Date.now());__publicField(this,"_badFrameCount",0)}update(app,millis){super.update(app,millis);const tref=app.now;this._counter+=tref-this._tref,this._frames+=1;const currentFPS=1e3/(tref-this._tref);this._tref=tref,this._badFrameCount+=currentFPS<50?1:0,currentFPS<this._worst&&(this._worst=currentFPS),this._counter>=1e3&&(this.text=`FPS: ${Math.round(this._frames/this._counter*1e3)} (worst: ${Math.round(this._worst)}, # >20ms: ${Math.round(this._badFrameCount)})`,this._counter=0,this._frames=0,this._worst=300,this._badFrameCount=0)}}class ScoreBoard extends BoxLayout{constructor(game,homeName,awayName){super({orientation:"horizontal",hints:{x:.02,y:.02,w:.5,h:.14},bgColor:"#0008"}),this.game=game,this.labels={homeName:new Label({text:"0",align:"left",color:"white"}),homeGoals:new Label({text:"0",align:"center",color:"white"}),homeBehinds:new Label({text:"0",align:"center",color:"white"}),homeTotal:new Label({text:"0",align:"center",color:"white"}),awayName:new Label({text:"0",align:"left",color:"white"}),awayGoals:new Label({text:"0",align:"center",color:"white"}),awayBehinds:new Label({text:"0",align:"center",color:"white"}),awayTotal:new Label({text:"0",align:"center",color:"white"}),timer:new Label({text:`Q1
20:00`,align:"center",color:"white",valign:"bottom",wrap:!0,hints:{x:0,y:0,w:.2,h:1}})};const grid=new GridLayout({numX:4});grid.children=[new Label({text:"",align:"left",color:"white"}),new Label({text:"G",align:"center",color:"white"}),new Label({text:"B",align:"center",color:"white"}),new Label({text:"T",align:"center",color:"white"}),this.labels.homeName,this.labels.homeGoals,this.labels.homeBehinds,this.labels.homeTotal,this.labels.awayName,this.labels.awayGoals,this.labels.awayBehinds,this.labels.awayTotal],this.children=[this.labels.timer,grid],this.homeName=homeName,this.awayName=awayName,this.homeGoal=0,this.homeBehind=0,this.awayGoal=0,this.awayBehind=0,this.quarter=1,this.timeLeft=300,this.updateProperties({})}on_homeName(event,object,value){this.labels.homeName.text=value}on_awayName(event,object,value){this.labels.awayName.text=value}on_homeGoal(event,obj,value){this.labels.homeGoals.text=value.toString(),this.labels.homeTotal.text=(value*6+this.homeBehind).toString()}on_homeBehind(event,obj,value){this.labels.homeBehinds.text=value.toString(),this.labels.homeTotal.text=(this.homeGoal*6+value).toString()}on_awayGoal(event,obj,value){this.labels.awayGoals.text=value.toString(),this.labels.awayTotal.text=(value*6+this.awayBehind).toString()}on_awayBehind(event,obj,value){this.labels.awayBehinds.text=value.toString(),this.labels.awayTotal.text=(this.awayGoal*6+value).toString()}on_timeLeft(_,__,value){const min=Math.floor(value/60).toString().padStart(2,"0"),sec=Math.floor(value%60).toString().padStart(2,"0");this.labels.timer.text=`Q${this.quarter}
${min}:${sec}`}on_quarter(_,__,value){const min=Math.floor(this.timeLeft/60).toString().padStart(2,"0"),sec=Math.floor(this.timeLeft%60).toString().padStart(2,"0");this.labels.timer.text=`Q${value}
${min}:${sec}`}resetScores(){this.homeGoal=0,this.homeBehind=0,this.awayGoal=0,this.awayBehind=0}getData(){return{home:{g:this.homeGoal,b:this.homeBehind,t:this.homeGoal*6+this.homeBehind},away:{g:this.awayGoal,b:this.awayBehind,t:this.awayGoal*6+this.awayBehind}}}on_touch_down(event,object,touch){return this.collide(touch.rect)?(this.game.baseWidget.addChild(new PauseMenu(this.game)),this.game.gameActive=!1,!0):!1}}class PauseMenu extends BoxLayout{constructor(game){super({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,y:.2,w:.4,h:.4},bgColor:"rgba(0,0,0,0.5)",outlineColor:"rgba(255,255,255,1)"}),this.game=game,game.gameActive=!1,this.children=[new Label({text:"Pie Break",color:"rgba(192, 50, 50, 1)",hints:{h:.5}}),new Button({text:"Continue",sizeGroup:"menuButton",on_press:()=>this.continue(),hints:{w:.8}}),new Button({text:"Exit to menu",sizeGroup:"menuButton",on_press:()=>this.exitToMenu(),hints:{w:.8}})],this.updateProperties({})}continue(){this.parent&&(this.game.gameActive=!0,this.parent.children=this.parent.children.filter(w=>w!==this))}exitToMenu(){this.parent&&this.game.endGame()}}class MainMenu extends BoxLayout{constructor(game){super({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,y:.2,w:.4,h:.6},bgColor:"rgba(0,0,0,0.5)",outlineColor:"rgba(255,255,255,1)"}),this.game=game,game.gameActive=!1,this.children=[new Label({text:"The Footy",color:"rgba(192, 50, 50, 1)",hints:{h:.3}}),new Button({text:"Quick Play",sizeGroup:"menuButton",on_press:()=>this.openQuickPlay(),hints:{w:.8}}),new Button({text:"Tournament",sizeGroup:"menuButton",on_press:()=>this.openTournament(),hints:{w:.8}}),new Button({text:"Career",sizeGroup:"menuButton",on_press:()=>this.openCareer(),hints:{w:.8}}),new Button({text:"Options",sizeGroup:"menuButton",on_press:()=>this.openOptions(),hints:{w:.8}})],this.updateProperties({})}openQuickPlay(){this.parent&&(this.parent.addChild(new QuickPlayMenu(this.game)),this.parent.children=this.parent.children.filter(w=>w!==this))}openTournament(){this.parent&&(this.parent.addChild(new TournamentMenu(this.game)),this.parent.children=this.parent.children.filter(w=>w!==this))}openCareer(){this.parent&&(this.parent.addChild(new CareerMenu(this.game)),this.parent.children=this.parent.children.filter(w=>w!==this))}openOptions(){this.parent&&(this.parent.addChild(new OptionsMenu(this.game)),this.parent.children=this.parent.children.filter(w=>w!==this))}}class QuickPlayMenu extends BoxLayout{constructor(game){super({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,y:.2,w:.4,h:.6},bgColor:"rgba(0,0,0,0.5)",outlineColor:"rgba(255,255,255,1)"}),this.game=game,this.timeButton=new Button({text:"Quarters:",sizeGroup:"menuButton",on_press:()=>this.nextQuarterTime()}),this.homeButton=new Button({text:"Home:",sizeGroup:"menuButton",on_press:()=>this.nextHomeTeam()}),this.awayButton=new Button({text:"Away:",sizeGroup:"menuButton",on_press:()=>this.nextAwayTeam()});const[home,away]=game.randomMatchup();this.home=home,this.away=away,this.quarterTime=5,this.children=[new Label({text:"Quick Play Setup",color:"rgba(192, 50, 50, 1)",hints:{h:.3}}),this.timeButton,this.homeButton,this.awayButton,new Button({text:"Randomize Matchup",sizeGroup:"menuButton",on_press:()=>this.randomizeMatchup()}),new Button({text:"Start Game",sizeGroup:"menuButton",on_press:()=>this.startGame(game)}),new Button({text:"Back",sizeGroup:"menuButton",on_press:()=>this.goBack()})],this.updateProperties({})}randomizeMatchup(){[this.home,this.away]=this.game.randomMatchup()}nextHomeTeam(){this.home=(this.home+1)%18}nextAwayTeam(){this.away=(this.away+1)%18}nextQuarterTime(){this.quarterTime<=1?this.quarterTime=2:this.quarterTime<=2?this.quarterTime=5:this.quarterTime<=5?this.quarterTime=10:this.quarterTime<=10?this.quarterTime=20:this.quarterTime<=20&&(this.quarterTime=1)}on_home(e,o,v){this.homeButton.text="Home: "+teamAbbrevs[this.home]}on_away(e,o,v){this.awayButton.text="Away: "+teamAbbrevs[this.away]}on_quarterTime(e,o,v){this.timeButton.text="Quarters: "+this.quarterTime+" min."}startGame(game){this.parent&&(this.game.gameActive=!0,this.parent.children=this.parent.children.filter(w=>w!==this),game.setupGame(this.home,this.away,this.quarterTime))}goBack(){this.parent&&(this.parent.addChild(new MainMenu(this.game)),this.parent.children=this.parent.children.filter(w=>w!==this))}}class TournamentMenu extends BoxLayout{constructor(game){super({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,y:.2,w:.4,h:.6},bgColor:"rgba(0,0,0,0.5)",outlineColor:"rgba(255,255,255,1)"}),this.game=game,this.children=[new Label({text:"Tournament Setup",color:"rgba(192, 50, 50, 1)",hints:{h:.3}}),new Button({text:"Select Team",disable:!0}),new Button({text:"Quarter Length",disable:!0}),new Button({text:"Begin Tournament",disable:!0,on_press:()=>this.startTournament()}),new Button({text:"Back",on_press:()=>this.goBack()})],this.updateProperties({})}startTournament(){this.parent&&(this.game.gameActive=!0,this.parent.children=this.parent.children.filter(w=>w!==this))}goBack(){this.parent&&(this.parent.addChild(new MainMenu(this.game)),this.parent.children=this.parent.children.filter(w=>w!==this))}}class CareerMenu extends BoxLayout{constructor(game){super({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,y:.2,w:.4,h:.6},bgColor:"rgba(0,0,0,0.5)",outlineColor:"rgba(255,255,255,1)"}),this.game=game,this.children=[new Label({text:"Career Mode",color:"rgba(192, 50, 50, 1)",hints:{h:.3}}),new Button({text:"Manage Team",disable:!0}),new Button({text:"Facilities",disable:!0}),new Button({text:"Start Season",disable:!0,on_press:()=>this.startSeason()}),new Button({text:"Back",on_press:()=>this.goBack()})],this.updateProperties({})}startSeason(){this.parent&&(this.game.gameActive=!0,this.parent.children=this.parent.children.filter(w=>w!==this))}goBack(){this.parent&&(this.parent.addChild(new MainMenu(this.game)),this.parent.children=this.parent.children.filter(w=>w!==this))}}class OptionsMenu extends BoxLayout{constructor(game){super({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,y:.2,w:.4,h:.6},bgColor:"rgba(0,0,0,0.5)",outlineColor:"rgba(255,255,255,1)"}),this.game=game,this.children=[new Label({text:"Options"}),new Button({text:"Audio"}),new Button({text:"Graphics"}),new Button({text:"Back",on_press:()=>this.goBack()})],this.updateProperties({})}goBack(){this.parent&&(this.parent.addChild(new MainMenu(this.game)),this.parent.children=this.parent.children.filter(w=>w!==this))}}App.rules.add("Label",{fontName:"Titillium Web"});App.rules.add("Button",{bgColor:"#222C",outlineColor:"#FFF8",color:"white",fontName:"Titillium Web",hints:{w:.8},sizeGroup:"menuButton"});class Game extends App{constructor(glCanvas,uiCanvas,spriteSheet){if(super({}),this.glCanvas=glCanvas,this.uiCanvas=uiCanvas,this.gl=glCanvas.getContext("webgl2",{alpha:!1,preserveDrawingBuffer:!1}),!this.gl)throw new Error("WebGL2 not supported");this.currentContest=null,this.now=Date.now(),this.prefDimH=-1,this.prefDimW=-1,this.canvasName="uicanvas",this.scoreBoard=new ScoreBoard(this,"A","B"),this.continuousFrameUpdates=!0,this.renderer=new Renderer(this.gl,glCanvas,spriteSheet),this.controls=new InputManager(uiCanvas),this.setPiece=null,this.entities=[],this.aimTarget=new AimTarget([5,.001,FIELD_LENGTH$1/2]),this.quarterTime=300,this.ball=new Ball(v3(0,0,FIELD_LENGTH$1/2)),this.entities.push(this.ball),this.players=[],this.player=null,this.chasers=0,this.followers=0,this.closestPlayers={home:null,away:null},this.cameraTarget=v3(0,10,FIELD_LENGTH$1/2),this.cameraPos=v3(0,10,FIELD_LENGTH$1/2+15),this.renderer.fovy=45*Math.PI/180,this.resize(),window.addEventListener("resize",()=>this.resize()),this.lastTime=performance.now(),this.gameActive=!1,this.roamAngle=0,this.roamRadius=40,this.setPiece=null,this.entities=[],this.aimTarget=new AimTarget([5,.001,FIELD_LENGTH$1/2]),this.ball=new Ball(v3(0,0,FIELD_LENGTH$1/2)),this.entities.push(this.ball),this.players=[],this.chasers=0,this.followers=0,this.baseWidget.children=[new MainMenu(this)]}randomMatchup(){setPRNG("mulberry32"),setSeed(stringToSeed(`DATE ${Date.now()}`));for(let i=0;i<1e3;++i)getRandomInt(20);const homeId=getRandomInt(18);let awayId=getRandomInt(18);for(;homeId===awayId;)awayId=getRandomInt(18);return[homeId,awayId]}setupGame(homeId,awayId,quarterTime){(homeId===null||awayId===null)&&([homeId,awayId]=this.randomMatchup()),this.quarterTime=quarterTime?quarterTime*60:300,this.roamAngle=0,this.roamRadius=40,this.setPiece=null,this.entities=[],this.aimTarget=new AimTarget([5,.001,FIELD_LENGTH$1/2]),this.ball=new Ball(v3(0,0,FIELD_LENGTH$1/2)),this.entities.push(this.ball),this.players=[],this.player=null,this.chasers=0,this.followers=0;const homePositions=generateFieldPositions(),awayPositions=generateFieldPositions(!0),teamPositions=[[homePositions,"home",homeId],[awayPositions,"away",awayId]];for(let[positions,team,teamId]of teamPositions)for(const[name,pos]of Object.entries(positions)){const player=new Player(name,team,teamId,pos,!name.toLowerCase().startsWith("bench"));this.entities.push(player),this.players.push(player),name==="RR"&&team==="home"&&(this.player=player)}this.scoreBoard.homeName=teams[homeId],this.scoreBoard.awayName=teams[awayId],this.scoreBoard.timeLeft=this.quarterTime,this.closestPlayers={home:null,away:null},this.gameActive=!0,this.baseWidget.children=[this.scoreBoard,new FPS({hints:{bottom:1,x:0,w:1,h:.05},align:"right"})]}update(){this._udpateActive=!0,this.now=Date.now();const dt0=(this.now-this.lastTime)/1e3,dt=Math.min(dt0,1/30);if(this.gameActive){this.updateClosestPlayers(),this.controls.update(dt),this.chasers=0,this.followers=0;const before=this.ball.pos.c;for(const entity of this.entities)entity.update(dt,this);this.setPiece&&(this.setPiece.update(dt),this.setPiece.finished&&(this.setPiece=null)),this.checkTimeAndBoundary(dt,before),this.updateCamera(),this.updatePlayerControl(),this.renderer.renderScene(this,this.entities),this.controls.state.menuPressed&&(this.baseWidget.addChild(new PauseMenu(this)),this.gameActive=!1),this.controls.endUpdate()}else{{const t=this.now/5e4,flyX=Math.sin(t)*50,flyZ=FIELD_LENGTH$1/2+Math.sin(t*2)*50,lookAhead=4,lookX=Math.sin(t+lookAhead*.05)*50,lookZ=FIELD_LENGTH$1/2+Math.sin((t+lookAhead*.05)*2)*50;this.cameraPos.setFrom(flyX,10,flyZ),this.cameraTarget.setFrom(lookX,9,lookZ)}this.renderer.renderScene(this,[]),this.controls.update(dt),this.controls.state.menuPressed&&this.baseWidget.children.some(w=>w instanceof PauseMenu)&&(this.baseWidget.children=this.baseWidget.children.filter(w=>!(w instanceof PauseMenu)),this.gameActive=!0),this.controls.endUpdate()}super.update(),this.lastTime=this.now}endGame(){this.gameActive=!1,this.entities=[],this.players=[],this.setPiece=null,this.player=null,this.baseWidget.children=[new MainMenu(this)]}checkTimeAndBoundary(dt,before){var _a,_b;if(this.scoreBoard.timeLeft-=dt,this.scoreBoard.timeLeft<=0)if(this.scoreBoard.quarter<4){this.scoreBoard.timeLeft=this.quarterTime,this.scoreBoard.quarter+=1;for(const entity of this.entities)entity.setupForBoundary("goalHome",this.ball.pos)}else this.endGame();if(!this.setPiece){let crossing=checkBoundaryCrossing(before,this.ball.pos);if(crossing!==null){if(crossing==="goalAway"&&(this.ball.lastTouchedType!=="kick"||((_a=this.ball.lastTouchedBy)==null?void 0:_a.team)==="home")?(crossing="behindAway",this.scoreBoard.awayBehind+=1):crossing==="goalHome"&&(this.ball.lastTouchedType!=="kick"||((_b=this.ball.lastTouchedBy)==null?void 0:_b.team)==="away")?(crossing="behindHome",this.scoreBoard.homeBehind+=1):crossing==="innerLeftPostAway"||crossing==="innerRightPostAway"?(crossing="behindAway",this.scoreBoard.awayBehind+=1):(crossing==="innerLeftPostHome"||crossing==="innerRightPostHome")&&(crossing="behindHome",this.scoreBoard.homeBehind+=1),crossing==="behindAway"){this.scoreBoard.awayBehind+=1;const kicker=this.players.find(p=>p.name==="FB"&&p.team==="home");kicker&&(this.setPiece=new MarkSetPiece(this,kicker,v3(0,0,FIELD_LENGTH$1-10)))}if(crossing==="behindHome"){this.scoreBoard.homeBehind+=1;const kicker=this.players.find(p=>p.name==="FB"&&p.team==="away");kicker&&(this.setPiece=new MarkSetPiece(this,kicker,v3(0,0,10)))}if(crossing==="goalAway"||crossing==="goalHome"||crossing==="outOfBounds"){crossing==="goalAway"&&(this.scoreBoard.awayGoal+=1),crossing==="goalHome"&&(this.scoreBoard.homeGoal+=1);for(const entity of this.entities)entity.setupForBoundary(crossing,this.ball.pos)}}}}updateClosestPlayers(){const ball=this.ball,closest={home:1/0,away:1/0},closestPlayers={home:null,away:null};for(let p of this.players){const candidate=p.pos.dist(ball.pos);candidate<closest[p.team]&&(closest[p.team]=candidate,closestPlayers[p.team]=p)}this.closestPlayers=closestPlayers}updatePlayerControl(){const homePlayers=this.players.filter(e=>e.team==="home"),carrier=this.ball.carrier;if(!carrier||carrier&&carrier.team==="home")return;let best=null,bestDistSq=1/0;for(const p of homePlayers){if(p.actionState==="tackle")continue;const distSq=squaredDistance(p.pos,carrier.pos),bias=(Math.abs(p.positionPos[0]-this.ball.pos[0])<10?-10:0)+(p.energy<.3?-5:0)+(p.pos[2]>carrier.pos[2]?-10:0);distSq+bias<bestDistSq&&(best=p,bestDistSq=distSq+bias)}best&&best!==this.player&&(this.player=best,this.player.aiming=!1)}updateCamera(){const ball=this.ball,carrier=ball.carrier,aspect=this.w/this.h,fovY=this.renderer.fovy,baseTarget=carrier?carrier.pos.c:ball.pos.c,cameraHeight=8-(1.5-Math.min(aspect,1.5))*2,cameraBack=20+(1.5-Math.min(aspect,1.5))*10,desiredNDC_Y=carrier&&carrier.team==="home"?.75:0,verticalBias=Math.tan(fovY/2)*cameraBack*desiredNDC_Y,targetX=baseTarget[0],halfFovX=Math.atan(Math.tan(fovY/2)*aspect),maxCameraOffset=Math.tan(halfFovX)*cameraBack-5,biasTowardCenter=-targetX*.5;let xOffset=Math.max(-maxCameraOffset,Math.min(maxCameraOffset,biasTowardCenter));const camX=targetX+xOffset;Math.abs(camX-targetX)>maxCameraOffset&&(xOffset=0);const lookTarget=baseTarget.c.add([xOffset,0,-verticalBias]),dist2=this.cameraTarget.dist(lookTarget),CAM_SPEED=Math.max(1/(1+3*dist2),.05);this.cameraTarget.lerp(lookTarget,CAM_SPEED),this.cameraPos=this.cameraTarget.c.add([0,cameraHeight,cameraBack])}resize(){this.glCanvas.width=window.innerWidth,this.glCanvas.height=window.innerHeight;const aspect=window.innerWidth/window.innerHeight,baseFov=45*Math.PI/180,maxFov=85*Math.PI/180,fovScale=Math.max(0,(1.777-aspect)/1);this.renderer.fovy=baseFov+fovScale*(maxFov-baseFov),this.renderer.updateProjection()}}const spriteSheetUrl="/footy/assets/spritesheet-B1iMSNhx.png";function main(spriteSheet){const uiCanvas=document.getElementById("uicanvas");if(!uiCanvas)throw console.error("UI Canvas element not found"),new Error("UI Canvas element not found");const glCanvas=document.getElementById("glcanvas");if(!glCanvas)throw console.error("WebGL2 Canvas element not found"),new Error("WebGL2 Canvas element not found");new Game(glCanvas,uiCanvas,spriteSheet).start()}function loadFont(){return document.fonts.load('10px "Titillium Web"').then(value=>{document.fonts.ready})}Promise.all([loadImage(spriteSheetUrl),loadFont()]).then(([image])=>{if(!image.complete)throw console.error("Failed to load sprite sheet"),new Error("Sprite sheet not loaded");main(image)}).catch(err=>{console.error("Initialization failed:",err)});
