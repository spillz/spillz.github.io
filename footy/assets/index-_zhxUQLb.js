var lt=e=>{throw TypeError(e)};var _t=(e,t,s)=>t.has(e)||lt("Cannot "+s);var ft=(e,t,s)=>t.has(e)?lt("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s);var st=(e,t,s)=>(_t(e,t,"access private method"),s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function s(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(o){if(o.ep)return;o.ep=!0;const r=s(o);fetch(o.href,r)}})();var rt=1e-6,O=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});function X(){var e=new O(16);return O!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function St(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Q(e,t,s){var i=s[0],o=s[1],r=s[2],a,n,h,c,d,f,u,l,g,m,p,T;return t===e?(e[12]=t[0]*i+t[4]*o+t[8]*r+t[12],e[13]=t[1]*i+t[5]*o+t[9]*r+t[13],e[14]=t[2]*i+t[6]*o+t[10]*r+t[14],e[15]=t[3]*i+t[7]*o+t[11]*r+t[15]):(a=t[0],n=t[1],h=t[2],c=t[3],d=t[4],f=t[5],u=t[6],l=t[7],g=t[8],m=t[9],p=t[10],T=t[11],e[0]=a,e[1]=n,e[2]=h,e[3]=c,e[4]=d,e[5]=f,e[6]=u,e[7]=l,e[8]=g,e[9]=m,e[10]=p,e[11]=T,e[12]=a*i+d*o+g*r+t[12],e[13]=n*i+f*o+m*r+t[13],e[14]=h*i+u*o+p*r+t[14],e[15]=c*i+l*o+T*r+t[15]),e}function at(e,t,s){var i=s[0],o=s[1],r=s[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*o,e[5]=t[5]*o,e[6]=t[6]*o,e[7]=t[7]*o,e[8]=t[8]*r,e[9]=t[9]*r,e[10]=t[10]*r,e[11]=t[11]*r,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Ft(e,t,s){var i=Math.sin(s),o=Math.cos(s),r=t[4],a=t[5],n=t[6],h=t[7],c=t[8],d=t[9],f=t[10],u=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=r*o+c*i,e[5]=a*o+d*i,e[6]=n*o+f*i,e[7]=h*o+u*i,e[8]=c*o-r*i,e[9]=d*o-a*i,e[10]=f*o-n*i,e[11]=u*o-h*i,e}function xt(e,t,s,i,o){var r=1/Math.tan(t/2),a;return e[0]=r/s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,o!=null&&o!==1/0?(a=1/(i-o),e[10]=(o+i)*a,e[14]=2*o*i*a):(e[10]=-1,e[14]=-2*i),e}var Lt=xt;function Bt(e,t,s,i){var o,r,a,n,h,c,d,f,u,l,g=t[0],m=t[1],p=t[2],T=i[0],y=i[1],k=i[2],R=s[0],v=s[1],M=s[2];return Math.abs(g-R)<rt&&Math.abs(m-v)<rt&&Math.abs(p-M)<rt?St(e):(d=g-R,f=m-v,u=p-M,l=1/Math.hypot(d,f,u),d*=l,f*=l,u*=l,o=y*u-k*f,r=k*d-T*u,a=T*f-y*d,l=Math.hypot(o,r,a),l?(l=1/l,o*=l,r*=l,a*=l):(o=0,r=0,a=0),n=f*a-u*r,h=u*o-d*a,c=d*r-f*o,l=Math.hypot(n,h,c),l?(l=1/l,n*=l,h*=l,c*=l):(n=0,h=0,c=0),e[0]=o,e[1]=n,e[2]=d,e[3]=0,e[4]=r,e[5]=h,e[6]=f,e[7]=0,e[8]=a,e[9]=c,e[10]=u,e[11]=0,e[12]=-(o*g+r*m+a*p),e[13]=-(n*g+h*m+c*p),e[14]=-(d*g+f*m+u*p),e[15]=1,e)}function S(){var e=new O(3);return O!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function _(e){var t=new O(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function I(e){var t=e[0],s=e[1],i=e[2];return Math.hypot(t,s,i)}function P(e,t,s){var i=new O(3);return i[0]=e,i[1]=t,i[2]=s,i}function A(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function W(e,t,s,i){return e[0]=t,e[1]=s,e[2]=i,e}function j(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e}function $(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2],e}function L(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e}function H(e,t,s,i){return e[0]=t[0]+s[0]*i,e[1]=t[1]+s[1]*i,e[2]=t[2]+s[2]*i,e}function K(e,t){var s=t[0]-e[0],i=t[1]-e[1],o=t[2]-e[2];return Math.hypot(s,i,o)}function Vt(e,t){var s=t[0]-e[0],i=t[1]-e[1],o=t[2]-e[2];return s*s+i*i+o*o}function Pt(e){var t=e[0],s=e[1],i=e[2];return t*t+s*s+i*i}function w(e,t){var s=t[0],i=t[1],o=t[2],r=s*s+i*i+o*o;return r>0&&(r=1/Math.sqrt(r)),e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function it(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function tt(e,t,s,i){var o=t[0],r=t[1],a=t[2];return e[0]=o+i*(s[0]-o),e[1]=r+i*(s[1]-r),e[2]=a+i*(s[2]-a),e}var Y=$,V=K,Dt=Pt;(function(){var e=S();return function(t,s,i,o,r,a){var n,h;for(s||(s=3),i||(i=0),o?h=Math.min(o*s+i,t.length):h=t.length,n=i;n<h;n+=s)e[0]=t[n],e[1]=t[n+1],e[2]=t[n+2],r(e,e,a),t[n]=e[0],t[n+1]=e[1],t[n+2]=e[2];return t}})();function Ht(){var e=new O(2);return O!=Float32Array&&(e[0]=0,e[1]=0),e}function dt(e,t){var s=new O(2);return s[0]=e,s[1]=t,s}function mt(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e}function At(e){var t=e[0],s=e[1];return Math.hypot(t,s)}var ut=At;(function(){var e=Ht();return function(t,s,i,o,r,a){var n,h;for(s||(s=2),i||(i=0),o?h=Math.min(o*s+i,t.length):h=t.length,n=i;n<h;n+=s)e[0]=t[n],e[1]=t[n+1],r(e,e,a),t[n]=e[0],t[n+1]=e[1];return t}})();const It=160,b=170,ht=It/2,D=b/2,C=6,ot=6,pt=.5;function E(e,t,s){return P(e,t,s)}const Ut=Object.freeze([E(-.5*C-ot,0,b),E(-.5*C,0,b),E(.5*C,0,b),E(.5*C+ot,0,b)]),jt=Object.freeze([E(-.5*C-ot,0,0),E(-.5*C,0,0),E(.5*C,0,0),E(.5*C+ot,0,0)]),Ot=Object.freeze({Away:Ut,Home:jt});function gt(e){const t=e[0]/ht,s=(e[2]-D)/D;return t*t+s*s>1}function Ct(e,t,s,i,o,r){const a=o-s,n=r-i;if(a===0&&n===0){const g=e-s,m=t-i;return g*g+m*m}const h=((e-s)*a+(t-i)*n)/(a*a+n*n),c=Math.max(0,Math.min(1,h)),d=s+c*a,f=i+c*n,u=e-d,l=t-f;return u*u+l*l}function Nt(e,t){const s=gt(e),i=gt(t);for(const o of["Away","Home"]){const r=Ot[o];if(i&&!s){if(o==="Away"){if(e[2]>b-10){const n=t[0];if(n>=-3&&n<=3)return"goalAway";if(n>=-9&&n<-3||n>3&&n<=9)return"behindAway"}}else if(o==="Home"&&e[2]<10){const n=t[0];if(n>=-3&&n<=3)return"goalHome";if(n>=-9&&n<-3||n>3&&n<=9)return"behindHome"}}const a=["outerLeftPost","innerLeftPost","innerRightPost","outerRightPost"];for(let n=0;n<r.length;n++){const h=r[n][0],c=r[n][2];if(Ct(h,c,e[0],e[2],t[0],t[2])<pt*pt)return`${a[n]}${o}`}}return!s&&i?"outOfBounds":null}function Tt(e=!1){const s={fullForward:70,halfForward:35,halfBack:-35,fullBack:-70},i={LFP:-45,FF:0,RFP:45,LHF:-50,CHF:0,RHF:50,LHB:-50,CHB:0,RHB:50,LBP:-45,FB:0,RBP:45};function o(h,c){const d=h*Math.PI/180,f=ht*Math.sin(d)*(Math.abs(c)/D)-(e?2:-2),u=D+c*(e?-1:1);return E(f,0,u)}const r=-ht+2,a=h=>D+(e?1:-1)*h;return{LFP:o(i.LFP,s.fullForward-(e?10:-10)),FF:o(i.FF,s.fullForward),RFP:o(i.RFP,s.fullForward-(e?10:-10)),LHF:o(i.LHF,s.halfForward),CHF:o(i.CHF,s.halfForward),RHF:o(i.RHF,s.halfForward),LW:E(-25,0,D-(e?2:-2)),C:E(8,0,D-(e?-5:5)),RW:E(25,0,D-(e?2:-2)),LHB:o(i.LHB,s.halfBack),CHB:o(i.CHB,s.halfBack),RHB:o(i.RHB,s.halfBack),LBP:o(i.LBP,s.fullBack-(e?10:-10)),FB:o(i.FB,s.fullBack),RBP:o(i.RBP,s.fullBack-(e?10:-10)),Ruck:E(0,0,D-(e?10:-10)),RR:E(-10,0,D-(e?10:-10)),Rover:E(10,0,D-(e?10:-10)),Bench1:E(r,0,a(10)),Bench2:E(r,0,a(13)),Bench3:E(r,0,a(16)),Bench4:E(r,0,a(19)),Bench5:E(r,0,a(22))}}function zt(e,t,s){let i=null,o=1/0;for(const r of t)if(r.team!==e.team){const a=K(r.pos,s);a<o&&(o=a,i=r)}return i}class Gt{constructor(t,s,i){this.game=t,this.kicker=s,this.markPos=_(i),this.timer=0,this.finished=!1}update(t){this.timer+=t}enforce(t){}cleanup(){}}class nt extends Gt{constructor(t,s,i){super(t,s,i),this.defender=null,this.zone={center:S(),radius:1},this.setup()}setup(){const{game:t,kicker:s,markPos:i}=this,o=s.team==="home"?0:b,r=P(0,0,o),a=Y(S(),i,r);a[1]=0,w(a,a);const n=8,h=10,c=_(i),d=H(S(),i,a,h);A(s.pos,d),A(s.vel,[0,0,0]),A(s.jogVel,[0,0,0]),A(s.joltVel,[0,0,0]),t.ball.carrier!==s&&t.ball.pickup(s),s.actionState="mark",s.stateTimer=1,this.defender=zt(s,t.players,i),this.defender&&(A(this.defender.pos,c),A(this.defender.vel,[0,0,0]),A(this.defender.jogVel,[0,0,0]),A(this.defender.joltVel,[0,0,0]),this.defender.actionState="mark",this.defender.stateTimer=10),this.zone={center:_(i),radius:n};for(const f of t.players){if(f===s||f===this.defender)continue;if(K(f.pos,i)<n+1){const l=Y(S(),f.pos,i);w(l,l),H(f.pos,i,l,n+1.5+Math.random()*2)}}}update(t){super.update(t);const{kicker:s,markPos:i,game:o}=this,r=K(s.pos,i)>1.5,a=!o.ball.carried;(r||a)&&(this.finished=!0)}enforce(t){if(t===this.kicker)this.game.ball.carried&&this.game.ball.carrier===t&&K(t.pos,this.markPos)<.5&&W(t.vel,0,0,0);else if(t===this.defender)A(t.pos,this.markPos),W(t.vel,0,0,0);else{const[s,,i]=t.pos,{minX:o,maxX:r,minZ:a,maxZ:n}=this.zone;s>o&&s<r&&i>a&&i<n&&W(t.vel,0,0,0)}}}function Xt(e,t){const s=e.pos[0]-t.pos[0],i=e.pos[1]-t.pos[1],o=e.pos[2]-t.pos[2],r=s*s+i*i+o*o,[a,n]=e.collideBounds(),[h,c]=t.collideBounds(),d=.5*ut(e.collideBounds()),f=.5*ut(t.collideBounds()),u=d+f;return r<=u*u}class ct{constructor(t){this.pos=t,this.vel=[0,0,0],this.width=1.6,this.height=2.4,this.usesGravity=!0,this.gravity=[0,-9.8,0],this.bounces=!1,this.restitution=.4,this.floorY=0}setupForBoundary(t,s){}update(t,s){this.usesGravity&&H(this.vel,this.vel,this.gravity,t),H(this.pos,this.pos,this.vel,t),this.pos[1]<this.floorY&&(this.pos[1]=this.floorY,this.bounces&&Math.abs(this.vel[1])>.5?this.vel[1]=-this.vel[1]*this.restitution:this.vel[1]=0)}render(t){t.renderSprite(this.pos,this.width,this.height,1,0)}collidesWith(t){return Xt(this,t)}collideBounds(){return[.5,1.8]}}const vt={home:Object.freeze({idle:[[0,0,0]],run:[[1,0,0],[2,0,0],[3,0,0],[4,0,0],[5,0,0],[6,0,0]],kickRightFoot:[[1,0,0],[2,0,0]],kickLeftFoot:[[4,0,0],[5,0,0]],handpassRightHand:[[1,0,0],[0,0,0]],handpassLeftHand:[[4,0,0],[0,0,0]],jumpMark:[[1,0,0],[2,0,0],[0,0,0]],jumpSpoil:[[1,0,0],[2,0,0],[0,0,0]]}),away:Object.freeze({idle:[[0,4,0]],run:[[1,4,0],[2,4,0],[3,4,0],[4,4,0],[5,4,0],[6,4,0]],kickRightFoot:[[1,4,0],[2,4,0]],kickLeftFoot:[[4,4,0],[5,4,0]],handpassRightHand:[[1,4,0],[0,4,0]],handpassLeftHand:[[4,4,0],[0,4,0]],jumpMark:[[1,4,0],[2,4,0],[0,4,0]],jumpSpoil:[[1,4,0],[2,4,0],[0,4,0]]})};class Yt extends ct{constructor(t,s,i,o=!1){super(i),this.positionPos=_(i),this.name=t,this.team=s,this.playing=o,this.width=1.6,this.height=2.4,this.aiming=!1,this.jogVel=P(0,0,0),this.joltVel=P(0,0,0),this.jogSpeed=5,this.joltSpeed=2,this.energy=10,this.energyRecovery=0,this.statsWeight=85+Math.random()*10,this.statsStrength=50+Math.random()*30,this.statsSpeed=10+Math.random()*5,this.statsJump=10,this.statsKickRange=45,this.statsHandpassRange=20,this.statsAgility=10,this.joltDecayRate=8,this.animations=vt[s]??vt.home,this.animState="idle",this.actionState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=8,this.stateTimer=0,this.animSprite=P(0,0,0)}updateAI(t,s){const o=s.ball;let r=null;if(o.carried&&o.carrier===this)if(this.stateTimer+=t,this.stateTimer<1)r="run";else{let n=!1;for(const l of s.players)if(!(l===this||l.team===this.team)&&V(l.pos,this.pos)<7){n=!0;break}const h=s.players.filter(l=>l.team===this.team&&l!==this);if(n){let l=null,g=-1/0;const m=P(0,0,this.team==="home"?-1:1);for(const p of h){if(p===this)continue;const T=V(this.pos,p.pos);if(T>20)continue;let y=!1;for(const F of s.players)if(F.team!==this.team&&V(F.pos,p.pos)<5){y=!0;break}if(y)continue;const k=S();$(k,p.pos,this.pos),w(k,k);const R=it(m,k),v=_(p.vel);v[1]=0;const M=it(m,v),x=T*.2,B=5*R+2*M-x;B>g&&(g=B,l=p)}if(l){const p=Y(S(),l.pos,this.pos),T=[p[0],p[2]];return this.tryDisposeBall(s,{kickReleased:!0,kickHeldTime:.1,aimTarget:T})??"run"}}const d=this.team==="home"?-5:b+5,f=0;if(Math.abs(this.pos[2]-d)<=this.statsKickRange){const l=P(f,0,d),g=(Math.random()-.5)*9;l[0]+=g;const m=Y(S(),l,this.pos),p=[m[0],m[2]];return this.tryDisposeBall(s,{kickReleased:!0,kickHeldTime:.4,aimTarget:p})??"run"}if(n||this.stateTimer>5){let l=null,g=-1/0;for(const m of h){const p=V(this.pos,m.pos);if(p>this.statsKickRange)continue;const T=this.team==="home"?-1:1,y=(m.pos[2]-this.pos[2])*T,k=Math.abs(m.pos[0]-this.pos[0]),R=y-k-p;R>g&&(g=R,l=m)}if(l){const m=Y(S(),l.pos,this.pos),p=[m[0],m[2]];return this.tryDisposeBall(s,{kickReleased:!0,kickHeldTime:.4,aimTarget:p})??"run"}}r="run"}let a=null;if(o.carried&&o.carrier===this){const n=this.team==="home"?-1:1,h=P(0,0,n);let c=S();for(const f of s.players){if(f===this||f.team===this.team)continue;const u=S();$(u,this.pos,f.pos),u[1]=0;const l=I(u);if(l<5&&l>.5){const g=1/l;w(u,u),H(c,c,u,g)}}const d=S();j(d,h,c),w(d,d),a=_(this.pos),H(a,a,d,10)}else if(o.carried)if(o.carrier&&o.carrier.team!==this.team&&V(o.pos,this.pos)<=15&&this.energy>0&&s.chasers<3)a=_(o.pos),s.chasers++;else if(o.carrier&&o.carrier.team===this.team&&V(o.pos,this.pos)>5&&this.energy>.3&&s.followers<3){s.followers++;const n=_(o.carrier.jogVel);I(n)<.01&&(n[2]=this.team==="home"?-1:1),w(n,n);const h=P(-n[2],0,n[0]);w(h,h);let c=0,d=12;switch(this.name){case"wing":c=12*(this.team==="home"?-1:1),d=15;break;case"forward":c=6,d=18;break;case"half-forward":case"half-back":c=4,d=10;break;case"center":case"mid":c=0,d=10;break;case"back":default:c=-6,d=8;break}const f=_(o.carrier.pos);H(f,f,n,d),H(f,f,h,c),a=f}else a=this.positionPos??this.pos;else if(o.pos[1]>.1||o.vel[1]>.1){const n=o.gravity[1]??-9.8,h=o.vel[1],c=o.pos[1],d=.5*n,f=h,u=c;let l=0;const g=f*f-4*d*u;if(g>=0&&Math.abs(d)>1e-5){const p=Math.sqrt(g),T=(-f+p)/(2*d),y=(-f-p)/(2*d);l=Math.max(T,y)}const m=S();H(m,o.pos,o.vel,l),m[1]=0,V(m,this.pos)<=35?a=m:a=this.positionPos??this.pos}else V(o.pos,this.pos)<=25?a=o.pos:a=this.positionPos??this.pos;if(a){const n=S();if($(n,a,this.pos),n[1]=0,Pt(n)>1e-4){w(n,n),L(this.joltVel,n,this.joltSpeed);const c=S();I(this.jogVel)>1e-4?(w(c,this.jogVel),tt(c,c,n,.15),w(c,c),L(this.jogVel,c,this.jogSpeed)):L(this.jogVel,n,this.jogSpeed)}}this.energy>0?(j(this.vel,this.jogVel,this.joltVel),this.energy-=t):(H(this.vel,this.jogVel,this.joltVel,.5),this.energyRecovery+=t,this.energyRecovery>=10&&(this.energy=10,this.energyRecovery=0)),L(this.joltVel,this.joltVel,Math.exp(-this.joltDecayRate*t)),this.checkPlayerCollisions(t,s),super.update(t,s);for(const n of s.players){if(n===this||!o.carried||o.carrier!==n||n.team===this.team||!this.collidesWith(n)||n.actionState==="tackleDisposal")continue;const h=S();$(h,n.pos,this.pos),h[1]=0,w(h,h);const c=_(this.jogVel);if(c[1]=0,I(c)<1e-4)continue;w(c,c);const d=it(c,h),f=V(this.pos,n.pos);if(d>.5&&f<1.5){r="tackle",this.stateTimer=1,n.actionState="tackleDisposal",n.stateTimer=1;break}}if(!o.carried&&o.collidesWith(this)&&r===null){const n=o.lastTouchedType==="kick"&&!o.hasBounced&&o.lastTouchedBy!==this;if(o.pickup(this),r=n?"mark":"pickup",n&&(s.setPiece=new nt(s,this,_(o.pos)),this.stateTimer=0),this.team==="home")return s.player=this,this.aiming=!1,null}return r||(r=I(this.vel)>1e-4?"run":"idle"),r}collideBounds(){return[.5,1.8]}get stunned(){return this.actionState==="tackle"||this.actionState==="tackled"}updateHuman(t,s){const i=s.controls,o=s.ball;let{kickPressed:r,kickReleased:a,kickHeldTime:n,moveX:h,moveZ:c,aimTarget:d}=i.state;const f=1e-4;let u=null;if((h!==0||c!==0)&&!this.aiming){const l=P(h,0,c);w(l,l);const g=P(h,0,c);if(Dt(g)>f){w(g,g),L(this.joltVel,g,this.joltSpeed);const m=S();I(this.jogVel)>f?(w(m,this.jogVel),tt(m,m,l,.15),w(m,m),L(this.jogVel,m,this.jogSpeed)):L(this.jogVel,l,this.jogSpeed)}}if(this.energy>0?(j(this.vel,this.jogVel,this.joltVel),this.energy-=t):(j(this.vel,this.jogVel,L(this.joltVel,this.joltVel,.5)),this.energyRecovery+=t,this.energyRecovery>=10&&(this.energy=10,this.energyRecovery=0)),L(this.joltVel,this.joltVel,Math.exp(-this.joltDecayRate*t)),this.checkPlayerCollisions(t,s),super.update(t,s),!o.carried&&o.collidesWith(this)){const l=o.lastTouchedType==="kick"&&!o.hasBounced&&o.lastTouchedBy!==this;o.pickup(this),u=l?"mark":"pickup",l&&(s.setPiece=new nt(s,this,_(o.pos)),this.stateTimer=0,this.aiming=!1)}if(o.carried&&o.carrier===this&&(r&&(this.aiming=!0),u=this.tryDisposeBall(s,{kickReleased:i.state.kickReleased,kickHeldTime:i.state.kickHeldTime,aimTarget:i.state.aimTarget,moveVec:h!==0||c!==0?P(h,0,c):_(this.jogVel)}),o.carried||(this.aiming=!1)),this.aiming){const l=dt(0,0);d&&mt(l,l,d),s.aimTarget.setPosition([this.pos[0]+l[0],.002,this.pos[2]+l[1]])}else s.aimTarget.setPosition(P(this.pos[0],.002,this.pos[2]+.8));return!u&&this.actionState!=="run"&&this.actionState!=="idle"&&(u=I(this.vel)>f?"run":"idle"),u}tryDisposeBall(t,s){const i=t.ball;if(!i.carried||i.carrier!==this)return null;const{kickReleased:o,kickHeldTime:r}=s;let{aimTarget:a}=s;if(!o)return null;const n=r<.25;if(n&&!a){const y=s.moveVec??_(this.jogVel);if(I(y)===0){const v=this.team==="home"?-1:1;W(y,0,0,v)}w(y,y);let k=null,R=-1/0;for(const v of t.players){if(v.team!==this.team||v===this||v.stunned)continue;const M=Y(S(),v.pos,this.pos),x=I(M);if(x>30)continue;const B=w(S(),M),F=it(y,B);if(F<=0)continue;let q=0;for(const U of t.players){if(U.team===this.team||U===v||U.stunned)continue;K(U.pos,v.pos)<=10&&q++}const Z=.5*q,z=F*2-x/30-Z;z>R&&(R=z,k=v)}if(k){const v=Y(S(),k.pos,this.pos);a=[v[0],v[2]]}else a=[y[0]*10,y[2]*10]}if(!a)return null;const h=dt(0,0);mt(h,h,a);const c=At(h);if(c<.1)return null;const d=-this.gravity[1],f=(n?12.5:30)*Math.PI/180,u=Math.sin(2*f),l=Math.sqrt(c*d/u),g=P(h[0],0,h[1]);w(g,g);const m=P(g[0]*Math.cos(f),Math.sin(f),g[2]*Math.cos(f));return i.launch(m,l),i.lastTouchedType=n?"handpass":"kick",i.hasBounced=!1,this.stateTimer=.5,n?"handpass":"kick"}update(t,s){if(s.ball.carried||(this.aiming=!1),!this.playing)return;if(this.actionState==="pickup"&&(this.actionState="run"),this.actionState==="mark"&&this.stateTimer>0&&(this.stateTimer-=t,this.stateTimer===0&&(this.actionState="run")),this.actionState==="tackleDisposal"){if(A(this.vel,[0,0,0]),this.stateTimer-=t,s.player===this&&s.controls.state.kickReleased){const o=this.tryDisposeBall(s,s.controls.state);return this.actionState="handpass",this.stateTimer=.5,o}if(s.player!==this){const o=.5-this.stateTimer,r=.5+(this.statsStrength-50)*.01,a=o/r*(.5+(this.statsStrength-50)/100);if(Math.random()<a*t*2)return this.tryDisposeBall(s,{kickReleased:!0,kickHeldTime:.1,aimTarget:null,moveVec:S()})}if(this.stateTimer<=0){const o=s.ball;o.carried=!1,o.carrier=null,A(o.pos,this.pos),W(o.vel,0,0,0),o.lastTouchedType="spill",o.hasBounced=!1,this.actionState="tackled",this.stateTimer=1;return}this.updateAnimation(t,null,s.ball);return}if(this.actionState==="mark"||this.actionState==="tackled"||this.actionState==="tackle"||this.actionState==="kick"||this.actionState==="handpass"){this.vel=P(0,0,0),this.stateTimer-=t,this.stateTimer<=0&&(this.actionState="idle",this.stateTimer=0),this.updateAnimation(t,null,s.ball);return}let i=null;s.player===this?i=this.updateHuman(t,s):i=this.updateAI(t,s),s.setPiece&&s.setPiece.enforce(this),this.updateAnimation(t,i,s.ball),i!==null&&(this.actionState=i)}updateAnimation(t,s,i){const o=this.animations[this.animState];if(o.length===0)return;this.animTimer+=t;const r=1/this.animFPS;this.animTimer>=r&&(this.animTimer-=r,this.animFrame=this.animFrame+1),s==="kick"&&(this.animState="kickRightFoot",this.animFrame=0,this.animTimer=0),this.animState==="run"&&V(this.vel,[0,0,0])===0&&(this.animState="idle",this.animFrame=0,this.animTimer=0),this.animState==="idle"&&V(this.vel,[0,0,0])!==0&&(this.animState="run",this.animFrame=0,this.animTimer=0);const a=this.animState==="run"||this.animState==="idle";this.animFrame>=o.length&&(this.animFrame=a?0:o.length-1,a||(this.animState="run",this.animFrame=0,this.animTimer=0));const n=this.animations[this.animState];this.animSprite=_(n[this.animFrame])??P(0,0,0),(this.vel[2]>0?"away":this.vel[2]<0?"home":this.pos[2]<i.pos[2]?"away":"home")==="away"&&(this.animSprite[0]+=7)}render(t){const[s,i,o]=this.animSprite;t.renderSprite(this.pos,this.width,this.height,s,i)}checkPlayerCollisions(t,s){for(const i of s.players)if(!(i===this||!i.playing)&&this.collidesWith(i)){const o=S();$(o,this.pos,i.pos),o[1]=0;const r=I(o);r<1e-4?(o[0]=Math.random()-.5,o[2]=Math.random()-.5,w(o,o)):L(o,o,1/r);const a=(this.width+i.width)/2-r;if(a<=0)continue;const n=this.statsWeight,h=i.statsWeight,c=n+h,d=S();L(d,o,a);const f=S(),u=S();L(f,d,h/c),L(u,d,n/c),this.pos[0]+=f[0],this.pos[2]+=f[2],i.pos[0]-=u[0],i.pos[2]-=u[2]}}setupForBoundary(t,s){t==="behindAway"&&this.team==="home"&&this.name==="FB"?(A(this.pos,[0,0,b-5]),A(this.jogVel,[0,0,0]),A(this.joltVel,[0,0,0]),this.actionState="idle",this.stateTimer=0):t==="behindAway"&&this.team==="away"&&this.name==="FF"?A(this.pos,[0,0,b-25]):t==="behindHome"&&this.team==="away"&&this.name==="FB"?(A(this.pos,[0,0,5]),A(this.jogVel,[0,0,0]),A(this.joltVel,[0,0,0]),this.actionState="idle",this.stateTimer=0):t==="behindHome"&&this.team==="home"&&this.name==="FF"?A(this.pos,[0,0,25]):A(this.pos,this.positionPos)}}class Wt extends ct{constructor(t){super(t),this.carried=!1,this.carrier=null,this.width=1.6,this.height=2.4,this.bounces=!0,this.animations=Object.freeze({idle:[[0,1,0]],backSpin:[[1,1,0],[2,1,0],[3,1,0],[4,1,0],[5,1,0],[6,1,0],[7,1,0],[8,1,0]],forwardSpin:[[8,1,0],[7,1,0],[6,1,0],[5,1,0],[4,1,0],[3,1,0],[2,1,0],[1,1,0]],backSpinRight:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]],backSpinLeft:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinRight:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinLeft:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]]}),this.animState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=12,this.lastTouchedBy=null,this.lastTouchedType=null,this.hasBounced=!1}update(t,s){if(this.carried&&this.carrier){const i=P(0,.5,this.carrier.vel[2]>0?.2:-.2),o=_(this.carrier.pos);j(this.pos,o,i)}else{const i=this.vel[1]<0;super.update(t,s),this.hasBounced=this.hasBounced||i&&this.vel[1]>0&&this.pos[1]<=this.floorY,this.pos[1]<=this.floorY&&L(this.vel,this.vel,.97)}this.updateAnimation(t)}collideBounds(){return[.4,.5]}pickup(t){this.carried=!0,this.carrier=t,this.lastTouchedBy=t,this.lastTouchedType=null,this.hasBounced=!1,W(this.pos,t.pos[0],t.pos[1],t.pos[2]-1),W(this.vel,0,0,0)}launch(t,s,i="kick"){this.carried=!1,this.carrier=null,L(this.vel,t,s),this.lastTouchedType=i,this.hasBounced=!1}updateAnimation(t){this.animTimer+=t;const s=1/this.animFPS;this.animTimer>=s&&(this.animTimer-=s,this.animFrame=this.animFrame+1);const i=this.animState;this.carried?this.animState="idle":this.lastTouchedType==="kick"&&!this.hasBounced?this.animState="backSpin":this.lastTouchedType==="handpass"&&!this.hasBounced?this.animState="backSpinRight":this.hasBounced?Math.abs(this.vel[1])<.05&&this.pos[1]<=this.floorY+.01?this.animState="idle":this.animState="forwardSpin":this.animState="idle",this.animState!==i&&(this.animFrame=0,this.animTimer=0);const o=this.animations[this.animState];o.length!==0&&this.animFrame>=o.length&&(this.animFrame=0)}render(t){var a;const s=(a=this.animations)==null?void 0:a[this.animState],[i,o,r]=(s==null?void 0:s[this.animFrame])??[0,1,void 0];t.renderSprite(this.pos,this.width,this.height,i,o)}setupForBoundary(t,s){if(this.carried=!1,this.carrier=null,t==="goalAway"||t==="goalHome")A(this.pos,[0,0,b/2]),A(this.vel,[0,15,0]);else if(t==="behindAway")A(this.pos,[0,0,b-6]);else if(t==="behindHome")A(this.pos,[0,0,6]);else{this.pos[1]=0,A(this.pos,s);const i=S();H(i,[0,b/2,b/2],s,-1),w(i,i),this.launch(i,15,"tap")}}}class qt{constructor(t=[0,.001,0]){this.pos=_(t),this.size=2,this.spriteCoord=[0,3]}setPosition(t){this.pos[0]=t[0],this.pos[2]=t[2]}render(t){const s=t.gl;s.useProgram(t.program),s.bindVertexArray(t.quadVao);const[i,o]=this.spriteCoord,r=i/t.sheetCols,a=o/t.sheetRows,n=(i+1)/t.sheetCols,h=(o+1)/t.sheetRows;s.uniform4f(t.uTileUV,r,a,n,h);const c=X();Q(c,c,[this.pos[0],.001,this.pos[2]]),Ft(c,c,-Math.PI/2),at(c,c,[this.size,this.size,1]),s.uniformMatrix4fv(t.uModel,!1,c),s.drawElements(s.TRIANGLES,6,s.UNSIGNED_SHORT,0)}}function yt(e,t,s){const i=(n,h)=>{const c=e.createShader(h);if(!c)throw new Error("Failed to create shader");if(e.shaderSource(c,n),e.compileShader(c),!e.getShaderParameter(c,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(c));return c},o=i(t,e.VERTEX_SHADER),r=i(s,e.FRAGMENT_SHADER),a=e.createProgram();if(e.attachShader(a,o),e.attachShader(a,r),e.linkProgram(a),!e.getProgramParameter(a,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(a));return a}async function Zt(e){const t=new Image;return t.src=e,await t.decode(),t}function $t(e,t,s,i=1){const a=e*2/1.6/i,n=t*2/2/i,h=[0,0,0,.5,.5],c=[];for(let d=0;d<=s;d++){const f=d/s*2*Math.PI,u=Math.cos(f)*e,l=Math.sin(f)*t,g=u/(e*2)*a+.5,m=l/(t*2)*n+.5;h.push(u,0,l,g,m),d>0&&c.push(0,d,d+1)}return{vertices:new Float32Array(h),indices:new Uint16Array(c)}}function Kt(e=160,t=170,s=50,i=50,o=.4){const r=[],a=[];let n=0;const h=(m,p,T,y,k)=>{const R=T-m,v=y-p,M=Math.hypot(R,v),x=-v/M,B=R/M,F=k/2,q=m+x*F,Z=p+B*F,z=m-x*F,U=p-B*F,et=T+x*F,G=y+B*F,bt=T-x*F,Mt=y-B*F;r.push(q,0,Z,et,0,G,bt,0,Mt,z,0,U),a.push(n,n+1,n+2,n,n+2,n+3),n+=4},c=e/2,d=t/2,f=64;for(let m=0;m<f;m++){const p=m/f*2*Math.PI,T=(m+1)/f*2*Math.PI,y=Math.cos(p)*c,k=Math.sin(p)*d,R=Math.cos(T)*c,v=Math.sin(T)*d;h(y,k,R,v,o)}const u=[[-i/2,-i/2],[i/2,-i/2],[i/2,i/2],[-i/2,i/2]];for(let m=0;m<4;m++){const[p,T]=u[m],[y,k]=u[(m+1)%4];h(p,T,y,k,o)}function l(m){const p=m>0?-1:1,T=[];for(let y=0;y<=1e3;y++){const k=-Math.PI+y/1e3*2*Math.PI,R=Math.sin(k)*s,v=m+p*Math.cos(k)*s,M=R/c,x=v/d;M*M+x*x<=1&&T.push(k)}return T.length===0?[-Math.PI/3,Math.PI/3]:[T[0],T[T.length-1]]}const g=40;for(let m of[-t/2,t/2]){const p=m>0?-1:1,[T,y]=l(m);for(let k=0;k<g;k++){const R=T+k/g*(y-T),v=T+(k+1)/g*(y-T),M=Math.sin(R)*s,x=m+p*Math.cos(R)*s,B=Math.sin(v)*s,F=m+p*Math.cos(v)*s;h(M,x,B,F,o)}}return{vertices:new Float32Array(r),indices:new Uint16Array(a)}}const J=170,Qt=80,kt=J/2;class Jt{constructor(t,s,i){this.gl=t,this.canvas=s,this.spriteSheet=i,this.sheetCols=32,this.sheetRows=32,this.setupMainProgram(),this.setupLineProgram(),this.setupSpriteGeometry(),this.setupField(),this.setupGoalposts(),this.setupCamera(),this.setupSpritesheet(),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL)}setupSpritesheet(){const t=this.gl;t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.spriteSheet),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.texture)}setupMainProgram(){const t=`#version 300 es
      in vec3 a_position;
      in vec2 a_texcoord;
      uniform mat4 u_projection, u_view, u_model;
      out vec2 v_texcoord;
      void main() {
        gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
        v_texcoord = a_texcoord;
      }`,s=`#version 300 es
precision mediump float;

uniform sampler2D u_texture;
uniform vec4 u_tileUV;

in vec2 v_texcoord;
out vec4 outColor;

void main() {
  vec2 tileUV = mod(v_texcoord, 1.0);
  vec2 texCoord = mix(u_tileUV.xy, u_tileUV.zw, tileUV);
  vec4 texColor = texture(u_texture, texCoord);

  if (texColor.a < 0.01) discard; // Skip fully transparent fragments

  outColor = texColor;
}
`;this.program=yt(this.gl,t,s),this.uProjection=this.gl.getUniformLocation(this.program,"u_projection"),this.uView=this.gl.getUniformLocation(this.program,"u_view"),this.uModel=this.gl.getUniformLocation(this.program,"u_model"),this.uTileUV=this.gl.getUniformLocation(this.program,"u_tileUV"),this.uTexture=this.gl.getUniformLocation(this.program,"u_texture"),this.aPos=this.gl.getAttribLocation(this.program,"a_position"),this.aUV=this.gl.getAttribLocation(this.program,"a_texcoord")}setupLineProgram(){const t=`#version 300 es
    in vec3 a_position;
    uniform mat4 u_projection;
    uniform mat4 u_view;
    uniform mat4 u_model;
    void main() {
    gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
    }`,s=`#version 300 es
    precision mediump float;
    out vec4 outColor;
    void main() {
    outColor = vec4(1, 1, 1, 1);
    }`;this.lineProgram=yt(this.gl,t,s),this.lineProj=this.gl.getUniformLocation(this.lineProgram,"u_projection"),this.lineView=this.gl.getUniformLocation(this.lineProgram,"u_view"),this.lineModel=this.gl.getUniformLocation(this.lineProgram,"u_model"),this.linePos=this.gl.getAttribLocation(this.lineProgram,"a_position")}setupSpriteGeometry(){const t=this.gl;t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.depthMask(!0);const s=new Float32Array([-.5,0,0,1,.5,0,1,1,.5,1,1,0,-.5,1,0,0]),i=new Uint16Array([0,1,2,0,2,3]);this.quadVao=this.gl.createVertexArray(),this.gl.bindVertexArray(this.quadVao);const o=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o),this.gl.bufferData(this.gl.ARRAY_BUFFER,s,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.aPos,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(this.aPos),this.gl.vertexAttribPointer(this.aUV,2,this.gl.FLOAT,!1,16,8),this.gl.enableVertexAttribArray(this.aUV);const r=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,i,this.gl.STATIC_DRAW)}setupField(){const t=this.gl,{vertices:s,indices:i}=$t(Qt,kt,64,16);this.fieldVao=this.gl.createVertexArray(),this.gl.bindVertexArray(this.fieldVao);const o=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o),this.gl.bufferData(this.gl.ARRAY_BUFFER,s,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.aPos,3,this.gl.FLOAT,!1,20,0),this.gl.enableVertexAttribArray(this.aPos),this.gl.vertexAttribPointer(this.aUV,2,this.gl.FLOAT,!1,20,12),this.gl.enableVertexAttribArray(this.aUV);const r=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,i,this.gl.STATIC_DRAW),this.fieldIndices=i.length,this.fieldLineMesh=Kt(),this.lineVao=t.createVertexArray(),t.bindVertexArray(this.lineVao);const a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,this.fieldLineMesh.vertices,t.STATIC_DRAW);const n=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.fieldLineMesh.indices,t.STATIC_DRAW),t.vertexAttribPointer(this.linePos,3,t.FLOAT,!1,12,0),t.enableVertexAttribArray(this.linePos)}setupGoalposts(){this.goalPostPositions=[[-9,0,J],[-3,0,J],[3,0,J],[9,0,J],[-9,0,0],[-3,0,0],[3,0,0],[9,0,0]]}setupCamera(){this.projection=X(),Lt(this.projection,Math.PI/4,this.canvas.width/this.canvas.height,.1,1e3),this.view=X(),this.model=X()}renderSprite(t,s,i,o,r){const{gl:a,program:n,quadVao:h,uModel:c,uTileUV:d,sheetCols:f,sheetRows:u}=this;a.useProgram(n),a.bindVertexArray(h);const l=X();Q(l,l,t),at(l,l,[s,i,1]),a.uniformMatrix4fv(c,!1,l);const g=o/f,m=r/u,p=(o+1)/f,T=(r+1)/u;a.uniform4f(d,g,m,p,T),a.drawElements(a.TRIANGLES,6,a.UNSIGNED_SHORT,0)}renderScene(t,s){const i=this.gl;i.viewport(0,0,this.canvas.width,this.canvas.height),i.clearColor(.2,.6,.2,1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);const o=P(0,10,15),r=S();j(r,t.cameraTarget,o);const a=P(0,0,-20),n=S();j(n,t.cameraTarget,a),Bt(this.view,r,n,[0,1,0]),i.useProgram(this.program),i.uniformMatrix4fv(this.uProjection,!1,this.projection),i.uniformMatrix4fv(this.uView,!1,this.view),i.activeTexture(i.TEXTURE0),i.uniform1i(this.uTexture,0),i.bindVertexArray(this.fieldVao),St(this.model),Q(this.model,this.model,[0,0,kt]),i.uniformMatrix4fv(this.uModel,!1,this.model);const h=0,c=2,d=h/this.sheetCols,f=c/this.sheetRows,u=(h+1)/this.sheetCols,l=(c+1)/this.sheetRows;i.uniform4f(this.uTileUV,d,f,u,l),i.drawElements(i.TRIANGLES,this.fieldIndices,i.UNSIGNED_SHORT,0),i.useProgram(this.lineProgram),i.uniformMatrix4fv(this.lineProj,!1,this.projection),i.uniformMatrix4fv(this.lineView,!1,this.view);const g=X();Q(g,this.model,[0,.001,0]),i.uniformMatrix4fv(this.lineModel,!1,g),i.bindVertexArray(this.lineVao),i.drawElements(i.TRIANGLES,this.fieldLineMesh.indices.length,i.UNSIGNED_SHORT,0),i.useProgram(this.program),i.bindVertexArray(this.quadVao);const m=1,p=2,T=m/this.sheetCols,y=p/this.sheetRows,k=(m+1)/this.sheetCols,R=(p+1)/this.sheetRows;i.uniform4f(this.uTileUV,T,y,k,R);for(let v=0;v<this.goalPostPositions.length;v++){const[M,x,B]=this.goalPostPositions[v],q=v%4===0||v%4===3?6:10,Z=r[0]-M,z=r[2]-B,U=Math.sqrt(Z*Z+z*z),et=U>50?1.5:U>150?2:1,G=X();Q(G,G,[M,x,B]),at(G,G,[et,q,1]),i.uniformMatrix4fv(this.uModel,!1,G),i.drawElements(i.TRIANGLES,6,i.UNSIGNED_SHORT,0)}i.bindVertexArray(this.quadVao);for(const v of s)v instanceof ct?v.render(this):this.renderSprite(v.pos,v.width,v.height,1,0);t.aimTarget.render(this)}}var N,Rt,wt,Et;class te{constructor(t){ft(this,N);this.state={moveX:0,moveZ:0,kickPressed:!1,kickReleased:!1,kickHeldTime:0,aimTarget:null},this.keys={},this.lastKeys={},this.touchMove=null,this.touchAim=null,this.kPressTime=0,t.addEventListener("touchstart",st(this,N,Rt).bind(this),{passive:!1}),t.addEventListener("touchmove",st(this,N,wt).bind(this),{passive:!1}),t.addEventListener("touchend",st(this,N,Et).bind(this)),window.addEventListener("keydown",s=>this.keys[s.key.toLowerCase()]=!0),window.addEventListener("keyup",s=>this.keys[s.key.toLowerCase()]=!1)}endUpdate(){this.state.moveX=0,this.state.moveZ=0,this.state.kickPressed=!1,this.state.kickReleased=!1}update(t){var r;const s=!!this.keys.k,i=!!this.lastKeys.k;if(s&&!i&&(this.state.kickPressed=!0,this.kPressTime=0,this.state.aimTarget=[0,0]),s?(this.kPressTime+=t,this.state.aimTarget&&(this.keys.a&&(this.state.aimTarget[0]-=30*t),this.keys.d&&(this.state.aimTarget[0]+=30*t),this.keys.w&&(this.state.aimTarget[1]-=30*t),this.keys.s&&(this.state.aimTarget[1]+=30*t))):(this.keys.a&&(this.state.moveX-=1),this.keys.d&&(this.state.moveX+=1),this.keys.w&&(this.state.moveZ-=1),this.keys.s&&(this.state.moveZ+=1)),!s&&i&&(this.state.kickReleased=!0),this.state.kickHeldTime=this.kPressTime,this.touchMove&&!this.touchAim&&(this.state.moveX=this.touchMove.dx/50,this.state.moveZ=this.touchMove.dy/50),this.touchAim){this.kPressTime+=t;const a=this.touchAim.dx,n=this.touchAim.dy;console.log("Touch aim:",a,n);const h=10;this.state.aimTarget=[-a/h,-n/h],this.state.kickHeldTime=this.kPressTime}const o=(r=navigator.getGamepads)==null?void 0:r.call(navigator)[0];if(o){this.state.moveX+=o.axes[0]||0,this.state.moveZ+=-(o.axes[1]||0);const a=o.axes[2]||0,n=-(o.axes[3]||0),h=Math.hypot(a,n);h>.2&&(this.state.aimTarget=[a/h,n/h])}this.lastKeys={...this.keys}}getState(){return this.state}}N=new WeakSet,Rt=function(t){t.preventDefault();for(const s of t.changedTouches)s.clientX<window.innerWidth/2?this.touchMove={id:s.identifier,startX:s.clientX,startY:s.clientY,dx:0,dy:0}:(this.touchAim={id:s.identifier,startX:s.clientX,startY:s.clientY,dx:0,dy:0},this.state.kickPressed=!0,this.kPressTime=0)},wt=function(t){t.preventDefault();for(const s of t.changedTouches)this.touchMove&&s.identifier===this.touchMove.id&&(this.touchMove.dx=s.clientX-this.touchMove.startX,this.touchMove.dy=s.clientY-this.touchMove.startY),this.touchAim&&s.identifier===this.touchAim.id&&(this.touchAim.dx=s.clientX-this.touchAim.startX,this.touchAim.dy=s.clientY-this.touchAim.startY)},Et=function(t){t.preventDefault();for(const s of t.changedTouches)this.touchAim&&s.identifier===this.touchAim.id&&(this.touchAim=null,this.state.kickReleased=!0),this.touchMove&&s.identifier===this.touchMove.id&&(this.touchMove=null)};class ee{constructor(t,s){if(this.canvas=t,this.gl=t.getContext("webgl2"),!this.gl)throw new Error("WebGL2 not supported");this.renderer=new Jt(this.gl,t,s),this.controls=new te(t),this.setPiece=null,this.entities=[],this.aimTarget=new qt([5,.001,b/2]),this.ball=new Wt(P(0,0,b/2)),this.entities.push(this.ball),this.players=[],this.chasers=0,this.followers=0,this.homePositions=Tt(),this.awayPositions=Tt(!0);const i=[[this.homePositions,"home"],[this.awayPositions,"away"]];for(let[o,r]of i)for(const[a,n]of Object.entries(o)){const h=new Yt(a,r,n,!a.toLowerCase().startsWith("bench"));this.entities.push(h),this.players.push(h),a==="RR"&&r==="home"&&(this.player=h)}this.cameraTarget=P(0,10,b/2),this.cameraPos=P(0,10,b/2+15),this.resize(),window.addEventListener("resize",()=>this.resize()),this.lastTime=performance.now()}start(){this.lastTime=performance.now(),requestAnimationFrame(this.loop.bind(this))}loop(t){var r,a;const s=(t-this.lastTime)/1e3,i=Math.min(s,1/30);this.lastTime=t,this.controls.update(i),this.chasers=0,this.followers=0;const o=_(this.ball.pos);for(const n of this.entities)n.update(i,this);if(this.setPiece&&(this.setPiece.update(i),this.setPiece.finished&&(this.setPiece=null)),!this.setPiece){let n=Nt(o,this.ball.pos);if(n!==null){if(n==="goalAway"&&(this.ball.lastTouchedType!=="kick"||((r=this.ball.lastTouchedBy)==null?void 0:r.team)==="home")?n="behindAway":n==="goalHome"&&(this.ball.lastTouchedType!=="kick"||((a=this.ball.lastTouchedBy)==null?void 0:a.team)==="away")?n="behindHome":n==="innerLeftPostAway"||n==="innerRightPostAway"?n="behindAway":(n==="innerLeftPostHome"||n==="innerRightPostHome")&&(n="behindHome"),n==="behindAway"){const h=this.players.find(c=>c.name==="FB"&&c.team==="home");h&&(this.setPiece=new nt(this,h,P(0,0,b-10)))}if(n==="behindHome"){const h=this.players.find(c=>c.name==="FB"&&c.team==="away");h&&(this.setPiece=new nt(this,h,P(0,0,10)))}if(n==="goalAway"||n==="goalHome"||n==="outOfBounds")for(const h of this.entities)h.setupForBoundary(n,this.ball.pos)}}this.updateCameraTarget(),this.updatePlayerControl(),this.renderer.renderScene(this,this.entities),this.controls.endUpdate(),requestAnimationFrame(this.loop.bind(this))}updatePlayerControl(){const t=this.players.filter(r=>r.team==="home"),s=this.ball.carrier;if(!s||s&&s.team==="home")return;let i=null,o=1/0;for(const r of t){if(r.actionState==="tackle")continue;const a=Vt(r.pos,s.pos),n=(Math.abs(r.positionPos[0]-this.ball.pos[0])<10?-10:0)+(r.energy<.3?-5:0)+(r.pos[2]>s.pos[2]?-10:0);a+n<o&&(i=r,o=a+n)}i&&(this.player=i,this.player.aiming=!1)}updateCameraTarget(){const t=this.ball,s=t.carrier,i=.025;if(s)if(s.team==="home")tt(this.cameraTarget,this.cameraTarget,s.pos,i);else{const r=P(0,0,15);tt(this.cameraTarget,this.cameraTarget,j(S(),s.pos,r),i)}else{const o=P(0,0,15);tt(this.cameraTarget,this.cameraTarget,j(S(),t.pos,o),i)}}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.renderer.setupCamera()}}const se="/footy/assets/spritesheet-C9G_3zho.png";function ie(e){const t=document.getElementById("glcanvas");if(!t)throw console.error("Canvas element not found"),new Error("Canvas element not found");new ee(t,e).start()}Zt(se).then(e=>{if(!e.complete)throw console.error("Failed to load sprite sheet"),new Error("Sprite sheet not loaded");ie(e)});
