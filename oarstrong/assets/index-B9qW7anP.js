var Wt=Object.defineProperty;var At=(a,t,s)=>t in a?Wt(a,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[t]=s;var l=(a,t,s)=>At(a,typeof t!="symbol"?t+"":t,s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))e(i);new MutationObserver(i=>{for(const h of i)if(h.type==="childList")for(const n of h.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&e(n)}).observe(document,{childList:!0,subtree:!0});function s(i){const h={};return i.integrity&&(h.integrity=i.integrity),i.referrerPolicy&&(h.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?h.credentials="include":i.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function e(i){if(i.ep)return;i.ep=!0;const h=s(i);fetch(i.href,h)}})();function Ht(a,t){for(let s=1e3;s>0;s--)if(t())return;throw"Timeout while trying to "+a}function lt(a,t=0){return t!=0?a+Math.floor(Math.random()*(t-a)):Math.floor(Math.random()*a)}function Ot(a,t){return[lt(a),lt(t)]}function ut(a){let t=a.length,s;for(;t!=0;)s=Math.floor(Math.random()*t),t--,[a[t],a[s]]=[a[s],a[t]];return a}function yt(a){return a[Math.floor(Math.random()*a.length)]}class _ extends Array{constructor(...t){t.length==1&&t[0]instanceof Array?super(...t[0]):super(...t)}sum(){let t=0;return this.forEach(s=>t+=s),t}mean(){return this.sum()/this.length}max(){return Math.max.apply(null,this)}min(){return Math.min.apply(null,this)}vars(){let t=0;return this.forEach(s=>t+=s*s),(t-this.length*this.mean()^2)/(this.length-1)}var(){let t=0;return this.forEach(s=>t+=s*s),t/this.length-this.mean()^2}std(){return Math.sqrt(this.var())}add(t){let s=new _(this);if(t instanceof Array||t instanceof _)for(let e=0;e<this.length;e++)s[e]+=t[e];else for(let e=0;e<this.length;e++)s[e]+=t;return s}mul(t){let s=new _(this);if(t instanceof Array||t instanceof _)for(let e=0;e<this.length;e++)s[e]*=t[e];else for(let e=0;e<this.length;e++)s[e]*=t;return s}dot(t){return this.mul(t).sum()}abs(){return Math.abs.apply(null,this)}shift(t){let s=new _;for(let e=-t;e<this.length-t;e++)e<0||e>=this.length?s.push(NaN):s.push(this[e]);return s}filter(t){return new _(super.filter(t))}dropNaN(){return this.filter(t=>!Number.isNaN(t))}}class u extends Array{constructor(t){super(),this[0]=t[0],this[1]=t[1]}static random(t){return new u(Ot(t[0],t[1]))}add(t){return new u([this[0]+t[0],this[1]+t[1]])}scale(t){return new u([this[0]*t,this[1]*t])}mul(t){return new u([this[0]*t[0],this[1]*t[1]])}dot(t){return this[0]*t[0]+this[1]*t[1]}dist(t){return Math.hypot(this[0]-t[0],this[1]-t[1])}set x(t){this[0]=t}set y(t){this[1]=t}get x(){return this[0]}get y(){return this[1]}}class f extends Array{constructor(t){super(),this.length=4,this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3]}set x(t){this[0]=t}set y(t){this[1]=t}set w(t){this[2]=t}set h(t){this[3]=t}set pos(t){this[0]=t[0],this[1]=t[1]}get pos(){return new u([this[0],this[1]])}get x(){return this[0]}get y(){return this[1]}get w(){return this[2]}get h(){return this[3]}get right(){return this[0]+this[2]}get bottom(){return this[1]+this[3]}get center_x(){return this[0]+this[2]/2}get center_y(){return this[1]+this[3]/2}get center(){return new u([this.center_x,this.center_y])}shift(t){return new f([this.x+t[0],this.y+t[1],this.w,this.h])}shrinkBorders(t){return new f([this.x+t,this.y+t,this.w-t*2,this.h-t*2])}scale(t,s=!0){if(s){let e=[this[2]*t,this[3]*t];return new f([this[0]+.5*(this[2]-e[0]),this[1]+.5*(this[3]-e[1]),e[0],e[1]])}else{let e=[this[2]*t,this[3]*t];return new f([this[0],this[1],e[0],e[1]])}}collide(t){return this.x<t.x+t.w&&this.x+this.w>t.x&&this.y<t.y+t.h&&this.h+this.y>t.y}contact(t){return this.x<=t.x+t.w&&this.x+this.w>=t.x&&this.y<=t.y+t.h&&this.h+this.y>=t.y}}function y(a,t){return Math.floor(Math.random()*(t-a+1))+a}function wt(a){let t="";return a.forEach(s=>{s+="";for(let e=s.length;e<10;e++)s+=" ";t+=s}),t}class I{constructor(t,s=0){this.elapsed=0,this.timer=t,this.triggered=!1,s>0&&this.tick(s)}finished(){return this.elapsed>=this.timer}tick(t){return this.elapsed>=this.timer?(this.triggered&&(this.triggered=!1),!1):(this.elapsed+=t,this.elapsed>=this.timer?(this.triggered=!0,!0):!1)}reset(t=-1,s=0){this.elapsed=s,this.triggered=!1,t>=0&&(this.timer=t)}}const S={left:!1,right:!1,up:!1,down:!1,cycle:!1,use:!1,dodge:!1,dash:!1,camera:!1,menu:!1};var bt={...S};function nt(){return{...bt}}var D={...S};({...S});function Rt(a){D={...a}}var H=null,Lt={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down",a:"left",d:"right",w:"up",s:"down",j:"dash",k:"use",l:"cycle",i:"dodge"," ":"dash",z:"use",x:"cycle",c:"dodge",0:"camera",Escape:"menu"};class ct{constructor(){this.controlStates={...bt},this.attach_to_player(),window.addEventListener("blur",t=>{this.clearPressedAll()})}attach_to_player(t=null){this.player=t,H=this,t!=null&&(this.player.controller=this)}set(t,s=!0){S[t]=s,H=this;let e=this.player;e!=null&&(e.controlStates[t]=s)}clearPressedAll(){for(const t in this.controlStates)this.controlStates[t]=!1}vibrate(t,s,e){}}class Et extends ct{constructor(t,s=null){super(),this.game=t,s==null&&(s=Lt),this.keyMap=s;let e=this;document.onkeydown=function(i){e.keyDownHandler(i)},document.onkeyup=function(i){e.keyUpHandler(i)}}keyDownHandler(t){t.key=="p"&&(this.game.fillScreen=!this.game.fillScreen,this.game.updateWindowSize()),t.key=="f"&&(this.game.showFPS=!this.game.showFPS,this.game.updateWindowSize()),t.key=="G"&&(this.game.cullOffCamera=!this.game.cullOffCamera),t.key in this.keyMap&&this.set(this.keyMap[t.key],!0)}keyUpHandler(t){t.key in this.keyMap&&this.set(this.keyMap[t.key],!1)}}class Gt extends ct{constructor(t,s){super(),this.game=t,this.gamepad=s,this.thresh=.2,this.internalStates={...this.controlStates}}set(t,s=!0){this.internalStates[t]!=s&&(this.internalStates[t]=s,super.set(t,s))}vibrate(t,s,e){this.game.activePlayers.length==1&&window.navigator.vibrate(e),this.gamepad.vibrationActuator!=null&&this.gamepad.vibrationActuator.playEffect("dual-rumble",{startDelay:0,duration:e,weakMagnitude:t,strongMagnitude:s})}}class Yt{constructor(t){l(this,"gamepads",{});let s=this;this.game=t,window.addEventListener("gamepadconnected",function(e){s.connected(e)}),window.addEventListener("gamepaddisconnected",function(e){s.disconnected(e)})}connected(t){this.gamepads[t.gamepad.index]=new Gt(this.game,t.gamepad)}disconnected(t){let s=this.gamepads[t.gamepad.index];s.player!=null&&(s.player.dead=!0,s.player.dropFromGame=!0),delete this.gamepads[t.gamepad.index]}update_gamepad_states(){let t=navigator.getGamepads();if(t!=null)for(let s of t){if(s==null)continue;let e=this.gamepads[s.index];e.gamepad=s,e.set("dash",this.buttonPressed(s.buttons[0])),e.set("cycle",this.buttonPressed(s.buttons[1])||this.buttonPressed(s.buttons[6])),e.set("use",this.buttonPressed(s.buttons[2])||this.buttonPressed(s.buttons[7])),e.set("dodge",this.buttonPressed(s.buttons[5])),e.set("camera",this.buttonPressed(s.buttons[12])),e.set("menu",this.buttonPressed(s.buttons[9])),e.set("left",s.axes[0]<-e.thresh&&s.axes[0]<-.5*Math.abs(s.axes[1])),e.set("right",s.axes[0]>e.thresh&&s.axes[0]>.5*Math.abs(s.axes[1])),e.set("up",s.axes[1]<-e.thresh&&s.axes[1]<-.5*Math.abs(s.axes[0])),e.set("down",s.axes[1]>e.thresh&&s.axes[1]>-.5*Math.abs(s.axes[0]))}}buttonPressed(t){return typeof t=="object"?t.pressed:t==1}attach_all_to_player(t){for(let s of Object.keys(this.gamepads))this.gamepads[s].attach_to_player(t)}release_all_players(){for(let t of Object.keys(this.gamepads))this.gamepads[t].attach_to_player()}}class Xt extends ct{constructor(s){super();l(this,"canvas");this.game=s;const e=document.getElementById("canvas");if(e instanceof HTMLCanvasElement){this.canvas=e;let i=this;e.addEventListener("touchstart",function(h){i.process_touchstart(h)},!1),e.addEventListener("touchmove",function(h){i.process_touchmove(h)},!1),e.addEventListener("touchcancel",function(h){i.process_touchend(h)},!1),e.addEventListener("touchend",function(h){i.process_touchend(h)},!1),document.addEventListener("backbutton",function(h){i.process_back(h)},!0)}this.dPad=[-1,0,0],this.butJump=[-1,0,0],this.butInv=[-1,0,0],this.butUse=[-1,0,0],this.butCamera=[-1,0,0]}process_back(s){console.log("Back pressed",s),this.set("menu",!0)}process_touchstart(s){let e=this.canvas;s.touches[0];for(let i of s.changedTouches)i.clientX<.5*e.width?i.clientY>.33*e.height?this.dPad=[i.identifier,i.clientX,i.clientY]:(this.set("camera"),this.butCamera=[i.identifier,i.clientX,i.clientY]):i.clientY>.66*e.height?(this.set("jump"),this.butJump=[i.identifier,i.clientX,i.clientY]):i.clientY<.33*e.height?(this.set("cycle"),this.butInv=[i.identifier,i.clientX,i.clientY]):(this.set("use"),this.butUse=[i.identifier,i.clientX,i.clientY]);s.preventDefault()}process_touchmove(s){for(let e of s.changedTouches)if(e.identifier==this.dPad[0]){let i=this.dPad[1],h=this.dPad[2];for(let n of["left","right","up","down","run","camera"])this.set(n,!1);this.set("left",e.clientX<i-.1*this.game.tileSize&&e.clientX-i<-.5*Math.abs(e.clientY-h)),this.set("right",e.clientX>i+.1*this.game.tileSize&&e.clientX-i>.5*Math.abs(e.clientY-h)),this.set("up",e.clientY<h-.1*this.game.tileSize&&e.clientY-h<-.5*Math.abs(e.clientX-i)),this.set("down",e.clientY>h+.1*this.game.tileSize&&e.clientY-h>.5*Math.abs(e.clientX-i)),this.set("run",e.clientX<i-this.game.tileSize||e.clientX>i+this.game.tileSize||e.clientY>h+this.game.tileSize||e.clientY<h-this.game.tileSize)}s.preventDefault()}process_touchend(s){for(let e of s.changedTouches){if(e.identifier==this.dPad[0]){for(let i of["left","right","up","down"])this.set(i,!1);this.dPad=[-1,0,0]}e.identifier==this.butInv[0]&&this.set("cycle",!1),e.identifier==this.butUse[0]&&this.set("use",!1),e.identifier==this.butJump[0]&&this.set("jump",!1),e.identifier==this.butCamera[0]&&this.set("camera",!1)}s.preventDefault()}vibrate(s,e,i){window.navigator.vibrate(i)}}function r(a,t){return[a,t]}function L(a,t,s,e){return[a,t,s,e]}class R{constructor(t,s,e=16){this.spriteSize=e,this.sheet=new Image,this.sheet.src=s,this.game=t}draw(t,s,e,i=!1){let h=i?-1:1;i&&this.game.ctx.scale(-1,1),this.game.ctx.drawImage(this.sheet,t[0]*this.spriteSize,t[1]*this.spriteSize,this.spriteSize,this.spriteSize,h*(s*this.game.tileSize+this.game.shakeX+this.game.gameOffsetX),e*this.game.tileSize+this.game.shakeY+this.game.gameOffsetY,h*this.game.tileSize,this.game.tileSize),i&&this.game.ctx.scale(-1,1)}drawScaled(t,s,e,i,h=!1){let n=h?-1:1;h&&this.game.ctx.scale(-1,1),this.game.ctx.drawImage(this.sheet,t[0]*this.spriteSize,t[1]*this.spriteSize,this.spriteSize,this.spriteSize,n*(s*this.game.tileSize+this.game.shakeX+this.game.gameOffsetX),e*this.game.tileSize+this.game.shakeY+this.game.gameOffsetY,n*this.game.tileSize*i,this.game.tileSize*i),h&&this.game.ctx.scale(-1,1)}drawRotated(t,s,e,i,h=!1,n="center"){const o=this.game;o.ctx.save(),n=="center"?n=[o.tileSize/2,o.tileSize/2]:n=[n[0]*o.tileSize,n[1]*o.tileSize],o.ctx.translate(s*o.tileSize+o.shakeX+o.gameOffsetX+n[0],e*o.tileSize+o.shakeY+o.gameOffsetY+n[1]),o.ctx.rotate(i*Math.PI/180),h&&o.ctx.scale(-1,1),o.ctx.translate(-n[0],-n[1]),o.ctx.drawImage(this.sheet,t[0]*this.spriteSize,t[1]*this.spriteSize,this.spriteSize,this.spriteSize,0,0,o.tileSize,o.tileSize),o.ctx.restore()}drawRotatedMultitile(t,s,e,i,h=!1,n="center"){const o=this.game;o.ctx.save();let d=t[2],c=t[3];n=="center"?n=[d*o.tileSize/2,c*o.tileSize/2]:n=[n[0]*o.tileSize,n[1]*o.tileSize],o.ctx.translate(s*o.tileSize+o.shakeX+o.gameOffsetX+n[0],e*o.tileSize+o.shakeY+o.gameOffsetY+n[1]),o.ctx.rotate(i*Math.PI/180),h&&o.ctx.scale(-1,1),o.ctx.translate(-n[0],-n[1]),o.ctx.drawImage(this.sheet,t[0]*this.spriteSize,t[1]*this.spriteSize,this.spriteSize*d,this.spriteSize*c,0,0,o.tileSize*d,o.tileSize*c),o.ctx.restore()}}const kt=Object.freeze({OneEye:0,TwoEye:1,Tank:2,Eater:3,Jester:4}),x=Object.freeze({BeachUpper:r(4,1),BeachLower:r(9,1),Water:r(10,1),Jelly:r(11,1),Cannonball:r(13,2),Wall:r(13,1),WallEnd:r(13,0),Pillar1:r(6,1),Pillar2:r(7,1),Pillar3:r(8,1),PlayerCharacter1:r(0,8),PlayerCharacter2:r(1,8),PlayerCharacter3:r(2,8),PlayerCharacter4:r(3,8),Slash:r(10,7),Strike:r(10,7),Cutlas:r(11,7),Crab:r(6,4),CrabShot:r(12,1)}),gt=Object.freeze({Boss1:L(0,3,3,3),CanonNS:L(11,3,1,2),CanonEW:L(12,3,2,1),Palm:L(4,2,2,2)}),z=Object.freeze({KioskScreen:r(0,0),KioskDispenser:r(0,1),Floor:r(1,0),Wall:r(2,0),Ledge:r(3,0),Ladder:r(4,0),Exit:r(5,0),LockedExit:r(6,0),TrapBlock:r(7,0),Pillar:r(8,0),Lights:r(0,1),FlowerBox:r(1,1),PlantBox:r(1,2),TreeTop:r(2,1),TrunkBox:r(2,2),AppleTreeTop:r(3,1),Trunk:r(3,2),BerryBush:r(4,1),Bush:r(4,2),VineBranchRight:r(5,1),VineUp:r(5,2),VineRightUp:r(6,1),VineLeftUp:r(6,2),VineTerminator:r(7,1),VineBranchLeft:r(7,2),VineLeft:r(10,2),VineRight:r(11,2),PineBox:r(8,1),VineBox:r(8,2),PineTop:r(9,1),PineMid:r(9,2),WaterTankLeft:r(10,1),WaterTankRight:r(11,1),LockerClosed:r(0,3),LockerOpen:r(1,3),RazorWireLeft:r(2,3),RazorWire:r(3,3),RazorWireRight:r(4,3),RazorWirePost:r(5,3),ShotWall1:r(6,3),ShotWall2:r(7,3),BlastedLadder1:r(8,3),BlastedLadder2:r(9,3),BlastedWall1:r(10,3),BlastedWall2:r(11,3),Debris1:r(12,3),BlastedPillar:r(13,3),BluePrint:r(0,4),Potions:r(1,4),Burner:r(2,4),Desk:r(7,4),Chair:r(8,4),CryoBottom:r(3,4),CryoTop:r(4,4),CryoMiddle:r(5,4),SuspendedWiresPlatform:r(6,4),SuspendedWiresVert:r(6,5),SuspendedWiresEnd:r(6,6),Dirt1:r(0,5),Dirt2:r(0,6),Dirt3:r(1,6),Drill1:r(1,5),Drill2:r(2,6),Drill3:r(3,6),DirtLeft:r(2,5),DirtBottom:r(3,5),DirtRight:r(4,5),DirtTop:r(5,5)}),p=Object.freeze({Chips:r(0,0),Energy:r(1,0),Key:r(2,0),LiveGrenade:r(3,0),Shot1:r(4,0),Shot2:r(5,0),Shot3:r(6,0),Boom:r(7,0),Drone1:r(8,0),Drone2:r(9,0),Platform:r(10,0),TrapBlade:r(11,0),GunTurretBase:r(12,0),GunTurretBarrel:r(13,0),LiveRocket:r(14,0),LiveVibroBlade:r(15,0),Reticle:r(16,0),Strike:r(17,0),InventorySelector:r(0,1),Gun:r(1,1),Grenade:r(2,1),Wrench:r(3,1),JetPack:r(4,1),Fist:r(5,1),GrappleGun:r(6,1),Glider:r(7,1),Shotgun:r(8,1),RocketLauncher:r(9,1),Shield:r(10,1),Drone:r(11,1),VibroBlade:r(12,1),AssaultRifle:r(13,1),ClimbingGlove:r(14,1),Boot1:r(0,2),Boot2:r(1,2),Boot3:r(2,2),Health:r(0,3),Pickup1:r(1,3),Pickup2:r(2,3),Frag:L(30,0,2,2)}),k=Object.freeze({Health:r(0,3),Gun:r(1,1),Grenade:r(2,1),Wrench:r(3,1),JetPack:r(4,1),Fist:r(5,1),GrappleGun:r(6,1),Glider:r(7,1),Shotgun:r(8,1),RocketLauncher:r(9,1),Shield:r(10,1),Drone:r(11,1),VibroBlade:r(12,1),AssaultRifle:r(13,1),ClimbingGlove:r(14,1)});class v{constructor(t,s){this.pos=new u([0,0]),this.vel=new u([0,0]),this.oldVel=new u([0,0]),this.angle=0,this.isPlayer=!1,this.size=new u([1,1]),this.boundingBox=new f([.25,.25,.5,.5]),this.boundingBoxes=[],this.facing=1,this.falling=!1,this.canFall=!0,this.dead=!1,this.sprite=s,this.hitBox=new f(this.boundingBox),this.move(t),this.oldPos=new u(this.pos)}move(t){t!==null?this.pos=new u([t[0],t[1]]):this.pos=new u([-1,-1])}rotatedBoundingBox(t=null,s=null,e=null,i=null,h=null){e=e??this.getFlipped(),s=s??this.angle,t==null&&(t=this.sprite.length==2?[.5,.5]:[.5*this.sprite[2],.5*this.sprite[3]]),i==null&&(i=[this.boundingBox[0]+this.boundingBox[2]/2,this.boundingBox[1]+this.boundingBox[3]/2]),h==null&&(h=this.boundingBox.slice(2,4));let n=(i[0]-t[0])*(1-2*e),o=i[1]-t[1],d=Math.cos(s/180*Math.PI),c=Math.sin(s/180*Math.PI),m=-(n-n*d+o*c),w=-(o-n*c-o*d);return new f([(i[0]-t[0])*(1-2*e)+t[0]+m-h[0]/2,i[1]+w-h[1]/2,h[0],h[1]])}bounds(t=null,s=null){return t==null&&(t=this.pos),s==null&&(s=this.boundingBox!=null?this.boundingBox:this.boundingBoxes[0]),new f([t[0]+s[0],t[1]+s[1],s[2],s[3]])}hitBounds(t=null){return t==null&&(t=this.pos),new f([t[0]+this.hitBox[0],t[1]+this.hitBox[1],this.hitBox[2],this.hitBox[3]])}getDisplayX(){return this.pos.x}getDisplayY(){return this.pos.y}getFlipped(){return this.facing==-1}draw(t){t.sprites.base.draw([this.sprite[0],this.sprite[1]],this.getDisplayX(),this.getDisplayY(),this.getFlipped())}draw_bounds(t){if(this.boundingBox!=null){let s=this.bounds(this.pos,this.boundingBox);s[0]=s[0]*t.tileSize+t.shakeX+t.gameOffsetX,s[1]=s[1]*t.tileSize+t.shakeY+t.gameOffsetY,s[2]=s[2]*t.tileSize,s[3]=s[3]*t.tileSize,t.ctx.beginPath(),t.ctx.lineWidth=t.tileSize/16,t.ctx.strokeStyle="#BAC3D9",t.ctx.rect(s[0],s[1],s[2],s[3]),t.ctx.stroke()}else for(let s of this.boundingBoxes){let e=this.bounds(this.pos,s);e[0]=e[0]*t.tileSize+t.shakeX+t.gameOffsetX,e[1]=e[1]*t.tileSize+t.shakeY+t.gameOffsetY,e[2]=e[2]*t.tileSize,e[3]=e[3]*t.tileSize,t.ctx.beginPath(),t.ctx.lineWidth=t.tileSize/16,t.ctx.strokeStyle="#BAC3D9",t.ctx.rect(e[0],e[1],e[2],e[3]),t.ctx.stroke()}}entityInteract(t,s,e){}entityCollide(t,s){}update(t,s){}}class ft extends v{constructor(t,s,e=1){super(t,s),this.hp=e,this.maxHp=e,this.facing=y(0,1)*2-1,this.topSpeed=1/600,this.jumpSpeed=1/350,this.maxFallSpeed=1/50,this.hitDamage=1,this.spawnTimer=1e3,this.spawnElapsed=0,this.stunTimer=new I(0,0),this.hitTimer=new I(0,0),this.boundingBox=new f([.25,.5,.5,.5]),this.hitBox=new f([.25,.2,.5,.8]),this.drone=!1,this.climbing=!1,this.falling=!1,this.dying=!1,this.intelLevel=1,this.stance="aggressive"}draw(t){t.sprites.monsters.draw([this.dying?1:0,this.sprite[1]],this.getDisplayX(),this.getDisplayY(),this.getFlipped()),this.hitTimer.finished()||x.Strike.length===2&&t.sprites.entitiesItems.draw(x.Strike,this.getDisplayX(),this.getDisplayY(),this.getFlipped())}die(t){this.stun(),this.dying=!0}death(t){if(this.dead=!0,!this.isPlayer){let s=t.tiles.closestTile(this.bounds());if(s instanceof b)return;t.addChips(s,1)}}heal(t){this.hp=Math.min(this.maxHp,this.hp+t)}tile_pos(){return new u([Math.round(this.pos.x),Math.ceil(this.pos.y)])}stun(t=2e3){this.dying||this.stunTimer.reset(t)}update(t,s){if(this.spawnElapsed+=s,this.spawnElapsed<this.spawnTimer)return;this.hitTimer.tick(s),this.stunTimer.tick(s);let e=!this.stunTimer.finished();if(!e&&this.dying){this.death(t);return}if(this.dying&&(this.vel=this.vel.scale(.9**(s/15))),!e&&!this.drone){if(this.stance=="targeting"){let i,h;if([i,h]=t.nearestPlayer(this.pos),i!=null){let n=Math.abs(i.pos.x-this.pos.x),o=Math.abs(i.pos.y-this.pos.y);n>=2&&o<=1.5?this.facing=this.pos.x<i.pos.x?1:-1:!this.falling&&this.vel.x==0&&(this.facing=-this.facing)}}else!this.falling&&this.vel.x==0;(!this.falling||Math.abs(this.vel.x)<this.topSpeed)&&(this.vel.x=this.facing*this.topSpeed)}if(e&&!this.drone&&!this.falling&&(this.vel.x/=1.5*s/15),!e&&!this.drone&&t.levelTime>0&&!this.falling){this.bounds();let i;i=t.tiles.closestPos(this.pos.add([0,0]));let h=i.add([0,1]),n=h.add([this.facing,0]),o=i,d=o.add([this.facing,0]);if(this.facing*(this.pos.x-i.x)<=0&&!t.tiles.at(h).standable)if(this.intelLevel>1&&t.tiles.at(o).passable&&t.tiles.at(d).passable&&t.tiles.at(n)instanceof E)this.vel.y=-1/400,this.vel.x=this.facing*this.jumpSpeed;else{let c=h.add([0,1]);if(this.stance=="targeting"){let[m,w]=t.nearestPlayer(this.pos);m!=null&&m.pos.y>this.pos.y&&t.tiles.at(c).passable&&t.tiles.below(c).tile.passable&&(this.vel.x=0)}else t.tiles.at(c).passable&&(this.vel.x=0)}else{let c=i.add([this.facing,0]),m=i.add([0,-1]),w=m.add([this.facing,0]);if(this.stance=="targeting"){let[T,g]=t.nearestPlayer(this.pos);T!==null&&T.pos.y<this.pos.y?!t.tiles.at(c).passable&&t.tiles.at(w).passable&&t.tiles.rightOf(w).tile.passable&&(this.vel.y=-1/200,this.vel.x=this.facing*this.jumpSpeed):(this.facing<0&&this.pos.x<=i.x||this.facing>0&&this.pos.x>=i.x)&&!t.tiles.at(c).passable&&t.tiles.at(m).passable&&t.tiles.at(w).passable&&(this.vel.y=-1/200,this.vel.x=this.facing*this.jumpSpeed)}else(this.facing<0&&this.pos.x<=i.x||this.facing>0&&this.pos.x>=i.x)&&!t.tiles.at(c).passable&&t.tiles.at(m).passable&&t.tiles.at(w).passable&&(this.vel.y=-1/200,this.vel.x=this.facing*this.jumpSpeed)}}if(this.canFall,t.tiles.move(this,s),!e)for(let i of t.activePlayers)i.hitBounds().collide(this.bounds())&&(i.hitFrom(t,this.pos,this.hitDamage,this.hitDamage),i.stun(500*this.hitDamage));this.pos.y>t.tiles.dimH&&this.die(t)}hitFrom(t,s,e,i=0){this.hp-=e,e>0&&this.hitTimer.reset(200),this.hp<=0&&this.die(t);const h=this.pos.dist(s);if(h>0){const n=this.pos.add(s.scale(-1)).scale(1/h);this.vel.x=i*1/200*n[0],this.vel.y=i*1/200*n[1]}this.falling=!0}tile_collide(t){return t.bounds.collide(this.bounds())}monster_collide(t){return t.bounds.collide(this.bounds())}fallCheck(t,s){return!1}fallBoom(t,s){this.die(t),t.playSound("boom");for(let e of t.tiles.iterRange(t.tiles.closestPos(this.pos),s))e instanceof E||t.addBoom(e,.5);for(let e of t.monsters)this.pos.dist(e.pos)<=s&&e.hitFrom(t,this.pos,this.hitDamage*3);for(let e of t.activePlayers)this.pos.dist(e.pos)<=s&&e.hitFrom(t,this.pos,this.hitDamage*3)}}class jt extends ft{constructor(t){super(t,[0,kt.OneEye],1),this.hp=1,this.topSpeed=.5*this.topSpeed,this.fallOrigin=null,this.stance="passive"}draw(t){x.Jelly.length===2&&t.sprites.base.draw(x.Jelly,this.getDisplayX(),this.getDisplayY(),this.getFlipped()),this.hitTimer.finished()||x.Slash.length===2&&t.sprites.base.draw(x.Slash,this.getDisplayX(),this.getDisplayY(),this.getFlipped())}update(t,s){super.update(t,s)}}class Mt extends ft{constructor(t){super(t,[0,kt.OneEye],1),this.hp=1,this.topSpeed=.5*this.topSpeed,this.fallOrigin=null,this.stance="passive",this.launchTimer=new I(1e4,Math.random()*5e3),this.launching=0}draw(t){x.Crab.length===2&&t.sprites.base.draw(x.Crab,this.getDisplayX(),this.getDisplayY(),this.getFlipped())}update(t,s){super.update(t,s),this.launchTimer.tick(s),this.launchTimer.finished()&&(this.launching<=8?(this.launchTimer.reset(500),t.items.push(new Vt(t.tiles.at(this.tile_pos()),null,this.launching*45))):(this.launching=0,this.launchTimer.reset(2e3-0*Math.random())),this.launching++)}}const rt=0,vt=1,W=2,X=3,j=4,ot=5;class G extends ft{constructor(s=-1,e=null){super(e,[0,s],3);l(this,"isPlayer",!0);l(this,"boundingBox",new f([.25,.5,.5,.5]));l(this,"hitBox",new f([.25,.25,.5,.5]));l(this,"dashBox",new f([0,0,1,1]));l(this,"immunityTimer",new I(1e3,1e3));l(this,"selectedTimer",new I(500,500));l(this,"hitTimer",new I(500,500));l(this,"stunTimer",new I(500,500));l(this,"jumpTimer",new I(0,0));l(this,"selectedSprite",null);l(this,"escaped",!1);l(this,"running",!1);l(this,"climbing",!1);l(this,"aiming",!1);l(this,"dropFromGame",!1);l(this,"startLevel",0);l(this,"lastVel",new u([0,0]));l(this,"maxHp",4);l(this,"topSpeed",1/250);l(this,"jumpSpeed",1/135);l(this,"maxFallSpeed",1/50);l(this,"airJumps",0);l(this,"wallJumps",0);l(this,"spikedBoots",0);l(this,"chips",0);l(this,"dead",!1);l(this,"score",0);l(this,"deaths",0);l(this,"pause",0);l(this,"lastFacing",0);l(this,"lastFramePos",new u([0,0]));l(this,"currentFrame",0);l(this,"useTimer",new I(0));l(this,"hookHitModifier",[]);l(this,"hookUpdate",[]);l(this,"activeState",j);l(this,"stateTimer",new I);l(this,"controller",null);this.inventory=new he(this),this.passiveInventory=new Pt(this),this.controlStates={...nt()},this.newControlStates={...nt()},this.oldControlStates={...nt()},this.sprite=[0,8],this.setAnimationFrames()}dashBounds(){const s=this.vel.x>0?.5:this.vel.x<0?-.5:0,e=this.vel.y>0?.5:this.vel.y<0?-.5:0,i=[this.pos.x+s,this.pos.y+e];return this.dashBox.shift(i)}setAnimationFrames(){const s=this.sprite[1];this.animationFrames={WALK_EW:[new u([1,s]),new u([2,s]),new u([3,s]),new u([3,s]),new u([2,s]),new u([1,s])],WALK_N:[new u([6,s]),new u([7,s]),new u([7,s]),new u([6,s])],WALK_S:[new u([4,s]),new u([5,s]),new u([5,s]),new u([4,s])],DASH_EW:[new u([11,s]),new u([12,s]),new u([13,s])],DASH_N:[new u([14,s]),new u([15,s]),new u([15,s]),new u([14,s])],DASH_S:[new u([12,s]),new u([13,s]),new u([13,s]),new u([12,s])],STAND:[new u([0,s])]}}cycleSprite(s){let e=s.other_players(this).map(i=>i.sprite[1]);for(;this.sprite[1]++,this.sprite[1]>=4&&(this.sprite[1]=0),!!e.includes(this.sprite[1]););this.setAnimationFrames()}die(s){if(this.dead)return;this.dead=!0,this.hp=0,this.deaths++;let e=yt(["dead1","dead2","dead3","dead4","dead5","dead6","dead7","dead8"]);this.setState(s,ot),s.playSound(e)}enterState(s,e){switch(e){case W:this.vel.x>0&&(this.vel.x=1/50),this.vel.x<0&&(this.vel.x=-1/50),this.vel.y>0&&(this.vel.y=1/50),this.vel.y<0&&(this.vel.y=-1/50);const i=this.vel.dist([0,0]);i>0&&(this.vel=this.vel.scale(1/50/i));break}this.activeState=e}exitState(s,e){}updateState(s,e){switch(this.activeState){case j:case rt:if(this.entityInteract(s),this.stunTimer.finished()&&(this.moveCheck(s,e,this.running),this.cycleInventoryCheck(s,e),this.vel.x!==0||this.vel.y!==0)){if(!this.oldControlStates.dodge&&this.controlStates.dodge){this.setState(s,X);return}else if(!this.oldControlStates.dash&&this.controlStates.dash){this.setState(s,W);return}}this.tileInteract(s,e);break;case vt:this.stunTimer.finished()&&(this.entityInteract(s),this.setState(s,rt),this.stunTimer.finished()&&(this.moveCheck(s,e,!1),this.cycleInventoryCheck(s,e)),this.tileInteract(s,e)),!this.jumpTimer.finished()&&this.vel.y<0&&!this.controlStates.dash&&(this.vel.y*=.5**(e/15));break;case W:this.entityInteract(s);for(let i of s.monsters)i.hitBounds().collide(this.dashBounds())&&(i.hitFrom(s,this.pos,1,2),i.stun());this.stateTimer.elapsed>100&&this.setState(s,j);break;case X:this.entityInteract(s),this.stunTimer.finished()&&(this.moveCheck(s,e,!0),this.cycleInventoryCheck(s,e)),!this.oldControlStates.dash&&this.controlStates.dash&&(this.vel.x!==0||this.vel.y!==0)&&this.setState(s,W),this.tileInteract(s,e),this.stateTimer.elapsed>500&&this.setState(s,j);break;case ot:this.driftCheck(s,e,!1);break}}revive(s){this.dead=!1,this.setState(s,rt),this.hp=s.competitiveMode?this.maxHp:1}hitFrom(s,e,i,h=0){if(!this.dead&&!this.escaped&&this.activeState!==X&&this.immunityTimer.finished()){for(let n of this.hookHitModifier)[i,h]=n.hitModifier(i,h);super.hitFrom(s,e,i,h),this.immunityTimer.reset(),s.playSound("hit1")}}use(s,e){this.useTimer.reset(e)}draw(s){const e=this.vel.x!==0?this.activeState===W?this.animationFrames.DASH_EW:this.animationFrames.WALK_EW:this.vel.y>0?this.activeState===W?this.animationFrames.DASH_S:this.animationFrames.WALK_S:this.vel.y<0?this.activeState===W?this.animationFrames.DASH_N:this.animationFrames.WALK_N:this.animationFrames.STAND;let i=this.getFlipped();if(this.escaped)return;let h=[0,0];this.dead?(h=[1,this.sprite[1]],this.currentFrame=0,this.lastFramePos=new u(this.pos)):this.useTimer.finished()?this.activeState===vt?(h=[4,this.sprite[1]],this.currentFrame=0,this.lastFramePos=new u(this.pos)):this.activeState===X?(h=e[0],this.currentFrame=0,this.lastFramePos=new u(this.pos)):this.vel.x===0?(h=e[this.currentFrame%e.length],this.pos.dist(this.lastFramePos)*4>=1&&(this.currentFrame+=Math.floor(this.pos.dist(this.lastFramePos)*4),this.lastFramePos=new u(this.pos)),i=this.currentFrame%e.length>=2):(this.facing!==this.lastFacing?(this.currentFrame=0,this.lastFramePos=new u(this.pos)):this.pos.dist(this.lastFramePos)*8>=1&&(this.currentFrame+=Math.floor(this.pos.dist(this.lastFramePos)*8),this.lastFramePos=new u(this.pos)),this.currentFrame=this.currentFrame%e.length,h=e[this.currentFrame]):(h=[4,this.sprite[1]],this.currentFrame=0,this.lastFramePos=new u(this.pos)),this.selectedTimer.finished()||s.sprites.entitiesItems.drawScaled(this.selectedSprite,this.pos.x+.25,this.pos.y-.25,.5),s.sprites.base.draw([h[0],h[1]],this.getDisplayX(),this.getDisplayY(),i),this.hitTimer.finished()||x.Strike.length===2&&s.sprites.base.draw(x.Strike,this.getDisplayX(),this.getDisplayY(),this.getFlipped()),this.lastFacing=this.facing}drawHUD(s,e){s.competitiveMode&&(s.drawTileText(""+Math.floor(this.score),.5*s.tileSize,e,"White"),e=e.add([1,0])),s.sprites.players.draw([this.dead?1:0,this.sprite[1]],e.x,e.y);let i=e.add([1,0]);p.Health.length===2&&s.sprites.entitiesItems.draw(p.Health,i.x,i.y),s.drawTileText(""+Math.ceil(this.hp),.5*s.tileSize,i,"White")}update(s,e){if(!this.escaped){new u(this.vel),new u(this.pos),this.immunityTimer.tick(e),this.stateTimer.tick(e),this.jumpTimer.tick(e),this.hitTimer.tick(e),this.useTimer.tick(e),this.stunTimer.tick(e),this.selectedTimer.tick(e),this.updateState(s,e),this.inventory.activeItem().update(s,e,this);for(let i of this.hookUpdate)i.update(s,e,this);this.activeState!=ot&&this.pos.y>s.tiles.dimH+3&&this.die(s),this.lastVel=new u(this.vel),s.tiles.move(this,e)}}driftCheck(s,e,i){const h=15625e-8;this.vel.x=this.vel.x>0?Math.max(this.vel.x-h*e/15,0):Math.min(this.vel.x+h*e/15,0),this.vel.y=this.vel.y>0?Math.max(this.vel.y-h*e/15,0):Math.min(this.vel.y+h*e/15,0)}moveCheck(s,e,i){this.controlStates.left?(this.vel.x=Math.max(-this.topSpeed*(i?2:1),this.vel.x-1/1600*e/15),this.facing=-1):!i&&this.vel.x<0&&(this.vel.x=0),this.controlStates.right?(this.vel.x=Math.min(this.topSpeed*(i?2:1),this.vel.x+1/1600*e/15),this.facing=1):!i&&this.vel.x>0&&(this.vel.x=0),this.controlStates.up?this.vel.y=Math.max(-this.topSpeed*(i?2:1),this.vel.y-1/1600*e/15):!i&&this.vel.y<0&&(this.vel.y=0),this.controlStates.down?this.vel.y=Math.min(this.topSpeed*(i?2:1),this.vel.y+1/1600*e/15):!i&&this.vel.y>0&&(this.vel.y=0)}cycleInventoryCheck(s,e){if(this.controlStates.cycle&&!this.oldControlStates.cycle){let i=this.inventory.next();this.selectedTimer.reset(500),this.selectedSprite=i.sprite,this.aiming=!1,this.use(s,0)}}entityInteract(s){for(let e=0;e<s.items.length;e++)this.bounds().collide(s.items[e].bounds())&&(s.items[e].entityCollide(s,this),this.aiming||(this.controlStates.up&&s.items[e].entityInteract(s,this,"up"),this.controlStates.down&&s.items[e].entityInteract(s,this,"down")))}tileInteract(s,e){if(this.controlStates.up){let i=s.tiles.closestTile(this.bounds());i instanceof b||i.entityInteract(s,this,"up")}if(this.controlStates.down){let i=s.tiles.closestTile(this.bounds());if(!(i instanceof b)){i.entityInteract(s,this,"down");let n=s.tiles.below(i.pos);!(n instanceof b)&&n.tile.y==this.bounds().bottom&&n.tile.entityInteract(s,this,"down")}let h=0;for(let n of s.tiles.contacters(this.bounds()))if(this.bounds().bottom==n.y){if(n.standable&&n.passable)h=1;else if(!n.passable&&this.bounds().bottom==n.y&&s.tiles.above(n.pos).tile.passable){h=0;break}}this.pos.y+=h*.01}}setState(s,e){this.exitState(s,this.activeState),this.enterState(s,e),this.stateTimer.reset()}}class Nt extends v{constructor(t,s=null){super(t,gt.Palm)}entityCollide(t,s){if(s.isPlayer){const[e,i,h,n]=s.bounds(),[o,d,c,m]=this.bounds(),w=Math.min(e+h-o,o+c-e),T=Math.min(i+n-d,d+m-i);w>0&&T>0&&(w<=T?s.pos[0]+=e<o?-w:w:s.pos[1]+=i<d?-T:T),s.vel[0]=0,s.vel[1]=0}}bounds(){return new f([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){t.sprites.base.drawRotatedMultitile(gt.Palm,this.pos[0]-.5,this.pos[1]-1,0,!1)}}class Vt extends v{constructor(t,s=null,e){super(t,x.CrabShot),this.vel[0]=Math.cos(e*Math.PI/180)*1/20,this.vel[1]=Math.sin(e*Math.PI/180)*1/20,this.angle=e}entityCollide(t,s){s.isPlayer&&(s.hitFrom(t,this.pos,1,1),this.dead=!0)}update(t,s){super.update(t,s),this.pos=this.pos.add(this.vel.scale(s/15)),(this.pos.x<-1||this.pos.y<-1||this.pos.x>t.tiles.dimW||this.pos.y>t.tiles.dimH)&&(this.dead=!0)}bounds(){return new f([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){this.sprite.length===2&&t.sprites.base.drawRotated(this.sprite,this.pos[0],this.pos[1],this.angle+90)}}class Kt extends v{constructor(t){super(t,p.Energy),this.pos}entityCollide(t,s){t.competitiveMode?s instanceof G&&(s.score+=1):(t.score++,t.cellsCollected++),t.playSound("pickup1"),this.dead=!0}entityInteract(t,s,e){this.dead||(t.score++,t.cellsCollected++,t.playSound("pickup1"),this.dead=!0)}}class Jt extends v{constructor(t,s=1){super(t,p.Chips),this.value=s}entityCollide(t,s){t.score++,s instanceof G&&(t.playSound("pickup2"),s.hp<s.maxHp&&s.hp++,this.dead=!0)}entityInteract(t,s,e){!this.dead&&s instanceof G&&(s.hp<s.maxHp&&s.hp++,t.score++,t.playSound("pickup2"),this.dead=!0)}}class qt extends v{constructor(t,s){super(t,[1,s.sprite[1]]),this.elapsed=0,this.timer=3e3}update(t,s){this.elapsed+=s,this.elapsed>this.timer&&(this.dead=!0)}draw(t){this.sprite.length===2&&t.sprites.players.draw(this.sprite,this.getDisplayX(),this.getDisplayY(),this.getFlipped())}}class Qt extends v{constructor(t,s){super(null,null),this.sound=t,this.delay=s,this.elapsed=0}update(t,s){this.elapsed+=s,this.elapsed>this.delay&&(t.playSound(this.sound),this.dead=!0)}draw(){}}class St extends v{constructor(t,s,e=250,i){super(null,p.Boom),this.player=s,t.vel.x=i*Math.abs(t.topSpeed*5),t.facing=i,t.drone=!0,this.monster=t,this.elapsed=0,this.timer=e,this.damage=t.hp+1}draw(t){}update(t,s){this.elapsed+=s;let e=this.player;if(this.elapsed>=this.timer||e!=null&&!e.dead&&e.oldControlStates.use&&!e.controlStates.use){if(this.elapsed<250){this.player=null;return}let i=t.tiles.closestTile(this.monster.bounds()),h=t.tiles.leftOf(i.pos),n=t.tiles.rightOf(i.pos);i instanceof E||t.items.push(new U(i)),h instanceof E||t.items.push(new U(h)),n instanceof E||t.items.push(new U(n));let o=new f([h.pos.x,h.pos.y,3,1]);for(let d of t.monsters)d.hitBounds().collide(o)&&d.hitFrom(t,this.pos,this.damage);for(let d of t.activePlayers)d.hitBounds().collide(o)&&d.hitFrom(t,this.pos,this.damage);this.dead=!0,t.playSound("boom");for(let d of t.activePlayers)d.dead||d.controller.vibrate(.5,.5,250)}}}class U extends v{constructor(t,s=250){super(t,p.Boom),this.timer=s,this.elapsed=0}update(t,s){if(this.elapsed+=s,this.elapsed>=this.timer){this.dead=!0;let e=t.tiles.get(this.pos);e instanceof dt||e instanceof ht||e instanceof Bt||e.replace(dt)}}}class Tt extends v{constructor(t,s=1,e=0,i=1,h=1,n=null){super(null,p.Shot1),this.player=t,this.pos=n==null?new u(t.pos):new u(n),this.facing=i,this.pos.x+=.2*i*(e==90?1:0)+.4*Math.cos(Math.PI*e/180),this.pos.y+=.4*Math.sin(Math.PI*e/180),this.vel.x=h*1/60*Math.cos(Math.PI*e/180),this.vel.y=h*1/60*Math.sin(Math.PI*e/180),this.angle=e-180*(i<0?1:0),s==2&&(this.sprite=p.Shot2),s>=3&&(this.sprite=p.Shot3),this.canFall=!1,this.boundingBox=new f([7/16,7/16,2/16,2/16]),this.shotDamage=s}update(t,s){let e=this.vel.x,i=this.vel.y;if(t.tiles.move(this,s),this.vel.x!=e||this.vel.y!=i)this.dead=!0;else if(this.pos.x<=-1||this.pos.x>=t.tiles.dimW)this.dead=!0;else if(this.pos.y<=-1||this.pos.y>=t.tiles.dimH)this.dead=!0;else{let h;this.player.isPlayer?h=t.monsters_with_other_players(this.player):h=t.monsters_and_players(!0,this.player);for(let n of h)if(!n.dead&&this.bounds().collide(n.hitBounds())){n.hitFrom(t,this.pos,this.shotDamage),this.dead=!0;break}}}draw(t){this.sprite.length===2&&t.sprites.entitiesItems.drawRotated(this.sprite,this.getDisplayX(),this.getDisplayY(),this.angle,this.facing<0)}}class Zt extends v{constructor(t,s,e=3,i=2,h=1,n=1/80){super(null,p.LiveGrenade),this.boundingBox=new f([.4,.4,.2,.2]),this.player=s,this.pos=s.pos.add([h*s.boundingBox.w*.75,0]);let o=t;o.passable||(h>0&&this.bounds().right>o.x&&(this.pos.x-=this.bounds().right-o.x),h<0&&this.bounds().x<o.right&&(this.pos.x+=this.bounds().x-o.right)),this.facing=h,this.vel=new u([0,n]),this.damage=e,this.radius=i,this.canFall=!0,this.damage=e,this.timer=2e3,this.elapsed=0}update(t,s){if(this.elapsed+=s,this.pos.y>t.dimW+4){this.dead=!0;return}let e=this.player;if(this.elapsed>=this.timer||e!=null&&!e.dead&&e.oldControlStates.use&&!e.controlStates.use){if(this.elapsed<250){this.player=null;return}let n=t.tiles.closestTile(this.bounds());if(n instanceof b){this.dead=!0;return}for(let o of t.tiles.iterRange(n.pos,this.radius))t.items.push(new U(o));for(let o of t.monsters_and_players()){let d=n.dist(o.pos);if(d<=this.radius){d=Math.max(.1,d),o.hitFrom(t,this.pos,this.damage*(1+(d<=.5?1:0))),o.stun(500*this.damage);let c=o.pos.x-n.x,m=o.pos.y-(n.y+1),w=1/1600+(this.radius-d)/3200;o.vel.x+=w*(c/d),o.vel.y+=w*(m/d),o.falling=!0}}this.dead=!0,t.playSound("boom");for(let o of t.activePlayers)o.dead||o.controller.vibrate(.5,.5,250)}if(this.vel.x*=.9/(s/15),this.canFall){this.falling=!0;for(let n of t.tiles.contacters(this.bounds()))if(!n.passable&&n.y==this.bounds().bottom){this.falling=!1;break}}let i=this.vel.y,h=this.vel.x;t.tiles.move(this,s),this.vel.x==0&&this.falling&&(this.vel.x=-h/(2*s/15)),Math.abs(this.vel.x)<1/3200&&(this.vel.x=0),this.vel.y==0&&i>1/3200&&(this.vel.y=-i/(3*s/15)),(this.pos.x<=-1||this.pos.x>=t.tiles.dimW)&&(this.vel.x=0)}}class $t extends v{constructor(t,s=3,e=2,i=0,h=1){super(null,p.Frag),this.player=t,this.pos=new u(t.pos),this.facing=h,this.pos.x+=1+.2*h*(i==90?1:0),this.pos.y+=-.5,this.angle=i-180*(h<0?1:0),this.boundingBox=null,this.boundingBoxes=[this.rotatedBoundingBox([-.5,1],this.angle,this.facing<0,[.5,1],[1,1]),this.rotatedBoundingBox([-.5,1],this.angle,this.facing<0,[1.5,.5],[1,1]),this.rotatedBoundingBox([-.5,1],this.angle,this.facing<0,[1.5,1.5],[1,1])],this.shotDamage=s,this.elapsed=0,this.timer=100}update(t,s){if(this.elapsed==0){let e=t.monsters_with_other_players(this.player);for(let i of e)for(let h of this.boundingBoxes)if(!i.dead&&this.bounds(this.pos,h).collide(i.hitBounds())){i.hitFrom(t,this.pos,this.shotDamage);break}}this.elapsed+=s,!(this.elapsed<this.timer)&&(this.dead=!0)}draw(t){this.sprite.length===4&&t.sprites.entitiesItems.drawRotatedMultitile(this.sprite,this.getDisplayX(),this.getDisplayY(),this.angle,this.facing<0,[-.5,1])}}class te extends v{constructor(t,s=1,e=1,i=0,h=1,n=1e3){super(null,p.LiveRocket),this.player=t,this.pos=new u(t.pos),this.pos.x+=.25*Math.cos(Math.PI*i/180),this.pos.y+=.25*Math.sin(Math.PI*i/180),this.facing=h,this.angle=i,this.vel.x=this.vel.y=0,this.x_inc=1/720*Math.cos(Math.PI*i/180),this.y_inc=1/720*Math.sin(Math.PI*i/180),this.canFall=!1,this.damage=s,this.radius=e,this.boundingBox=new f([7/16,7/16,2/16,2/16]),this.elapsed=0,this.accelTime=300}update(t,s){this.elapsed+=s,this.elapsed<=this.accelTime&&(this.vel.x+=this.x_inc*(s/15),this.vel.y+=this.y_inc*(s/15));let e=this.vel.x,i=this.vel.y;if(t.tiles.move(this,s),this.pos.x<=-4||this.pos.x>=4+t.tiles.dimW)this.dead=!0;else if(this.pos.y<=-4||this.pos.y>=4+t.tiles.dimH)this.dead=!0;else{let h=!1;this.vel.x==0&&e!=0&&(h=!0),this.vel.y==0&&i!=0&&(h=!0);let n=t.monsters_with_other_players(this.player);for(let o of n)if(o.hitBounds().collide(this.bounds())){h=!0;break}if(h){let o=t.tiles.closestTile(this.bounds());t.playSound("boomBig");for(let d of t.activePlayers)d.dead||d.controller.vibrate(1,1,350);for(let d of t.tiles.iterRange(o.pos,this.radius))t.items.push(new U(d));for(let d of t.monsters_and_players()){let c=this.pos.dist(d.pos);if(c<=this.radius){c=Math.max(.1,c),d.hitFrom(t,this.pos,this.damage*(1+(c<=.5?1:0))),d.stun(500*this.damage);let m=d.pos.x-this.pos.x,w=d.pos.y-(this.pos.y+1),T=1/1600+(this.radius-c)/3200;d.vel.x+=T*(m/c),d.vel.y+=T*(w/c),d.falling=!0}}this.dead=!0;return}}}draw(t){this.sprite.length===2&&t.sprites.entitiesItems.drawRotated(this.sprite,this.getDisplayX(),this.getDisplayY(),this.angle,this.facing<0)}}class ee extends v{constructor(t,s){super(null,p.Drone1),this.player=t,this.inventoryItem=s,this.pos=t.pos.add([t.facing*t.boundingBox.w*.75,0]),this.facing=t.facing,this.vel=new u([0,0]),this.damage=s.damage,this.radius=s.radius,this.boundingBox=new f([.4,.4,.2,.2]),this.timer=s.flightTime,this.elapsed=0,t.setState(t.states.driving)}update(t,s){this.elapsed+=s;let e=this.player;if(e.activeState!=e.states.driving){this.dead=!0;return}if(this.elapsed>this.timer||!e.controlStates.use||e.dead||e.escaped||this.pos.y<-4||this.pos.y>t.dimH+4||this.pos.x<-4||this.pos.x>t.dimW+4){this.inventoryItem.live=!1,e.setState(e.states.falling),this.dead=!0;return}e.controlStates.up&&(this.vel.y=Math.min(1/50,this.vel.y-1/3200*s/15)),e.controlStates.down&&(this.vel.y=Math.min(1/50,this.vel.y+1/3200*s/15)),e.controlStates.left&&(this.vel.x=Math.min(1/50,this.vel.x-1/3200*s/15)),e.controlStates.right&&(this.vel.x=Math.min(1/50,this.vel.x+1/3200*s/15)),!e.controlStates.left&&!e.controlStates.right&&!e.controlStates.up&&!e.controlStates.down&&(this.vel.x=this.vel.y=0);let i=this.vel.y,h=this.vel.x;t.tiles.move(this,s);let n=!1;this.vel.x==0&&h!=0&&(n=!0),this.vel.y==0&&i!=0&&(n=!0);for(let o of t.monsters)if(o.hitBounds().collide(this.bounds())){n=!0;break}if(n){let o=t.tiles.closestTile(this.bounds());for(let d of t.tiles.iterRange(o.pos,this.radius))t.items.push(new U(d));for(let d of t.monsters_with_other_players(e))o.dist(d.pos)<=this.radius&&d.hitFrom(t,this.pos,this.damage);e.controller.vibrate(.2,.2,100),this.inventoryItem.live=!1,this.inventoryItem.lastBuildTime=0,this.dead=!0,e.setState(e.states.falling);return}}}class se extends v{constructor(t,s,e=0){super(null,p.LiveVibroBlade),this.angle=e,this.facing=s,this.pos=new u([t.x+.75,t.y]),this.angle-=s<0?180:0,this.elapsed=0,this.lifeTime=100,this.boundingBox=this.rotatedBoundingBox([-.25,.5])}update(t,s){this.elapsed+=s,this.elapsed>this.lifeTime&&(this.dead=!0)}draw(t){this.sprite.length===2&&t.sprites.entitiesItems.drawRotated(this.sprite,this.getDisplayX(),this.getDisplayY(),this.angle,this.facing<0,[-.25,.5])}}class pt extends v{constructor(t,s){super(null,p.Reticle),this.player=t,this.aimable=s;let e=s.angle;this.pos=new u([t.pos.x+Math.cos(Math.PI*e/180),t.pos.y+Math.sin(Math.PI*e/180)])}update(t,s){if(!this.player.aiming){this.dead=!0;return}let e=this.player,i=this.aimable.angle;this.pos=new u([e.pos.x+Math.cos(Math.PI*i/180),e.pos.y+Math.sin(Math.PI*i/180)])}}class ie extends v{constructor(t){super(null,p.TrapBlade),this.platform=t,this.triggered=!1,t.type=="static"?this.pos=new u(this.platform.shift([0,-1])):this.pos=new u(this.platform),this.facing=1,this.boundingBox=new f([.125,.25,.75,.75]),this.elapsed=0}update(t,s){let e=this.platform;if(t.tiles.at(e.pos)!=e&&(this.dead=!0),this.elapsed+=s,e.type=="contact")if(this.pos.y==e.y&&this.vel.y==0){for(let h of t.activePlayers)if(h.bounds().collide(t.tiles.at(e).shift([0,-1]))){this.vel.y=-1/e.extendTime,this.elapsed=0;break}}else this.pos.y==e.y-1&&this.elapsed>=e.extendedTime&&(this.vel.y=1/e.extendTime,this.elapsed=0);else e.type=="cycling"&&(this.pos.y==e.y-1&&this.elapsed>=e.extendedTime&&(this.vel.y=1/e.extendTime,this.elapsed=0),this.pos.y==e.y&&this.elapsed>=e.retractedTime&&(this.vel.y=-1/e.extendTime,this.elapsed=0));for(let h of t.monsters_and_players())this.bounds().collide(h.bounds())&&(h.hitFrom(t,this.pos,e.damage,1),h.isPlayer||h.stun(500));let i=this.elapsed>e.contactDelay||e.type!=="contact"?this.vel.y:0;this.pos.y=Math.min(Math.max(this.pos.y+i*s,e.y-1),e.y),(this.pos.y==e.y-1&&this.vel.y<0||this.pos.y==e.y&&this.vel.y>0)&&(this.vel.y=0)}drawAsTile(t){this.sprite.length===2&&t.sprites.entitiesItems.draw(this.sprite,this.getDisplayX(),this.getDisplayY(),this.getFlipped())}draw(t){}}class Pt extends Array{constructor(t,s=null){if(super(),this.player=t,s!=null)for(let e of s)this.push(e)}setPositions(t){let s=t.camera.scrollable?t.camera.viewPortW:t.dimW;for(let e=0;e<this.length;e++)this[e].pos.x=s+e%4,this[e].pos.y=5+Math.floor(e/4)}get(t){for(let e=0;e<this.length;e++)if(this[e]instanceof t)return this[e];let s=new t(this);return this.add(s),s}contains(t){for(let s=0;s<this.length;s++)if(this[s]instanceof t)return!0;return!1}add(t){this.push(t),t.registerHooks(this.player)}remove(t,s){for(let e=0;e<this.length;e++)if(this[e]==s){this.splice(e,1),this.setPositions(t);return}}randomExcluding(t){let s=-1;for(let i=0;i<this.length;i++)if(this[i]==t){s=i;break}if(s<0)return null;let e=lt(this.length-1);return e<s?this[e]:this[e+1]}}class he extends Pt{next(){for(let t=0;t<this.length;t++)if(this[t].selected){let s=this[t+1<this.length?t+1:0];return this.select(s),s}}activeItem(){for(let t=0;t<this.length;t++)if(this[t].selected)return this[t];return null}select(t){for(let s of this)s.selected=!1;t.selected=!0}}class F extends v{constructor(t){super(null,t),this.selected=!1,this.count=0}drawIconsForPlayer(t,s,e){this.sprite.length===2&&t.sprites.entitiesItems.draw(this.sprite,s.x,s.y),this.selected&&p.InventorySelector.length===2&&t.sprites.entitiesItems.draw(p.InventorySelector,s.x,s.y);const i=this.value(e);i!==null&&t.drawTileText(""+Math.floor(i),.5*t.tileSize,s,"White")}value(t){return null}update(t,s,e){}registerHooks(t){}}class _t extends v{constructor(t){super(null,t),this.selected=!1,this.selectedTimer=0,this.count=0}value(t){return null}drawIconsForPlayer(t,s,e){this.sprite.length===2&&t.sprites.entitiesItems.draw(this.sprite,s.x,s.y);const i=this.value(e);i!==null&&t.drawTileText(""+Math.floor(i),.5*t.tileSize,s,"White")}registerHooks(t){}}class O extends F{constructor(){super(p.Fist),this.hitPower=1,this.hitDamage=.5,this.stunTime=2e3,this.elapsed=500,this.timer=500}value(t){return null}upgrade(t){t==1&&(this.hitPower*=1.2),t==2&&(this.hitDamage+=.5)}update(t,s,e){if(super.update(t,s,e),this.elapsed+=s,e.oldControlStates.use||!e.newControlStates.use||this.elapsed<this.timer)return;e.use(t,100);let i=t.monsters_with_other_players(e),h=(-(e.controlStates.up?1:0)+(e.controlStates.down?1:0))*.5,n=h===0?1:0,o=e.boundingBox.w*(e.facing*n+(-(e.controlStates.left?1:0)+(e.controlStates.right?1:0))*n),d=new u([o,h]),c=e.bounds().shift(d);for(let m of i)if(!m.dead&&c.collide(m.hitBounds())){m.facing=e.facing,m.falling=!0,m.stun(this.stunTime),m.hitFrom(t,e.pos,this.hitDamage,this.hitPower),e.controller.vibrate(.3,.5,75),this.elapsed=0;return}t.tiles.closestTile(c).hitFrom(t,e.pos,.5,"blunt")}}class N extends F{constructor(){super(p.Gun),this.lastShotTime=2e3,this.reloadSpeed=1e3,this.shotDamage=1,this.energyUse=1,this.loaded=!0}value(t){return t.resources.maxUse(this.energyUse,0,0)}upgrade(t){t==1&&(this.reloadSpeed/=2),t==2&&this.shotDamage++}update(t,s,e){if(super.update(t,s,e),this.lastShotTime+=s,!e.controlStates.use||this.lastShotTime<this.reloadSpeed)return;this.loaded||(t.playSound("gunReload"),this.loaded=!0);let i=e.facing<0?180:0;e.controlStates.up?e.controlStates.left&&!e.controlStates.right?i=225:e.controlStates.right&&!e.controlStates.left?i=315:i=270:e.controlStates.down&&(e.controlStates.left&&!e.controlStates.right?i=135:e.controlStates.right&&!e.controlStates.left?i=45:i=90),e.use(t,100),t.items.push(new Tt(e,this.shotDamage,i,e.facing)),this.shotDamage<=1?t.playSound("gunFire1"):this.shotDamage<=2?t.playSound("gunFire2"):t.playSound("gunFire3"),e.controller.vibrate(this.shotDamage*.25,this.shotDamage*.25,50),this.lastShotTime=0,this.loaded=!1}}class V extends F{constructor(){super(p.Grenade),this.damage=3,this.radius=1.5,this.energyUse=1,this.alloyUse=2,this.bioticUse=1}value(t){return t.resources.maxUse(this.energyUse,this.alloyUse,this.bioticUse)}upgrade(t){t==1&&(this.radius+=1),t==2&&(this.damage+=1)}update(t,s,e){if(super.update(t,s,e),this.lastShotTime+=s,!e.resources.canUse(this.energyUse,this.alloyUse,this.bioticUse)||!e.controlStates.use||e.oldControlStates.use)return;let i;e.controlStates.down?i=e.vel.add([0,0]):e.controlStates.up?i=e.vel.add([e.facing*1/250,-1/80]):i=e.vel.add([e.facing*1/80,-1/300]),t.items.push(new Zt(t,e,this.damage,this.radius,e.facing,i)),e.use(100),e.resources.use(this.energyUse,this.alloyUse,this.bioticUse),this.lastShotTime=0}}class K extends F{constructor(){super(p.Wrench);l(this,"breakTime",1e3);l(this,"chargeTime",5e3);l(this,"energyUse",2);l(this,"alloyUse",0);l(this,"bioticUse",0);l(this,"elapsed",4e3);l(this,"timer",2e3);l(this,"monsterBoom",!0);l(this,"boomTime",2e3);l(this,"charges",0)}value(s){return s.resources.maxUse(this.energyUse,this.alloyUse,this.bioticUse)}upgrade(s){s==1&&(this.chargeTime/=2),s==2&&(this.breakTime/=2)}update(s,e,i){if(super.update(s,e,i),this.elapsed+=e,i.falling||i.oldControlStates.use||!i.newControlStates.use||!i.resources.canUse(this.energyUse,this.alloyUse,this.bioticUse)||this.elapsed<this.timer)return;let h=s.tiles.closestTile(i.bounds());if(i.controlStates.up)h=s.tiles.above(h.pos);else if(i.controlStates.down)h=s.tiles.below(h.pos);else if(i.facing==-1){for(let n of s.monsters)if(this.monsterBoom&&i.bounds().shift([-i.boundingBox.w,0]).collide(n.hitBounds())){i.use(100),s.items.push(new St(n,i,this.boomTime,i.facing)),i.controller.vibrate(.25,.25,50),i.resources.use(this.energyUse,this.alloyUse,this.bioticUse),this.elapsed=-this.boomTime,this.lastShotTime=0;return}h=s.tiles.leftOf(h.pos)}else if(i.facing==1){for(let n of s.monsters)if(this.monsterBoom&&i.bounds().shift([i.boundingBox.w,0]).collide(n.hitBounds())){i.use(100),s.items.push(new St(n,i,this.boomTime,i.facing)),i.controller.vibrate(.25,.25,50),i.resources.use(this.energyUse,this.alloyUse,this.bioticUse),this.elapsed=-this.boomTime,this.lastShotTime=0;return}h=s.tiles.rightOf(h.pos)}h instanceof dt||h instanceof ht||h instanceof Bt||(i.use(100),s.items.push(new U(h,this.breakTime)),i.controller.vibrate(.25,.25,50),this.charges-=1,this.elapsed=-this.breakTime,this.lastShotTime=0)}}class J extends F{constructor(){super(p.JetPack),this.power=1/400,this.energyUse=1/1e3}value(t){return t.resources.maxUse(this.energyUse,0,0)/1e3}upgrade(t){t==1&&(this.energyUse*=.9),t==2&&(this.power*=1.2)}update(t,s,e){if(super.update(t,s,e),!!e.controlStates.use&&e.resources.use(this.energyUse*s,0,0))if(e.controller.vibrate(.15,.15,s),e.controlStates.up)e.vel.y-=1/2400*s/15,e.vel.y=Math.max(e.vel.y,-this.power);else{let i=t.tiles.closestTile(e.bounds());i.passable&&!t.tiles.below(i).passable?(e.vel.y-=1/2400*s/15,e.vel.y=Math.max(e.vel.y,-this.power)):(e.vel.y-=1/2400*s/15,e.vel.y=Math.max(e.vel.y,0))}}}class q extends F{constructor(){super(p.GrappleGun),this.grapple_vel=1/60,this.power=1/180,this.alloyUse=1,this.angle=0,this.activeLine=null,this.grappling=!1}value(t){return t.resources.maxUse(0,this.alloyUse,0)}upgrade(t){t==1&&(this.power*=1.2),t==2&&(this.grapple_vel*=1.2)}update(t,s,e){if(super.update(t,s,e),this.activeLine==null){if(e.controlStates.use&&!e.oldControlStates.use&&e.resources.canUse(0,this.alloyUse,0)){this.angle=270,e.aiming=!0;let i=new pt(e,this);t.items.push(i)}e.aiming&&(e.use(100),e.controlStates.use&&e.controlStates.up&&(this.angle=this.angle-3*(s/15)*e.facing),e.controlStates.use&&e.controlStates.down&&(this.angle=this.angle+3*(s/15)*e.facing),!e.controlStates.use&&e.oldControlStates.use&&(e.aiming=!1,this.grappling=!0))}}}class Q extends F{constructor(){super(p.RocketLauncher),this.lastShotTime=6e3,this.accelTime=1e3,this.reloadSpeed=5e3,this.rocketDamage=3,this.energyUse=2,this.alloyUse=2,this.bioticUse=1,this.blastRadius=2,this.loaded=!0}value(t){return t.resources.maxUse(this.energyUse,this.alloyUse,this.bioticUse)}upgrade(t){t==1&&(this.reloadSpeed/=2),t==2&&this.rocketDamage++}update(t,s,e){if(super.update(t,s,e),this.lastShotTime+=s,!(this.lastShotTime<this.reloadSpeed)&&e.resources.canUse(this.energyUse,this.alloyUse,this.bioticUse)){if(this.loaded||(t.playSound("rocketReload"),this.loaded=!0),e.controlStates.use&&!e.oldControlStates.use){this.angle=e.facing<0?180:0,e.aiming=!0;let i=new pt(e,this);t.items.push(i)}e.aiming&&(e.use(100),e.controlStates.use&&e.controlStates.up&&(this.angle=this.angle-3*(s/15)*e.facing),e.controlStates.use&&e.controlStates.down&&(this.angle=this.angle+3*(s/15)*e.facing),!e.controlStates.use&&e.oldControlStates.use&&(e.aiming=!1,t.items.push(new te(e,this.rocketDamage,this.blastRadius,this.angle,this.accelTime)),e.resources.use(this.energyUse,this.alloyUse,this.bioticUse),this.lastShotTime=0,this.loaded=!1,t.playSound("rocketFire"),e.controller.vibrate(.75,.75,150)))}}}class Z extends F{constructor(){super(p.AssaultRifle),this.lastShotTime=2e3,this.reloadSpeed=1e3,this.shotDamage=1,this.energyUse=1,this.loaded=!0}value(t){return t.resources.maxUse(this.energyUse,0,0)}upgrade(t){t==1&&(this.reloadSpeed/=2),t==2&&this.shotDamage++}update(t,s,e){if(super.update(t,s,e),this.lastShotTime+=s,!(this.lastShotTime<this.reloadSpeed)&&e.resources.canUse(this.energyUse,0,0)){if(this.loaded||(t.playSound("rifleReload"),this.loaded=!0),e.controlStates.use&&!e.oldControlStates.use){this.angle=e.facing<0?180:0,e.aiming=!0;let i=new pt(e,this);t.items.push(i)}e.aiming&&(e.use(100),e.controlStates.use&&e.controlStates.up&&(this.angle=this.angle-3*(s/15)*e.facing),e.controlStates.use&&e.controlStates.down&&(this.angle=this.angle+3*(s/15)*e.facing),!e.controlStates.use&&e.oldControlStates.use&&(e.aiming=!1,this.grappling=!0,t.items.push(new Tt(e,this.shotDamage,this.angle,e.facing)),e.resources.use(this.energyUse,0,0),this.lastShotTime=0,this.loaded=!1,t.playSound("rifleFire"),e.controller.vibrate(this.shotDamage*.25,this.shotDamage*.25,100)))}}}class $ extends F{constructor(){super(p.Shotgun),this.lastShotTime=2e3,this.reloadSpeed=1e3,this.shotDamage=2,this.shotRange=2,this.energyUse=1,this.alloyUse=1,this.loaded=!0}value(t){return t.resources.maxUse(this.energyUse,this.alloyUse,0)}upgrade(t){t==1&&(this.reloadSpeed*=.8),t==2&&this.shotDamage++}update(t,s,e){if(super.update(t,s,e),this.lastShotTime+=s,this.lastShotTime<this.reloadSpeed||!e.resources.canUse(this.energyUse,this.alloyUse,0)||(this.loaded||(t.playSound("shotgunReload"),this.loaded=!0),!e.controlStates.use))return;let i=e.facing<0?180:0;e.controlStates.up?e.controlStates.left&&!e.controlStates.right?i=225:e.controlStates.right&&!e.controlStates.left?i=315:i=270:e.controlStates.down&&(e.controlStates.left&&!e.controlStates.right?i=135:e.controlStates.right&&!e.controlStates.left?i=45:i=90),t.items.push(new $t(e,this.shotDamage,this.shotRange,i,e.facing)),e.resources.use(this.energyUse,this.alloyUse,0),this.lastShotTime=0,this.loaded=!1,e.use(100),t.playSound("shotgunFire"),e.controller.vibrate(this.shotDamage*.5,this.shotDamage*.5,100)}}class tt extends F{constructor(){super(p.VibroBlade),this.hitPower=.25,this.hitDamage=1,this.chargeBonus=1,this.chargeTime=1e3,this.chargeElapsed=0,this.charged=!1,this.energyUse=2,this.stunTime=500,this.elapsed=500,this.timer=500}value(t){return t.resources.maxUse(this.energyUse,0,0)}upgrade(t){t==1&&(this.chargeTime*=.9),t==2&&(this.chargeBonus+=1)}update(t,s,e){if(super.update(t,s,e),this.elapsed+=s,!(this.elapsed<this.timer)){if(e.controlStates.use&&e.resources.canUse(this.energyUse,0,0)){this.chargeElapsed+=s,e.use(100),!this.charged&&this.chargeElapsed>this.chargeTime&&(this.charged=!0),this.charged&&e.controller.vibrate(.1,.1,s);return}if(e.oldControlStates.use&&!e.controlStates.use){e.use(100);let i=e.facing<0?180:0;e.controlStates.up&&(e.controlStates.left?i=225:e.controlStates.right&&(i=315),i=270),e.controlStates.down&&(e.controlStates.left?i=135:e.controlStates.right&&(i=45),i=90);let h=new se(e.pos,e.facing,i);t.items.push(h);let n=this.hitDamage;this.chargeElapsed>this.chargeTime&&e.resources.canUse(this.energyUse,0,0)&&(n+=this.chargeBonus,e.resources.use(this.energyUse,0,0));let o=t.monsters_with_other_players(e),d=!1;for(let c of o)!c.dead&&h.bounds().collide(c.hitBounds())&&(c.facing=e.facing,c.falling=!0,c.stun(this.stunTime),c.hitFrom(t,e.pos,n,this.hitPower),e.controller.vibrate(.5,.5,100),d=!0);d||t.tiles.closestTile(h.bounds()).hitFrom(t,e.pos,n,"cut"),this.charged=!1,this.elapsed=0,this.chargeElapsed=0}}}}class et extends F{constructor(){super(p.Drone),this.lastBuildTime=11e3,this.buildTime=5e3,this.flightTime=5e3,this.live=!1,this.liveDrone=null,this.alloyUse=1,this.bioticUse=1,this.damage=1,this.radius=1,this.reloadSpeed=2e3}value(t){if(this.live)return Math.ceil((this.liveDrone.timer-this.liveDrone.elapsed)/1e3);{const s=Math.ceil(Math.max(this.buildTime-this.lastBuildTime,0)/1e3);return s>0?s:t.resources.maxUse(0,this.alloyUse,this.bioticUse)}}upgrade(t){t==1&&(this.reloadSpeed*=.8),t==2&&(this.flightTime+=1e3)}update(t,s,e){super.update(t,s,e),!this.live&&(this.lastBuildTime+=s,!(this.lastBuildTime<this.buildTime)&&e.controlStates.use&&(this.lastShotTime<this.reloadSpeed||e.resources.canUse(0,this.alloyUse,this.bioticUse)&&(e.resources.use(0,this.alloyUse,this.bioticUse),this.liveDrone=new ee(e,this),t.items.push(this.liveDrone),e.controller.vibrate(.1,.1,s),this.live=!0,this.lastShotTime=0)))}}class st extends _t{constructor(){super(p.Glider),this.glide_coef=.15,this.arrestRate=1}value(t){return null}upgrade(t){t==1&&(this.arrestRate+=1),t==2&&(this.glide_coef*=.85)}registerHooks(t){t.hookUpdate.push(this)}update(t,s,e){if(!e.controlStates.jump)return;let i=this.glide_coef*e.maxFallSpeed;e.vel.y>i&&(e.vel.y=Math.min(i,e.vel.y-1/1e3*(1+this.arrestRate)*s/15),e.controller.vibrate(.05,.1,s))}}class it extends _t{constructor(){super(p.Shield),this.elapsed=0,this.chargeTime=5e3,this.maxCharge=1,this.charge=1,this.passive=!0}value(t){return Math.floor(this.charge)}upgrade(t){t==1&&(this.maxCharge+=1),t==2&&(this.chargeTime*=.9)}registerHooks(t){t.hookHitModifier.push(this),t.hookUpdate.push(this)}hitModifier(t,s=0){let e=Math.floor(Math.min(t,this.charge));return t-=e,this.charge-=e,[t,s]}update(t,s,e){this.charge<this.maxCharge&&(this.elapsed+=s),this.elapsed>this.chargeTime&&(this.charge+=1,e.controller.vibrate(.1,0,s),this.charge=Math.max(this.charge,this.maxCharge),this.elapsed=0)}}class M{constructor(t,s){this.pos=new u(t),this.sprite=s}getDisplayX(){return this.pos.x+4/16}getDisplayY(){return this.pos.y+2/16}draw(t){t.sprites.entitiesItems.drawScaled(this.sprite,this.getDisplayX(),this.getDisplayY(),.5)}activate(t){}}class ae extends M{constructor(t){super(t,k.Health)}activate(t){t.maxHp+=1,t.hp=t.maxHp,this.dead=!0}}class ne extends M{constructor(t){super(t,k.Fist)}activate(t){let s=t.inventory.contains(O),e=t.inventory.get(O);s&&e.upgrade(y(1,2)),this.dead=!0}}class re extends M{constructor(t){super(t,k.Gun)}activate(t){let s=t.inventory.contains(N),e=t.inventory.get(N);s&&e.upgrade(y(1,2)),e.ammo=e.maxAmmo,this.dead=!0}}class oe extends M{constructor(t){super(t,k.Shotgun)}activate(t){let s=t.inventory.contains($),e=t.inventory.get($);s&&e.upgrade(y(1,2)),e.ammo=e.maxAmmo,this.dead=!0}}class le extends M{constructor(t){super(t,k.AssaultRifle)}activate(t){let s=t.inventory.contains(Z),e=t.inventory.get(Z);s&&e.upgrade(y(1,2)),e.ammo=e.maxAmmo,this.dead=!0}}class de extends M{constructor(t){super(t,k.RocketLauncher)}activate(t){let s=t.inventory.contains(Q),e=t.inventory.get(Q);s&&e.upgrade(y(1,2)),e.ammo=e.maxAmmo,this.dead=!0}}class ue extends M{constructor(t){super(t,k.Grenade)}activate(t){let s=t.inventory.contains(V),e=t.inventory.get(V);s&&e.upgrade(y(1,2)),e.count+=3,this.dead=!0}}class ce extends M{constructor(t){super(t,k.VibroBlade)}activate(t){let s=t.inventory.contains(tt),e=t.inventory.get(tt);s&&e.upgrade(y(1,2)),this.dead=!0}}class fe extends M{constructor(t){super(t,k.JetPack)}activate(t){let s=t.inventory.contains(J),e=t.inventory.get(J);s&&e.upgrade(y(1,2)),e.fuel=1e4,this.dead=!0}}class pe extends M{constructor(t){super(t,k.Wrench)}activate(t){let s=t.inventory.contains(K),e=t.inventory.get(K);s&&e.upgrade(y(1,2)),e.charges=e.maxCharges,this.dead=!0}}class me extends M{constructor(t){super(t,k.GrappleGun)}activate(t){let s=t.inventory.contains(q),e=t.inventory.get(q);s&&e.upgrade(y(1,2)),this.dead=!0}}class we extends M{constructor(t){super(t,k.Drone)}activate(t){let s=t.inventory.contains(et),e=t.inventory.get(et);s&&e.upgrade(y(1,2)),this.dead=!0}}class ge extends M{constructor(t){super(t,k.Shield)}activate(t){let s=t.passiveInventory.contains(it),e=t.passiveInventory.get(it);s&&e.upgrade(y(1,2)),e.charge=e.maxCharge,this.dead=!0}}class ve extends M{constructor(t){super(t,k.Glider)}activate(t){let s=t.passiveInventory.contains(st),e=t.passiveInventory.get(st);s&&e.upgrade(y(1,2)),this.dead=!0}}class C extends f{constructor(t,s=null,e=!0,i=!1){super([t[0],t[1],1,1]),this.sprite=s,this.passable=e,this.climbable=i,this.climbSpeed=1/300,this.hp=100}get standable(){return!this.passable||this.climbable}stoodOnBy(t,s){return!this.standable}bounds(){return new f([this.x,this.y,1,1])}dist(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}draw(t){this.sprite!=null&&t.sprites.base.draw(this.sprite,this.x,this.y)}playerInteract(t,s,e){}entityInteract(t,s,e){}initItems(t){}hitFrom(t,s,e,i){}}class b extends C{constructor(t,s=null){super(t,s,!0,!1)}}class Dt extends C{constructor(t,s=null){s==null&&(s=x.BeachLower),super(t,s,!0,!1)}}class Ft extends C{constructor(t,s=null){s==null&&(s=x.BeachUpper),super(t,s,!0,!1)}}class Se extends C{constructor(t,s=null){s==null&&(s=x.BeachLower),super(t,s,!0,!1)}draw(t){super.draw(t),t.sprites.base.draw(x.Water,this.x,this.y)}}class xe extends C{constructor(t,s=null){s==null&&(s=x.BeachLower),super(t,s,!0,!1)}draw(t){super.draw(t),t.sprites.base.draw(x.Water,this.x,this.y),t.sprites.base.draw(x.Water,this.x,this.y)}}class dt extends C{constructor(t,s=null){s==null&&(s=z.Floor),super(t,s,!0,!1)}}class E extends C{constructor(t,s=null){s==null&&(s=z.Wall),super(t,s,!1,!1)}bounds(){return new f([this.x,this.y,1,.25])}}class Bt extends C{constructor(t,s=!1){super(t,s?z.LockedExit:z.Exit,!0),this._locked=s}draw(t){if(t.competitiveMode&&t.levelTime>t.startLevelTime/2){t.sprites.tiles.draw(z.LockedExit,this.x,this.y);return}this.sprite!=null&&t.sprites.tiles.draw(this.sprite,this.x,this.y)}set locked(t){this.sprite=t?z.LockedExit:z.Exit,this._locked=t}playerInteract(t,s,e){t.competitiveMode&&t.levelTime>t.startLevelTime/2||e=="up"&&s.controlStates.up&&!s.oldControlStates.up&&(s.escaped=!0,t.playSound("exitLevel"),t.competitiveMode&&(s.score+=2))}}class ht extends C{}class ye extends ht{constructor(t){super(t,z.KioskScreen,!0,!1),this.items=[],this.activeItem=null,this.used=new Set}draw(t){super.draw(t),this.activeItem!=null&&this.activeItem.draw(t)}}class It extends ht{constructor(t,s){super(t,z.KioskDispenser,!0,!1),this.items=[],this.activeItem=-1,this.used=new Set,this.screen=s}setItems(t){this.items=t.map(s=>new s(this.screen)),this.activeItem=-1,this.screen.activeItem=this.activeItem>=0?this.items[this.activeItem]:null}playerInteract(t,s,e){if(!this.used.has(s)){if(e=="down"&&s.controlStates.down&&!s.oldControlStates.down&&(t.playSound("kioskInteract"),this.activeItem=this.activeItem<this.items.length-1?this.activeItem+1:0),this.activeItem>=0&&e=="up"&&s.controlStates.up&&!s.oldControlStates.up){if(this.items.length==0)return;this.items[this.activeItem].activate(s),this.used.add(s),this.activeItem=-1,t.playSound("kioskDispense")}this.screen.activeItem=this.activeItem>=0?this.items[this.activeItem]:null}}}class A{constructor(t,s,e){this.tilemap=t,this.tile=s,this.pos=e}move(t,s){const e=new u([this.pos[0]+t,this.pos[1]+s]),i=this.tilemap.at(e);return new A(this.tilemap,i,e)}left(){return this.move(-1,0)}right(){return this.move(1,0)}above(){return this.move(0,-1)}below(){return this.move(0,1)}replace(t,...s){return this.tilemap.set(this.pos,t,...s),this.tile=t,this}getNeighbor(t,s){return this.move(t,s)}getAdjacentNeighbors(){return ut([this.getNeighbor(0,-1),this.getNeighbor(0,1),this.getNeighbor(-1,0),this.getNeighbor(1,0)])}getAdjacentPassableNeighbors(){return this.getAdjacentNeighbors().filter(t=>t.tile.passable)}getConnectedTiles(){let t=[this],s=[this];for(;s.length;){let e=s.pop().getAdjacentPassableNeighbors().filter(i=>!t.includes(i));t=t.concat(e),s=s.concat(e)}return t}}class be{constructor(t,s){const e=new u([0,0]);this.startTile=new b(e),this.kioskTile=new b(e),this.endTile=new b(e),this.dimW=t,this.dimH=s,this.array=[];for(let i=0;i<t;i++){this.array[i]=[];for(let h=0;h<s;h++)this.array[i][h]=new C([i,h])}}isValidPos(t){return t!=null&&t[0]>=0&&t[0]<this.dimW&&t[1]>=0&&t[1]<this.dimH}at(t){return this.isValidPos(t)?this.array[t[0]][t[1]]:new b(t)}get(t){const s=new u(t),e=this.at(s);return new A(this,e,s)}set(t,s,...e){if(!this.isValidPos(t))return null;let i=new s(t,...e);return this.array[t[0]][t[1]]=i,i}fillRect(t,s){for(let e of this.iterRectPos(t))this.set(e,s)}fillCircle(t,s,e){for(let i of this.iterRange(t,s))this.set(i.pos,e)}leftOf(t){return new A(this,this.at([t[0],t[1]]),t).left()}rightOf(t){return new A(this,this.at([t[0],t[1]]),t).right()}above(t){return new A(this,this.at([t[0],t[1]]),t).above()}below(t){return new A(this,this.at([t[0],t[1]]),t).below()}*iterAllPos(){for(let t=0;t<this.dimW;t++)for(let s=0;s<this.dimH;s++)yield new u([t,s])}*iterRectPos(t){for(let s=Math.max(t.x,0);s<Math.min(t.right,this.dimW);s++)for(let e=Math.max(t.y,0);e<Math.min(t.bottom,this.dimH);e++)yield new u([s,e])}*iterAll(){for(let t=0;t<this.dimW;t++)for(let s=0;s<this.dimH;s++)yield this.at([t,s])}*iterRect(t){for(let s=t.x;s<t.right;s++)for(let e=t.y;e<t.bottom;e++){let i=this.at([s,e]);i instanceof b||(yield i)}}*iterRectBorder(t){for(let s=t.x;s<t.right;s++){let e=this.at([s,t.y]);e instanceof b||(yield e),e=this.at([s,t.bottom-1]),e instanceof b||(yield e)}for(let s=t.y;s<t.bottom;s++){let e=this.at([t.x,s]);e instanceof b||(yield e),e=this.at([t.right-1,s]),e instanceof b||(yield e)}}*iterRange(t,s){for(let e=Math.floor(t[0]-s);e<=Math.ceil(t[0]+s);e++)for(let i=Math.floor(t[1]-s);i<=Math.ceil(t[1]+s);i++)if(Math.hypot(t[0]-e,t[1]-i)<=s){let h=this.at([e,i]);h instanceof b||(yield h)}}*colliders(t){for(let s of this.iterRange([t.center_x-.5,t.center_y-.5],1.5))s.collide(t)&&(yield s)}*contacters(t){for(let s of this.iterRange([t.center_x-.5,t.center_y-.5],1.5))s.contact(t)&&(yield s)}*iterRandom(t=null,s=null,e=null,i=1){let h=t==null?this.iterAllPos():this.iterRectPos(t);for(let n of ut(Array.from(h)))(s==null||this.at(n)instanceof s)&&(e==null||!(this.numNeighbors(n,e)<=i))&&(yield n)}hasNeighbors(t,s){for(let e of this.iterRange(t,1.5))if(this.at(e.pos)instanceof s)return!0;return!1}numNeighbors(t,s,e=1.5){let i=0;for(let h of this.iterRange(t,e))this.at(h.pos)instanceof s&&(i+=1);return i}closestTile(t){return this.at([Math.round(t.center_x-.5),Math.round(t.center_y-.5)])}closestPos(t){return new u([Math.round(t.x),Math.round(t.y)])}move(t,s=15,e=null){e===null&&(e=new u(t.vel));let i=t.pos.add([0,e.y*s]),h=t.bounds(i);for(let d of this.colliders(h))d.passable||(e.y>0&&h.bottom>d.y&&(i.y-=h.bottom-d.y,e.y=0,t.vel.y=0,h=t.bounds(i)),e.y<0&&h.y<d.bottom&&(i.y+=d.bottom-h.y,e.y=0,t.vel.y=0,h=t.bounds(i)));let n=i.add([e.x*s,0]),o=t.bounds(n);for(let d of this.colliders(o))d.passable||(e.x>0&&o.right>d.x&&(n.x-=o.right-d.x,e.x=0,t.vel.x=0,o=t.bounds(n)),e.x<0&&o.x<d.right&&(n.x+=d.right-o.x,e.x=0,t.vel.x=0,o=t.bounds(n)));t.pos=new u([n.x,i.y])}}class ke extends f{constructor(){super([0,0,14,8]),this.scrollable=!0,this.focusPlayer=null}get viewPortH(){return this.h}set viewPortH(t){this.h=t}get viewPortW(){return this.w}set viewPortW(t){this.w=t}get pos(){return new u([-this.x,-this.y])}set pos(t){t!=null?(this.x=-t.x,this.y=-t.y):(this.x=null,this.y=null)}update(t,s){if(this.scrollable){let e=0,i=0,h=0;for(let d of t.activePlayers)!d.dead&&!d.escaped&&((this.focusPlayer==null||this.focusPlayer.dead||this.focusPlayer.escaped)&&(this.focusPlayer=d),d.controlStates.camera&&!d.oldControlStates.camera&&(this.focusPlayer=d),i+=d.pos.x,h+=d.pos.y,e++);this.focusPlayer===null&&(this.focusPlayer=t.activePlayers[0]),e>0&&(i/=e,h/=e),e==0&&(i=this.focusPlayer.pos.x,h=this.focusPlayer.pos.y),e>1&&(Math.abs(this.focusPlayer.pos.x-i)>this.viewPortW/2-1||Math.abs(this.focusPlayer.pos.y-h)>this.viewPortH/2-1)&&(i=this.focusPlayer.pos.x,h=this.focusPlayer.pos.y);let n=-i-.5+this.viewPortW/2,o=-h-.5+this.viewPortH/2;if(n=Math.max(Math.min(n,0),-t.dimW+this.viewPortW),o=Math.max(Math.min(o,0),-t.dimH+this.viewPortH),this.x==null||this.y==null)this.pos=new u([n,o]);else{let d=n-this.pos.x,c=o-this.pos.y,m=.2*(s/15),w=Math.max(Math.abs(d),Math.abs(c));this.pos!=null&&w>m?this.pos=new u([this.pos.x+d*m/w,this.pos.y+c*m/w]):this.pos=new u([n,o])}t.shakeX=Math.floor(-this.x*t.tileSize),t.shakeY=Math.floor(-this.y*t.tileSize)}}draw(){}}function Me(a){Te(a),a.monsters=[],Pe(a,a.tiles.startTile.pos),a.items=[],a.cells=3+Math.floor(a.level/5),a.cellsCollected=0;for(let s=0;s<a.cells;s++)a.items.push(new Kt(Ct(a.tiles)));let t=0;for(let s of a.tiles.iterRandom(new f([10,10,20,20]),Ft,void 0,5))if(a.items.push(new Nt(a.tiles.at(s))),t++,t>5)break;t=0;for(let s of a.tiles.iterRandom(new f([5,5,30,30]),Dt,void 0,5))if(a.monsters.push(new Mt(a.tiles.at(s))),t++,t>5)break;for(let s of a.tiles.iterAll())s.initItems(a)}function Te(a){let t;if(a.camera.scrollable&&a.prefDimW==null&&a.prefDimH==null)switch(t=0,t){case 0:a.dimW=30,a.dimH=30;break}const s=a.dimW,e=a.dimH;a.tiles=new be(s,e);let i=a.tiles;i.fillRect(new f([0,0,s,e]),xe),i.fillCircle([15,15],10.5,Se),i.fillCircle([15,15],8.5,Dt),i.fillCircle([16,16],3.5,Ft),i.startTile=i.at([15,15]),i.endTile=i.at([10,10]);let h=[20,20];i.above(new u(h)).replace(ye).tile;let n=i.get(h).replace(It).tile;i.kioskTile=n}function Ct(a,t=null,s=!1,e=!0){let i;return Ht("get random passable tile",function(){let h=y(0,a.dimW-1),n=y(0,a.dimH-1);return i=a.at([h,n]),t!=null?i.passable&&i.pos.dist(t)>3:!0}),i}function Pe(a,t){let s=Math.min(2*a.level,15)+5;for(let e=0;e<s;e++)zt(a,t,!1)}function zt(a,t=null,s=!1){let e=[];e=[jt,Mt];let i=yt(e),h=new i(Ct(a.tiles,t,s));a.monsters.push(h)}class mt{constructor(t,s,e){this.options=t,this.dim=new f(s),this.activeOption=0,this.callback=e,this.color="DarkSeaGreen"}draw(t){let s=Math.ceil(this.dim.h/this.options.length),e=Math.ceil(this.dim.h/this.options.length/2),i=this.dim.y,h=this.dim.x+this.dim.w/2,n=0;for(let o of this.options){let d=n==this.activeOption?">"+o+"<":o;this.drawMenuText(t,d,e,!0,h,i,this.color),n+=1,i+=s}}drawMenuText(t,s,e,i,h,n,o){t.ctx.fillStyle=o,t.ctx.font=e+"px monospace",i&&(h=h-t.ctx.measureText(s).width/2),t.ctx.fillText(s,h,n)}update(t,s){S.up&&!D.up&&(this.activeOption=this.activeOption>0?this.activeOption-1:this.options.length-1,this.callback(this,"change")),S.down&&!D.down&&(this.activeOption=this.activeOption<this.options.length-1?this.activeOption+1:0,this.callback(this,"change")),(S.use&&!D.use||S.dash&&!D.dash)&&this.callback(this,"select")}}class _e extends mt{constructor(t){let s=new f([0,t.canvas.height/2,t.canvas.width,4*t.tileSize]);super(["Play Game","High Scores","Options"],s,(e,i)=>this.handler(t,e,i))}updateWindowSize(t){this.dim=new f([0,t.canvas.height/2,t.canvas.width,4*t.tileSize])}handler(t,s,e){if(e==="select")switch(s.activeOption){case 0:S.left?(t.prefDimW=80,t.prefDimH=40,t.startLevelTime=36e4):S.right?(t.prefDimW=22,t.prefDimH=13,t.startLevelTime=12e4):(t.prefDimW=null,t.prefDimH=null,t.startLevelTime=24e4),t.competitiveMode=!1,t.updateWindowSize(),t.startGame();break;case 1:t.gameState="scores";break;case 2:t.gameState="options";break}}}class De extends mt{constructor(t){let s=new f([0,t.canvas.height/2,t.canvas.width,0]);super([],s,(e,i)=>this.handler(t,e,i))}updateWindowSize(t){this.dim=new f([0,t.canvas.height/2,t.canvas.width,this.options.length*t.tileSize])}update(t,s){this.options=["Pixel perfect scaling: "+(t.fillScreen?"OFF":"ON"),"Show framerate: "+(t.showFPS?"ON":"OFF"),"Sandbox mode: "+(t.sandboxMode?"ON":"OFF"),"Back"],this.dim=new f([0,t.canvas.height/2,t.canvas.width,this.options.length*t.tileSize]),super.update(t,s)}handler(t,s,e){if(e=="select")switch(s.activeOption){case 0:t.fillScreen=!t.fillScreen,t.updateWindowSize();break;case 1:t.showFPS=!t.showFPS;break;case 2:t.sandboxMode=!t.sandboxMode;break;case 3:t.gameState="title";break;case 4:break;case 5:t.gameState="title";break}}}class Fe extends mt{constructor(t){let s=new f([0,t.canvas.height/2,t.canvas.width,3*t.tileSize]);super(["Continue","Drop Player","Exit to Main Menu"],s,(e,i)=>this.handler(t,e,i))}updateWindowSize(t){this.dim=new f([0,t.canvas.height/2,t.canvas.width,this.options.length*t.tileSize])}handler(t,s,e){if(e=="select")switch(s.activeOption){case 0:t.gameState="running";break;case 1:for(let i of t.activePlayers)i.controlStates.dash&&!i.oldControlStates.dash&&(i.dead=!0,i.dropFromGame=!0,t.gameState="running");break;case 2:t.gameState="title";break}}}function Ut(){return localStorage.best_runs?JSON.parse(localStorage.best_runs):[]}function xt(a,t,s){let e=Ut(),i={score:t,level:a.level,won:s};e.push(i),a.sandboxMode||(localStorage.best_runs=JSON.stringify(e))}function Be(a){let t=Ut();if(t.length){a.drawText(wt(["LEVEL","SCORE","END"]),18,!0,a.canvas.height/2,"white");let s=t.pop();t.sort(function(e,i){return i.score-e.score}),t.unshift(s);for(let e=0;e<Math.min(10,t.length);e++){let i=wt([t[e].level,t[e].score,t[e].won?"ESCAPED":"DIED"]);a.drawText(i,18,!0,a.canvas.height/2+24+e*24,e==0?"DarkOrange":"DarkSeaGreen")}}}class Ie{constructor(){l(this,"timer_tick",null);l(this,"FPSframes",0);l(this,"FPStime",0);l(this,"FPS",0);l(this,"updateTimes",new _([]));l(this,"drawTimes",new _([]));l(this,"updateMean",0);l(this,"updateMax",0);l(this,"drawMean",0);l(this,"drawMax",0);l(this,"fillScreen",!1);l(this,"prefDimW",44);l(this,"prefDimH",26);l(this,"dimW",this.prefDimW);l(this,"dimH",this.prefDimH);l(this,"uiWidth",0);l(this,"uiHeight",2);l(this,"gameOffsetX",0);l(this,"gameOffsetY",0);l(this,"startLevelTime",6e4);l(this,"level",1);l(this,"maxHp",3);l(this,"activePlayers",[]);l(this,"tiles",null);l(this,"monsters",null);l(this,"items",null);l(this,"multiplayerEnabled",!0);l(this,"competitiveMode",!1);l(this,"sandboxMode",!1);l(this,"gameState","loading");l(this,"showFPS",!1);l(this,"cullOffCamera",!0);l(this,"cells",0);l(this,"cellsCollected",0);l(this,"startingHp",3);l(this,"numLevels",30);l(this,"shakeAmount",0);l(this,"shakeX",0);l(this,"shakeY",0);l(this,"numReady",0);this.initSounds(),this.keyboard=new Et(this),this.touch=new Xt(this),this.gamepadMgr=new Yt(this),this.camera=new ke,this.tileSize=this.getTileScale()*32,this.sprites={players:new R(this,"sprites/players.png"),monsters:new R(this,"sprites/monsters.png"),tiles:new R(this,"sprites/tiles.png"),entitiesItems:new R(this,"sprites/entities_and_items.png"),base:new R(this,"sprites/WaveStrong.png",32)}}start(){window.onresize=()=>t.updateWindowSize(),this.setupCanvas();let t=this;this.sprites.players.sheet.onload=()=>t.ready(),this.sprites.monsters.sheet.onload=()=>t.ready(),this.sprites.tiles.sheet.onload=()=>t.ready(),this.sprites.entitiesItems.sheet.onload=()=>t.ready(),this.mainMenu=new _e(this),this.optionsMenu=new De(this),this.inGameMenu=new Fe(this)}ready(){this.numReady++,this.numReady>=4&&(this.gameState="title",this.update())}update(){let t=performance.now();this.gamepadMgr.update_gamepad_states();for(let e of Object.keys(S))D[e],S[e];for(let e of this.activePlayers)for(let i of Object.keys(e.controlStates))e.newControlStates[i]=e.oldControlStates[i]!==e.controlStates[i];if(this.gameState=="dead"&&!D.dash&&S.dash)this.gameState="scores";else if(this.gameState=="running"||this.gameState=="dead"){this.gameState=="running"&&S.menu&&!D.menu&&(this.gameState="paused"),this.gameState=="running"&&S.dash&&!D.dash&&H.player==null&&this.addPlayer();let e=15,i=Date.now();this.timer_tick!=null&&(e=Math.min(i-this.timer_tick,30)),this.timer_tick=i;for(let o of this.activePlayers)o.update(B,e);if(this.levelTime-=e,this.levelTime<0&&this.levelTime+e>=0){let o=0;for(let d of this.tiles.iterRect(new f([1,this.tiles.dimH-1,this.tiles.dimW-2,1])))this.items.push(new U(d,1e3+o*20)),o+=1}for(let o of this.items)o.update(this,e);this.remove_dead(this.items);for(let o of this.monsters)o.update(this,e);this.remove_dead(this.monsters),this.remove_dropped(this.activePlayers);let h=!0;for(let o of this.activePlayers)if(!o.dead){h=!1;break}!this.competitiveMode&&h&&this.gameState!="dead"&&(this.keyboard.player=null,this.touch.player=null,this.gamepadMgr.release_all_players(),xt(this.score,!1),this.gameState="dead",this.items.push(new Qt("gameOver",1e3)));let n=!0;for(let o of this.activePlayers)if(!o.dead&&!o.escaped){n=!1;break}n&&this.gameState!="dead"&&(this.level==this.numLevels?(this.competitiveMode||xt(this.score,!0),this.gameState="dead",this.prefDimW=22,this.prefDimH=13,this.updateWindowSize(),this.showTitle()):(this.level++,this.startLevel())),this.spawnCounter-=e,this.spawnCounter<=0&&(this.spawnCounter=this.spawnRate,this.monsters.length<20&&zt(this,null,!0)),this.updateTimes.push(performance.now()-t),this.draw(e)}else this.gameState==="title"||this.gameState==="options"?this.showTitle():this.gameState==="scores"?(this.showTitle(),!D.dash&&S.dash&&(this.gameState="title")):this.gameState==="paused"&&(this.showTitle(),this.gameState==="paused"&&!D.menu&&S.menu&&(this.gameState="running"));Rt(S);for(let e of this.activePlayers)e.oldControlStates={...e.controlStates};let s=this;window.requestAnimationFrame(()=>s.update())}draw(t){let s=performance.now();if(this.gameState==="running"||this.gameState==="dead"){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.screenshake(),this.camera.update(B,t);let e=0,i=0,h=this.tiles.dimW,n=this.tiles.dimH;this.cullOffCamera&&(e=Math.floor(this.camera.x),i=Math.floor(this.camera.y),h=Math.ceil(this.camera.right),n=Math.ceil(this.camera.bottom));for(let g=e;g<h;g++)for(let P=i;P<n;P++)this.tiles.at([g,P]).draw(B);const o=[...this.activePlayers,...this.monsters,...this.items];if(o.sort((g,P)=>g.pos[1]-P.pos[1]),this.cullOffCamera){let g=this.camera;for(let P of o)g.shrinkBorders(-2).collide(new f([P.pos.x,P.pos.y,1,1]))&&P.draw(this)}else for(let g=0;g<this.items.length;g++)this.items[g].draw(this);this.shakeX=0,this.shakeY=0;const d=this.camera.scrollable?this.camera.viewPortW:this.dimW,c=this.camera.scrollable?this.camera.viewPortH:this.dimH;let m=!this.competitiveMode||this.levelTime>this.startLevelTime-1e4?"DarkSeaGreen":"DarkOrange";this.drawText("Lvl "+this.level+" Time "+Math.ceil(this.levelTime/1e3)+" Scr "+this.score,this.tileSize*3/8,!0,this.tileSize*3/4,m);let w=[new u([0,0]),new u([d-6,0]),new u([0,c-1]),new u([d-6,c-1])],T=0;for(let g of this.activePlayers){let P=w[T];g.drawHUD(B,P);let Y=0;for(let at of g.inventory)at.draw(B,P.add([3+Y+(this.competitiveMode?1:0),0]),g),Y++;for(let at of g.passiveInventory)at.draw(B,P.add([3+Y+(this.competitiveMode?1:0),0]),g),Y++;T++}if(this.drawTimes.push(performance.now()-s),this.showFPS){this.FPSframes+=1,this.FPStime+=t,this.FPStime>1e3&&(this.FPS=Math.round(10*1e3*this.FPSframes/this.FPStime)/10,this.FPStime=0,this.FPSframes=0,this.updateMean=Math.round(this.updateTimes.mean()*100)/100,this.updateMax=Math.round(this.updateTimes.max()*100)/100,this.updateTimes=new _([]),this.drawMean=Math.round(this.drawTimes.mean()*100)/100,this.drawMax=Math.round(this.drawTimes.max()*100)/100,this.drawTimes=new _([]));let g=this.cullOffCamera?"CULL":"";this.drawText("FPS: "+this.FPS+"  Update: "+this.updateMean+"ms (peak "+this.updateMax+")  Draw: "+this.drawMean+"ms (peak "+this.drawMax+") "+g,this.tileSize*3/8,!0,this.tileSize*(c-.25)+this.gameOffsetY,"DarkSeaGreen")}}}setupCanvas(){this.canvas=document.querySelector("canvas"),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.canvas.style.width=this.canvas.width+"px",this.canvas.style.height=this.canvas.height+"px",this.ctx=this.canvas.getContext("2d"),this.ctx.imageSmoothingEnabled=!1,this.camera.scrollable?(this.gameOffsetX=Math.floor((window.innerWidth-this.tileSize*this.camera.viewPortW)/2),this.gameOffsetY=Math.floor((window.innerHeight-this.tileSize*this.camera.viewPortH)/2)):(this.gameOffsetX=Math.floor((window.innerWidth-this.tileSize*this.dimW)/2),this.gameOffsetY=Math.floor((window.innerHeight-this.tileSize*this.dimH)/2))}getTileScale(){let t=window.innerHeight,s=window.innerWidth,e;return this.camera.scrollable?e=t/(this.camera.viewPortH+this.uiHeight)/32:e=Math.min(t/(this.prefDimH+this.uiHeight)/32,s/(this.prefDimW+this.uiWidth)/32),this.fillScreen||(e=Math.floor(e)),e}fitMaptoTileSize(t){let s=window.innerHeight,e=window.innerWidth;this.camera.scrollable?(this.camera.viewPortH=s/t,this.camera.viewPortW=e/t):(this.dimH=Math.floor(s/t),this.dimW=Math.floor(e/t),this.camera.viewPortH=this.dimH,this.camera.viewPortW=this.dimW)}updateWindowSize(){this.competitiveMode?this.camera.scrollable=!1:(this.camera.scrollable=!0,this.camera.viewPortW=14,this.camera.viewPortH=8),this.tileSize=this.getTileScale()*32,this.fitMaptoTileSize(this.tileSize),this.setupCanvas(),this.mainMenu.updateWindowSize(this),this.optionsMenu.updateWindowSize(this)}initSounds(){this.sounds={hit1:new Audio("sounds/hit1.wav"),hit2:new Audio("sounds/hit2.wav"),pickup1:new Audio("sounds/sfx_sounds_powerup5.wav"),pickup2:new Audio("sounds/sfx_sounds_powerup15.wav"),changeInv:new Audio("sounds/Slide_Sharp_01.wav"),boom:new Audio("sounds/explodemini.wav"),boomBig:new Audio("sounds/explode.wav"),dead1:new Audio("sounds/aargh0.ogg"),dead2:new Audio("sounds/aargh1.ogg"),dead3:new Audio("sounds/aargh2.ogg"),dead4:new Audio("sounds/aargh3.ogg"),dead5:new Audio("sounds/aargh4.ogg"),dead6:new Audio("sounds/aargh5.ogg"),dead7:new Audio("sounds/aargh6.ogg"),dead8:new Audio("sounds/aargh7.ogg"),exitLevel:new Audio("sounds/rock_metal_slide_1.wav"),gameOver:new Audio("sounds/evil cyber laugh.wav"),kioskInteract:new Audio("sounds/Click_Standard_02.wav"),kioskDispense:new Audio("sounds/flaunch.wav"),gunFire1:new Audio("sounds/sfx_wpn_laser7.wav"),gunFire2:new Audio("sounds/sfx_wpn_laser6.wav"),gunFire3:new Audio("sounds/sfx_wpn_laser5.wav"),gunReload:new Audio("sounds/sfx_wpn_reload.wav"),rifleFire:new Audio("sounds/Rifleprimary2.ogg"),rifleReload:new Audio("sounds/sfx_wpn_reload.wav"),shotgunFire:new Audio("sounds/minigun3.ogg"),shotgunReload:new Audio("sounds/Rack.mp3"),rocketFire:new Audio("sounds/sfx_wpn_missilelaunch.wav"),rocketReload:new Audio("sounds/Slide_Sharp_01.wav"),grappleFire:new Audio("sounds/jumppad.ogg"),grappleReload:new Audio("sounds/Slide_Sharp_01.wav"),grappleRetract:new Audio("sounds/rattle1.wav"),wrenchFire:new Audio("sounds/rattle1.wav"),wrenchReload:new Audio("sounds/Slide_Sharp_01.wav"),saberCharge:new Audio("sounds/SpaceShip_Engine_Large_Loop_00.wav")}}playSound(t,s=0,e=!1,i=!0){return this.sounds[t].currentTime=s,this.sounds[t].loop=e,i&&this.sounds[t].play(),this.sounds[t]}showTitle(){this.ctx.fillStyle="rgba(0,0,0,.75)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),B.drawText("Oarstrong",2*this.tileSize,!0,this.canvas.height/2-3.5*this.tileSize,"DarkSeaGreen"),B.drawText("by Evan Moore",this.tileSize,!0,this.canvas.height/2-2*this.tileSize,"DarkOrange"),this.gameState==="title"?(this.mainMenu.update(this,0),this.mainMenu.draw(this)):this.gameState==="options"?(this.optionsMenu.update(this,0),this.optionsMenu.draw(this)):this.gameState==="paused"?(this.inGameMenu.update(this,0),this.inGameMenu.draw(this)):this.gameState==="scores"&&Be(this)}addPlayer(){let t=new G;t.inventory.setPositions(this),t.passiveInventory.setPositions(this),t.hp=this.startingHp,t.maxHp=this.startingHp;let s;if(this.sandboxMode){s=[new K,new O,new tt,new V,new N,new $,new Z,new Q,new J,new et,new q],s[0].count=4,s[3].count=5;for(let e of[new it,new st])t.passiveInventory.add(e)}else s=[new O],this.competitiveMode&&(s[0].hitDamage=1);for(let e of s)t.inventory.add(e);t.inventory.select(t.inventory[0]),t.pos=this.tiles.startTile.pos,t.controller=H,H.attach_to_player(t),this.activePlayers.push(t)}startGame(){this.timer_tick=null,this.level=1,this.score=0,this.cellsCollected=2,this.activePlayers=[];let t=new G;this.activePlayers.push(t),this.multiplayerEnabled?H.attach_to_player(t):(this.keyboard.attach_to_player(t),this.touch.attach_to_player(t),this.gamepadMgr.attach_all_to_player(t)),t.hp=this.startingHp,t.maxHp=this.startingHp;let s;if(this.sandboxMode){s=[new K,new O,new tt,new V,new N,new $,new Z,new Q,new J,new et,new q],s[0].count=4,s[3].count=5;for(let e of[new it,new st])t.passiveInventory.add(e)}else s=[new O],this.competitiveMode&&(s[0].hitDamage=1);for(let e of s)t.inventory.add(e);t.inventory.select(t.inventory[0]),this.startLevel(),this.gameState="running"}startLevel(){this.spawnRate=1e4,this.spawnCounter=this.spawnRate,this.levelTime=this.startLevelTime,this.camera.pos=null;let t=this.competitiveMode?1:this.cellsCollected;Me(B);for(let i of this.activePlayers){i.pos=this.tiles.startTile.pos,i.escaped=!1,i.dead&&i.revive(this);let h=1+Math.floor(this.level/10);if(this.sandboxMode&&this.level>1&&!i.dead){let n=i.inventory;n[0].ammo+=2*h,n[1].charges+=h,n[2].count+=h,n[3].fuel+=1e3*h,n[0].ammo=Math.min(n[0].ammo,n[0].maxAmmo),n[1].charges=Math.min(n[1].charges,n[1].maxCharges),n[2].count=Math.min(n[2].count,n[2].maxCount),n[3].fuel=Math.min(n[3].fuel,n[3].maxFuel)}}let s=ut([ne,ce,ue,re,le,oe,de,fe,pe,me,we,ge,ve]).slice(0,t);s.push(ae);const e=this.tiles.kioskTile;e instanceof It&&e.setItems(s)}screenshake(){this.shakeAmount&&this.shakeAmount--;let t=Math.random()*Math.PI*2;this.shakeX=Math.round(Math.cos(t)*this.shakeAmount),this.shakeY=Math.round(Math.sin(t)*this.shakeAmount)}drawText(t,s,e,i,h){this.ctx.fillStyle=h,this.ctx.font=s+"px monospace";let n;e?n=(this.canvas.width-this.ctx.measureText(t).width)/2:n=this.canvas.width-this.uiWidth*(this.tileSize-1),this.ctx.fillText(t,n,i)}drawTileText(t,s,e,i){this.ctx.fillStyle=i,this.ctx.font=s+"px monospace";let h=(e.y+1-(1-s/this.tileSize)/2)*this.tileSize+this.gameOffsetY+this.shakeY,n=(e.x+(1-this.ctx.measureText(t).width/this.tileSize)/2)*this.tileSize+this.gameOffsetX+this.shakeX;this.ctx.fillText(t,n,h)}nearestPlayer(t){let s=1e9,e=null;for(let i of this.activePlayers)if(!i.dead){let h=i.pos.dist(t);e=h<s?i:e,s=h<s?h:s}return[e,s]}monsters_and_players(t=!0,s=null){return!t&&(!this.competitiveMode||this.levelTime>this.startLevelTime-1e4)?this.monsters.filter(e=>e!==s):this.monsters.concat(this.activePlayers).filter(e=>e!==s)}monsters_with_other_players(t){if(!this.competitiveMode||this.levelTime>this.startLevelTime-1e4)return this.monsters;let s=this.activePlayers.indexOf(t),e=this.activePlayers.slice(0,s).concat(this.activePlayers.slice(s+1));return this.monsters.concat(e)}other_players(t){let s=this.activePlayers.indexOf(t);return this.activePlayers.slice(0,s).concat(this.activePlayers.slice(s+1))}remove(t,s){for(let e=0;e<t.length;e++)if(t[e]==s){t.splice(e,1);return}}remove_dead(t){for(let s=t.length-1;s>=0;s--)t[s].dead&&t.splice(s,1)}remove_dropped(t){for(let s=t.length-1;s>=0;s--)t[s].dropFromGame&&(t[s].controller.attach_to_player(),this.items.push(new qt(t[s])),t.splice(s,1))}addGunPlatform(t){}addChips(t,s){const e=new Jt(t,s);return this.items.push(e),e}addBoom(t,s){const e=new U(t,s);return this.items.push(e),e}addTrapBlade(t){const s=new ie(t);return this.items.push(s),s}}var B=new Ie;B.start();
