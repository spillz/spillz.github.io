var __defProp=Object.defineProperty;var __defNormalProp=(obj,key,value)=>key in obj?__defProp(obj,key,{enumerable:!0,configurable:!0,writable:!0,value}):obj[key]=value;var __publicField=(obj,key,value)=>__defNormalProp(obj,typeof key!="symbol"?key+"":key,value);(function(){const relList=document.createElement("link").relList;if(relList&&relList.supports&&relList.supports("modulepreload"))return;for(const link of document.querySelectorAll('link[rel="modulepreload"]'))processPreload(link);new MutationObserver(mutations=>{for(const mutation of mutations)if(mutation.type==="childList")for(const node of mutation.addedNodes)node.tagName==="LINK"&&node.rel==="modulepreload"&&processPreload(node)}).observe(document,{childList:!0,subtree:!0});function getFetchOpts(link){const fetchOpts={};return link.integrity&&(fetchOpts.integrity=link.integrity),link.referrerPolicy&&(fetchOpts.referrerPolicy=link.referrerPolicy),link.crossOrigin==="use-credentials"?fetchOpts.credentials="include":link.crossOrigin==="anonymous"?fetchOpts.credentials="omit":fetchOpts.credentials="same-origin",fetchOpts}function processPreload(link){if(link.ep)return;link.ep=!0;const fetchOpts=getFetchOpts(link);fetch(link.href,fetchOpts)}})();function splitmix64(seed){let state=BigInt(seed)&0xFFFFFFFFFFFFFFFFn;return function(){state=state+0x9E3779B97F4A7C15n&0xFFFFFFFFFFFFFFFFn;let z=state;return z=(z^z>>30n)*0xBF58476D1CE4E5B9n&0xFFFFFFFFFFFFFFFFn,z=(z^z>>27n)*0x94D049BB133111EBn&0xFFFFFFFFFFFFFFFFn,z=z^z>>31n,z}}class PRNG{constructor(){__publicField(this,"_seed",0)}random(){return Math.random()}seed(seed){throw new Error("Seeding is not available in the default PRNG class. You can set another with `eskv.rand.setPRNG`.")}getRandomInt(m1,m2=0){return m2!=0?m1+Math.floor(this.random()*(m2-m1)):Math.floor(this.random()*m1)}getRandomPos(maxX,maxY){return[this.getRandomInt(maxX),this.getRandomInt(maxY)]}randomRange(min=0,max=1){return Math.floor(this.random()*(max-min+1))+min}randomFloat(min=0,max=1){return this.random()*(max-min)+min}shuffle(arr){let temp,r;for(let i=1;i<arr.length;i++)r=this.randomRange(0,i),temp=arr[i],arr[i]=arr[r],arr[r]=temp;return arr}choose(array){return array[Math.floor(this.random()*array.length)]}chooseN(arr,n){let result=new Array(n),len=arr.length,taken=new Array(len);if(n>len)throw new RangeError("chooeN: more elements requested than available");for(;n--;){let x=Math.floor(this.random()*len);result[n]=arr[x in taken?taken[x]:x],taken[x]=--len in taken?taken[len]:len}return result}}function sfc32(a2,b,c,d){return function(){a2>>>=0,b>>>=0,c>>>=0,d>>>=0;var t=a2+b|0;return a2=b^b>>>9,b=c+(c<<3)|0,c=c<<21|c>>>11,d=d+1|0,t=t+d|0,c=c+t|0,(t>>>0)/4294967296}}class PRNG_sfc32 extends PRNG{constructor(){super(...arguments);__publicField(this,"_seed",1);__publicField(this,"d",3735928559);__publicField(this,"xorSeed",Math.floor(Date.now())^this.d);__publicField(this,"random",sfc32(2654435769,608135816,3084996962,this.xorSeed))}seed(seed){this._seed=seed,this.xorSeed=seed^this.d;const sm=splitmix64(this.xorSeed);this.random=sfc32(sm(),sm(),sm(),sm())}}var defaultPRNG=new PRNG_sfc32;function getRandomPos(max1,max2){return defaultPRNG.getRandomPos(max1,max2)}function randomFloat(min=0,max=1){return defaultPRNG.randomFloat(min,max)}class Vec2 extends Array{constructor(vec=[0,0]){super(),this[0]=vec[0],this[1]=vec[1]}equals(vec){return this.length===vec.length&&this[0]===vec[0]&&this[1]===vec[1]}static random(vec){return new Vec2(getRandomPos(vec[0],vec[1]))}add(vec){return new Vec2([this[0]+vec[0],this[1]+vec[1]])}sub(vec){return new Vec2([this[0]-vec[0],this[1]-vec[1]])}floor(){return new Vec2([Math.floor(this[0]),Math.floor(this[1])])}ceil(){return new Vec2([Math.floor(this[0]),Math.floor(this[1])])}scale(scalar){return new Vec2([this[0]*scalar,this[1]*scalar])}mul(vec){return new Vec2([this[0]*vec[0],this[1]*vec[1]])}div(vec){return new Vec2([this[0]/vec[0],this[1]/vec[1]])}dot(vec){return this[0]*vec[0]+this[1]*vec[1]}dist(vec){return Math.hypot(this[0]-vec[0],this[1]-vec[1])}abs(){return new Vec2([Math.abs(this[0]),Math.abs(this[1])])}sum(){return this[0]+this[1]}relativeTo(rect){return this.sub(rect.pos).div(rect.size)}absoluteFrom(rect){return this.mul(rect.size).add(rect.pos)}relativeToPS(pos,sz){return this.sub(pos).scale(1/sz)}absoluteFromPS(pos,sz){return this.scale(sz).add(pos)}set x(val){this[0]=val}set y(val){this[1]=val}get x(){return this[0]}get y(){return this[1]}}class Rect extends Array{constructor(rect=null){if(super(),rect===null){this[0]=0,this[1]=0,this[2]=0,this[3]=0;return}this[0]=rect[0],this[1]=rect[1],this[2]=rect[2],this[3]=rect[3]}set x(val){this[0]=val}set y(val){this[1]=val}set w(val){this[2]=val}set h(val){this[3]=val}set pos(vec){this[0]=vec[0],this[1]=vec[1]}set size(vec){this[2]=vec[0],this[3]=vec[1]}get size(){return new Vec2([this[2],this[3]])}get pos(){return new Vec2([this[0],this[1]])}get x(){return this[0]}get y(){return this[1]}get w(){return this[2]}get h(){return this[3]}get right(){return this[0]+this[2]}get bottom(){return this[1]+this[3]}get center_x(){return this[0]+this[2]/2}get center_y(){return this[1]+this[3]/2}get center(){return new Vec2([this.center_x,this.center_y])}grow(amount){return new Rect([this[0]-amount,this[1]-amount,this[2]+2*amount,this[3]+2*amount])}get flooredCenter(){return new Vec2([Math.floor(this[0]+this[2]/2),Math.floor(this[1]+this[3]/2)])}translate(pos){return new Rect([this.x+pos[0],this.y+pos[1],this.w,this.h])}shrinkBorders(value){return new Rect([this.x+value,this.y+value,this.w-value*2,this.h-value*2])}scaleBorders(scale){return new Rect([this.x+this.w*(1-scale)/2,this.y+this.h*(1-scale)/2,this.w*scale,this.h*scale])}mult(scalar){return new Rect([this[0]*scalar,this[1]*scalar,this[2]*scalar,this[3]*scalar])}multXY(vec){return new Rect([this[0]*vec[0],this[1]*vec[1],this[2]*vec[0],this[3]*vec[1]])}scale(scalar,centered=!0){if(centered){let news=[this[2]*scalar,this[3]*scalar];return new Rect([this[0]+.5*(this[2]-news[0]),this[1]+.5*(this[3]-news[1]),news[0],news[1]])}else{let news=[this[2]*scalar,this[3]*scalar];return new Rect([this[0],this[1],news[0],news[1]])}}collideRadius(rect,radius=null){let d=[this.center_x-rect.center_x,this.center_y-rect.center_y];return radius===null&&(radius=Math.min(this.w,this.h,rect.w,rect.h)/2),d[0]*d[0]+d[1]*d[1]<radius*radius}collide(rect){return this.x<rect.x+rect.w&&this.x+this.w>rect.x&&this.y<rect.y+rect.h&&this.h+this.y>rect.y}contains(rect){return this.x<=rect.x&&this.y<=rect.y&&this.x+this.w>=rect.x+rect.w&&this.y+this.h>=rect.y+rect.h}contact(rect){return this.x<=rect.x+rect.w&&this.x+this.w>=rect.x&&this.y<=rect.y+rect.h&&this.h+this.y>=rect.y}contactRadius(rect,radius=null){let d=[this.center_x-rect.center_x,this.center_y-rect.center_y];return radius===null&&(radius=Math.min(this.w,this.h,rect.w,rect.h)),d[0]*d[0]+d[1]*d[1]<=radius*radius}}class Grid2D extends Array{constructor(tileDim=[0,0],initialData=void 0){initialData===void 0?super(tileDim[0]*tileDim[1]):super(...initialData),this.tileDim=new Vec2(tileDim),this.hidden=!1,this._cacheData=null}clone(){return new Grid2D(this.tileDim,this)}get(pos){return this[pos[0]+pos[1]*this.tileDim[0]]}set(pos,val){this[pos[0]+pos[1]*this.tileDim[0]]=val}*iterBetween(pos1,pos2,tol=0){var x1,y1,x2,y2;if([x1,y1]=pos1,[x2,y2]=pos2,!(Math.abs(y2-y1)==0&&Math.abs(x2-x1)==0))if(Math.abs(y2-y1)>Math.abs(x2-x1)){var slope=(x2-x1)/(y2-y1);if(y1>y2)for(var y=y1;y>=y2;y--){var xa=x1+(y-y1)*slope;yield[xa,y]}else for(var y=y1;y<=y2;y++){var xa=x1+(y-y1)*slope;yield[xa,y]}}else{var slope=(y2-y1)/(x2-x1);if(x1>x2)for(var x=x1;x>=x2;x--){var ya=y1+(x-x1)*slope;yield[x,ya]}else for(var x=x1;x<=x2;x++){var ya=y1+(x-x1)*slope;yield[x,ya]}}}*iterInBetween(pos1,pos2){var x1,y1,x2,y2;if([x1,y1]=pos1,[x2,y2]=pos2,!(Math.abs(y2-y1)==0&&Math.abs(x2-x1)==0))if(Math.abs(y2-y1)>Math.abs(x2-x1)){var slope=(x2-x1)/(y2-y1);if(y1>y2)for(var y=y1-1;y>y2;y--){var x=Math.round(x1+(y-y1)*slope);yield[x,y]}else for(var y=y1+1;y<y2;y++){var x=Math.round(x1+(y-y1)*slope);yield[x,y]}}else{var slope=(y2-y1)/(x2-x1);if(x1>x2)for(var x=x1-1;x>x2;x--){var y=Math.round(y1+(x-x1)*slope);yield[x,y]}else for(var x=x1+1;x<x2;x++){var y=Math.round(y1+(x-x1)*slope);yield[x,y]}}}*iterTypesBetween(pos1,pos2,types){for(var pos of this.iterBetween(pos1,pos2))types.includes(this.get(pos))&&(yield pos)}*iterTypesInBetween(pos1,pos2,types){for(var pos of this.iterInBetween(pos1,pos2))types.includes(this.get(pos))&&(yield pos)}hasTypesBetween(pos1,pos2,types){for(var pos of this.iterTypesBetween(pos1,pos2,types))return!0;return!1}hasTypesInBetween(pos1,pos2,types){for(var pos of this.iterTypesInBetween(pos1,pos2,types))return!0;return!1}*iterAll(sub_rect=null){const[tw,th]=this.tileDim;if(sub_rect!==null)for(var y=sub_rect[1];y<Math.min(th,sub_rect[1]+sub_rect[3]);y++)for(var x=sub_rect[0];x<Math.min(tw,sub_rect[0]+sub_rect[2]);x++)yield[x,y];else for(var y=0;y<th;y++)for(var x=0;x<tw;x++)yield[x,y]}*iterTypes(types,sub_rect){for(var pos of this.iterAll(sub_rect))types.includes(this.get(pos))&&(yield pos)}*iterAdjacent(pos,diagonal=!1){pos=new Vec2(pos);const dirs=diagonal?[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]]:[[0,-1],[1,0],[0,1],[-1,0]];for(let dir of dirs){const npos=pos.add(dir);npos[0]>=0&&npos[0]<this.tileDim[0]&&npos[1]>=0&&npos[1]<this.tileDim[1]&&(yield npos)}}hasAdjacent(pos,types,diagonal=!1){for(let npos of this.iterAdjacent(pos,diagonal))if(types.includes(this.get(npos)))return!0;return!1}*iterInRange(pos,radius){var x,y;[x,y]=pos;const[tw,th]=this.tileDim;radius==null&&(radius=3);for(var rad=Math.ceil(radius),yoff=-rad;yoff<rad+1;yoff++)for(var xoff=-rad;xoff<rad+1;xoff++)if(xoff*xoff+yoff*yoff<=radius*radius){var x0=x+xoff,y0=y+yoff;0<=y0&&y0<th&&0<=x0&&x0<tw&&(yield[x0,y0])}}*iterTypesInRange(pos,types,radius,blocker_types=null){for(var pos0 of this.iterInRange(pos,radius))blocker_types!==null&&this.hasTypesBetween(pos,pos0,blocker_types)||types.includes(this.get(pos0))&&(yield pos0)}numInRange(pos,types,radius,blocker_types=null){var num=0;for(var pos0 of this.iterTypesInRange(pos,types,radius,blocker_types))num++;return num}*iterRectBoundary(rect){const[tw,th]=this.tileDim;let xl=Math.min(Math.max(rect.x,0),tw),xu=Math.min(Math.max(rect.x+rect.w,0),tw),yl=Math.min(Math.max(rect.y,0),th),yu=Math.min(Math.max(rect.y+rect.h,0),th);for(let x0=xl;x0<xu;x0++)yield[x0,yl];for(let x0=xl;x0<xu;x0++)yield[x0,yu];for(let y0=yl;y0<yu;y0++)yield[xl,y0];for(let y0=yl;y0<yu;y0++)yield[xu,y0]}*iterRect(rect,mustFit=!0){const[tw,th]=this.tileDim;if(rect instanceof Rect||(rect=new Rect(rect)),mustFit&&(rect.x<0||rect.y<0||rect.right>tw||rect.bottom>th))return;let xl=Math.max(rect.x,0),xu=Math.min(rect.x+rect.w,tw),yl=Math.max(rect.y,0),yu=Math.min(rect.y+rect.h,th);for(let y0=yl;y0<yu;y0++)for(let x0=xl;x0<xu;x0++)yield[x0,y0]}numInRect(rect,targets,mustFit=!0){let num=0;for(var pos of this.iterRect(rect,mustFit))targets.includes(this.get(pos))&&num++;return num}}const minFontSize$1=8,scaleFactor$1=48*(1/window.devicePixelRatio||1);function sizeText(ctx,text,size,fontName,centered,rect,color){let scale=1;size<minFontSize$1&&(scale=1/scaleFactor$1,ctx.save(),ctx.scale(scale,scale)),ctx.fillStyle=color,ctx.font=(size>=minFontSize$1?size:Math.ceil(size/scale))+"px "+fontName,rect.x;let w=scale*ctx.measureText(text).width;return size<minFontSize$1&&ctx.restore(),[w,2*size]}function getTextData(ctx,text,size,fontName,halign,valign,rect,color){let scale=1;size<minFontSize$1&&(scale=1/scaleFactor$1,ctx.save(),ctx.scale(scale,scale)),ctx.fillStyle=color,ctx.font=(size>=minFontSize$1?size:Math.ceil(size/scale))+"px "+fontName;let textX=rect.x,metrics=ctx.measureText(text),textY=rect.y;switch(halign){case"left":break;case"center":textX+=(rect.w-scale*metrics.width)/2;break;case"right":textX+=rect.w-scale*metrics.width;break}switch(valign){case"top":break;case"middle":textY+=rect.h/2;break;case"bottom":textY+=rect.h;break}let textData={outText:[[text,textX/scale,textY/scale]],color,fontName,size,valign};return size<minFontSize$1&&ctx.restore(),textData}function drawText(ctx,textData,color=null){let scale=1,size=textData.size;switch(color==null&&(color=textData.color),size<minFontSize$1&&(scale=1/scaleFactor$1,ctx.save(),ctx.scale(scale,scale)),textData.valign){case"top":ctx.textBaseline="top";break;case"middle":ctx.textBaseline="middle";break;case"bottom":ctx.textBaseline="bottom";break}ctx.fillStyle=color,ctx.font=(size>=minFontSize$1?size:Math.ceil(size/scale))+"px "+textData.fontName;let[t,x,y]=textData.outText[0];ctx.fillText(t,x,y),size<minFontSize$1&&ctx.restore()}function sizeWrappedText(ctx,text,size,fontName,centered,rect,color,wordwrap=!0){let scale=1;size<minFontSize$1&&(scale=1/scaleFactor$1,ctx.save(),ctx.scale(scale,scale)),ctx.font=(size>=minFontSize$1?size:Math.ceil(size/scale))+"px "+fontName;let h=0,paraText="",guess=Math.min(Math.max(1,Math.ceil(text.length*rect.w/ctx.measureText(text).width/scale)),text.length);for(;text!=""||paraText!="";){if(paraText==""){let n=text.indexOf(`
`);n>=0?(paraText=text.slice(0,n),text=text.slice(n+1)):(paraText=text,text="")}let nextLine=paraText.slice(0,guess),w=scale*ctx.measureText(nextLine).width;if(w>rect.w&&guess>1)for(;w>rect.w&&guess>1;)guess--,nextLine=paraText.slice(0,guess),w=scale*ctx.measureText(nextLine).width;if(w<rect.w&&guess<paraText.length){for(;w<rect.w&&guess<paraText.length;)guess++,nextLine=paraText.slice(0,guess),w=scale*ctx.measureText(nextLine).width;w>rect.w&&guess--}if(wordwrap&&nextLine[-1]!=""&&paraText[guess]!=" "&&paraText[guess]!="	"){let lastIndex=Math.max(nextLine.lastIndexOf(" "),nextLine.lastIndexOf("	"));lastIndex>=0&&(guess-=nextLine.length-lastIndex-1)}guess=Math.max(1,guess),nextLine=paraText.slice(0,guess),paraText=paraText.slice(guess),wordwrap&&(paraText=paraText.trimStart()),h+=size}return h+=size,size<minFontSize$1&&ctx.restore(),[rect.w,h]}function getWrappedTextData(ctx,text,size,fontName,halign,valign,rect,color,wordwrap=!0){let scale=1;size<minFontSize$1&&(scale=1/scaleFactor$1,ctx.save(),ctx.scale(scale,scale)),ctx.fillStyle=color,ctx.font=(size>=minFontSize$1?size:Math.ceil(size/scale))+"px "+fontName;let y=rect.y,outText=[],paraText="",guess=Math.min(Math.max(1,Math.ceil(text.length*(rect.w/ctx.measureText(text).width)/scale)),text.length);for(;text!=""||paraText!="";){if(paraText==""){let n=text.indexOf(`
`);n>=0?(paraText=text.slice(0,n),text=text.slice(n+1)):(paraText=text,text="")}let x=rect.x,nextLine=paraText.slice(0,guess),w=scale*ctx.measureText(nextLine).width;if(w>rect.w&&guess>1)for(;w>rect.w&&guess>1;)guess--,nextLine=paraText.slice(0,guess),w=scale*ctx.measureText(nextLine).width;if(w<rect.w&&guess<paraText.length){for(;w<rect.w&&guess<paraText.length;)guess++,nextLine=paraText.slice(0,guess),w=scale*ctx.measureText(nextLine).width;w>rect.w&&guess--}if(wordwrap&&guess<paraText.length&&nextLine[-1]!=""&&paraText[guess]!=" "&&paraText[guess]!="	"){let lastIndex=Math.max(nextLine.lastIndexOf(" "),nextLine.lastIndexOf("	"));lastIndex>=0&&(guess-=nextLine.length-lastIndex-1)}switch(guess=Math.max(1,guess),nextLine=paraText.slice(0,guess),paraText=paraText.slice(guess),wordwrap&&(paraText=paraText.trimStart()),w=scale*ctx.measureText(nextLine).width,halign){case"left":break;case"center":x+=(rect.w-w)/2;break;case"right":x+=rect.w-w;break}outText.push([nextLine,x/scale,y/scale]),y+=size}let h=y-rect.y,off=0;switch(valign){case"top":off=0;break;case"middle":off=(rect.h-h)/2+size/2;break;case"bottom":off=rect.h-h+size}let textData={size,fontName,outText,off:off/scale,color,valign};return size<minFontSize$1&&ctx.restore(),textData}function drawWrappedText(ctx,textData,color=null){let scale=1,size=textData.size;switch(color===null&&(color=textData.color),size<minFontSize$1&&(scale=1/scaleFactor$1,ctx.save(),ctx.scale(scale,scale)),textData.valign){case"top":ctx.textBaseline="top";break;case"middle":ctx.textBaseline="middle";break;case"bottom":ctx.textBaseline="bottom";break}ctx.fillStyle=color,ctx.font=(size>=minFontSize$1?size:Math.ceil(size/scale))+"px "+textData.fontName;for(let tdat of textData.outText)ctx.fillText(tdat[0],tdat[1],tdat[2]+(textData.off??0));size<minFontSize$1&&ctx.restore()}const clamp=(num,min,max)=>Math.min(Math.max(num,min),max);function dist(pos1,pos2){return new Vec2(pos1).dist(pos2)}function colorString(vec){let r,g,b;return[r,g,b]=new MathArray(vec).scale(255).map(x=>Math.floor(x)),"#"+r.toString(16).padStart(2,"0")+g.toString(16).padStart(2,"0")+b.toString(16).padStart(2,"0")}class MathArray extends Array{constructor(...arr){arr.length==1&&arr[0]instanceof Array?super(...arr[0]):super(...arr)}static asRandomFloats(size,low=0,high=1){let a2=new MathArray(size);for(let i=0;i<a2.length;i++)a2[i]=randomFloat(low,high);return a2}sum(){let s=0;return this.forEach(el=>s+=el),s}mean(){return this.sum()/this.length}max(){return Math.max.apply(null,this)}min(){return Math.min.apply(null,this)}vars(){let s=0;return this.forEach(el=>s+=el*el),(s-this.length*this.mean()^2)/(this.length-1)}var(){let s=0;return this.forEach(el=>s+=el*el),s/this.length-this.mean()^2}std(){return Math.sqrt(this.var())}add(arr2){let a2=new MathArray(this);if(arr2 instanceof Array)for(let i=0;i<this.length;i++)a2[i]+=arr2[i];else for(let i=0;i<this.length;i++)a2[i]+=arr2;return a2}mul(arr2){let a2=new MathArray(this);if(arr2 instanceof Array)for(let i=0;i<this.length;i++)a2[i]*=arr2[i];else for(let i=0;i<this.length;i++)a2[i]*=arr2;return a2}scale(scalar){const arr=Array();for(let val of this)arr.push(val*scalar);return arr}dot(arr2){return this.mul(arr2).sum()}abs(){return Math.abs.apply(null,this)}lag(k){let a2=new MathArray;for(let i=-k;i<this.length-k;i++)i<0||i>=this.length?a2.push(NaN):a2.push(this[i]);return a2}filter(func){return new MathArray(super.filter(func))}dropNaN(){return this.filter(el=>!Number.isNaN(el))}}class Touch{constructor(props={}){__publicField(this,"identifier",-1);__publicField(this,"pos",[0,0]);__publicField(this,"state","touch_up");__publicField(this,"device","touch");__publicField(this,"nativeObject",null);__publicField(this,"nativeEvent",null);for(let p in props)this[p]=props[p]}copy(){return new Touch({pos:[...this.pos],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}asChildTouch(widget){return new Touch({pos:[...widget.toChild(this.pos)],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}get rect(){return new Rect([...this.pos,0,0])}set x(value){this.pos[0]=value}set y(value){this.pos[1]=value}get x(){return this.pos[0]}get y(){return this.pos[1]}get grabbed(){return App.get().inputHandler.grabbed}grab(widget){App.get().inputHandler.grab(widget)}ungrab(){App.get().inputHandler.ungrab()}}class InputHandler{constructor(app){__publicField(this,"grabbed",null);__publicField(this,"mouseTouchEmulation",!0);__publicField(this,"mouseev",null);__publicField(this,"keyStates",{});this.app=app,this.canvas=app.canvas;let canvas=this.canvas,that=this;document.addEventListener("keydown",function(ev){that.process_key(ev,"key_down")},!0),document.addEventListener("keyup",function(ev){that.process_key(ev,"key_up")},!0),canvas.addEventListener("mousedown",function(ev){that.process_mouse(ev,"mouse_down")},!0),canvas.addEventListener("mousemove",function(ev){that.process_mouse(ev,"mouse_move")},!0),canvas.addEventListener("mouseout",function(ev){that.process_mouse(ev,"mouse_cancel")},!0),canvas.addEventListener("mouseup",function(ev){that.process_mouse(ev,"mouse_up")},!0),canvas.addEventListener("touchstart",function(ev){that.process_touch(ev,"touch_down")},!1),canvas.addEventListener("touchmove",function(ev){that.process_touch(ev,"touch_move")},!1),canvas.addEventListener("touchcancel",function(ev){that.process_touch(ev,"touch_cancel")},!1),canvas.addEventListener("touchend",function(ev){that.process_touch(ev,"touch_up")},!1),canvas.addEventListener("wheel",function(ev){that.process_wheel(ev,"wheel")},!0),window.history.replaceState(null,document.title,location.pathname+"#!/backbutton"),window.history.pushState(null,document.title,location.pathname),window.addEventListener("popstate",function(ev){that.process_back(ev,"back_button")},!1)}grab(widget){this.grabbed=widget}ungrab(){this.grabbed=null}isKeyUp(key){return key in this.keyStates&&this.keyStates[key]}isKeyDown(key){return key in this.keyStates&&this.keyStates[key]}process_key(ev,name){this.app.requestFrameUpdate();const oldKeyState=this.keyStates[ev.key];name==="key_up"?this.keyStates[ev.key]=!1:name==="key_down"&&(this.keyStates[ev.key]=!0),this.app.emit(name,{states:this.keyStates,oldState:oldKeyState,event:ev})}process_touch(ev,name){if(this.app.requestFrameUpdate(),this.grabbed!==null)for(let to of ev.changedTouches){let pos=this.grabbed.appToChild([to.clientX,to.clientY]),t=new Touch({pos,state:name,nativeObject:to,nativeEvent:ev,identifier:to.identifier});this.grabbed.emit(name,t)}else for(let to of ev.changedTouches){let t=new Touch({pos:this.app.toChild([to.clientX,to.clientY]),state:name,nativeObject:to,nativeEvent:ev,identifier:to.identifier});this.app.childEmit(name,t,!0)}ev.preventDefault()}process_back(ev,name){location.hash==="#!/backbutton"&&(history.replaceState(null,document.title,location.pathname),this.app.childEmit("back_button",ev))}process_mouse(ev,name){if(this.app.requestFrameUpdate(),this.mouseev=ev,ev.preventDefault(),this.mouseTouchEmulation){let mapping={mouse_up:"touch_up",mouse_down:"touch_down",mouse_move:"touch_move",mouse_cancel:"touch_cancel"};if(ev.buttons!==1&&name!=="mouse_up")return;if(this.grabbed!==null){let pos0=[ev.clientX,ev.clientY],pos=this.grabbed.appToChild(pos0),t=new Touch({pos,state:mapping[name],nativeObject:ev,identifier:-1});this.grabbed.emit(mapping[name],t)}else{let t=new Touch({pos:this.app.toChild([ev.clientX,ev.clientY]),state:mapping[name],nativeObject:ev,identifier:-1});this.app.childEmit(mapping[name],t,!0)}}else this.grabbed!==null?this.grabbed.emit(name,ev):this.app.childEmit(name,ev,!0)}process_wheel(ev,name){if(this.mouseev!=null){if(this.app.requestFrameUpdate(),this.grabbed!=null){let pos=this.grabbed.appToChild([this.mouseev.clientX,this.mouseev.clientY]),t=new Touch({pos,state:name,nativeObject:ev});return this.grabbed.emit(name,t)}else{let t=new Touch({pos:this.app.toChild([this.mouseev.clientX,this.mouseev.clientY]),state:name,nativeObject:ev});this.app.childEmit(name,t,!0)}ev.preventDefault()}}vibrate(intensity1,intensity2,duration){window.navigator.vibrate(duration)}}function evaluatedProperty(key,value,context,root){if(typeof value=="string"||value instanceof String){if(key.startsWith("on_"))return new Function("resources","parent","root",`return function(event, object, value) {${value}}`).bind(context)(App.resources,context.parent,root);if(value.trim().startsWith("(")&&value.indexOf("=>")<value.indexOf(`
`)){const func=new Function("resources","parent","root",`return ${value}`).bind(context)(App.resources,context.parent,root);return func.markupMethod=!0,func}const objs=new Set;let objCount=0;if(value[0]!=="'"&&value[0]!=='"')for(let m of value.matchAll(/(?!\.)\b([a-z]\w*)\.([a-z_]\w*)\b/ig)){const c=m[1];c!=="this"&&c!=="parent"&&c!=="root"&&c!=="resources"&&objs.add(c),objCount++}if(objCount===0)return new Function("resources",`return ${value};`)(App.resources);const objStr=[...objs].join(", "),functionBody=`return function (${objStr}) { return ${value} }`,dynamicFunc=new Function("resources","parent","root",functionBody)(App.resources,context.parent,root).bind(context);return dynamicFunc.text=`(${objStr}) => ${value}`,dynamicFunc}return value}function instanceClassData(widget,objectData,rootWidget){const props={},clsName=widget.constructor.name,merged={...App.rules.get(clsName),...objectData};for(let p in merged){const val=merged[p];if(p==="children"&&val instanceof Array){const ch=[];for(let c of val)if(c instanceof Object&&"cls"in c){const[cls,clsExtends]=App.classes[c.cls],childWidget=cls.a();instanceClassData(childWidget,c,rootWidget),ch.push(childWidget)}else throw Error(`Unknown child class ${c} on clsName ${clsName}`);widget instanceof App?widget.baseWidget.children=ch:widget.children=ch}else if(p!=="cls")try{props[p]=evaluatedProperty(p,val,widget,rootWidget)}catch{props[p]=val}}widget.updateProperties(props)}class Timer{constructor(time,initElapsed=0,callback=null){this.elapsed=0,this.timer=time,this.triggered=!1,this.callback=callback,initElapsed>0&&this.tick(initElapsed)}finished(){return this.elapsed>=this.timer}tick(millis){return this.elapsed>=this.timer?(this.triggered&&(this.triggered=!1),!1):(this.elapsed+=millis,this.elapsed>=this.timer?(this.callback!=null&&this.callback("timer",this),this.triggered=!0,!0):!1)}reset(time=-1,initElapsed=0){this.triggered=!1,time>=0&&(this.timer=time),initElapsed>0&&this.tick(initElapsed)}}const minFontSize=8,scaleFactor=48*(1/window.devicePixelRatio||1);function tokenizeRich(text){const tokens=[],re=/\[(?:\s*(fg|bg|s|a)\s*=\s*([^\]\s]+)\s*)+\]|\[\/\]|\[\[|\]\]/g;let i=0,m;for(;m=re.exec(text);){const j=m.index;j>i&&tokens.push({type:"text",text:text.slice(i,j)});const tag=m[0];if(tag==="[[")tokens.push({type:"text",text:"["});else if(tag==="]]")tokens.push({type:"text",text:"]"});else if(tag==="[/]")tokens.push({type:"tagClose"});else{const attrs={},inner=tag.slice(1,-1);for(const kv of inner.trim().split(/\s+/)){const mm=/^(fg|bg|s|a)\s*=\s*(.+)$/.exec(kv);mm&&(attrs[mm[1]]=mm[2])}tokens.push({type:"tagOpen",attrs})}i=re.lastIndex}return i<text.length&&tokens.push({type:"text",text:text.slice(i)}),tokens}function buildRuns(tokens){const stack=[{fg:null,bg:null,s:1,a:1}],runs=[];for(const t of tokens){if(t.type==="text"){t.text&&runs.push({text:t.text,style:{...stack[stack.length-1]}});continue}if(t.type==="tagOpen"){const top={...stack[stack.length-1]};if(t.attrs.fg&&(top.fg=t.attrs.fg),t.attrs.bg&&(top.bg=t.attrs.bg),t.attrs.s){const mult=parseFloat(t.attrs.s);isFinite(mult)&&mult>0&&(top.s*=mult)}if(t.attrs.a){const alpha=parseFloat(t.attrs.a);isFinite(alpha)&&(top.a*=Math.max(0,Math.min(1,alpha)))}stack.push(top);continue}stack.length>1&&stack.pop()}return runs}function atomizeRuns(runs){const atoms=[];for(const r of runs){const parts=r.text.split(/(\n|\s+)/);for(const p of parts)p!==""&&atoms.push({text:p,style:r.style})}return atoms}function measureAtom(ctx,atom,baseSize,fontName){var _a;const s=baseSize*(((_a=atom.style)==null?void 0:_a.s)||1),fontPx=Math.max(1,Math.round(s)),oldFont=ctx.font;ctx.font=`${fontPx}px ${fontName}`;const w=ctx.measureText(atom.text).width;return ctx.font=oldFont,{width:w,sizePx:fontPx}}function wrapRich(ctx,atoms,baseSize,fontName,maxWidth){const lines=[];let line=[],lineWidth=0;const flush=()=>{const merged=[];for(const seg of line){const last=merged[merged.length-1];last&&last.fg===seg.fg&&last.bg===seg.bg&&last.a===seg.a&&last.sizePx===seg.sizePx?(last.text+=seg.text,last.width+=seg.width):merged.push({...seg})}lines.push(merged),line=[],lineWidth=0};for(const atom of atoms){if(atom.text===`
`){flush();continue}const{width,sizePx}=measureAtom(ctx,atom,baseSize,fontName),isSpace=/^\s+$/.test(atom.text);lineWidth+width>maxWidth&&line.length>0?(flush(),isSpace||(line.push({text:atom.text,width,sizePx,fg:atom.style.fg??null,bg:atom.style.bg??null,a:atom.style.a??1}),lineWidth+=width)):(line.push({text:atom.text,width,sizePx,fg:atom.style.fg??null,bg:atom.style.bg??null,a:atom.style.a??1}),lineWidth+=width)}return flush(),lines}function fallbackMetrics(sizePx){const ascent=sizePx*.8,descent=sizePx*.2;return{ascent,descent,lineHeight:ascent+descent}}function setFont(ctx,px,fontName){const prev=ctx.font;return ctx.font=`${px}px ${fontName}`,prev}function sizeRichText(ctx,text,size,fontName,rect,color,wordwrap=!0){let scale=1;size<minFontSize&&(scale=1/scaleFactor,ctx.save(),ctx.scale(scale,scale)),setFont(ctx,size>=minFontSize?size:Math.ceil(size/scale),fontName);const runs=buildRuns(tokenizeRich(text)),atoms=wordwrap?atomizeRuns(runs):runs.map(r=>({...r})),lines=wordwrap?wrapRich(ctx,atoms,size/scale,fontName,rect.w/scale):[wrapRich(ctx,atoms,size/scale,fontName,1e9)[0]||[]];let totalH=0;for(const segs of lines){let lineH=0;for(const seg of segs){const{ascent,descent}=fallbackMetrics(seg.sizePx);lineH=Math.max(lineH,ascent+descent)}totalH+=lineH||size}return totalH+=lines.length?0:size,size<minFontSize&&ctx.restore(),[rect.w,totalH*scale]}function getRichText(ctx,text,size,fontName,halign,valign,rect,color,wordwrap=!0){let scale=1;size<minFontSize&&(scale=1/scaleFactor,ctx.save(),ctx.scale(scale,scale));const basePx=size>=minFontSize?size:Math.ceil(size/scale);setFont(ctx,basePx,fontName);const runs=buildRuns(tokenizeRich(text)),atoms=wordwrap?atomizeRuns(runs):runs.map(r=>({...r})),lines=wordwrap?wrapRich(ctx,atoms,basePx,fontName,rect.w/scale):[wrapRich(ctx,atoms,basePx,fontName,1e9)[0]||[]],laid=[];let y=rect.y/scale,maxLineHeights=[];for(const segs of lines){let lineW=0,lineH=0;for(const seg of segs){lineW+=seg.width;const{ascent,descent}=fallbackMetrics(seg.sizePx);lineH=Math.max(lineH,ascent+descent)}let x=rect.x/scale;halign==="center"?x+=(rect.w/scale-lineW)/2:halign==="right"&&(x+=rect.w/scale-lineW),laid.push({x,y,segs,lineH}),maxLineHeights.push(lineH||basePx),y+=lineH||basePx}const textH=maxLineHeights.reduce((a2,b)=>a2+b,0);let off=0;switch(valign){case"middle":off=(rect.h/scale-textH)/2;break;case"bottom":off=rect.h/scale-textH;break}const richData={fontName,lines:laid.map(L=>({x:L.x,y:L.y,lineH:L.lineH,segments:L.segs})),off,valign,baseColor:color,baseSizePx:basePx};return size<minFontSize&&ctx.restore(),richData}function drawRichText(ctx,richData,overrideColor=null){let scale=1;const size=richData.baseSizePx;size<minFontSize&&(scale=1/scaleFactor,ctx.save(),ctx.scale(scale,scale)),ctx.textBaseline="top";for(const L of richData.lines){let x=L.x;const yTop=L.y+(richData.off??0);for(const seg of L.segments){if(!seg.text)continue;const prevFont=ctx.font;ctx.font=`${seg.sizePx}px ${richData.fontName}`;const m=ctx.measureText(seg.text),ascent=m.actualBoundingBoxAscent??seg.sizePx*.8,descent=m.actualBoundingBoxDescent??seg.sizePx*.2,lineH=ascent+descent,pad=Math.round(seg.sizePx*.15);if(seg.bg){const prevFill2=ctx.fillStyle;ctx.fillStyle=seg.bg,ctx.globalAlpha*=seg.a??1,ctx.fillRect(x-pad,yTop-pad,m.width+pad*2,lineH+pad*2),ctx.globalAlpha/=seg.a??1,ctx.fillStyle=prevFill2}const fg=overrideColor??seg.fg??richData.baseColor,prevFill=ctx.fillStyle,prevAlpha=ctx.globalAlpha;ctx.fillStyle=fg,ctx.globalAlpha=prevAlpha*(seg.a??1),ctx.fillText(seg.text,x,yTop),ctx.globalAlpha=prevAlpha,ctx.fillStyle=prevFill,x+=m.width,ctx.font=prevFont}}size<minFontSize&&ctx.restore()}class Rules{constructor(){this.rules=new Map}add(widgetClass,ruleProperties,replace=!0){let curRuleset=this.rules.get(widgetClass);if(curRuleset&&!replace)for(let p in curRuleset)curRuleset[p]=ruleProperties[p];else this.rules.set(widgetClass,ruleProperties)}get(widgetClass){return this.rules.get(widgetClass)??{}}remove(widgetClass){return this.rules.delete(widgetClass)}}class EventConnection{constructor(listener,event,callback){this.listener=listener,this.event=event,this.callback=callback}}class EventManager{constructor(){this.connections=new Map}listen(listener,emitterEvent,callback){const[first,second]=emitterEvent.split(".",2);emitterEvent=second??first;const emitterId=second===void 0?listener.id??listener:first;let conn=new EventConnection(listener,emitterEvent,callback),conns=this.connections.get(emitterId);conns?conns.add(conn):this.connections.set(emitterId,new Set([conn]))}emit(emitter,event,data){const conns=this.connections.get(emitter.id??emitter);if(!conns)return!1;for(let conn of conns)if(conn.event===event&&conn.callback(event,emitter,data,conn.listener))return!0;return!1}disconnect(widget){this.connections.delete(widget.id??widget);for(let emitter of this.connections.keys()){const deleteList=[],conns=this.connections.get(emitter);if(conns){for(let conn of conns)conn.listener===widget&&deleteList.push(conn);deleteList.forEach(conn=>conns.delete(conn))}}}}class WidgetAnimation{constructor(){__publicField(this,"stack",[]);__publicField(this,"widget",null);__publicField(this,"props",{});__publicField(this,"elapsed",0)}add(props,duration=1e3){this.stack.push([props,duration])}update(app,millis){if(this.widget===null)return;let targetProps=this.stack[0][0],duration=this.stack[0][1];if(this.elapsed==0){this.initProps={};for(let p in targetProps)this.initProps[p]=this.widget[p]}let skip=this.elapsed+millis-duration;this.elapsed=skip<0?this.elapsed+millis:duration;let wgt=duration==0?1:this.elapsed/duration;if(skip<0)for(let p in this.initProps){let x=targetProps[p];typeof x=="number"&&(this.widget[p]=(1-wgt)*this.initProps[p]+wgt*x)}else{for(let p in this.initProps){let x=targetProps[p];typeof x=="number"&&(this.widget[p]=x)}if(this.stack=this.stack.slice(1),this.elapsed=skip,this.stack.length==0)this.cancel();else{this.initProps={};for(let p in this.stack[0][0])this.initProps[p]=this.widget[p]}}}start(widget){this.widget=widget,widget._animation=this}cancel(){this.widget!==null&&(this.widget._animation=null,this.widget.emit("animationComplete",this))}}function a(klass,arg1,arg2){var _a;Widget._ALLOW_CONSTRUCT=!0;const obj=new klass;Widget._ALLOW_CONSTRUCT=!1;let id=null,props={};return typeof arg1=="string"?(id=arg1,props=arg2??{}):props=arg1??{},id&&(obj.id=id),obj instanceof Widget&&instanceClassData(obj,{},obj),(_a=obj.updateProperties)==null||_a.call(obj,props),obj}const _Widget=class _Widget extends Rect{constructor(){super();__publicField(this,"bgColor",null);__publicField(this,"outlineColor",null);__publicField(this,"_animation",null);__publicField(this,"_layoutNotify",!1);__publicField(this,"hints",{});if(!_Widget._ALLOW_CONSTRUCT)throw new Error(`[ESKV] Do not use 'new ${typeof this}()'. Use '${typeof this}.a(...)' instead.`);return _Widget._ALLOW_CONSTRUCT=!1,this.parent=null,this._processTouches=!1,this._deferredProps=null,this._children=[],this._needsLayout=!0,new Proxy(this,{set(target,name,value,receiver){return typeof name=="string"&&(["x","y","w","h","children","rect"].includes(name)||name[0]=="_")?Reflect.set(target,name,value,receiver):(Reflect.set(target,name,value,receiver),typeof name=="string"&&Reflect.apply(target.emit,receiver,[name,value]),!0)}})}static a(arg1,arg2=void 0){var _a;_Widget._ALLOW_CONSTRUCT=!0;const obj=new this;_Widget._ALLOW_CONSTRUCT=!1;let id=null,props={};return typeof arg1=="string"?(id=arg1,props=arg2??{}):props=arg1??{},id&&(obj.id=id),obj instanceof _Widget&&instanceClassData(obj,{},obj),(_a=obj.updateProperties)==null||_a.call(obj,props),obj}i(id){return this.id=id,this}p(props){return this.updateProperties(props),this}sh(hints,mode="replace"){return mode==="merge"?this.hints=Object.assign({},this.hints??{},hints):this.hints=hints,this}b(property,callback){return this.listen(property,callback)}c(child){if(child instanceof _Widget)this.addChild(child);else for(const ch of child)this.addChild(ch);return this}d(property,computeFn){return this._deferredProps||(this._deferredProps={}),this._deferredProps[property]=computeFn,this}set rect(rect){this[0]=rect[0],this[1]=rect[1],this[2]=rect[2],this[3]=rect[3],this._needsLayout=!0}get rect(){return new Rect([this[0],this[1],this[2],this[3]])}deferredProperties(app){let properties=this._deferredProps;this._deferredProps=null;for(let p in properties)if(!p.startsWith("on_")&&!p.startsWith("_")&&typeof properties[p]=="function"){let func=properties[p],args,rval;[args,rval]=(func.text??func.toString()).split("=>"),args=args.replace("(","").replace(")","").split(",").map(a2=>a2.trim());let objs=args.map(a2=>app.findById(a2)),obmap={};for(let a2 of args)obmap[a2]=app.findById(a2);const re=/(\w+)\.(\w+)|(\w+)\[['"](\w+)['"]\]/g;for(let pat of rval.matchAll(re)){let pr,ob;if([ob,pr]=pat.slice(1),ob==="this")this.listen(pr,(evt,obj,data)=>{try{this[p]=func(...objs)}catch(error){}});else if(ob in obmap)try{this.listen(`${ob}.${pr}`,(evt,obj,data)=>{try{this[p]=func(...objs)}catch(error){}})}catch(error){`${ob}`}}try{this[p]=func(...objs)}catch(error){}}}updateProperties(properties){for(let p in properties)!p.startsWith("on_")&&!p.startsWith("_")&&typeof properties[p]=="function"&&!("markupMethod"in properties[p])?this._deferredProps=properties:this[p]=properties[p]}listen(emitterEvent,func){return App.get()._eventManager.listen(this,emitterEvent,func),this}emit(event,data){return"on_"+event in this&&this["on_"+event](event,this,data)?!0:App.get()._eventManager.emit(this,event,data)}*iter(recursive=!0,inView=!0){if(yield this,!!recursive)for(let c of this._children)yield*c.iter(...arguments)}*iterParents(){this.parent!==null&&(yield this.parent,this.parent!=App.get()&&(yield*this.parent.iterParents()))}findById(id){for(let w of this.iter(!0,!1))if("id"in w&&w.id==id)return w;return null}*iterByPropertyValue(property,value){for(let w of this.iter(!0,!1))property in w&&w[property]==value&&(yield w)}getTransformRecurse(includeSelf=!1,widget=null){let transform=this!==widget&&this.parent!==null?this.parent.getTransformRecurse(!0,widget):new DOMMatrix;if(!includeSelf)return transform;let newT=this.getTransform();return newT?transform.multiply(newT):transform}getTransform(){return null}applyTransform(pt,invert=!1,recurse=!1,includeSelf=!1,firstWidget=null){let tx=recurse?this.getTransformRecurse(includeSelf,firstWidget):this.getTransform();if(!tx)return pt;invert&&(tx=tx.inverse());let dp=tx.transformPoint(new DOMPoint(pt.x,pt.y));return new Vec2([dp.x,dp.y])}appToWidget(pos,recurse=!0){if(this.parent){let pt=this.parent.getTransformRecurse().inverse().transformPoint(new DOMPoint(pos[0],pos[1]));return new Vec2([pt.x,pt.y])}return pos}appToChild(pos,recurse=!0){let pt=this.getTransformRecurse().inverse().transformPoint(new DOMPoint(pos[0],pos[1]));return new Vec2([pt.x,pt.y])}toChild(pos){let tx=this.getTransform();if(!tx)return pos;let pt=tx.inverse().transformPoint(new DOMPoint(pos[0],pos[1]));return new Vec2([pt.x,pt.y])}addChild(child,pos=-1){return pos==-1?this._children.push(child):this._children=[...this._children.slice(0,pos),child,...this._children.slice(pos)],this.emit("child_added",child),child.parent=this,this._needsLayout=!0,this}addNew(klass,props_or_id,props){return this.addChild(a(klass,props_or_id,props)),this}removeChild(child,disconnect=!0){this._children=this.children.filter(c=>c!=child),disconnect&&App.get()._eventManager.disconnect(child),this.emit("child_removed",child),child.parent=null,this._needsLayout=!0}get children(){return this._children}set children(children){for(let c of this._children)this.emit("child_removed",c),c.parent=null,this._needsLayout=!0;this._children=[];for(let c of children)this.addChild(c)}set x(val){this._needsLayout=!0,this[0]=val}set center_x(val){this._needsLayout=!0,this[0]=val-this[2]/2}set right(val){this._needsLayout=!0,this[0]=val-this[2]}set y(val){this._needsLayout=!0,this[1]=val}set center_y(val){this._needsLayout=!0,this[1]=val-this[3]/2}set bottom(val){this._needsLayout=!0,this[1]=val-this[3]}set w(val){this._needsLayout=!0,this[2]=val}set h(val){this._needsLayout=!0,this[3]=val}get x(){return this[0]}get center_x(){return this[0]+this[2]/2}get right(){return this[0]+this[2]}get y(){return this[1]}get center_y(){return this[1]+this[3]/2}get bottom(){return this[1]+this[3]}get w(){return this[2]}get h(){return this[3]}on_wheel(event,object,wheel){for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,wheel))return!0;return!1}on_touch_down(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,t))return!0}else for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,touch))return!0;return!1}on_touch_up(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,t))return!0}else for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,touch))return!0;return!1}on_touch_move(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,t))return!0}else for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,touch))return!0;return!1}on_touch_cancel(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,t))return!0}else for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,touch))return!0;return!1}on_back_button(event,object,history2){return!1}getMetric(widget,target,rule,parentWidth=null,parentHeight=null){let app=App.get();if(rule===null)return widget[target];let value=0,base="relative";for(parentWidth=parentWidth??this.w,parentHeight=parentHeight??this.h;;){if(rule.constructor==String){let r2=rule.slice(-2);if(r2=="ww"){value=+rule.slice(0,-2)*widget.w;break}if(r2=="wh"){value=+rule.slice(0,-2)*widget.h;break}if(r2=="aw"){value=+rule.slice(0,-2)*app.dimW,base="absolute";break}if(r2=="ah"){value=+rule.slice(0,-2)*app.dimH,base="absolute";break}let r1=rule.slice(-1);if(r1=="w"){value=+rule.slice(0,-1)*parentWidth;break}if(r1=="h"){value=+rule.slice(0,-1)*parentHeight;break}value=+rule;break}if(target=="w"||target=="x"||target=="center_x"||target=="right"){value=+rule;break}value=+rule;break}return base=="relative"&&(["x","center_x","right"].includes(target)&&(value+=this.x),["y","center_y","bottom"].includes(target)&&(value+=this.y)),value}applyHintMetric(widget,target,rule,parentWidth=null,parentHeight=null){let app=App.get();if(rule===null)return;let value=0,base="relative";for(parentWidth=parentWidth??this.w,parentHeight=parentHeight??this.h;;){if(rule.constructor==String){let r2=rule.slice(-2);if(r2=="ww"){value=+rule.slice(0,-2)*widget.w;break}if(r2=="wh"){value=+rule.slice(0,-2)*widget.h;break}if(r2=="aw"){value=+rule.slice(0,-2)*app.dimW,base="absolute";break}if(r2=="ah"){value=+rule.slice(0,-2)*app.dimH,base="absolute";break}let r1=rule.slice(-1);if(r1=="w"){value=+rule.slice(0,-1)*parentWidth;break}if(r1=="h"){value=+rule.slice(0,-1)*parentHeight;break}value=+rule;break}if(target=="w"||target=="x"||target=="center_x"||target=="right"){value=+rule*parentWidth;break}value=+rule*parentHeight;break}base=="relative"&&(["x","center_x","right"].includes(target)&&(value+=this.x),["y","center_y","bottom"].includes(target)&&(value+=this.y)),widget[target]=value}applyHints(c,w=null,h=null){let hints=c.hints;w=w??this.w,h=h??this.h,"w"in hints&&hints.w!=null&&hints.w.constructor==String&&hints.w.slice(-2)=="wh"?(hints.h!==void 0&&this.applyHintMetric(c,"h",hints.h,w,h),hints.w!==void 0&&this.applyHintMetric(c,"w",hints.w,w,h)):(hints.w!==void 0&&this.applyHintMetric(c,"w",hints.w,w,h),hints.h!==void 0&&this.applyHintMetric(c,"h",hints.h,w,h));for(let ht in hints)ht!="w"&&ht!="h"&&this.applyHintMetric(c,ht,hints[ht],w,h)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;for(let c of this.children)this.applyHints(c),c.layoutChildren()}_draw(app,ctx,millis){this.draw(app,ctx);let transform=this.getTransform();if(transform){ctx.save(),ctx.transform(transform.a,transform.b,transform.c,transform.d,transform.e,transform.f);for(let c of this._children)c._draw(app,ctx,millis);ctx.restore();return}for(let c of this._children)c._draw(app,ctx,millis)}draw(app,ctx){let r=this.rect;if(ctx.beginPath(),ctx.rect(r[0],r[1],r[2],r[3]),this.bgColor!=null){const origFill=ctx.fillStyle;ctx.fillStyle=this.bgColor,ctx.fill(),ctx.fillStyle=origFill}if(this.outlineColor!=null){let lw=ctx.lineWidth;ctx.lineWidth=this.getMetric(this,"lineWidth",this.hints.lineWidth??`${1/app.tileSize}`);const origStroke=ctx.strokeStyle;ctx.strokeStyle=this.outlineColor,ctx.stroke(),ctx.lineWidth=lw,ctx.strokeStyle=origStroke}}update(app,millis){this._deferredProps!=null&&this.deferredProperties(app),this._animation!=null&&(this._animation.update(app,millis),app.requestFrameUpdate()),this._needsLayout&&(this.layoutChildren(),app.requestFrameUpdate());for(let c of this._children)c.update(app,millis)}};__publicField(_Widget,"_ALLOW_CONSTRUCT",!1);let Widget=_Widget;const _App=class _App extends Widget{static registerClass(name,cls,baseClsName){_App.classes[name]=[cls,baseClsName]}constructor(){if(_App.appInstance!=null)return _App.appInstance;Widget._ALLOW_CONSTRUCT=!0,super(),Widget._ALLOW_CONSTRUCT=!1,_App.appInstance=this,window.app=this,this._eventManager=new EventManager,this.id="app",this.canvas=null,this.canvasName="canvas",this.w=-1,this.h=-1,this._baseWidget=a(Widget,{hints:{x:0,y:0,w:1,h:1}}),this._baseWidget.parent=this,this._modalWidgets=[],this._udpateActive=!0,this.pixelSize=1,this.integerTileSize=!1,this.exactDimensions=!1,this.prefDimW=32,this.prefDimH=16,this.dimW=this.prefDimW,this.dimH=this.prefDimH,this.tileSize=this.getTileScale()*this.pixelSize,this.offsetX=0,this.offsetY=0,this.shakeX=0,this.shakeY=0,this.shakeAmount=0,this.timer_tick=null,this.timers=[],this.continuousFrameUpdates=!1,this._requestedFrameUpdate=!1}get baseWidget(){return this._baseWidget}addTimer(duration,callback){let t=new Timer(duration,0,callback);return this.timers.push(t),t}removeTimer(timer){this.timers=this.timers.filter(t=>t!=timer)}addModal(modal){this._modalWidgets.push(modal),this._needsLayout=!0}removeModal(modal){this._modalWidgets=this._modalWidgets.filter(m=>m!=modal)}static get(){return _App.appInstance||(_App.appInstance=new _App),_App.appInstance}start(){let that=this;this.setupCanvas(),this.inputHandler=new InputHandler(this),window.onresize=(()=>that.updateWindowSize()),this.updateWindowSize(),setTimeout(()=>this._start(),1)}_start(){this.update()}childEmit(event,data,topModalOnly=!1){if(topModalOnly&&this._modalWidgets.length>0)return this._modalWidgets[this._modalWidgets.length-1].emit(event,data);if(this._baseWidget.emit(event,data))return!0;for(let mw of this._modalWidgets)if(mw.emit(event,data))return!0;return!1}*iter(recursive=!0,inView=!0){yield this,yield*this._baseWidget.iter(...arguments);for(let mw of this._modalWidgets)yield*mw.iter(...arguments)}findById(id){for(let w of this.iter(!0,!1))if("id"in w&&w.id==id)return w;return null}*iterByPropertyValue(property,value){for(let w of this.iter(!0,!1))property in w&&w[property]===value&&(yield w)}update(){this._requestedFrameUpdate=!1,this._udpateActive=!0;let millis=15,n_timer_tick=Date.now();this.timer_tick!=null&&(millis=Math.min(n_timer_tick-this.timer_tick,30)),(this.timers.length>0||this._needsLayout)&&this.requestFrameUpdate();for(let t of this.timers)t.tick(millis);this._needsLayout&&this.layoutChildren();for(let res of _App.resources.values())res.update(this,millis);this._baseWidget.update(this,millis);for(let mw of this._modalWidgets)mw.update(this,millis);this.ctx&&this._draw(this,this.ctx,millis),this.continuousFrameUpdates&&this.requestFrameUpdate(),this.timer_tick=n_timer_tick,this._udpateActive=!1,this._requestedFrameUpdate&&(this._requestedFrameUpdate=!1,this.requestFrameUpdate())}requestFrameUpdate(){this._requestedFrameUpdate||(this._udpateActive?this._requestedFrameUpdate=!0:(this._udpateActive=!0,window.requestAnimationFrame(()=>this.update())))}_draw(app,ctx,millis){if(!this.canvas)return;ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.shakeX=0,this.shakeY=0,this.screenShake(),ctx.save();let tx=this.getTransform();tx&&ctx.transform(tx.a,tx.b,tx.c,tx.d,tx.e,tx.f),this._baseWidget._draw(app,ctx,millis);for(let mw of this._modalWidgets)mw._draw(app,ctx,millis);ctx.restore()}getTransform(recurse=!0){return new DOMMatrix().translate(this.offsetX+this.shakeX,this.offsetY+this.shakeY).scale(this.tileSize,this.tileSize)}on_prefDimW(e,o,v){this.updateWindowSize()}on_prefDimH(e,o,v){this.updateWindowSize()}on_tileSize(e,o,v){this.prefDimH<0&&this.prefDimW<0&&this.updateWindowSize()}computeDeviceScale(){const dpr=window.devicePixelRatio||1,scale=1080/(Math.min(window.innerWidth,window.innerHeight)*dpr);return Math.max(1,Math.min(scale,3))}updateWindowSize(){this.x=0,this.y=0,this.w=window.innerWidth,this.h=window.innerHeight,this.pixelSize=this.computeDeviceScale(),(this.prefDimH>=0||this.prefDimW>=0)&&(this.tileSize=this.getTileScale()),this.fitDimensionsToTileSize(this.tileSize),this.canvas!==null&&this.setupCanvas();try{screen.orientation.unlock()}catch{}this._needsLayout=!0,this.requestFrameUpdate()}getTileScale(){let sh=this.h,sw=this.w,scale=1/this.pixelSize;return this.prefDimW<0&&this.prefDimH<0?this.tileSize>0&&(scale=this.tileSize/this.pixelSize):this.prefDimW<0?scale=sh/this.prefDimH/this.pixelSize:this.prefDimH<0?scale=sw/this.prefDimW/this.pixelSize:scale=Math.min(sh/this.prefDimH/this.pixelSize,sw/this.prefDimW/this.pixelSize),this.integerTileSize&&scale>1&&(scale=Math.floor(scale)),scale*this.pixelSize}fitDimensionsToTileSize(scale){let sh=this.h,sw=this.w;if(this.exactDimensions){this.prefDimW<0&&this.prefDimH<0?(this.dimW=sw/this.tileSize,this.dimH=sh/this.tileSize):this.prefDimH<0?(this.dimW=this.prefDimW,this.dimH=sh/this.tileSize):this.prefDimW<0?(this.dimW=sw/this.tileSize,this.dimH=this.prefDimH):(this.dimH=this.prefDimH,this.dimW=this.prefDimW);return}this.dimH=Math.floor(sh/scale),this.dimW=Math.floor(sw/scale)}setupCanvas(){const canvas=document.getElementById(this.canvasName);if(!(canvas instanceof HTMLCanvasElement))throw"No canvas element named "+this.canvasName;this.canvas=canvas,this.canvas.width=this.w,this.canvas.height=this.h,this.ctx=this.canvas.getContext("2d"),this.ctx&&(this.ctx.imageSmoothingEnabled=!1,this.offsetX=Math.floor((this.w-this.tileSize*this.dimW)/2),this.offsetY=Math.floor((this.h-this.tileSize*this.dimH)/2))}applyHints(c){super.applyHints(c,this.dimW,this.dimH)}screenShake(){this.shakeAmount&&this.shakeAmount--;let shakeAngle=Math.random()*Math.PI*2;this.shakeX=Math.round(Math.cos(shakeAngle)*this.shakeAmount),this.shakeY=Math.round(Math.sin(shakeAngle)*this.shakeAmount)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.applyHints(this._baseWidget),this._baseWidget.layoutChildren();for(let mw of this._modalWidgets)this.applyHints(mw),mw.layoutChildren()}};__publicField(_App,"appInstance",null),__publicField(_App,"rules",new Rules),__publicField(_App,"resources",new Map),__publicField(_App,"classes",{});let App=_App;class Label extends Widget{constructor(){super();__publicField(this,"fontSize",null);__publicField(this,"sizeGroup","");__publicField(this,"clip",!1);__publicField(this,"ignoreSizeForGroup",!1);__publicField(this,"fontName",'"Nimbus Mono PS", "Courier New", monospace');__publicField(this,"text","");__publicField(this,"wrap",!1);__publicField(this,"richText",!1);__publicField(this,"wrapAtWord",!0);__publicField(this,"align","center");__publicField(this,"valign","middle");__publicField(this,"color","white");this._textData=null}on_align(e,object,v){this._needsLayout=!0}on_valign(e,object,v){this._needsLayout=!0}on_wrap(e,object,v){this._needsLayout=!0}on_richText(e,object,v){this._needsLayout=!0}on_wrapAtWord(e,object,v){this._needsLayout=!0}on_text(e,object,v){this._needsLayout=!0}on_fontSize(e,object,v){this._needsLayout=!0}on_fontName(e,object,v){this._needsLayout=!0}layoutChildren(){let ctx=App.get().ctx;if(!ctx)return;let fontSize=this.fontSize===null?null:this.getMetric(this,"fontSize",this.fontSize);if("h"in this.hints&&this.hints.h==null&&fontSize!==null&&(this[3]=this.richText?sizeRichText(ctx,this.text,fontSize,this.fontName,this.rect,this.color,this.wrap)[1]:this.wrap?sizeWrappedText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[1]:sizeText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color)[1]),"w"in this.hints&&this.hints.w==null&&fontSize!==null&&(this[2]=this.richText?sizeRichText(ctx,this.text,fontSize,this.fontName,this.rect,this.color,this.wrap)[0]:this.wrap?sizeWrappedText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[0]:sizeText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color)[0]),fontSize=fontSize===null?this.h/2:fontSize,this.fontSize===null&&this.rect.w!==void 0){let i=0,w,h;for(;i<50;){if(this.richText?[w,h]=sizeRichText(ctx,this.text,fontSize,this.fontName,this.rect,this.color,this.wrap):this.wrap?[w,h]=sizeWrappedText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord):[w,h]=sizeText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color),(this.h>=h||"h"in this.hints&&this.hints.h==null||fontSize<.01)&&(this.w>=w||"w"in this.hints&&this.hints.w==null)){"h"in this.hints&&this.hints.h==null&&(this.h=h),"w"in this.hints&&this.hints.w==null&&(this.w=w);break}const err=Math.min(1.1,this.w/w,this.h/h);this.wrap?fontSize*=err**.5:fontSize*=err**1.1,i++}fontSize===void 0&&(fontSize=.001*App.get().h)}this.sizeGroup!==""?(this._bestFontSize=fontSize,this._textData=null):this.richText?this._textData=getRichText(ctx,this.text,fontSize,this.fontName,this.align,this.valign,this.rect,this.color,this.wrap):this.wrap?this._textData=getWrappedTextData(ctx,this.text,fontSize,this.fontName,this.align,this.valign,this.rect,this.color,this.wrapAtWord):this._textData=getTextData(ctx,this.text,fontSize,this.fontName,this.align,this.valign,this.rect,this.color),super.layoutChildren()}sizeToGroup(ctx){if(this._bestFontSize===void 0)return;let fontSize=1/0;for(let lbl of App.get().iterByPropertyValue("sizeGroup",this.sizeGroup))fontSize>lbl._bestFontSize&&!lbl.ignoreSizeForGroup&&(fontSize=lbl._bestFontSize);if(fontSize>0)for(let lbl of App.get().iterByPropertyValue("sizeGroup",this.sizeGroup)){const fs=lbl.clip||!lbl.ignoreSizeForGroup?fontSize:lbl._bestFontSize;lbl.richText?lbl._textData=getRichText(ctx,lbl.text,fs,lbl.fontName,lbl.align,lbl.valign,lbl.rect,lbl.color,lbl.wrap):lbl.wrap?lbl._textData=getWrappedTextData(ctx,lbl.text,fs,lbl.fontName,lbl.align,lbl.valign,lbl.rect,lbl.color,lbl.wrapAtWord):lbl._textData=getTextData(ctx,lbl.text,fs,lbl.fontName,lbl.align,lbl.valign,lbl.rect,lbl.color)}}draw(app,ctx){if(super.draw(app,ctx),this.clip){ctx.save();const r=this.rect;ctx.rect(r.x,r.y,r.w,r.h),ctx.clip()}!this._textData&&this.sizeGroup!==""&&this.sizeToGroup(ctx),this._textData&&(this.richText?drawRichText(ctx,this._textData,this.color):this.wrap?drawWrappedText(ctx,this._textData,this.color):drawText(ctx,this._textData,this.color)),this.clip&&ctx.restore()}}class Button extends Label{constructor(){super();__publicField(this,"bgColor",colorString([.5,.5,.5]));__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.4,.4,.4]));__publicField(this,"disable",!1)}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,!0):!1}on_touch_up(event,object,touch){return super.on_touch_up(event,object,touch)?!0:touch.grabbed!=this?!1:(touch.ungrab(),!this.disable&&this.collide(touch.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(event,object,touch){return super.on_touch_move(event,object,touch)?!0:(touch.grabbed==this&&!this.disable&&(this._touching=this.collide(touch.rect)),!1)}draw(app,ctx){let saved=this.bgColor,saved2=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(app,ctx),this.bgColor=saved,this.color=saved2}}class BasicButton extends Widget{constructor(){super();__publicField(this,"color",colorString([.8,.8,.8]));__publicField(this,"bgColor",colorString([.5,.5,.5]));__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.4,.4,.4]));__publicField(this,"disable",!1)}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,!0):!1}on_touch_up(event,object,touch){return super.on_touch_up(event,object,touch)?!0:touch.grabbed!=this?!1:(touch.ungrab(),!this.disable&&this.collide(touch.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(event,object,touch){return super.on_touch_move(event,object,touch)?!0:(touch.grabbed==this&&!this.disable&&(this._touching=this.collide(touch.rect)),!1)}draw(app,ctx){let saved=this.bgColor,saved2=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(app,ctx),this.bgColor=saved,this.color=saved2}}class ToggleButton extends Label{constructor(){super();__publicField(this,"bgColor",colorString([.5,.5,.5]));__publicField(this,"pressColor",colorString([.7,.7,.7]));__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.4,.4,.4]));__publicField(this,"disable",!1);__publicField(this,"_press",!1);__publicField(this,"group",null);__publicField(this,"singleSelect",!0)}get press(){return this._press}set press(value){this._press=value}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,!0):!1}on_touch_up(event,object,touch){if(touch.grabbed!==this)return!1;if(touch.ungrab(),this._touching=!1,this.collide(touch.rect)){if(this.group===null||!this.singleSelect)this.press=!this.press;else{if(this.parent!==null)for(let w of this.parent.iterByPropertyValue("group",this.group))w!==this&&(w._press=!1);this.press=!0}return!0}return!1}on_touch_move(event,object,touch){return touch.grabbed===this?(this._touching=this.collide(touch.rect),!0):!1}draw(app,ctx){let saved=this.bgColor,saved2=this.color;this.press&&(this.bgColor=this.pressColor),this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(app,ctx),this.bgColor=saved,this.color=saved2}}class CheckBox extends Widget{constructor(){super();__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"color",colorString([.6,.6,.6]));__publicField(this,"bgColor",colorString([.5,.5,.5]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.3,.3,.3]));__publicField(this,"disable",!1);__publicField(this,"check",!1);__publicField(this,"group",null)}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,!0):!1}on_touch_up(event,object,touch){if(super.on_touch_up(event,object,touch))return!0;if(this.parent===null||touch.grabbed!=this)return!1;if(touch.ungrab(),!this.disable&&this.collide(touch.rect)){if(this._touching=!1,this.group==null)this.check=!this.check;else{for(let w of this.parent.iterByPropertyValue("group",this.group))w!=this&&(w.check=!1);this.check=!0}return!0}return!1}on_touch_move(event,object,touch){return super.on_touch_move(event,object,touch)?!0:touch.grabbed==this&&!this.disable?(this._touching=this.collide(touch.rect),!0):!1}draw(app,ctx){if(this.group!=null){let r2=this.rect;r2.w=r2.h=.5*Math.min(r2.w,r2.h),r2.x=this.x+(this.w-r2.w)/2,r2.y=this.y+(this.h-r2.h)/2;let ts2=App.get().tileSize,ctx2=App.get().ctx;if(!ctx2)return;ctx2.strokeStyle=this.disable?this.disableColor1:this.bgColor,ctx2.lineWidth=1/ts2,ctx2.beginPath(),ctx2.arc(r2.center_x,r2.center_y,r2.w/2,0,2*Math.PI),ctx2.stroke(),(this._touching||this.disable)&&(ctx2.fillStyle=this.disable?this.disableColor1:this.selectColor,ctx2.fill()),this.check&&(ctx2.fillStyle=this.disable?this.disableColor2:this.color,ctx2.beginPath(),ctx2.arc(r2.center_x,r2.center_y,r2.w/3,0,2*Math.PI),ctx2.fill());return}let r=this.rect;r.w=r.h=.5*Math.min(r.w,r.h),r.x=this.x+(this.w-r.w)/2,r.y=this.y+(this.h-r.h)/2;let ts=app.tileSize;ctx.beginPath(),ctx.strokeStyle=this.bgColor,this.disable&&(ctx.strokeStyle=this.disableColor1),ctx.lineWidth=1/ts,ctx.rect(r[0],r[1],r[2],r[3]),ctx.stroke(),this._touching&&(ctx.fillStyle=this.selectColor,ctx.fill()),this.check&&(ctx.strokeStyle=this.color,this.disable&&(ctx.strokeStyle=this.disableColor2),ctx.beginPath(),ctx.lineWidth=r.w/5,ctx.moveTo(r.x,r.y),ctx.lineTo(r.right,r.bottom),ctx.moveTo(r.right,r.y),ctx.lineTo(r.x,r.bottom),ctx.stroke())}}class Slider extends Widget{constructor(){super();__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"color",colorString([.6,.6,.6]));__publicField(this,"bgColor",colorString([.4,.4,.4]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.3,.3,.3]));__publicField(this,"disable",!1);__publicField(this,"min",0);__publicField(this,"max",1);__publicField(this,"curMax",1);__publicField(this,"unboundedStopMultiple",10);__publicField(this,"exponentialSlider",!1);__publicField(this,"step",null);__publicField(this,"orientation","horizontal");__publicField(this,"value",0);__publicField(this,"sliderSize",.2)}setValue(touch){let max=this.max??this.curMax,value=0;this.orientation=="horizontal"&&(value=clamp((touch.rect.x-this.x-this.w*this.sliderSize/2)/(this.w*(1-this.sliderSize)),0,1)),this.orientation=="vertical"&&(value=clamp((touch.rect.y-this.y-this.h*this.sliderSize/2)/(this.h*(1-this.sliderSize)),0,1)),this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?value=value>.5?max/this.unboundedStopMultiple+(value-.5)/.5*(max-max/this.unboundedStopMultiple):this.min+value/.5*(max/this.unboundedStopMultiple-this.min):value=this.min+(max-this.min)*value,this.step!=null&&(value=Math.round(value/this.step)*this.step),this.value=value}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touch=!0,this.setValue(touch),!0):!1}updateMax(){this.max===null&&(this.curMax=this.unboundedStopMultiple*this.value)}on_touch_up(event,object,touch){return touch.grabbed!=this?super.on_touch_up(event,object,touch):(touch.ungrab(),!this.disable&&this.collide(touch.rect)&&(this._touching=!1,this.setValue(touch)),this.updateMax(),!0)}on_touch_move(event,object,touch){return touch.grabbed!==this?super.on_touch_move(event,object,touch):(this.disable||(this._touching=this.collide(touch.rect),this.setValue(touch)),!1)}draw(app,ctx){let ts=app.tileSize,r=this.rect;if(this.orientation=="horizontal"){r.w-=this.sliderSize*this.w,r.x+=this.sliderSize/2*this.w;let rad=Math.min(this.sliderSize/2*this.w,this.h/2)/2;ctx.strokeStyle=this.disable?this.disableColor1:this.bgColor,ctx.beginPath(),ctx.lineWidth=4/ts,ctx.moveTo(r.x,r.center_y),ctx.lineTo(r.right,r.center_y),ctx.stroke();let max=this.max??this.curMax,vPos;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?vPos=this.value>max/this.unboundedStopMultiple?(.5+.5*(this.value-max/this.unboundedStopMultiple)/(max-max/this.unboundedStopMultiple))*r.w:.5*(this.value-this.min)/(max/this.unboundedStopMultiple-this.min)*r.w:vPos=(this.value-this.min)/(max-this.min)*r.w,ctx.strokeStyle=this.disable?this.disableColor2:this.bgColor,ctx.beginPath(),ctx.arc(r.x+vPos,r.center_y,rad,0,2*Math.PI),ctx.stroke(),ctx.fillStyle=this.color,(this._touching||this.disable)&&(ctx.fillStyle=this.disable?this.disableColor1:this.selectColor),ctx.fill()}if(this.orientation=="vertical"){r.h-=this.sliderSize*this.h,r.y+=this.sliderSize/2*this.h;let rad=Math.min(this.sliderSize/2*this.h,this.w/2)/2;ctx.strokeStyle=this.disable?this.disableColor1:this.bgColor,ctx.beginPath(),ctx.lineWidth=4/ts,ctx.moveTo(r.center_x,r.y),ctx.lineTo(r.center_x,r.bottom),ctx.stroke();let max=this.max??this.curMax,vPos;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?vPos=this.value>max/this.unboundedStopMultiple?(.5+.5*(this.value-max/this.unboundedStopMultiple)/(max-max/this.unboundedStopMultiple))*r.h:.5*(this.value-this.min)/(max/this.unboundedStopMultiple-this.min)*r.h:vPos=(this.value-this.min)/(max-this.min)*r.h,ctx.strokeStyle=this.disable?this.disableColor2:this.bgColor,ctx.beginPath(),ctx.arc(r.center_x,r.y+vPos,rad,0,2*Math.PI),ctx.stroke(),ctx.fillStyle=this.color,(this._touching||this.disable)&&(ctx.fillStyle=this.disable?this.disableColor1:this.selectColor),ctx.fill()}}}class TextInput extends Label{constructor(){super();__publicField(this,"_activeDOMInput",null);__publicField(this,"focus",!0);__publicField(this,"disable",!1);__publicField(this,"_inputSanitizer");this._textData=null}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,!0):(this.clearDOM(),!1)}on_touch_up(event,object,touch){return super.on_touch_up(event,object,touch)?!0:touch.grabbed!=this?!1:!this.disable&&this.collide(touch.rect)?(this._touching=!1,this.addDOMInput(),!0):(this.clearDOM(),!1)}on_layout(event,object,value){this.clearDOM()}_syncTextareaVAlign(inp,rt,lhPx){var _a,_b;const blockH=Math.max(1,((_b=(_a=this._textData)==null?void 0:_a.outText)==null?void 0:_b.length)||1)*lhPx;let padTop=0;this.valign==="middle"?padTop=Math.max(0,(rt.h-blockH)/2):this.valign==="bottom"&&(padTop=Math.max(0,rt.h-blockH)),inp.style.paddingTop=`${Math.floor(padTop)}px`}DOMInputRect(){let r=this.rect,t=this.getTransformRecurse(),rt=new Rect,dp1=t.transformPoint(new DOMPoint(r.x,r.y)),dp2=t.transformPoint(new DOMPoint(r.right,r.bottom));return[rt.x,rt.y]=[dp1.x,dp1.y],[rt.w,rt.h]=[dp2.x,dp2.y],rt.w-=rt.x,rt.h-=rt.y,rt}addDOMInput(){if(!this._textData)return;const app=App.get(),canvasdiv=document.getElementById("eskvapp");if(!canvasdiv)return;const type=this.wrap?"textarea":"input",inp=document.createElement(type);if(!(inp instanceof HTMLInputElement)&&!(inp instanceof HTMLTextAreaElement))return;const rt=this.DOMInputRect(),color=this.color??"white",bgColor=this.bgColor??"black",fsPx=Math.max(1,this._textData.size*app.tileSize),lhPx=Math.round(fsPx*1.25);inp.value=this.text,inp.style.position="absolute",inp.style.top=`${Math.floor(rt.y*100)/100}px`,inp.style.left=`${Math.floor(rt.x*100)/100}px`,inp.style.width=`${Math.floor(rt.w*100)/100}px`,inp.style.height=`${Math.floor(rt.h*100)/100}px`,inp.style.fontSize=`${fsPx}px`,inp.style.lineHeight=`${lhPx}px`,inp.style.fontFamily=this.fontName,inp.style.color=color,inp.style.background=bgColor,inp.style.textAlign=this.align,inp.style.border="none",inp.style.outline="none",inp.style.padding="0",inp.style.margin="0",inp.style.boxSizing="border-box",inp.style.caretColor=color,type==="textarea"?(inp.setAttribute("wrap","soft"),inp.style.whiteSpace="pre-wrap",inp.style.overflowWrap=this.wrapAtWord?"break-word":"anywhere",inp.style.wordBreak=this.wrapAtWord?"normal":"break-all",inp.style.resize="none",inp.style.overflowY="auto",this._syncTextareaVAlign(inp,rt,lhPx),inp.addEventListener("input",()=>this._syncTextareaVAlign(inp,this.DOMInputRect(),lhPx))):(inp.style.whiteSpace="nowrap",inp.style.overflow="hidden"),this._activeDOMInput=inp,canvasdiv.appendChild(inp),inp.addEventListener("focusout",()=>this.clearDOM()),inp.focus(),inp.select(),this.focus=!0}clearDOM(){if(this._activeDOMInput!=null){this.text=this._inputSanitizer?this._inputSanitizer(this._activeDOMInput.value,this):this._activeDOMInput.value;let inp=this._activeDOMInput;this._activeDOMInput=null,inp.remove(),this.focus=!1,this._needsLayout=!0;let iph=App.get().inputHandler;(iph==null?void 0:iph.grabbed)===this&&iph.ungrab()}}layoutChildren(){if(super.layoutChildren(),this._activeDOMInput!=null){let rt=this.DOMInputRect(),inp=this._activeDOMInput;if(inp.style.top=(Math.floor(rt.y*100)/100).toString()+"px",inp.style.left=(Math.floor(rt.x*100)/100).toString()+"px",inp.style.width=(Math.floor(rt.w*100)/100).toString()+"px",inp.style.height=(Math.floor(rt.h*100)/100).toString()+"px",this._activeDOMInput instanceof HTMLTextAreaElement&&this.wrap){const fsPx=parseFloat(this._activeDOMInput.style.fontSize)||16,lhPx=parseFloat(this._activeDOMInput.style.lineHeight)||Math.round(fsPx*1.25);this._syncTextareaVAlign(this._activeDOMInput,rt,lhPx)}}}}class ImageWidget extends Widget{constructor(){super();__publicField(this,"bgColor",null);__publicField(this,"outlineColor",null);__publicField(this,"src",null);__publicField(this,"lockAspect",!0);__publicField(this,"scaleToFit",!0);__publicField(this,"antiAlias",!0);__publicField(this,"angle",0);__publicField(this,"anchor","center");__publicField(this,"mirror",!1);this.image=new Image}on_src(event,object,data){this.src?this.image.src=this.src:this.image.src=""}layoutChildren(){this._layoutNotify&&this.emit("layout",null);let app=App.get();"w"in this.hints&&this.hints.w==null&&(this[2]=this.image.width/app.tileSize),"h"in this.hints&&this.hints.h==null&&(this[3]=this.image.height/app.tileSize),this._needsLayout=!1,super.layoutChildren()}draw(app,ctx){if(super.draw(app,ctx),!this.image.complete||this.image.naturalHeight==0)return;let r=this.rect;if(this.scaleToFit||(r.x+=r.w/2-this.image.width/2/app.tileSize,r.y+=r.h/2-this.image.height/2/app.tileSize,r.w=this.image.width/app.tileSize,r.h=this.image.height/app.tileSize),this.lockAspect){let srcAspect=this.image.height/this.image.width,dstAspect=r.h/r.w,rh=r.h,rw=r.w;srcAspect<dstAspect&&(rh=r.w*srcAspect),srcAspect>dstAspect&&(rw=r.h/srcAspect),r.x+=r.w/2-rw/2,r.y+=r.h/2-rh/2,r.w=rw,r.h=rh}ctx.save(),ctx.imageSmoothingEnabled=this.antiAlias;let anchor=this.anchor;anchor=="center"?anchor=[r.w/2,r.h/2]:anchor=[anchor[0]*r.w,anchor[1]*r.h],this.mirror&&ctx.scale(-1,1),ctx.translate(r.x+anchor[0],r.y+anchor[1]),this.angle!=0&&ctx.rotate(this.angle),ctx.translate(-anchor[0],-anchor[1]),ctx.drawImage(this.image,0,0,this.image.width,this.image.height,0,0,r.w,r.h),ctx.restore()}}class BoxLayout extends Widget{constructor(){super();__publicField(this,"spacingX",0);__publicField(this,"spacingY",0);__publicField(this,"paddingX",0);__publicField(this,"paddingY",0);__publicField(this,"orientation","vertical");__publicField(this,"order","forward")}*iterChildren(){if(this.order==="forward")for(let c of this._children)yield c;else for(let i=this._children.length-1;i>=0;i--)yield this._children[i]}on_numX(event,object,data){this._needsLayout=!0}on_numY(event,object,data){this._needsLayout=!0}on_spacingX(event,object,data){this._needsLayout=!0}on_spacingY(event,object,data){this._needsLayout=!0}on_paddingX(event,object,data){this._needsLayout=!0}on_paddingY(event,object,data){this._needsLayout=!0}on_orientation(event,object,data){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let spacingX=this.getMetric(this,"spacingX",this.spacingX),spacingY=this.getMetric(this,"spacingY",this.spacingY),paddingX=this.getMetric(this,"paddingX",this.paddingX),paddingY=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation==="vertical"){let num=this.children.length,h=this.h-spacingY*(num-1)-2*paddingY,w=this.w-2*paddingX,fixedh=0;for(let c of this.iterChildren())c.w=w,this.applyHints(c,w,h),"h"in c.hints&&(c.hints.h===null&&c.layoutChildren(),fixedh+=c.h,num--);let ch=(h-fixedh)/num,cw=w;this.hints.h!==null&&(num===0&&h>0||ch<0)&&(paddingY=(h-fixedh)/2);let y=this.y+paddingY,x=this.x+paddingX;for(let c of this.iterChildren())c.y=y,"w"in c.hints||(c.w=cw),"h"in c.hints||(c.h=ch),!("x"in c.hints)&&!("center_x"in c.hints)&&!("right"in c.hints)&&(c.x=x,w!==c.w&&(c.x+=(w-c.w)/2)),c.layoutChildren(),y+=spacingY+c.h;if(num===0&&"h"in this.hints&&this.hints.h===null){const oldH=this[3];this[3]=Math.max(this[0],y+2*paddingY-this.y),Math.abs(oldH-this[3])>1e-6&&(App.get()._needsLayout=!0)}return}if(this.orientation==="horizontal"){let num=this.children.length,h=this.h-2*paddingY,w=this.w-spacingX*(num-1)-2*paddingX,fixedw=0;for(let c of this.iterChildren())c.h=h,this.applyHints(c,w,h),"w"in c.hints&&(c.hints.w===null&&c.layoutChildren(),fixedw+=c.w,num--);let ch=h,cw=(w-fixedw)/num;(this.hints.w!==null&&num===0&&w>0||cw<0)&&(paddingX=(w-fixedw)/2);let y=this.y+paddingY,x=this.x+paddingX;for(let c of this.iterChildren())c.x=x,"w"in c.hints||(c.w=cw),"h"in c.hints||(c.h=ch),!("y"in c.hints)&&!("center_y"in c.hints)&&!("bottom"in c.hints)&&(c.y=y,h!==c.h&&(c.y+=(h-c.h)/2)),c.layoutChildren(),x+=spacingX+c.w;if(num==0&&"w"in this.hints&&this.hints.w==null){const oldW=this[2];this[2]=Math.max(x+2*paddingX-this.x,0),Math.abs(oldW-this[2])>1e-6&&(App.get()._needsLayout=!0)}}}}class Notebook extends Widget{constructor(){super();__publicField(this,"activePage",0)}on_wheel(event,object,wheel){const ch=this.children[this.activePage]??void 0;return!!(ch!==void 0&&ch.emit(event,wheel))}on_touch_down(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_up(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_move(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_cancel(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_activePage(e,o,v){this._needsLayout=!0}_draw(app,ctx,millis){this.draw(app,ctx);let transform=this.getTransform();if(transform){ctx.save(),ctx.transform(transform.a,transform.b,transform.c,transform.d,transform.e,transform.f);let w2=this.children[this.activePage]??void 0;w2!==void 0&&w2._draw(app,ctx,millis),ctx.restore();return}let w=this.children[this.activePage]??void 0;w!==void 0&&w._draw(app,ctx,millis)}}class TabbedNotebook extends Notebook{constructor(){super();__publicField(this,"tabHeightHint","1");__publicField(this,"tabGroupName","tabbedNotebookGroup");this.buttonBox=a(BoxLayout,{orientation:"horizontal",hints:{h:this.tabHeightHint,w:null}}),this.buttonScroller=a(ScrollView,{id:"_scrollview",hints:{h:this.tabHeightHint,w:1},children:[this.buttonBox]}),this._children=[this.buttonScroller],this.buttonScroller.parent=this,this.updateButtons()}on_tabHeightHint(e,o,v){this.buttonBox.hints.h=this.tabHeightHint}on_child_added(e,o,v){this.updateButtons()}on_child_removed(e,o,v){this.updateButtons()}on_wheel(event,object,wheel){const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,wheel))return!0;const ch=this.children[this.activePage]??void 0;return!!(ch!==void 0&&ch.emit(event,wheel))}on_touch_down(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,t))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,touch))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_up(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,t))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,touch))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_move(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,t))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,touch))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_cancel(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,t))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,touch))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}get children(){return this._children.slice(1)}set children(children){for(let c of this._children.slice(1))this.emit("child_removed",c),c.parent=null,this._needsLayout=!0,this.updateButtons();this._children=this._children.slice(0,1);for(let c of children)this.addChild(c)}updateButtons(){this.buttonBox.children=[];let i=0;for(let page of this.children){const tb=a(ToggleButton,{text:page.name??String(i+1),group:this.tabGroupName,singleSelect:!0,press:this.activePage===i,fontSize:"0.5",hints:{h:null,w:null}});tb.listen("press",(e,o,v)=>{this.activePage=this.buttonBox.children.findIndex(w=>w===o)}),this.buttonBox.addChild(tb),i++}}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;const bb=this._children[0];this.applyHints(bb),bb.x=this.x,bb.y=this.y,bb.layoutChildren();const h=this.h-bb.h,w=this.w;for(let c of this.children)c.y=this.y+bb.h,c.x=this.x,c.w=w,c.h=h,c.layoutChildren()}_draw(app,ctx,millis){this.draw(app,ctx);let transform=this.getTransform();if(transform){ctx.save(),ctx.transform(transform.a,transform.b,transform.c,transform.d,transform.e,transform.f);let bb2=this._children[0]??void 0;bb2!==void 0&&bb2._draw(app,ctx,millis);let w2=this.children[this.activePage]??void 0;w2!==void 0&&w2._draw(app,ctx,millis),ctx.restore();return}let bb=this._children[0]??void 0;bb!==void 0&&bb._draw(app,ctx,millis);let w=this.children[this.activePage]??void 0;w!==void 0&&w._draw(app,ctx,millis)}}class GridLayout extends Widget{constructor(){super();__publicField(this,"numX",1);__publicField(this,"numY",1);__publicField(this,"spacingX",0);__publicField(this,"spacingY",0);__publicField(this,"paddingX",0);__publicField(this,"paddingY",0);__publicField(this,"orientation","horizontal")}on_numX(event,object,string){this._needsLayout=!0}on_numY(event,object,string){this._needsLayout=!0}on_spacingX(event,object,string){this._needsLayout=!0}on_spacingY(event,object,string){this._needsLayout=!0}on_paddingX(event,object,string){this._needsLayout=!0}on_paddingY(event,object,string){this._needsLayout=!0}on_orientation(event,object,string){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let spacingX=this.getMetric(this,"spacingX",this.spacingX),spacingY=this.getMetric(this,"spacingY",this.spacingY),paddingX=this.getMetric(this,"paddingX",this.paddingX),paddingY=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation=="horizontal"){let numX=this.numX,numY=Math.ceil(this.children.length/this.numX),h=this.h-spacingY*(numY-1)-2*paddingY,w=this.w-spacingX*(numX-1)-2*paddingX,_colWidths=new Array(numX).fill(0),_rowHeights=new Array(numY).fill(0),r=0,c=0,i=0;for(let ch2 of this.children)this.applyHints(ch2,w,h),"w"in ch2.hints&&(_colWidths[c]=Math.max(ch2.w,_colWidths[c])),"h"in ch2.hints&&(_rowHeights[r]=Math.max(ch2.h,_rowHeights[r])),(i+1)%numX==0?(r++,c=0):c++,i++;let fixedW=0,fixedH=0,nfX=0,nfY=0;for(let cw2 of _colWidths)fixedW+=cw2,cw2>0&&nfX++;for(let rh of _rowHeights)fixedH+=rh,rh>0&&nfY++;let ch=numY>nfY?(h-fixedH)/(numY-nfY):0,cw=numX>nfX?(w-fixedW)/(numX-nfX):0,y=this.y+paddingY,x=this.x+paddingX;r=0,c=0;for(let i2=0;i2<this.children.length;i2++){let el=this.children[i2],cw0=_colWidths[c]==0?cw:_colWidths[c],ch0=_rowHeights[r]==0?ch:_rowHeights[r];"w"in el.hints||(el.w=cw0),"h"in el.hints||(el.h=ch0),el.x=x,el.y=y,el.layoutChildren(),(i2+1)%numX==0?(x=this.x+paddingX,y+=spacingY+ch0,c=0,r++):(x+=spacingX+cw0,c++)}return}else{let numX=Math.ceil(this.children.length/this.numY),numY=this.numY,h=this.h-spacingY*(numY-1)-2*paddingY,w=this.w-spacingX*(numX-1)-2*paddingX,_colWidths=new Array(numX).fill(0),_rowHeights=new Array(numY).fill(0),r=0,c=0,i=0;for(let ch2 of this.children)this.applyHints(ch2,w,h),"w"in ch2.hints&&(_colWidths[c]=Math.max(ch2.w,_colWidths[c])),"h"in ch2.hints&&(_rowHeights[r]=Math.max(ch2.h,_rowHeights[r])),(i+1)%numY==0?(c++,r=0):r++,i++;let fixedW=0,fixedH=0,nfX=0,nfY=0;for(let cw2 of _colWidths)fixedW+=cw2,cw2>0&&nfX++;for(let rh of _rowHeights)fixedH+=rh,rh>0&&nfY++;let ch=numY>nfY?(h-fixedH)/(numY-nfY):0,cw=numX>nfX?(w-fixedW)/(numX-nfX):0,y=this.y+paddingY,x=this.x+paddingX;r=0,c=0;for(let i2=0;i2<this.children.length;i2++){let el=this.children[i2],cw0=_colWidths[c]==0?cw:_colWidths[c],ch0=_rowHeights[r]==0?ch:_rowHeights[r];"w"in el.hints||(el.w=cw0),"h"in el.hints||(el.h=ch0),el.x=x,el.y=y,el.layoutChildren(),(i2+1)%numY==0?(y=this.y+paddingY,x+=spacingX+cw0,r=0,c++):(y+=spacingY+ch0,r++)}}}}class ScrollView extends Widget{constructor(){super();__publicField(this,"_scrollX",0);__publicField(this,"_scrollY",0);__publicField(this,"scrollX",0);__publicField(this,"scrollY",0);__publicField(this,"scrollW",!0);__publicField(this,"scrollH",!0);__publicField(this,"wAlign","center");__publicField(this,"hAlign","top");__publicField(this,"uiZoom",!0);__publicField(this,"uiMove",!0);__publicField(this,"zoom",1);__publicField(this,"vel",null);__publicField(this,"velCutoff",1e-5);__publicField(this,"velDecay",.95);__publicField(this,"unboundedH",!1);__publicField(this,"unboundedW",!1);__publicField(this,"_zoomCenter",null);this._processTouches=!0,this._oldTouch=null,this._lastDist=null}on_child_added(event,object,child){this.children.length==1&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0,child.listen("rect",(event2,obj,data)=>this._needsLayout=!0),child.listen("w",(event2,obj,data)=>this._needsLayout=!0),child.listen("h",(event2,obj,data)=>this._needsLayout=!0))}on_child_removed(event,object,child){this.children.length==0&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.children[0][0]=0,this.children[0][1]=0,this.scrollW||(this.children[0][2]=this.w),this.scrollH||(this.children[0][3]=this.h);for(let c of this.children)c.layoutChildren()}fitToClient(){this.zoom=Math.min(this.w/this.children[0].w,this.h/this.children[0].h),this.scrollX=.5*this.scrollableW,this.scrollY=.5*this.scrollableH}on_uiZoom(event,object,value){this._needsLayout=!0}on_hAlign(event,object,value){this._needsLayout=!0}on_vAlign(event,object,value){this._needsLayout=!0}*iter(recursive=!0,inView=!0){if(yield this,!!recursive)if(inView)for(let c of this._children)this.contains(c)&&(yield*c.iter(...arguments));else for(let c of this._children)yield*c.iter(...arguments)}on_scrollW(event,object,value){this._needsLayout=!0,this.scrollX=0}on_scrollH(event,object,value){this._needsLayout=!0,this.scrollY=0}on_scrollX(event,object,value){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedW){this._scrollX=this.scrollX;return}let align=0;switch(this.wAlign){case"center":align=.5*this.scrollableW;break;case"right":align=1*this.scrollableW}this._scrollX=this.scrollableW<=0||this.scrollableW>=this.children[0].w?align:value,this._scrollX=clamp(value,0,this.scrollableW)}on_scrollY(event,object,value){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedH){this._scrollY=this.scrollY;return}let align=0;switch(this.hAlign){case"middle":align=.5*this.scrollableH;break;case"bottom":align=1*this.scrollableH}this._scrollY=this.scrollableH<=0||this.scrollableH>=this.children[0].h?align:value,this._scrollY=clamp(value,0,this.scrollableH)}update(app,millis){if(super.update(app,millis),this.vel!==null){this.scrollX+=this.vel.x*millis,this.scrollY+=this.vel.y*millis,this.vel=this.vel.scale(this.velDecay**(millis/30));let a2=this.vel.abs();a2.x<=this.velCutoff/this.zoom&&a2.y<=this.velCutoff/this.zoom&&(this.vel=null)}}getTransform(){const ts=App.get().tileSize;return new DOMMatrix().translate(Math.floor((this.x-this._scrollX*this.zoom)*ts)/ts,Math.floor((this.y-this._scrollY*this.zoom)*ts)/ts).scale(this.zoom,this.zoom)}on_touch_down(event,object,touch){this.vel=null;let r=touch.rect;if(this._lastDist=null,this.collide(r)){let millis=Date.now(),tl=touch.asChildTouch(this);return this._oldTouch=[tl.x,tl.y,tl.identifier,millis,null],super.on_touch_down(event,object,touch)||touch.grab(this),!0}return!1}on_touch_up(event,object,touch){if(touch.grabbed!==this)return!1;if(this._oldTouch!=null){let ovel=this._oldTouch[4],tl=new Vec2([this._oldTouch[0],this._oldTouch[1]]),tln=touch.asChildTouch(this),millis=Math.max(Date.now()-this._oldTouch[3],1),vx=this.scrollableW>0||this.unboundedW?(tln.x-tl.x)/millis:0,vy=this.scrollableH>0||this.unboundedH?(tln.y-tl.y)/millis:0;this.vel=new Vec2([-vx,-vy]),ovel&&(this.vel=this.vel.add(ovel).scale(.5))}return this._oldTouch=null,this._lastDist=null,this._zoomCenter=null,touch.ungrab(),!1}on_touch_move(event,object,touch){if(touch.grabbed!==this)return!1;let r=touch.rect;if(this.collide(r)){let tl=touch.asChildTouch(this);if((this.uiMove&&touch.nativeEvent==null||touch.nativeEvent instanceof TouchEvent&&touch.nativeEvent.touches.length==1)&&this._oldTouch!=null&&touch.identifier==this._oldTouch[2]){this.scrollW&&(this.scrollX=this.scrollableW==0?0:this._scrollX+(this._oldTouch[0]-tl.x)),this.scrollH&&(this.scrollY=this.scrollableH==0?0:this._scrollY+(this._oldTouch[1]-tl.y));let tln=touch.asChildTouch(this),ot=this._oldTouch,time=Date.now(),vel=new Vec2([0,0]),ovel=new Vec2([0,0]);if(ot!=null){let millis=Math.max(time-ot[3],1),vx=this.scrollableW>0||this.unboundedW?(tln.x-tl.x)/millis:0,vy=this.scrollableH>0||this.unboundedH?(tln.y-tl.y)/millis:0;vel=new Vec2([vx,vy]),ovel=ot[4]!==null?ot[4]:ovel}let nvel=vel.abs().sum()===0?vel:vel.add(ovel).scale(.5);this._oldTouch=[tln.x,tln.y,touch.identifier,time,nvel]}if(this.uiZoom&&touch.nativeEvent&&touch.nativeEvent instanceof TouchEvent&&touch.nativeEvent.touches.length==2){let t0=touch.nativeEvent.touches[0],t1=touch.nativeEvent.touches[1],d=dist([t0.clientX,t0.clientY],[t1.clientX,t1.clientY]);if(this._lastDist!=null){let scrollPosCenterW=this._scrollX+this.w/this.zoom/2,scrollPosCenterH=this._scrollY+this.h/this.zoom/2,touchPixelPos0=[t0.clientX,t0.clientY],touchPixelPos1=[t1.clientX,t1.clientY],scrollableTouchPosBefore0=this.appToChild(touchPixelPos0),scrollableTouchPosBefore1=this.appToChild(touchPixelPos1),sTargetCenterPosBefore=[(scrollableTouchPosBefore0[0]+scrollableTouchPosBefore1[0])/2,(scrollableTouchPosBefore0[1]+scrollableTouchPosBefore1[1])/2];this._zoomCenter===null&&(this._zoomCenter=new Vec2(sTargetCenterPosBefore));let zoom=this.zoom*d/this._lastDist,minZoom=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(zoom,minZoom);let scrollableTouchPosAfter0=this.appToChild(touchPixelPos0),scrollableTouchPosAfter1=this.appToChild(touchPixelPos1),sTargetCenterPosAfter=[(scrollableTouchPosAfter0[0]+scrollableTouchPosAfter1[0])/2,(scrollableTouchPosAfter0[1]+scrollableTouchPosAfter1[1])/2];this.scrollX=scrollPosCenterW+sTargetCenterPosBefore[0]-sTargetCenterPosAfter[0]-this.w/this.zoom/2,this.scrollY=scrollPosCenterH+sTargetCenterPosBefore[1]-sTargetCenterPosAfter[1]-this.h/this.zoom/2}this._lastDist=d}}return!1}on_touch_cancel(event,object,touch){return this._lastDist=null,touch.grabbed===this?(touch.ungrab(),!0):!!super.on_touch_cancel(event,object,touch)}on_wheel(event,object,touch){let app=App.get();if(!app.inputHandler)return!0;let sx=this._scrollX+this.w/this.zoom/2,sy=this._scrollY+this.h/this.zoom/2,wheel=touch.nativeObject;if(!this.collide(touch.rect)&&(!this.unboundedW||!this.unboundedH)||!(wheel instanceof WheelEvent))return!1;if(this.uiZoom&&app.inputHandler.isKeyDown("Control")){let loc=touch.asChildTouch(this);loc.pos[0],loc.pos[1];let zoom=this.zoom*Math.exp(-wheel.deltaY/app.h),minZoom=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(zoom,minZoom);let moc=touch.asChildTouch(this);return moc.pos[0],moc.pos[1],this.scrollX=this.scrollableW==0&&!this.unboundedW?0:sx-this.w/this.zoom/2,this.scrollY=this.scrollableH==0&&!this.unboundedH?0:sy-this.h/this.zoom/2,this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}else{if(this.uiMove&&this.scrollW&&app.inputHandler.isKeyDown("Shift"))return this.scrollX+=this.scrollableW==0&&!this.unboundedW?0:this.w/this.zoom*(wheel.deltaY/app.w),this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),!0;if(this.uiMove&&this.scrollH)return this.scrollY+=this.scrollableH==0&&!this.unboundedH?0:this.h/this.zoom*(wheel.deltaY/app.h),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}return!1}get scrollableW(){return this.children.length==0?0:this.unboundedW?this.children[0].w-this.w/this.zoom:Math.max(this.children[0].w-this.w/this.zoom,0)}get scrollableH(){return this.children.length==0?0:this.unboundedH?this.children[0].h-this.h/this.zoom:Math.max(this.children[0].h-this.h/this.zoom,0)}_draw(app,ctx,millis){this.draw(app,ctx);let r=this.rect;r[0]=Math.floor(r[0]*app.tileSize*app.pixelSize)/(app.tileSize*app.pixelSize),r[1]=Math.floor(r[1]*app.tileSize*app.pixelSize)/(app.tileSize*app.pixelSize),r[2]=Math.floor(r[2]*app.tileSize*app.pixelSize)/(app.tileSize*app.pixelSize),r[3]=Math.floor(r[3]*app.tileSize*app.pixelSize)/(app.tileSize*app.pixelSize),ctx.save(),ctx.beginPath(),ctx.rect(r[0],r[1],r[2],r[3]),ctx.clip();let newT=this.getTransform();newT&&ctx.transform(newT.a,newT.b,newT.c,newT.d,newT.e,newT.f),this.children[0]._draw(app,ctx,millis),ctx.restore()}}class ModalView extends BoxLayout{constructor(){super();__publicField(this,"closeOnTouchOutside",!0);__publicField(this,"bgColor","slate");__publicField(this,"outlineColor","gray");__publicField(this,"dim",!0);__publicField(this,"dimScale",.8)}get visible(){return App.get()._modalWidgets.indexOf(this)>=0}popup(){if(this.parent==null){let app=App.get();return this.parent=app,app.addModal(this),!0}return!1}close(exitVal=0){if(this.parent!=null){this.emit("close",exitVal);let app=App.get();return this.parent=null,app.removeModal(this),!0}return!1}on_touch_down(event,object,touch){return this.closeOnTouchOutside&&!this.collide(touch.rect)?(this.close(),!0):super.on_touch_down(event,object,touch)}draw(app,ctx){if(this.dim){let r=App.get().baseWidget.rect,ctx2=App.get().ctx;if(!ctx2)return;ctx2.fillStyle="rgba(0,0,0,"+this.dimScale+")",ctx2.rect(r[0],r[1],r[2],r[3]),ctx2.fill(),super.draw(app,ctx2)}}}class LayeredAnimationFrame extends Array{constructor(frames,offsets){super();for(let i=0;i<frames.length;++i)offsets[i]?this.push(frames[i],offsets[i][0],offsets[i][1]):this.push(frames[i],0,0)}*iter(){for(let i=0;i<this.length/3;i++)yield[this[i*3],this[i*3+1],this[i*3+2]]}}class SpriteWidget extends Widget{constructor(props={}){super();__publicField(this,"spriteSheet",null);__publicField(this,"frames",[]);__publicField(this,"timePerFrame",30);__publicField(this,"timeLeft",0);__publicField(this,"activeFrame",0);__publicField(this,"id","");__publicField(this,"facing",0);__publicField(this,"flipX",!1);__publicField(this,"flipY",!1);__publicField(this,"oneShot",!1);props&&this.updateProperties(props)}update(app,millis){if(super.update(app,millis),this.timeLeft-=millis,this.timeLeft<=0){if(this.oneShot&&this.activeFrame===this.frames.length-1){this.timeLeft=1/0,this.emit("animationComplete",this.activeFrame);return}this.activeFrame++,this.activeFrame>=this.frames.length&&(this.activeFrame=0),this.timeLeft+=this.timePerFrame}this.frames.length>0&&this.timeLeft!==1/0&&app.requestFrameUpdate()}restart(){this.activeFrame=0,this.timeLeft=this.timePerFrame}on_frames(e,o,v){this.restart()}get frame(){return this.frames[this.activeFrame]??-1}draw(app,ctx){var _a;if(this.spriteSheet===null||!((_a=this.spriteSheet.sheet)!=null&&_a.complete))return;const tx=Math.floor(this.x*this.spriteSheet.spriteSize)/this.spriteSheet.spriteSize,ty=Math.floor(this.y*this.spriteSheet.spriteSize)/this.spriteSheet.spriteSize;if(ctx.translate(tx,ty),ctx.scale(this.w,this.h),this.frame instanceof LayeredAnimationFrame)for(let[f,dx,dy]of this.frame.iter())this.spriteSheet.drawIndexed(ctx,f,0,0,this.facing,this.flipX,dx,dy);else this.spriteSheet.drawIndexed(ctx,this.frame,0,0,this.facing,this.flipX);ctx.scale(1/this.w,1/this.h),ctx.translate(-tx,-ty)}}class TileMap extends Widget{constructor(props={}){super(),this.defaultValue=-1,this._data=new Grid2D,this._vLayer=null,this._aLayer=null,this._cacheTileDim=new Vec2,this.tileDim=new Vec2,this.hints={w:null,h:null},this.spriteSheet=null,this.clipRegion=null,this.alphaValue=.5,this.useCache=!0,props&&this.updateProperties(props)}serialize(){const data={};return data._data=this._data.slice(),data.tileDim=this.tileDim.slice(),data.spriteSheet=Array(...App.resources.keys()).find(k=>App.resources[k]===this.spriteSheet)??null,data}get(pos){return this._data.get(pos)}set(pos,value){this._data.set(pos,value),this._data._cacheData=null}get data(){return this._data}deserialize(data){this.tileDim=new Vec2(data.tileDim??[0,0]);const _data=data._data;for(let i=0;i<_data.length;i++)this._data[i]=_data[i];this.spriteSheet=App.resources[data.spriteSheet]??null,this._data._cacheData=null}on_tileDim(evt,obj,val){this.resizeData(),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new Vec2(this.tileDim)}resizeData(){let cacheData=[];for(let y=0;y<this._cacheTileDim[1];y++)for(let x=0;x<this._cacheTileDim[0];x++)cacheData.push(this.get([x,y]));this._data.tileDim=new Vec2(this.tileDim),this._data.length=this.tileDim[0]*this.tileDim[1],this._data.fill(this.defaultValue);let i=0;for(let y=0;y<this._cacheTileDim[1];y++)for(let x=0;x<this._cacheTileDim[0];x++)x<this.tileDim[0]&&y<this.tileDim[1]&&this.set([x,y],cacheData[i]),++i;this._data._cacheData=null}draw(app,ctx){if(super.draw(app,ctx),this.spriteSheet===null||!this.spriteSheet.sheet.complete||!this.spriteSheet.sheet.complete||this.spriteSheet.sheet.naturalHeight==0)return;let[x0,y0]=[0,0],[x1,y1]=this.tileDim;if(this.clipRegion&&([x0,y0]=this.clipRegion.pos,[x1,y1]=this.clipRegion.pos.add(this.clipRegion.size).add([1,1]),x0=Math.min(Math.max(x0,0),this.tileDim[0]),x1=Math.min(Math.max(x1,0),this.tileDim[0]),y0=Math.min(Math.max(y0,0),this.tileDim[1]),y1=Math.min(Math.max(y1,0),this.tileDim[1])),Math.floor(this.spriteSheet.sheet.width/this.spriteSheet.spriteSize),Math.floor(this.spriteSheet.sheet.height/this.spriteSheet.spriteSize),this.useCache){if(this._data._cacheData===null&&this.cacheCanvas(),this._data._cacheData===null)return;const s=this.spriteSheet.spriteSize;if(ctx.drawImage(this._data._cacheData,s*x0,s*y0,s*(x1-x0),s*(y1-y0),this.x+x0,this.y+y0,x1-x0,y1-y0),this._aLayer===null&&this._vLayer===null)for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=this._data[p];ind<-1&&this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y)}else if(this._aLayer&&this._vLayer){const aL=this._aLayer,vL=this._vLayer,origAlpha=ctx.globalAlpha,dat=this._data;for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=dat[p];ind<-1&&vL[p]>0&&(aL[p]===0?(ctx.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y),ctx.globalAlpha=origAlpha):this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y))}}}else if(this._aLayer===null&&this._vLayer===null)for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=this._data[p];this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y)}else if(this._aLayer&&this._vLayer){const aL=this._aLayer,vL=this._vLayer,origAlpha=ctx.globalAlpha,dat=this._data;for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=dat[p];ind!==-1&&vL[p]>0&&(aL[p]===0?(ctx.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y),ctx.globalAlpha=origAlpha):this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y))}}}clearCache(){this.data._cacheData=null}cacheCanvas(){if(this._data._cacheData=null,!this.spriteSheet||!this.spriteSheet.sheet||this.tileDim[0]<=0||this.tileDim[1]<=0)return;const _cacheData=new OffscreenCanvas(this.tileDim[0]*this.spriteSheet.spriteSize,this.tileDim[1]*this.spriteSheet.spriteSize),cacheCtx=_cacheData.getContext("2d");if(!cacheCtx)return;cacheCtx.scale(this.spriteSheet.spriteSize,this.spriteSheet.spriteSize);let[x0,y0]=[0,0],[x1,y1]=this.tileDim;if(this._aLayer===null&&this._vLayer===null)for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=this._data[p];ind>=0&&this.spriteSheet.drawIndexed(cacheCtx,ind,x,y)}else if(this._aLayer&&this._vLayer){const aL=this._aLayer,vL=this._vLayer,origAlpha=cacheCtx.globalAlpha,dat=this._data;for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=dat[p];ind>=0&&vL[p]>0&&(aL[p]===0?(cacheCtx.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(cacheCtx,ind,x,y),cacheCtx.globalAlpha=origAlpha):this.spriteSheet.drawIndexed(cacheCtx,ind,x,y))}}this._data._cacheData=_cacheData}}class LayeredTileMap extends TileMap{constructor(props={}){super(),this._layerData=[this._data],this.numLayers=1,this.activeLayer=0,this.visibilityLayer=-1,this.alphaLayer=-1,props&&this.updateProperties(props)}on_alphaLayer(e,o,v){this._aLayer=this.alphaLayer>=0?this._layerData[this.alphaLayer]:null}on_visibilityLayer(e,o,v){this._vLayer=this.visibilityLayer>=0?this._layerData[this.visibilityLayer]:null}serialize(){const data={},layerCopy=[];for(let l of this._layerData)layerCopy.push(l.slice());return data._layerData=layerCopy,data.activeLayer=this.activeLayer,data.numLayers=this.numLayers,data.tileDim=this.tileDim.slice(),data.spriteSheet=Array(...App.resources.keys()).find(k=>App.resources[k]===this.spriteSheet)??null,data}deserialize(data){this.numLayers=data.numLayers,this.activeLayer=data.activeLayer,this.tileDim=new Vec2(data.tileDim??[0,0]);const n=data._layerData.length;this._layerData.length=n;for(let i=0;i<n;i++){const lout=this._layerData[i],lin=data._layerData[i];for(let j=0;j<lin.lenth;j++)lout[j]=lin[j]}this.spriteSheet=App.resources[data.spriteSheet]??null,this.clearCache()}on_tileDim(evt,obj,val){if("_layerData"in this){for(let l of this._layerData)this._data=l,this.resizeData();this.activeLayer>=0&&(this._data=this._layerData[this.activeLayer]),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new Vec2(this.tileDim)}}on_numLayers(evt,obj,val){const oldLen=this._layerData.length;this._layerData.length=this.numLayers;for(let i=oldLen;i<this.numLayers;i++){const layer=new Grid2D(this.tileDim).fill(this.defaultValue);this._layerData[i]=layer}this.activeLayer>=this.numLayers&&(this.activeLayer=this.numLayers-1)}on_activeLayer(evt,obj,val){this._data=this._layerData[this.activeLayer]}get layer(){return this._layerData}getFromLayer(layer,pos){return this._layerData[layer][pos[0]+pos[1]*this.tileDim[0]]}setInLayer(layer,pos,val){this._layerData[layer][pos[0]+pos[1]*this.tileDim[0]]=val,this._layerData[layer]._cacheData=null}clearCache(){for(let l of this._layerData)l._cacheData=null}draw(app,ctx){for(let l of this._layerData)l.hidden||(this._data=l,super.draw(app,ctx));this._data=this._layerData[this.activeLayer]}}App.registerClass("Widget",Widget,"");App.registerClass("App",App,"");App.registerClass("Label",Label,"");App.registerClass("Button",Button,"");App.registerClass("ToggleButton",ToggleButton,"");App.registerClass("BasicButton",BasicButton,"");App.registerClass("TextInput",TextInput,"");App.registerClass("CheckBox",CheckBox,"");App.registerClass("Slider",Slider,"");App.registerClass("ImageWidget",ImageWidget,"");App.registerClass("BoxLayout",BoxLayout,"");App.registerClass("GridLayout",GridLayout,"");App.registerClass("ScrollView",ScrollView,"");App.registerClass("ModalView",ModalView,"");App.registerClass("Notebook",Notebook,"");App.registerClass("TabbedNotebook",TabbedNotebook,"");App.registerClass("SpriteWidget",SpriteWidget,"");App.registerClass("TileMap",TileMap,"");App.registerClass("LayeredTileMap",LayeredTileMap,"");export{App as A,BoxLayout as B,CheckBox as C,ImageWidget as I,Label as L,Notebook as N,ScrollView as S,TextInput as T,Widget as W,Button as a,WidgetAnimation as b,Slider as c};
