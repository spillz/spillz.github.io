import{A as App,B as BoxLayout,L as Label,S as ScrollView,T as TextInput,I as ImageWidget,a as Button}from"./eskv-BvQgZPp6.js";const BOOK_PREFIX="books/",AUTOSAVE_MS=400,PAGE_PREVIEW_CHARS=30;class BookStorage{static keyForTitle(title){return BOOK_PREFIX+encodeURIComponent(title)}static list(){var _a;const out=[];for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(!(!k||!k.startsWith(BOOK_PREFIX)))try{const b=JSON.parse(localStorage.getItem(k));out.push({key:k,title:(b==null?void 0:b.title)||decodeURIComponent(k.slice(BOOK_PREFIX.length)),author:(b==null?void 0:b.author)||"",updatedAt:(b==null?void 0:b.updatedAt)||"",cover:((_a=b==null?void 0:b.cover)==null?void 0:_a.src)||""})}catch{}}return out.sort((a,b)=>(b.updatedAt||"").localeCompare(a.updatedAt||"")),out}static loadByKey(key){try{const s=localStorage.getItem(key);return s?JSON.parse(s):null}catch{return null}}static saveByKey(key,book){try{localStorage.setItem(key,JSON.stringify(book))}catch(e){alert("Save failed: "+e)}}static deleteByKey(key){try{localStorage.removeItem(key)}catch{}}}class BookMakerApp{constructor(){this.app=App.a({}),this.mode="library",this.booksList=[],this.book=null,this.currentKey=null,this.pageIndex=0,this.dirty=!1,this.autosaveTimer=0,this.dom=this.ensureHiddenInputs(),this.buildUI(),this.app.start(),this.refreshLibrary(),this.switchToLibrary()}nowIso(){return new Date().toISOString()}debounceSave(){clearTimeout(this.autosaveTimer),this.autosaveTimer=setTimeout(()=>this.autosave(),AUTOSAVE_MS)}markDirty(){this.dirty=!0,this.updateHeaderStatus(),this.debounceSave()}fileToDataURL(file){return new Promise((res,rej)=>{const fr=new FileReader;fr.onload=()=>res(fr.result),fr.onerror=rej,fr.readAsDataURL(file)})}snippet(text,max=PAGE_PREVIEW_CHARS){if(!text)return"(empty)";let t=String(text).replace(/\s+/g," ").trim();const m=t.match(/.*?[.!?â€¦](?:\s|$)/);if(m&&(t=m[0].trim()),t.length<=max)return t;let cut=t.lastIndexOf(" ",max-1);return cut<Math.floor(max*.6)&&(cut=max-1),t.slice(0,cut).trimEnd()+"â€¦"}ensureHiddenInputs(){let wrap=document.getElementById("hidden-inputs");wrap||(wrap=document.createElement("div"),wrap.id="hidden-inputs",wrap.style.position="fixed",wrap.style.inset="0",wrap.style.pointerEvents="none",document.body.appendChild(wrap));const mk=(id,accept)=>{let el=document.getElementById(id);return el||(el=document.createElement("input"),el.id=id,el.type="file",el.accept=accept,el.style.position="absolute",el.style.opacity="0",wrap.appendChild(el)),el},cover=mk("file-cover","image/*"),page=mk("file-page","image/*"),imp=mk("file-import",".json,application/json");return cover.addEventListener("change",e=>this.onPickCover(e)),page.addEventListener("change",e=>this.onPickPageImage(e)),imp.addEventListener("change",e=>this.onImportFile(e)),{cover,page,import:imp}}emptyBook(){return{schema:"eskv.book.v1",title:"Untitled Book",author:"",createdAt:this.nowIso(),updatedAt:this.nowIso(),cover:null,pages:[{text:"Tap to edit this page text. Add images via Upload or URL.",image:null}]}}autosave(){if(!this.book)return;const newKey=BookStorage.keyForTitle(this.book.title);this.book.updatedAt=this.nowIso(),!this.currentKey||this.currentKey===newKey?(BookStorage.saveByKey(newKey,this.book),this.currentKey=newKey):(BookStorage.deleteByKey(this.currentKey),BookStorage.saveByKey(newKey,this.book),this.currentKey=newKey),this.dirty=!1,this.refreshLibrary(),this.updateHeaderStatus()}refreshLibrary(){this.booksList=BookStorage.list(),this.libRows.children=[];let y=0;for(const b of this.booksList)this.libRows.addChild(this.makeLibraryRow(b,y)),y+=.12;this.libEmpty.text=this.booksList.length?"":"No books yet. Create or import one."}buildUI(){this.header=BoxLayout.a({orientation:"horizontal",spacingX:.03,hints:{x:0,y:0,w:1,h:"2"},children:[this.btn("New","#2f4b6b",()=>this.onNew(),{w:.12,h:1}),this.btn("Libary","#2f4b6b",()=>this.onOpenLibrary(),{w:.16,h:1}),this.btn("Import","#354e6a",()=>{this.dom.import.value="",this.dom.import.click()},{w:.12,h:1}),this.btn("Export","#354e6a",()=>this.onExport(),{w:.12,h:1}),this.btn("Delete Book","#5a2a2a",()=>this.onDeleteCurrent(),{w:.16,h:1},"#fff"),this.modeLbl=Label.a({text:"Library",align:"left",color:"#e2efff",hints:{w:.16,h:1}}),this.statLbl=Label.a({text:"",align:"right",color:"#98a6bd",hints:{w:.16,h:1}})]}),this.libraryView=ScrollView.a({id:"libraryView",wAlign:"left",scrollW:!1,hints:{x:0,y:.12,w:1,h:.88},children:[BoxLayout.a({orientation:"vertical",hints:{w:1,h:null}}).c(this.libEmpty=Label.a({id:"libEmpty",text:"",align:"center",color:"#98a6bd",hints:{x:.05,y:.05,w:.9,h:"3"}})).c(this.libRows=BoxLayout.a({id:"libRows",hints:{x:0,y:.2,w:1,h:null}}))]}),this.editorView=BoxLayout.a({id:"editorView",orientation:"horizontal",spacingX:.03,hints:{x:0,y:1.2,w:1,h:0},children:[ScrollView.a({wAlign:"left",scrollW:!1,hints:{w:.3,h:.96}}).c(this.pageList=BoxLayout.a({id:"pageList",orientation:"vertical",hints:{w:1,h:null}})),BoxLayout.a({orientation:"vertical",spacingX:.02,hints:{w:.4,h:.96},children:[this.pageNum=Label.a({id:"pageNum",text:"Page 1 / 1",align:"left",color:"#9fb4c9",hints:{w:1,h:.06}}),this.pageText=TextInput.a({id:"pageText",text:"",wrap:!0,bgColor:"#1c2b3d",color:"#e2efff",hints:{w:1,h:.54},on_text:(e,o,t)=>(this.book&&(this.book.pages[this.pageIndex].text=t,this.markDirty()),!1)}),this.pageImg=ImageWidget.a({id:"pageImg",src:"",outlineColor:"#333",hints:{w:1,h:.26}}),BoxLayout.a({orientation:"horizontal",hints:{w:1,h:.14},children:[this.btn("Upload Image","#2d3e52",()=>{this.dom.page.value="",this.dom.page.click()},{w:.34,h:1}),this.pageUrlIn=TextInput.a({id:"pageUrlIn",text:"",bgColor:"#24344a",color:"#e2efff",hints:{w:.46,h:1}}),this.btn("Set URL","#2d3e52",()=>{if(!this.book)return;const u=(this.pageUrlIn.text||"").trim();u&&(this.book.pages[this.pageIndex].image={src:u},this.pageImg.src=u,this.markDirty())},{w:.2,h:1})]}),BoxLayout.a({orientation:"horizontal",hints:{w:1,h:.1},children:[this.btn("+ Add Page","#2f4b6b",()=>this.onAddPage(),{w:.49,h:"1"}),this.btn("+ from ðŸ“‹","#2f4b6b",()=>this.onAddPagesFromClipboard(),{w:.49,h:"1"})]})]}),BoxLayout.a({orientation:"vertical",hints:{w:.22,h:.96},children:[Label.a({text:"Title",align:"left",color:"#9fb4c9",hints:{w:1,h:.06}}),this.titleIn=TextInput.a({id:"titleIn",text:"",bgColor:"#24344a",color:"#e2efff",hints:{w:1,h:.08},on_text:(e,o,t)=>(!this.book||this.book.title===t||(this.book.title=t,this.markDirty()),!1)}),Label.a({text:"Author",align:"left",color:"#9fb4c9",hints:{w:1,h:.06}}),this.authorIn=TextInput.a({id:"authorIn",text:"",bgColor:"#24344a",color:"#e2efff",hints:{w:1,h:.08},on_text:(e,o,t)=>(this.book&&(this.book.author=t,this.markDirty()),!1)}),this.coverImg=ImageWidget.a({id:"coverImg",src:"",outlineColor:"#333",hints:{w:1,h:.4}}),BoxLayout.a({orientation:"horizontal",hints:{w:1,h:.12},children:[this.btn("Upload Cover","#2d3e52",()=>{this.dom.cover.value="",this.dom.cover.click()},{w:.6,h:1}),this.btn("âœ•","#5a2a2a",()=>{this.book&&(this.book.cover=null,this.coverImg.src="",this.markDirty())},{w:.16,h:1},"#fff")]}),this.coverUrlIn=TextInput.a({id:"coverUrlIn",text:"",bgColor:"#24344a",color:"#e2efff",hints:{w:1,h:.08}}),this.btn("Set Cover URL","#2d3e52",()=>{if(!this.book)return;const u=(this.coverUrlIn.text||"").trim();u&&(this.book.cover={src:u},this.coverImg.src=u,this.markDirty())},{w:1,h:.1})]})]}),this.app.baseWidget.children=[this.header,this.libraryView,this.editorView]}btn(text,bg,handler,hints,color){return Button.a({text,align:"center",bgColor:bg,color:color||"#e2efff",hints:hints||{w:.12,h:1}}).b("press",handler)}makeLibraryRow(b,y){return BoxLayout.a({orientation:"horizontal",hints:{w:1,h:"1"},children:[ImageWidget.a({src:b.cover||"",hints:{w:"1wh",h:"1"}}),Label.a({text:`${b.title}
${b.author||""}`,align:"left",color:"#e2efff",hints:{h:"1"}}),this.btn("Open","#24415e",()=>this.openBook(b.title),{w:.12,h:"1"}),this.btn("Export","#2c3c4f",()=>this.exportByKey(b.key),{w:.12,h:"1"}),this.btn("Delete","#5a2a2a",()=>{confirm(`Delete "${b.title}"?`)&&(BookStorage.deleteByKey(b.key),this.refreshLibrary())},{w:.12,h:"1"},"#fff"),Label.a({text:b.updatedAt?new Date(b.updatedAt).toLocaleString():"",align:"right",color:"#98a6bd",hints:{w:.2,h:"1"}})]})}switchToLibrary(){this.mode="library",this.libraryView.hints={x:0,y:.12,w:1,h:.88},this.editorView.hints={x:0,y:1.2,w:1,h:0},this.updateHeaderStatus(),this.app.baseWidget._needsLayout=!0}switchToEditor(){this.mode="editor",this.libraryView.hints={x:0,y:1.2,w:1,h:0},this.editorView.hints={x:0,y:.12,w:1,h:.88},this.updateHeaderStatus(),this.app.baseWidget._needsLayout=!0}updateHeaderStatus(){this.modeLbl.text=this.mode==="editor"&&this.book?`Editing: ${this.book.title}`:"Library",this.mode==="editor"&&this.book?this.statLbl.text=this.dirty?"Unsavedâ€¦":`Saved â€¢ ${new Date(this.book.updatedAt||Date.now()).toLocaleTimeString()}`:this.statLbl.text="",this.app.baseWidget._needsLayout=!0}renderEditor(){var _a;this.titleIn.text=this.book.title||"",this.authorIn.text=this.book.author||"",this.coverImg.src=((_a=this.book.cover)==null?void 0:_a.src)||"",this.pageList.children=[];for(let i=0;i<this.book.pages.length;i++)this.pageList.addChild(this.pageRow(i,this.book.pages[i]));this.showPage(this.pageIndex||0),this.updateHeaderStatus()}pageRow(i,page){var _a;return BoxLayout.a({orientation:"horizontal",hints:{w:1,h:"1"},children:[Label.a({text:`${i+1}.`,align:"right",color:"#9fb4c9",hints:{w:.1,h:"1"}}),ImageWidget.a({src:((_a=page.image)==null?void 0:_a.src)||"",hints:{w:"1h",h:"1"}}),Label.a({text:this.snippet(page.text,PAGE_PREVIEW_CHARS),align:"left",color:"#e2efff",hints:{h:"1"},on_touch_down:(e,o,t)=>{if(o.collide(t.rect))return this.showPage(i),!0}}),this.btn("â†‘","#2d3e52",()=>this.movePage(i,-1),{w:.08,h:1}),this.btn("â†“","#2d3e52",()=>this.movePage(i,1),{w:.08,h:1}),this.btn("âœ•","#5a2a2a",()=>this.deletePage(i),{w:.08,h:1},"#fff"),this.btn("Open","#24415e",()=>this.showPage(i),{w:.1,h:1})]})}showPage(i){var _a;this.pageIndex=Math.max(0,Math.min(this.book.pages.length-1,i));const p=this.book.pages[this.pageIndex];this.pageNum.text=`Page ${this.pageIndex+1} / ${this.book.pages.length}`,this.pageText.text=p.text||"",this.pageImg.src=((_a=p.image)==null?void 0:_a.src)||""}onAddPage(){this.book.pages.push({text:"",image:null}),this.markDirty(),this.renderEditor(),this.showPage(this.book.pages.length-1)}splitTextIntoPageChunks(text,maxLen=200){if(!text)return[];const normalized=text.replace(/\r\n/g,`
`).replace(/\r/g,`
`).trim(),rawBlocks=(/\n{2,}/.test(normalized)?normalized.split(/\n{2,}/):normalized.split(/\n/)).map(s=>s.trim()).filter(s=>s.length>0),out=[];for(const block of rawBlocks){if(block.length<=maxLen){out.push(block);continue}const sentences=block.match(/[^.!?â€¦]+[.!?â€¦]+(?:["')\]]+)?|\S+$/g)||[block];let current="";const flush=()=>{current.trim()&&out.push(current.trim()),current=""};for(let s of sentences){if(s=s.trim(),!s)continue;const pushLongSentenceInChunks=longS=>{const words=longS.split(/\s+/);let buf="";for(const w of words){const candidate2=buf?buf+" "+w:w;if(candidate2.length>maxLen)if(buf)out.push(buf),buf=w;else{out.push(w.slice(0,maxLen));const rest=w.slice(maxLen);rest&&pushLongSentenceInChunks(rest),buf=""}else buf=candidate2}buf&&out.push(buf)};if(s.length>maxLen){flush(),pushLongSentenceInChunks(s);continue}const candidate=current?current+" "+s:s;candidate.length>maxLen?(flush(),current=s):current=candidate}flush()}return out}async onAddPagesFromClipboard(){if(!this.book){alert("Open or create a book first.");return}let text="";try{text=await navigator.clipboard.readText()}catch(err){alert(`Could not read clipboard. Your browser may block clipboard access on this page.
`+err);return}if(text=(text||"").trim(),!text){alert("Clipboard is empty.");return}const startIdx=this.book.pages.length,chunks=this.splitTextIntoPageChunks(text,200);if(chunks.length===0){alert("No text found to add as pages.");return}for(const t of chunks)this.book.pages.push({text:t,image:null});this.markDirty(),this.renderEditor(),this.showPage(startIdx)}deletePage(i){if(this.book.pages.length<=1){alert("A book must have at least one page.");return}this.book.pages.splice(i,1),this.pageIndex>=this.book.pages.length&&(this.pageIndex=this.book.pages.length-1),this.markDirty(),this.renderEditor(),this.showPage(this.pageIndex)}movePage(i,dir){const j=i+dir;if(j<0||j>=this.book.pages.length)return;const[pg]=this.book.pages.splice(i,1);this.book.pages.splice(j,0,pg),this.pageIndex=j,this.markDirty(),this.renderEditor()}onNew(){this.book=this.emptyBook(),this.currentKey=BookStorage.keyForTitle(this.book.title),BookStorage.saveByKey(this.currentKey,this.book),this.pageIndex=0,this.dirty=!1,this.refreshLibrary(),this.renderEditor(),this.switchToEditor()}onOpenLibrary(){this.switchToLibrary(),this.refreshLibrary()}onExport(){if(!this.book){alert("Open a book first.");return}const blob=new Blob([JSON.stringify(this.book,null,2)],{type:"application/json"}),a=document.createElement("a"),title=(this.book.title||"book").replace(/[\\/:*?"<>|]/g,"_");a.href=URL.createObjectURL(blob),a.download=`${title}.eskvbook.json`,document.body.appendChild(a),a.click(),a.remove(),setTimeout(()=>URL.revokeObjectURL(a.href),0)}onDeleteCurrent(){this.book&&confirm(`Delete "${this.book.title}" from this device?`)&&(BookStorage.deleteByKey(this.currentKey),this.book=null,this.currentKey=null,this.pageIndex=0,this.switchToLibrary(),this.refreshLibrary())}exportByKey(k){const b=BookStorage.loadByKey(k);if(!b){alert("Nothing to export.");return}const blob=new Blob([JSON.stringify(b,null,2)],{type:"application/json"}),a=document.createElement("a"),title=(b.title||"book").replace(/[\\/:*?"<>|]/g,"_");a.href=URL.createObjectURL(blob),a.download=`${title}.eskvbook.json`,document.body.appendChild(a),a.click(),a.remove(),setTimeout(()=>URL.revokeObjectURL(a.href),0)}openBook(title){const k=BookStorage.keyForTitle(title),b=BookStorage.loadByKey(k);if(!b||!Array.isArray(b.pages)){alert("Book not found or invalid.");return}this.book=b,this.currentKey=k,this.pageIndex=0,this.dirty=!1,this.renderEditor(),this.switchToEditor()}async onPickCover(e){var _a;const f=(_a=e.target.files)==null?void 0:_a[0];if(e.target.value="",!f||!this.book)return;const dataUrl=await this.fileToDataURL(f);this.book.cover={src:dataUrl},this.coverImg.src=dataUrl,this.markDirty()}async onPickPageImage(e){var _a;const f=(_a=e.target.files)==null?void 0:_a[0];if(e.target.value="",!f||!this.book)return;const dataUrl=await this.fileToDataURL(f);this.book.pages[this.pageIndex].image={src:dataUrl},this.pageImg.src=dataUrl,this.markDirty()}async onImportFile(e){var _a;const f=(_a=e.target.files)==null?void 0:_a[0];if(e.target.value="",!!f)try{const txt=await f.text(),obj=JSON.parse(txt);if(!obj||obj.schema!=="eskv.book.v1"||!Array.isArray(obj.pages))throw new Error("Invalid schema");let title=obj.title||"Imported Book",key=BookStorage.keyForTitle(title),n=1;for(;localStorage.getItem(key);)title=`${obj.title||"Imported Book"} (${n++})`,key=BookStorage.keyForTitle(title);obj.title=decodeURIComponent(key.slice(BOOK_PREFIX.length)),obj.createdAt=obj.createdAt||this.nowIso(),obj.updatedAt=this.nowIso(),BookStorage.saveByKey(key,obj),this.refreshLibrary(),this.openBook(obj.title)}catch(err){alert("Import failed: "+err)}}}new BookMakerApp;
