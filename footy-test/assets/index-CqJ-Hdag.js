var ae=Object.defineProperty;var At=h=>{throw TypeError(h)};var le=(h,t,e)=>t in h?ae(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var m=(h,t,e)=>le(h,typeof t!="symbol"?t+"":t,e),ce=(h,t,e)=>t.has(h)||At("Cannot "+e);var Ft=(h,t,e)=>t.has(h)?At("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(h):t.set(h,e);var it=(h,t,e)=>(ce(h,t,"access private method"),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();var mt=1e-6,X=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var h=0,t=arguments.length;t--;)h+=arguments[t]*arguments[t];return Math.sqrt(h)});function U(){var h=new X(16);return X!=Float32Array&&(h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[11]=0,h[12]=0,h[13]=0,h[14]=0),h[0]=1,h[5]=1,h[10]=1,h[15]=1,h}function Gt(h){return h[0]=1,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=1,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=1,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h}function q(h,t,e){var i=e[0],s=e[1],n=e[2],r,o,a,l,c,u,f,d,p,g,S,b;return t===h?(h[12]=t[0]*i+t[4]*s+t[8]*n+t[12],h[13]=t[1]*i+t[5]*s+t[9]*n+t[13],h[14]=t[2]*i+t[6]*s+t[10]*n+t[14],h[15]=t[3]*i+t[7]*s+t[11]*n+t[15]):(r=t[0],o=t[1],a=t[2],l=t[3],c=t[4],u=t[5],f=t[6],d=t[7],p=t[8],g=t[9],S=t[10],b=t[11],h[0]=r,h[1]=o,h[2]=a,h[3]=l,h[4]=c,h[5]=u,h[6]=f,h[7]=d,h[8]=p,h[9]=g,h[10]=S,h[11]=b,h[12]=r*i+c*s+p*n+t[12],h[13]=o*i+u*s+g*n+t[13],h[14]=a*i+f*s+S*n+t[14],h[15]=l*i+d*s+b*n+t[15]),h}function ht(h,t,e){var i=e[0],s=e[1],n=e[2];return h[0]=t[0]*i,h[1]=t[1]*i,h[2]=t[2]*i,h[3]=t[3]*i,h[4]=t[4]*s,h[5]=t[5]*s,h[6]=t[6]*s,h[7]=t[7]*s,h[8]=t[8]*n,h[9]=t[9]*n,h[10]=t[10]*n,h[11]=t[11]*n,h[12]=t[12],h[13]=t[13],h[14]=t[14],h[15]=t[15],h}function qt(h,t,e){var i=Math.sin(e),s=Math.cos(e),n=t[4],r=t[5],o=t[6],a=t[7],l=t[8],c=t[9],u=t[10],f=t[11];return t!==h&&(h[0]=t[0],h[1]=t[1],h[2]=t[2],h[3]=t[3],h[12]=t[12],h[13]=t[13],h[14]=t[14],h[15]=t[15]),h[4]=n*s+l*i,h[5]=r*s+c*i,h[6]=o*s+u*i,h[7]=a*s+f*i,h[8]=l*s-n*i,h[9]=c*s-r*i,h[10]=u*s-o*i,h[11]=f*s-a*i,h}function ue(h,t,e,i,s){var n=1/Math.tan(t/2),r;return h[0]=n/e,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=n,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[11]=-1,h[12]=0,h[13]=0,h[15]=0,s!=null&&s!==1/0?(r=1/(i-s),h[10]=(s+i)*r,h[14]=2*s*i*r):(h[10]=-1,h[14]=-2*i),h}var de=ue;function fe(h,t,e,i){var s,n,r,o,a,l,c,u,f,d,p=t[0],g=t[1],S=t[2],b=i[0],y=i[1],w=i[2],v=e[0],_=e[1],M=e[2];return Math.abs(p-v)<mt&&Math.abs(g-_)<mt&&Math.abs(S-M)<mt?Gt(h):(c=p-v,u=g-_,f=S-M,d=1/Math.hypot(c,u,f),c*=d,u*=d,f*=d,s=y*f-w*u,n=w*c-b*f,r=b*u-y*c,d=Math.hypot(s,n,r),d?(d=1/d,s*=d,n*=d,r*=d):(s=0,n=0,r=0),o=u*r-f*n,a=f*s-c*r,l=c*n-u*s,d=Math.hypot(o,a,l),d?(d=1/d,o*=d,a*=d,l*=d):(o=0,a=0,l=0),h[0]=s,h[1]=o,h[2]=c,h[3]=0,h[4]=n,h[5]=a,h[6]=u,h[7]=0,h[8]=r,h[9]=l,h[10]=f,h[11]=0,h[12]=-(s*p+n*g+r*S),h[13]=-(o*p+a*g+l*S),h[14]=-(c*p+u*g+f*S),h[15]=1,h)}function wt(){var h=new X(3);return X!=Float32Array&&(h[0]=0,h[1]=0,h[2]=0),h}function Pt(h,t,e){var i=new X(3);return i[0]=h,i[1]=t,i[2]=e,i}function Dt(h,t,e){return h[0]=t[0]+e[0],h[1]=t[1]+e[1],h[2]=t[2]+e[2],h}function me(h,t){var e=t[0]-h[0],i=t[1]-h[1],s=t[2]-h[2];return e*e+i*i+s*s}(function(){var h=wt();return function(t,e,i,s,n,r){var o,a;for(e||(e=3),i||(i=0),s?a=Math.min(s*e+i,t.length):a=t.length,o=i;o<a;o+=e)h[0]=t[o],h[1]=t[o+1],h[2]=t[o+2],n(h,h,r),t[o]=h[0],t[o+1]=h[1],t[o+2]=h[2];return t}})();function pe(){var h=new X(2);return X!=Float32Array&&(h[0]=0,h[1]=0),h}function ye(h,t){var e=new X(2);return e[0]=h,e[1]=t,e}function _e(h,t,e){return h[0]=t[0]+e[0],h[1]=t[1]+e[1],h}(function(){var h=pe();return function(t,e,i,s,n,r){var o,a;for(e||(e=2),i||(i=0),s?a=Math.min(s*e+i,t.length):a=t.length,o=i;o<a;o+=e)h[0]=t[o],h[1]=t[o+1],n(h,h,r),t[o]=h[0],t[o+1]=h[1];return t}})();class O extends Float32Array{constructor(t=0,e=0,i=0){super(3),this[0]=t,this[1]=e,this[2]=i}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}set x(t){this[0]=t}set y(t){this[1]=t}set z(t){this[2]=t}get c(){return new O(this[0],this[1],this[2])}zeroX(){return this[0]=0,this}zeroY(){return this[1]=0,this}zeroZ(){return this[2]=0,this}setFrom(t,e,i){return this[0]=t,this[1]=e,this[2]=i,this}add(t){return this[0]+=t[0],this[1]+=t[1],this[2]+=t[2],this}sub(t){return this[0]-=t[0],this[1]-=t[1],this[2]-=t[2],this}scale(t){return this[0]*=t,this[1]*=t,this[2]*=t,this}scaleAndAdd(t,e){return this[0]+=t[0]*e,this[1]+=t[1]*e,this[2]+=t[2]*e,this}normalize(){const t=Math.hypot(this[0],this[1],this[2]);return t>0?this.scale(1/t):this.setFrom(0,0,0)}dot(t){return this[0]*t[0]+this[1]*t[1]+this[2]*t[2]}cross(t){return new O(this[1]*t[2]-this[2]*t[1],this[2]*t[0]-this[0]*t[2],this[0]*t[1]-this[1]*t[0])}lenSq(){return this[0]**2+this[1]**2+this[2]**2}len(){return Math.hypot(this[0],this[1],this[2])}dist(t){return Math.hypot(this[0]-t[0],this[1]-t[1],this[2]-t[2])}copyFrom(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this}toArray(){return[this[0],this[1],this[2]]}static fromArray(t){return new O(t[0],t[1],t[2])}static direction(t,e){return new O(e[0]-t[0],e[1]-t[1],e[2]-t[2]).normalize()}lerp(t,e){return this[0]+=(t[0]-this[0])*e,this[1]+=(t[1]-this[1])*e,this[2]+=(t[2]-this[2])*e,this}lerpEased(t,e,i){const s=i?i(e):e;return this[0]+=(t[0]-this[0])*s,this[1]+=(t[1]-this[1])*s,this[2]+=(t[2]-this[2])*s,this}get xz(){return new nt(this[0],this[2])}get xy(){return new nt(this[0],this[1])}get yz(){return new nt(this[1],this[2])}toDir(t){return this.sub(t).normalize()}moveTo(t,e,i=!1){const s=t[0]-this[0],n=t[1]-this[1],r=t[2]-this[2],o=Math.hypot(s,n,r);if(o<1e-5)return this;const a=i?e/o:Math.min(1,e/o);return this[0]+=s*a,this[1]+=n*a,this[2]+=r*a,this}moveDir(t,e){const i=t[0],s=t[1],n=t[2],r=Math.hypot(i,s,n);return r<1e-5?this:(this[0]+=i*e/r,this[1]+=s*e/r,this[2]+=n*e/r,this)}}let nt=class rt extends Float32Array{constructor(t=0,e=0){super(2),this[0]=t,this[1]=e}get x(){return this[0]}get y(){return this[1]}set x(t){this[0]=t}set y(t){this[1]=t}get c(){return new rt(this[0],this[1])}set(t,e){return this[0]=t,this[1]=e,this}add(t){return this[0]+=t[0],this[1]+=t[1],this}sub(t){return this[0]-=t[0],this[1]-=t[1],this}scale(t){return this[0]*=t,this[1]*=t,this}normalize(){const t=Math.hypot(this[0],this[1]);return t>0?this.scale(1/t):this.set(0,0)}dot(t){return this[0]*t[0]+this[1]*t[1]}lenSq(){return this[0]**2+this[1]**2}len(){return Math.sqrt(this.lenSq())}dist(t){return Math.hypot(this[0]-t[0],this[1]-t[1])}copyFrom(t){return this[0]=t[0],this[1]=t[1],this}toArray(){return[this[0],this[1]]}static fromArray(t){return new rt(t[0],t[1])}static direction(t,e){return new rt(e[0]-t[0],e[1]-t[1]).normalize()}lerp(t,e){return this[0]+=(t[0]-this[0])*e,this[1]+=(t[1]-this[1])*e,this}lerpEased(t,e,i=void 0){const s=i?i(e):e;return this[0]+=(t[0]-this[0])*s,this[1]+=(t[1]-this[1])*s,this[2]+=(t[2]-this[2])*s,this}toDir(t){return this.sub(t).normalize()}moveTo(t,e,i=!1){const s=t[0]-this[0],n=t[1]-this[1],r=Math.hypot(s,n);if(r<1e-5)return this;const o=i?e/r:Math.min(1,e/r);return this[0]+=s*o,this[1]+=n*o,this}moveDir(t,e){const i=t[0],s=t[1],n=Math.hypot(i,s);return n<1e-5?this:(this[0]+=i*e/n,this[1]+=s*e/n,this)}};const F=(h=0,t=0,e=0)=>new O(h,t,e),be=(h=0,t=0)=>new nt(h,t),we=160,C=170,gt=we/2,j=C/2,Y=6,ot=6,kt=.5,ge=Object.freeze({home:[0,0,0],away:[0,0,C]}),ve=Object.freeze([F(-.5*Y-ot,0,C),F(-.5*Y,0,C),F(.5*Y,0,C),F(.5*Y+ot,0,C)]),Te=Object.freeze([F(-.5*Y-ot,0,0),F(-.5*Y,0,0),F(.5*Y,0,0),F(.5*Y+ot,0,0)]),Se=Object.freeze({Away:ve,Home:Te});function Rt(h){const t=h[0]/gt,e=(h[2]-j)/j;return t*t+e*e>1}function xe(h,t,e,i,s,n){const r=s-e,o=n-i;if(r===0&&o===0){const p=h-e,g=t-i;return p*p+g*g}const a=((h-e)*r+(t-i)*o)/(r*r+o*o),l=Math.max(0,Math.min(1,a)),c=e+l*r,u=i+l*o,f=h-c,d=t-u;return f*f+d*d}function Me(h,t){const e=Rt(h),i=Rt(t);for(const s of["Away","Home"]){const n=Se[s];if(i&&!e){if(s==="Away"){if(h[2]>C-10){const o=t[0];if(o>=-3&&o<=3)return"goalAway";if(o>=-9&&o<-3||o>3&&o<=9)return"behindAway"}}else if(s==="Home"&&h[2]<10){const o=t[0];if(o>=-3&&o<=3)return"goalHome";if(o>=-9&&o<-3||o>3&&o<=9)return"behindHome"}}const r=["outerLeftPost","innerLeftPost","innerRightPost","outerRightPost"];for(let o=0;o<n.length;o++){const a=n[o][0],l=n[o][2];if(xe(a,l,h[0],h[2],t[0],t[2])<kt*kt)return`${r[o]}${s}`}}return!e&&i?"outOfBounds":null}function Et(h=!1){const e={fullForward:70,halfForward:35,halfBack:-35,fullBack:-70},i={LFP:-45,FF:0,RFP:45,LHF:-50,CHF:0,RHF:50,LHB:-50,CHB:0,RHB:50,LBP:-45,FB:0,RBP:45};function s(a,l){const c=a*Math.PI/180,u=gt*Math.sin(c)*(Math.abs(l)/j)-(h?2:-2),f=j+l*(h?-1:1);return F(u,0,f)}const n=-gt-4,r=a=>j+(h?1:-1)*a;return{LFP:s(i.LFP,e.fullForward-(h?10:-10)),FF:s(i.FF,e.fullForward),RFP:s(i.RFP,e.fullForward-(h?10:-10)),LHF:s(i.LHF,e.halfForward),CHF:s(i.CHF,e.halfForward),RHF:s(i.RHF,e.halfForward),LW:F(-25,0,j-(h?2:-2)),C:F(8,0,j-(h?-5:5)),RW:F(25,0,j-(h?2:-2)),LHB:s(i.LHB,e.halfBack),CHB:s(i.CHB,e.halfBack),RHB:s(i.RHB,e.halfBack),LBP:s(i.LBP,e.fullBack-(h?10:-10)),FB:s(i.FB,e.fullBack),RBP:s(i.RBP,e.fullBack-(h?10:-10)),Ruck:F(0,0,j-(h?10:-10)),RR:F(-10,0,j-(h?10:-10)),Rover:F(10,0,j-(h?10:-10)),Bench1:F(n,0,r(10)),Bench2:F(n,0,r(13)),Bench3:F(n,0,r(16)),Bench4:F(n,0,r(19)),Bench5:F(n,0,r(22))}}function Ae(h,t,e){let i=null,s=1/0;for(const n of t)if(n.team!==h.team){const r=n.pos.dist(e);r<s&&(s=r,i=n)}return i}class Fe{constructor(t,e,i){this.game=t,this.kicker=e,this.markPos=i.c,this.timer=0,this.finished=!1}update(t){this.timer+=t}enforce(t,e){return!1}cleanup(){}}class at extends Fe{constructor(t,e,i){super(t,e,i),this.defender=null,this.zone={center:F(0,0,0),radius:1},this.game=t,t=this.game,e=this.kicker;const s=e.team==="home"?0:C,n=F(0,0,s),r=i.c.sub(n).zeroY().normalize(),o=15,a=i.c,l=i.c;e.pos.copyFrom(l),e.jogVel.copyFrom(r).scale(e.jogSpeed),e.joltVel.setFrom(0,0,0),t.ball.carrier!==e&&t.ball.pickup(e),e.team==="home"&&(this.game.player=e),e.stateTimer=o/e.jogSpeed,this.defender=Ae(e,t.players,i),this.defender&&(this.defender.pos.copyFrom(a),this.defender.vel.setFrom(0,0,0),this.defender.jogVel.setFrom(0,0,0),this.defender.joltVel.setFrom(0,0,0),this.defender.actionState="standingMark",this.defender.stateTimer=10)}update(t){super.update(t);const{kicker:e,markPos:i,game:s}=this,n=!s.ball.carried,r=e.pos.c.sub(i);r[1]=0;const o=e.team==="home"?0:C,a=F(0,0,o).sub(i).zeroY().normalize(),l=r.dot(a),c=F(-a[2],0,a[0]),u=r.dot(c),f=l>.05||u>2;(n||f)&&(this.finished=!0)}enforce(t,e){const{kicker:i,defender:s,markPos:n}=this,r=i.pos,o=n.c.lerp(r,.5),a=n.dist(r)/2+5,l=t.pos.dist(o);if(t===s)return t.pos.copyFrom(s.pos),t.vel.setFrom(0,0,0),t.jogVel.setFrom(0,0,0),t.joltVel.setFrom(0,0,0),!1;if(l<a&&t!==i&&t!==s){const c=t.pos.dist(o),u=a-c;if(u>0){const f=t.pos.c.sub(o);f[1]=0,f.len()<.001?f.setFrom(Math.random()-.5,0,Math.random()-.5).normalize():f.normalize();const p=u<2?u*10:u*20;return t.joltVel.scaleAndAdd(f,p*e),t.pos.scaleAndAdd(t.joltVel,e),!0}}return!1}}function St(h){let t=BigInt(h)&0xFFFFFFFFFFFFFFFFn;return function(){t=t+0x9E3779B97F4A7C15n&0xFFFFFFFFFFFFFFFFn;let i=t;return i=(i^i>>30n)*0xBF58476D1CE4E5B9n&0xFFFFFFFFFFFFFFFFn,i=(i^i>>27n)*0x94D049BB133111EBn&0xFFFFFFFFFFFFFFFFn,i=i^i>>31n,i}}class et{constructor(){m(this,"_seed",0)}random(){return Math.random()}seed(t){throw new Error("Seeding is not available in the default PRNG class. You can set another with `eskv.rand.setPRNG`.")}getRandomInt(t,e=0){return e!=0?t+Math.floor(this.random()*(e-t)):Math.floor(this.random()*t)}getRandomPos(t,e){return[this.getRandomInt(t),this.getRandomInt(e)]}randomRange(t=0,e=1){return Math.floor(this.random()*(e-t+1))+t}randomFloat(t=0,e=1){return this.random()*(e-t)+t}shuffle(t){let e,i;for(let s=1;s<t.length;s++)i=this.randomRange(0,s),e=t[s],t[s]=t[i],t[i]=e;return t}choose(t){return t[Math.floor(this.random()*t.length)]}chooseN(t,e){let i=new Array(e),s=t.length,n=new Array(s);if(e>s)throw new RangeError("chooeN: more elements requested than available");for(;e--;){let r=Math.floor(this.random()*s);i[e]=t[r in n?n[r]:r],n[r]=--s in n?n[s]:s}return i}}function Lt(h,t,e,i){return function(){h>>>=0,t>>>=0,e>>>=0,i>>>=0;var s=h+t|0;return h=t^t>>>9,t=e+(e<<3)|0,e=e<<21|e>>>11,i=i+1|0,s=s+i|0,e=e+s|0,(s>>>0)/4294967296}}function Ct(h){return function(){var t=h+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function zt(h,t,e,i){return function(){var s=t<<9,n=t*5;return n=(n<<7|n>>>25)*9,e^=h,i^=t,t^=e,h^=i,e^=s,i=i<<11|i>>>21,(n>>>0)/4294967296}}function Bt(h,t,e,i){return function(){h|=0,t|=0,e|=0,i|=0;var s=h-(t<<27|t>>>5)|0;return h=t^(e<<17|e>>>15),t=e+i|0,e=i+s|0,i=h+s|0,(i>>>0)/4294967296}}class Zt extends et{constructor(){super(...arguments);m(this,"_seed",1);m(this,"d",3735928559);m(this,"xorSeed",Math.floor(Date.now())^this.d);m(this,"random",Lt(2654435769,608135816,3084996962,this.xorSeed))}seed(e){this._seed=e,this.xorSeed=e^this.d;const i=St(this.xorSeed);this.random=Lt(i(),i(),i(),i())}}class Pe extends et{constructor(){super(...arguments);m(this,"_seed",1);m(this,"d",3735928559);m(this,"xorSeed",Math.floor(Date.now())^this.d);m(this,"random",Ct(this.xorSeed))}seed(e){this._seed=e,this.xorSeed=e^this.d,this.random=Ct(this.xorSeed)}}class De extends et{constructor(){super(...arguments);m(this,"_seed",1);m(this,"d",3735928559);m(this,"xorSeed",Math.floor(Date.now())^this.d);m(this,"random",zt(2654435769,608135816,3084996962,this.xorSeed))}seed(e){this._seed=e,this.xorSeed=e^this.d;const i=St(this.xorSeed);this.random=zt(i(),i(),i(),i())}}class ke extends et{constructor(){super(...arguments);m(this,"_seed",1);m(this,"d",3735928559);m(this,"xorSeed",Math.floor(Date.now())^this.d);m(this,"random",Bt(2654435769,608135816,3084996962,this.xorSeed))}seed(e){this._seed=e,this.xorSeed=e^this.d;const i=St(this.xorSeed);this.random=Bt(i(),i(),i(),i())}}var W=new Zt;function Re(h){switch(h){case"Math.random":W=new et;return;case"sfc32":W=new Zt;return;case"mulberry32":W=new Pe;return;case"xoshiro128ss":W=new De;return;case"jsf32":W=new ke;return;default:throw Error(`Unknown PRNG ${h}`)}}function Q(h,t=0){return W.getRandomInt(h,t)}function Ee(h,t){return W.getRandomPos(h,t)}function Le(h=0,t=1){return W.randomFloat(h,t)}function Ce(h){return W.choose(h)}function ze(h){return W.seed(h)}function Be(h){let t=5381;for(let e=0;e<h.length;e++)t=(t<<5)+t+h.charCodeAt(e),t=t&4294967295;return t>>>0}function Ie(h,t){const[e,i]=h.collideBounds(),[s,n]=t.collideBounds(),r=h.pos[0]-t.pos[0],o=h.pos[2]-t.pos[2],a=r*r+o*o,l=.5*e,c=.5*s,u=l+c,f=h.pos[1],d=h.pos[1]+i,p=t.pos[1],g=t.pos[1]+n,S=f<g&&d>p;return a<=u*u&&S}function It(h){const t=h.collideBounds()[0]||1;return h.intent==="shepherd"||h.intent==="block"?t*1.4:h.intent==="crumb"||h.intent==="hangBack"?t*.8:t}function Ht(h){switch(h){case"mark":return 1.3;case"block":return 1.4;case"spoil":return 1.1;case"shepherd":return 1.25;case"contestAnyway":return 1;case"crumb":return .7;case"hangBack":return .5;default:return 1}}class xt{constructor(t){this.pos=F(t[0],t[1],t[2]),this.vel=F(0,0,0),this.width=1.6,this.height=2.4,this.usesGravity=!0,this.gravity=F(0,-9.8,0),this.bounce=0,this.floorY=0}setupForBoundary(t,e){}update(t,e){this.usesGravity&&this.vel.scaleAndAdd(this.gravity,t),this.pos.scaleAndAdd(this.vel,t),this.pos[1]<this.floorY&&(this.pos[1]=this.floorY,Math.abs(this.vel[1])>.5?this.vel[1]=-this.vel[1]*this.bounce:this.vel[1]=0)}render(t){t.renderSprite(this.pos,this.width,this.height,1,0)}collidesWith(t){return Ie(this,t)}collideBounds(){return[.5,1.8]}}const Vt={home:Object.freeze({idle:[[0,0,0]],run:[[1,0,0],[2,0,0],[3,0,0],[4,0,0],[5,0,0],[6,0,0]],kickRightFoot:[[1,0,0],[2,0,0]],kickLeftFoot:[[4,0,0],[5,0,0]],handpassRightHand:[[1,0,0],[0,0,0]],handpassLeftHand:[[4,0,0],[0,0,0]],jumpMark:[[1,0,0],[2,0,0],[0,0,0]],jumpSpoil:[[1,0,0],[2,0,0],[0,0,0]]}),away:Object.freeze({idle:[[0,4,0]],run:[[1,4,0],[2,4,0],[3,4,0],[4,4,0],[5,4,0],[6,4,0]],kickRightFoot:[[1,4,0],[2,4,0]],kickLeftFoot:[[4,4,0],[5,4,0]],handpassRightHand:[[1,4,0],[0,4,0]],handpassLeftHand:[[4,4,0],[0,4,0]],jumpMark:[[1,4,0],[2,4,0],[0,4,0]],jumpSpoil:[[1,4,0],[2,4,0],[0,4,0]]})},pt=Object.freeze({ruddy:{front:[0,12,0],back:[0,13,0],headCount:4,bodyRowOffset:9},pasty:{front:[0,14,0],back:[0,15,0],headCount:3,bodyRowOffset:10},swarthy:{front:[0,16,0],back:[0,17,0],headCount:3,bodyRowOffset:11}}),He=Object.freeze({home:{front:[0,5,0],back:[0,6,0]},away:{front:[0,7,0],back:[0,8,0]}}),Ve=Object.freeze({idle:[[0,0,0]],run:[[1,0,0],[2,0,0],[3,0,0],[4,0,0],[5,0,0],[6,0,0]],kickRightFoot:[[1,0,0],[2,0,0]],kickLeftFoot:[[4,0,0],[5,0,0]],handpassRightHand:[[1,0,0],[0,0,0]],handpassLeftHand:[[4,0,0],[0,0,0]],jumpMark:[[1,0,0],[2,0,0],[0,0,0]],jumpSpoil:[[1,0,0],[2,0,0],[0,0,0]]});class je extends xt{constructor(t,e,i,s,n=!1){super(s),this.intent="idle",this.intentTarget=null,this.positionPos=O.fromArray(s),this.teamId=i,this.complexion=Ce(["ruddy","pasty","swarthy"]),this.faceId=Q(pt[this.complexion].headCount),this.name=t,this.team=e,this.playing=n,this.width=1.6,this.height=2.4,this.aiming=!1,this.jogVel=F(0,0,0),this.joltVel=F(0,0,0),this.jogSpeed=5,this.joltSpeed=2,this.energy=10,this.energyRecovery=0,this.statsWeight=85+Math.random()*10,this.statsStrength=50+Math.random()*30,this.statsSpeed=10+Math.random()*5,this.statsJump=10,this.statsKickRange=45,this.statsHandpassRange=20,this.statsAgility=10,this.joltDecayRate=8,this.animations=Vt[e]??Vt.home,this.animState="idle",this.actionState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=8,this.stateTimer=0,this.animSprite=[[0,0,0]]}updateAI(t,e){const s=e.ball;let n=null;if(s.carried&&s.carrier===this)if(this.stateTimer+=t,this.stateTimer<1)n="run";else{let o=!1;for(const d of e.players)if(!(d===this||d.team===this.team)&&d.pos.dist(this.pos)<7){o=!0;break}const a=e.players.filter(d=>d.team===this.team&&d!==this);if(o){let d=null,p=-1/0;const g=F(0,0,this.team==="home"?-1:1);for(const S of a){if(S===this)continue;const b=this.pos.dist(S.pos);if(b>40)continue;let y=!1;for(const P of e.players)if(P.team!==this.team&&P.pos.dist(S.pos)<5){y=!0;break}if(y)continue;const w=this.pos.c.toDir(S.pos),v=g.c.dot(w),_=O.fromArray(S.vel);_[1]=0;const M=g.dot(_),T=Math.abs(b-15)*.2,A=15*v+2*M-T;A>p&&(p=A,d=S)}if(d){const S=d.pos.c.sub(this.pos),b=[S[0],S[2]];return this.tryDisposeBall(e,{kickReleased:!0,kickHeldTime:S.len()>20?.5:.1,aimTarget:b})??"run"}}const c=this.team==="home"?-5:C+5,u=0;if(Math.abs(this.pos[2]-c)<=this.statsKickRange){const d=F(u+(Math.random()-.5)*9,0,c).sub(this.pos),p=[d[0],d[2]];return this.tryDisposeBall(e,{kickReleased:!0,kickHeldTime:.4,aimTarget:p})??"run"}if(o||this.stateTimer>5){let d=null,p=-1/0;for(const g of a){const S=this.pos.dist(g.pos);if(S>this.statsKickRange)continue;const b=this.team==="home"?-1:1,y=(g.pos[2]-this.pos[2])*b,w=Math.abs(g.pos[0]-this.pos[0]),v=y-w-S;v>p&&(p=v,d=g)}if(d){const g=d.pos.c.sub(this.pos),S=[g[0],g[2]];return this.tryDisposeBall(e,{kickReleased:!0,kickHeldTime:.4,aimTarget:S})??"run"}}n="run"}let r=null;if(s.carried&&s.carrier===this){const o=this.team==="home"?-1:1,a=F(0,0,o);let l=F(0,0,0);for(const u of e.players){if(u===this||u.team===this.team)continue;const f=this.pos.c.sub(u.pos);f[1]=0;const d=f.len();if(d<5&&d>.5){const p=1/d;l.scaleAndAdd(f.normalize(),p)}}const c=a.c.add(l).normalize();r=this.pos.c.scaleAndAdd(c,10)}else if(s.carried)if(s.carrier&&s.carrier.team!==this.team&&e.chasers<3&&e.closestPlayers[this.team]===this||s.pos.dist(this.pos)<=15&&this.energy>0)r=s.pos.c,e.chasers++;else if(s.carrier&&s.carrier.team===this.team&&s.pos[2]>20&&s.pos[2]<C-20&&s.pos.dist(this.pos)<10&&this.energy>.3&&e.followers<3){e.followers++;const o=s.carrier.jogVel.c;o.len()<.01&&(o[2]=this.team==="home"?-1:1),o.normalize();const a=F(-o[2],0,o[0]).normalize();let l=0,c=12;switch(this.name){case"wing":l=12*(this.team==="home"?-1:1),c=15;break;case"forward":l=6,c=18;break;case"half-forward":case"half-back":l=4,c=10;break;case"center":case"mid":l=0,c=10;break;case"back":default:l=-6,c=8;break}r=s.carrier.pos.c.scaleAndAdd(o,c).scaleAndAdd(a,l)}else r=this.positionPos??this.pos;else if(s.pos[1]>.1||s.vel[1]>.1){const o=s.gravity[1]??-9.8,a=s.vel[1],l=s.pos[1],c=.5*o,u=a,f=l;let d=0;const p=u*u-4*c*f;if(p>=0&&Math.abs(c)>1e-5){const S=Math.sqrt(p),b=(-u+S)/(2*c),y=(-u-S)/(2*c);d=Math.max(b,y)}const g=s.pos.c.scaleAndAdd(s.vel,d);g[1]=0,g.dist(this.pos)<=35?r=g:r=this.positionPos??this.pos}else s.pos.dist(this.pos)<=25&&e.chasers<3?(r=s.pos,e.chasers++):r=this.positionPos??this.pos;if(r===this.positionPos&&this.positionPos.dist(this.pos)<=1&&(n="idle",this.actionState!=="idle"&&(this.stateTimer=0),this.jogVel.setFrom(0,0,0),this.joltVel.setFrom(0,0,0)),r===null&&n===null&&(r=ge[this.team]),r&&n!=="idle"){const o=r.c.sub(this.pos).zeroY().normalize();if(o.len()>1e-4){this.joltVel.copyFrom(o).scale(this.joltSpeed);const a=this.jogVel.c.normalize();this.jogVel.len()>1e-4?(a.lerp(o,10*t).normalize(),this.jogVel.copyFrom(a).scale(this.jogSpeed)):this.jogVel.copyFrom(o).scale(this.jogSpeed)}}if(this.energy>0&&this.actionState!=="idle"?(this.vel.copyFrom(this.jogVel).add(this.joltVel),this.energy-=t):(this.vel.copyFrom(this.jogVel).scaleAndAdd(this.joltVel,.5),this.energyRecovery+=t,this.energyRecovery>=10&&(this.energy=10,this.energyRecovery=0)),this.joltVel.scale(Math.exp(-this.joltDecayRate*t)),this.checkPlayerCollisions(t,e),super.update(t,e),n===null&&(n=this.tryTackle(e)),!s.carried&&s.collidesWith(this)&&n===null){const o=s.lastTouchedType==="kick"&&!s.hasBounced&&s.lastTouchedBy!==this&&s.pos.dist(s.origin)>=15;return s.pickup(this),o?(e.setPiece=new at(e,this,this.pos.c),n="freeKick"):n="pickup",this.team==="home"&&(e.player=this,this.aiming=!1),n}return n||(n=this.vel.len()>1e-4?"run":"idle"),n}collideBounds(){return[.8,1.8]}get stunned(){return this.actionState==="tackle"||this.actionState==="tackled"}tryTackle(t){const e=t.ball;for(const i of t.players){if(i===this||!e.carried||e.carrier!==i||i.team===this.team||!this.collidesWith(i)||i.actionState==="tackleDisposal"||i.actionState==="freeKick")continue;const s=i.pos.c.sub(this.pos);s[1]=0,s.normalize();const n=1e-8,r=this.jogVel.c;if(r[1]=0,r.len()<n||r.c.normalize().dot(s)>.1)return this.stateTimer=1,i.actionState="tackleDisposal",i.stateTimer=.5,"tackle"}return null}updateHuman(t,e){const i=e.controls,s=e.ball;let{kickPressed:n,kickReleased:r,kickHeldTime:o,moveX:a,moveZ:l,aimTarget:c}=i.state;const u=1e-4;let f=null;if((a!==0||l!==0)&&!this.aiming){const d=F(a,0,l).normalize();if(F(a,0,l),d.len()>u){this.joltVel.copyFrom(d).scale(this.joltSpeed);const p=this.jogVel.c.normalize();this.jogVel.len()>u?(p.lerp(d,10*t).normalize(),this.jogVel.copyFrom(p).scale(this.jogSpeed)):this.jogVel.copyFrom(d).scale(this.jogSpeed)}}if(this.energy>0?(this.vel.copyFrom(this.jogVel).add(this.joltVel),this.energy-=t):(this.vel.copyFrom(this.jogVel).scaleAndAdd(this.joltVel,.5),this.energyRecovery+=t,this.energyRecovery>=10&&(this.energy=10,this.energyRecovery=0)),this.joltVel.scale(Math.exp(-this.joltDecayRate*t)),this.checkPlayerCollisions(t,e),super.update(t,e),s.carried&&s.carrier!==this&&n&&(f=this.tryTackle(e)),!s.carried&&s.collidesWith(this)&&f===null){const d=s.lastTouchedType==="kick"&&!s.hasBounced&&s.lastTouchedBy!==this&&s.pos.dist(s.origin)>=15;return s.pickup(this),d?(e.setPiece=new at(e,this,this.pos.c),f="freeKick"):f="pickup",this.team==="home"&&(e.player=this,this.aiming=!1),f}if(s.carried&&s.carrier===this&&f===null){if(n&&(this.aiming=!0,this.jogVel.len()<1e-5)){const d=F(0,0,this.team==="home"?0:C).sub(this.pos).normalize();this.jogVel.copyFrom(d).scale(this.jogSpeed)}f=this.tryDisposeBall(e,{kickReleased:i.state.kickReleased,kickHeldTime:i.state.kickHeldTime,aimTarget:i.state.aimTarget,moveVec:a!==0||l!==0?F(a,0,l):O.fromArray(this.jogVel)}),s.carried||(this.aiming=!1)}return this.updateAim(e),!f&&this.actionState!=="run"&&this.actionState!=="idle"&&(f=this.vel.len()>u?"run":"idle"),f}tryDisposeBall(t,e){const i=t.ball;if(!i.carried||i.carrier!==this)return null;const{kickReleased:s,kickHeldTime:n}=e;let{aimTarget:r}=e;if(!s)return null;const o=n<.25;if(o){const y=e.moveVec??this.jogVel.c;if(y.len()===0){const _=this.team==="home"?-1:1;y.setFrom(0,0,_)}y.normalize;let w=null,v=-1/0;for(const _ of t.players){if(_.team!==this.team||_===this||_.stunned)continue;const M=_.pos.c.sub(this.pos),T=M.len();if(T>30)continue;const A=M.c.normalize(),P=y.dot(A);if(P<=0)continue;let k=0;for(const z of t.players){if(z.team===this.team||z===_||z.stunned)continue;z.pos.dist(_.pos)<=10&&k++}const R=.5*k,E=P*2-T/30-R;E>v&&(v=E,w=_)}if(w){const _=w.pos.c.sub(this.pos);r=[_[0],_[2]]}else r=[y[0]*10,y[2]*10]}if(!r)return null;const a=be(r[0],r[1]),l=a.len();if(l<.1)return null;const c=-this.gravity[1],u=(o?20:30)*Math.PI/180,f=Math.sin(2*u),d=Math.sqrt(l*c/f),p=F(a[0],0,a[1]).normalize(),g=F(p[0]*Math.cos(u),Math.sin(u),p[2]*Math.cos(u));return i.launch(g,d),i.lastTouchedType=o?"handpass":"kick",i.hasBounced=!1,this.stateTimer=.5,o?"handpass":"kick"}update(t,e){this.oldPos=this.pos.c;let i=!1;if(e.setPiece&&(i=e.setPiece.enforce(this,t)),e.ball.carried||(this.aiming=!1),!this.playing)return;if(this.actionState==="pickup"&&(this.actionState="run"),this.actionState==="freeKick"){this.stateTimer-=t,this.stateTimer<=0?(this.actionState="idle",this.stateTimer=0,this.jogVel[0]=0,this.jogVel[2]=0,e.setPiece):(e.setPiece===null||e.controls.state.moveX!==0||e.controls.state.moveZ!==0)&&(this.actionState="idle",this.stateTimer=0),this.vel.copyFrom(this.jogVel),super.update(t,e),this.updateAim(e),this.updateAnimation(t,null,e.ball);return}if(this.actionState==="standingMark"){this.stateTimer-=t,this.stateTimer<=0?(this.actionState="idle",this.stateTimer=0,this.jogVel[0]=0,this.jogVel[1]=0,e.setPiece):e.setPiece===null&&(this.actionState="idle",this.stateTimer=0),this.updateAim(e),this.updateAnimation(t,null,e.ball);return}if(this.actionState==="tackleDisposal"){if(this.stateTimer-=t,this.pos.scaleAndAdd(this.jogVel,t),e.player===this&&e.controls.state.kickReleased&&(this.tryDisposeBall(e,e.controls.state),this.actionState="handpass",this.stateTimer=.5),e.player!==this){const n=.5-this.stateTimer,r=.5+(this.statsStrength-50)*.01,o=n/r*(.5+(this.statsStrength-50)/100);Math.random()<o*t*2&&this.tryDisposeBall(e,{kickReleased:!0,kickHeldTime:.1,aimTarget:null,moveVec:F(0,0,0)})}if(this.stateTimer<=0){const n=e.ball;n.carried=!1,n.carrier=null,n.pos.copyFrom(this.pos),n.vel.copyFrom(this.vel.len()>.5?this.vel:F(Math.random()*2-1,0,Math.random()*2-1).normalize().scale(this.jogSpeed+this.joltSpeed)),n.lastTouchedType="spill",n.hasBounced=!1,this.actionState="tackled",this.stateTimer=1}this.updateAim(e),this.updateAnimation(t,null,e.ball);return}if(this.actionState==="tackled"||this.actionState==="tackle"||this.actionState==="kick"||this.actionState==="handpass"){this.actionState==="tackled"&&this.vel.scale(.8),this.stateTimer-=t,this.stateTimer<=0&&(this.actionState="idle",this.stateTimer=0),this.aiming&&(this.aiming=!1),super.update(t,e),this.updateAim(e),this.updateAnimation(t,null,e.ball);return}let s=null;i||(e.player===this?s=this.updateHuman(t,e):s=this.updateAI(t,e)),this.updateAnimation(t,s,e.ball),s!==null&&(this.actionState=s)}updateAim(t){if(this===t.player){const i=t.controls.state.aimTarget;if(this.aiming){const s=ye(0,0);i&&_e(s,s,i),t.aimTarget.setPosition([this.pos[0]+s[0],.02,this.pos[2]+s[1]])}else t.player===this&&t.aimTarget.setPosition(F(this.pos[0],.02,this.pos[2]+.8))}}updateAnimation(t,e,i){const s=this.animations[this.animState];if(s.length===0)return;this.animTimer+=t;const n=1/this.animFPS;this.animTimer>=n&&(this.animTimer-=n,this.animFrame=this.animFrame+1),e==="kick"&&(this.animState="kickRightFoot",this.animFrame=0,this.animTimer=0),this.animState==="run"&&this.vel.len()===0&&(this.animState="idle",this.animFrame=0,this.animTimer=0),this.animState==="idle"&&this.vel.len()!==0&&(this.animState="run",this.animFrame=0,this.animTimer=0);const r=this.animState==="run"||this.animState==="idle";this.animFrame>=s.length&&(this.animFrame=r?0:s.length-1,r||(this.animState="run",this.animFrame=0,this.animTimer=0));const o=He.home.back.slice();o[0]+=this.teamId,this.team==="away"&&(o[1]+=2);const a=pt[this.complexion].back.slice();a[0]+=this.faceId;const l=Ve[this.animState][this.animFrame].slice()??[0,0,0];l[1]+=pt[this.complexion].bodyRowOffset,(this.vel[2]>0?"away":this.vel[2]<0?"home":this.pos[2]<i.pos[2]?"away":"home")==="away"&&(l[0]+=7,o[1]-=1,a[1]-=1),this.animSprite=[o,a,l]}render(t){const e=F(0,.005,.01);let i=1;for(let[s,n,r]of this.animSprite)t.renderSprite(this.pos.c.scaleAndAdd(e,i),this.width,this.height,s,n),i++}renderOrig(t){const[e,i,s]=this.animSprite;t.renderSprite(this.pos,this.width,this.height,e,i)}checkPlayerCollisions(t,e){if(this.actionState!=="freeKick")for(const i of e.players){if(i===this||!i.playing||i.actionState==="freeKick")continue;const s=this.pos.c.sub(i.pos);s[1]=0;const n=s.len(),r=It(this),o=It(i),l=(r+o)/2-n;if(l<=0)continue;n<1e-4?(s[0]=Math.random()-.5,s[2]=Math.random()-.5,s.normalize()):s.scale(1/n);const c=this.statsWeight*Ht(this.intent),u=i.statsWeight*Ht(i.intent),f=c+u,d=s.c.scale(l),p=d.c.scale(u/f),g=d.c.scale(c/f);this.pos[0]+=p[0],this.pos[2]+=p[2],i.pos[0]-=g[0],i.pos[2]-=g[2]}}setupForBoundary(t,e){t==="behindAway"&&this.team==="home"&&this.name==="FB"?(this.pos.setFrom(0,0,C-5),this.jogVel.setFrom(0,0,0),this.joltVel.setFrom(0,0,0),this.actionState="idle",this.stateTimer=0):t==="behindAway"&&this.team==="away"&&this.name==="FF"?this.pos.setFrom(0,0,C-25):t==="behindHome"&&this.team==="away"&&this.name==="FB"?(this.pos.setFrom(0,0,5),this.jogVel.setFrom(0,0,0),this.joltVel.setFrom(0,0,0),this.actionState="idle",this.stateTimer=0):t==="behindHome"&&this.team==="home"&&this.name==="FF"?this.pos.setFrom(0,0,25):this.pos.copyFrom(this.positionPos)}}class Ue extends xt{constructor(t){super(t),this.carried=!1,this.origin=F(0,0,0),this.carrier=null,this.width=1.6,this.height=2.4,this.bounce=.5,this.animations=Object.freeze({idle:[[0,1,0]],backSpin:[[1,1,0],[2,1,0],[3,1,0],[4,1,0],[5,1,0],[6,1,0],[7,1,0],[8,1,0]],forwardSpin:[[8,1,0],[7,1,0],[6,1,0],[5,1,0],[4,1,0],[3,1,0],[2,1,0],[1,1,0]],backSpinRight:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]],backSpinLeft:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinRight:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinLeft:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]]}),this.animState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=12,this.lastTouchedBy=null,this.lastTouchedType=null,this.hasBounced=!1}update(t,e){if(this.carried&&this.carrier){const i=this.carrier,s=i.vel[2]>0?1:i.vel[2]<0||i.team==="home"?-1:1,n=F(0,.5,.2*s);this.pos.copyFrom(this.carrier.pos).add(n),this.origin.copyFrom(this.pos)}else{const i=this.vel[1]<0;super.update(t,e),this.hasBounced=this.hasBounced||i&&this.vel[1]>0&&this.pos[1]<=this.floorY,this.pos[1]<=this.floorY&&(this.vel.scale(.97),this.origin.copyFrom(this.pos))}this.updateAnimation(t)}collideBounds(){return[.4,.5]}pickup(t){this.carried=!0,this.carrier=t,this.lastTouchedBy=t,this.lastTouchedType=null,this.hasBounced=!1,this.origin.copyFrom(this.pos);const e=t.vel[2]>0?1:t.vel[2]<0||t.team==="home"?-1:1;this.pos.copyFrom(t.pos).add(F(0,0,e*.2)),this.vel.setFrom(0,0,0)}launch(t,e,i="kick"){this.carried=!1,this.carrier=null,this.vel.copyFrom(t).scale(e),this.lastTouchedType=i,this.hasBounced=!1}updateAnimation(t){this.animTimer+=t;const e=1/this.animFPS;this.animTimer>=e&&(this.animTimer-=e,this.animFrame=this.animFrame+1);const i=this.animState;this.carried?this.animState="idle":this.lastTouchedType==="kick"&&!this.hasBounced?this.animState=this.vel[2]<0?"backSpin":"forwardSpin":this.lastTouchedType==="handpass"&&!this.hasBounced?this.animState=this.vel[2]<0?"backSpinRight":"forwardSpinLeft":this.hasBounced?Math.abs(this.vel[1])<.05&&this.pos[1]<=this.floorY+.01?this.animState="idle":this.animState=this.vel[2]<0?"forwardSpin":"backSpin":this.animState="idle",this.animState!==i&&(this.animFrame=0,this.animTimer=0);const s=this.animations[this.animState];s.length!==0&&this.animFrame>=s.length&&(this.animFrame=0)}render(t){var r;const e=(r=this.animations)==null?void 0:r[this.animState],[i,s,n]=(e==null?void 0:e[this.animFrame])??[0,1,void 0];t.renderSprite(this.pos,this.width,this.height,i,s);{const o=t.gl;o.useProgram(t.program),o.bindVertexArray(t.quadVao);const[a,l]=[2,3];t.setTileUV(a,l),o.uniform1i(t.uTilingU,0),o.uniform1i(t.uTilingV,0);const c=U();q(c,c,[this.pos[0],.001,this.pos[2]]),qt(c,c,-Math.PI/2),ht(c,c,[2,2,1]),o.uniformMatrix4fv(t.uModel,!1,c),o.drawElements(o.TRIANGLES,6,o.UNSIGNED_SHORT,0)}}setupForBoundary(t,e){if(this.carried=!1,this.carrier=null,t==="goalAway"||t==="goalHome")this.pos.setFrom(0,0,C/2),this.vel.setFrom(0,15,0),this.lastTouchedType="tap",this.lastTouchedBy=null,this.origin.copyFrom(this.pos);else if(t==="behindAway")this.pos.setFrom(0,0,C-6);else if(t==="behindHome")this.pos.setFrom(0,0,6);else{this.pos.copyFrom(e),this.pos.y=0;const i=F(0,C/2,C/2).toDir(this.pos);this.launch(i,15,"tap")}}}class We{constructor(t=[0,.001,0]){this.pos=O.fromArray(t),this.size=2,this.spriteCoord=[0,3]}setPosition(t){this.pos[0]=t[0],this.pos[2]=t[2]}render(t){const e=t.gl;e.useProgram(t.program),e.bindVertexArray(t.quadVao);const[i,s]=this.spriteCoord;t.setTileUV(i,s),e.uniform1i(t.uTilingU,0),e.uniform1i(t.uTilingV,0);const n=U();q(n,n,[this.pos[0],.02,this.pos[2]]),qt(n,n,-Math.PI/2),ht(n,n,[this.size,this.size,1]),e.uniformMatrix4fv(t.uModel,!1,n),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0)}}function jt(h,t,e){const i=(o,a)=>{const l=h.createShader(a);if(!l)throw new Error("Failed to create shader");if(h.shaderSource(l,o),h.compileShader(l),!h.getShaderParameter(l,h.COMPILE_STATUS))throw new Error(h.getShaderInfoLog(l));return l},s=i(t,h.VERTEX_SHADER),n=i(e,h.FRAGMENT_SHADER),r=h.createProgram();if(h.attachShader(r,s),h.attachShader(r,n),h.linkProgram(r),!h.getProgramParameter(r,h.LINK_STATUS))throw new Error(h.getProgramInfoLog(r));return r}async function Oe(h){const t=new Image;return t.src=h,await t.decode(),t}function Ne(h,t,e,i=1){const r=h*2/1.6/i,o=t*2/2/i,a=[0,0,0,.5,.5],l=[];for(let c=0;c<=e;c++){const u=c/e*2*Math.PI,f=Math.cos(u)*h,d=Math.sin(u)*t,p=f/(h*2)*r+.5,g=d/(t*2)*o+.5;a.push(f,0,d,p,g),c>0&&l.push(0,c,c+1)}return{vertices:new Float32Array(a),indices:new Uint16Array(l)}}function Ye(h=160,t=170,e=50,i=50,s=.4){const n=[],r=[];let o=0;function a(b,y,w,v){const _=o;for(let M=0;M<b.length;M++)n.push(b[M],0,y[M]),n.push(w[M],0,v[M]),o+=2;for(let M=0;M<b.length-1;M++){const T=_+M*2,A=T+1,P=T+2,k=T+3;r.push(T,A,P,P,A,k)}}function l(b,y,w,v,_){const M=w-b,T=v-y,A=Math.hypot(M,T),P=-T/A,k=M/A,R=_/2,E=b+P*R,z=y+k*R,$=b-P*R,ut=y-k*R,dt=w+P*R,ft=v+k*R,he=w-P*R,oe=v-k*R;a([E,dt],[z,ft],[$,he],[ut,oe])}function c(b,y,w,v,_){const M=w-v/2,T=w+v/2,A=[],P=[],k=[],R=[];for(let E=0;E<=_;E++){const z=E/_*2*Math.PI;A.push(b+Math.cos(z)*M),P.push(y+Math.sin(z)*M),k.push(b+Math.cos(z)*T),R.push(y+Math.sin(z)*T)}a(A,P,k,R)}const u=h/2,f=t/2;{const y=[],w=[],v=[],_=[];for(let M=0;M<=64;M++){const T=M/64*2*Math.PI,A=Math.cos(T),P=Math.sin(T);y.push(A*(u-s/2)),w.push(P*(f-s/2)),v.push(A*(u+s/2)),_.push(P*(f+s/2))}a(y,w,v,_)}const d=[[-i/2,-i/2],[i/2,-i/2],[i/2,i/2],[-i/2,i/2]];for(let b=0;b<4;b++){const[y,w]=d[b],[v,_]=d[(b+1)%4];l(y,w,v,_,s)}function p(b){const y=b>0?-1:1,w=[];for(let v=0;v<=1e3;v++){const _=-Math.PI+v/1e3*2*Math.PI,M=Math.sin(_)*e,T=b+y*Math.cos(_)*e,A=M/u,P=T/f;A*A+P*P<=1&&w.push(_)}return w.length===0?[-Math.PI/3,Math.PI/3]:[w[0],w[w.length-1]]}for(let b of[-t/2,t/2]){const y=b>0?-1:1,[w,v]=p(b),_=40,M=e-s/2,T=e+s/2,A=[],P=[],k=[],R=[];for(let E=0;E<=_;E++){const z=w+E/_*(v-w),$=Math.sin(z)*M,ut=b+y*Math.cos(z)*M,dt=Math.sin(z)*T,ft=b+y*Math.cos(z)*T;A.push($),P.push(ut),k.push(dt),R.push(ft)}a(A,P,k,R)}const g=6.4,S=9;for(let b of[-1,1]){const y=b*(t/2),w=y,v=y-b*S,_=-g/2,M=g/2;l(_,w,M,w,s),l(M,w,M,v,s),l(M,v,_,v,s),l(_,v,_,w,s)}return c(0,0,3,s,48),c(0,0,10,s,64),l(-10,0,10,0,s),{vertices:new Float32Array(n),indices:new Uint16Array(r)}}function Xe(h,t,e=3.5,i=128){const s=[],n=[],r=h+e,o=t+e,a=2.4,c=1/2;for(let u=0;u<=i;u++){const f=u/i*2*Math.PI,d=Math.cos(f)*r,p=Math.sin(f)*o,g=u*c;s.push(d,0,p,g,1),s.push(d,a,p,g,0)}for(let u=0;u<i;u++){const f=u*2;n.push(f,f+1,f+2),n.push(f+2,f+1,f+3)}return{fenceVertices:new Float32Array(s),fenceIndices:new Uint16Array(n)}}function Ge(h,t,e,i,s,n,r=64){const o=[],a=[],u=(h+t+e+i)/4,d=2*Math.PI*u/r/3.2,g=Math.abs(n-s)/4.8;for(let S=0;S<=r;S++){const b=S/r*2*Math.PI,y=Math.cos(b),w=Math.sin(b),v=y*h,_=w*t,M=y*e,T=w*i,A=S*d;o.push(v,s,_,A,g),o.push(M,n,T,A,0)}for(let S=0;S<r;S++){const b=S*2;a.push(b,b+1,b+2),a.push(b+2,b+1,b+3)}return{vertices:new Float32Array(o),indices:new Uint16Array(a)}}function qe(h,t,e,i,s,n=64){const r=[],o=[],a=s+5,l=a+4,c=.5*(h+e),u=.5*(t+i),f=c,d=u,p=3.2,g=4.8,S=.5*(e+i),b=2*Math.PI*S/n/p,y=(a-s)/g,w=(l-a)/g;for(let v=0;v<=n;v++){const _=v/n*2*Math.PI,M=Math.cos(_),T=Math.sin(_),A=v*b,P=M*e,k=T*i,R=M*c,E=T*u,z=M*f,$=T*d;r.push(P,s,k,A,y+w),r.push(R,a,E,A,w),r.push(z,l,$,A,0)}for(let v=0;v<n;v++){const _=v*3;o.push(_,_+1,_+3),o.push(_+3,_+1,_+4),o.push(_+1,_+2,_+4),o.push(_+4,_+2,_+5)}return{vertices:new Float32Array(r),indices:new Uint16Array(o)}}function Ze(h,t,e=-9.8,i=32,s=.5){const n=[],r=[],o=h[1],a=t[1],l=e,c=a*a-2*l*o;if(c<0)return{vertices:new Float32Array,indices:new Uint16Array};const u=(-a-Math.sqrt(c))/l,f=u/i,d=[t[0],t[2]],p=Math.hypot(...d),g=-d[1]/p,S=d[0]/p;for(let y=0;y<=i;y++){const w=y*f,v=h[0]+t[0]*w,_=h[1]+t[1]*w+.5*l*w*w,M=h[2]+t[2]*w,T=.2+.8*(w/u),A=s/2*T,P=v+g*A,k=M+S*A,R=v-g*A,E=M-S*A;n.push(P,_,k),n.push(R,_,E)}const b=n.length/3;for(let y=0;y<b-2;y+=2)r.push(y,y+1,y+2),r.push(y+2,y+1,y+3);return{vertices:new Float32Array(n),indices:new Uint16Array(r)}}function Ke(h,t,e=!1){const i=-h.gravity[1],s=(e?20:30)*Math.PI/180,n=F(t[0],0,t[1]),r=n.len();if(r<.1)return null;const o=Math.sin(2*s),a=Math.sqrt(r*i/o),l=n.c.normalize();return F(l[0]*Math.cos(s),Math.sin(s),l[2]*Math.cos(s)).scale(a)}const $e=`#version 300 es
    in vec3 a_position;
    in vec2 a_texcoord;
    uniform mat4 u_projection, u_view, u_model;
    out vec2 v_texcoord;
    void main() {
        gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
        v_texcoord = a_texcoord;
    }
`,Je=`#version 300 es
precision mediump float;

uniform sampler2D u_texture;
uniform vec4 u_tileUV;
uniform bool u_tilingU;
uniform bool u_tilingV;

in vec2 v_texcoord;
out vec4 outColor;

void main() {
    vec2 tileUV = v_texcoord;

    if (u_tilingU) tileUV.x = fract(tileUV.x);
    if (u_tilingV) tileUV.y = fract(tileUV.y);

    vec2 texCoord = mix(u_tileUV.xy, u_tileUV.zw, tileUV);

    vec2 texelSize = 1.0 / vec2(textureSize(u_texture, 0));
    vec2 epsilon = 0.5 * texelSize;
    texCoord = clamp(texCoord, u_tileUV.xy + epsilon, u_tileUV.zw - epsilon);

    vec4 texColor = texture(u_texture, texCoord);
    if (texColor.a < 0.01) discard;

    outColor = texColor;
}
`,Qe=`#version 300 es
    in vec3 a_position;
    uniform mat4 u_projection;
    uniform mat4 u_view;
    uniform mat4 u_model;
    void main() {
        gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
    }`,ti=`#version 300 es
    precision mediump float;
    uniform vec4 u_color;
    out vec4 out_color;
    void main() {
        out_color = u_color;
    }
`,Kt=16,$t=24,Ut=512,Wt=768,vt=0,Tt=0,Ot=Kt+vt,Nt=$t+Tt,tt=170,yt=80,st=tt/2;class ei{constructor(t,e,i){this.gl=t,this.canvas=e,this.spriteSheet=i,this.sheetCols=32,this.sheetRows=32,this.program=jt(t,$e,Je),this.uProjection=t.getUniformLocation(this.program,"u_projection"),this.uView=t.getUniformLocation(this.program,"u_view"),this.uModel=t.getUniformLocation(this.program,"u_model"),this.uTileUV=t.getUniformLocation(this.program,"u_tileUV"),this.uTilingU=t.getUniformLocation(this.program,"u_tilingU"),this.uTilingV=t.getUniformLocation(this.program,"u_tilingV"),this.uTexture=t.getUniformLocation(this.program,"u_texture"),this.aPos=t.getAttribLocation(this.program,"a_position"),this.aUV=t.getAttribLocation(this.program,"a_texcoord"),this.lineProgram=jt(t,Qe,ti),this.lineProj=t.getUniformLocation(this.lineProgram,"u_projection"),this.lineView=t.getUniformLocation(this.lineProgram,"u_view"),this.lineModel=t.getUniformLocation(this.lineProgram,"u_model"),this.linePos=t.getAttribLocation(this.lineProgram,"a_position"),this.uLineColor=t.getUniformLocation(this.lineProgram,"u_color"),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.depthMask(!0);const s=new Float32Array([-.5,0,0,1,.5,0,1,1,.5,1,1,0,-.5,1,0,0]),n=new Uint16Array([0,1,2,0,2,3]);this.quadVao=t.createVertexArray(),t.bindVertexArray(this.quadVao);const r=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,s,t.STATIC_DRAW),t.vertexAttribPointer(this.aPos,2,t.FLOAT,!1,16,0),t.enableVertexAttribArray(this.aPos),t.vertexAttribPointer(this.aUV,2,t.FLOAT,!1,16,8),t.enableVertexAttribArray(this.aUV);const o=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,o),t.bufferData(t.ELEMENT_ARRAY_BUFFER,n,t.STATIC_DRAW);const{vertices:a,indices:l}=Ne(yt,st,64,16);this.fieldVao=t.createVertexArray(),t.bindVertexArray(this.fieldVao);const c=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,c),t.bufferData(t.ARRAY_BUFFER,a,t.STATIC_DRAW),t.vertexAttribPointer(this.aPos,3,t.FLOAT,!1,20,0),t.enableVertexAttribArray(this.aPos),t.vertexAttribPointer(this.aUV,2,t.FLOAT,!1,20,12),t.enableVertexAttribArray(this.aUV);const u=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,u),t.bufferData(t.ELEMENT_ARRAY_BUFFER,l,t.STATIC_DRAW),this.fieldIndices=l.length,this.fieldLineMesh=Ye(),this.lineVao=t.createVertexArray(),t.bindVertexArray(this.lineVao);const f=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,f),t.bufferData(t.ARRAY_BUFFER,this.fieldLineMesh.vertices,t.STATIC_DRAW);const d=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,d),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.fieldLineMesh.indices,t.STATIC_DRAW),t.vertexAttribPointer(this.linePos,3,t.FLOAT,!1,12,0),t.enableVertexAttribArray(this.linePos);const p=6.8;this.goalPostPositions=[[-3*p/2,0,tt],[-p/2,0,tt],[p/2,0,tt],[3*p/2,0,tt],[-3*p/2,0,0],[-p/2,0,0],[p/2,0,0],[3*p/2,0,0]];const{fenceVertices:g,fenceIndices:S}=Xe(yt,st);this.fenceVao=t.createVertexArray(),t.bindVertexArray(this.fenceVao);const b=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,b),t.bufferData(t.ARRAY_BUFFER,g,t.STATIC_DRAW),t.vertexAttribPointer(this.aPos,3,t.FLOAT,!1,20,0),t.enableVertexAttribArray(this.aPos),t.vertexAttribPointer(this.aUV,2,t.FLOAT,!1,20,12),t.enableVertexAttribArray(this.aUV);const y=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,y),t.bufferData(t.ELEMENT_ARRAY_BUFFER,S,t.STATIC_DRAW),this.fenceIndices=S.length;const w=yt+3.5,v=st+3.5,_=Ge(w+.5,v+.5,w+30,v+30,0,20);this.stadiumVao=t.createVertexArray(),t.bindVertexArray(this.stadiumVao);const M=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,M),t.bufferData(t.ARRAY_BUFFER,_.vertices,t.STATIC_DRAW),t.vertexAttribPointer(this.aPos,3,t.FLOAT,!1,20,0),t.enableVertexAttribArray(this.aPos),t.vertexAttribPointer(this.aUV,2,t.FLOAT,!1,20,12),t.enableVertexAttribArray(this.aUV);const T=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,T),t.bufferData(t.ELEMENT_ARRAY_BUFFER,_.indices,t.STATIC_DRAW),this.stadiumIndices=_.indices.length;const A=qe(w+.5,v+.5,w+30,v+30,20);this.stadiumRoofVao=t.createVertexArray(),t.bindVertexArray(this.stadiumRoofVao);const P=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,P),t.bufferData(t.ARRAY_BUFFER,A.vertices,t.STATIC_DRAW),t.vertexAttribPointer(this.aPos,3,t.FLOAT,!1,20,0),t.enableVertexAttribArray(this.aPos),t.vertexAttribPointer(this.aUV,2,t.FLOAT,!1,20,12),t.enableVertexAttribArray(this.aUV);const k=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,k),t.bufferData(t.ELEMENT_ARRAY_BUFFER,A.indices,t.STATIC_DRAW),this.stadiumRoofIndices=A.indices.length,t.bindVertexArray(null),this.trajVao=t.createVertexArray(),this.trajVbo=t.createBuffer(),this.trajEbo=t.createBuffer();const R=128;t.bindVertexArray(this.trajVao),t.bindBuffer(t.ARRAY_BUFFER,this.trajVbo);const E=R*2;t.bufferData(t.ARRAY_BUFFER,E*12,t.DYNAMIC_DRAW),t.vertexAttribPointer(this.linePos,3,t.FLOAT,!1,12,0),t.enableVertexAttribArray(this.linePos),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.trajEbo),t.bufferData(t.ELEMENT_ARRAY_BUFFER,6*(R-1)*Uint16Array.BYTES_PER_ELEMENT,t.DYNAMIC_DRAW),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.spriteSheet),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.texture),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),this.projection=U(),this.view=U(),this.model=U(),this.updateProjection()}updateProjection(){this.projection=U(),de(this.projection,Math.PI/4,this.canvas.width/this.canvas.height,.1,1e3)}renderSprite(t,e,i,s,n){const{gl:r,program:o,quadVao:a,uModel:l,uTileUV:c,sheetCols:u,sheetRows:f}=this;r.useProgram(o),r.bindVertexArray(a);const d=U();q(d,d,t),ht(d,d,[e,i,1]),r.uniformMatrix4fv(l,!1,d),this.setTileUV(s,n),r.uniform1i(this.uTilingU,0),r.uniform1i(this.uTilingV,0),r.drawElements(r.TRIANGLES,6,r.UNSIGNED_SHORT,0)}setTileUV(t,e,i=Kt,s=$t){const n=(t*Ot+vt/2)/Ut,r=(e*Nt+Tt/2)/Wt,o=(t*Ot+vt/2+i)/Ut,a=(e*Nt+Tt/2+s)/Wt;this.gl.uniform4f(this.uTileUV,n,r,o,a)}renderScene(t,e){const i=this.gl;i.viewport(0,0,this.canvas.width,this.canvas.height),i.clearColor(.2,.6,.2,1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);const s=Pt(0,10,15),n=wt();Dt(n,t.cameraTarget,s);const r=Pt(0,0,-20),o=wt();Dt(o,t.cameraTarget,r),fe(this.view,n,o,[0,1,0]),i.useProgram(this.program),i.uniformMatrix4fv(this.uProjection,!1,this.projection),i.uniformMatrix4fv(this.uView,!1,this.view),i.activeTexture(i.TEXTURE0),i.uniform1i(this.uTexture,0),i.bindVertexArray(this.fieldVao),Gt(this.model),q(this.model,this.model,[0,0,st]),i.uniformMatrix4fv(this.uModel,!1,this.model),this.setTileUV(0,2),i.uniform1i(this.uTilingU,1),i.uniform1i(this.uTilingV,1),i.drawElements(i.TRIANGLES,this.fieldIndices,i.UNSIGNED_SHORT,0),i.enable(i.CULL_FACE),i.cullFace(i.FRONT),i.frontFace(i.CCW),i.uniformMatrix4fv(this.uModel,!1,this.model),i.bindVertexArray(this.stadiumVao),this.setTileUV(7,2),i.uniform1i(this.uTilingU,1),i.uniform1i(this.uTilingV,1),i.drawElements(i.TRIANGLES,this.stadiumIndices,i.UNSIGNED_SHORT,0),this.setTileUV(8,2),i.uniform1i(this.uTilingU,1),i.uniform1i(this.uTilingV,1),i.bindVertexArray(this.stadiumRoofVao),i.drawElements(i.TRIANGLES,this.stadiumRoofIndices,i.UNSIGNED_SHORT,0),i.disable(i.CULL_FACE),i.bindVertexArray(this.fenceVao),this.setTileUV(3,2,48,24),i.uniform1i(this.uTilingU,1),i.uniform1i(this.uTilingV,0),i.drawElements(i.TRIANGLES,this.fenceIndices,i.UNSIGNED_SHORT,0),i.useProgram(this.lineProgram),i.uniform4f(this.uLineColor,1,1,1,1),i.uniformMatrix4fv(this.lineProj,!1,this.projection),i.uniformMatrix4fv(this.lineView,!1,this.view);const p=U();q(p,this.model,[0,.01,0]),i.uniformMatrix4fv(this.lineModel,!1,p),i.bindVertexArray(this.lineVao),i.drawElements(i.TRIANGLES,this.fieldLineMesh.indices.length,i.UNSIGNED_SHORT,0),i.useProgram(this.program),i.bindVertexArray(this.quadVao),this.setTileUV(1,2),i.uniform1i(this.uTilingU,0),i.uniform1i(this.uTilingV,1);for(let y=0;y<this.goalPostPositions.length;y++){const[w,v,_]=this.goalPostPositions[y],T=y%4===0||y%4===3?6:10,A=n[0]-w,P=n[2]-_,k=Math.sqrt(A*A+P*P),R=k>50?1.5:k>150?2:1,E=U();q(E,E,[w,v,_]),ht(E,E,[R,T,1]),i.uniformMatrix4fv(this.uModel,!1,E),i.drawElements(i.TRIANGLES,6,i.UNSIGNED_SHORT,0)}i.bindVertexArray(this.quadVao);for(const y of e)y instanceof xt&&y.render(this);t.aimTarget.render(this);const b=t.controls.getState().aimTarget;if(t.player&&t.player.aiming&&b!==null){const w=Ke(t.player,b,!1);if(!w)return;const v=t.player.pos.c,_=Ze(v,w,-9.8,32);i.useProgram(this.lineProgram),i.uniform4f(this.uLineColor,1,1,1,.1),i.uniformMatrix4fv(this.lineProj,!1,this.projection),i.uniformMatrix4fv(this.lineView,!1,this.view);const M=U();q(M,M,[0,.01,0]),i.uniformMatrix4fv(this.lineModel,!1,M),i.bindVertexArray(this.trajVao),i.bindBuffer(i.ARRAY_BUFFER,this.trajVbo),i.bufferSubData(i.ARRAY_BUFFER,0,_.vertices),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.trajEbo),i.bufferSubData(i.ELEMENT_ARRAY_BUFFER,0,_.indices),i.drawElements(i.TRIANGLES,_.indices.length,i.UNSIGNED_SHORT,0)}}}var G,Jt,Qt,te;class ii{constructor(t){Ft(this,G);this.state={moveX:0,moveZ:0,kickPressed:!1,kickReleased:!1,kickHeldTime:0,aimTarget:null},this.keys={},this.lastKeys={},this.touchMove=null,this.touchAim=null,this.gamepadAimActive=!1,this.kPressTime=0,t.addEventListener("touchstart",it(this,G,Jt).bind(this),{passive:!1}),t.addEventListener("touchmove",it(this,G,Qt).bind(this),{passive:!1}),t.addEventListener("touchend",it(this,G,te).bind(this)),window.addEventListener("keydown",e=>this.keys[e.key.toLowerCase()]=!0),window.addEventListener("keyup",e=>this.keys[e.key.toLowerCase()]=!1)}endUpdate(){this.state.moveX=0,this.state.moveZ=0,this.state.kickPressed=!1,this.state.kickReleased=!1}update(t){var n;const e=!!this.keys.k,i=!!this.lastKeys.k;if(e&&!i&&(this.state.kickPressed=!0,this.kPressTime=0,this.state.aimTarget=[0,-10]),e?(this.kPressTime+=t,this.state.aimTarget&&(this.keys.a&&(this.state.aimTarget[0]-=30*t),this.keys.d&&(this.state.aimTarget[0]+=30*t),this.keys.w&&(this.state.aimTarget[1]-=30*t),this.keys.s&&(this.state.aimTarget[1]+=30*t))):(this.keys.a&&(this.state.moveX-=1),this.keys.d&&(this.state.moveX+=1),this.keys.w&&(this.state.moveZ-=1),this.keys.s&&(this.state.moveZ+=1)),!e&&i&&(this.state.kickReleased=!0),this.state.kickHeldTime=this.kPressTime,this.touchMove&&!this.touchAim&&(this.state.moveX=this.touchMove.dx/50,this.state.moveZ=this.touchMove.dy/50),this.touchAim){this.kPressTime+=t;const r=this.touchAim.dx,o=this.touchAim.dy,a=10;this.state.aimTarget=[-r/a,-o/a],this.state.kickHeldTime=this.kPressTime}const s=(n=navigator.getGamepads)==null?void 0:n.call(navigator)[0];if(s){this.state.moveX+=Math.abs(s.axes[0])>.1?s.axes[0]:0,this.state.moveZ+=Math.abs(s.axes[1])>.1?s.axes[1]:0;const r=s.axes[2]||0,o=s.axes[3]||0,a=Math.hypot(r,o);this.gamepadAimActive?(this.kPressTime+=t,this.state.kickHeldTime+=this.kPressTime,o>.025?this.state.aimTarget&&(this.state.aimTarget=[this.state.aimTarget[0]-r/a,this.state.aimTarget[1]-o/a]):(this.state.kickReleased=!0,this.gamepadAimActive=!1)):o>.025&&(this.state.aimTarget=[0,-10],this.state.kickHeldTime=this.kPressTime,this.state.kickPressed=!0,this.gamepadAimActive=!0)}this.lastKeys={...this.keys}}getState(){return this.state}}G=new WeakSet,Jt=function(t){t.preventDefault();for(const e of t.changedTouches)e.clientX<window.innerWidth/2?this.touchMove={id:e.identifier,startX:e.clientX,startY:e.clientY,dx:0,dy:0}:(this.touchAim={id:e.identifier,startX:e.clientX,startY:e.clientY,dx:0,dy:0},this.state.kickPressed=!0,this.kPressTime=0)},Qt=function(t){t.preventDefault();for(const e of t.changedTouches)this.touchMove&&e.identifier===this.touchMove.id&&(this.touchMove.dx=e.clientX-this.touchMove.startX,this.touchMove.dy=e.clientY-this.touchMove.startY),this.touchAim&&e.identifier===this.touchAim.id&&(this.touchAim.dx=e.clientX-this.touchAim.startX,this.touchAim.dy=e.clientY-this.touchAim.startY)},te=function(t){t.preventDefault();for(const e of t.changedTouches)this.touchAim&&e.identifier===this.touchAim.id&&(this.touchAim=null,this.state.kickReleased=!0),this.touchMove&&e.identifier===this.touchMove.id&&(this.touchMove=null)};class D extends Array{constructor(t=[0,0]){super(),this[0]=t[0],this[1]=t[1]}equals(t){return this.length===t.length&&this[0]===t[0]&&this[1]===t[1]}static random(t){return new D(Ee(t[0],t[1]))}add(t){return new D([this[0]+t[0],this[1]+t[1]])}sub(t){return new D([this[0]-t[0],this[1]-t[1]])}floor(){return new D([Math.floor(this[0]),Math.floor(this[1])])}ceil(){return new D([Math.floor(this[0]),Math.floor(this[1])])}scale(t){return new D([this[0]*t,this[1]*t])}mul(t){return new D([this[0]*t[0],this[1]*t[1]])}div(t){return new D([this[0]/t[0],this[1]/t[1]])}dot(t){return this[0]*t[0]+this[1]*t[1]}dist(t){return Math.hypot(this[0]-t[0],this[1]-t[1])}abs(){return new D([Math.abs(this[0]),Math.abs(this[1])])}sum(){return this[0]+this[1]}relativeTo(t){return this.sub(t.pos).div(t.size)}absoluteFrom(t){return this.mul(t.size).add(t.pos)}relativeToPS(t,e){return this.sub(t).scale(1/e)}absoluteFromPS(t,e){return this.scale(e).add(t)}set x(t){this[0]=t}set y(t){this[1]=t}get x(){return this[0]}get y(){return this[1]}}class H extends Array{constructor(t=null){if(super(),t===null){this[0]=0,this[1]=0,this[2]=0,this[3]=0;return}this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3]}set x(t){this[0]=t}set y(t){this[1]=t}set w(t){this[2]=t}set h(t){this[3]=t}set pos(t){this[0]=t[0],this[1]=t[1]}set size(t){this[2]=t[0],this[3]=t[1]}get size(){return new D([this[2],this[3]])}get pos(){return new D([this[0],this[1]])}get x(){return this[0]}get y(){return this[1]}get w(){return this[2]}get h(){return this[3]}get right(){return this[0]+this[2]}get bottom(){return this[1]+this[3]}get center_x(){return this[0]+this[2]/2}get center_y(){return this[1]+this[3]/2}get center(){return new D([this.center_x,this.center_y])}grow(t){return new H([this[0]-t,this[1]-t,this[2]+2*t,this[3]+2*t])}get flooredCenter(){return new D([Math.floor(this[0]+this[2]/2),Math.floor(this[1]+this[3]/2)])}translate(t){return new H([this.x+t[0],this.y+t[1],this.w,this.h])}shrinkBorders(t){return new H([this.x+t,this.y+t,this.w-t*2,this.h-t*2])}scaleBorders(t){return new H([this.x+this.w*(1-t)/2,this.y+this.h*(1-t)/2,this.w*t,this.h*t])}mult(t){return new H([this[0]*t,this[1]*t,this[2]*t,this[3]*t])}multXY(t){return new H([this[0]*t[0],this[1]*t[1],this[2]*t[0],this[3]*t[1]])}scale(t,e=!0){if(e){let i=[this[2]*t,this[3]*t];return new H([this[0]+.5*(this[2]-i[0]),this[1]+.5*(this[3]-i[1]),i[0],i[1]])}else{let i=[this[2]*t,this[3]*t];return new H([this[0],this[1],i[0],i[1]])}}collideRadius(t,e=null){let i=[this.center_x-t.center_x,this.center_y-t.center_y];return e===null&&(e=Math.min(this.w,this.h,t.w,t.h)/2),i[0]*i[0]+i[1]*i[1]<e*e}collide(t){return this.x<t.x+t.w&&this.x+this.w>t.x&&this.y<t.y+t.h&&this.h+this.y>t.y}contains(t){return this.x<=t.x&&this.y<=t.y&&this.x+this.w>=t.x+t.w&&this.y+this.h>=t.y+t.h}contact(t){return this.x<=t.x+t.w&&this.x+this.w>=t.x&&this.y<=t.y+t.h&&this.h+this.y>=t.y}contactRadius(t,e=null){let i=[this.center_x-t.center_x,this.center_y-t.center_y];return e===null&&(e=Math.min(this.w,this.h,t.w,t.h)),i[0]*i[0]+i[1]*i[1]<=e*e}}class ct extends Array{constructor(t=[0,0],e=void 0){e===void 0?super(t[0]*t[1]):super(...e),this.tileDim=new D(t),this.hidden=!1,this._cacheData=null}clone(){return new ct(this.tileDim,this)}get(t){return this[t[0]+t[1]*this.tileDim[0]]}set(t,e){this[t[0]+t[1]*this.tileDim[0]]=e}*iterBetween(t,e,i=0){var s,n,r,o;if([s,n]=t,[r,o]=e,!(Math.abs(o-n)==0&&Math.abs(r-s)==0))if(Math.abs(o-n)>Math.abs(r-s)){var a=(r-s)/(o-n);if(n>o)for(var l=n;l>=o;l--){var c=s+(l-n)*a;yield[c,l]}else for(var l=n;l<=o;l++){var c=s+(l-n)*a;yield[c,l]}}else{var a=(o-n)/(r-s);if(s>r)for(var u=s;u>=r;u--){var f=n+(u-s)*a;yield[u,f]}else for(var u=s;u<=r;u++){var f=n+(u-s)*a;yield[u,f]}}}*iterInBetween(t,e){var i,s,n,r;if([i,s]=t,[n,r]=e,!(Math.abs(r-s)==0&&Math.abs(n-i)==0))if(Math.abs(r-s)>Math.abs(n-i)){var o=(n-i)/(r-s);if(s>r)for(var a=s-1;a>r;a--){var l=Math.round(i+(a-s)*o);yield[l,a]}else for(var a=s+1;a<r;a++){var l=Math.round(i+(a-s)*o);yield[l,a]}}else{var o=(r-s)/(n-i);if(i>n)for(var l=i-1;l>n;l--){var a=Math.round(s+(l-i)*o);yield[l,a]}else for(var l=i+1;l<n;l++){var a=Math.round(s+(l-i)*o);yield[l,a]}}}*iterTypesBetween(t,e,i){for(var s of this.iterBetween(t,e))i.includes(this.get(s))&&(yield s)}*iterTypesInBetween(t,e,i){for(var s of this.iterInBetween(t,e))i.includes(this.get(s))&&(yield s)}hasTypesBetween(t,e,i){for(var s of this.iterTypesBetween(t,e,i))return!0;return!1}hasTypesInBetween(t,e,i){for(var s of this.iterTypesInBetween(t,e,i))return!0;return!1}*iterAll(t=null){const[e,i]=this.tileDim;if(t!==null)for(var s=t[1];s<Math.min(i,t[1]+t[3]);s++)for(var n=t[0];n<Math.min(e,t[0]+t[2]);n++)yield[n,s];else for(var s=0;s<i;s++)for(var n=0;n<e;n++)yield[n,s]}*iterTypes(t,e){for(var i of this.iterAll(e))t.includes(this.get(i))&&(yield i)}*iterAdjacent(t,e=!1){t=new D(t);const i=e?[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]]:[[0,-1],[1,0],[0,1],[-1,0]];for(let s of i){const n=t.add(s);n[0]>=0&&n[0]<this.tileDim[0]&&n[1]>=0&&n[1]<this.tileDim[1]&&(yield n)}}hasAdjacent(t,e,i=!1){for(let s of this.iterAdjacent(t,i))if(e.includes(this.get(s)))return!0;return!1}*iterInRange(t,e){var i,s;[i,s]=t;const[n,r]=this.tileDim;e==null&&(e=3);for(var o=Math.ceil(e),a=-o;a<o+1;a++)for(var l=-o;l<o+1;l++)if(l*l+a*a<=e*e){var c=i+l,u=s+a;0<=u&&u<r&&0<=c&&c<n&&(yield[c,u])}}*iterTypesInRange(t,e,i,s=null){for(var n of this.iterInRange(t,i))s!==null&&this.hasTypesBetween(t,n,s)||e.includes(this.get(n))&&(yield n)}numInRange(t,e,i,s=null){var n=0;for(var r of this.iterTypesInRange(t,e,i,s))n++;return n}*iterRectBoundary(t){const[e,i]=this.tileDim;let s=Math.min(Math.max(t.x,0),e),n=Math.min(Math.max(t.x+t.w,0),e),r=Math.min(Math.max(t.y,0),i),o=Math.min(Math.max(t.y+t.h,0),i);for(let a=s;a<n;a++)yield[a,r];for(let a=s;a<n;a++)yield[a,o];for(let a=r;a<o;a++)yield[s,a];for(let a=r;a<o;a++)yield[n,a]}*iterRect(t,e=!0){const[i,s]=this.tileDim;if(t instanceof H||(t=new H(t)),e&&(t.x<0||t.y<0||t.right>i||t.bottom>s))return;let n=Math.max(t.x,0),r=Math.min(t.x+t.w,i),o=Math.max(t.y,0),a=Math.min(t.y+t.h,s);for(let l=o;l<a;l++)for(let c=n;c<r;c++)yield[c,l]}numInRect(t,e,i=!0){let s=0;for(var n of this.iterRect(t,i))e.includes(this.get(n))&&s++;return s}}const B=8,J=48*(1/window.devicePixelRatio||1);function _t(h,t,e,i,s,n,r){let o=1;e<B&&(o=1/J,h.save(),h.scale(o,o)),h.fillStyle=r,h.font=(e>=B?e:Math.ceil(e/o))+"px "+i,n.x;let a=o*h.measureText(t).width;return e<B&&h.restore(),[a,2*e]}function Yt(h,t,e,i,s,n,r,o){let a=1;e<B&&(a=1/J,h.save(),h.scale(a,a)),h.fillStyle=o,h.font=(e>=B?e:Math.ceil(e/a))+"px "+i;let l=r.x,c=h.measureText(t),u=r.y;switch(s){case"left":break;case"center":l+=(r.w-a*c.width)/2;break;case"right":l+=r.w-a*c.width;break}switch(n){case"top":break;case"middle":u+=r.h/2;break;case"bottom":u+=r.h;break}let d={outText:[[t,l/a,u/a]],color:o,fontName:i,size:e,valign:n};return e<B&&h.restore(),d}function si(h,t,e=null){let i=1,s=t.size;switch(e==null&&(e=t.color),s<B&&(i=1/J,h.save(),h.scale(i,i)),t.valign){case"top":h.textBaseline="top";break;case"middle":h.textBaseline="middle";break;case"bottom":h.textBaseline="bottom";break}h.fillStyle=e,h.font=(s>=B?s:Math.ceil(s/i))+"px "+t.fontName;let[n,r,o]=t.outText[0];h.fillText(n,r,o),s<B&&h.restore()}function bt(h,t,e,i,s,n,r,o=!0){let a=1;e<B&&(a=1/J,h.save(),h.scale(a,a)),h.font=(e>=B?e:Math.ceil(e/a))+"px "+i;let l=0,c="",u=Math.min(Math.max(1,Math.ceil(t.length*n.w/h.measureText(t).width/a)),t.length);for(;t!=""||c!="";){if(c==""){let p=t.indexOf(`
`);p>=0?(c=t.slice(0,p),t=t.slice(p+1)):(c=t,t="")}let f=c.slice(0,u),d=a*h.measureText(f).width;if(d>n.w&&u>1)for(;d>n.w&&u>1;)u--,f=c.slice(0,u),d=a*h.measureText(f).width;if(d<n.w&&u<c.length){for(;d<n.w&&u<c.length;)u++,f=c.slice(0,u),d=a*h.measureText(f).width;d>n.w&&u--}if(o&&f[-1]!=""&&c[u]!=" "&&c[u]!="	"){let p=Math.max(f.lastIndexOf(" "),f.lastIndexOf("	"));p>=0&&(u-=f.length-p-1)}u=Math.max(1,u),f=c.slice(0,u),c=c.slice(u),o&&(c=c.trimStart()),l+=e}return l+=e,e<B&&h.restore(),[n.w,l]}function Xt(h,t,e,i,s,n,r,o,a=!0){let l=1;e<B&&(l=1/J,h.save(),h.scale(l,l)),h.fillStyle=o,h.font=(e>=B?e:Math.ceil(e/l))+"px "+i;let c=r.y,u=[],f="",d=Math.min(Math.max(1,Math.ceil(t.length*(r.w/h.measureText(t).width)/l)),t.length);for(;t!=""||f!="";){if(f==""){let v=t.indexOf(`
`);v>=0?(f=t.slice(0,v),t=t.slice(v+1)):(f=t,t="")}let b=r.x,y=f.slice(0,d),w=l*h.measureText(y).width;if(w>r.w&&d>1)for(;w>r.w&&d>1;)d--,y=f.slice(0,d),w=l*h.measureText(y).width;if(w<r.w&&d<f.length){for(;w<r.w&&d<f.length;)d++,y=f.slice(0,d),w=l*h.measureText(y).width;w>r.w&&d--}if(a&&d<f.length&&y[-1]!=""&&f[d]!=" "&&f[d]!="	"){let v=Math.max(y.lastIndexOf(" "),y.lastIndexOf("	"));v>=0&&(d-=y.length-v-1)}switch(d=Math.max(1,d),y=f.slice(0,d),f=f.slice(d),a&&(f=f.trimStart()),w=l*h.measureText(y).width,s){case"left":break;case"center":b+=(r.w-w)/2;break;case"right":b+=r.w-w;break}u.push([y,b/l,c/l]),c+=e}let p=c-r.y,g=0;switch(n){case"top":g=0;break;case"middle":g=(r.h-p)/2+e/2;break;case"bottom":g=r.h-p+e}let S={size:e,fontName:i,outText:u,off:g/l,color:o,valign:n};return e<B&&h.restore(),S}function ni(h,t,e=null){let i=1,s=t.size;switch(e===null&&(e=t.color),s<B&&(i=1/J,h.save(),h.scale(i,i)),t.valign){case"top":h.textBaseline="top";break;case"middle":h.textBaseline="middle";break;case"bottom":h.textBaseline="bottom";break}h.fillStyle=e,h.font=(s>=B?s:Math.ceil(s/i))+"px "+t.fontName;for(let n of t.outText)h.fillText(n[0],n[1],n[2]+(t.off??0));s<B&&h.restore()}const lt=(h,t,e)=>Math.min(Math.max(h,t),e);function ri(h,t){return new D(h).dist(t)}function L(h){let t,e,i;return[t,e,i]=new Z(h).scale(255).map(s=>Math.floor(s)),"#"+t.toString(16).padStart(2,"0")+e.toString(16).padStart(2,"0")+i.toString(16).padStart(2,"0")}class Z extends Array{constructor(...t){t.length==1&&t[0]instanceof Array?super(...t[0]):super(...t)}static asRandomFloats(t,e=0,i=1){let s=new Z(t);for(let n=0;n<s.length;n++)s[n]=Le(e,i);return s}sum(){let t=0;return this.forEach(e=>t+=e),t}mean(){return this.sum()/this.length}max(){return Math.max.apply(null,this)}min(){return Math.min.apply(null,this)}vars(){let t=0;return this.forEach(e=>t+=e*e),(t-this.length*this.mean()^2)/(this.length-1)}var(){let t=0;return this.forEach(e=>t+=e*e),t/this.length-this.mean()^2}std(){return Math.sqrt(this.var())}add(t){let e=new Z(this);if(t instanceof Array)for(let i=0;i<this.length;i++)e[i]+=t[i];else for(let i=0;i<this.length;i++)e[i]+=t;return e}mul(t){let e=new Z(this);if(t instanceof Array)for(let i=0;i<this.length;i++)e[i]*=t[i];else for(let i=0;i<this.length;i++)e[i]*=t;return e}scale(t){const e=Array();for(let i of this)e.push(i*t);return e}dot(t){return this.mul(t).sum()}abs(){return Math.abs.apply(null,this)}lag(t){let e=new Z;for(let i=-t;i<this.length-t;i++)i<0||i>=this.length?e.push(NaN):e.push(this[i]);return e}filter(t){return new Z(super.filter(t))}dropNaN(){return this.filter(t=>!Number.isNaN(t))}}class N{constructor(t={}){m(this,"identifier",-1);m(this,"pos",[0,0]);m(this,"state","touch_up");m(this,"device","touch");m(this,"nativeObject",null);m(this,"nativeEvent",null);for(let e in t)this[e]=t[e]}copy(){return new N({pos:[...this.pos],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}asChildTouch(t){return new N({pos:[...t.toChild(this.pos)],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}get rect(){return new H([...this.pos,0,0])}set x(t){this.pos[0]=t}set y(t){this.pos[1]=t}get x(){return this.pos[0]}get y(){return this.pos[1]}get grabbed(){return x.get().inputHandler.grabbed}grab(t){x.get().inputHandler.grab(t)}ungrab(){x.get().inputHandler.ungrab()}}class hi{constructor(t){m(this,"grabbed",null);m(this,"mouseTouchEmulation",!0);m(this,"mouseev",null);m(this,"keyStates",{});this.app=t,this.canvas=t.canvas;let e=this.canvas,i=this;document.addEventListener("keydown",function(s){i.process_key(s,"key_down")},!0),document.addEventListener("keyup",function(s){i.process_key(s,"key_up")},!0),e.addEventListener("mousedown",function(s){i.process_mouse(s,"mouse_down")},!0),e.addEventListener("mousemove",function(s){i.process_mouse(s,"mouse_move")},!0),e.addEventListener("mouseout",function(s){i.process_mouse(s,"mouse_cancel")},!0),e.addEventListener("mouseup",function(s){i.process_mouse(s,"mouse_up")},!0),e.addEventListener("touchstart",function(s){i.process_touch(s,"touch_down")},!1),e.addEventListener("touchmove",function(s){i.process_touch(s,"touch_move")},!1),e.addEventListener("touchcancel",function(s){i.process_touch(s,"touch_cancel")},!1),e.addEventListener("touchend",function(s){i.process_touch(s,"touch_up")},!1),e.addEventListener("wheel",function(s){i.process_wheel(s,"wheel")},!0),window.history.replaceState(null,document.title,location.pathname+"#!/backbutton"),window.history.pushState(null,document.title,location.pathname),window.addEventListener("popstate",function(s){i.process_back(s,"back_button")},!1)}grab(t){this.grabbed=t}ungrab(){this.grabbed=null}isKeyUp(t){return t in this.keyStates&&this.keyStates[t]}isKeyDown(t){return t in this.keyStates&&this.keyStates[t]}process_key(t,e){this.app.requestFrameUpdate();const i=this.keyStates[t.key];e==="key_up"?this.keyStates[t.key]=!1:e==="key_down"&&(this.keyStates[t.key]=!0),this.app.emit(e,{states:this.keyStates,oldState:i,event:t})}process_touch(t,e){if(this.app.requestFrameUpdate(),this.grabbed!==null)for(let i of t.changedTouches){let s=this.grabbed.appToChild([i.clientX,i.clientY]),n=new N({pos:s,state:e,nativeObject:i,nativeEvent:t,identifier:i.identifier});this.grabbed.emit(e,n)}else for(let i of t.changedTouches){let s=new N({pos:this.app.toChild([i.clientX,i.clientY]),state:e,nativeObject:i,nativeEvent:t,identifier:i.identifier});this.app.childEmit(e,s,!0)}t.preventDefault()}process_back(t,e){location.hash==="#!/backbutton"&&(history.replaceState(null,document.title,location.pathname),this.app.childEmit("back_button",t))}process_mouse(t,e){if(this.app.requestFrameUpdate(),this.mouseev=t,t.preventDefault(),this.mouseTouchEmulation){let i={mouse_up:"touch_up",mouse_down:"touch_down",mouse_move:"touch_move",mouse_cancel:"touch_cancel"};if(t.buttons!==1&&e!=="mouse_up")return;if(this.grabbed!==null){let s=[t.clientX,t.clientY],n=this.grabbed.appToChild(s),r=new N({pos:n,state:i[e],nativeObject:t,identifier:-1});this.grabbed.emit(i[e],r)}else{let s=new N({pos:this.app.toChild([t.clientX,t.clientY]),state:i[e],nativeObject:t,identifier:-1});this.app.childEmit(i[e],s,!0)}}else this.grabbed!==null?this.grabbed.emit(e,t):this.app.childEmit(e,t,!0)}process_wheel(t,e){if(this.mouseev!=null){if(this.app.requestFrameUpdate(),this.grabbed!=null){let i=this.grabbed.appToChild([this.mouseev.clientX,this.mouseev.clientY]),s=new N({pos:i,state:e,nativeObject:t});return this.grabbed.emit(e,s)}else{let i=new N({pos:this.app.toChild([this.mouseev.clientX,this.mouseev.clientY]),state:e,nativeObject:t});this.app.childEmit(e,i,!0)}t.preventDefault()}}vibrate(t,e,i){window.navigator.vibrate(i)}}function oi(h,t,e,i){if(typeof t=="string"||t instanceof String){if(h.startsWith("on_"))return new Function("resources","parent","root",`return function(event, object, value) {${t}}`).bind(e)(x.resources,e.parent,i);if(t.trim().startsWith("(")&&t.indexOf("=>")<t.indexOf(`
`)){const l=new Function("resources","parent","root",`return ${t}`).bind(e)(x.resources,e.parent,i);return l.markupMethod=!0,l}const s=new Set;let n=0;if(t[0]!=="'"&&t[0]!=='"')for(let l of t.matchAll(/(?!\.)\b([a-z]\w*)\.([a-z_]\w*)\b/ig)){const c=l[1];c!=="this"&&c!=="parent"&&c!=="root"&&c!=="resources"&&s.add(c),n++}if(n===0)return new Function("resources",`return ${t};`)(x.resources);const r=[...s].join(", "),o=`return function (${r}) { return ${t} }`,a=new Function("resources","parent","root",o)(x.resources,e.parent,i).bind(e);return a.text=`(${r}) => ${t}`,a}return t}function ee(h,t,e){const i={},s=h.constructor.name,r={...x.rules.get(s),...t};for(let o in r){const a=r[o];if(o==="children"&&a instanceof Array){const l=[];for(let c of a)if(c instanceof Object&&"cls"in c){const[u,f]=x.classes[c.cls],d=new u;ee(d,c,e),l.push(d)}else throw Error(`Unknown child class ${c} on clsName ${s}`);h instanceof x?h.baseWidget.children=l:h.children=l}else if(o!=="cls")try{i[o]=oi(o,a,h,e)}catch{i[o]=a}}h.updateProperties(i,!1)}class ai{constructor(t,e=0,i=null){this.elapsed=0,this.timer=t,this.triggered=!1,this.callback=i,e>0&&this.tick(e)}finished(){return this.elapsed>=this.timer}tick(t){return this.elapsed>=this.timer?(this.triggered&&(this.triggered=!1),!1):(this.elapsed+=t,this.elapsed>=this.timer?(this.callback!=null&&this.callback("timer",this),this.triggered=!0,!0):!1)}reset(t=-1,e=0){this.triggered=!1,t>=0&&(this.timer=t),e>0&&this.tick(e)}}class li{constructor(){this.rules=new Map}add(t,e,i=!0){let s=this.rules.get(t);if(s&&!i)for(let n in s)s[n]=e[n];else this.rules.set(t,e)}get(t){return this.rules.get(t)??{}}remove(t){return this.rules.delete(t)}}class ci{constructor(t,e,i){this.listener=t,this.event=e,this.callback=i}}class ui{constructor(){this.connections=new Map}bind(t,e,i,s){let n=new ci(t,i,s),r=this.connections.get(e);r?r.add(n):this.connections.set(e,new Set([n]))}emit(t,e,i){const s=this.connections.get(t);if(!s)return!1;for(let n of s)if(n.event===e&&n.callback(e,t,i))return!0;return!1}disconnect(t){this.connections.delete(t);for(let e of this.connections.keys()){const i=[],s=this.connections.get(e);if(s){for(let n of s)n.listener===t&&i.push(n);i.forEach(n=>s.delete(n))}}}}class V extends H{constructor(e=null){super();m(this,"bgColor",null);m(this,"outlineColor",null);m(this,"_animation",null);m(this,"_layoutNotify",!1);m(this,"hints",{});return this.parent=null,this._processTouches=!1,this._deferredProps=null,this._children=[],this._needsLayout=!0,e!=null&&this.updateProperties(e),new Proxy(this,{set(i,s,n,r){return typeof s=="string"&&(["x","y","w","h","children","rect"].includes(s)||s[0]=="_")?Reflect.set(i,s,n,r):(Reflect.set(i,s,n,r),typeof s=="string"&&Reflect.apply(i.emit,r,[s,n]),!0)}})}set rect(e){this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this._needsLayout=!0}get rect(){return new H([this[0],this[1],this[2],this[3]])}deferredProperties(e){let i=this._deferredProps;this._deferredProps=null;for(let s in i)if(!s.startsWith("on_")&&!s.startsWith("_")&&typeof i[s]=="function"){let n=i[s],r,o;[r,o]=(n.text??n.toString()).split("=>"),r=r.replace("(","").replace(")","").split(",").map(u=>u.trim());let a=r.map(u=>e.findById(u)),l={};for(let u of r)l[u]=e.findById(u);const c=/(\w+)\.(\w+)/g;for(let u of o.matchAll(c)){let f,d;if([d,f]=u.slice(1),d==="this")this.bind(f,(p,g,S)=>{try{this[s]=n(...a)}catch(b){console.log("Dynamic binding error",this,s,b)}});else if(d in l)try{l[d].bind(f,(p,g,S)=>{try{this[s]=n(...a)}catch(b){console.log("Dynamic binding error",this,s,b)}})}catch(p){console.log(`Warning: ${d} cannot be bound on`,this,`
property`,s,`
error`,p)}}try{this[s]=n(...a)}catch(u){console.log("Dynamic binding error",this,s,u)}}}updateProperties(e,i=!0){i&&ee(this,{},this);for(let s in e)!s.startsWith("on_")&&!s.startsWith("_")&&typeof e[s]=="function"&&!("markupMethod"in e[s])?this._deferredProps=e:this[s]=e[s]}bind(e,i,s=null){x.get()._eventManager.bind(s,this,e,i)}emit(e,i){return"on_"+e in this&&this["on_"+e](e,this,i)?!0:x.get()._eventManager.emit(this,e,i)}*iter(e=!0,i=!0){if(yield this,!!e)for(let s of this._children)yield*s.iter(...arguments)}*iterParents(){this.parent!==null&&(yield this.parent,this.parent!=x.get()&&(yield*this.parent.iterParents()))}findById(e){for(let i of this.iter(!0,!1))if("id"in i&&i.id==e)return i;return null}*iterByPropertyValue(e,i){for(let s of this.iter(!0,!1))e in s&&s[e]==i&&(yield s)}getTransformRecurse(e=!1,i=null){let s=this!==i&&this.parent!==null?this.parent.getTransformRecurse(!0,i):new DOMMatrix;if(!e)return s;let n=this.getTransform();return n?s.multiply(n):s}getTransform(){return null}applyTransform(e,i=!1,s=!1,n=!1,r=null){let o=s?this.getTransformRecurse(n,r):this.getTransform();if(!o)return e;i&&(o=o.inverse());let a=o.transformPoint(new DOMPoint(e.x,e.y));return new D([a.x,a.y])}appToWidget(e,i=!0){if(this.parent){let s=this.parent.getTransformRecurse().inverse().transformPoint(new DOMPoint(e[0],e[1]));return new D([s.x,s.y])}return e}appToChild(e,i=!0){let s=this.getTransformRecurse().inverse().transformPoint(new DOMPoint(e[0],e[1]));return new D([s.x,s.y])}toChild(e){let i=this.getTransform();if(!i)return e;let s=i.inverse().transformPoint(new DOMPoint(e[0],e[1]));return new D([s.x,s.y])}addChild(e,i=-1){i==-1?this._children.push(e):this._children=[...this._children.slice(0,i),e,...this._children.slice(i)],this.emit("child_added",e),e.parent=this,this._needsLayout=!0}removeChild(e,i=!0){this._children=this.children.filter(s=>s!=e),i&&x.get()._eventManager.disconnect(e),this.emit("child_removed",e),e.parent=null,this._needsLayout=!0}get children(){return this._children}set children(e){for(let i of this._children)this.emit("child_removed",i),i.parent=null,this._needsLayout=!0;this._children=[];for(let i of e)this.addChild(i)}set x(e){this._needsLayout=!0,this[0]=e}set center_x(e){this._needsLayout=!0,this[0]=e-this[2]/2}set right(e){this._needsLayout=!0,this[0]=e-this[2]}set y(e){this._needsLayout=!0,this[1]=e}set center_y(e){this._needsLayout=!0,this[1]=e-this[3]/2}set bottom(e){this._needsLayout=!0,this[1]=e-this[3]}set w(e){this._needsLayout=!0,this[2]=e}set h(e){this._needsLayout=!0,this[3]=e}get x(){return this[0]}get center_x(){return this[0]+this[2]/2}get right(){return this[0]+this[2]}get y(){return this[1]}get center_y(){return this[1]+this[3]/2}get bottom(){return this[1]+this[3]}get w(){return this[2]}get h(){return this[3]}on_wheel(e,i,s){for(let n=this._children.length-1;n>=0;n--)if(this._children[n].emit(e,s))return!0;return!1}on_touch_down(e,i,s){let n=this.getTransform();if(n){let r=s.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];for(let a=this._children.length-1;a>=0;a--)if(this._children[a].emit(e,r))return!0}else for(let r=this._children.length-1;r>=0;r--)if(this._children[r].emit(e,s))return!0;return!1}on_touch_up(e,i,s){let n=this.getTransform();if(n){let r=s.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];for(let a=this._children.length-1;a>=0;a--)if(this._children[a].emit(e,r))return!0}else for(let r=this._children.length-1;r>=0;r--)if(this._children[r].emit(e,s))return!0;return!1}on_touch_move(e,i,s){let n=this.getTransform();if(n){let r=s.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];for(let a=this._children.length-1;a>=0;a--)if(this._children[a].emit(e,r))return!0}else for(let r=this._children.length-1;r>=0;r--)if(this._children[r].emit(e,s))return!0;return!1}on_touch_cancel(e,i,s){let n=this.getTransform();if(n){let r=s.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];for(let a=this._children.length-1;a>=0;a--)if(this._children[a].emit(e,r))return!0}else for(let r=this._children.length-1;r>=0;r--)if(this._children[r].emit(e,s))return!0;return!1}on_back_button(e,i,s){return!1}getMetric(e,i,s,n=null,r=null){let o=x.get();if(s===null)return e[i];let a=0,l="relative";for(n=n??this.w,r=r??this.h;;){if(s.constructor==String){let c=s.slice(-2);if(c=="ww"){a=+s.slice(0,-2)*e.w;break}if(c=="wh"){a=+s.slice(0,-2)*e.h;break}if(c=="aw"){a=+s.slice(0,-2)*o.dimW,l="absolute";break}if(c=="ah"){a=+s.slice(0,-2)*o.dimH,l="absolute";break}let u=s.slice(-1);if(u=="w"){a=+s.slice(0,-1)*n;break}if(u=="h"){a=+s.slice(0,-1)*r;break}a=+s;break}if(i=="w"||i=="x"||i=="center_x"||i=="right"){a=+s;break}a=+s;break}return l=="relative"&&(["x","center_x","right"].includes(i)&&(a+=this.x),["y","center_y","bottom"].includes(i)&&(a+=this.y)),a}applyHintMetric(e,i,s,n=null,r=null){let o=x.get();if(s===null)return;let a=0,l="relative";for(n=n??this.w,r=r??this.h;;){if(s.constructor==String){let c=s.slice(-2);if(c=="ww"){a=+s.slice(0,-2)*e.w;break}if(c=="wh"){a=+s.slice(0,-2)*e.h;break}if(c=="aw"){a=+s.slice(0,-2)*o.dimW,l="absolute";break}if(c=="ah"){a=+s.slice(0,-2)*o.dimH,l="absolute";break}let u=s.slice(-1);if(u=="w"){a=+s.slice(0,-1)*n;break}if(u=="h"){a=+s.slice(0,-1)*r;break}a=+s;break}if(i=="w"||i=="x"||i=="center_x"||i=="right"){a=+s*n;break}a=+s*r;break}l=="relative"&&(["x","center_x","right"].includes(i)&&(a+=this.x),["y","center_y","bottom"].includes(i)&&(a+=this.y)),e[i]=a}applyHints(e,i=null,s=null){let n=e.hints;i=i??this.w,s=s??this.h,"w"in n&&n.w!=null&&n.w.constructor==String&&n.w.slice(-2)=="wh"?(n.h!==void 0&&this.applyHintMetric(e,"h",n.h,i,s),n.w!==void 0&&this.applyHintMetric(e,"w",n.w,i,s)):(n.w!==void 0&&this.applyHintMetric(e,"w",n.w,i,s),n.h!==void 0&&this.applyHintMetric(e,"h",n.h,i,s));for(let r in n)r!="w"&&r!="h"&&this.applyHintMetric(e,r,n[r],i,s)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;for(let e of this.children)this.applyHints(e),e.layoutChildren()}_draw(e,i,s){this.draw(e,i);let n=this.getTransform();if(n){i.save(),i.transform(n.a,n.b,n.c,n.d,n.e,n.f);for(let r of this._children)r._draw(e,i,s);i.restore();return}for(let r of this._children)r._draw(e,i,s)}draw(e,i){let s=this.rect;if(i.beginPath(),i.rect(s[0],s[1],s[2],s[3]),this.bgColor!=null){const n=i.fillStyle;i.fillStyle=this.bgColor,i.fill(),i.fillStyle=n}if(this.outlineColor!=null){let n=i.lineWidth;i.lineWidth=1/e.tileSize;const r=i.strokeStyle;i.strokeStyle=this.outlineColor,i.stroke(),i.lineWidth=n,i.strokeStyle=r}}update(e,i){this._deferredProps!=null&&this.deferredProperties(e),this._animation!=null&&(this._animation.update(e,i),e.requestFrameUpdate()),this._needsLayout&&(this.layoutChildren(),e.requestFrameUpdate());for(let s of this._children)s.update(e,i)}}const I=class I extends V{static registerClass(t,e,i){I.classes[t]=[e,i]}constructor(t=null){if(I.appInstance!=null)return I.appInstance;super(),I.appInstance=this,window.app=this,this._eventManager=new ui,this.id="app",this.canvas=null,this.canvasName="canvas",this.w=-1,this.h=-1,this._baseWidget=new V({hints:{x:0,y:0,w:1,h:1}}),this._baseWidget.parent=this,this._modalWidgets=[],this._udpateActive=!0,this.pixelSize=1,this.integerTileSize=!1,this.exactDimensions=!1,this.prefDimW=32,this.prefDimH=16,this.dimW=this.prefDimW,this.dimH=this.prefDimH,this.tileSize=this.getTileScale()*this.pixelSize,this.offsetX=0,this.offsetY=0,this.shakeX=0,this.shakeY=0,this.shakeAmount=0,this.timer_tick=null,this.timers=[],this.continuousFrameUpdates=!1,this._requestedFrameUpdate=!1,t&&this.updateProperties(t)}get baseWidget(){return this._baseWidget}addTimer(t,e){let i=new ai(t,0,e);return this.timers.push(i),i}removeTimer(t){this.timers=this.timers.filter(e=>e!=t)}addModal(t){this._modalWidgets.push(t),this._needsLayout=!0}removeModal(t){this._modalWidgets=this._modalWidgets.filter(e=>e!=t)}static get(){return I.appInstance||(I.appInstance=new I),I.appInstance}start(){let t=this;this.setupCanvas(),this.inputHandler=new hi(this),window.onresize=()=>t.updateWindowSize(),this.updateWindowSize(),setTimeout(()=>this._start(),1)}_start(){this.update()}childEmit(t,e,i=!1){if(i&&this._modalWidgets.length>0)return this._modalWidgets[this._modalWidgets.length-1].emit(t,e);if(this._baseWidget.emit(t,e))return!0;for(let s of this._modalWidgets)if(s.emit(t,e))return!0;return!1}*iter(t=!0,e=!0){yield this,yield*this._baseWidget.iter(...arguments);for(let i of this._modalWidgets)yield*i.iter(...arguments)}findById(t){for(let e of this.iter(!0,!1))if("id"in e&&e.id==t)return e;return null}*iterByPropertyValue(t,e){for(let i of this.iter(!0,!1))t in i&&i[t]===e&&(yield i)}update(){this._udpateActive=!0,this._requestedFrameUpdate=!1;let t=15,e=Date.now();this.timer_tick!=null&&(t=Math.min(e-this.timer_tick,30)),(this.timers.length>0||this._needsLayout)&&this.requestFrameUpdate();for(let i of this.timers)i.tick(t);this._needsLayout&&this.layoutChildren();for(let i of I.resources.values())i.update(this,t);this._baseWidget.update(this,t);for(let i of this._modalWidgets)i.update(this,t);this.ctx&&this._draw(this,this.ctx,t),this.continuousFrameUpdates&&this.requestFrameUpdate(),this.timer_tick=e,this._requestedFrameUpdate&&window.requestAnimationFrame(()=>this.update()),this._udpateActive=!1}requestFrameUpdate(){this._requestedFrameUpdate||(this._udpateActive?this._requestedFrameUpdate=!0:(this._udpateActive=!0,window.requestAnimationFrame(()=>this.update())))}_draw(t,e,i){if(!this.canvas)return;e.clearRect(0,0,this.canvas.width,this.canvas.height),this.shakeX=0,this.shakeY=0,this.screenShake(),e.save();let s=this.getTransform();s&&e.transform(s.a,s.b,s.c,s.d,s.e,s.f),this._baseWidget._draw(t,e,i);for(let n of this._modalWidgets)n._draw(t,e,i);e.restore()}getTransform(t=!0){return new DOMMatrix().translate(this.offsetX+this.shakeX,this.offsetY+this.shakeY).scale(this.tileSize,this.tileSize)}on_prefDimW(t,e,i){this.updateWindowSize()}on_prefDimH(t,e,i){this.updateWindowSize()}on_tileSize(t,e,i){this.prefDimH<0&&this.prefDimW<0&&this.updateWindowSize()}updateWindowSize(){this.x=0,this.y=0,this.w=window.innerWidth,this.h=window.innerHeight,(this.prefDimH>=0||this.prefDimW>=0)&&(this.tileSize=this.getTileScale()),this.fitDimensionsToTileSize(this.tileSize),this.canvas!==null&&this.setupCanvas();try{screen.orientation.unlock()}catch{}this._needsLayout=!0,this.requestFrameUpdate()}getTileScale(){let t=this.h,e=this.w,i=1/this.pixelSize;return this.prefDimW<0&&this.prefDimH<0?this.tileSize>0&&(i=this.tileSize/this.pixelSize):this.prefDimW<0?i=t/this.prefDimH/this.pixelSize:this.prefDimH<0?i=e/this.prefDimW/this.pixelSize:i=Math.min(t/this.prefDimH/this.pixelSize,e/this.prefDimW/this.pixelSize),this.integerTileSize&&i>1&&(i=Math.floor(i)),i*this.pixelSize}fitDimensionsToTileSize(t){let e=this.h,i=this.w;if(this.exactDimensions){this.prefDimW<0&&this.prefDimH<0?(this.dimW=i/this.tileSize,this.dimH=e/this.tileSize):this.prefDimH<0?(this.dimW=this.prefDimW,this.dimH=e/this.tileSize):this.prefDimW<0?(this.dimW=i/this.tileSize,this.dimH=this.prefDimH):(this.dimH=this.prefDimH,this.dimW=this.prefDimW);return}this.dimH=Math.floor(e/t),this.dimW=Math.floor(i/t)}setupCanvas(){const t=document.getElementById(this.canvasName);if(!(t instanceof HTMLCanvasElement))throw"No canvas element named "+this.canvasName;this.canvas=t,this.canvas.width=this.w,this.canvas.height=this.h,this.ctx=this.canvas.getContext("2d"),this.ctx&&(this.ctx.imageSmoothingEnabled=!1,this.offsetX=Math.floor((this.w-this.tileSize*this.dimW)/2),this.offsetY=Math.floor((this.h-this.tileSize*this.dimH)/2))}applyHints(t){super.applyHints(t,this.dimW,this.dimH)}screenShake(){this.shakeAmount&&this.shakeAmount--;let t=Math.random()*Math.PI*2;this.shakeX=Math.round(Math.cos(t)*this.shakeAmount),this.shakeY=Math.round(Math.sin(t)*this.shakeAmount)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.applyHints(this._baseWidget),this._baseWidget.layoutChildren();for(let t of this._modalWidgets)this.applyHints(t),t.layoutChildren()}};m(I,"appInstance",null),m(I,"rules",new li),m(I,"resources",new Map),m(I,"classes",{});let x=I;class K extends V{constructor(e=null){super();m(this,"fontSize",null);m(this,"sizeGroup","");m(this,"clip",!1);m(this,"ignoreSizeForGroup",!1);m(this,"fontName",'"Nimbus Mono PS", "Courier New", monospace');m(this,"text","");m(this,"wrap",!1);m(this,"wrapAtWord",!0);m(this,"align","center");m(this,"valign","middle");m(this,"color","white");this._textData=null,e!==null&&this.updateProperties(e)}on_align(e,i,s){this._needsLayout=!0}on_valign(e,i,s){this._needsLayout=!0}on_wrap(e,i,s){this._needsLayout=!0}on_wrapAtWord(e,i,s){this._needsLayout=!0}on_text(e,i,s){this._needsLayout=!0}on_fontSize(e,i,s){this._needsLayout=!0}on_fontName(e,i,s){this._needsLayout=!0}layoutChildren(){let i=x.get().ctx;if(!i)return;let s=this.fontSize===null?null:this.getMetric(this,"fontSize",this.fontSize);if("h"in this.hints&&this.hints.h==null&&s!==null&&(this[3]=this.wrap?bt(i,this.text,s,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[1]:_t(i,this.text,s,this.fontName,this.align=="center",this.rect,this.color)[1]),"w"in this.hints&&this.hints.w==null&&s!==null&&(this[2]=this.wrap?bt(i,this.text,s,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[0]:_t(i,this.text,s,this.fontName,this.align=="center",this.rect,this.color)[0]),s=s===null?this.h/2:s,this.fontSize===null&&this.rect.w!==void 0){let n=0,r,o;for(;n<50;){if(this.wrap?[r,o]=bt(i,this.text,s,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord):[r,o]=_t(i,this.text,s,this.fontName,this.align=="center",this.rect,this.color),(this.h>=o||"h"in this.hints&&this.hints.h==null||s<.01)&&(this.w>=r||"w"in this.hints&&this.hints.w==null)){"h"in this.hints&&this.hints.h==null&&(this.h=o),"w"in this.hints&&this.hints.w==null&&(this.w=r);break}const a=Math.min(1.1,this.w/r,this.h/o);this.wrap?s*=a**.5:s*=a**1.1,n++}s===void 0&&(s=.001*x.get().h)}this.sizeGroup!==""?(this._bestFontSize=s,this._textData=null):this.wrap?this._textData=Xt(i,this.text,s,this.fontName,this.align,this.valign,this.rect,this.color,this.wrapAtWord):this._textData=Yt(i,this.text,s,this.fontName,this.align,this.valign,this.rect,this.color),super.layoutChildren()}sizeToGroup(e){if(this._bestFontSize===void 0)return;let i=1/0;for(let s of x.get().iterByPropertyValue("sizeGroup",this.sizeGroup))i>s._bestFontSize&&!s.ignoreSizeForGroup&&(i=s._bestFontSize);if(i>0)for(let s of x.get().iterByPropertyValue("sizeGroup",this.sizeGroup)){const n=s.clip||!s.ignoreSizeForGroup?i:s._bestFontSize;s.wrap?s._textData=Xt(e,s.text,n,s.fontName,s.align,s.valign,s.rect,s.color,s.wrapAtWord):s._textData=Yt(e,s.text,n,s.fontName,s.align,s.valign,s.rect,s.color)}}draw(e,i){if(super.draw(e,i),this.clip){i.save();const s=this.rect;i.rect(s.x,s.y,s.w,s.h),i.clip()}!this._textData&&this.sizeGroup!==""&&this.sizeToGroup(i),this._textData&&(this.wrap?ni(i,this._textData,this.color):si(i,this._textData,this.color)),this.clip&&i.restore()}}class di extends K{constructor(e=null){super();m(this,"bgColor",L([.5,.5,.5]));m(this,"selectColor",L([.7,.7,.8]));m(this,"disableColor1",L([.2,.2,.2]));m(this,"disableColor2",L([.4,.4,.4]));m(this,"disable",!1);e!==null&&this.updateProperties(e)}on_touch_down(e,i,s){return super.on_touch_down(e,i,s)?!0:!this.disable&&this.collide(s.rect)?(s.grab(this),this._touching=!0,!0):!1}on_touch_up(e,i,s){return super.on_touch_up(e,i,s)?!0:s.grabbed!=this?!1:(s.ungrab(),!this.disable&&this.collide(s.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(e,i,s){return super.on_touch_move(e,i,s)?!0:(s.grabbed==this&&!this.disable&&(this._touching=this.collide(s.rect)),!1)}draw(e,i){let s=this.bgColor,n=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(e,i),this.bgColor=s,this.color=n}}class fi extends V{constructor(e=null){super();m(this,"color",L([.8,.8,.8]));m(this,"bgColor",L([.5,.5,.5]));m(this,"selectColor",L([.7,.7,.8]));m(this,"disableColor1",L([.2,.2,.2]));m(this,"disableColor2",L([.4,.4,.4]));m(this,"disable",!1);e!==null&&this.updateProperties(e)}on_touch_down(e,i,s){return super.on_touch_down(e,i,s)?!0:!this.disable&&this.collide(s.rect)?(s.grab(this),this._touching=!0,!0):!1}on_touch_up(e,i,s){return super.on_touch_up(e,i,s)?!0:s.grabbed!=this?!1:(s.ungrab(),!this.disable&&this.collide(s.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(e,i,s){return super.on_touch_move(e,i,s)?!0:(s.grabbed==this&&!this.disable&&(this._touching=this.collide(s.rect)),!1)}draw(e,i){let s=this.bgColor,n=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(e,i),this.bgColor=s,this.color=n}}class ie extends K{constructor(e=null){super();m(this,"bgColor",L([.5,.5,.5]));m(this,"pressColor",L([.7,.7,.7]));m(this,"selectColor",L([.7,.7,.8]));m(this,"disableColor1",L([.2,.2,.2]));m(this,"disableColor2",L([.4,.4,.4]));m(this,"disable",!1);m(this,"_press",!1);m(this,"group",null);m(this,"singleSelect",!0);e!==null&&this.updateProperties(e)}get press(){return this._press}set press(e){this._press=e}on_touch_down(e,i,s){return super.on_touch_down(e,i,s)?!0:!this.disable&&this.collide(s.rect)?(s.grab(this),this._touching=!0,!0):!1}on_touch_up(e,i,s){if(s.grabbed!==this)return!1;if(s.ungrab(),this._touching=!1,this.collide(s.rect)){if(this.group===null||!this.singleSelect)this.press=!this.press;else{if(this.parent!==null)for(let n of this.parent.iterByPropertyValue("group",this.group))n!==this&&(n._press=!1);this.press=!0}return!0}return!1}on_touch_move(e,i,s){return s.grabbed===this?(this._touching=this.collide(s.rect),!0):!1}draw(e,i){let s=this.bgColor,n=this.color;this.press&&(this.bgColor=this.pressColor),this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(e,i),this.bgColor=s,this.color=n}}class mi extends V{constructor(e=null){super();m(this,"selectColor",L([.7,.7,.8]));m(this,"color",L([.6,.6,.6]));m(this,"bgColor",L([.5,.5,.5]));m(this,"disableColor1",L([.2,.2,.2]));m(this,"disableColor2",L([.3,.3,.3]));m(this,"disable",!1);m(this,"check",!1);m(this,"group",null);e!==null&&this.updateProperties(e)}on_touch_down(e,i,s){return super.on_touch_down(e,i,s)?!0:!this.disable&&this.collide(s.rect)?(s.grab(this),this._touching=!0,!0):!1}on_touch_up(e,i,s){if(super.on_touch_up(e,i,s))return!0;if(this.parent===null||s.grabbed!=this)return!1;if(s.ungrab(),!this.disable&&this.collide(s.rect)){if(this._touching=!1,this.group==null)this.check=!this.check;else{for(let n of this.parent.iterByPropertyValue("group",this.group))n!=this&&(n.check=!1);this.check=!0}return!0}return!1}on_touch_move(e,i,s){return super.on_touch_move(e,i,s)?!0:s.grabbed==this&&!this.disable?(this._touching=this.collide(s.rect),!0):!1}draw(e,i){if(this.group!=null){let r=this.rect;r.w=r.h=.5*Math.min(r.w,r.h),r.x=this.x+(this.w-r.w)/2,r.y=this.y+(this.h-r.h)/2;let o=x.get().tileSize,a=x.get().ctx;if(!a)return;a.strokeStyle=this.disable?this.disableColor1:this.bgColor,a.lineWidth=1/o,a.beginPath(),a.arc(r.center_x,r.center_y,r.w/2,0,2*Math.PI),a.stroke(),(this._touching||this.disable)&&(a.fillStyle=this.disable?this.disableColor1:this.selectColor,a.fill()),this.check&&(a.fillStyle=this.disable?this.disableColor2:this.color,a.beginPath(),a.arc(r.center_x,r.center_y,r.w/3,0,2*Math.PI),a.fill());return}let s=this.rect;s.w=s.h=.5*Math.min(s.w,s.h),s.x=this.x+(this.w-s.w)/2,s.y=this.y+(this.h-s.h)/2;let n=e.tileSize;i.beginPath(),i.strokeStyle=this.bgColor,this.disable&&(i.strokeStyle=this.disableColor1),i.lineWidth=1/n,i.rect(s[0],s[1],s[2],s[3]),i.stroke(),this._touching&&(i.fillStyle=this.selectColor,i.fill()),this.check&&(i.strokeStyle=this.color,this.disable&&(i.strokeStyle=this.disableColor2),i.beginPath(),i.lineWidth=s.w/5,i.moveTo(s.x,s.y),i.lineTo(s.right,s.bottom),i.moveTo(s.right,s.y),i.lineTo(s.x,s.bottom),i.stroke())}}class pi extends V{constructor(e=null){super();m(this,"selectColor",L([.7,.7,.8]));m(this,"color",L([.6,.6,.6]));m(this,"bgColor",L([.4,.4,.4]));m(this,"disableColor1",L([.2,.2,.2]));m(this,"disableColor2",L([.3,.3,.3]));m(this,"disable",!1);m(this,"min",0);m(this,"max",1);m(this,"curMax",1);m(this,"unboundedStopMultiple",10);m(this,"exponentialSlider",!1);m(this,"step",null);m(this,"orientation","horizontal");m(this,"value",0);m(this,"sliderSize",.2);e!==null&&this.updateProperties(e)}setValue(e){let i=this.max??this.curMax,s=0;this.orientation=="horizontal"&&(s=lt((e.rect.x-this.x-this.w*this.sliderSize/2)/(this.w*(1-this.sliderSize)),0,1)),this.orientation=="vertical"&&(s=lt((e.rect.y-this.y-this.h*this.sliderSize/2)/(this.h*(1-this.sliderSize)),0,1)),this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?s=s>.5?i/this.unboundedStopMultiple+(s-.5)/.5*(i-i/this.unboundedStopMultiple):this.min+s/.5*(i/this.unboundedStopMultiple-this.min):s=this.min+(i-this.min)*s,this.step!=null&&(s=Math.round(s/this.step)*this.step),this.value=s}on_touch_down(e,i,s){return super.on_touch_down(e,i,s)?!0:!this.disable&&this.collide(s.rect)?(s.grab(this),this._touch=!0,this.setValue(s),!0):!1}updateMax(){this.max===null&&(this.curMax=this.unboundedStopMultiple*this.value)}on_touch_up(e,i,s){return s.grabbed!=this?super.on_touch_up(e,i,s):(s.ungrab(),!this.disable&&this.collide(s.rect)&&(this._touching=!1,this.setValue(s)),this.updateMax(),!0)}on_touch_move(e,i,s){return s.grabbed!==this?super.on_touch_move(e,i,s):(this.disable||(this._touching=this.collide(s.rect),this.setValue(s)),!1)}draw(e,i){let s=e.tileSize,n=this.rect;if(this.orientation=="horizontal"){n.w-=this.sliderSize*this.w,n.x+=this.sliderSize/2*this.w;let r=Math.min(this.sliderSize/2*this.w,this.h/2)/2;i.strokeStyle=this.disable?this.disableColor1:this.bgColor,i.beginPath(),i.lineWidth=4/s,i.moveTo(n.x,n.center_y),i.lineTo(n.right,n.center_y),i.stroke();let o=this.max??this.curMax,a;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?a=this.value>o/this.unboundedStopMultiple?(.5+.5*(this.value-o/this.unboundedStopMultiple)/(o-o/this.unboundedStopMultiple))*n.w:.5*(this.value-this.min)/(o/this.unboundedStopMultiple-this.min)*n.w:a=(this.value-this.min)/(o-this.min)*n.w,i.strokeStyle=this.disable?this.disableColor2:this.bgColor,i.beginPath(),i.arc(n.x+a,n.center_y,r,0,2*Math.PI),i.stroke(),i.fillStyle=this.color,(this._touching||this.disable)&&(i.fillStyle=this.disable?this.disableColor1:this.selectColor),i.fill()}if(this.orientation=="vertical"){n.h-=this.sliderSize*this.h,n.y+=this.sliderSize/2*this.h;let r=Math.min(this.sliderSize/2*this.h,this.w/2)/2;i.strokeStyle=this.disable?this.disableColor1:this.bgColor,i.beginPath(),i.lineWidth=4/s,i.moveTo(n.center_x,n.y),i.lineTo(n.center_x,n.bottom),i.stroke();let o=this.max??this.curMax,a;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?a=this.value>o/this.unboundedStopMultiple?(.5+.5*(this.value-o/this.unboundedStopMultiple)/(o-o/this.unboundedStopMultiple))*n.h:.5*(this.value-this.min)/(o/this.unboundedStopMultiple-this.min)*n.h:a=(this.value-this.min)/(o-this.min)*n.h,i.strokeStyle=this.disable?this.disableColor2:this.bgColor,i.beginPath(),i.arc(n.center_x,n.y+a,r,0,2*Math.PI),i.stroke(),i.fillStyle=this.color,(this._touching||this.disable)&&(i.fillStyle=this.disable?this.disableColor1:this.selectColor),i.fill()}}}class yi extends K{constructor(e={}){super();m(this,"_activeDOMInput",null);m(this,"focus",!0);m(this,"disable",!1);m(this,"_inputSanitizer");this._textData=null,e!==null&&this.updateProperties(e)}on_touch_down(e,i,s){return super.on_touch_down(e,i,s)?!0:!this.disable&&this.collide(s.rect)?(s.grab(this),this._touching=!0,!0):(this.clearDOM(),!1)}on_touch_up(e,i,s){return super.on_touch_up(e,i,s)?!0:s.grabbed!=this?!1:!this.disable&&this.collide(s.rect)?(this._touching=!1,this.addDOMInput(),!0):(this.clearDOM(),!1)}on_layout(e,i,s){this.clearDOM()}DOMInputRect(){let e=this.rect,i=this.getTransformRecurse(),s=new H,n=i.transformPoint(new DOMPoint(e.x,e.y)),r=i.transformPoint(new DOMPoint(e.right,e.bottom));return[s.x,s.y]=[n.x,n.y],[s.w,s.h]=[r.x,r.y],s.w-=s.x,s.h-=s.y,s}addDOMInput(){if(!this._textData)return;x.get();let e=document.getElementById("eskvapp");if(!e)return;let i=this.wrap?"textarea":"input",s=document.createElement(i);if(!(s instanceof HTMLInputElement)&&!(s instanceof HTMLTextAreaElement))return;let n,r=this.DOMInputRect(),o=this.color!=null?this.color:"white",a=this.bgColor!=null?this.bgColor:"black";s.style.color=o,n=this._textData.size/this.h*r.h/this._textData.outText.length,i=="textarea"&&this._textData.outText.length,s.value=this.text,n=(Math.floor(n*100)/100).toString()+"px",s.style.fontSize=n,s.style.backgroundColor=a,s.style.top=(Math.floor(r.y*100)/100).toString()+"px",s.style.left=(Math.floor(r.x*100)/100).toString()+"px",s.style.width=(Math.floor(r.w*100)/100).toString()+"px",s.style.height=(Math.floor(r.h*100)/100).toString()+"px",s.style.fontFamily=this.fontName,this._activeDOMInput=s,e.appendChild(s),s.addEventListener("focusout",l=>this.clearDOM()),s.focus(),s.select(),this.focus=!0}clearDOM(){if(this._activeDOMInput!=null){this.text=this._inputSanitizer?this._inputSanitizer(this._activeDOMInput.value,this):this._activeDOMInput.value;let e=this._activeDOMInput;this._activeDOMInput=null,e.remove(),this.focus=!1,this._needsLayout=!0;let i=x.get().inputHandler;(i==null?void 0:i.grabbed)===this&&i.ungrab()}}layoutChildren(){if(super.layoutChildren(),this._activeDOMInput!=null){let e=this.DOMInputRect(),i=this._activeDOMInput;i.style.top=(Math.floor(e.y*100)/100).toString()+"px",i.style.left=(Math.floor(e.x*100)/100).toString()+"px",i.style.width=(Math.floor(e.w*100)/100).toString()+"px",i.style.height=(Math.floor(e.h*100)/100).toString()+"px"}}}class _i extends V{constructor(e=null){super();m(this,"bgColor",null);m(this,"outlineColor",null);m(this,"src",null);m(this,"lockAspect",!0);m(this,"scaleToFit",!0);m(this,"antiAlias",!0);m(this,"angle",0);m(this,"anchor","center");m(this,"mirror",!1);this.image=new Image,e!==null&&this.updateProperties(e),this.src&&(this.image.src=this.src)}on_src(e,i,s){this.src?this.image.src=this.src:this.image.src=""}layoutChildren(){this._layoutNotify&&this.emit("layout",null);let e=x.get();"w"in this.hints&&this.hints.w==null&&(this[2]=this.image.width/e.tileSize),"h"in this.hints&&this.hints.h==null&&(this[3]=this.image.height/e.tileSize),this._needsLayout=!1,super.layoutChildren()}draw(e,i){if(super.draw(e,i),!this.image.complete||this.image.naturalHeight==0)return;let s=this.rect;if(this.scaleToFit||(s.x+=s.w/2-this.image.width/2/e.tileSize,s.y+=s.h/2-this.image.height/2/e.tileSize,s.w=this.image.width/e.tileSize,s.h=this.image.height/e.tileSize),this.lockAspect){let r=this.image.height/this.image.width,o=s.h/s.w,a=s.h,l=s.w;r<o&&(a=s.w*r),r>o&&(l=s.h/r),s.x+=s.w/2-l/2,s.y+=s.h/2-a/2,s.w=l,s.h=a}i.save(),i.imageSmoothingEnabled=this.antiAlias;let n=this.anchor;n=="center"?n=[s.w/2,s.h/2]:n=[n[0]*s.w,n[1]*s.h],this.mirror&&i.scale(-1,1),i.translate(s.x+n[0],s.y+n[1]),this.angle!=0&&i.rotate(this.angle),i.translate(-n[0],-n[1]),i.drawImage(this.image,0,0,this.image.width,this.image.height,0,0,s.w,s.h),i.restore()}}class Mt extends V{constructor(e=null){super();m(this,"spacingX",0);m(this,"spacingY",0);m(this,"paddingX",0);m(this,"paddingY",0);m(this,"orientation","vertical");m(this,"order","forward");e!==null&&this.updateProperties(e)}*iterChildren(){if(this.order==="forward")for(let e of this._children)yield e;else for(let e=this._children.length-1;e>=0;e--)yield this._children[e]}on_numX(e,i,s){this._needsLayout=!0}on_numY(e,i,s){this._needsLayout=!0}on_spacingX(e,i,s){this._needsLayout=!0}on_spacingY(e,i,s){this._needsLayout=!0}on_paddingX(e,i,s){this._needsLayout=!0}on_paddingY(e,i,s){this._needsLayout=!0}on_orientation(e,i,s){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let e=this.getMetric(this,"spacingX",this.spacingX),i=this.getMetric(this,"spacingY",this.spacingY),s=this.getMetric(this,"paddingX",this.paddingX),n=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation==="vertical"){let r=this.children.length,o=this.h-i*(r-1)-2*n,a=this.w-2*s,l=0;for(let p of this.iterChildren())p.w=a,this.applyHints(p,a,o),"h"in p.hints&&(p.hints.h===null&&p.layoutChildren(),l+=p.h,r--);let c=(o-l)/r,u=a;(r===0&&o>0||c<0)&&(n=(o-l)/2);let f=this.y+n,d=this.x+s;for(let p of this.iterChildren())p.y=f,"w"in p.hints||(p.w=u),"h"in p.hints||(p.h=c),!("x"in p.hints)&&!("center_x"in p.hints)&&!("right"in p.hints)&&(p.x=d,a!==p.w&&(p.x+=(a-p.w)/2)),p.layoutChildren(),f+=i+p.h;if(r===0&&"h"in this.hints&&this.hints.h===null){const p=this[3];this[3]=f+2*n-this.y,Math.abs(p-this[3])>1e-6&&(x.get()._needsLayout=!0)}return}if(this.orientation==="horizontal"){let r=this.children.length,o=this.h-2*n,a=this.w-e*(r-1)-2*s,l=0;for(let p of this.iterChildren())p.h=o,this.applyHints(p,a,o),"w"in p.hints&&(p.hints.w===null&&p.layoutChildren(),l+=p.w,r--);let c=o,u=(a-l)/r;(r===0&&a>0||u<0)&&(s=(a-l)/2);let f=this.y+n,d=this.x+s;for(let p of this.iterChildren())p.x=d,"w"in p.hints||(p.w=u),"h"in p.hints||(p.h=c),!("y"in p.hints)&&!("center_y"in p.hints)&&!("bottom"in p.hints)&&(p.y=f,o!==p.h&&(p.y+=(o-p.h)/2)),p.layoutChildren(),d+=e+p.w;if(r==0&&"w"in this.hints&&this.hints.w==null){const p=this[2];this[2]=d+2*s-this.x,Math.abs(p-this[2])>1e-6&&(x.get()._needsLayout=!0)}}}}class se extends V{constructor(e=null){super();m(this,"activePage",0);e!==null&&this.updateProperties(e)}on_wheel(e,i,s){const n=this.children[this.activePage]??void 0;return!!(n!==void 0&&n.emit(e,s))}on_touch_down(e,i,s){let n=this.getTransform();if(n){let r=s.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];const a=this.children[this.activePage]??void 0;if(a!==void 0&&a.emit(e,r))return!0}else{const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(e,s))return!0}return!1}on_touch_up(e,i,s){let n=this.getTransform();if(n){let r=s.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];const a=this.children[this.activePage]??void 0;if(a!==void 0&&a.emit(e,r))return!0}else{const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(e,s))return!0}return!1}on_touch_move(e,i,s){let n=this.getTransform();if(n){let r=s.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];const a=this.children[this.activePage]??void 0;if(a!==void 0&&a.emit(e,r))return!0}else{const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(e,s))return!0}return!1}on_touch_cancel(e,i,s){let n=this.getTransform();if(n){let r=s.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];const a=this.children[this.activePage]??void 0;if(a!==void 0&&a.emit(e,r))return!0}else{const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(e,s))return!0}return!1}on_activePage(e,i,s){this._needsLayout=!0}_draw(e,i,s){this.draw(e,i);let n=this.getTransform();if(n){i.save(),i.transform(n.a,n.b,n.c,n.d,n.e,n.f);let o=this.children[this.activePage]??void 0;o!==void 0&&o._draw(e,i,s),i.restore();return}let r=this.children[this.activePage]??void 0;r!==void 0&&r._draw(e,i,s)}}class bi extends se{constructor(e=null){super();m(this,"tabHeightHint","1");m(this,"tabGroupName","tabbedNotebookGroup");this.buttonBox=new Mt({orientation:"horizontal",hints:{h:this.tabHeightHint,w:null}}),this.buttonScroller=new ne({id:"_scrollview",hints:{h:this.tabHeightHint,w:1},children:[this.buttonBox]}),this._children=[this.buttonScroller],this.buttonScroller.parent=this,e!==null&&this.updateProperties(e),this.updateButtons()}on_tabHeightHint(e,i,s){this.buttonBox.hints.h=this.tabHeightHint}on_child_added(e,i,s){this.updateButtons()}on_child_removed(e,i,s){this.updateButtons()}on_wheel(e,i,s){const n=this._children[0]??void 0;if(n!==void 0&&n.emit(e,s))return!0;const r=this.children[this.activePage]??void 0;return!!(r!==void 0&&r.emit(e,s))}on_touch_down(e,i,s){let n=this.getTransform();if(n){let r=s.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];const a=this._children[0]??void 0;if(a!==void 0&&a.emit(e,r))return!0;const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(e,r))return!0}else{const r=this._children[0]??void 0;if(r!==void 0&&r.emit(e,s))return!0;const o=this.children[this.activePage]??void 0;if(o!==void 0&&o.emit(e,s))return!0}return!1}on_touch_up(e,i,s){let n=this.getTransform();if(n){let r=s.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];const a=this._children[0]??void 0;if(a!==void 0&&a.emit(e,r))return!0;const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(e,r))return!0}else{const r=this._children[0]??void 0;if(r!==void 0&&r.emit(e,s))return!0;const o=this.children[this.activePage]??void 0;if(o!==void 0&&o.emit(e,s))return!0}return!1}on_touch_move(e,i,s){let n=this.getTransform();if(n){let r=s.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];const a=this._children[0]??void 0;if(a!==void 0&&a.emit(e,r))return!0;const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(e,r))return!0}else{const r=this._children[0]??void 0;if(r!==void 0&&r.emit(e,s))return!0;const o=this.children[this.activePage]??void 0;if(o!==void 0&&o.emit(e,s))return!0}return!1}on_touch_cancel(e,i,s){let n=this.getTransform();if(n){let r=s.copy(),o=n.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[o.x,o.y];const a=this._children[0]??void 0;if(a!==void 0&&a.emit(e,r))return!0;const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(e,r))return!0}else{const r=this._children[0]??void 0;if(r!==void 0&&r.emit(e,s))return!0;const o=this.children[this.activePage]??void 0;if(o!==void 0&&o.emit(e,s))return!0}return!1}get children(){return this._children.slice(1)}set children(e){for(let i of this._children.slice(1))this.emit("child_removed",i),i.parent=null,this._needsLayout=!0,this.updateButtons();this._children=this._children.slice(0,1);for(let i of e)this.addChild(i)}updateButtons(){this.buttonBox.children=[];let e=0;for(let i of this.children){const s=new ie({text:i.name??String(e+1),group:this.tabGroupName,singleSelect:!0,press:this.activePage===e,fontSize:"0.5",hints:{h:null,w:null}});s.bind("press",(n,r,o)=>{this.activePage=this.buttonBox.children.findIndex(a=>a===r)}),this.buttonBox.addChild(s),e++}}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;const e=this._children[0];this.applyHints(e),e.x=this.x,e.y=this.y,e.layoutChildren();const i=this.h-e.h,s=this.w;for(let n of this.children)n.y=this.y+e.h,n.x=this.x,n.w=s,n.h=i,n.layoutChildren()}_draw(e,i,s){this.draw(e,i);let n=this.getTransform();if(n){i.save(),i.transform(n.a,n.b,n.c,n.d,n.e,n.f);let a=this._children[0]??void 0;a!==void 0&&a._draw(e,i,s);let l=this.children[this.activePage]??void 0;l!==void 0&&l._draw(e,i,s),i.restore();return}let r=this._children[0]??void 0;r!==void 0&&r._draw(e,i,s);let o=this.children[this.activePage]??void 0;o!==void 0&&o._draw(e,i,s)}}class wi extends V{constructor(e=null){super();m(this,"numX",1);m(this,"numY",1);m(this,"spacingX",0);m(this,"spacingY",0);m(this,"paddingX",0);m(this,"paddingY",0);m(this,"orientation","horizontal");e!==null&&this.updateProperties(e)}on_numX(e,i,s){this._needsLayout=!0}on_numY(e,i,s){this._needsLayout=!0}on_spacingX(e,i,s){this._needsLayout=!0}on_spacingY(e,i,s){this._needsLayout=!0}on_paddingX(e,i,s){this._needsLayout=!0}on_paddingY(e,i,s){this._needsLayout=!0}on_orientation(e,i,s){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let e=this.getMetric(this,"spacingX",this.spacingX),i=this.getMetric(this,"spacingY",this.spacingY),s=this.getMetric(this,"paddingX",this.paddingX),n=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation=="horizontal"){let r=this.numX,o=Math.ceil(this.children.length/this.numX),a=this.h-i*(o-1)-2*n,l=this.w-e*(r-1)-2*s,c=new Array(r).fill(0),u=new Array(o).fill(0),f=0,d=0,p=0;for(let T of this.children)this.applyHints(T,l,a),"w"in T.hints&&(c[d]=Math.max(T.w,c[d])),"h"in T.hints&&(u[f]=Math.max(T.h,u[f])),(p+1)%r==0?(f++,d=0):d++,p++;let g=0,S=0,b=0,y=0;for(let T of c)g+=T,T>0&&b++;for(let T of u)S+=T,T>0&&y++;let w=o>y?(a-S)/(o-y):0,v=r>b?(l-g)/(r-b):0,_=this.y+n,M=this.x+s;f=0,d=0;for(let T=0;T<this.children.length;T++){let A=this.children[T],P=c[d]==0?v:c[d],k=u[f]==0?w:u[f];"w"in A.hints||(A.w=P),"h"in A.hints||(A.h=k),A.x=M,A.y=_,A.layoutChildren(),(T+1)%r==0?(M=this.x+s,_+=i+k,d=0,f++):(M+=e+P,d++)}return}else{let r=Math.ceil(this.children.length/this.numY),o=this.numY,a=this.h-i*(o-1)-2*n,l=this.w-e*(r-1)-2*s,c=new Array(r).fill(0),u=new Array(o).fill(0),f=0,d=0,p=0;for(let T of this.children)this.applyHints(T,l,a),"w"in T.hints&&(c[d]=Math.max(T.w,c[d])),"h"in T.hints&&(u[f]=Math.max(T.h,u[f])),(p+1)%o==0?(d++,f=0):f++,p++;let g=0,S=0,b=0,y=0;for(let T of c)g+=T,T>0&&b++;for(let T of u)S+=T,T>0&&y++;let w=o>y?(a-S)/(o-y):0,v=r>b?(l-g)/(r-b):0,_=this.y+n,M=this.x+s;f=0,d=0;for(let T=0;T<this.children.length;T++){let A=this.children[T],P=c[d]==0?v:c[d],k=u[f]==0?w:u[f];"w"in A.hints||(A.w=P),"h"in A.hints||(A.h=k),A.x=M,A.y=_,A.layoutChildren(),(T+1)%o==0?(_=this.y+n,M+=e+P,f=0,d++):(_+=i+k,f++)}}}}class ne extends V{constructor(e=null){super();m(this,"_scrollX",0);m(this,"_scrollY",0);m(this,"scrollX",0);m(this,"scrollY",0);m(this,"scrollW",!0);m(this,"scrollH",!0);m(this,"wAlign","center");m(this,"hAlign","top");m(this,"uiZoom",!0);m(this,"uiMove",!0);m(this,"zoom",1);m(this,"vel",null);m(this,"velCutoff",1e-5);m(this,"velDecay",.95);m(this,"unboundedH",!1);m(this,"unboundedW",!1);m(this,"_zoomCenter",null);e!==null&&this.updateProperties(e),this._processTouches=!0,this._oldTouch=null,this._lastDist=null}on_child_added(e,i,s){this.children.length==1&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0,s.bind("rect",(n,r,o)=>this._needsLayout=!0),s.bind("w",(n,r,o)=>this._needsLayout=!0),s.bind("h",(n,r,o)=>this._needsLayout=!0))}on_child_removed(e,i,s){this.children.length==0&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.children[0][0]=0,this.children[0][1]=0,this.scrollW||(this.children[0][2]=this.w),this.scrollH||(this.children[0][3]=this.h);for(let e of this.children)e.layoutChildren()}fitToClient(){this.zoom=Math.min(this.w/this.children[0].w,this.h/this.children[0].h),this.scrollX=.5*this.scrollableW,this.scrollY=.5*this.scrollableH}on_uiZoom(e,i,s){this._needsLayout=!0}on_hAlign(e,i,s){this._needsLayout=!0}on_vAlign(e,i,s){this._needsLayout=!0}*iter(e=!0,i=!0){if(yield this,!!e)if(i)for(let s of this._children)this.contains(s)&&(yield*s.iter(...arguments));else for(let s of this._children)yield*s.iter(...arguments)}on_scrollW(e,i,s){this._needsLayout=!0,this.scrollX=0}on_scrollH(e,i,s){this._needsLayout=!0,this.scrollY=0}on_scrollX(e,i,s){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedW){this._scrollX=this.scrollX;return}let n=0;switch(this.wAlign){case"center":n=.5*this.scrollableW;break;case"right":n=1*this.scrollableW}this._scrollX=this.scrollableW<=0||this.scrollableW>=this.children[0].w?n:s,this._scrollX=lt(s,0,this.scrollableW)}on_scrollY(e,i,s){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedH){this._scrollY=this.scrollY;return}let n=0;switch(this.hAlign){case"middle":n=.5*this.scrollableH;break;case"bottom":n=1*this.scrollableH}this._scrollY=this.scrollableH<=0||this.scrollableH>=this.children[0].h?n:s,this._scrollY=lt(s,0,this.scrollableH)}update(e,i){if(super.update(e,i),this.vel!==null){this.scrollX+=this.vel.x*i,this.scrollY+=this.vel.y*i,this.vel=this.vel.scale(this.velDecay**(i/30));let s=this.vel.abs();s.x<=this.velCutoff/this.zoom&&s.y<=this.velCutoff/this.zoom&&(this.vel=null)}}getTransform(){const e=x.get().tileSize;return new DOMMatrix().translate(Math.floor((this.x-this._scrollX*this.zoom)*e)/e,Math.floor((this.y-this._scrollY*this.zoom)*e)/e).scale(this.zoom,this.zoom)}on_touch_down(e,i,s){this.vel=null;let n=s.rect;if(this._lastDist=null,this.collide(n)){let r=Date.now(),o=s.asChildTouch(this);return this._oldTouch=[o.x,o.y,o.identifier,r,null],super.on_touch_down(e,i,s)||s.grab(this),!0}return!1}on_touch_up(e,i,s){if(s.grabbed!==this)return!1;if(this._oldTouch!=null){let n=this._oldTouch[4],r=new D([this._oldTouch[0],this._oldTouch[1]]),o=s.asChildTouch(this),a=Math.max(Date.now()-this._oldTouch[3],1),l=this.scrollableW>0||this.unboundedW?(o.x-r.x)/a:0,c=this.scrollableH>0||this.unboundedH?(o.y-r.y)/a:0;this.vel=new D([-l,-c]),n&&(this.vel=this.vel.add(n).scale(.5))}return this._oldTouch=null,this._lastDist=null,this._zoomCenter=null,s.ungrab(),!1}on_touch_move(e,i,s){if(s.grabbed!==this)return!1;let n=s.rect;if(this.collide(n)){let r=s.asChildTouch(this);if((this.uiMove&&s.nativeEvent==null||s.nativeEvent instanceof TouchEvent&&s.nativeEvent.touches.length==1)&&this._oldTouch!=null&&s.identifier==this._oldTouch[2]){this.scrollW&&(this.scrollX=this.scrollableW==0?0:this._scrollX+(this._oldTouch[0]-r.x)),this.scrollH&&(this.scrollY=this.scrollableH==0?0:this._scrollY+(this._oldTouch[1]-r.y));let o=s.asChildTouch(this),a=this._oldTouch,l=Date.now(),c=new D([0,0]),u=new D([0,0]);if(a!=null){let d=Math.max(l-a[3],1),p=this.scrollableW>0||this.unboundedW?(o.x-r.x)/d:0,g=this.scrollableH>0||this.unboundedH?(o.y-r.y)/d:0;c=new D([p,g]),u=a[4]!==null?a[4]:u}let f=c.abs().sum()===0?c:c.add(u).scale(.5);this._oldTouch=[o.x,o.y,s.identifier,l,f]}if(this.uiZoom&&s.nativeEvent&&s.nativeEvent instanceof TouchEvent&&s.nativeEvent.touches.length==2){let o=s.nativeEvent.touches[0],a=s.nativeEvent.touches[1],l=ri([o.clientX,o.clientY],[a.clientX,a.clientY]);if(this._lastDist!=null){let c=this._scrollX+this.w/this.zoom/2,u=this._scrollY+this.h/this.zoom/2,f=[o.clientX,o.clientY],d=[a.clientX,a.clientY],p=this.appToChild(f),g=this.appToChild(d),S=[(p[0]+g[0])/2,(p[1]+g[1])/2];this._zoomCenter===null&&(this._zoomCenter=new D(S));let b=this.zoom*l/this._lastDist,y=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(b,y);let w=this.appToChild(f),v=this.appToChild(d),_=[(w[0]+v[0])/2,(w[1]+v[1])/2];this.scrollX=c+S[0]-_[0]-this.w/this.zoom/2,this.scrollY=u+S[1]-_[1]-this.h/this.zoom/2}this._lastDist=l}}return!1}on_touch_cancel(e,i,s){return this._lastDist=null,s.grabbed===this?(s.ungrab(),!0):!!super.on_touch_cancel(e,i,s)}on_wheel(e,i,s){let n=x.get();if(!n.inputHandler)return!0;let r=this._scrollX+this.w/this.zoom/2,o=this._scrollY+this.h/this.zoom/2,a=s.nativeObject;if(!this.collide(s.rect)&&(!this.unboundedW||!this.unboundedH)||!(a instanceof WheelEvent))return!1;if(this.uiZoom&&n.inputHandler.isKeyDown("Control")){let l=s.asChildTouch(this);l.pos[0],l.pos[1];let c=this.zoom*Math.exp(-a.deltaY/n.h),u=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(c,u);let f=s.asChildTouch(this);return f.pos[0],f.pos[1],this.scrollX=this.scrollableW==0&&!this.unboundedW?0:r-this.w/this.zoom/2,this.scrollY=this.scrollableH==0&&!this.unboundedH?0:o-this.h/this.zoom/2,this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}else{if(this.uiMove&&this.scrollW&&n.inputHandler.isKeyDown("Shift"))return this.scrollX+=this.scrollableW==0&&!this.unboundedW?0:this.w/this.zoom*(a.deltaY/n.w),this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),!0;if(this.uiMove&&this.scrollH)return this.scrollY+=this.scrollableH==0&&!this.unboundedH?0:this.h/this.zoom*(a.deltaY/n.h),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}return!1}get scrollableW(){return this.children.length==0?0:this.unboundedW?this.children[0].w-this.w/this.zoom:Math.max(this.children[0].w-this.w/this.zoom,0)}get scrollableH(){return this.children.length==0?0:this.unboundedH?this.children[0].h-this.h/this.zoom:Math.max(this.children[0].h-this.h/this.zoom,0)}_draw(e,i,s){this.draw(e,i);let n=this.rect;n[0]=Math.floor(n[0]*e.tileSize*e.pixelSize)/(e.tileSize*e.pixelSize),n[1]=Math.floor(n[1]*e.tileSize*e.pixelSize)/(e.tileSize*e.pixelSize),n[2]=Math.floor(n[2]*e.tileSize*e.pixelSize)/(e.tileSize*e.pixelSize),n[3]=Math.floor(n[3]*e.tileSize*e.pixelSize)/(e.tileSize*e.pixelSize),i.save(),i.beginPath(),i.rect(n[0],n[1],n[2],n[3]),i.clip();let r=this.getTransform();r&&i.transform(r.a,r.b,r.c,r.d,r.e,r.f),this.children[0]._draw(e,i,s),i.restore()}}class gi extends Mt{constructor(e=null){super();m(this,"closeOnTouchOutside",!0);m(this,"bgColor","slate");m(this,"outlineColor","gray");m(this,"dim",!0);m(this,"dimScale",.8);e!==null&&this.updateProperties(e)}get visible(){return x.get()._modalWidgets.indexOf(this)>=0}popup(){if(this.parent==null){let e=x.get();return this.parent=e,e.addModal(this),!0}return!1}close(e=0){if(this.parent!=null){this.emit("close",e);let i=x.get();return this.parent=null,i.removeModal(this),!0}return!1}on_touch_down(e,i,s){return this.closeOnTouchOutside&&!this.collide(s.rect)?(this.close(),!0):super.on_touch_down(e,i,s)}draw(e,i){if(this.dim){let s=x.get().baseWidget.rect,n=x.get().ctx;if(!n)return;n.fillStyle="rgba(0,0,0,"+this.dimScale+")",n.rect(s[0],s[1],s[2],s[3]),n.fill(),super.draw(e,n)}}}class vi extends Array{constructor(t,e){super();for(let i=0;i<t.length;++i)e[i]?this.push(t[i],e[i][0],e[i][1]):this.push(t[i],0,0)}*iter(){for(let t=0;t<this.length/3;t++)yield[this[t*3],this[t*3+1],this[t*3+2]]}}class Ti extends V{constructor(e={}){super();m(this,"spriteSheet",null);m(this,"frames",[]);m(this,"timePerFrame",30);m(this,"timeLeft",0);m(this,"activeFrame",0);m(this,"id","");m(this,"facing",0);m(this,"flipX",!1);m(this,"flipY",!1);m(this,"oneShot",!1);e&&this.updateProperties(e)}update(e,i){if(super.update(e,i),this.timeLeft-=i,this.timeLeft<=0){if(this.oneShot&&this.activeFrame===this.frames.length-1){this.timeLeft=1/0,this.emit("animationComplete",this.activeFrame);return}this.activeFrame++,this.activeFrame>=this.frames.length&&(this.activeFrame=0),this.timeLeft+=this.timePerFrame}this.frames.length>0&&this.timeLeft!==1/0&&e.requestFrameUpdate()}restart(){this.activeFrame=0,this.timeLeft=this.timePerFrame}on_frames(e,i,s){this.restart()}get frame(){return this.frames[this.activeFrame]??-1}draw(e,i){var r;if(this.spriteSheet===null||!((r=this.spriteSheet.sheet)!=null&&r.complete))return;const s=Math.floor(this.x*this.spriteSheet.spriteSize)/this.spriteSheet.spriteSize,n=Math.floor(this.y*this.spriteSheet.spriteSize)/this.spriteSheet.spriteSize;if(i.translate(s,n),i.scale(this.w,this.h),this.frame instanceof vi)for(let[o,a,l]of this.frame.iter())this.spriteSheet.drawIndexed(i,o,0,0,this.facing,this.flipX,a,l);else this.spriteSheet.drawIndexed(i,this.frame,0,0,this.facing,this.flipX);i.scale(1/this.w,1/this.h),i.translate(-s,-n)}}class re extends V{constructor(t={}){super(),this.defaultValue=-1,this._data=new ct,this._vLayer=null,this._aLayer=null,this._cacheTileDim=new D,this.tileDim=new D,this.hints={w:null,h:null},this.spriteSheet=null,this.clipRegion=null,this.alphaValue=.5,this.useCache=!0,t&&this.updateProperties(t)}serialize(){const t={};return t._data=this._data.slice(),t.tileDim=this.tileDim.slice(),t.spriteSheet=Array(...x.resources.keys()).find(e=>x.resources[e]===this.spriteSheet)??null,t}get(t){return this._data.get(t)}set(t,e){this._data.set(t,e),this._data._cacheData=null}get data(){return this._data}deserialize(t){this.tileDim=new D(t.tileDim??[0,0]);const e=t._data;for(let i=0;i<e.length;i++)this._data[i]=e[i];this.spriteSheet=x.resources[t.spriteSheet]??null,this._data._cacheData=null}on_tileDim(t,e,i){this.resizeData(),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new D(this.tileDim)}resizeData(){let t=[];for(let i=0;i<this._cacheTileDim[1];i++)for(let s=0;s<this._cacheTileDim[0];s++)t.push(this.get([s,i]));this._data.tileDim=new D(this.tileDim),this._data.length=this.tileDim[0]*this.tileDim[1],this._data.fill(this.defaultValue);let e=0;for(let i=0;i<this._cacheTileDim[1];i++)for(let s=0;s<this._cacheTileDim[0];s++)s<this.tileDim[0]&&i<this.tileDim[1]&&this.set([s,i],t[e]),++e;this._data._cacheData=null}draw(t,e){if(super.draw(t,e),this.spriteSheet===null||!this.spriteSheet.sheet.complete||!this.spriteSheet.sheet.complete||this.spriteSheet.sheet.naturalHeight==0)return;let[i,s]=[0,0],[n,r]=this.tileDim;if(this.clipRegion&&([i,s]=this.clipRegion.pos,[n,r]=this.clipRegion.pos.add(this.clipRegion.size).add([1,1]),i=Math.min(Math.max(i,0),this.tileDim[0]),n=Math.min(Math.max(n,0),this.tileDim[0]),s=Math.min(Math.max(s,0),this.tileDim[1]),r=Math.min(Math.max(r,0),this.tileDim[1])),Math.floor(this.spriteSheet.sheet.width/this.spriteSheet.spriteSize),Math.floor(this.spriteSheet.sheet.height/this.spriteSheet.spriteSize),this.useCache){if(this._data._cacheData===null&&this.cacheCanvas(),this._data._cacheData===null)return;const o=this.spriteSheet.spriteSize;if(e.drawImage(this._data._cacheData,o*i,o*s,o*(n-i),o*(r-s),this.x+i,this.y+s,n-i,r-s),this._aLayer===null&&this._vLayer===null)for(let a=i;a<n;a++)for(let l=s;l<r;l++){let c=a+l*this.tileDim[0],u=this._data[c];u<-1&&this.spriteSheet.drawIndexed(e,u,a+this.x,l+this.y)}else if(this._aLayer&&this._vLayer){const a=this._aLayer,l=this._vLayer,c=e.globalAlpha,u=this._data;for(let f=i;f<n;f++)for(let d=s;d<r;d++){let p=f+d*this.tileDim[0],g=u[p];g<-1&&l[p]>0&&(a[p]===0?(e.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(e,g,f+this.x,d+this.y),e.globalAlpha=c):this.spriteSheet.drawIndexed(e,g,f+this.x,d+this.y))}}}else if(this._aLayer===null&&this._vLayer===null)for(let o=i;o<n;o++)for(let a=s;a<r;a++){let l=o+a*this.tileDim[0],c=this._data[l];this.spriteSheet.drawIndexed(e,c,o+this.x,a+this.y)}else if(this._aLayer&&this._vLayer){const o=this._aLayer,a=this._vLayer,l=e.globalAlpha,c=this._data;for(let u=i;u<n;u++)for(let f=s;f<r;f++){let d=u+f*this.tileDim[0],p=c[d];p!==-1&&a[d]>0&&(o[d]===0?(e.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(e,p,u+this.x,f+this.y),e.globalAlpha=l):this.spriteSheet.drawIndexed(e,p,u+this.x,f+this.y))}}}clearCache(){this.data._cacheData=null}cacheCanvas(){if(this._data._cacheData=null,!this.spriteSheet||!this.spriteSheet.sheet||this.tileDim[0]<=0||this.tileDim[1]<=0)return;const t=new OffscreenCanvas(this.tileDim[0]*this.spriteSheet.spriteSize,this.tileDim[1]*this.spriteSheet.spriteSize),e=t.getContext("2d");if(!e)return;e.scale(this.spriteSheet.spriteSize,this.spriteSheet.spriteSize);let[i,s]=[0,0],[n,r]=this.tileDim;if(this._aLayer===null&&this._vLayer===null)for(let o=i;o<n;o++)for(let a=s;a<r;a++){let l=o+a*this.tileDim[0],c=this._data[l];c>=0&&this.spriteSheet.drawIndexed(e,c,o,a)}else if(this._aLayer&&this._vLayer){const o=this._aLayer,a=this._vLayer,l=e.globalAlpha,c=this._data;for(let u=i;u<n;u++)for(let f=s;f<r;f++){let d=u+f*this.tileDim[0],p=c[d];p>=0&&a[d]>0&&(o[d]===0?(e.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(e,p,u,f),e.globalAlpha=l):this.spriteSheet.drawIndexed(e,p,u,f))}}this._data._cacheData=t}}class Si extends re{constructor(t={}){super(),this._layerData=[this._data],this.numLayers=1,this.activeLayer=0,this.visibilityLayer=-1,this.alphaLayer=-1,t&&this.updateProperties(t)}on_alphaLayer(t,e,i){this._aLayer=this.alphaLayer>=0?this._layerData[this.alphaLayer]:null}on_visibilityLayer(t,e,i){this._vLayer=this.visibilityLayer>=0?this._layerData[this.visibilityLayer]:null}serialize(){const t={},e=[];for(let i of this._layerData)e.push(i.slice());return t._layerData=e,t.activeLayer=this.activeLayer,t.numLayers=this.numLayers,t.tileDim=this.tileDim.slice(),t.spriteSheet=Array(...x.resources.keys()).find(i=>x.resources[i]===this.spriteSheet)??null,t}deserialize(t){this.numLayers=t.numLayers,this.activeLayer=t.activeLayer,this.tileDim=new D(t.tileDim??[0,0]);const e=t._layerData.length;this._layerData.length=e;for(let i=0;i<e;i++){const s=this._layerData[i],n=t._layerData[i];for(let r=0;r<n.lenth;r++)s[r]=n[r]}this.spriteSheet=x.resources[t.spriteSheet]??null,this.clearCache()}on_tileDim(t,e,i){if("_layerData"in this){for(let s of this._layerData)this._data=s,this.resizeData();this.activeLayer>=0&&(this._data=this._layerData[this.activeLayer]),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new D(this.tileDim)}}on_numLayers(t,e,i){const s=this._layerData.length;this._layerData.length=this.numLayers;for(let n=s;n<this.numLayers;n++){const r=new ct(this.tileDim).fill(this.defaultValue);this._layerData[n]=r}this.activeLayer>=this.numLayers&&(this.activeLayer=this.numLayers-1)}on_activeLayer(t,e,i){this._data=this._layerData[this.activeLayer]}get layer(){return this._layerData}getFromLayer(t,e){return this._layerData[t][e[0]+e[1]*this.tileDim[0]]}setInLayer(t,e,i){this._layerData[t][e[0]+e[1]*this.tileDim[0]]=i,this._layerData[t]._cacheData=null}clearCache(){for(let t of this._layerData)t._cacheData=null}draw(t,e){for(let i of this._layerData)i.hidden||(this._data=i,super.draw(t,e));this._data=this._layerData[this.activeLayer]}}x.registerClass("Widget",V,"");x.registerClass("App",x,"");x.registerClass("Label",K,"");x.registerClass("Button",di,"");x.registerClass("ToggleButton",ie,"");x.registerClass("BasicButton",fi,"");x.registerClass("TextInput",yi,"");x.registerClass("CheckBox",mi,"");x.registerClass("Slider",pi,"");x.registerClass("ImageWidget",_i,"");x.registerClass("BoxLayout",Mt,"");x.registerClass("GridLayout",wi,"");x.registerClass("ScrollView",ne,"");x.registerClass("ModalView",gi,"");x.registerClass("Notebook",se,"");x.registerClass("TabbedNotebook",bi,"");x.registerClass("SpriteWidget",Ti,"");x.registerClass("TileMap",re,"");x.registerClass("LayeredTileMap",Si,"");class xi extends K{constructor(){super(...arguments);m(this,"_counter",0);m(this,"_frames",0);m(this,"_worst",300);m(this,"_tref",Date.now());m(this,"_badFrameCount",0)}update(e,i){super.update(e,i);const s=Date.now();this._counter+=s-this._tref,this._frames+=1;const n=1e3/(s-this._tref);console.log("FPS update",s,s-this._tref,n),this._tref=s,this._badFrameCount+=n<50?1:0,n<this._worst&&(this._worst=n),this._counter>=1e3&&(this.text=`FPS: ${Math.round(this._frames/this._counter*1e3)} (worst: ${Math.round(this._worst)}, # >20ms: ${Math.round(this._badFrameCount)})`,this._counter=0,this._frames=0,this._worst=300,this._badFrameCount=0)}}class Mi extends x{constructor(t,e,i){if(super({}),this.glCanvas=t,this.uiCanvas=e,this.gl=t.getContext("webgl2"),!this.gl)throw new Error("WebGL2 not supported");this.currentContest=null,this.prefDimH=-1,this.prefDimW=-1,this.canvasName="uicanvas",this.baseWidget.children=[new K({text:"WCO: 11 - 11 - 77",align:"left",hints:{x:0,y:0,w:1,h:.05}}),new K({text:"CAR: 11 - 11 - 77",align:"left",hints:{x:0,y:.05,w:1,h:.05}}),new xi({hints:{bottom:1,x:0,w:1,h:.05},align:"right"})],this.continuousFrameUpdates=!0,this.renderer=new ei(this.gl,t,i),this.controls=new ii(e),this.setPiece=null,this.entities=[],this.aimTarget=new We([5,.001,C/2]),this.ball=new Ue(F(0,0,C/2)),this.entities.push(this.ball),this.players=[],this.chasers=0,this.followers=0,this.homePositions=Et(),this.awayPositions=Et(!0),Re("mulberry32"),ze(Be(`DATE ${Date.now()}`));for(let o=0;o<1e3;++o)Q(20);const s=Q(18);let n=Q(18);for(;s===n;)n=Q(18);console.log("teams",s,n);const r=[[this.homePositions,"home",s],[this.awayPositions,"away",n]];for(let[o,a,l]of r)for(const[c,u]of Object.entries(o)){const f=new je(c,a,l,u,!c.toLowerCase().startsWith("bench"));this.entities.push(f),this.players.push(f),c==="RR"&&a==="home"&&(this.player=f)}this.closestPlayers={home:null,away:null},this.cameraTarget=F(0,10,C/2),this.cameraPos=F(0,10,C/2+15),this.resize(),window.addEventListener("resize",()=>this.resize()),this.lastTime=performance.now()}start(){this.lastTime=performance.now(),super.start()}update(){var n,r;this._udpateActive=!0;const t=Date.now(),e=(Date.now()-this.lastTime)/1e3,i=Math.min(e,1/30);this.lastTime=t,this.updateClosestPlayers(),this.controls.update(i),this.chasers=0,this.followers=0;const s=this.ball.pos.c;for(const o of this.entities)o.update(i,this);if(this.setPiece&&(this.setPiece.update(i),this.setPiece.finished&&(this.setPiece=null)),!this.setPiece){let o=Me(s,this.ball.pos);if(o!==null){if(o==="goalAway"&&(this.ball.lastTouchedType!=="kick"||((n=this.ball.lastTouchedBy)==null?void 0:n.team)==="home")?o="behindAway":o==="goalHome"&&(this.ball.lastTouchedType!=="kick"||((r=this.ball.lastTouchedBy)==null?void 0:r.team)==="away")?o="behindHome":o==="innerLeftPostAway"||o==="innerRightPostAway"?o="behindAway":(o==="innerLeftPostHome"||o==="innerRightPostHome")&&(o="behindHome"),o==="behindAway"){const a=this.players.find(l=>l.name==="FB"&&l.team==="home");a&&(this.setPiece=new at(this,a,F(0,0,C-10)))}if(o==="behindHome"){const a=this.players.find(l=>l.name==="FB"&&l.team==="away");a&&(this.setPiece=new at(this,a,F(0,0,10)))}if(o==="goalAway"||o==="goalHome"||o==="outOfBounds")for(const a of this.entities)a.setupForBoundary(o,this.ball.pos)}}this.updateCameraTarget(),this.updatePlayerControl(),this.renderer.renderScene(this,this.entities),this.controls.endUpdate(),super.update()}updateClosestPlayers(){const t=this.ball,e={home:1/0,away:1/0},i={home:null,away:null};for(let s of this.players){const n=s.pos.dist(t.pos);n<e[s.team]&&(e[s.team]=n,i[s.team]=s)}this.closestPlayers=i}updatePlayerControl(){const t=this.players.filter(n=>n.team==="home"),e=this.ball.carrier;if(!e||e&&e.team==="home")return;let i=null,s=1/0;for(const n of t){if(n.actionState==="tackle")continue;const r=me(n.pos,e.pos),o=(Math.abs(n.positionPos[0]-this.ball.pos[0])<10?-10:0)+(n.energy<.3?-5:0)+(n.pos[2]>e.pos[2]?-10:0);r+o<s&&(i=n,s=r+o)}i&&i!==this.player&&(this.player=i,this.player.aiming=!1)}updateCameraTarget(){const t=this.ball,e=t.carrier,i=e?(e.team==="home",e.pos.c):t.pos.c;let s=e&&e.team==="home"?0:Math.max(40-i[2],15),n=-.2*i[0];i.add([n,0,s]);const r=this.cameraTarget.dist(i),o=Math.max(1/(1+3*r),.05);this.cameraTarget.lerp(i,o)}resize(){this.glCanvas.width=window.innerWidth,this.glCanvas.height=window.innerHeight,this.uiCanvas.width=window.innerWidth,this.uiCanvas.height=window.innerHeight,this.renderer.updateProjection()}}const Ai="/footy/assets/spritesheet-B1iMSNhx.png";function Fi(h){const t=document.getElementById("uicanvas");if(!t)throw console.error("UI Canvas element not found"),new Error("UI Canvas element not found");const e=document.getElementById("glcanvas");if(!e)throw console.error("WebGL2 Canvas element not found"),new Error("WebGL2 Canvas element not found");new Mi(e,t,h).start()}Oe(Ai).then(h=>{if(!h.complete)throw console.error("Failed to load sprite sheet"),new Error("Sprite sheet not loaded");Fi(h)});
