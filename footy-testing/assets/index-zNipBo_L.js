var __defProp=Object.defineProperty;var __typeError=msg=>{throw TypeError(msg)};var __defNormalProp=(obj,key,value)=>key in obj?__defProp(obj,key,{enumerable:!0,configurable:!0,writable:!0,value}):obj[key]=value;var __publicField=(obj,key,value)=>__defNormalProp(obj,typeof key!="symbol"?key+"":key,value),__accessCheck=(obj,member,msg)=>member.has(obj)||__typeError("Cannot "+msg);var __privateAdd=(obj,member,value)=>member.has(obj)?__typeError("Cannot add the same private member more than once"):member instanceof WeakSet?member.add(obj):member.set(obj,value);var __privateMethod=(obj,member,method)=>(__accessCheck(obj,member,"access private method"),method);(function(){const relList=document.createElement("link").relList;if(relList&&relList.supports&&relList.supports("modulepreload"))return;for(const link of document.querySelectorAll('link[rel="modulepreload"]'))processPreload(link);new MutationObserver(mutations=>{for(const mutation of mutations)if(mutation.type==="childList")for(const node of mutation.addedNodes)node.tagName==="LINK"&&node.rel==="modulepreload"&&processPreload(node)}).observe(document,{childList:!0,subtree:!0});function getFetchOpts(link){const fetchOpts={};return link.integrity&&(fetchOpts.integrity=link.integrity),link.referrerPolicy&&(fetchOpts.referrerPolicy=link.referrerPolicy),link.crossOrigin==="use-credentials"?fetchOpts.credentials="include":link.crossOrigin==="anonymous"?fetchOpts.credentials="omit":fetchOpts.credentials="same-origin",fetchOpts}function processPreload(link){if(link.ep)return;link.ep=!0;const fetchOpts=getFetchOpts(link);fetch(link.href,fetchOpts)}})();var EPSILON=1e-6,ARRAY_TYPE=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var y=0,i=arguments.length;i--;)y+=arguments[i]*arguments[i];return Math.sqrt(y)});function create$2(){var out=new ARRAY_TYPE(16);return ARRAY_TYPE!=Float32Array&&(out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[11]=0,out[12]=0,out[13]=0,out[14]=0),out[0]=1,out[5]=1,out[10]=1,out[15]=1,out}function identity(out){return out[0]=1,out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[5]=1,out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[10]=1,out[11]=0,out[12]=0,out[13]=0,out[14]=0,out[15]=1,out}function translate(out,a2,v){var x=v[0],y=v[1],z=v[2],a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23;return a2===out?(out[12]=a2[0]*x+a2[4]*y+a2[8]*z+a2[12],out[13]=a2[1]*x+a2[5]*y+a2[9]*z+a2[13],out[14]=a2[2]*x+a2[6]*y+a2[10]*z+a2[14],out[15]=a2[3]*x+a2[7]*y+a2[11]*z+a2[15]):(a00=a2[0],a01=a2[1],a02=a2[2],a03=a2[3],a10=a2[4],a11=a2[5],a12=a2[6],a13=a2[7],a20=a2[8],a21=a2[9],a22=a2[10],a23=a2[11],out[0]=a00,out[1]=a01,out[2]=a02,out[3]=a03,out[4]=a10,out[5]=a11,out[6]=a12,out[7]=a13,out[8]=a20,out[9]=a21,out[10]=a22,out[11]=a23,out[12]=a00*x+a10*y+a20*z+a2[12],out[13]=a01*x+a11*y+a21*z+a2[13],out[14]=a02*x+a12*y+a22*z+a2[14],out[15]=a03*x+a13*y+a23*z+a2[15]),out}function scale(out,a2,v){var x=v[0],y=v[1],z=v[2];return out[0]=a2[0]*x,out[1]=a2[1]*x,out[2]=a2[2]*x,out[3]=a2[3]*x,out[4]=a2[4]*y,out[5]=a2[5]*y,out[6]=a2[6]*y,out[7]=a2[7]*y,out[8]=a2[8]*z,out[9]=a2[9]*z,out[10]=a2[10]*z,out[11]=a2[11]*z,out[12]=a2[12],out[13]=a2[13],out[14]=a2[14],out[15]=a2[15],out}function rotateX(out,a2,rad){var s=Math.sin(rad),c=Math.cos(rad),a10=a2[4],a11=a2[5],a12=a2[6],a13=a2[7],a20=a2[8],a21=a2[9],a22=a2[10],a23=a2[11];return a2!==out&&(out[0]=a2[0],out[1]=a2[1],out[2]=a2[2],out[3]=a2[3],out[12]=a2[12],out[13]=a2[13],out[14]=a2[14],out[15]=a2[15]),out[4]=a10*c+a20*s,out[5]=a11*c+a21*s,out[6]=a12*c+a22*s,out[7]=a13*c+a23*s,out[8]=a20*c-a10*s,out[9]=a21*c-a11*s,out[10]=a22*c-a12*s,out[11]=a23*c-a13*s,out}function perspectiveNO(out,fovy,aspect,near,far){var f=1/Math.tan(fovy/2),nf;return out[0]=f/aspect,out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[5]=f,out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[11]=-1,out[12]=0,out[13]=0,out[15]=0,far!=null&&far!==1/0?(nf=1/(near-far),out[10]=(far+near)*nf,out[14]=2*far*near*nf):(out[10]=-1,out[14]=-2*near),out}var perspective=perspectiveNO;function lookAt(out,eye,center,up){var x0,x1,x2,y0,y1,y2,z0,z1,z2,len2,eyex=eye[0],eyey=eye[1],eyez=eye[2],upx=up[0],upy=up[1],upz=up[2],centerx=center[0],centery=center[1],centerz=center[2];return Math.abs(eyex-centerx)<EPSILON&&Math.abs(eyey-centery)<EPSILON&&Math.abs(eyez-centerz)<EPSILON?identity(out):(z0=eyex-centerx,z1=eyey-centery,z2=eyez-centerz,len2=1/Math.hypot(z0,z1,z2),z0*=len2,z1*=len2,z2*=len2,x0=upy*z2-upz*z1,x1=upz*z0-upx*z2,x2=upx*z1-upy*z0,len2=Math.hypot(x0,x1,x2),len2?(len2=1/len2,x0*=len2,x1*=len2,x2*=len2):(x0=0,x1=0,x2=0),y0=z1*x2-z2*x1,y1=z2*x0-z0*x2,y2=z0*x1-z1*x0,len2=Math.hypot(y0,y1,y2),len2?(len2=1/len2,y0*=len2,y1*=len2,y2*=len2):(y0=0,y1=0,y2=0),out[0]=x0,out[1]=y0,out[2]=z0,out[3]=0,out[4]=x1,out[5]=y1,out[6]=z1,out[7]=0,out[8]=x2,out[9]=y2,out[10]=z2,out[11]=0,out[12]=-(x0*eyex+x1*eyey+x2*eyez),out[13]=-(y0*eyex+y1*eyey+y2*eyez),out[14]=-(z0*eyex+z1*eyey+z2*eyez),out[15]=1,out)}function create$1(){var out=new ARRAY_TYPE(3);return ARRAY_TYPE!=Float32Array&&(out[0]=0,out[1]=0,out[2]=0),out}function length(a2){var x=a2[0],y=a2[1],z=a2[2];return Math.hypot(x,y,z)}function fromValues$1(x,y,z){var out=new ARRAY_TYPE(3);return out[0]=x,out[1]=y,out[2]=z,out}function squaredDistance(a2,b){var x=b[0]-a2[0],y=b[1]-a2[1],z=b[2]-a2[2];return x*x+y*y+z*z}var len=length;(function(){var vec=create$1();return function(a2,stride,offset,count,fn,arg){var i,l;for(stride||(stride=3),offset||(offset=0),count?l=Math.min(count*stride+offset,a2.length):l=a2.length,i=offset;i<l;i+=stride)vec[0]=a2[i],vec[1]=a2[i+1],vec[2]=a2[i+2],fn(vec,vec,arg),a2[i]=vec[0],a2[i+1]=vec[1],a2[i+2]=vec[2];return a2}})();function create(){var out=new ARRAY_TYPE(2);return ARRAY_TYPE!=Float32Array&&(out[0]=0,out[1]=0),out}function fromValues(x,y){var out=new ARRAY_TYPE(2);return out[0]=x,out[1]=y,out}function add(out,a2,b){return out[0]=a2[0]+b[0],out[1]=a2[1]+b[1],out}(function(){var vec=create();return function(a2,stride,offset,count,fn,arg){var i,l;for(stride||(stride=2),offset||(offset=0),count?l=Math.min(count*stride+offset,a2.length):l=a2.length,i=offset;i<l;i+=stride)vec[0]=a2[i],vec[1]=a2[i+1],fn(vec,vec,arg),a2[i]=vec[0],a2[i+1]=vec[1];return a2}})();class Vec3 extends Float32Array{constructor(x=0,y=0,z=0){super(3),this[0]=x,this[1]=y,this[2]=z}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}set x(v){this[0]=v}set y(v){this[1]=v}set z(v){this[2]=v}get c(){return new Vec3(this[0],this[1],this[2])}zeroX(){return this[0]=0,this}zeroY(){return this[1]=0,this}zeroZ(){return this[2]=0,this}setFrom(x,y,z){return this[0]=x,this[1]=y,this[2]=z,this}add(v){return this[0]+=v[0],this[1]+=v[1],this[2]+=v[2],this}sub(v){return this[0]-=v[0],this[1]-=v[1],this[2]-=v[2],this}scale(s){return this[0]*=s,this[1]*=s,this[2]*=s,this}scaleAndAdd(v,s){return this[0]+=v[0]*s,this[1]+=v[1]*s,this[2]+=v[2]*s,this}normalize(){const len2=Math.hypot(this[0],this[1],this[2]);return len2>1e-6?this.scale(1/len2):this.setFrom(0,0,0)}dot(v){return this[0]*v[0]+this[1]*v[1]+this[2]*v[2]}cross(v){return new Vec3(this[1]*v[2]-this[2]*v[1],this[2]*v[0]-this[0]*v[2],this[0]*v[1]-this[1]*v[0])}lenSq(){return this[0]**2+this[1]**2+this[2]**2}len(){return Math.hypot(this[0],this[1],this[2])}dist(v){return Math.hypot(this[0]-v[0],this[1]-v[1],this[2]-v[2])}distSq(v){return(this[0]-v[0])*(this[0]-v[0])+(this[1]-v[1])*(this[1]-v[1])+(this[2]-v[2])*(this[2]-v[2])}copyFrom(v){return this[0]=v[0],this[1]=v[1],this[2]=v[2],this}toArray(){return[this[0],this[1],this[2]]}static fromXZ(x,z){return new Vec3(x,0,z)}static fromXY(x,y){return new Vec3(x,y,0)}static fromArrayXZ(arr){return new Vec3(arr[0],0,arr[1])}static fromArrayXY(arr){return new Vec3(arr[0],arr[1],0)}static fromArray(arr){return new Vec3(arr[0],arr[1],arr[2])}static direction(from,to){return new Vec3(to[0]-from[0],to[1]-from[1],to[2]-from[2]).normalize()}lerp(to,t){return this[0]+=(to[0]-this[0])*t,this[1]+=(to[1]-this[1])*t,this[2]+=(to[2]-this[2])*t,this}lerpEased(target,t,easing){const te=easing?easing(t):t;return this[0]+=(target[0]-this[0])*te,this[1]+=(target[1]-this[1])*te,this[2]+=(target[2]-this[2])*te,this}get xz(){return new Vec2$1(this[0],this[2])}get xy(){return new Vec2$1(this[0],this[1])}get yz(){return new Vec2$1(this[1],this[2])}toDir(target){return this.sub(target).normalize()}dirTo(target){return Vec3.fromArray(target).sub(this).normalize()}dirFrom(target){return this.c.sub(target).normalize()}moveTo(target,amount,overRun=!1){const dx=target[0]-this[0],dy=target[1]-this[1],dz=target[2]-this[2],dist2=Math.hypot(dx,dy,dz);if(dist2<1e-5)return this;const f=overRun?amount/dist2:Math.min(1,amount/dist2);return this[0]+=dx*f,this[1]+=dy*f,this[2]+=dz*f,this}moveDir(dir,amount){const dx=dir[0],dy=dir[1],dz=dir[2],dist2=Math.hypot(dx,dy,dz);return dist2<1e-5?this:(this[0]+=dx*amount/dist2,this[1]+=dy*amount/dist2,this[2]+=dz*amount/dist2,this)}rotateXZ(angleRad){const cos=Math.cos(angleRad),sin=Math.sin(angleRad);return[this[0],this[2]]=[this[0]*cos-this[2]*sin,this[0]*sin+this[2]*cos],this}}let Vec2$1=class Vec2 extends Float32Array{constructor(x=0,y=0){super(2),this[0]=x,this[1]=y}get x(){return this[0]}get y(){return this[1]}set x(v){this[0]=v}set y(v){this[1]=v}get c(){return new Vec2(this[0],this[1])}set(x,y){return this[0]=x,this[1]=y,this}add(v){return this[0]+=v[0],this[1]+=v[1],this}sub(v){return this[0]-=v[0],this[1]-=v[1],this}scale(s){return this[0]*=s,this[1]*=s,this}normalize(){const len2=Math.hypot(this[0],this[1]);return len2>1e-6?this.scale(1/len2):this.set(0,0)}dot(v){return this[0]*v[0]+this[1]*v[1]}lenSq(){return this[0]**2+this[1]**2}len(){return Math.sqrt(this.lenSq())}dist(v){return Math.hypot(this[0]-v[0],this[1]-v[1])}distSq(v){return(this[0]-v[0])*(this[0]-v[0])+(this[1]-v[1])*(this[1]-v[1])}copyFrom(v){return this[0]=v[0],this[1]=v[1],this}toArray(){return[this[0],this[1]]}static fromArray(arr){return new Vec2(arr[0],arr[1])}static direction(from,to){return new Vec2(to[0]-from[0],to[1]-from[1]).normalize()}lerp(to,t){return this[0]+=(to[0]-this[0])*t,this[1]+=(to[1]-this[1])*t,this}lerpEased(target,t,easing=void 0){const te=easing?easing(t):t;return this[0]+=(target[0]-this[0])*te,this[1]+=(target[1]-this[1])*te,this[2]+=(target[2]-this[2])*te,this}toDir(target){return this.sub(target).normalize()}moveTo(target,amount,overRun=!1){const dx=target[0]-this[0],dy=target[1]-this[1],dist2=Math.hypot(dx,dy);if(dist2<1e-5)return this;const f=overRun?amount/dist2:Math.min(1,amount/dist2);return this[0]+=dx*f,this[1]+=dy*f,this}moveDir(dir,amount){const dx=dir[0],dy=dir[1],dist2=Math.hypot(dx,dy);return dist2<1e-5?this:(this[0]+=dx*amount/dist2,this[1]+=dy*amount/dist2,this)}};const v3=(x=0,y=0,z=0)=>new Vec3(x,y,z),v2=(x=0,y=0)=>new Vec2$1(x,y);function splitmix64$1(seed){let state=BigInt(seed)&0xFFFFFFFFFFFFFFFFn;return function(){state=state+0x9E3779B97F4A7C15n&0xFFFFFFFFFFFFFFFFn;let z=state;return z=(z^z>>30n)*0xBF58476D1CE4E5B9n&0xFFFFFFFFFFFFFFFFn,z=(z^z>>27n)*0x94D049BB133111EBn&0xFFFFFFFFFFFFFFFFn,z=z^z>>31n,z}}let PRNG$1=class{constructor(){__publicField(this,"_seed",0)}random(){return Math.random()}seed(seed){throw new Error("Seeding is not available in the default PRNG class. You can set another with `eskv.rand.setPRNG`.")}getRandomInt(m1,m2=0){return m2!=0?m1+Math.floor(this.random()*(m2-m1)):Math.floor(this.random()*m1)}getRandomPos(maxX,maxY){return[this.getRandomInt(maxX),this.getRandomInt(maxY)]}randomRange(min=0,max=1){return Math.floor(this.random()*(max-min+1))+min}randomFloat(min=0,max=1){return this.random()*(max-min)+min}shuffle(arr){let temp,r;for(let i=1;i<arr.length;i++)r=this.randomRange(0,i),temp=arr[i],arr[i]=arr[r],arr[r]=temp;return arr}choose(array){return array[Math.floor(this.random()*array.length)]}chooseN(arr,n){let result=new Array(n),len2=arr.length,taken=new Array(len2);if(n>len2)throw new RangeError("chooeN: more elements requested than available");for(;n--;){let x=Math.floor(this.random()*len2);result[n]=arr[x in taken?taken[x]:x],taken[x]=--len2 in taken?taken[len2]:len2}return result}};function sfc32$1(a2,b,c,d){return function(){a2>>>=0,b>>>=0,c>>>=0,d>>>=0;var t=a2+b|0;return a2=b^b>>>9,b=c+(c<<3)|0,c=c<<21|c>>>11,d=d+1|0,t=t+d|0,c=c+t|0,(t>>>0)/4294967296}}function mulberry32$1(a2){return function(){var t=a2+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function xoshiro128ss$1(a2,b,c,d){return function(){var t=b<<9,r=b*5;return r=(r<<7|r>>>25)*9,c^=a2,d^=b,b^=c,a2^=d,c^=t,d=d<<11|d>>>21,(r>>>0)/4294967296}}function jsf32$1(a2,b,c,d){return function(){a2|=0,b|=0,c|=0,d|=0;var t=a2-(b<<27|b>>>5)|0;return a2=b^(c<<17|c>>>15),b=c+d|0,c=d+t|0,d=a2+t|0,(d>>>0)/4294967296}}let PRNG_sfc32$1=class extends PRNG$1{constructor(){super(...arguments);__publicField(this,"_seed",1);__publicField(this,"d",3735928559);__publicField(this,"xorSeed",Math.floor(Date.now())^this.d);__publicField(this,"random",sfc32$1(2654435769,608135816,3084996962,this.xorSeed))}seed(seed){this._seed=seed,this.xorSeed=seed^this.d;const sm=splitmix64$1(this.xorSeed);this.random=sfc32$1(sm(),sm(),sm(),sm())}},PRNG_mulberry32$1=class extends PRNG$1{constructor(){super(...arguments);__publicField(this,"_seed",1);__publicField(this,"d",3735928559);__publicField(this,"xorSeed",Math.floor(Date.now())^this.d);__publicField(this,"random",mulberry32$1(this.xorSeed))}seed(seed){this._seed=seed,this.xorSeed=seed^this.d,this.random=mulberry32$1(this.xorSeed)}},PRNG_xoshiro128ss$1=class extends PRNG$1{constructor(){super(...arguments);__publicField(this,"_seed",1);__publicField(this,"d",3735928559);__publicField(this,"xorSeed",Math.floor(Date.now())^this.d);__publicField(this,"random",xoshiro128ss$1(2654435769,608135816,3084996962,this.xorSeed))}seed(seed){this._seed=seed,this.xorSeed=seed^this.d;const sm=splitmix64$1(this.xorSeed);this.random=xoshiro128ss$1(sm(),sm(),sm(),sm())}},PRNG_jsf32$1=class extends PRNG$1{constructor(){super(...arguments);__publicField(this,"_seed",1);__publicField(this,"d",3735928559);__publicField(this,"xorSeed",Math.floor(Date.now())^this.d);__publicField(this,"random",jsf32$1(2654435769,608135816,3084996962,this.xorSeed))}seed(seed){this._seed=seed,this.xorSeed=seed^this.d;const sm=splitmix64$1(this.xorSeed);this.random=jsf32$1(sm(),sm(),sm(),sm())}};var defaultPRNG$1=new PRNG_sfc32$1;function setPRNG$1(name){switch(name){case"Math.random":defaultPRNG$1=new PRNG$1;return;case"sfc32":defaultPRNG$1=new PRNG_sfc32$1;return;case"mulberry32":defaultPRNG$1=new PRNG_mulberry32$1;return;case"xoshiro128ss":defaultPRNG$1=new PRNG_xoshiro128ss$1;return;case"jsf32":defaultPRNG$1=new PRNG_jsf32$1;return;default:throw Error(`Unknown PRNG ${name}`)}}function getRandomInt(m1,m2=0){return defaultPRNG$1.getRandomInt(m1,m2)}function getRandomPos(max1,max2){return defaultPRNG$1.getRandomPos(max1,max2)}function randomFloat(min=0,max=1){return defaultPRNG$1.randomFloat(min,max)}function choose(array){return defaultPRNG$1.choose(array)}function setSeed$1(seed){return defaultPRNG$1.seed(seed)}function stringToSeed$1(str){let hash=5381;for(let i=0;i<str.length;i++)hash=(hash<<5)+hash+str.charCodeAt(i),hash=hash&4294967295;return hash>>>0}function solveQuadratic(a2,b,c){const discriminant=b*b-4*a2*c;if(discriminant<0)return[];const sqrtD=Math.sqrt(discriminant),t1=(-b-sqrtD)/(2*a2),t2=(-b+sqrtD)/(2*a2);return[t1,t2].filter(t=>t>=0)}function getPositionAtTime(pos0,vel0,g,t){return pos0.c.scaleAndAdd(vel0,t).scaleAndAdd(g,.5*t*t)}function timeToHeight(pos0,vel0,g,h){const a2=-.5*g,b=vel0[1],c=pos0[1]-h;return solveQuadratic(a2,b,c).filter(t=>t>=0)}function timeToGround(pos0,vel0,g){return timeToHeight(pos0,vel0,g,0)}function applyKickInaccuracy(aimTarget,magnitude=.15){const dist2=Math.hypot(aimTarget[0],aimTarget[1]),noiseX=(Math.random()-.5)*dist2*magnitude,noiseZ=(Math.random()-.5)*dist2*magnitude;return[aimTarget[0]+noiseX,aimTarget[1]+noiseZ]}function getLaunchParamsFor(origin,target,gravity,angleDeg=30){const diff=v3(target[0]-origin[0],0,target[2]-origin[2]),dist2=diff.len();if(dist2<.1)return null;const angleRad=angleDeg*Math.PI/180,sin2θ=Math.sin(2*angleRad);if(Math.abs(sin2θ)<1e-5)return null;const speed=Math.sqrt(dist2*gravity/sin2θ),dirXZ=diff.normalize();return{direction:v3(dirXZ[0]*Math.cos(angleRad),Math.sin(angleRad),dirXZ[2]*Math.cos(angleRad)),speed}}function computeKickVelocity(player,aimTarget,isHandpass=!1,overrideVy){const gravity=-player.gravity[1],origin=player.pos,targetY=player.pos[1]+(isHandpass?player.statsHeight-.1:0);if(overrideVy!==void 0){const dy=targetY-player.pos[1],roots=solveQuadratic(-.5*gravity,overrideVy,-dy),t=Math.min(...roots.filter(r=>r>0));if(!isFinite(t))return null;const vx=aimTarget[0]/t,vz=aimTarget[1]/t;return v3(vx,overrideVy,vz)}const angle=isHandpass?10:30,target=v3(player.pos[0]+aimTarget[0],targetY,player.pos[2]+aimTarget[1]),params=getLaunchParamsFor(origin,target,gravity,angle);return params?params.direction.scale(params.speed):null}function computeAerialInterceptJumpApex(playerPos,playerHeight,jumpVel,maxSpeed,ballPos,ballVel,gravity,deltaTime=1/60){const g=gravity,apexTime=jumpVel/g,apexHeight=jumpVel*jumpVel/(2*g),a2=-.5*g,b=ballVel[1],c=ballPos[1]-(playerPos[1]+playerHeight+apexHeight),D=b*b-4*a2*c;if(D<0)return{ok:!1,runVel:v3(0,0,0),jumpNow:!1};const s=Math.sqrt(D),t1=(-b-s)/(2*a2),t2=(-b+s)/(2*a2),cand=[t1,t2].filter(t=>t>=apexTime&&b-g*t<0).sort((x,y)=>x-y);for(const t of cand){const bx=ballPos[0]+ballVel[0]*t,by=ballPos[1]+ballVel[1]*t-.5*g*t*t,bz=ballPos[2]+ballVel[2]*t,v=v3(bx-playerPos[0],0,bz-playerPos[2]).scale(1/t);if(v.len()<=maxSpeed)return{ok:!0,runVel:v,jumpNow:t-apexTime<=deltaTime,time:t,point:v3(bx,by,bz)}}return{ok:!1,runVel:v3(0,0,0),jumpNow:!1}}function computeBallLanding(ballPos,ballVel,gravity,groundY=0){const a2=-.5*gravity,b=ballVel[1],c=ballPos[1]-groundY;if(c<=0)return{ok:!0,time:0,point:v3(ballPos[0],groundY,ballPos[2]),note:"already at/below ground"};const disc=b*b-4*a2*c;if(disc<0)return{ok:!1,time:null,point:null,note:"never reaches ground"};const sqrtD=Math.sqrt(disc),t1=(-b+sqrtD)/(2*a2),t2=(-b-sqrtD)/(2*a2),ts=[t1,t2].filter(t3=>t3>=0);if(!ts.length)return{ok:!1,time:null,point:null,note:"roots < 0"};const t=Math.max(...ts),x=ballPos[0]+ballVel[0]*t,z=ballPos[2]+ballVel[2]*t;return{ok:!0,time:t,point:v3(x,groundY,z)}}function computeAerialInterceptAnyJumpHeight(playerPos,playerHeight,jumpVel,maxSpeed,ballPos,ballVel,gravity,deltaTime=1/60){const g=gravity,apexHeight=jumpVel*jumpVel/(2*g),yMin=playerPos[1]+playerHeight,yMax=yMin+apexHeight,a2=-.5*g,b=ballVel[1],cTop=ballPos[1]-yMax,cBot=ballPos[1]-yMin,discTop=b*b-4*a2*cTop,discBot=b*b-4*a2*cBot;if(discTop<0&&discBot<0)return{ok:!1,note:"ball never within jump reach"};const tEnter=discTop>=0?Math.max((-b-Math.sqrt(discTop))/(2*a2),0):0,tExit=discBot>=0?Math.max((-b-Math.sqrt(discBot))/(2*a2),tEnter+.01):tEnter+.01,dx=ballPos[0]-playerPos[0],dz=ballPos[2]-playerPos[2],vx=ballVel[0],vz=ballVel[2],s2=maxSpeed*maxSpeed,A=vx*vx+vz*vz-s2,B=2*(dx*vx+dz*vz),C=dx*dx+dz*dz;let t=null;if(Math.abs(A)<1e-6)if(Math.abs(B)<1e-6)t=C===0?0:null;else{const root=-C/B;root>=tEnter&&root<=tExit&&(t=root)}else{const D=B*B-4*A*C;if(D>=0){const sqrtD=Math.sqrt(D),r1=(-B-sqrtD)/(2*A),r2=(-B+sqrtD)/(2*A),r=[r1,r2].filter(rt=>rt>=tEnter&&rt<=tExit);r.length&&(t=Math.min(...r))}}if(t===null)return{ok:!1,note:"no reachable time at maxSpeed"};const bx=ballPos[0]+vx*t,by=ballPos[1]+ballVel[1]*t-.5*g*t*t,bz=ballPos[2]+vz*t,a22=-.5*g,b2=jumpVel,c2=playerPos[1]-by,D2=b2*b2-4*a22*c2;if(D2<0)return{ok:!1,note:"no valid jump τ for intercept height"};const sqrtD2=Math.sqrt(D2),τ1=(-b2+sqrtD2)/(2*a22),τ2=(-b2-sqrtD2)/(2*a22),τ=Math.min(τ1,τ2),jumpStart=t-τ;if(jumpStart<0||τ<0)return{ok:!1,note:"jumpStart < 0 or τ < 0"};const runVel=v3((bx-playerPos[0])/t,0,(bz-playerPos[2])/t);return{ok:!0,time:t,point:v3(bx,by,bz),runVel,jumpStart,jumpNow:jumpStart<=deltaTime}}function computeGroundIntercept(playerPos,maxSpeed,ballPos,ballVel,gravity,lossPer5m=.2){const[px,,pz]=playerPos,[bx0,,bz0]=ballPos,[vx,,vz]=ballVel,S=maxSpeed,S2=S*S,EPS=1e-6,land=computeBallLanding(ballPos,ballVel,gravity,0),tL=land!=null&&land.ok&&land.time!=null?land.time:null,bL=land!=null&&land.ok&&land.point?land.point:null,quadEarliest=(A,B,C)=>{if(Math.abs(A)<1e-10){if(Math.abs(B)<1e-10)return C<=0?0:void 0;const t=-C/B;return t>=0?t:void 0}const D=B*B-4*A*C;if(D<0)return;const s=Math.sqrt(D),d=2*A,t1=(-B-s)/d,t2=(-B+s)/d;if(t1>=0&&t2>=0)return Math.min(t1,t2);if(t1>=0)return t1;if(t2>=0)return t2},dx0=bx0-px,dz0=bz0-pz,v22=vx*vx+vz*vz,tPre=tL===null?void 0:quadEarliest(v22-S2,2*(dx0*vx+dz0*vz),dx0*dx0+dz0*dz0);if(tPre!==void 0&&tL!==null&&tPre<=tL+EPS){const tx2=bx0+vx*tPre,tz2=bz0+vz*tPre,rx2=tx2-px,rz2=tz2-pz;return{ok:!0,time:tPre,point:v3(tx2,0,tz2),runVel:tPre>EPS?v3(rx2/tPre,0,rz2/tPre):v3(0,0,0),note:"pre-bounce intercept"}}if(tL!=null&&bL){const dirNorm=Math.hypot(vx,vz)||1,ux=vx/dirNorm,uz=vz/dirNorm,v0b=dirNorm,b=-Math.log(1-Math.max(0,Math.min(.99,lossPer5m)))/5,bxL=bL[0],bzL=bL[2],f=tau=>{const s=Math.log1p(b*v0b*tau)/b,tx2=bxL+ux*s,tz2=bzL+uz*s;return Math.hypot(tx2-px,tz2-pz)-S*(tL+tau)};let lo=0,hi=.2,fhi=f(hi),it=0;for(;fhi>0&&it++<40&&(lo=hi,hi*=2,fhi=f(hi),!(hi>20)););if(fhi<=0){for(let k=0;k<36;k++){const mid=(lo+hi)/2,fm=f(mid);fm<=0?(hi=mid,fhi=fm):lo=mid}const t=tL+hi,s=Math.log1p(b*v0b*(t-tL))/b,tx2=bxL+ux*s,tz2=bzL+uz*s,rx2=tx2-px,rz2=tz2-pz;return{ok:!0,time:t,point:v3(tx2,0,tz2),runVel:t>EPS?v3(rx2/t,0,rz2/t):v3(0,0,0),note:"post-bounce intercept (decay)"}}}if(bL){const rx2=bL[0]-px,rz2=bL[2]-pz,dist2=Math.hypot(rx2,rz2),t=Math.max(tL??0,dist2/S);return{ok:!0,time:t,point:bL,runVel:t>EPS?v3(rx2/t,0,rz2/t):v3(0,0,0),note:"fallback: landing"}}const tAny=quadEarliest(v22-S2,2*(dx0*vx+dz0*vz),dx0*dx0+dz0*dz0);if(tAny===void 0)return{ok:!1,time:null,point:null,runVel:null,note:"no intercept"};const tx=bx0+vx*tAny,tz=bz0+vz*tAny,rx=tx-px,rz=tz-pz;return{ok:!0,time:tAny,point:v3(tx,0,tz),runVel:v3(rx/tAny,0,rz/tAny),note:"projection intercept"}}function computeBestIntercept(playerPos,playerHeight,jumpVel,maxSpeed,ballPos,ballVel,gravity,deltaTime){const apex=computeAerialInterceptJumpApex(playerPos,playerHeight,jumpVel,maxSpeed,ballPos,ballVel,gravity,deltaTime);if(apex.ok&&apex.runVel)return{...apex,mode:"apex"};const sub=computeAerialInterceptAnyJumpHeight(playerPos,playerHeight,jumpVel,maxSpeed,ballPos,ballVel,gravity,deltaTime);if(sub.ok&&sub.runVel&&sub.point)return{...sub,mode:"subApex"};const ground=computeGroundIntercept(playerPos,maxSpeed,ballPos,ballVel,gravity);return ground.ok&&ground.point&&ground.runVel?{...ground,mode:"ground"}:{ok:!1,note:"No viable intercept within speed/jump constraints"}}function createShaderProgram(gl,vsSource,fsSource){const compile=(src,type)=>{const shader=gl.createShader(type);if(!shader)throw new Error("Failed to create shader");if(gl.shaderSource(shader,src),gl.compileShader(shader),!gl.getShaderParameter(shader,gl.COMPILE_STATUS))throw new Error(gl.getShaderInfoLog(shader));return shader},vs=compile(vsSource,gl.VERTEX_SHADER),fs=compile(fsSource,gl.FRAGMENT_SHADER),program=gl.createProgram();if(gl.attachShader(program,vs),gl.attachShader(program,fs),gl.linkProgram(program),!gl.getProgramParameter(program,gl.LINK_STATUS))throw new Error(gl.getProgramInfoLog(program));return program}async function loadImage(url){const image=new Image;return image.src=url,await image.decode(),image}const FIELD_WIDTH=160,FIELD_LENGTH$1=170,FIELD_RADIUS_X$1=FIELD_WIDTH/2,FIELD_RADIUS_Z$1=FIELD_LENGTH$1/2,GOAL_WIDTH=6,BEHIND_WIDTH=6,POST_THICKNESS=.5,goals=Object.freeze({home:v3(0,0,0),away:v3(0,0,FIELD_LENGTH$1)}),GOAL_POSTS_NORTH=Object.freeze([v3(-.5*GOAL_WIDTH-BEHIND_WIDTH,0,FIELD_LENGTH$1),v3(-.5*GOAL_WIDTH,0,FIELD_LENGTH$1),v3(.5*GOAL_WIDTH,0,FIELD_LENGTH$1),v3(.5*GOAL_WIDTH+BEHIND_WIDTH,0,FIELD_LENGTH$1)]),GOAL_POSTS_SOUTH=Object.freeze([v3(-.5*GOAL_WIDTH-BEHIND_WIDTH,0,0),v3(-.5*GOAL_WIDTH,0,0),v3(.5*GOAL_WIDTH,0,0),v3(.5*GOAL_WIDTH+BEHIND_WIDTH,0,0)]),GOAL_POSTS=Object.freeze({Away:GOAL_POSTS_NORTH,Home:GOAL_POSTS_SOUTH});function isOutOfBounds(pos){const xNorm=pos[0]/FIELD_RADIUS_X$1,zNorm=(pos[2]-FIELD_RADIUS_Z$1)/FIELD_RADIUS_Z$1;return xNorm*xNorm+zNorm*zNorm>1}function boundaryIntersection(point){const center=fromValues$1(0,0,FIELD_RADIUS_Z$1),dx=point[0]-center[0],dz=point[2]-center[2];if(dx===0&&dz===0)return fromValues$1(0,0,center[2]+FIELD_RADIUS_Z$1);const a2=FIELD_RADIUS_X$1,b=FIELD_RADIUS_Z$1,A=dx*dx/(a2*a2)+dz*dz/(b*b),t=1/Math.sqrt(A),x=center[0]+t*dx,z=center[2]+t*dz;return fromValues$1(x,0,z)}function pointToSegmentDistanceSq(px,pz,x0,z0,x1,z1){const dx=x1-x0,dz=z1-z0;if(dx===0&&dz===0){const dxp2=px-x0,dzp2=pz-z0;return dxp2*dxp2+dzp2*dzp2}const t=((px-x0)*dx+(pz-z0)*dz)/(dx*dx+dz*dz),clampedT=Math.max(0,Math.min(1,t)),closestX=x0+clampedT*dx,closestZ=z0+clampedT*dz,dxp=px-closestX,dzp=pz-closestZ;return dxp*dxp+dzp*dzp}function checkBoundaryCrossing(before,after){const iobBefore=isOutOfBounds(before),iobAfter=isOutOfBounds(after);for(const tag of["Away","Home"]){const posts=GOAL_POSTS[tag];if(iobAfter&&!iobBefore){if(tag==="Away"){if(before[2]>FIELD_LENGTH$1-10){const x=after[0];if(x>=-3&&x<=3)return"goalAway";if(x>=-9&&x<-3||x>3&&x<=9)return"behindAway"}}else if(tag==="Home"&&before[2]<10){const x=after[0];if(x>=-3&&x<=3)return"goalHome";if(x>=-9&&x<-3||x>3&&x<=9)return"behindHome"}}const postLabels=["outerLeftPost","innerLeftPost","innerRightPost","outerRightPost"];for(let i=0;i<posts.length;i++){const px=posts[i][0],pz=posts[i][2];if(pointToSegmentDistanceSq(px,pz,before[0],before[2],after[0],after[2])<POST_THICKNESS*POST_THICKNESS)return`${postLabels[i]}${tag}`}}return!iobBefore&&iobAfter?"outOfBounds":null}function generateFieldPositions(flip=!1){const r={fullBack:70,halfBack:35,halfForward:-35,fullForward:-70},angleMap={LFP:-45,FF:0,RFP:45,LHF:-50,CHF:0,RHF:50,LHB:-50,CHB:0,RHB:50,LBP:-45,FB:0,RBP:45};function setPos(angle,radius){const angleRad=angle*Math.PI/180,x=FIELD_RADIUS_X$1*Math.sin(angleRad)*(Math.abs(radius)/FIELD_RADIUS_Z$1)-(flip?2:-2),z=FIELD_RADIUS_Z$1+radius*(flip?-1:1);return v3(x,0,z)}const benchX=-FIELD_RADIUS_X$1-4,benchZ=offset=>FIELD_RADIUS_Z$1+(flip?1:-1)*offset;return{LFP:setPos(angleMap.LFP,r.fullForward+10),FF:setPos(angleMap.FF,r.fullForward),RFP:setPos(angleMap.RFP,r.fullForward+10),LHF:setPos(angleMap.LHF,r.halfForward),CHF:setPos(angleMap.CHF,r.halfForward),RHF:setPos(angleMap.RHF,r.halfForward),LW:v3(-25,0,FIELD_RADIUS_Z$1-(flip?2:-2)),C:v3(8,0,FIELD_RADIUS_Z$1-(flip?-5:5)),RW:v3(25,0,FIELD_RADIUS_Z$1-(flip?2:-2)),LHB:setPos(angleMap.LHB,r.halfBack),CHB:setPos(angleMap.CHB,r.halfBack),RHB:setPos(angleMap.RHB,r.halfBack),LBP:setPos(angleMap.LBP,r.fullBack-10),FB:setPos(angleMap.FB,r.fullBack),RBP:setPos(angleMap.RBP,r.fullBack-10),Ruck:v3(0,0,FIELD_RADIUS_Z$1-(flip?10:-10)),RR:v3(-10,0,FIELD_RADIUS_Z$1-(flip?10:-10)),Rover:v3(10,0,FIELD_RADIUS_Z$1-(flip?10:-10)),Bench1:v3(benchX,0,benchZ(10)),Bench2:v3(benchX,0,benchZ(13)),Bench3:v3(benchX,0,benchZ(16)),Bench4:v3(benchX,0,benchZ(19)),Bench5:v3(benchX,0,benchZ(22))}}function createFieldEllipseMesh(radiusX,radiusZ,segments,tileScale=1){const uvRepeatX=radiusX*2/1.6/tileScale,uvRepeatZ=radiusZ*2/2/tileScale,vertices=[0,0,0,.5,.5],indices=[];for(let i=0;i<=segments;i++){const angle=i/segments*2*Math.PI,x=Math.cos(angle)*radiusX,z=Math.sin(angle)*radiusZ,u=x/(radiusX*2)*uvRepeatX+.5,v=z/(radiusZ*2)*uvRepeatZ+.5;vertices.push(x,0,z,u,v),i>0&&indices.push(0,i,i+1)}return{vertices:new Float32Array(vertices),indices:new Uint16Array(indices)}}function createFieldLineMesh(W=160,L=170,arcR=50,CS=50,thickness=.4){const verts=[],indices=[];let index=0;function pushLineStrip(x0List,z0List,x1List,z1List){const startIndex=index;for(let i=0;i<x0List.length;i++)verts.push(x0List[i],0,z0List[i]),verts.push(x1List[i],0,z1List[i]),index+=2;for(let i=0;i<x0List.length-1;i++){const i0=startIndex+i*2,i1=i0+1,i2=i0+2,i3=i0+3;indices.push(i0,i1,i2,i2,i1,i3)}}function lineSegment(x0,z0,x1,z1,thickness2){const dx=x1-x0,dz=z1-z0,len2=Math.hypot(dx,dz),nx=-dz/len2,nz=dx/len2,t=thickness2/2,x0a=x0+nx*t,z0a=z0+nz*t,x0b=x0-nx*t,z0b=z0-nz*t,x1a=x1+nx*t,z1a=z1+nz*t,x1b=x1-nx*t,z1b=z1-nz*t;pushLineStrip([x0a,x1a],[z0a,z1a],[x0b,x1b],[z0b,z1b])}function ringSegment(cx,cz,r,thickness2,steps){const r0=r-thickness2/2,r1=r+thickness2/2,x0s=[],z0s=[],x1s=[],z1s=[];for(let i=0;i<=steps;i++){const a3=i/steps*2*Math.PI;x0s.push(cx+Math.cos(a3)*r0),z0s.push(cz+Math.sin(a3)*r0),x1s.push(cx+Math.cos(a3)*r1),z1s.push(cz+Math.sin(a3)*r1)}pushLineStrip(x0s,z0s,x1s,z1s)}const a2=W/2,b=L/2;{const x0s=[],z0s=[],x1s=[],z1s=[];for(let i=0;i<=64;i++){const theta=i/64*2*Math.PI,x=Math.cos(theta),z=Math.sin(theta);x0s.push(x*(a2-thickness/2)),z0s.push(z*(b-thickness/2)),x1s.push(x*(a2+thickness/2)),z1s.push(z*(b+thickness/2))}pushLineStrip(x0s,z0s,x1s,z1s)}const pts=[[-CS/2,-CS/2],[CS/2,-CS/2],[CS/2,CS/2],[-CS/2,CS/2]];for(let i=0;i<4;i++){const[x0,z0]=pts[i],[x1,z1]=pts[(i+1)%4];lineSegment(x0,z0,x1,z1,thickness)}function findValidArcAngles(goalZ){const towardCenter=goalZ>0?-1:1,validAngles=[];for(let i=0;i<=1e3;i++){const theta=-Math.PI+i/1e3*2*Math.PI,x=Math.sin(theta)*arcR,z=goalZ+towardCenter*Math.cos(theta)*arcR,normX=x/a2,normZ=z/b;normX*normX+normZ*normZ<=1&&validAngles.push(theta)}return validAngles.length===0?[-Math.PI/3,Math.PI/3]:[validAngles[0],validAngles[validAngles.length-1]]}for(let goalZ of[-L/2,L/2]){const towardCenter=goalZ>0?-1:1,[thetaStart,thetaEnd]=findValidArcAngles(goalZ),arcSteps=40,r0=arcR-thickness/2,r1=arcR+thickness/2,x0s=[],z0s=[],x1s=[],z1s=[];for(let i=0;i<=arcSteps;i++){const t=thetaStart+i/arcSteps*(thetaEnd-thetaStart),xInner=Math.sin(t)*r0,zInner=goalZ+towardCenter*Math.cos(t)*r0,xOuter=Math.sin(t)*r1,zOuter=goalZ+towardCenter*Math.cos(t)*r1;x0s.push(xInner),z0s.push(zInner),x1s.push(xOuter),z1s.push(zOuter)}pushLineStrip(x0s,z0s,x1s,z1s)}const GS_W=6.4,GS_L=9;for(let zSign of[-1,1]){const z=zSign*(L/2),z0=z,z1=z-zSign*GS_L,x0=-GS_W/2,x1=GS_W/2;lineSegment(x0,z0,x1,z0,thickness),lineSegment(x1,z0,x1,z1,thickness),lineSegment(x1,z1,x0,z1,thickness),lineSegment(x0,z1,x0,z0,thickness)}return ringSegment(0,0,3,thickness,48),ringSegment(0,0,10,thickness,64),lineSegment(-10,0,10,0,thickness),{vertices:new Float32Array(verts),indices:new Uint16Array(indices)}}function createFenceMesh(radiusX,radiusZ,offset=3.5,segments=128){const verts=[],indices=[],rX=radiusX+offset,rZ=radiusZ+offset,height=2.4,uScale=1/2;for(let i=0;i<=segments;i++){const theta=i/segments*2*Math.PI,x=Math.cos(theta)*rX,z=Math.sin(theta)*rZ,u=i*uScale;verts.push(x,0,z,u,1),verts.push(x,height,z,u,0)}for(let i=0;i<segments;i++){const base=i*2;indices.push(base,base+1,base+2),indices.push(base+2,base+1,base+3)}return{fenceVertices:new Float32Array(verts),fenceIndices:new Uint16Array(indices)}}function createStadiumMesh(rx0,rz0,rx1,rz1,h0,h1,segments=64){const verts=[],indices=[],avgRadius=(rx0+rz0+rx1+rz1)/4,uPerSegment=2*Math.PI*avgRadius/segments/3.2,vMax=Math.abs(h1-h0)/4.8;for(let i=0;i<=segments;i++){const theta=i/segments*2*Math.PI,cos=Math.cos(theta),sin=Math.sin(theta),x0=cos*rx0,z0=sin*rz0,x1=cos*rx1,z1=sin*rz1,u=i*uPerSegment;verts.push(x0,h0,z0,u,vMax),verts.push(x1,h1,z1,u,0)}for(let i=0;i<segments;i++){const base=i*2;indices.push(base,base+1,base+2),indices.push(base+2,base+1,base+3)}return{vertices:new Float32Array(verts),indices:new Uint16Array(indices)}}function createEllipticalStadiumRoofMesh(rx0,rz0,rx1,rz1,h1,segments=64){const verts=[],indices=[],h2=h1+5,h3=h2+4,rxMid=.5*(rx0+rx1),rzMid=.5*(rz0+rz1),rxInner=rxMid,rzInner=rzMid,tileU=3.2,tileV=4.8,avgRadius=.5*(rx1+rz1),uPerSegment=2*Math.PI*avgRadius/segments/tileU,vSlope=(h2-h1)/tileV,vDome=(h3-h2)/tileV;for(let i=0;i<=segments;i++){const theta=i/segments*2*Math.PI,cos=Math.cos(theta),sin=Math.sin(theta),u=i*uPerSegment,x1=cos*rx1,z1=sin*rz1,x2=cos*rxMid,z2=sin*rzMid,x3=cos*rxInner,z3=sin*rzInner;verts.push(x1,h1,z1,u,vSlope+vDome),verts.push(x2,h2,z2,u,vDome),verts.push(x3,h3,z3,u,0)}for(let i=0;i<segments;i++){const b=i*3;indices.push(b,b+1,b+3),indices.push(b+3,b+1,b+4),indices.push(b+1,b+2,b+4),indices.push(b+4,b+2,b+5)}return{vertices:new Float32Array(verts),indices:new Uint16Array(indices)}}function createAimTrajectoryMesh(start,velocity,gravity=-9.8,segments=32,width=.5){const verts=[],indices=[],y0=start[1],vy=velocity[1],g=gravity,disc=vy*vy-2*g*y0;if(disc<0)return{vertices:new Float32Array,indices:new Uint16Array};const t_flight=(-vy-Math.sqrt(disc))/g,dt=t_flight/segments,horizVel=[velocity[0],velocity[2]],horizLen=Math.hypot(...horizVel),nx=-horizVel[1]/horizLen,nz=horizVel[0]/horizLen;for(let i=0;i<=segments;i++){const t=i*dt,x=start[0]+velocity[0]*t,y=start[1]+velocity[1]*t+.5*g*t*t,z=start[2]+velocity[2]*t,taper=.2+.8*(t/t_flight),dynamicHalfW=width/2*taper,xL=x+nx*dynamicHalfW,zL=z+nz*dynamicHalfW,xR=x-nx*dynamicHalfW,zR=z-nz*dynamicHalfW;verts.push(xL,y,zL),verts.push(xR,y,zR)}const vertCount=verts.length/3;for(let i=0;i<vertCount-2;i+=2)indices.push(i,i+1,i+2),indices.push(i+2,i+1,i+3);return{vertices:new Float32Array(verts),indices:new Uint16Array(indices)}}const vertexSrc=`#version 300 es
    in vec3 a_position;
    in vec2 a_texcoord;
    uniform mat4 u_projection, u_view, u_model;
    out vec2 v_texcoord;
    void main() {
        gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
        v_texcoord = a_texcoord;
    }
`,fragSrc=`#version 300 es
precision mediump float;

uniform sampler2D u_texture;
uniform vec4 u_tileUV;
uniform bool u_tilingU;
uniform bool u_tilingV;
uniform vec4 u_tint;

in vec2 v_texcoord;
out vec4 outColor;

void main() {
    vec2 tileUV = v_texcoord;

    if (u_tilingU) tileUV.x = fract(tileUV.x);
    if (u_tilingV) tileUV.y = fract(tileUV.y);

    vec2 texCoord = mix(u_tileUV.xy, u_tileUV.zw, tileUV);

    vec2 texelSize = 1.0 / vec2(textureSize(u_texture, 0));
    vec2 epsilon = 0.5 * texelSize;
    texCoord = clamp(texCoord, u_tileUV.xy + epsilon, u_tileUV.zw - epsilon);

    vec4 texColor = texture(u_texture, texCoord);
    if (texColor.a < 0.01) discard;

    outColor = texColor * u_tint;
}
`,lineVertSrc=`#version 300 es
    in vec3 a_position;
    uniform mat4 u_projection;
    uniform mat4 u_view;
    uniform mat4 u_model;
    void main() {
        gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
    }`,lineFragSrc=`#version 300 es
    precision mediump float;
    uniform vec4 u_color;
    out vec4 out_color;
    void main() {
        out_color = u_color;
    }
`,SPRITE_WIDTH=16,SPRITE_HEIGHT=24,SHEET_WIDTH=512,SHEET_HEIGHT=768,SPRITE_PAD_X=0,SPRITE_PAD_Y=0,STRIDE_WIDTH=SPRITE_WIDTH+SPRITE_PAD_X,STRIDE_HEIGHT=SPRITE_HEIGHT+SPRITE_PAD_Y,FIELD_LENGTH=170,FIELD_RADIUS_X=80,FIELD_RADIUS_Z=FIELD_LENGTH/2;class Renderer{constructor(gl,canvas,spriteSheet){this.gl=gl,this.canvas=canvas,this.spriteSheet=spriteSheet,this.sheetCols=32,this.sheetRows=32,this.program=createShaderProgram(gl,vertexSrc,fragSrc),this.uProjection=gl.getUniformLocation(this.program,"u_projection"),this.uView=gl.getUniformLocation(this.program,"u_view"),this.uModel=gl.getUniformLocation(this.program,"u_model"),this.uTileUV=gl.getUniformLocation(this.program,"u_tileUV"),this.uTilingU=gl.getUniformLocation(this.program,"u_tilingU"),this.uTilingV=gl.getUniformLocation(this.program,"u_tilingV"),this.uTint=gl.getUniformLocation(this.program,"u_tint"),this.uTexture=gl.getUniformLocation(this.program,"u_texture"),this.aPos=gl.getAttribLocation(this.program,"a_position"),this.aUV=gl.getAttribLocation(this.program,"a_texcoord"),this.lineProgram=createShaderProgram(gl,lineVertSrc,lineFragSrc),this.lineProj=gl.getUniformLocation(this.lineProgram,"u_projection"),this.lineView=gl.getUniformLocation(this.lineProgram,"u_view"),this.lineModel=gl.getUniformLocation(this.lineProgram,"u_model"),this.linePos=gl.getAttribLocation(this.lineProgram,"a_position"),this.uLineColor=gl.getUniformLocation(this.lineProgram,"u_color"),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!0);const verts=new Float32Array([-.5,0,0,1,.5,0,1,1,.5,1,1,0,-.5,1,0,0]),indicesSprite=new Uint16Array([0,1,2,0,2,3]);this.quadVao=gl.createVertexArray(),gl.bindVertexArray(this.quadVao);const vboSprite=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vboSprite),gl.bufferData(gl.ARRAY_BUFFER,verts,gl.STATIC_DRAW),gl.vertexAttribPointer(this.aPos,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(this.aPos),gl.vertexAttribPointer(this.aUV,2,gl.FLOAT,!1,16,8),gl.enableVertexAttribArray(this.aUV);const eboSprite=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,eboSprite),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,indicesSprite,gl.STATIC_DRAW);const{vertices,indices}=createFieldEllipseMesh(FIELD_RADIUS_X,FIELD_RADIUS_Z,64,16);this.fieldVao=gl.createVertexArray(),gl.bindVertexArray(this.fieldVao);const vboField=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vboField),gl.bufferData(gl.ARRAY_BUFFER,vertices,gl.STATIC_DRAW),gl.vertexAttribPointer(this.aPos,3,gl.FLOAT,!1,20,0),gl.enableVertexAttribArray(this.aPos),gl.vertexAttribPointer(this.aUV,2,gl.FLOAT,!1,20,12),gl.enableVertexAttribArray(this.aUV);const eboField=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,eboField),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,indices,gl.STATIC_DRAW),this.fieldIndices=indices.length,this.fieldLineMesh=createFieldLineMesh(),this.lineVao=gl.createVertexArray(),gl.bindVertexArray(this.lineVao);const vboLine=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vboLine),gl.bufferData(gl.ARRAY_BUFFER,this.fieldLineMesh.vertices,gl.STATIC_DRAW);const eboLine=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,eboLine),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.fieldLineMesh.indices,gl.STATIC_DRAW),gl.vertexAttribPointer(this.linePos,3,gl.FLOAT,!1,12,0),gl.enableVertexAttribArray(this.linePos);const GOAL_WIDTH2=6.8;this.goalPostPositions=[[-3*GOAL_WIDTH2/2,0,FIELD_LENGTH],[-GOAL_WIDTH2/2,0,FIELD_LENGTH],[GOAL_WIDTH2/2,0,FIELD_LENGTH],[3*GOAL_WIDTH2/2,0,FIELD_LENGTH],[-3*GOAL_WIDTH2/2,0,0],[-GOAL_WIDTH2/2,0,0],[GOAL_WIDTH2/2,0,0],[3*GOAL_WIDTH2/2,0,0]];const{fenceVertices,fenceIndices}=createFenceMesh(FIELD_RADIUS_X,FIELD_RADIUS_Z);this.fenceVao=gl.createVertexArray(),gl.bindVertexArray(this.fenceVao);const vbo=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vbo),gl.bufferData(gl.ARRAY_BUFFER,fenceVertices,gl.STATIC_DRAW),gl.vertexAttribPointer(this.aPos,3,gl.FLOAT,!1,20,0),gl.enableVertexAttribArray(this.aPos),gl.vertexAttribPointer(this.aUV,2,gl.FLOAT,!1,20,12),gl.enableVertexAttribArray(this.aUV);const ebo=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,ebo),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,fenceIndices,gl.STATIC_DRAW),this.fenceIndices=fenceIndices.length;const radiusFenceX=FIELD_RADIUS_X+3.5,radiusFenceZ=FIELD_RADIUS_Z+3.5,stadiumMesh=createStadiumMesh(radiusFenceX+.5,radiusFenceZ+.5,radiusFenceX+30,radiusFenceZ+30,0,20);this.stadiumVao=gl.createVertexArray(),gl.bindVertexArray(this.stadiumVao);const vboStadium=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vboStadium),gl.bufferData(gl.ARRAY_BUFFER,stadiumMesh.vertices,gl.STATIC_DRAW),gl.vertexAttribPointer(this.aPos,3,gl.FLOAT,!1,20,0),gl.enableVertexAttribArray(this.aPos),gl.vertexAttribPointer(this.aUV,2,gl.FLOAT,!1,20,12),gl.enableVertexAttribArray(this.aUV);const eboStadium=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,eboStadium),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,stadiumMesh.indices,gl.STATIC_DRAW),this.stadiumIndices=stadiumMesh.indices.length;const roofMesh=createEllipticalStadiumRoofMesh(radiusFenceX+.5,radiusFenceZ+.5,radiusFenceX+30,radiusFenceZ+30,20);this.stadiumRoofVao=gl.createVertexArray(),gl.bindVertexArray(this.stadiumRoofVao);const vboRoof=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vboRoof),gl.bufferData(gl.ARRAY_BUFFER,roofMesh.vertices,gl.STATIC_DRAW),gl.vertexAttribPointer(this.aPos,3,gl.FLOAT,!1,20,0),gl.enableVertexAttribArray(this.aPos),gl.vertexAttribPointer(this.aUV,2,gl.FLOAT,!1,20,12),gl.enableVertexAttribArray(this.aUV);const eboRoof=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,eboRoof),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,roofMesh.indices,gl.STATIC_DRAW),this.stadiumRoofIndices=roofMesh.indices.length,gl.bindVertexArray(null),this.trajVao=gl.createVertexArray(),this.trajVbo=gl.createBuffer(),this.trajEbo=gl.createBuffer();const maxPoints=128;gl.bindVertexArray(this.trajVao),gl.bindBuffer(gl.ARRAY_BUFFER,this.trajVbo);const maxVertices=maxPoints*2;gl.bufferData(gl.ARRAY_BUFFER,maxVertices*12,gl.DYNAMIC_DRAW),gl.vertexAttribPointer(this.linePos,3,gl.FLOAT,!1,12,0),gl.enableVertexAttribArray(this.linePos),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.trajEbo),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,6*(maxPoints-1)*Uint16Array.BYTES_PER_ELEMENT,gl.DYNAMIC_DRAW),gl.pixelStorei(gl.UNPACK_ALIGNMENT,1),gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1),this.texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,this.texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this.spriteSheet),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,this.texture),gl.enable(gl.DEPTH_TEST),gl.depthFunc(gl.LEQUAL),this.fovy=45*Math.PI/180,this.projection=create$2(),this.view=create$2(),this.model=create$2(),this.updateProjection()}updateProjection(){this.projection=create$2(),perspective(this.projection,this.fovy,this.canvas.width/this.canvas.height,.1,1e3)}renderSprite(pos,width,height,col,row,tint=[1,1,1,1]){const{gl,program,quadVao,uModel,uTileUV,sheetCols,sheetRows}=this;gl.useProgram(program),gl.bindVertexArray(quadVao);const model=create$2();translate(model,model,pos),scale(model,model,[width,height,1]),gl.uniformMatrix4fv(uModel,!1,model),this.setTileUV(col,row),gl.uniform1i(this.uTilingU,0),gl.uniform1i(this.uTilingV,0),tint?gl.uniform4f(this.uTint,tint[0],tint[1],tint[2],tint[3]):gl.uniform4f(this.uTint,1,1,1,1),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)}setTileUV(col,row,tileWidthPx=SPRITE_WIDTH,tileHeightPx=SPRITE_HEIGHT){const u0=(col*STRIDE_WIDTH+SPRITE_PAD_X/2)/SHEET_WIDTH,v0=(row*STRIDE_HEIGHT+SPRITE_PAD_Y/2)/SHEET_HEIGHT,u1=(col*STRIDE_WIDTH+SPRITE_PAD_X/2+tileWidthPx)/SHEET_WIDTH,v1=(row*STRIDE_HEIGHT+SPRITE_PAD_Y/2+tileHeightPx)/SHEET_HEIGHT;this.gl.uniform4f(this.uTileUV,u0,v0,u1,v1)}getApproxVisibleFieldWidthAtZ(cameraPos,zWorld){const aspect=this.canvas.width/this.canvas.height,fov=Math.PI/4;return 2*(cameraPos[2]-zWorld)*Math.tan(fov/2)*aspect}renderScene(game,entities){const gl=this.gl;gl.viewport(0,0,this.canvas.width,this.canvas.height),gl.clearColor(.2,.6,.2,1),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),lookAt(this.view,game.cameraPos,game.cameraTarget,[0,1,0]),gl.useProgram(this.program),gl.uniformMatrix4fv(this.uProjection,!1,this.projection),gl.uniformMatrix4fv(this.uView,!1,this.view),gl.uniform4f(this.uTint,1,1,1,1),gl.activeTexture(gl.TEXTURE0),gl.uniform1i(this.uTexture,0),gl.bindVertexArray(this.fieldVao),identity(this.model),translate(this.model,this.model,[0,0,FIELD_RADIUS_Z]),gl.uniformMatrix4fv(this.uModel,!1,this.model),this.setTileUV(0,2),gl.uniform1i(this.uTilingU,1),gl.uniform1i(this.uTilingV,1),gl.drawElements(gl.TRIANGLES,this.fieldIndices,gl.UNSIGNED_SHORT,0),gl.enable(gl.CULL_FACE),gl.cullFace(gl.FRONT),gl.frontFace(gl.CCW),gl.uniformMatrix4fv(this.uModel,!1,this.model),gl.bindVertexArray(this.stadiumVao),this.setTileUV(7,2),gl.uniform1i(this.uTilingU,1),gl.uniform1i(this.uTilingV,1),gl.drawElements(gl.TRIANGLES,this.stadiumIndices,gl.UNSIGNED_SHORT,0),this.setTileUV(8,2),gl.uniform1i(this.uTilingU,1),gl.uniform1i(this.uTilingV,1),gl.bindVertexArray(this.stadiumRoofVao),gl.drawElements(gl.TRIANGLES,this.stadiumRoofIndices,gl.UNSIGNED_SHORT,0),gl.disable(gl.CULL_FACE),gl.bindVertexArray(this.fenceVao),this.setTileUV(3,2,48,24),gl.uniform1i(this.uTilingU,1),gl.uniform1i(this.uTilingV,0),gl.drawElements(gl.TRIANGLES,this.fenceIndices,gl.UNSIGNED_SHORT,0),gl.useProgram(this.lineProgram),gl.uniform4f(this.uLineColor,1,1,1,1),gl.uniformMatrix4fv(this.lineProj,!1,this.projection),gl.uniformMatrix4fv(this.lineView,!1,this.view);const model=create$2();translate(model,this.model,[0,.01,0]),gl.uniformMatrix4fv(this.lineModel,!1,model),gl.bindVertexArray(this.lineVao),gl.drawElements(gl.TRIANGLES,this.fieldLineMesh.indices.length,gl.UNSIGNED_SHORT,0),gl.useProgram(this.program),gl.uniform4f(this.uTint,1,1,1,1),gl.bindVertexArray(this.quadVao),this.setTileUV(1,2),gl.uniform1i(this.uTilingU,0),gl.uniform1i(this.uTilingV,1);for(let i=0;i<this.goalPostPositions.length;i++){const[x,y,z]=this.goalPostPositions[i],baseHeight=i%4===0||i%4===3?6:10,dx=game.cameraPos[0]-x,dz=game.cameraPos[2]-z,dist2=Math.sqrt(dx*dx+dz*dz),scaleLOD=dist2>50?1.5:dist2>150?2:1,postModel=create$2();translate(postModel,postModel,[x,y,z]),scale(postModel,postModel,[scaleLOD,baseHeight,1]),gl.uniformMatrix4fv(this.uModel,!1,postModel),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)}gl.bindVertexArray(this.quadVao);for(const entity of entities)entity instanceof Entity&&entity.render(this);if(game.ball.carrier){const carrier=game.ball.carrier,teamTint=carrier.actionState==="tackled"?[1,0,0,1]:[1,1,1,1],bob=.2*Math.sin(performance.now()/200),pos=[carrier.pos[0],carrier.pos[1]+2.4+.2+bob,carrier.pos[2]];this.renderSprite(pos,1,2.4,carrier.team==="away"?5:6,3,teamTint)}const aimTarget=game.controls.getState().aimTarget;if(game.player&&game.aimTarget.render(this),game.player&&game.ball.carrier===game.player&&game.player.actionState==="run"&&game.controls.state.kickAimActive&&aimTarget!==null){const vel=computeKickVelocity(game.player,aimTarget,!1);if(!vel)return;const pos=game.player.pos.c,mesh=createAimTrajectoryMesh(pos,vel,-9.8,32);gl.useProgram(this.lineProgram);const[r,g,b,a2]=game.aimTarget.tint;gl.uniform4f(this.uLineColor,r,g,b,a2),gl.uniformMatrix4fv(this.lineProj,!1,this.projection),gl.uniformMatrix4fv(this.lineView,!1,this.view);const model2=create$2();translate(model2,model2,[0,.01,0]),gl.uniformMatrix4fv(this.lineModel,!1,model2),gl.bindVertexArray(this.trajVao),gl.bindBuffer(gl.ARRAY_BUFFER,this.trajVbo),gl.bufferSubData(gl.ARRAY_BUFFER,0,mesh.vertices),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.trajEbo),gl.bufferSubData(gl.ELEMENT_ARRAY_BUFFER,0,mesh.indices),gl.drawElements(gl.TRIANGLES,mesh.indices.length,gl.UNSIGNED_SHORT,0)}}}class Vec22 extends Array{constructor(vec=[0,0]){super(),this[0]=vec[0],this[1]=vec[1]}equals(vec){return this.length===vec.length&&this[0]===vec[0]&&this[1]===vec[1]}static random(vec){return new Vec22(getRandomPos(vec[0],vec[1]))}add(vec){return new Vec22([this[0]+vec[0],this[1]+vec[1]])}sub(vec){return new Vec22([this[0]-vec[0],this[1]-vec[1]])}floor(){return new Vec22([Math.floor(this[0]),Math.floor(this[1])])}ceil(){return new Vec22([Math.floor(this[0]),Math.floor(this[1])])}scale(scalar){return new Vec22([this[0]*scalar,this[1]*scalar])}mul(vec){return new Vec22([this[0]*vec[0],this[1]*vec[1]])}div(vec){return new Vec22([this[0]/vec[0],this[1]/vec[1]])}dot(vec){return this[0]*vec[0]+this[1]*vec[1]}dist(vec){return Math.hypot(this[0]-vec[0],this[1]-vec[1])}abs(){return new Vec22([Math.abs(this[0]),Math.abs(this[1])])}sum(){return this[0]+this[1]}relativeTo(rect){return this.sub(rect.pos).div(rect.size)}absoluteFrom(rect){return this.mul(rect.size).add(rect.pos)}relativeToPS(pos,sz){return this.sub(pos).scale(1/sz)}absoluteFromPS(pos,sz){return this.scale(sz).add(pos)}set x(val){this[0]=val}set y(val){this[1]=val}get x(){return this[0]}get y(){return this[1]}}class Rect extends Array{constructor(rect=null){if(super(),rect===null){this[0]=0,this[1]=0,this[2]=0,this[3]=0;return}this[0]=rect[0],this[1]=rect[1],this[2]=rect[2],this[3]=rect[3]}set x(val){this[0]=val}set y(val){this[1]=val}set w(val){this[2]=val}set h(val){this[3]=val}set pos(vec){this[0]=vec[0],this[1]=vec[1]}set size(vec){this[2]=vec[0],this[3]=vec[1]}get size(){return new Vec22([this[2],this[3]])}get pos(){return new Vec22([this[0],this[1]])}get x(){return this[0]}get y(){return this[1]}get w(){return this[2]}get h(){return this[3]}get right(){return this[0]+this[2]}get bottom(){return this[1]+this[3]}get center_x(){return this[0]+this[2]/2}get center_y(){return this[1]+this[3]/2}get center(){return new Vec22([this.center_x,this.center_y])}grow(amount){return new Rect([this[0]-amount,this[1]-amount,this[2]+2*amount,this[3]+2*amount])}get flooredCenter(){return new Vec22([Math.floor(this[0]+this[2]/2),Math.floor(this[1]+this[3]/2)])}translate(pos){return new Rect([this.x+pos[0],this.y+pos[1],this.w,this.h])}shrinkBorders(value){return new Rect([this.x+value,this.y+value,this.w-value*2,this.h-value*2])}scaleBorders(scale2){return new Rect([this.x+this.w*(1-scale2)/2,this.y+this.h*(1-scale2)/2,this.w*scale2,this.h*scale2])}mult(scalar){return new Rect([this[0]*scalar,this[1]*scalar,this[2]*scalar,this[3]*scalar])}multXY(vec){return new Rect([this[0]*vec[0],this[1]*vec[1],this[2]*vec[0],this[3]*vec[1]])}scale(scalar,centered=!0){if(centered){let news=[this[2]*scalar,this[3]*scalar];return new Rect([this[0]+.5*(this[2]-news[0]),this[1]+.5*(this[3]-news[1]),news[0],news[1]])}else{let news=[this[2]*scalar,this[3]*scalar];return new Rect([this[0],this[1],news[0],news[1]])}}collideRadius(rect,radius=null){let d=[this.center_x-rect.center_x,this.center_y-rect.center_y];return radius===null&&(radius=Math.min(this.w,this.h,rect.w,rect.h)/2),d[0]*d[0]+d[1]*d[1]<radius*radius}collide(rect){return this.x<rect.x+rect.w&&this.x+this.w>rect.x&&this.y<rect.y+rect.h&&this.h+this.y>rect.y}contains(rect){return this.x<=rect.x&&this.y<=rect.y&&this.x+this.w>=rect.x+rect.w&&this.y+this.h>=rect.y+rect.h}contact(rect){return this.x<=rect.x+rect.w&&this.x+this.w>=rect.x&&this.y<=rect.y+rect.h&&this.h+this.y>=rect.y}contactRadius(rect,radius=null){let d=[this.center_x-rect.center_x,this.center_y-rect.center_y];return radius===null&&(radius=Math.min(this.w,this.h,rect.w,rect.h)),d[0]*d[0]+d[1]*d[1]<=radius*radius}}class Grid2D extends Array{constructor(tileDim=[0,0],initialData=void 0){initialData===void 0?super(tileDim[0]*tileDim[1]):super(...initialData),this.tileDim=new Vec22(tileDim),this.hidden=!1,this._cacheData=null}clone(){return new Grid2D(this.tileDim,this)}get(pos){return this[pos[0]+pos[1]*this.tileDim[0]]}set(pos,val){this[pos[0]+pos[1]*this.tileDim[0]]=val}*iterBetween(pos1,pos2,tol=0){var x1,y1,x2,y2;if([x1,y1]=pos1,[x2,y2]=pos2,!(Math.abs(y2-y1)==0&&Math.abs(x2-x1)==0))if(Math.abs(y2-y1)>Math.abs(x2-x1)){var slope=(x2-x1)/(y2-y1);if(y1>y2)for(var y=y1;y>=y2;y--){var xa=x1+(y-y1)*slope;yield[xa,y]}else for(var y=y1;y<=y2;y++){var xa=x1+(y-y1)*slope;yield[xa,y]}}else{var slope=(y2-y1)/(x2-x1);if(x1>x2)for(var x=x1;x>=x2;x--){var ya=y1+(x-x1)*slope;yield[x,ya]}else for(var x=x1;x<=x2;x++){var ya=y1+(x-x1)*slope;yield[x,ya]}}}*iterInBetween(pos1,pos2){var x1,y1,x2,y2;if([x1,y1]=pos1,[x2,y2]=pos2,!(Math.abs(y2-y1)==0&&Math.abs(x2-x1)==0))if(Math.abs(y2-y1)>Math.abs(x2-x1)){var slope=(x2-x1)/(y2-y1);if(y1>y2)for(var y=y1-1;y>y2;y--){var x=Math.round(x1+(y-y1)*slope);yield[x,y]}else for(var y=y1+1;y<y2;y++){var x=Math.round(x1+(y-y1)*slope);yield[x,y]}}else{var slope=(y2-y1)/(x2-x1);if(x1>x2)for(var x=x1-1;x>x2;x--){var y=Math.round(y1+(x-x1)*slope);yield[x,y]}else for(var x=x1+1;x<x2;x++){var y=Math.round(y1+(x-x1)*slope);yield[x,y]}}}*iterTypesBetween(pos1,pos2,types){for(var pos of this.iterBetween(pos1,pos2))types.includes(this.get(pos))&&(yield pos)}*iterTypesInBetween(pos1,pos2,types){for(var pos of this.iterInBetween(pos1,pos2))types.includes(this.get(pos))&&(yield pos)}hasTypesBetween(pos1,pos2,types){for(var pos of this.iterTypesBetween(pos1,pos2,types))return!0;return!1}hasTypesInBetween(pos1,pos2,types){for(var pos of this.iterTypesInBetween(pos1,pos2,types))return!0;return!1}*iterAll(sub_rect=null){const[tw,th]=this.tileDim;if(sub_rect!==null)for(var y=sub_rect[1];y<Math.min(th,sub_rect[1]+sub_rect[3]);y++)for(var x=sub_rect[0];x<Math.min(tw,sub_rect[0]+sub_rect[2]);x++)yield[x,y];else for(var y=0;y<th;y++)for(var x=0;x<tw;x++)yield[x,y]}*iterTypes(types,sub_rect){for(var pos of this.iterAll(sub_rect))types.includes(this.get(pos))&&(yield pos)}*iterAdjacent(pos,diagonal=!1){pos=new Vec22(pos);const dirs=diagonal?[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]]:[[0,-1],[1,0],[0,1],[-1,0]];for(let dir of dirs){const npos=pos.add(dir);npos[0]>=0&&npos[0]<this.tileDim[0]&&npos[1]>=0&&npos[1]<this.tileDim[1]&&(yield npos)}}hasAdjacent(pos,types,diagonal=!1){for(let npos of this.iterAdjacent(pos,diagonal))if(types.includes(this.get(npos)))return!0;return!1}*iterInRange(pos,radius){var x,y;[x,y]=pos;const[tw,th]=this.tileDim;radius==null&&(radius=3);for(var rad=Math.ceil(radius),yoff=-rad;yoff<rad+1;yoff++)for(var xoff=-rad;xoff<rad+1;xoff++)if(xoff*xoff+yoff*yoff<=radius*radius){var x0=x+xoff,y0=y+yoff;0<=y0&&y0<th&&0<=x0&&x0<tw&&(yield[x0,y0])}}*iterTypesInRange(pos,types,radius,blocker_types=null){for(var pos0 of this.iterInRange(pos,radius))blocker_types!==null&&this.hasTypesBetween(pos,pos0,blocker_types)||types.includes(this.get(pos0))&&(yield pos0)}numInRange(pos,types,radius,blocker_types=null){var num=0;for(var pos0 of this.iterTypesInRange(pos,types,radius,blocker_types))num++;return num}*iterRectBoundary(rect){const[tw,th]=this.tileDim;let xl=Math.min(Math.max(rect.x,0),tw),xu=Math.min(Math.max(rect.x+rect.w,0),tw),yl=Math.min(Math.max(rect.y,0),th),yu=Math.min(Math.max(rect.y+rect.h,0),th);for(let x0=xl;x0<xu;x0++)yield[x0,yl];for(let x0=xl;x0<xu;x0++)yield[x0,yu];for(let y0=yl;y0<yu;y0++)yield[xl,y0];for(let y0=yl;y0<yu;y0++)yield[xu,y0]}*iterRect(rect,mustFit=!0){const[tw,th]=this.tileDim;if(rect instanceof Rect||(rect=new Rect(rect)),mustFit&&(rect.x<0||rect.y<0||rect.right>tw||rect.bottom>th))return;let xl=Math.max(rect.x,0),xu=Math.min(rect.x+rect.w,tw),yl=Math.max(rect.y,0),yu=Math.min(rect.y+rect.h,th);for(let y0=yl;y0<yu;y0++)for(let x0=xl;x0<xu;x0++)yield[x0,y0]}numInRect(rect,targets,mustFit=!0){let num=0;for(var pos of this.iterRect(rect,mustFit))targets.includes(this.get(pos))&&num++;return num}}const minFontSize=8,scaleFactor=48*(1/window.devicePixelRatio||1);function sizeText(ctx,text,size,fontName,centered,rect,color){let scale2=1;size<minFontSize&&(scale2=1/scaleFactor,ctx.save(),ctx.scale(scale2,scale2)),ctx.fillStyle=color,ctx.font=(size>=minFontSize?size:Math.ceil(size/scale2))+"px "+fontName,rect.x;let w=scale2*ctx.measureText(text).width;return size<minFontSize&&ctx.restore(),[w,2*size]}function getTextData(ctx,text,size,fontName,halign,valign,rect,color){let scale2=1;size<minFontSize&&(scale2=1/scaleFactor,ctx.save(),ctx.scale(scale2,scale2)),ctx.fillStyle=color,ctx.font=(size>=minFontSize?size:Math.ceil(size/scale2))+"px "+fontName;let textX=rect.x,metrics=ctx.measureText(text),textY=rect.y;switch(halign){case"left":break;case"center":textX+=(rect.w-scale2*metrics.width)/2;break;case"right":textX+=rect.w-scale2*metrics.width;break}switch(valign){case"top":break;case"middle":textY+=rect.h/2;break;case"bottom":textY+=rect.h;break}let textData={outText:[[text,textX/scale2,textY/scale2]],color,fontName,size,valign};return size<minFontSize&&ctx.restore(),textData}function drawText(ctx,textData,color=null){let scale2=1,size=textData.size;switch(color==null&&(color=textData.color),size<minFontSize&&(scale2=1/scaleFactor,ctx.save(),ctx.scale(scale2,scale2)),textData.valign){case"top":ctx.textBaseline="top";break;case"middle":ctx.textBaseline="middle";break;case"bottom":ctx.textBaseline="bottom";break}ctx.fillStyle=color,ctx.font=(size>=minFontSize?size:Math.ceil(size/scale2))+"px "+textData.fontName;let[t,x,y]=textData.outText[0];ctx.fillText(t,x,y),size<minFontSize&&ctx.restore()}function sizeWrappedText(ctx,text,size,fontName,centered,rect,color,wordwrap=!0){let scale2=1;size<minFontSize&&(scale2=1/scaleFactor,ctx.save(),ctx.scale(scale2,scale2)),ctx.font=(size>=minFontSize?size:Math.ceil(size/scale2))+"px "+fontName;let h=0,paraText="",guess=Math.min(Math.max(1,Math.ceil(text.length*rect.w/ctx.measureText(text).width/scale2)),text.length);for(;text!=""||paraText!="";){if(paraText==""){let n=text.indexOf(`
`);n>=0?(paraText=text.slice(0,n),text=text.slice(n+1)):(paraText=text,text="")}let nextLine=paraText.slice(0,guess),w=scale2*ctx.measureText(nextLine).width;if(w>rect.w&&guess>1)for(;w>rect.w&&guess>1;)guess--,nextLine=paraText.slice(0,guess),w=scale2*ctx.measureText(nextLine).width;if(w<rect.w&&guess<paraText.length){for(;w<rect.w&&guess<paraText.length;)guess++,nextLine=paraText.slice(0,guess),w=scale2*ctx.measureText(nextLine).width;w>rect.w&&guess--}if(wordwrap&&nextLine[-1]!=""&&paraText[guess]!=" "&&paraText[guess]!="	"){let lastIndex=Math.max(nextLine.lastIndexOf(" "),nextLine.lastIndexOf("	"));lastIndex>=0&&(guess-=nextLine.length-lastIndex-1)}guess=Math.max(1,guess),nextLine=paraText.slice(0,guess),paraText=paraText.slice(guess),wordwrap&&(paraText=paraText.trimStart()),h+=size}return h+=size,size<minFontSize&&ctx.restore(),[rect.w,h]}function getWrappedTextData(ctx,text,size,fontName,halign,valign,rect,color,wordwrap=!0){let scale2=1;size<minFontSize&&(scale2=1/scaleFactor,ctx.save(),ctx.scale(scale2,scale2)),ctx.fillStyle=color,ctx.font=(size>=minFontSize?size:Math.ceil(size/scale2))+"px "+fontName;let y=rect.y,outText=[],paraText="",guess=Math.min(Math.max(1,Math.ceil(text.length*(rect.w/ctx.measureText(text).width)/scale2)),text.length);for(;text!=""||paraText!="";){if(paraText==""){let n=text.indexOf(`
`);n>=0?(paraText=text.slice(0,n),text=text.slice(n+1)):(paraText=text,text="")}let x=rect.x,nextLine=paraText.slice(0,guess),w=scale2*ctx.measureText(nextLine).width;if(w>rect.w&&guess>1)for(;w>rect.w&&guess>1;)guess--,nextLine=paraText.slice(0,guess),w=scale2*ctx.measureText(nextLine).width;if(w<rect.w&&guess<paraText.length){for(;w<rect.w&&guess<paraText.length;)guess++,nextLine=paraText.slice(0,guess),w=scale2*ctx.measureText(nextLine).width;w>rect.w&&guess--}if(wordwrap&&guess<paraText.length&&nextLine[-1]!=""&&paraText[guess]!=" "&&paraText[guess]!="	"){let lastIndex=Math.max(nextLine.lastIndexOf(" "),nextLine.lastIndexOf("	"));lastIndex>=0&&(guess-=nextLine.length-lastIndex-1)}switch(guess=Math.max(1,guess),nextLine=paraText.slice(0,guess),paraText=paraText.slice(guess),wordwrap&&(paraText=paraText.trimStart()),w=scale2*ctx.measureText(nextLine).width,halign){case"left":break;case"center":x+=(rect.w-w)/2;break;case"right":x+=rect.w-w;break}outText.push([nextLine,x/scale2,y/scale2]),y+=size}let h=y-rect.y,off=0;switch(valign){case"top":off=0;break;case"middle":off=(rect.h-h)/2+size/2;break;case"bottom":off=rect.h-h+size}let textData={size,fontName,outText,off:off/scale2,color,valign};return size<minFontSize&&ctx.restore(),textData}function drawWrappedText(ctx,textData,color=null){let scale2=1,size=textData.size;switch(color===null&&(color=textData.color),size<minFontSize&&(scale2=1/scaleFactor,ctx.save(),ctx.scale(scale2,scale2)),textData.valign){case"top":ctx.textBaseline="top";break;case"middle":ctx.textBaseline="middle";break;case"bottom":ctx.textBaseline="bottom";break}ctx.fillStyle=color,ctx.font=(size>=minFontSize?size:Math.ceil(size/scale2))+"px "+textData.fontName;for(let tdat of textData.outText)ctx.fillText(tdat[0],tdat[1],tdat[2]+(textData.off??0));size<minFontSize&&ctx.restore()}const clamp=(num,min,max)=>Math.min(Math.max(num,min),max);function dist(pos1,pos2){return new Vec22(pos1).dist(pos2)}function colorString(vec){let r,g,b;return[r,g,b]=new MathArray(vec).scale(255).map(x=>Math.floor(x)),"#"+r.toString(16).padStart(2,"0")+g.toString(16).padStart(2,"0")+b.toString(16).padStart(2,"0")}class MathArray extends Array{constructor(...arr){arr.length==1&&arr[0]instanceof Array?super(...arr[0]):super(...arr)}static asRandomFloats(size,low=0,high=1){let a2=new MathArray(size);for(let i=0;i<a2.length;i++)a2[i]=randomFloat(low,high);return a2}sum(){let s=0;return this.forEach(el=>s+=el),s}mean(){return this.sum()/this.length}max(){return Math.max.apply(null,this)}min(){return Math.min.apply(null,this)}vars(){let s=0;return this.forEach(el=>s+=el*el),(s-this.length*this.mean()^2)/(this.length-1)}var(){let s=0;return this.forEach(el=>s+=el*el),s/this.length-this.mean()^2}std(){return Math.sqrt(this.var())}add(arr2){let a2=new MathArray(this);if(arr2 instanceof Array)for(let i=0;i<this.length;i++)a2[i]+=arr2[i];else for(let i=0;i<this.length;i++)a2[i]+=arr2;return a2}mul(arr2){let a2=new MathArray(this);if(arr2 instanceof Array)for(let i=0;i<this.length;i++)a2[i]*=arr2[i];else for(let i=0;i<this.length;i++)a2[i]*=arr2;return a2}scale(scalar){const arr=Array();for(let val of this)arr.push(val*scalar);return arr}dot(arr2){return this.mul(arr2).sum()}abs(){return Math.abs.apply(null,this)}lag(k){let a2=new MathArray;for(let i=-k;i<this.length-k;i++)i<0||i>=this.length?a2.push(NaN):a2.push(this[i]);return a2}filter(func){return new MathArray(super.filter(func))}dropNaN(){return this.filter(el=>!Number.isNaN(el))}}class Touch{constructor(props={}){__publicField(this,"identifier",-1);__publicField(this,"pos",[0,0]);__publicField(this,"state","touch_up");__publicField(this,"device","touch");__publicField(this,"nativeObject",null);__publicField(this,"nativeEvent",null);for(let p in props)this[p]=props[p]}copy(){return new Touch({pos:[...this.pos],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}asChildTouch(widget){return new Touch({pos:[...widget.toChild(this.pos)],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}get rect(){return new Rect([...this.pos,0,0])}set x(value){this.pos[0]=value}set y(value){this.pos[1]=value}get x(){return this.pos[0]}get y(){return this.pos[1]}get grabbed(){return App.get().inputHandler.grabbed}grab(widget){App.get().inputHandler.grab(widget)}ungrab(){App.get().inputHandler.ungrab()}}class InputHandler{constructor(app){__publicField(this,"grabbed",null);__publicField(this,"mouseTouchEmulation",!0);__publicField(this,"mouseev",null);__publicField(this,"keyStates",{});this.app=app,this.canvas=app.canvas;let canvas=this.canvas,that=this;document.addEventListener("keydown",function(ev){that.process_key(ev,"key_down")},!0),document.addEventListener("keyup",function(ev){that.process_key(ev,"key_up")},!0),canvas.addEventListener("mousedown",function(ev){that.process_mouse(ev,"mouse_down")},!0),canvas.addEventListener("mousemove",function(ev){that.process_mouse(ev,"mouse_move")},!0),canvas.addEventListener("mouseout",function(ev){that.process_mouse(ev,"mouse_cancel")},!0),canvas.addEventListener("mouseup",function(ev){that.process_mouse(ev,"mouse_up")},!0),canvas.addEventListener("touchstart",function(ev){that.process_touch(ev,"touch_down")},!1),canvas.addEventListener("touchmove",function(ev){that.process_touch(ev,"touch_move")},!1),canvas.addEventListener("touchcancel",function(ev){that.process_touch(ev,"touch_cancel")},!1),canvas.addEventListener("touchend",function(ev){that.process_touch(ev,"touch_up")},!1),canvas.addEventListener("wheel",function(ev){that.process_wheel(ev,"wheel")},!0),window.history.replaceState(null,document.title,location.pathname+"#!/backbutton"),window.history.pushState(null,document.title,location.pathname),window.addEventListener("popstate",function(ev){that.process_back(ev,"back_button")},!1)}grab(widget){this.grabbed=widget}ungrab(){this.grabbed=null}isKeyUp(key){return key in this.keyStates&&this.keyStates[key]}isKeyDown(key){return key in this.keyStates&&this.keyStates[key]}process_key(ev,name){this.app.requestFrameUpdate();const oldKeyState=this.keyStates[ev.key];name==="key_up"?this.keyStates[ev.key]=!1:name==="key_down"&&(this.keyStates[ev.key]=!0),this.app.emit(name,{states:this.keyStates,oldState:oldKeyState,event:ev})}process_touch(ev,name){if(this.app.requestFrameUpdate(),this.grabbed!==null)for(let to of ev.changedTouches){let pos=this.grabbed.appToChild([to.clientX,to.clientY]),t=new Touch({pos,state:name,nativeObject:to,nativeEvent:ev,identifier:to.identifier});this.grabbed.emit(name,t)}else for(let to of ev.changedTouches){let t=new Touch({pos:this.app.toChild([to.clientX,to.clientY]),state:name,nativeObject:to,nativeEvent:ev,identifier:to.identifier});this.app.childEmit(name,t,!0)}ev.preventDefault()}process_back(ev,name){location.hash==="#!/backbutton"&&(history.replaceState(null,document.title,location.pathname),this.app.childEmit("back_button",ev))}process_mouse(ev,name){if(this.app.requestFrameUpdate(),this.mouseev=ev,ev.preventDefault(),this.mouseTouchEmulation){let mapping={mouse_up:"touch_up",mouse_down:"touch_down",mouse_move:"touch_move",mouse_cancel:"touch_cancel"};if(ev.buttons!==1&&name!=="mouse_up")return;if(this.grabbed!==null){let pos0=[ev.clientX,ev.clientY],pos=this.grabbed.appToChild(pos0),t=new Touch({pos,state:mapping[name],nativeObject:ev,identifier:-1});this.grabbed.emit(mapping[name],t)}else{let t=new Touch({pos:this.app.toChild([ev.clientX,ev.clientY]),state:mapping[name],nativeObject:ev,identifier:-1});this.app.childEmit(mapping[name],t,!0)}}else this.grabbed!==null?this.grabbed.emit(name,ev):this.app.childEmit(name,ev,!0)}process_wheel(ev,name){if(this.mouseev!=null){if(this.app.requestFrameUpdate(),this.grabbed!=null){let pos=this.grabbed.appToChild([this.mouseev.clientX,this.mouseev.clientY]),t=new Touch({pos,state:name,nativeObject:ev});return this.grabbed.emit(name,t)}else{let t=new Touch({pos:this.app.toChild([this.mouseev.clientX,this.mouseev.clientY]),state:name,nativeObject:ev});this.app.childEmit(name,t,!0)}ev.preventDefault()}}vibrate(intensity1,intensity2,duration){window.navigator.vibrate(duration)}}function evaluatedProperty(key,value,context,root){if(typeof value=="string"||value instanceof String){if(key.startsWith("on_"))return new Function("resources","parent","root",`return function(event, object, value) {${value}}`).bind(context)(App.resources,context.parent,root);if(value.trim().startsWith("(")&&value.indexOf("=>")<value.indexOf(`
`)){const func=new Function("resources","parent","root",`return ${value}`).bind(context)(App.resources,context.parent,root);return func.markupMethod=!0,func}const objs=new Set;let objCount=0;if(value[0]!=="'"&&value[0]!=='"')for(let m of value.matchAll(/(?!\.)\b([a-z]\w*)\.([a-z_]\w*)\b/ig)){const c=m[1];c!=="this"&&c!=="parent"&&c!=="root"&&c!=="resources"&&objs.add(c),objCount++}if(objCount===0)return new Function("resources",`return ${value};`)(App.resources);const objStr=[...objs].join(", "),functionBody=`return function (${objStr}) { return ${value} }`,dynamicFunc=new Function("resources","parent","root",functionBody)(App.resources,context.parent,root).bind(context);return dynamicFunc.text=`(${objStr}) => ${value}`,dynamicFunc}return value}function instanceClassData(widget,objectData,rootWidget){const props={},clsName=widget.constructor.name,merged={...App.rules.get(clsName),...objectData};for(let p in merged){const val=merged[p];if(p==="children"&&val instanceof Array){const ch=[];for(let c of val)if(c instanceof Object&&"cls"in c){const[cls,clsExtends]=App.classes[c.cls],childWidget=cls.a();instanceClassData(childWidget,c,rootWidget),ch.push(childWidget)}else throw Error(`Unknown child class ${c} on clsName ${clsName}`);widget instanceof App?widget.baseWidget.children=ch:widget.children=ch}else if(p!=="cls")try{props[p]=evaluatedProperty(p,val,widget,rootWidget)}catch{props[p]=val}}widget.updateProperties(props)}class Timer{constructor(time,initElapsed=0,callback=null){this.elapsed=0,this.timer=time,this.triggered=!1,this.callback=callback,initElapsed>0&&this.tick(initElapsed)}finished(){return this.elapsed>=this.timer}tick(millis){return this.elapsed>=this.timer?(this.triggered&&(this.triggered=!1),!1):(this.elapsed+=millis,this.elapsed>=this.timer?(this.callback!=null&&this.callback("timer",this),this.triggered=!0,!0):!1)}reset(time=-1,initElapsed=0){this.triggered=!1,time>=0&&(this.timer=time),initElapsed>0?this.tick(initElapsed):this.elapsed=0}}class Rules{constructor(){this.rules=new Map}add(widgetClass,ruleProperties,replace=!0){let curRuleset=this.rules.get(widgetClass);if(curRuleset&&!replace)for(let p in curRuleset)curRuleset[p]=ruleProperties[p];else this.rules.set(widgetClass,ruleProperties)}get(widgetClass){return this.rules.get(widgetClass)??{}}remove(widgetClass){return this.rules.delete(widgetClass)}}class EventConnection{constructor(listener,event,callback){this.listener=listener,this.event=event,this.callback=callback}}class EventManager{constructor(){this.connections=new Map}listen(listener,emitterEvent,callback){const[first,second]=emitterEvent.split(".",2);emitterEvent=second??first;const emitterId=second===void 0?listener.id??listener:first;let conn=new EventConnection(listener,emitterEvent,callback),conns=this.connections.get(emitterId);conns?conns.add(conn):this.connections.set(emitterId,new Set([conn]))}emit(emitter,event,data){const conns=this.connections.get(emitter.id??emitter);if(!conns)return!1;for(let conn of conns)if(conn.event===event&&conn.callback(event,emitter,data,conn.listener))return!0;return!1}disconnect(widget){this.connections.delete(widget.id??widget);for(let emitter of this.connections.keys()){const deleteList=[],conns=this.connections.get(emitter);if(conns){for(let conn of conns)conn.listener===widget&&deleteList.push(conn);deleteList.forEach(conn=>conns.delete(conn))}}}}class WidgetAnimation{constructor(){__publicField(this,"stack",[]);__publicField(this,"widget",null);__publicField(this,"props",{});__publicField(this,"elapsed",0)}add(props,duration=1e3){this.stack.push([props,duration])}update(app,millis){if(this.widget===null)return;let targetProps=this.stack[0][0],duration=this.stack[0][1];if(this.elapsed==0){this.initProps={};for(let p in targetProps)this.initProps[p]=this.widget[p]}let skip=this.elapsed+millis-duration;this.elapsed=skip<0?this.elapsed+millis:duration;let wgt=duration==0?1:this.elapsed/duration;if(skip<0)for(let p in this.initProps){let x=targetProps[p];typeof x=="number"&&(this.widget[p]=(1-wgt)*this.initProps[p]+wgt*x)}else{for(let p in this.initProps){let x=targetProps[p];typeof x=="number"&&(this.widget[p]=x)}if(this.stack=this.stack.slice(1),this.elapsed=skip,this.stack.length==0)this.cancel();else{this.initProps={};for(let p in this.stack[0][0])this.initProps[p]=this.widget[p]}}}start(widget){this.widget=widget,widget._animation=this}cancel(){this.widget!==null&&(this.widget._animation=null,this.widget.emit("animationComplete",this))}}function a(klass,arg1,arg2){var _a;Widget._ALLOW_CONSTRUCT=!0;const obj=new klass;Widget._ALLOW_CONSTRUCT=!1;let id=null,props={};return typeof arg1=="string"?(id=arg1,props=arg2??{}):props=arg1??{},id&&(obj.id=id),obj instanceof Widget&&instanceClassData(obj,{},obj),(_a=obj.updateProperties)==null||_a.call(obj,props),obj}const _Widget=class _Widget extends Rect{constructor(){super();__publicField(this,"bgColor",null);__publicField(this,"outlineColor",null);__publicField(this,"_animation",null);__publicField(this,"_layoutNotify",!1);__publicField(this,"hints",{});if(!_Widget._ALLOW_CONSTRUCT)throw new Error(`[ESKV] Do not use 'new ${typeof this}()'. Use '${typeof this}.a(...)' instead.`);return _Widget._ALLOW_CONSTRUCT=!1,this.parent=null,this._processTouches=!1,this._deferredProps=null,this._children=[],this._needsLayout=!0,new Proxy(this,{set(target,name,value,receiver){return typeof name=="string"&&(["x","y","w","h","children","rect"].includes(name)||name[0]=="_")?Reflect.set(target,name,value,receiver):(Reflect.set(target,name,value,receiver),typeof name=="string"&&Reflect.apply(target.emit,receiver,[name,value]),!0)}})}static a(arg1,arg2=void 0){var _a;_Widget._ALLOW_CONSTRUCT=!0;const obj=new this;_Widget._ALLOW_CONSTRUCT=!1;let id=null,props={};return typeof arg1=="string"?(id=arg1,props=arg2??{}):props=arg1??{},id&&(obj.id=id),obj instanceof _Widget&&instanceClassData(obj,{},obj),(_a=obj.updateProperties)==null||_a.call(obj,props),obj}i(id){return this.id=id,this}p(props){return this.updateProperties(props),this}sh(hints,mode="replace"){return mode==="merge"?this.hints=Object.assign({},this.hints??{},hints):this.hints=hints,this}b(property,callback){return this._deferredProps||(this._deferredProps={}),this._deferredProps[property]=callback,this}c(child){if(Array.isArray(child))for(const ch of child)this.addChild(ch);else this.addChild(child);return this}d(property,computeFn){return this._deferredProps||(this._deferredProps={}),this._deferredProps[property]=computeFn,this}set rect(rect){this[0]=rect[0],this[1]=rect[1],this[2]=rect[2],this[3]=rect[3],this._needsLayout=!0}get rect(){return new Rect([this[0],this[1],this[2],this[3]])}deferredProperties(app){let properties=this._deferredProps;this._deferredProps=null;for(let p in properties)if(!p.startsWith("on_")&&!p.startsWith("_")&&typeof properties[p]=="function"){let func=properties[p],args,rval;[args,rval]=(func.text??func.toString()).split("=>"),args=args.replace("(","").replace(")","").split(",").map(a2=>a2.trim());let objs=args.map(a2=>app.findById(a2)),obmap={};for(let a2 of args)obmap[a2]=app.findById(a2);const re=/(\w+)\.(\w+)|(\w+)\[['"](\w+)['"]\]/g;for(let pat of rval.matchAll(re)){let pr,ob;if([ob,pr]=pat.slice(1),ob==="this")this.listen(pr,(evt,obj,data)=>{try{this[p]=func(...objs)}catch(error){}});else if(ob in obmap)try{this.listen(`${ob}.${pr}`,(evt,obj,data)=>{try{this[p]=func(...objs)}catch(error){}})}catch(error){`${ob}`}}try{this[p]=func(...objs)}catch(error){}}}updateProperties(properties){for(let p in properties)!p.startsWith("on_")&&!p.startsWith("_")&&typeof properties[p]=="function"&&!("markupMethod"in properties[p])?this._deferredProps=properties:this[p]=properties[p]}listen(emitterEvent,func){return App.get()._eventManager.listen(this,emitterEvent,func),this}emit(event,data){return"on_"+event in this&&this["on_"+event](event,this,data)?!0:App.get()._eventManager.emit(this,event,data)}*iter(recursive=!0,inView=!0){if(yield this,!!recursive)for(let c of this._children)yield*c.iter(...arguments)}*iterParents(){this.parent!==null&&(yield this.parent,this.parent!=App.get()&&(yield*this.parent.iterParents()))}findById(id){for(let w of this.iter(!0,!1))if("id"in w&&w.id==id)return w;return null}*iterByPropertyValue(property,value){for(let w of this.iter(!0,!1))property in w&&w[property]==value&&(yield w)}getTransformRecurse(includeSelf=!1,widget=null){let transform=this!==widget&&this.parent!==null?this.parent.getTransformRecurse(!0,widget):new DOMMatrix;if(!includeSelf)return transform;let newT=this.getTransform();return newT?transform.multiply(newT):transform}getTransform(){return null}applyTransform(pt,invert=!1,recurse=!1,includeSelf=!1,firstWidget=null){let tx=recurse?this.getTransformRecurse(includeSelf,firstWidget):this.getTransform();if(!tx)return pt;invert&&(tx=tx.inverse());let dp=tx.transformPoint(new DOMPoint(pt.x,pt.y));return new Vec22([dp.x,dp.y])}appToWidget(pos,recurse=!0){if(this.parent){let pt=this.parent.getTransformRecurse().inverse().transformPoint(new DOMPoint(pos[0],pos[1]));return new Vec22([pt.x,pt.y])}return pos}appToChild(pos,recurse=!0){let pt=this.getTransformRecurse().inverse().transformPoint(new DOMPoint(pos[0],pos[1]));return new Vec22([pt.x,pt.y])}toChild(pos){let tx=this.getTransform();if(!tx)return pos;let pt=tx.inverse().transformPoint(new DOMPoint(pos[0],pos[1]));return new Vec22([pt.x,pt.y])}addChild(child,pos=-1){return pos==-1?this._children.push(child):this._children=[...this._children.slice(0,pos),child,...this._children.slice(pos)],this.emit("child_added",child),child.parent=this,this._needsLayout=!0,this}addNew(klass,props_or_id,props){return this.addChild(a(klass,props_or_id,props)),this}removeChild(child,disconnect=!0){this._children=this.children.filter(c=>c!=child),disconnect&&App.get()._eventManager.disconnect(child),this.emit("child_removed",child),child.parent=null,this._needsLayout=!0}get children(){return this._children}set children(children){for(let c of this._children)this.emit("child_removed",c),c.parent=null,this._needsLayout=!0;this._children=[];for(let c of children)this.addChild(c)}set x(val){this._needsLayout=!0,this[0]=val}set center_x(val){this._needsLayout=!0,this[0]=val-this[2]/2}set right(val){this._needsLayout=!0,this[0]=val-this[2]}set y(val){this._needsLayout=!0,this[1]=val}set center_y(val){this._needsLayout=!0,this[1]=val-this[3]/2}set bottom(val){this._needsLayout=!0,this[1]=val-this[3]}set w(val){this._needsLayout=!0,this[2]=val}set h(val){this._needsLayout=!0,this[3]=val}get x(){return this[0]}get center_x(){return this[0]+this[2]/2}get right(){return this[0]+this[2]}get y(){return this[1]}get center_y(){return this[1]+this[3]/2}get bottom(){return this[1]+this[3]}get w(){return this[2]}get h(){return this[3]}on_wheel(event,object,wheel){for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,wheel))return!0;return!1}on_touch_down(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,t))return!0}else for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,touch))return!0;return!1}on_touch_up(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,t))return!0}else for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,touch))return!0;return!1}on_touch_move(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,t))return!0}else for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,touch))return!0;return!1}on_touch_cancel(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,t))return!0}else for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,touch))return!0;return!1}on_back_button(event,object,history2){return!1}getMetric(widget,target,rule,parentWidth=null,parentHeight=null){let app=App.get();if(rule===null)return widget[target];let value=0,base="relative";for(parentWidth=parentWidth??this.w,parentHeight=parentHeight??this.h;;){if(rule.constructor==String){let r2=rule.slice(-2);if(r2=="ww"){value=+rule.slice(0,-2)*widget.w;break}if(r2=="wh"){value=+rule.slice(0,-2)*widget.h;break}if(r2=="aw"){value=+rule.slice(0,-2)*app.dimW,base="absolute";break}if(r2=="ah"){value=+rule.slice(0,-2)*app.dimH,base="absolute";break}let r1=rule.slice(-1);if(r1=="w"){value=+rule.slice(0,-1)*parentWidth;break}if(r1=="h"){value=+rule.slice(0,-1)*parentHeight;break}value=+rule;break}if(target=="w"||target=="x"||target=="center_x"||target=="right"){value=+rule;break}value=+rule;break}return base=="relative"&&(["x","center_x","right"].includes(target)&&(value+=this.x),["y","center_y","bottom"].includes(target)&&(value+=this.y)),value}applyHintMetric(widget,target,rule,parentWidth=null,parentHeight=null){let app=App.get();if(rule===null)return;let value=0,base="relative";for(parentWidth=parentWidth??this.w,parentHeight=parentHeight??this.h;;){if(rule.constructor==String){let r2=rule.slice(-2);if(r2=="ww"){value=+rule.slice(0,-2)*widget.w;break}if(r2=="wh"){value=+rule.slice(0,-2)*widget.h;break}if(r2=="aw"){value=+rule.slice(0,-2)*app.dimW,base="absolute";break}if(r2=="ah"){value=+rule.slice(0,-2)*app.dimH,base="absolute";break}let r1=rule.slice(-1);if(r1=="w"){value=+rule.slice(0,-1)*parentWidth;break}if(r1=="h"){value=+rule.slice(0,-1)*parentHeight;break}value=+rule;break}if(target=="w"||target=="x"||target=="center_x"||target=="right"){value=+rule*parentWidth;break}value=+rule*parentHeight;break}base=="relative"&&(["x","center_x","right"].includes(target)&&(value+=this.x),["y","center_y","bottom"].includes(target)&&(value+=this.y)),widget[target]=value}applyHints(c,w=null,h=null){let hints=c.hints;w=w??this.w,h=h??this.h,"w"in hints&&hints.w!=null&&hints.w.constructor==String&&hints.w.slice(-2)=="wh"?(hints.h!==void 0&&this.applyHintMetric(c,"h",hints.h,w,h),hints.w!==void 0&&this.applyHintMetric(c,"w",hints.w,w,h)):(hints.w!==void 0&&this.applyHintMetric(c,"w",hints.w,w,h),hints.h!==void 0&&this.applyHintMetric(c,"h",hints.h,w,h));for(let ht in hints)ht!="w"&&ht!="h"&&this.applyHintMetric(c,ht,hints[ht],w,h)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;for(let c of this.children)this.applyHints(c),c.layoutChildren()}_draw(app,ctx,millis){this.draw(app,ctx);let transform=this.getTransform();if(transform){ctx.save(),ctx.transform(transform.a,transform.b,transform.c,transform.d,transform.e,transform.f);for(let c of this._children)c._draw(app,ctx,millis);ctx.restore();return}for(let c of this._children)c._draw(app,ctx,millis)}draw(app,ctx){let r=this.rect;if(ctx.beginPath(),ctx.rect(r[0],r[1],r[2],r[3]),this.bgColor!=null){const origFill=ctx.fillStyle;ctx.fillStyle=this.bgColor,ctx.fill(),ctx.fillStyle=origFill}if(this.outlineColor!=null){let lw=ctx.lineWidth;ctx.lineWidth=this.getMetric(this,"lineWidth",this.hints.lineWidth??`${1/app.tileSize}`);const origStroke=ctx.strokeStyle;ctx.strokeStyle=this.outlineColor,ctx.stroke(),ctx.lineWidth=lw,ctx.strokeStyle=origStroke}}update(app,millis){this._deferredProps!=null&&this.deferredProperties(app),this._animation!=null&&(this._animation.update(app,millis),app.requestFrameUpdate()),this._needsLayout&&(this.layoutChildren(),app.requestFrameUpdate());for(let c of this._children)c.update(app,millis)}};__publicField(_Widget,"_ALLOW_CONSTRUCT",!1);let Widget=_Widget;const _App=class _App extends Widget{static registerClass(name,cls,baseClsName){_App.classes[name]=[cls,baseClsName]}constructor(){if(_App.appInstance!=null)return _App.appInstance;Widget._ALLOW_CONSTRUCT=!0,super(),Widget._ALLOW_CONSTRUCT=!1,_App.appInstance=this,window.app=this,this._eventManager=new EventManager,this.id="app",this.canvas=null,this.canvasName="canvas",this.w=-1,this.h=-1,this._baseWidget=a(Widget,{hints:{x:0,y:0,w:1,h:1}}),this._baseWidget.parent=this,this._modalWidgets=[],this._udpateActive=!0,this.pixelSize=1,this.integerTileSize=!1,this.exactDimensions=!1,this.prefDimW=32,this.prefDimH=16,this.dimW=this.prefDimW,this.dimH=this.prefDimH,this.tileSize=this.getTileScale()*this.pixelSize,this.offsetX=0,this.offsetY=0,this.shakeX=0,this.shakeY=0,this.shakeAmount=0,this.timer_tick=null,this.timers=[],this.continuousFrameUpdates=!1,this._requestedFrameUpdate=!1}get baseWidget(){return this._baseWidget}addTimer(duration,callback){let t=new Timer(duration,0,callback);return this.timers.push(t),t}removeTimer(timer){this.timers=this.timers.filter(t=>t!=timer)}addModal(modal){this._modalWidgets.push(modal),this._needsLayout=!0}removeModal(modal){this._modalWidgets=this._modalWidgets.filter(m=>m!=modal)}static get(){return _App.appInstance||(_App.appInstance=new _App),_App.appInstance}start(){let that=this;this.setupCanvas(),this.inputHandler=new InputHandler(this),window.onresize=()=>that.updateWindowSize(),this.updateWindowSize(),setTimeout(()=>this._start(),1)}_start(){this.update()}childEmit(event,data,topModalOnly=!1){if(topModalOnly&&this._modalWidgets.length>0)return this._modalWidgets[this._modalWidgets.length-1].emit(event,data);if(this._baseWidget.emit(event,data))return!0;for(let mw of this._modalWidgets)if(mw.emit(event,data))return!0;return!1}*iter(recursive=!0,inView=!0){yield this,yield*this._baseWidget.iter(...arguments);for(let mw of this._modalWidgets)yield*mw.iter(...arguments)}findById(id){for(let w of this.iter(!0,!1))if("id"in w&&w.id==id)return w;return null}*iterByPropertyValue(property,value){for(let w of this.iter(!0,!1))property in w&&w[property]===value&&(yield w)}update(){this._requestedFrameUpdate=!1,this._udpateActive=!0;let millis=15,n_timer_tick=Date.now();this.timer_tick!=null&&(millis=Math.min(n_timer_tick-this.timer_tick,30)),(this.timers.length>0||this._needsLayout)&&this.requestFrameUpdate();for(let t of this.timers)t.tick(millis);this._needsLayout&&this.layoutChildren();for(let res of _App.resources.values())res.update(this,millis);this._baseWidget.update(this,millis);for(let mw of this._modalWidgets)mw.update(this,millis);this.ctx&&this._draw(this,this.ctx,millis),this.continuousFrameUpdates&&this.requestFrameUpdate(),this.timer_tick=n_timer_tick,this._udpateActive=!1,this._requestedFrameUpdate&&(this._requestedFrameUpdate=!1,this.requestFrameUpdate())}requestFrameUpdate(){this._requestedFrameUpdate||(this._udpateActive?this._requestedFrameUpdate=!0:(this._udpateActive=!0,window.requestAnimationFrame(()=>this.update())))}_draw(app,ctx,millis){if(!this.canvas)return;ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.shakeX=0,this.shakeY=0,this.screenShake(),ctx.save();let tx=this.getTransform();tx&&ctx.transform(tx.a,tx.b,tx.c,tx.d,tx.e,tx.f),this._baseWidget._draw(app,ctx,millis);for(let mw of this._modalWidgets)mw._draw(app,ctx,millis);ctx.restore()}getTransform(recurse=!0){return new DOMMatrix().translate(this.offsetX+this.shakeX,this.offsetY+this.shakeY).scale(this.tileSize,this.tileSize)}on_prefDimW(e,o,v){this.updateWindowSize()}on_prefDimH(e,o,v){this.updateWindowSize()}on_tileSize(e,o,v){this.prefDimH<0&&this.prefDimW<0&&this.updateWindowSize()}computeDeviceScale(){const dpr=window.devicePixelRatio||1,scale2=1080/(Math.min(window.innerWidth,window.innerHeight)*dpr);return Math.max(1,Math.min(scale2,3))}updateWindowSize(){this.x=0,this.y=0,this.w=window.innerWidth,this.h=window.innerHeight,this.pixelSize=this.computeDeviceScale(),(this.prefDimH>=0||this.prefDimW>=0)&&(this.tileSize=this.getTileScale()),this.fitDimensionsToTileSize(this.tileSize),this.canvas!==null&&this.setupCanvas();try{screen.orientation.unlock()}catch{}this._needsLayout=!0,this.requestFrameUpdate()}getTileScale(){let sh=this.h,sw=this.w,scale2=1/this.pixelSize;return this.prefDimW<0&&this.prefDimH<0?this.tileSize>0&&(scale2=this.tileSize/this.pixelSize):this.prefDimW<0?scale2=sh/this.prefDimH/this.pixelSize:this.prefDimH<0?scale2=sw/this.prefDimW/this.pixelSize:scale2=Math.min(sh/this.prefDimH/this.pixelSize,sw/this.prefDimW/this.pixelSize),this.integerTileSize&&scale2>1&&(scale2=Math.floor(scale2)),scale2*this.pixelSize}fitDimensionsToTileSize(scale2){let sh=this.h,sw=this.w;if(this.exactDimensions){this.prefDimW<0&&this.prefDimH<0?(this.dimW=sw/this.tileSize,this.dimH=sh/this.tileSize):this.prefDimH<0?(this.dimW=this.prefDimW,this.dimH=sh/this.tileSize):this.prefDimW<0?(this.dimW=sw/this.tileSize,this.dimH=this.prefDimH):(this.dimH=this.prefDimH,this.dimW=this.prefDimW);return}this.dimH=Math.floor(sh/scale2),this.dimW=Math.floor(sw/scale2)}setupCanvas(){const canvas=document.getElementById(this.canvasName);if(!(canvas instanceof HTMLCanvasElement))throw"No canvas element named "+this.canvasName;this.canvas=canvas,this.canvas.width=this.w,this.canvas.height=this.h,this.ctx=this.canvas.getContext("2d"),this.ctx&&(this.ctx.imageSmoothingEnabled=!1,this.offsetX=Math.floor((this.w-this.tileSize*this.dimW)/2),this.offsetY=Math.floor((this.h-this.tileSize*this.dimH)/2))}applyHints(c){super.applyHints(c,this.dimW,this.dimH)}screenShake(){this.shakeAmount&&this.shakeAmount--;let shakeAngle=Math.random()*Math.PI*2;this.shakeX=Math.round(Math.cos(shakeAngle)*this.shakeAmount),this.shakeY=Math.round(Math.sin(shakeAngle)*this.shakeAmount)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.applyHints(this._baseWidget),this._baseWidget.layoutChildren();for(let mw of this._modalWidgets)this.applyHints(mw),mw.layoutChildren()}};__publicField(_App,"appInstance",null),__publicField(_App,"rules",new Rules),__publicField(_App,"resources",new Map),__publicField(_App,"classes",{});let App=_App;class Label extends Widget{constructor(){super();__publicField(this,"fontSize",null);__publicField(this,"sizeGroup","");__publicField(this,"clip",!1);__publicField(this,"ignoreSizeForGroup",!1);__publicField(this,"fontName",'"Nimbus Mono PS", "Courier New", monospace');__publicField(this,"text","");__publicField(this,"wrap",!1);__publicField(this,"wrapAtWord",!0);__publicField(this,"align","center");__publicField(this,"valign","middle");__publicField(this,"color","white");this._textData=null}on_align(e,object,v){this._needsLayout=!0}on_valign(e,object,v){this._needsLayout=!0}on_wrap(e,object,v){this._needsLayout=!0}on_wrapAtWord(e,object,v){this._needsLayout=!0}on_text(e,object,v){this._needsLayout=!0}on_fontSize(e,object,v){this._needsLayout=!0}on_fontName(e,object,v){this._needsLayout=!0}layoutChildren(){let ctx=App.get().ctx;if(!ctx)return;let fontSize=this.fontSize===null?null:this.getMetric(this,"fontSize",this.fontSize);if("h"in this.hints&&this.hints.h==null&&fontSize!==null&&(this[3]=this.wrap?sizeWrappedText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[1]:sizeText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color)[1]),"w"in this.hints&&this.hints.w==null&&fontSize!==null&&(this[2]=this.wrap?sizeWrappedText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[0]:sizeText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color)[0]),fontSize=fontSize===null?this.h/2:fontSize,this.fontSize===null&&this.rect.w!==void 0){let i=0,w,h;for(;i<50;){if(this.wrap?[w,h]=sizeWrappedText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord):[w,h]=sizeText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color),(this.h>=h||"h"in this.hints&&this.hints.h==null||fontSize<.01)&&(this.w>=w||"w"in this.hints&&this.hints.w==null)){"h"in this.hints&&this.hints.h==null&&(this.h=h),"w"in this.hints&&this.hints.w==null&&(this.w=w);break}const err=Math.min(1.1,this.w/w,this.h/h);this.wrap?fontSize*=err**.5:fontSize*=err**1.1,i++}fontSize===void 0&&(fontSize=.001*App.get().h)}this.sizeGroup!==""?(this._bestFontSize=fontSize,this._textData=null):this.wrap?this._textData=getWrappedTextData(ctx,this.text,fontSize,this.fontName,this.align,this.valign,this.rect,this.color,this.wrapAtWord):this._textData=getTextData(ctx,this.text,fontSize,this.fontName,this.align,this.valign,this.rect,this.color),super.layoutChildren()}sizeToGroup(ctx){if(this._bestFontSize===void 0)return;let fontSize=1/0;for(let lbl of App.get().iterByPropertyValue("sizeGroup",this.sizeGroup))fontSize>lbl._bestFontSize&&!lbl.ignoreSizeForGroup&&(fontSize=lbl._bestFontSize);if(fontSize>0)for(let lbl of App.get().iterByPropertyValue("sizeGroup",this.sizeGroup)){const fs=lbl.clip||!lbl.ignoreSizeForGroup?fontSize:lbl._bestFontSize;lbl.wrap?lbl._textData=getWrappedTextData(ctx,lbl.text,fs,lbl.fontName,lbl.align,lbl.valign,lbl.rect,lbl.color,lbl.wrapAtWord):lbl._textData=getTextData(ctx,lbl.text,fs,lbl.fontName,lbl.align,lbl.valign,lbl.rect,lbl.color)}}draw(app,ctx){if(super.draw(app,ctx),this.clip){ctx.save();const r=this.rect;ctx.rect(r.x,r.y,r.w,r.h),ctx.clip()}!this._textData&&this.sizeGroup!==""&&this.sizeToGroup(ctx),this._textData&&(this.wrap?drawWrappedText(ctx,this._textData,this.color):drawText(ctx,this._textData,this.color)),this.clip&&ctx.restore()}}class Button extends Label{constructor(){super();__publicField(this,"bgColor",colorString([.5,.5,.5]));__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.4,.4,.4]));__publicField(this,"disable",!1)}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,!0):!1}on_touch_up(event,object,touch){return super.on_touch_up(event,object,touch)?!0:touch.grabbed!=this?!1:(touch.ungrab(),!this.disable&&this.collide(touch.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(event,object,touch){return super.on_touch_move(event,object,touch)?!0:(touch.grabbed==this&&!this.disable&&(this._touching=this.collide(touch.rect)),!1)}draw(app,ctx){let saved=this.bgColor,saved2=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(app,ctx),this.bgColor=saved,this.color=saved2}}class BasicButton extends Widget{constructor(){super();__publicField(this,"color",colorString([.8,.8,.8]));__publicField(this,"bgColor",colorString([.5,.5,.5]));__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.4,.4,.4]));__publicField(this,"disable",!1)}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,!0):!1}on_touch_up(event,object,touch){return super.on_touch_up(event,object,touch)?!0:touch.grabbed!=this?!1:(touch.ungrab(),!this.disable&&this.collide(touch.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(event,object,touch){return super.on_touch_move(event,object,touch)?!0:(touch.grabbed==this&&!this.disable&&(this._touching=this.collide(touch.rect)),!1)}draw(app,ctx){let saved=this.bgColor,saved2=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(app,ctx),this.bgColor=saved,this.color=saved2}}class ToggleButton extends Label{constructor(){super();__publicField(this,"bgColor",colorString([.5,.5,.5]));__publicField(this,"pressColor",colorString([.7,.7,.7]));__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.4,.4,.4]));__publicField(this,"disable",!1);__publicField(this,"_press",!1);__publicField(this,"group",null);__publicField(this,"singleSelect",!0)}get press(){return this._press}set press(value){this._press=value}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,!0):!1}on_touch_up(event,object,touch){if(touch.grabbed!==this)return!1;if(touch.ungrab(),this._touching=!1,this.collide(touch.rect)){if(this.group===null||!this.singleSelect)this.press=!this.press;else{if(this.parent!==null)for(let w of this.parent.iterByPropertyValue("group",this.group))w!==this&&(w._press=!1);this.press=!0}return!0}return!1}on_touch_move(event,object,touch){return touch.grabbed===this?(this._touching=this.collide(touch.rect),!0):!1}draw(app,ctx){let saved=this.bgColor,saved2=this.color;this.press&&(this.bgColor=this.pressColor),this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(app,ctx),this.bgColor=saved,this.color=saved2}}class CheckBox extends Widget{constructor(){super();__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"color",colorString([.6,.6,.6]));__publicField(this,"bgColor",colorString([.5,.5,.5]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.3,.3,.3]));__publicField(this,"disable",!1);__publicField(this,"check",!1);__publicField(this,"group",null)}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,!0):!1}on_touch_up(event,object,touch){if(super.on_touch_up(event,object,touch))return!0;if(this.parent===null||touch.grabbed!=this)return!1;if(touch.ungrab(),!this.disable&&this.collide(touch.rect)){if(this._touching=!1,this.group==null)this.check=!this.check;else{for(let w of this.parent.iterByPropertyValue("group",this.group))w!=this&&(w.check=!1);this.check=!0}return!0}return!1}on_touch_move(event,object,touch){return super.on_touch_move(event,object,touch)?!0:touch.grabbed==this&&!this.disable?(this._touching=this.collide(touch.rect),!0):!1}draw(app,ctx){if(this.group!=null){let r2=this.rect;r2.w=r2.h=.5*Math.min(r2.w,r2.h),r2.x=this.x+(this.w-r2.w)/2,r2.y=this.y+(this.h-r2.h)/2;let ts2=App.get().tileSize,ctx2=App.get().ctx;if(!ctx2)return;ctx2.strokeStyle=this.disable?this.disableColor1:this.bgColor,ctx2.lineWidth=1/ts2,ctx2.beginPath(),ctx2.arc(r2.center_x,r2.center_y,r2.w/2,0,2*Math.PI),ctx2.stroke(),(this._touching||this.disable)&&(ctx2.fillStyle=this.disable?this.disableColor1:this.selectColor,ctx2.fill()),this.check&&(ctx2.fillStyle=this.disable?this.disableColor2:this.color,ctx2.beginPath(),ctx2.arc(r2.center_x,r2.center_y,r2.w/3,0,2*Math.PI),ctx2.fill());return}let r=this.rect;r.w=r.h=.5*Math.min(r.w,r.h),r.x=this.x+(this.w-r.w)/2,r.y=this.y+(this.h-r.h)/2;let ts=app.tileSize;ctx.beginPath(),ctx.strokeStyle=this.bgColor,this.disable&&(ctx.strokeStyle=this.disableColor1),ctx.lineWidth=1/ts,ctx.rect(r[0],r[1],r[2],r[3]),ctx.stroke(),this._touching&&(ctx.fillStyle=this.selectColor,ctx.fill()),this.check&&(ctx.strokeStyle=this.color,this.disable&&(ctx.strokeStyle=this.disableColor2),ctx.beginPath(),ctx.lineWidth=r.w/5,ctx.moveTo(r.x,r.y),ctx.lineTo(r.right,r.bottom),ctx.moveTo(r.right,r.y),ctx.lineTo(r.x,r.bottom),ctx.stroke())}}class Slider extends Widget{constructor(){super();__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"color",colorString([.6,.6,.6]));__publicField(this,"bgColor",colorString([.4,.4,.4]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.3,.3,.3]));__publicField(this,"disable",!1);__publicField(this,"min",0);__publicField(this,"max",1);__publicField(this,"curMax",1);__publicField(this,"unboundedStopMultiple",10);__publicField(this,"exponentialSlider",!1);__publicField(this,"step",null);__publicField(this,"orientation","horizontal");__publicField(this,"value",0);__publicField(this,"sliderSize",.2)}setValue(touch){let max=this.max??this.curMax,value=0;this.orientation=="horizontal"&&(value=clamp((touch.rect.x-this.x-this.w*this.sliderSize/2)/(this.w*(1-this.sliderSize)),0,1)),this.orientation=="vertical"&&(value=clamp((touch.rect.y-this.y-this.h*this.sliderSize/2)/(this.h*(1-this.sliderSize)),0,1)),this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?value=value>.5?max/this.unboundedStopMultiple+(value-.5)/.5*(max-max/this.unboundedStopMultiple):this.min+value/.5*(max/this.unboundedStopMultiple-this.min):value=this.min+(max-this.min)*value,this.step!=null&&(value=Math.round(value/this.step)*this.step),this.value=value}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touch=!0,this.setValue(touch),!0):!1}updateMax(){this.max===null&&(this.curMax=this.unboundedStopMultiple*this.value)}on_touch_up(event,object,touch){return touch.grabbed!=this?super.on_touch_up(event,object,touch):(touch.ungrab(),!this.disable&&this.collide(touch.rect)&&(this._touching=!1,this.setValue(touch)),this.updateMax(),!0)}on_touch_move(event,object,touch){return touch.grabbed!==this?super.on_touch_move(event,object,touch):(this.disable||(this._touching=this.collide(touch.rect),this.setValue(touch)),!1)}draw(app,ctx){let ts=app.tileSize,r=this.rect;if(this.orientation=="horizontal"){r.w-=this.sliderSize*this.w,r.x+=this.sliderSize/2*this.w;let rad=Math.min(this.sliderSize/2*this.w,this.h/2)/2;ctx.strokeStyle=this.disable?this.disableColor1:this.bgColor,ctx.beginPath(),ctx.lineWidth=4/ts,ctx.moveTo(r.x,r.center_y),ctx.lineTo(r.right,r.center_y),ctx.stroke();let max=this.max??this.curMax,vPos;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?vPos=this.value>max/this.unboundedStopMultiple?(.5+.5*(this.value-max/this.unboundedStopMultiple)/(max-max/this.unboundedStopMultiple))*r.w:.5*(this.value-this.min)/(max/this.unboundedStopMultiple-this.min)*r.w:vPos=(this.value-this.min)/(max-this.min)*r.w,ctx.strokeStyle=this.disable?this.disableColor2:this.bgColor,ctx.beginPath(),ctx.arc(r.x+vPos,r.center_y,rad,0,2*Math.PI),ctx.stroke(),ctx.fillStyle=this.color,(this._touching||this.disable)&&(ctx.fillStyle=this.disable?this.disableColor1:this.selectColor),ctx.fill()}if(this.orientation=="vertical"){r.h-=this.sliderSize*this.h,r.y+=this.sliderSize/2*this.h;let rad=Math.min(this.sliderSize/2*this.h,this.w/2)/2;ctx.strokeStyle=this.disable?this.disableColor1:this.bgColor,ctx.beginPath(),ctx.lineWidth=4/ts,ctx.moveTo(r.center_x,r.y),ctx.lineTo(r.center_x,r.bottom),ctx.stroke();let max=this.max??this.curMax,vPos;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?vPos=this.value>max/this.unboundedStopMultiple?(.5+.5*(this.value-max/this.unboundedStopMultiple)/(max-max/this.unboundedStopMultiple))*r.h:.5*(this.value-this.min)/(max/this.unboundedStopMultiple-this.min)*r.h:vPos=(this.value-this.min)/(max-this.min)*r.h,ctx.strokeStyle=this.disable?this.disableColor2:this.bgColor,ctx.beginPath(),ctx.arc(r.center_x,r.y+vPos,rad,0,2*Math.PI),ctx.stroke(),ctx.fillStyle=this.color,(this._touching||this.disable)&&(ctx.fillStyle=this.disable?this.disableColor1:this.selectColor),ctx.fill()}}}class TextInput extends Label{constructor(){super();__publicField(this,"_activeDOMInput",null);__publicField(this,"focus",!0);__publicField(this,"disable",!1);__publicField(this,"_inputSanitizer");this._textData=null}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,!0):(this.clearDOM(),!1)}on_touch_up(event,object,touch){return super.on_touch_up(event,object,touch)?!0:touch.grabbed!=this?!1:!this.disable&&this.collide(touch.rect)?(this._touching=!1,this.addDOMInput(),!0):(this.clearDOM(),!1)}on_layout(event,object,value){this.clearDOM()}DOMInputRect(){let r=this.rect,t=this.getTransformRecurse(),rt=new Rect,dp1=t.transformPoint(new DOMPoint(r.x,r.y)),dp2=t.transformPoint(new DOMPoint(r.right,r.bottom));return[rt.x,rt.y]=[dp1.x,dp1.y],[rt.w,rt.h]=[dp2.x,dp2.y],rt.w-=rt.x,rt.h-=rt.y,rt}addDOMInput(){if(!this._textData)return;App.get();let canvasdiv=document.getElementById("eskvapp");if(!canvasdiv)return;let type=this.wrap?"textarea":"input",inp=document.createElement(type);if(!(inp instanceof HTMLInputElement)&&!(inp instanceof HTMLTextAreaElement))return;let fs,rt=this.DOMInputRect(),color=this.color!=null?this.color:"white",bgColor=this.bgColor!=null?this.bgColor:"black";inp.style.color=color,fs=this._textData.size/this.h*rt.h/this._textData.outText.length,type=="textarea"&&this._textData.outText.length,inp.value=this.text,fs=(Math.floor(fs*100)/100).toString()+"px",inp.style.fontSize=fs,inp.style.backgroundColor=bgColor,inp.style.top=(Math.floor(rt.y*100)/100).toString()+"px",inp.style.left=(Math.floor(rt.x*100)/100).toString()+"px",inp.style.width=(Math.floor(rt.w*100)/100).toString()+"px",inp.style.height=(Math.floor(rt.h*100)/100).toString()+"px",inp.style.fontFamily=this.fontName,this._activeDOMInput=inp,canvasdiv.appendChild(inp),inp.addEventListener("focusout",event=>this.clearDOM()),inp.focus(),inp.select(),this.focus=!0}clearDOM(){if(this._activeDOMInput!=null){this.text=this._inputSanitizer?this._inputSanitizer(this._activeDOMInput.value,this):this._activeDOMInput.value;let inp=this._activeDOMInput;this._activeDOMInput=null,inp.remove(),this.focus=!1,this._needsLayout=!0;let iph=App.get().inputHandler;(iph==null?void 0:iph.grabbed)===this&&iph.ungrab()}}layoutChildren(){if(super.layoutChildren(),this._activeDOMInput!=null){let rt=this.DOMInputRect(),inp=this._activeDOMInput;inp.style.top=(Math.floor(rt.y*100)/100).toString()+"px",inp.style.left=(Math.floor(rt.x*100)/100).toString()+"px",inp.style.width=(Math.floor(rt.w*100)/100).toString()+"px",inp.style.height=(Math.floor(rt.h*100)/100).toString()+"px"}}}class ImageWidget extends Widget{constructor(){super();__publicField(this,"bgColor",null);__publicField(this,"outlineColor",null);__publicField(this,"src",null);__publicField(this,"lockAspect",!0);__publicField(this,"scaleToFit",!0);__publicField(this,"antiAlias",!0);__publicField(this,"angle",0);__publicField(this,"anchor","center");__publicField(this,"mirror",!1);this.image=new Image}on_src(event,object,data){this.src?this.image.src=this.src:this.image.src=""}layoutChildren(){this._layoutNotify&&this.emit("layout",null);let app=App.get();"w"in this.hints&&this.hints.w==null&&(this[2]=this.image.width/app.tileSize),"h"in this.hints&&this.hints.h==null&&(this[3]=this.image.height/app.tileSize),this._needsLayout=!1,super.layoutChildren()}draw(app,ctx){if(super.draw(app,ctx),!this.image.complete||this.image.naturalHeight==0)return;let r=this.rect;if(this.scaleToFit||(r.x+=r.w/2-this.image.width/2/app.tileSize,r.y+=r.h/2-this.image.height/2/app.tileSize,r.w=this.image.width/app.tileSize,r.h=this.image.height/app.tileSize),this.lockAspect){let srcAspect=this.image.height/this.image.width,dstAspect=r.h/r.w,rh=r.h,rw=r.w;srcAspect<dstAspect&&(rh=r.w*srcAspect),srcAspect>dstAspect&&(rw=r.h/srcAspect),r.x+=r.w/2-rw/2,r.y+=r.h/2-rh/2,r.w=rw,r.h=rh}ctx.save(),ctx.imageSmoothingEnabled=this.antiAlias;let anchor=this.anchor;anchor=="center"?anchor=[r.w/2,r.h/2]:anchor=[anchor[0]*r.w,anchor[1]*r.h],this.mirror&&ctx.scale(-1,1),ctx.translate(r.x+anchor[0],r.y+anchor[1]),this.angle!=0&&ctx.rotate(this.angle),ctx.translate(-anchor[0],-anchor[1]),ctx.drawImage(this.image,0,0,this.image.width,this.image.height,0,0,r.w,r.h),ctx.restore()}}class BoxLayout extends Widget{constructor(){super();__publicField(this,"spacingX",0);__publicField(this,"spacingY",0);__publicField(this,"paddingX",0);__publicField(this,"paddingY",0);__publicField(this,"orientation","vertical");__publicField(this,"order","forward")}*iterChildren(){if(this.order==="forward")for(let c of this._children)yield c;else for(let i=this._children.length-1;i>=0;i--)yield this._children[i]}on_numX(event,object,data){this._needsLayout=!0}on_numY(event,object,data){this._needsLayout=!0}on_spacingX(event,object,data){this._needsLayout=!0}on_spacingY(event,object,data){this._needsLayout=!0}on_paddingX(event,object,data){this._needsLayout=!0}on_paddingY(event,object,data){this._needsLayout=!0}on_orientation(event,object,data){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let spacingX=this.getMetric(this,"spacingX",this.spacingX),spacingY=this.getMetric(this,"spacingY",this.spacingY),paddingX=this.getMetric(this,"paddingX",this.paddingX),paddingY=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation==="vertical"){let num=this.children.length,h=this.h-spacingY*(num-1)-2*paddingY,w=this.w-2*paddingX,fixedh=0;for(let c of this.iterChildren())c.w=w,this.applyHints(c,w,h),"h"in c.hints&&(c.hints.h===null&&c.layoutChildren(),fixedh+=c.h,num--);let ch=(h-fixedh)/num,cw=w;(num===0&&h>0||ch<0)&&(paddingY=(h-fixedh)/2);let y=this.y+paddingY,x=this.x+paddingX;for(let c of this.iterChildren())c.y=y,"w"in c.hints||(c.w=cw),"h"in c.hints||(c.h=ch),!("x"in c.hints)&&!("center_x"in c.hints)&&!("right"in c.hints)&&(c.x=x,w!==c.w&&(c.x+=(w-c.w)/2)),c.layoutChildren(),y+=spacingY+c.h;if(num===0&&"h"in this.hints&&this.hints.h===null){const oldH=this[3];this[3]=y+2*paddingY-this.y,Math.abs(oldH-this[3])>1e-6&&(App.get()._needsLayout=!0)}return}if(this.orientation==="horizontal"){let num=this.children.length,h=this.h-2*paddingY,w=this.w-spacingX*(num-1)-2*paddingX,fixedw=0;for(let c of this.iterChildren())c.h=h,this.applyHints(c,w,h),"w"in c.hints&&(c.hints.w===null&&c.layoutChildren(),fixedw+=c.w,num--);let ch=h,cw=(w-fixedw)/num;(num===0&&w>0||cw<0)&&(paddingX=(w-fixedw)/2);let y=this.y+paddingY,x=this.x+paddingX;for(let c of this.iterChildren())c.x=x,"w"in c.hints||(c.w=cw),"h"in c.hints||(c.h=ch),!("y"in c.hints)&&!("center_y"in c.hints)&&!("bottom"in c.hints)&&(c.y=y,h!==c.h&&(c.y+=(h-c.h)/2)),c.layoutChildren(),x+=spacingX+c.w;if(num==0&&"w"in this.hints&&this.hints.w==null){const oldW=this[2];this[2]=x+2*paddingX-this.x,Math.abs(oldW-this[2])>1e-6&&(App.get()._needsLayout=!0)}}}}class Notebook extends Widget{constructor(){super();__publicField(this,"activePage",0)}on_wheel(event,object,wheel){const ch=this.children[this.activePage]??void 0;return!!(ch!==void 0&&ch.emit(event,wheel))}on_touch_down(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_up(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_move(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_cancel(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_activePage(e,o,v){this._needsLayout=!0}_draw(app,ctx,millis){this.draw(app,ctx);let transform=this.getTransform();if(transform){ctx.save(),ctx.transform(transform.a,transform.b,transform.c,transform.d,transform.e,transform.f);let w2=this.children[this.activePage]??void 0;w2!==void 0&&w2._draw(app,ctx,millis),ctx.restore();return}let w=this.children[this.activePage]??void 0;w!==void 0&&w._draw(app,ctx,millis)}}class TabbedNotebook extends Notebook{constructor(){super();__publicField(this,"tabHeightHint","1");__publicField(this,"tabGroupName","tabbedNotebookGroup");this.buttonBox=a(BoxLayout,{orientation:"horizontal",hints:{h:this.tabHeightHint,w:null}}),this.buttonScroller=a(ScrollView,{id:"_scrollview",hints:{h:this.tabHeightHint,w:1},children:[this.buttonBox]}),this._children=[this.buttonScroller],this.buttonScroller.parent=this,this.updateButtons()}on_tabHeightHint(e,o,v){this.buttonBox.hints.h=this.tabHeightHint}on_child_added(e,o,v){this.updateButtons()}on_child_removed(e,o,v){this.updateButtons()}on_wheel(event,object,wheel){const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,wheel))return!0;const ch=this.children[this.activePage]??void 0;return!!(ch!==void 0&&ch.emit(event,wheel))}on_touch_down(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,t))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,touch))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_up(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,t))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,touch))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_move(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,t))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,touch))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_cancel(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,t))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,touch))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}get children(){return this._children.slice(1)}set children(children){for(let c of this._children.slice(1))this.emit("child_removed",c),c.parent=null,this._needsLayout=!0,this.updateButtons();this._children=this._children.slice(0,1);for(let c of children)this.addChild(c)}updateButtons(){this.buttonBox.children=[];let i=0;for(let page of this.children){const tb=a(ToggleButton,{text:page.name??String(i+1),group:this.tabGroupName,singleSelect:!0,press:this.activePage===i,fontSize:"0.5",hints:{h:null,w:null}});tb.listen("press",(e,o,v)=>{this.activePage=this.buttonBox.children.findIndex(w=>w===o)}),this.buttonBox.addChild(tb),i++}}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;const bb=this._children[0];this.applyHints(bb),bb.x=this.x,bb.y=this.y,bb.layoutChildren();const h=this.h-bb.h,w=this.w;for(let c of this.children)c.y=this.y+bb.h,c.x=this.x,c.w=w,c.h=h,c.layoutChildren()}_draw(app,ctx,millis){this.draw(app,ctx);let transform=this.getTransform();if(transform){ctx.save(),ctx.transform(transform.a,transform.b,transform.c,transform.d,transform.e,transform.f);let bb2=this._children[0]??void 0;bb2!==void 0&&bb2._draw(app,ctx,millis);let w2=this.children[this.activePage]??void 0;w2!==void 0&&w2._draw(app,ctx,millis),ctx.restore();return}let bb=this._children[0]??void 0;bb!==void 0&&bb._draw(app,ctx,millis);let w=this.children[this.activePage]??void 0;w!==void 0&&w._draw(app,ctx,millis)}}class GridLayout extends Widget{constructor(){super();__publicField(this,"numX",1);__publicField(this,"numY",1);__publicField(this,"spacingX",0);__publicField(this,"spacingY",0);__publicField(this,"paddingX",0);__publicField(this,"paddingY",0);__publicField(this,"orientation","horizontal")}on_numX(event,object,string){this._needsLayout=!0}on_numY(event,object,string){this._needsLayout=!0}on_spacingX(event,object,string){this._needsLayout=!0}on_spacingY(event,object,string){this._needsLayout=!0}on_paddingX(event,object,string){this._needsLayout=!0}on_paddingY(event,object,string){this._needsLayout=!0}on_orientation(event,object,string){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let spacingX=this.getMetric(this,"spacingX",this.spacingX),spacingY=this.getMetric(this,"spacingY",this.spacingY),paddingX=this.getMetric(this,"paddingX",this.paddingX),paddingY=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation=="horizontal"){let numX=this.numX,numY=Math.ceil(this.children.length/this.numX),h=this.h-spacingY*(numY-1)-2*paddingY,w=this.w-spacingX*(numX-1)-2*paddingX,_colWidths=new Array(numX).fill(0),_rowHeights=new Array(numY).fill(0),r=0,c=0,i=0;for(let ch2 of this.children)this.applyHints(ch2,w,h),"w"in ch2.hints&&(_colWidths[c]=Math.max(ch2.w,_colWidths[c])),"h"in ch2.hints&&(_rowHeights[r]=Math.max(ch2.h,_rowHeights[r])),(i+1)%numX==0?(r++,c=0):c++,i++;let fixedW=0,fixedH=0,nfX=0,nfY=0;for(let cw2 of _colWidths)fixedW+=cw2,cw2>0&&nfX++;for(let rh of _rowHeights)fixedH+=rh,rh>0&&nfY++;let ch=numY>nfY?(h-fixedH)/(numY-nfY):0,cw=numX>nfX?(w-fixedW)/(numX-nfX):0,y=this.y+paddingY,x=this.x+paddingX;r=0,c=0;for(let i2=0;i2<this.children.length;i2++){let el=this.children[i2],cw0=_colWidths[c]==0?cw:_colWidths[c],ch0=_rowHeights[r]==0?ch:_rowHeights[r];"w"in el.hints||(el.w=cw0),"h"in el.hints||(el.h=ch0),el.x=x,el.y=y,el.layoutChildren(),(i2+1)%numX==0?(x=this.x+paddingX,y+=spacingY+ch0,c=0,r++):(x+=spacingX+cw0,c++)}return}else{let numX=Math.ceil(this.children.length/this.numY),numY=this.numY,h=this.h-spacingY*(numY-1)-2*paddingY,w=this.w-spacingX*(numX-1)-2*paddingX,_colWidths=new Array(numX).fill(0),_rowHeights=new Array(numY).fill(0),r=0,c=0,i=0;for(let ch2 of this.children)this.applyHints(ch2,w,h),"w"in ch2.hints&&(_colWidths[c]=Math.max(ch2.w,_colWidths[c])),"h"in ch2.hints&&(_rowHeights[r]=Math.max(ch2.h,_rowHeights[r])),(i+1)%numY==0?(c++,r=0):r++,i++;let fixedW=0,fixedH=0,nfX=0,nfY=0;for(let cw2 of _colWidths)fixedW+=cw2,cw2>0&&nfX++;for(let rh of _rowHeights)fixedH+=rh,rh>0&&nfY++;let ch=numY>nfY?(h-fixedH)/(numY-nfY):0,cw=numX>nfX?(w-fixedW)/(numX-nfX):0,y=this.y+paddingY,x=this.x+paddingX;r=0,c=0;for(let i2=0;i2<this.children.length;i2++){let el=this.children[i2],cw0=_colWidths[c]==0?cw:_colWidths[c],ch0=_rowHeights[r]==0?ch:_rowHeights[r];"w"in el.hints||(el.w=cw0),"h"in el.hints||(el.h=ch0),el.x=x,el.y=y,el.layoutChildren(),(i2+1)%numY==0?(y=this.y+paddingY,x+=spacingX+cw0,r=0,c++):(y+=spacingY+ch0,r++)}}}}class ScrollView extends Widget{constructor(){super();__publicField(this,"_scrollX",0);__publicField(this,"_scrollY",0);__publicField(this,"scrollX",0);__publicField(this,"scrollY",0);__publicField(this,"scrollW",!0);__publicField(this,"scrollH",!0);__publicField(this,"wAlign","center");__publicField(this,"hAlign","top");__publicField(this,"uiZoom",!0);__publicField(this,"uiMove",!0);__publicField(this,"zoom",1);__publicField(this,"vel",null);__publicField(this,"velCutoff",1e-5);__publicField(this,"velDecay",.95);__publicField(this,"unboundedH",!1);__publicField(this,"unboundedW",!1);__publicField(this,"_zoomCenter",null);this._processTouches=!0,this._oldTouch=null,this._lastDist=null}on_child_added(event,object,child){this.children.length==1&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0,child.listen("rect",(event2,obj,data)=>this._needsLayout=!0),child.listen("w",(event2,obj,data)=>this._needsLayout=!0),child.listen("h",(event2,obj,data)=>this._needsLayout=!0))}on_child_removed(event,object,child){this.children.length==0&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.children[0][0]=0,this.children[0][1]=0,this.scrollW||(this.children[0][2]=this.w),this.scrollH||(this.children[0][3]=this.h);for(let c of this.children)c.layoutChildren()}fitToClient(){this.zoom=Math.min(this.w/this.children[0].w,this.h/this.children[0].h),this.scrollX=.5*this.scrollableW,this.scrollY=.5*this.scrollableH}on_uiZoom(event,object,value){this._needsLayout=!0}on_hAlign(event,object,value){this._needsLayout=!0}on_vAlign(event,object,value){this._needsLayout=!0}*iter(recursive=!0,inView=!0){if(yield this,!!recursive)if(inView)for(let c of this._children)this.contains(c)&&(yield*c.iter(...arguments));else for(let c of this._children)yield*c.iter(...arguments)}on_scrollW(event,object,value){this._needsLayout=!0,this.scrollX=0}on_scrollH(event,object,value){this._needsLayout=!0,this.scrollY=0}on_scrollX(event,object,value){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedW){this._scrollX=this.scrollX;return}let align=0;switch(this.wAlign){case"center":align=.5*this.scrollableW;break;case"right":align=1*this.scrollableW}this._scrollX=this.scrollableW<=0||this.scrollableW>=this.children[0].w?align:value,this._scrollX=clamp(value,0,this.scrollableW)}on_scrollY(event,object,value){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedH){this._scrollY=this.scrollY;return}let align=0;switch(this.hAlign){case"middle":align=.5*this.scrollableH;break;case"bottom":align=1*this.scrollableH}this._scrollY=this.scrollableH<=0||this.scrollableH>=this.children[0].h?align:value,this._scrollY=clamp(value,0,this.scrollableH)}update(app,millis){if(super.update(app,millis),this.vel!==null){this.scrollX+=this.vel.x*millis,this.scrollY+=this.vel.y*millis,this.vel=this.vel.scale(this.velDecay**(millis/30));let a2=this.vel.abs();a2.x<=this.velCutoff/this.zoom&&a2.y<=this.velCutoff/this.zoom&&(this.vel=null)}}getTransform(){const ts=App.get().tileSize;return new DOMMatrix().translate(Math.floor((this.x-this._scrollX*this.zoom)*ts)/ts,Math.floor((this.y-this._scrollY*this.zoom)*ts)/ts).scale(this.zoom,this.zoom)}on_touch_down(event,object,touch){this.vel=null;let r=touch.rect;if(this._lastDist=null,this.collide(r)){let millis=Date.now(),tl=touch.asChildTouch(this);return this._oldTouch=[tl.x,tl.y,tl.identifier,millis,null],super.on_touch_down(event,object,touch)||touch.grab(this),!0}return!1}on_touch_up(event,object,touch){if(touch.grabbed!==this)return!1;if(this._oldTouch!=null){let ovel=this._oldTouch[4],tl=new Vec22([this._oldTouch[0],this._oldTouch[1]]),tln=touch.asChildTouch(this),millis=Math.max(Date.now()-this._oldTouch[3],1),vx=this.scrollableW>0||this.unboundedW?(tln.x-tl.x)/millis:0,vy=this.scrollableH>0||this.unboundedH?(tln.y-tl.y)/millis:0;this.vel=new Vec22([-vx,-vy]),ovel&&(this.vel=this.vel.add(ovel).scale(.5))}return this._oldTouch=null,this._lastDist=null,this._zoomCenter=null,touch.ungrab(),!1}on_touch_move(event,object,touch){if(touch.grabbed!==this)return!1;let r=touch.rect;if(this.collide(r)){let tl=touch.asChildTouch(this);if((this.uiMove&&touch.nativeEvent==null||touch.nativeEvent instanceof TouchEvent&&touch.nativeEvent.touches.length==1)&&this._oldTouch!=null&&touch.identifier==this._oldTouch[2]){this.scrollW&&(this.scrollX=this.scrollableW==0?0:this._scrollX+(this._oldTouch[0]-tl.x)),this.scrollH&&(this.scrollY=this.scrollableH==0?0:this._scrollY+(this._oldTouch[1]-tl.y));let tln=touch.asChildTouch(this),ot=this._oldTouch,time=Date.now(),vel=new Vec22([0,0]),ovel=new Vec22([0,0]);if(ot!=null){let millis=Math.max(time-ot[3],1),vx=this.scrollableW>0||this.unboundedW?(tln.x-tl.x)/millis:0,vy=this.scrollableH>0||this.unboundedH?(tln.y-tl.y)/millis:0;vel=new Vec22([vx,vy]),ovel=ot[4]!==null?ot[4]:ovel}let nvel=vel.abs().sum()===0?vel:vel.add(ovel).scale(.5);this._oldTouch=[tln.x,tln.y,touch.identifier,time,nvel]}if(this.uiZoom&&touch.nativeEvent&&touch.nativeEvent instanceof TouchEvent&&touch.nativeEvent.touches.length==2){let t0=touch.nativeEvent.touches[0],t1=touch.nativeEvent.touches[1],d=dist([t0.clientX,t0.clientY],[t1.clientX,t1.clientY]);if(this._lastDist!=null){let scrollPosCenterW=this._scrollX+this.w/this.zoom/2,scrollPosCenterH=this._scrollY+this.h/this.zoom/2,touchPixelPos0=[t0.clientX,t0.clientY],touchPixelPos1=[t1.clientX,t1.clientY],scrollableTouchPosBefore0=this.appToChild(touchPixelPos0),scrollableTouchPosBefore1=this.appToChild(touchPixelPos1),sTargetCenterPosBefore=[(scrollableTouchPosBefore0[0]+scrollableTouchPosBefore1[0])/2,(scrollableTouchPosBefore0[1]+scrollableTouchPosBefore1[1])/2];this._zoomCenter===null&&(this._zoomCenter=new Vec22(sTargetCenterPosBefore));let zoom=this.zoom*d/this._lastDist,minZoom=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(zoom,minZoom);let scrollableTouchPosAfter0=this.appToChild(touchPixelPos0),scrollableTouchPosAfter1=this.appToChild(touchPixelPos1),sTargetCenterPosAfter=[(scrollableTouchPosAfter0[0]+scrollableTouchPosAfter1[0])/2,(scrollableTouchPosAfter0[1]+scrollableTouchPosAfter1[1])/2];this.scrollX=scrollPosCenterW+sTargetCenterPosBefore[0]-sTargetCenterPosAfter[0]-this.w/this.zoom/2,this.scrollY=scrollPosCenterH+sTargetCenterPosBefore[1]-sTargetCenterPosAfter[1]-this.h/this.zoom/2}this._lastDist=d}}return!1}on_touch_cancel(event,object,touch){return this._lastDist=null,touch.grabbed===this?(touch.ungrab(),!0):!!super.on_touch_cancel(event,object,touch)}on_wheel(event,object,touch){let app=App.get();if(!app.inputHandler)return!0;let sx=this._scrollX+this.w/this.zoom/2,sy=this._scrollY+this.h/this.zoom/2,wheel=touch.nativeObject;if(!this.collide(touch.rect)&&(!this.unboundedW||!this.unboundedH)||!(wheel instanceof WheelEvent))return!1;if(this.uiZoom&&app.inputHandler.isKeyDown("Control")){let loc=touch.asChildTouch(this);loc.pos[0],loc.pos[1];let zoom=this.zoom*Math.exp(-wheel.deltaY/app.h),minZoom=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(zoom,minZoom);let moc=touch.asChildTouch(this);return moc.pos[0],moc.pos[1],this.scrollX=this.scrollableW==0&&!this.unboundedW?0:sx-this.w/this.zoom/2,this.scrollY=this.scrollableH==0&&!this.unboundedH?0:sy-this.h/this.zoom/2,this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}else{if(this.uiMove&&this.scrollW&&app.inputHandler.isKeyDown("Shift"))return this.scrollX+=this.scrollableW==0&&!this.unboundedW?0:this.w/this.zoom*(wheel.deltaY/app.w),this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),!0;if(this.uiMove&&this.scrollH)return this.scrollY+=this.scrollableH==0&&!this.unboundedH?0:this.h/this.zoom*(wheel.deltaY/app.h),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}return!1}get scrollableW(){return this.children.length==0?0:this.unboundedW?this.children[0].w-this.w/this.zoom:Math.max(this.children[0].w-this.w/this.zoom,0)}get scrollableH(){return this.children.length==0?0:this.unboundedH?this.children[0].h-this.h/this.zoom:Math.max(this.children[0].h-this.h/this.zoom,0)}_draw(app,ctx,millis){this.draw(app,ctx);let r=this.rect;r[0]=Math.floor(r[0]*app.tileSize*app.pixelSize)/(app.tileSize*app.pixelSize),r[1]=Math.floor(r[1]*app.tileSize*app.pixelSize)/(app.tileSize*app.pixelSize),r[2]=Math.floor(r[2]*app.tileSize*app.pixelSize)/(app.tileSize*app.pixelSize),r[3]=Math.floor(r[3]*app.tileSize*app.pixelSize)/(app.tileSize*app.pixelSize),ctx.save(),ctx.beginPath(),ctx.rect(r[0],r[1],r[2],r[3]),ctx.clip();let newT=this.getTransform();newT&&ctx.transform(newT.a,newT.b,newT.c,newT.d,newT.e,newT.f),this.children[0]._draw(app,ctx,millis),ctx.restore()}}class ModalView extends BoxLayout{constructor(){super();__publicField(this,"closeOnTouchOutside",!0);__publicField(this,"bgColor","slate");__publicField(this,"outlineColor","gray");__publicField(this,"dim",!0);__publicField(this,"dimScale",.8)}get visible(){return App.get()._modalWidgets.indexOf(this)>=0}popup(){if(this.parent==null){let app=App.get();return this.parent=app,app.addModal(this),!0}return!1}close(exitVal=0){if(this.parent!=null){this.emit("close",exitVal);let app=App.get();return this.parent=null,app.removeModal(this),!0}return!1}on_touch_down(event,object,touch){return this.closeOnTouchOutside&&!this.collide(touch.rect)?(this.close(),!0):super.on_touch_down(event,object,touch)}draw(app,ctx){if(this.dim){let r=App.get().baseWidget.rect,ctx2=App.get().ctx;if(!ctx2)return;ctx2.fillStyle="rgba(0,0,0,"+this.dimScale+")",ctx2.rect(r[0],r[1],r[2],r[3]),ctx2.fill(),super.draw(app,ctx2)}}}class LayeredAnimationFrame extends Array{constructor(frames,offsets){super();for(let i=0;i<frames.length;++i)offsets[i]?this.push(frames[i],offsets[i][0],offsets[i][1]):this.push(frames[i],0,0)}*iter(){for(let i=0;i<this.length/3;i++)yield[this[i*3],this[i*3+1],this[i*3+2]]}}class SpriteWidget extends Widget{constructor(props={}){super();__publicField(this,"spriteSheet",null);__publicField(this,"frames",[]);__publicField(this,"timePerFrame",30);__publicField(this,"timeLeft",0);__publicField(this,"activeFrame",0);__publicField(this,"id","");__publicField(this,"facing",0);__publicField(this,"flipX",!1);__publicField(this,"flipY",!1);__publicField(this,"oneShot",!1);props&&this.updateProperties(props)}update(app,millis){if(super.update(app,millis),this.timeLeft-=millis,this.timeLeft<=0){if(this.oneShot&&this.activeFrame===this.frames.length-1){this.timeLeft=1/0,this.emit("animationComplete",this.activeFrame);return}this.activeFrame++,this.activeFrame>=this.frames.length&&(this.activeFrame=0),this.timeLeft+=this.timePerFrame}this.frames.length>0&&this.timeLeft!==1/0&&app.requestFrameUpdate()}restart(){this.activeFrame=0,this.timeLeft=this.timePerFrame}on_frames(e,o,v){this.restart()}get frame(){return this.frames[this.activeFrame]??-1}draw(app,ctx){var _a;if(this.spriteSheet===null||!((_a=this.spriteSheet.sheet)!=null&&_a.complete))return;const tx=Math.floor(this.x*this.spriteSheet.spriteSize)/this.spriteSheet.spriteSize,ty=Math.floor(this.y*this.spriteSheet.spriteSize)/this.spriteSheet.spriteSize;if(ctx.translate(tx,ty),ctx.scale(this.w,this.h),this.frame instanceof LayeredAnimationFrame)for(let[f,dx,dy]of this.frame.iter())this.spriteSheet.drawIndexed(ctx,f,0,0,this.facing,this.flipX,dx,dy);else this.spriteSheet.drawIndexed(ctx,this.frame,0,0,this.facing,this.flipX);ctx.scale(1/this.w,1/this.h),ctx.translate(-tx,-ty)}}class TileMap extends Widget{constructor(props={}){super(),this.defaultValue=-1,this._data=new Grid2D,this._vLayer=null,this._aLayer=null,this._cacheTileDim=new Vec22,this.tileDim=new Vec22,this.hints={w:null,h:null},this.spriteSheet=null,this.clipRegion=null,this.alphaValue=.5,this.useCache=!0,props&&this.updateProperties(props)}serialize(){const data={};return data._data=this._data.slice(),data.tileDim=this.tileDim.slice(),data.spriteSheet=Array(...App.resources.keys()).find(k=>App.resources[k]===this.spriteSheet)??null,data}get(pos){return this._data.get(pos)}set(pos,value){this._data.set(pos,value),this._data._cacheData=null}get data(){return this._data}deserialize(data){this.tileDim=new Vec22(data.tileDim??[0,0]);const _data=data._data;for(let i=0;i<_data.length;i++)this._data[i]=_data[i];this.spriteSheet=App.resources[data.spriteSheet]??null,this._data._cacheData=null}on_tileDim(evt,obj,val){this.resizeData(),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new Vec22(this.tileDim)}resizeData(){let cacheData=[];for(let y=0;y<this._cacheTileDim[1];y++)for(let x=0;x<this._cacheTileDim[0];x++)cacheData.push(this.get([x,y]));this._data.tileDim=new Vec22(this.tileDim),this._data.length=this.tileDim[0]*this.tileDim[1],this._data.fill(this.defaultValue);let i=0;for(let y=0;y<this._cacheTileDim[1];y++)for(let x=0;x<this._cacheTileDim[0];x++)x<this.tileDim[0]&&y<this.tileDim[1]&&this.set([x,y],cacheData[i]),++i;this._data._cacheData=null}draw(app,ctx){if(super.draw(app,ctx),this.spriteSheet===null||!this.spriteSheet.sheet.complete||!this.spriteSheet.sheet.complete||this.spriteSheet.sheet.naturalHeight==0)return;let[x0,y0]=[0,0],[x1,y1]=this.tileDim;if(this.clipRegion&&([x0,y0]=this.clipRegion.pos,[x1,y1]=this.clipRegion.pos.add(this.clipRegion.size).add([1,1]),x0=Math.min(Math.max(x0,0),this.tileDim[0]),x1=Math.min(Math.max(x1,0),this.tileDim[0]),y0=Math.min(Math.max(y0,0),this.tileDim[1]),y1=Math.min(Math.max(y1,0),this.tileDim[1])),Math.floor(this.spriteSheet.sheet.width/this.spriteSheet.spriteSize),Math.floor(this.spriteSheet.sheet.height/this.spriteSheet.spriteSize),this.useCache){if(this._data._cacheData===null&&this.cacheCanvas(),this._data._cacheData===null)return;const s=this.spriteSheet.spriteSize;if(ctx.drawImage(this._data._cacheData,s*x0,s*y0,s*(x1-x0),s*(y1-y0),this.x+x0,this.y+y0,x1-x0,y1-y0),this._aLayer===null&&this._vLayer===null)for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=this._data[p];ind<-1&&this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y)}else if(this._aLayer&&this._vLayer){const aL=this._aLayer,vL=this._vLayer,origAlpha=ctx.globalAlpha,dat=this._data;for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=dat[p];ind<-1&&vL[p]>0&&(aL[p]===0?(ctx.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y),ctx.globalAlpha=origAlpha):this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y))}}}else if(this._aLayer===null&&this._vLayer===null)for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=this._data[p];this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y)}else if(this._aLayer&&this._vLayer){const aL=this._aLayer,vL=this._vLayer,origAlpha=ctx.globalAlpha,dat=this._data;for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=dat[p];ind!==-1&&vL[p]>0&&(aL[p]===0?(ctx.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y),ctx.globalAlpha=origAlpha):this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y))}}}clearCache(){this.data._cacheData=null}cacheCanvas(){if(this._data._cacheData=null,!this.spriteSheet||!this.spriteSheet.sheet||this.tileDim[0]<=0||this.tileDim[1]<=0)return;const _cacheData=new OffscreenCanvas(this.tileDim[0]*this.spriteSheet.spriteSize,this.tileDim[1]*this.spriteSheet.spriteSize),cacheCtx=_cacheData.getContext("2d");if(!cacheCtx)return;cacheCtx.scale(this.spriteSheet.spriteSize,this.spriteSheet.spriteSize);let[x0,y0]=[0,0],[x1,y1]=this.tileDim;if(this._aLayer===null&&this._vLayer===null)for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=this._data[p];ind>=0&&this.spriteSheet.drawIndexed(cacheCtx,ind,x,y)}else if(this._aLayer&&this._vLayer){const aL=this._aLayer,vL=this._vLayer,origAlpha=cacheCtx.globalAlpha,dat=this._data;for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=dat[p];ind>=0&&vL[p]>0&&(aL[p]===0?(cacheCtx.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(cacheCtx,ind,x,y),cacheCtx.globalAlpha=origAlpha):this.spriteSheet.drawIndexed(cacheCtx,ind,x,y))}}this._data._cacheData=_cacheData}}class LayeredTileMap extends TileMap{constructor(props={}){super(),this._layerData=[this._data],this.numLayers=1,this.activeLayer=0,this.visibilityLayer=-1,this.alphaLayer=-1,props&&this.updateProperties(props)}on_alphaLayer(e,o,v){this._aLayer=this.alphaLayer>=0?this._layerData[this.alphaLayer]:null}on_visibilityLayer(e,o,v){this._vLayer=this.visibilityLayer>=0?this._layerData[this.visibilityLayer]:null}serialize(){const data={},layerCopy=[];for(let l of this._layerData)layerCopy.push(l.slice());return data._layerData=layerCopy,data.activeLayer=this.activeLayer,data.numLayers=this.numLayers,data.tileDim=this.tileDim.slice(),data.spriteSheet=Array(...App.resources.keys()).find(k=>App.resources[k]===this.spriteSheet)??null,data}deserialize(data){this.numLayers=data.numLayers,this.activeLayer=data.activeLayer,this.tileDim=new Vec22(data.tileDim??[0,0]);const n=data._layerData.length;this._layerData.length=n;for(let i=0;i<n;i++){const lout=this._layerData[i],lin=data._layerData[i];for(let j=0;j<lin.lenth;j++)lout[j]=lin[j]}this.spriteSheet=App.resources[data.spriteSheet]??null,this.clearCache()}on_tileDim(evt,obj,val){if("_layerData"in this){for(let l of this._layerData)this._data=l,this.resizeData();this.activeLayer>=0&&(this._data=this._layerData[this.activeLayer]),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new Vec22(this.tileDim)}}on_numLayers(evt,obj,val){const oldLen=this._layerData.length;this._layerData.length=this.numLayers;for(let i=oldLen;i<this.numLayers;i++){const layer=new Grid2D(this.tileDim).fill(this.defaultValue);this._layerData[i]=layer}this.activeLayer>=this.numLayers&&(this.activeLayer=this.numLayers-1)}on_activeLayer(evt,obj,val){this._data=this._layerData[this.activeLayer]}get layer(){return this._layerData}getFromLayer(layer,pos){return this._layerData[layer][pos[0]+pos[1]*this.tileDim[0]]}setInLayer(layer,pos,val){this._layerData[layer][pos[0]+pos[1]*this.tileDim[0]]=val,this._layerData[layer]._cacheData=null}clearCache(){for(let l of this._layerData)l._cacheData=null}draw(app,ctx){for(let l of this._layerData)l.hidden||(this._data=l,super.draw(app,ctx));this._data=this._layerData[this.activeLayer]}}App.registerClass("Widget",Widget,"");App.registerClass("App",App,"");App.registerClass("Label",Label,"");App.registerClass("Button",Button,"");App.registerClass("ToggleButton",ToggleButton,"");App.registerClass("BasicButton",BasicButton,"");App.registerClass("TextInput",TextInput,"");App.registerClass("CheckBox",CheckBox,"");App.registerClass("Slider",Slider,"");App.registerClass("ImageWidget",ImageWidget,"");App.registerClass("BoxLayout",BoxLayout,"");App.registerClass("GridLayout",GridLayout,"");App.registerClass("ScrollView",ScrollView,"");App.registerClass("ModalView",ModalView,"");App.registerClass("Notebook",Notebook,"");App.registerClass("TabbedNotebook",TabbedNotebook,"");App.registerClass("SpriteWidget",SpriteWidget,"");App.registerClass("TileMap",TileMap,"");App.registerClass("LayeredTileMap",LayeredTileMap,"");const LEAD_RANGE=40,RETURN_DIST=60;function distToSegmentXZ(p,a2,b){const ax=a2[0],az=a2[2],bx=b[0],bz=b[2],px=p[0],pz=p[2],abx=bx-ax,abz=bz-az,apx=px-ax,apz=pz-az,abLenSq=abx*abx+abz*abz;if(abLenSq<1e-5)return Math.hypot(apx,apz);const t=Math.max(0,Math.min(1,(apx*abx+apz*abz)/abLenSq)),cx=ax+abx*t,cz=az+abz*t;return Math.hypot(px-cx,pz-cz)}function inFront(player,target){const f=player.vel.xz,v=("pos"in target?target.pos:target).c.sub(player.pos).xz;return f.dot(v)>=0}function pathThreat(player,target,opponents,baseReach=1.5){const segStart=player.pos,segEnd="pos"in target?target.pos:target,segVec=segEnd.c.sub(segStart),segLen=segVec.len();if(segLen<.5)return 1;const g=-player.gravity[1],angleDeg=segLen<=player.statsHandpassRange?10:30,params=getLaunchParamsFor(segStart,segEnd.c.add([0,player.statsHeight-.1,0]),g,angleDeg);if(!params)return 1;const travelTime=segLen/Math.max(params.speed,1e-6),segDir=segVec.c.normalize();let worst=0;for(const opp of opponents){const rel=opp.pos.c.sub(segStart),t=segDir.dot(rel);if(t<0||t>segLen)continue;const distSeg=distToSegmentXZ(opp.pos,segStart,segEnd),lateralSpeed=(opp.jogSpeed??0)+(opp.joltSpeed??0),maxR=baseReach+lateralSpeed*travelTime,r=Math.max(0,Math.min(1,1-distSeg/Math.max(maxR,1e-6))),midWeight=1-Math.abs(t/segLen-.5)*.6;if(worst=Math.max(worst,r*midWeight),worst===1)break}return worst}function countOpponentsWithin(point,opponents,radius){let n=0;for(const o of opponents)o.pos.c.zeroY().dist(point.c.zeroY())<=radius&&n++;return n}function findDisposalTarget(game,player,teammates,opponents,passDir,preferHandpass=!1){const gravity=Math.abs(game.ball.gravity[1]),kickAngleDeg=30,coneThreshold=0,uPass=passDir&&(passDir.x!==0||passDir.z!==0)?passDir.c.zeroY().normalize():null,goalDir=player.team==="home"?-1:1;let bestTarget,bestScore=-1/0,bestNeedsLoft=!1;if((!preferHandpass||player.pos.dist(goals[player.team])<player.statsKickRange-20)&&inFront(player,goals[player.team])){const longKickTarget=player.pos.c.add(player.pos.c.dirTo(goals[player.team]).scale(player.statsKickRange));if(isOutOfBounds(longKickTarget))bestTarget=longKickTarget,bestScore=40-player.pos.dist(goals[player.team]);else{const laneBad=pathThreat(player,longKickTarget,opponents,2.5);bestTarget=longKickTarget,bestScore=player.statsKickRange/2-laneBad*player.statsKickRange/2}}const debugScoreData=[[bestTarget,bestScore]];for(const mate of teammates){if(mate===player)continue;if(uPass){const toMate=mate.pos.c.sub(player.pos).zeroY().normalize();if(toMate.dot(uPass)<coneThreshold){debugScoreData.push([mate,`Out of pass cone ${passDir}: ${toMate.dot(uPass)} < ${coneThreshold}`]);continue}}const horizDist=player.pos.c.zeroY().dist(mate.pos.c.zeroY());if(horizDist>(preferHandpass?player.statsHandpassRange+5:player.statsKickRange+10)){debugScoreData.push([mate,`Out of range ${horizDist}`]);continue}const launch=getLaunchParamsFor(player.pos,mate.pos,gravity,kickAngleDeg);if(!launch){debugScoreData.push([mate,`No launch from ${player.pos} to ${mate.pos} dist ${player.pos.dist(mate.pos)}`]);continue}const T=horizDist/launch.speed,A=player.pos,B=mate.pos,AB=B.c.sub(A).zeroY(),L=AB.len(),u=L?AB.c.scale(1/L):AB;let blocked=!1,nearestOppDist=1/0;for(const o of opponents){nearestOppDist=Math.min(nearestOppDist,o.pos.c.zeroY().dist(B.c.zeroY()));const rel=o.pos.c.sub(A).zeroY(),s=rel.dot(u);if(s<=0||s>=L)continue;const lateral=rel.c.sub(u.c.scale(s)).len(),reach=1.2+((o.jogSpeed??0)+(o.joltSpeed??0))*(s/L*T);if(lateral<=reach){blocked=!0,debugScoreData.push([mate,`lane ${o.name}`]);break}}const blockedPenalty=blocked?10:0,gapScore=nearestOppDist,forwardZ=(mate.pos.z-player.pos.z)*goalDir,moveAlign=mate.vel.c.zeroY().lenSq()>1e-4?mate.vel.c.zeroY().normalize().dot(mate.pos.c.sub(player.pos).zeroY().normalize()):0,Rsel=horizDist<=player.statsHandpassRange?6:11,densityPenalty=countOpponentsWithin(mate.pos,opponents,Rsel)*(horizDist<=player.statsHandpassRange?8:6),score=forwardZ+moveAlign*15+gapScore-densityPenalty-blockedPenalty+Math.random()*2;debugScoreData.push([player,`score ${score}: ${forwardZ} + ${moveAlign*15} + ${gapScore} - ${densityPenalty} + rand*2`]),score>bestScore&&(bestScore=score,bestTarget=mate,horizDist<=player.statsHandpassRange,bestNeedsLoft=blocked)}if(!bestTarget)return player.pos,`${passDir}`,["handball",void 0];let targetPos;if(bestTarget instanceof Player){const mate=bestTarget,launch=getLaunchParamsFor(player.pos,mate.pos,gravity,30),horiz=player.pos.c.zeroY().dist(mate.pos.c.zeroY()),T=launch?horiz/Math.max(launch.speed,1e-6):.8,avgOpponentDir=opponents.reduce((prev,opp)=>opp.pos.dist(mate.pos)<.7*T*(opp.jogSpeed+opp.joltSpeed)?prev.add(mate.pos.dirTo(opp.pos)):prev,v3(0,0,0));avgOpponentDir.len()>1e-4?(avgOpponentDir.normalize(),targetPos=mate.pos.c.scaleAndAdd(avgOpponentDir,-.5*T*(mate.jogSpeed+mate.joltSpeed))):targetPos=mate.pos.c.scaleAndAdd(mate.vel,.5*T)}else targetPos=bestTarget;targetPos.dist(player.pos)>player.statsKickRange&&targetPos.copyFrom(player.pos.c.scaleAndAdd(player.pos.c.dirTo(targetPos),player.statsKickRange));let isHand=player.pos.c.zeroY().dist(targetPos.c.zeroY())<=player.statsHandpassRange;return player.intentVelocity=null,isHand&&bestNeedsLoft&&(player.intentVelocity=v3(0,5,0)),player.pos,player.pos.dist(bestTarget.pos??bestTarget),`${targetPos}`,bestTarget.pos,[isHand?"handball":"kickToTarget",targetPos]}function isInLeadRange(player,ballPos){const direction=player.team==="home"?-1:1,dz=(player.pos[2]-ballPos[2])*direction;return dz>0&&dz<=LEAD_RANGE}function shouldClearOut(player,game){if(game.ball.carrier===player)return!1;if(game.setPiece&&"kicker"in game.setPiece&&game.setPiece.kicker instanceof Player){const kicker=game.setPiece.kicker;if(kicker.team===player.team&&player.pos.dist(kicker.pos)<20)return!0}return player.intent==="lead"&&player.stateTimer>3||game.players.filter(p=>p!==player&&p.playing&&p.team===player.team&&p.pos.dist(player.pos)<8).length>=3}function shouldReturnToPosition(player,game){player.intent==="pushBack"&&player.pos.dist(player.positionPos)>5&&(player.intentTarget=player.positionPos.c);const ballPos=game.ball.carrier?game.ball.carrier.pos:game.ball.pos,direction=player.team==="home"?-1:1,ahead=(player.positionPos[2]-ballPos[2])*direction;return player.pos.dist(ballPos)>RETURN_DIST&&player.pos.dist(player.positionPos)>5||game.players.filter(p=>p!==player&&p.playing&&p.team===player.team&&p.pos.dist(player.pos)<10).length>=2&&player.pos.dist(player.positionPos)>5||ahead>LEAD_RANGE&&player.pos.dist(player.positionPos)>5}function shouldLeadNow(player,game){const ballCarrier=game.ball.carrier;if(!ballCarrier||ballCarrier.team!==player.team)return!1;const zGap=(player.pos[2]-ballCarrier.pos[2])*(player.team==="home"?-1:1);if(zGap<5||zGap>50)return!1;const dist2=player.pos.dist(ballCarrier.pos);return!(dist2<25||dist2>75||game.players.filter(p=>p!==player&&p.playing&&p.team===player.team&&p.intent==="lead"&&p.pos.dist(player.pos)<20).length>2)}function setLeadingDirs(offense,defense,game){const ballCarrier=game.ball.carrier;if(!ballCarrier)return;const sign=ballCarrier.team==="home"?-1:1,forward=v3(0,0,sign),angles=[-40,-20,0,20,40],leadDist=20,candidates=angles.map(a2=>{const dir=forward.c.rotateXZ(a2*Math.PI/180),pos=ballCarrier.pos.c.scaleAndAdd(dir,leadDist),score=defense.reduce((m,d)=>Math.min(m,d.pos.dist(pos)),1/0);return{dir,pos,score}}).sort((A,B)=>B.score-A.score),assigned=new Set;for(const cand of candidates){let best=null,bestDist=1/0;for(const p of offense){if(assigned.has(p))continue;const dist2=p.pos.dist(cand.pos);dist2<bestDist&&(best=p,bestDist=dist2)}best&&(assigned.add(best),best.intent="lead",best.intentTarget=null,best.intentVelocity=best.pos.c.dirTo(cand.pos).scale(best.jogSpeed+best.joltSpeed))}for(const p of offense)assigned.has(p)||(p.pos.dist(p.positionPos)>5?(p.intent="pushBack",p.intentTarget=p.positionPos.c,p.intentVelocity=null):(p.intent="idle",p.intentTarget=null,p.intentVelocity=null))}function getCrumbSpot(player,landing){const sign=player.team==="home"?-1:1,lateral=(Math.random()-.5)*2;return v3(landing[0]+lateral,landing[1],landing[2]+sign*3)}function findSafeRunDirection(player,game,stepAngleDeg=15,maxAngleDeg=90,checkDist=2,dangerRadius=5){const forward=player.pos.c.dirTo(goals[player.team]),anglesToTry=[0];for(let a2=stepAngleDeg;a2<=maxAngleDeg;a2+=stepAngleDeg)anglesToTry.push(+a2),anglesToTry.push(-a2);for(const angleDeg of anglesToTry){const angleRad=angleDeg*Math.PI/180,dir=forward.c.rotateXZ(angleRad),testPos=player.pos.c.scaleAndAdd(dir,checkDist);let safe=!0;for(const opponent of game.players){if(opponent.team===player.team||!opponent.playing)continue;if(opponent.pos.dist(testPos)<dangerRadius){safe=!1;break}}if(safe)return dir}return null}function findClosestOpponent$1(player,opponents){return opponents.reduce((best,opp)=>!best||player.pos.distSq(opp.pos)<player.pos.distSq(best.pos)?opp:best,void 0)}function isFrontHalf(player,game){const axis=goals[player.team].c.sub([0,FIELD_LENGTH$1/2,0]).xz,rel=player.pos.c.sub([0,FIELD_LENGTH$1/2,0]).xz;return axis.dot(rel)>0}function inKickRangeOfGoal(carrier,game){return carrier.pos.dist(goals[carrier.team])<=carrier.statsKickRange+30}function findClosestOpponent(kicker,players,markPos){let closest=null,minDist=1/0;for(const p of players)if(p.team!==kicker.team){const d=p.pos.dist(markPos);d<minDist&&(minDist=d,closest=p)}return closest}class SetPiece{constructor(game){this.game=game,this.timer=0,this.finished=!1}update(dt){this.timer+=dt}enforce(player,dt){return!1}cameraTarget(){return null}getIntent(player){return null}cleanup(){}}class FreeKickSetPiece extends SetPiece{constructor(game,kicker,markPos){super(game),this.kicker=kicker,this.state="backup",this.markPos=markPos.c.zeroY(),this.zone={center:v3(0,0,0),radius:1},this.game=game,this.timer=10,game=this.game,kicker=this.kicker;const goalZ=kicker.team==="home"?0:FIELD_LENGTH$1,goalDir=v3(0,0,goalZ).c.sub(this.markPos).zeroY().normalize();this.backupPos=this.markPos.c.scaleAndAdd(goalDir,-15),kicker.intent="freeKick",kicker.intentTarget=this.markPos.c.scaleAndAdd(goalDir,-15),game.ball.carrier!==kicker&&game.ball.pickup(kicker),kicker.team==="home"&&(this.game.player=kicker),this.defender=findClosestOpponent(kicker,game.players,this.markPos),this.defenderMarkAssignment={targetPos:this.markPos.c,arrived:!1},this.defender&&(this.defender.actionState="run",this.defender.intent="standMark",this.defender.intentTarget=this.markPos)}update(dt){if(this.timer-=dt,this.timer<=0){this.kicker.intent="idle",this.kicker.intentTarget=null,this.defender&&(this.defender.intent="contestAnyway",this.defender.intentTarget=this.kicker),this.finished=!0,this.game.banner.commentary("PLAY ON");return}const{kicker,markPos,game}=this,disposed=!game.ball.carried;this.defender&&!this.defenderMarkAssignment.arrived&&this.defender.pos.dist(this.markPos)<1&&(this.defenderMarkAssignment.arrived=!0,this.defender.actionState="standingMark",this.defender.stateTimer=10,this.defender.intent="standMark",this.defender.intentTarget=this.markPos,this.defender.jogVel.setFrom(0,0,0),this.defender.joltVel.setFrom(0,0,0));const goalDir=v3(0,0,kicker.team==="home"?0:FIELD_LENGTH$1).c.sub(markPos).zeroY().normalize(),lateralDir=v3(-goalDir[2],0,goalDir[0]),markToKicker=kicker.pos.c.sub(markPos).zeroY(),forwardDist=markToKicker.dot(goalDir),lateralDist=Math.abs(markToKicker.dot(lateralDir)),movingForward=kicker.vel.c.zeroY().dot(goalDir)>.5,playedOn=forwardDist>.05&&movingForward||lateralDist>2.5;if(playedOn&&isOutOfBounds(kicker.pos)){this.game.setPiece=new BoundaryThrowInSetPiece(this.game,this.markPos.c),game.banner.commentary("OUT OF BOUNDS");return}this.timer<9&&(playedOn&&game.banner.commentary("PLAY ON!"),(disposed||playedOn)&&(this.defender!==null&&(this.defender.stateTimer=0,this.defender.intent="spoil",this.defender.actionState="run",this.defender.intentTarget=kicker.pos.c),this.kicker.intent="idle",this.finished=!0))}enforce(player,dt){const{defender,markPos}=this;return player===defender&&this.defenderMarkAssignment.arrived&&(player.pos.copyFrom(markPos),player.vel.setFrom(0,player.vel[1],0),player.jogVel.setFrom(0,0,0),player.joltVel.setFrom(0,0,0)),!1}getIntent(player){return"idle"}}class CenterBounceSetPiece extends SetPiece{constructor(game){super(game),this.bouncePos=v3(0,0,FIELD_LENGTH$1/2),this.game=game;const ball=game.ball;ball.carried=!1,ball.carrier=null,ball.pos.setFrom(0,0,FIELD_LENGTH$1/2),ball.vel.setFrom(0,0,0),ball.origin.copyFrom(ball.pos),ball.lastTouchedBy=null,ball.lastTouchedType=null,this.ballLaunched=!1,this.waitTimer=5;for(const p of game.players)p.playing&&(p.pos.copyFrom(p.positionPos),p.vel.setFrom(0,0,0),p.jogVel.setFrom(0,0,0),p.joltVel.setFrom(0,0,0),p.actionState="idle",p.intent="centerBounceFreeze",p.intentTarget=null);const homePlayers=game.players.filter(p=>p.team==="home"&&p.playing),awayPlayers=game.players.filter(p=>p.team==="away"&&p.playing);this.homeRuck=this.findRuck(homePlayers),this.awayRuck=this.findRuck(awayPlayers),this.homeRuck&&(this.homeRuck.intent="ruckTap",this.homeRuck.intentTarget=v3(0,0,0)),this.awayRuck&&(this.awayRuck.intent="ruckTap",this.awayRuck.intentTarget=v3(0,0,0)),this.crumbers=game.players.filter(p=>["RR","Rover","C"].includes(p.name)),this.crumbAssignments=new Map,this.crumbers.forEach((c,i)=>{const ruck=c.team==="home"?this.homeRuck:this.awayRuck,angle=(i%2===0?-1:1)*(Math.PI/4),offset=v3(Math.sin(angle)*(Math.random()*4+4),0,Math.cos(angle)*(Math.random()*4+4));c.intent="crumb",ruck?(c.intentTarget=ruck.pos.c.add(offset),this.crumbAssignments.set(c,{ruck,offset})):c.intentTarget=this.bouncePos.c.add(offset)}),this.jumped=new Set,this.tapResolved=!1,this.moveStartTimes=new Map,this.ballLaunchTime=0}findRuck(players){let ruck=players.find(p=>p.name==="Ruck");return ruck||(ruck=players.reduce((a2,b)=>a2&&a2.statsHeight>b.statsHeight?a2:b,players[0])),ruck}update(dt){super.update(dt);const ball=this.game.ball;if(!this.ballLaunched){this.waitTimer-=dt,this.waitTimer<=0&&(this.game.banner.commentary("BALL UP!"),ball.launch(v3(0,1,0),15,null),this.ballLaunched=!0,this.ballLaunchTime=this.timer,this.homeRuck.actionState="run",this.awayRuck.actionState="run");return}if(ball.carried||ball.hasBounced){this.finished=!0;for(let p of this.game.players)p.playing&&(p.intent="idle")}}enforce(player,dt){if(!this.ballLaunched)return player.vel.setFrom(0,0,0),player.jogVel.setFrom(0,0,0),player.joltVel.setFrom(0,0,0),!0;const radius=3,center=this.bouncePos;if(player===this.homeRuck||player===this.awayRuck)return!1;const dist2=player.pos.dist(center);if(dist2<radius){const dir=player.pos.c.sub(center).zeroY();return dir.len()<.001&&dir.setFrom(Math.random()-.5,0,Math.random()-.5),dir.normalize(),player.joltVel.scaleAndAdd(dir,(radius-dist2)*20*dt),player.pos.scaleAndAdd(player.joltVel,dt),!0}return!1}getIntent(player){const game=this.game;if(player===this.homeRuck||player===this.awayRuck){if(this.waitTimer<=0){const result=computeBestIntercept(player.pos.c,player.statsHeight+.3,player.statsJump,player.jogSpeed+player.joltSpeed,game.ball.pos,game.ball.vel,Math.abs(game.ball.gravity[1]),game.dt);player.intent=result.jumpNow||player.pos[1]>0?"jumpRuckTap":"ruckTap",player.intentVelocity=result.runVel??null,player.intentTarget=null}return player.intent}if(player.intent==="crumb"&&(player!==this.game.player||this.game.controls.state.moveX===0&&this.game.controls.state.moveZ===0)){const assignment=this.crumbAssignments.get(player);return assignment&&(player.intentTarget=assignment.ruck.pos.c.add(assignment.offset),this.game.currentContest&&(player.intentVelocity=player.intentTarget.c.sub(player.pos).scale(1/(this.game.currentContest.time-game.now)))),player.intent}return null}}class BoundaryThrowInSetPiece extends SetPiece{constructor(game,pos){super(game),this.game=game,this.throwPos=pos.c,this.waitTimer=5,this.ballLaunched=!1;const ball=game.ball;ball.carried=!1,ball.carrier=null,ball.pos.copyFrom(pos),ball.vel.setFrom(0,0,0),ball.origin.copyFrom(pos),ball.lastTouchedBy=null,ball.lastTouchedType=null;for(const p of game.players)p.playing&&(p.pos.copyFrom(p.positionPos),p.vel.setFrom(0,0,0),p.jogVel.setFrom(0,0,0),p.joltVel.setFrom(0,0,0),p.actionState="idle",p.intentTarget=null);const center=v3(0,0,FIELD_LENGTH$1/2);this.fieldDir=center.c.sub(pos).zeroY().normalize(),this.landingPos=pos.c.add(this.fieldDir.c.scale(20)),this.ruckPos=pos.c.add(this.fieldDir.c.scale(25));const homePlayers=game.players.filter(p=>p.team==="home"&&p.playing),awayPlayers=game.players.filter(p=>p.team==="away"&&p.playing);this.homeRuck=this.findRuck(homePlayers),this.awayRuck=this.findRuck(awayPlayers),this.homeRuck&&(this.homeRuck.pos.copyFrom(this.ruckPos),this.homeRuck.vel.setFrom(0,0,0),this.homeRuck.jogVel.setFrom(0,0,0),this.homeRuck.joltVel.setFrom(0,0,0),this.homeRuck.intent="ruckTap",this.homeRuck.intentTarget=v3(0,0,0),this.homeRuck.actionState="idle"),this.awayRuck&&(this.awayRuck.pos.copyFrom(this.ruckPos),this.awayRuck.vel.setFrom(0,0,0),this.awayRuck.jogVel.setFrom(0,0,0),this.awayRuck.joltVel.setFrom(0,0,0),this.awayRuck.intent="ruckTap",this.homeRuck.intentTarget=v3(0,0,0),this.homeRuck.actionState="idle");const byTeam={home:game.players.filter(p=>p.team==="home"&&p!==this.homeRuck&&p.playing),away:game.players.filter(p=>p.team==="away"&&p!==this.awayRuck&&p.playing)};this.crumbers=[];for(const team of["home","away"]){const list=byTeam[team].sort((a2,b)=>a2.pos.dist(this.landingPos)-b.pos.dist(this.landingPos));let selected=list.filter(p=>p.positionPos.dist(this.landingPos)<40).slice(0,5);if(selected.length<2){const extras=list.filter(p=>!selected.includes(p)).slice(0,2-selected.length);selected.push(...extras)}selected=selected.slice(0,5),selected.forEach(p=>{p.intent="crumb",p.intentTarget=this.landingPos}),this.crumbers=this.crumbers.concat(selected)}this.crumbAssignments=new Map,this.crumbers.forEach((c,i)=>{const ruck=c.team==="home"?this.homeRuck:this.awayRuck,angle=(i%2===0?-1:1)*(Math.PI/4),offset=v3(Math.sin(angle)*(Math.random()*4+4),0,Math.cos(angle)*(Math.random()*4+4));c.intent="crumb",ruck?(c.intentTarget=ruck.pos.c.add(offset),this.crumbAssignments.set(c,{ruck,offset})):c.intentTarget=this.landingPos.c.add(offset)}),this.jumped=new Set}cameraTarget(){return this.landingPos}findRuck(players){const skip=this.game.player,candidates=players.filter(p=>p!==skip);let ruck=candidates.find(p=>p.name==="Ruck");return ruck&&ruck.pos.dist(this.landingPos)/ruck.jogSpeed<=this.waitTimer?ruck:candidates.sort((a2,b)=>{const da=a2.pos.dist(this.landingPos),db=b.pos.dist(this.landingPos);return Math.abs(da-db)<.001?b.statsHeight-a2.statsHeight:da-db})[0]??null}update(dt){super.update(dt);const ball=this.game.ball;if(!this.ballLaunched){if(this.waitTimer-=dt,this.waitTimer<=0){this.game.banner.commentary("BALL UP!");const params=getLaunchParamsFor(ball.pos.c,this.landingPos,Math.abs(ball.gravity[1]),60);params?ball.launch(params.direction,params.speed,null):ball.launch(this.fieldDir,10,null),this.ballLaunched=!0,this.awayRuck.actionState="run",this.homeRuck.actionState="run"}return}if(ball.vel[1]<0){for(const r of[this.homeRuck,this.awayRuck])if(r&&!this.jumped.has(r)){const g=ball.gravity[1]??-9.8;(-ball.vel[1]-Math.sqrt(Math.max(0,ball.vel[1]**2-2*g*(ball.pos[1]-r.statsHeight))))/g<=.2&&(r.vel[1]=r.statsJump,this.jumped.add(r))}}(ball.carried||ball.hasBounced)&&(this.finished=!0)}enforce(player,dt){const center=this.landingPos;if(player===this.homeRuck||player===this.awayRuck)return!1;const dist2=player.pos.dist(center);if(dist2<3){const dir=player.pos.c.sub(center).zeroY();return dir.len()<.001&&dir.setFrom(Math.random()-.5,0,Math.random()-.5),dir.normalize(),player.joltVel.scaleAndAdd(dir,(3-dist2)*20*dt),player.pos.scaleAndAdd(player.joltVel,dt),!0}return!1}getIntent(player){return null}}class TrainingKicking extends SetPiece{constructor(game){super(game)}update(){if(this.game.ball.hasBounced)this.game.banner.commentary("NO DROPS",null,2e3);else if(this.game.setPiece instanceof BoundaryThrowInSetPiece)this.game.banner.commentary("NO OUT OF BOUNDS",null,2e3);else if(this.game.setPiece instanceof CenterBounceSetPiece)this.game.banner.commentary("GOAL!!",null,2e3);else return;this.game.setupTraining(this.game.homeId,this.game.awayId,5,"kicking")}getIntent(game){return null}}class TrainingHandpass extends SetPiece{constructor(game){super(game)}update(){if(this.game.ball.hasBounced)this.game.banner.commentary("NO DROPPED BALLS",null,2e3);else if(this.game.setPiece instanceof BoundaryThrowInSetPiece)this.game.banner.commentary("NO OUT OF BOUNDS",null,2e3);else if(this.game.setPiece instanceof CenterBounceSetPiece)this.game.banner.commentary("GOAL!!",null,2e3);else if(this.game.ball.lastTouchedType==="kick"&&this.game.ball.pos.dist(goals.home)>50)this.game.banner.commentary(`NO KICKS
GET CLOSER TO TARGET`,null,2e3);else return;this.game.setupTraining(this.game.homeId,this.game.awayId,5,"handpass")}getIntent(game){return null}}function catchOrTapBall(player,game){const ball=game.ball;if(!ball.carried&&ball.catchCollidesWith(player)){if(ball.hasBounced){ball.pickup(player,ball.pos[1]);return}const isRuck=player.intent==="ruckTap"||player.intent==="jumpRuckTap",isSpoil=player.intent==="spoil"||player.intent==="jumpSpoil";if(isRuck&&ball.lastTouchedType===null||isSpoil||ball.vel[1]>0&&ball.lastTouchedType!=="handball"){ball.pickup(player,ball.pos[1]);const mates=game.players.filter(p=>p.team===player.team&&p!==player&&p.playing&&p.pos.dist(player.pos)<15),aimDir=mates.length>0?player.pos.dirTo(choose(mates).pos):v3(Math.random()-.5,0,Math.random()-.5).normalize();ball.launch(aimDir,10,"tap"),isRuck&&game.banner.commentary(`RUCKTAP [${teamAbbrevs[player.teamId]}]`,player.team),isSpoil&&game.banner.commentary(`SPOIL [${teamAbbrevs[player.teamId]}]`,player.team),ball.hasBounced=!1}else if(ball.lastTouchedType==="kick"&&ball.pos.dist(ball.origin)>15){const markClear=!game.players.some(p=>p.team!==player.team&&p.pos.dist(player.pos)<5),dirZ=player.team==="home"?-1:1,behind=player.pos.c.add(v3(0,0,dirZ*8)),spaceBehind=!isOutOfBounds(behind)&&!game.players.some(p=>p.team!==player.team&&p.pos.dist(behind)<5);if(markClear&&spaceBehind&&(player.team==="away"||player.team==="home"&&game.controls.state.moveX!==0&&game.controls.state.moveZ!==0)){game.banner.commentary("PLAY ON"),ball.pickup(player);return}else game.banner.commentary(`MARK [${teamAbbrevs[player.teamId]}]`,player.team),game.setPiece=new FreeKickSetPiece(game,player,player.pos.c)}else ball.lastTouchedBy!==player&&ball.pickup(player)}}const bump={transitions:{run:(p,g)=>p.stateTimer>.3},update:(dt,g,p,transition)=>{if(transition&&p.intentTarget instanceof Player){const pushDir=p.intentTarget.pos.c.sub(p.pos).zeroY().normalize();p.intentTarget.joltVel.add(pushDir.scale(4))}p.jogVel.setFrom(0,0,0),p.applyPhysics(dt,g)}},block={transitions:{run:(p,g)=>!0},update:(dt,g,p,transition)=>{if(transition&&p.intentTarget&&"pos"in p.intentTarget){const pushDir=p.pos.dirTo(p.intentTarget.pos??p.intentTarget).normalize();p.joltVel.copyFrom(pushDir.scale(8))}p.applyPhysics(dt,g)}},idle={transitions:{tackle:(p,g)=>g.ball.carrier!==null&&g.ball.carrier.team!==p.team&&p.collidesWith(g.ball.carrier),tackled:(p,g)=>g.ball.carrier===p&&g.players.some(opp=>opp.team!==p.team&&opp.actionState==="run"&&opp.collidesWith(p)),run:(p,g)=>{const aiMovement=new Set(["runCarry","supportRun","lead","pushForward","fillSpace","markUp","crumb","gatherLoose","contestAnyway","freeKick"]).has(p.intent)&&(!!p.intentVelocity||!!p.intentTarget),isHuman=p===g.player,moveVecLen=len([g.controls.state.moveX,0,g.controls.state.moveZ]),humanMovement=isHuman&&moveVecLen>.1;return aiMovement||humanMovement},spoil:(p,g)=>p.intent==="spoil"&&g.ball.catchCollidesWith(p),mark:(p,g)=>p.intent==="mark"&&g.ball.catchCollidesWith(p),ruckTap:(p,g)=>p.intent==="ruckTap"&&g.ball.catchCollidesWith(p),jump:(p,g)=>{var _a;return(_a=p.intent)==null?void 0:_a.startsWith("jump")},pickUp:(p,g)=>!g.ball.carried&&g.ball.catchCollidesWith(p)},update:(dt,g,p)=>{p.joltVel.setFrom(0,0,0);const alpha=1-Math.exp(-dt/.2);p.energy=Math.min(p.energy+dt,p.statsEnergy),p.jogVel.lerp(p.joltVel,alpha),p.applyPhysics(dt,g)}},run={transitions:{tackle:(p,g)=>g.ball.carrier!==null&&g.ball.carrier.team!==p.team&&p.collidesWith(g.ball.carrier),tackled:(p,g)=>g.ball.carrier===p&&p.intent!=="freeKick"&&g.players.some(opp=>opp.team!==p.team&&opp.actionState==="run"&&opp.collidesWith(p)),kick:(p,g)=>p.intent==="kickToTarget"&&g.ball.carrier===p,handball:(p,g)=>p.intent==="handball"&&g.ball.carrier===p,spoil:(p,g)=>p.intent==="spoil"&&g.ball.catchCollidesWith(p),mark:(p,g)=>p.intent==="mark"&&g.ball.catchCollidesWith(p),ruckTap:(p,g)=>p.intent==="ruckTap"&&g.ball.catchCollidesWith(p),jump:(p,g)=>{var _a;return(_a=p.intent)==null?void 0:_a.startsWith("jump")},pickUp:(p,g)=>!g.ball.carried&&g.ball.catchCollidesWith(p)},update:(dt,g,p)=>{var _a,_b;if((_b=(_a=g.setPiece)==null?void 0:_a.enforce)!=null&&_b.call(_a,p,dt))return;const EPSILON2=1e-4,agility=p.statsAgility??5,alpha=1-Math.exp(-10*agility*dt);if(p.intentVelocity){const desiredDir=p.intentVelocity.c.normalize(),desiredSpeed=p.intentVelocity.len(),jogSpeed=Math.min(desiredSpeed,p.jogSpeed),jogIsMoving=p.jogVel.lenSq()>EPSILON2;desiredSpeed>jogSpeed&&p.joltVel.copyFrom(desiredDir).scale(desiredSpeed-jogSpeed);const blendedDir=jogIsMoving?p.jogVel.c.normalize().lerp(desiredDir,desiredSpeed>jogSpeed?alpha:alpha*2).normalize():desiredDir;p.jogVel.copyFrom(blendedDir).scale(jogSpeed)}else if(p.intentTarget){const toTarget=p.targetPos.c.zeroY().sub(p.pos.c.zeroY()),dist2=toTarget.len(),desiredSpeed=Math.min(p.jogSpeed+p.joltSpeed,dist2/dt);let jogSpeed=Math.min(p.jogSpeed,dist2/dt);jogSpeed<.5&&p.intent!=="ruckTap"&&p.intent!=="mark"&&p.intent!=="spoil"&&p.intent!=="contestAnyway"&&(jogSpeed=0);const desiredDir=toTarget.normalize(),blendedDir=p.jogVel.lenSq()>EPSILON2?p.jogVel.c.normalize().lerp(desiredDir,alpha).normalize():desiredDir;desiredSpeed>jogSpeed&&p.joltVel.copyFrom(desiredDir).scale(desiredSpeed-jogSpeed),p.jogVel.copyFrom(blendedDir).scale(jogSpeed)}else p.jogVel.lerp(v3(0,0,0),alpha),p.joltVel.setFrom(0,0,0);p.joltVel.len()>0?(p.energy>0&&(p.energy-=dt),p.energy<=0&&(p.energy=0,p.joltVel.scale(.5))):p.energy=Math.min(p.energy+dt,p.statsEnergy),p.applyPhysics(dt,g)}},jump={transitions:{mark:(p,g)=>p.intent==="jumpMark"&&g.ball.catchCollidesWith(p),spoil:(p,g)=>p.intent==="jumpSpoil"&&g.ball.catchCollidesWith(p),ruckTap:(p,g)=>p.intent==="jumpRuckTap"&&g.ball.catchCollidesWith(p),run:(p,g)=>p.pos[1]<=p.floorY},update:(dt,g,p,transition)=>{if(transition&&p.pos[1]<=p.floorY&&["jumpMark","jumpSpoil","jumpRuckTap"].includes(p.intent)){if(p.intentVelocity!==null){const desiredVel=p.intentVelocity.len(),desiredDir=p.intentVelocity.c.normalize();desiredVel>p.jogSpeed?(p.jogVel.copyFrom(desiredDir.c.scale(p.jogSpeed)),p.joltVel.copyFrom(desiredDir.c.scale(desiredVel-p.jogSpeed))):p.jogVel.copyFrom(p.intentVelocity)}p.vel[1]=p.statsJump}p.applyPhysics(dt,g)}},mark={transitions:{run:(p,g)=>p.stateTimer>.05&&p.pos[1]<=0,jump:(p,g)=>p.stateTimer>.05&&p.pos[1]>0},update:(dt,g,p,transition)=>{transition&&catchOrTapBall(p,g),p.applyPhysics(dt,g)}},spoil={transitions:{run:(p,g)=>p.stateTimer>.05&&p.pos[1]<=0,jump:(p,g)=>p.stateTimer>.05&&p.pos[1]>0},update:(dt,g,p,transition)=>{transition&&catchOrTapBall(p,g),p.applyPhysics(dt,g)}},ruckTap={transitions:{run:(p,g)=>p.stateTimer>.05&&p.pos[1]<=0,jump:(p,g)=>p.stateTimer>.05&&p.pos[1]>0},update:(dt,g,p,transition)=>{transition&&catchOrTapBall(p,g),p.applyPhysics(dt,g)}},standingMark={transitions:{run:(p,g)=>!g.setPiece||p.intent==="runCarry"&&len(p.jogVel)>.5},update:(dt,g,p)=>{p.jogVel.setFrom(0,0,0),p.applyPhysics(dt,g)}},kick={transitions:{run:(p,g)=>p.stateTimer>.3},update:(dt,g,p,transition)=>{transition&&p.intentTarget&&p.kickBall(g,p.targetPos),p.applyPhysics(dt,g)}},handball={transitions:{run:(p,g)=>p.stateTimer>.4},update:(dt,g,p,transition)=>{transition&&p.handpassBall(g,p.intentTarget),p.applyPhysics(dt,g)}},pickUp={transitions:{run:(p,g)=>p.stateTimer>.2},update:(dt,g,p,transition)=>{transition&&!g.ball.carried&&catchOrTapBall(p,g),p.applyPhysics(dt,g)}},tackled={transitions:{kick:(p,g)=>p.intent==="kickToTarget"&&g.ball.carrier===p,handball:(p,g)=>p.intent==="handball"&&g.ball.carrier===p,tackleSpill:(p,g)=>Math.random()<g.dt,run:(p,g)=>p.stateTimer>1},update:(dt,g,p)=>{if(p.jogVel.normalize().scale(.5*p.jogSpeed),p.stateTimer>.5){const tackler=findClosestOpponent(p,g.players,g.ball.pos.c);g.banner.commentary("HOLDING THE BALL!",(tackler==null?void 0:tackler.team)??null),tackler&&(g.setPiece=new FreeKickSetPiece(g,tackler,g.ball.pos.c))}p.applyPhysics(dt,g)}},tackleSpill={transitions:{run:(p,g)=>p.stateTimer>.4},update:(dt,g,p,transition)=>{if(transition){const dir=p.jogVel.c.normalize();g.ball.launch(dir,p.jogSpeed+p.joltSpeed,null),g.ball.lastTouchedBy=p}p.jogVel.normalize().scale(.5*p.jogSpeed),p.applyPhysics(dt,g)}},tackleAssist={transitions:{run:(p,g)=>p.stateTimer>.4},update:(dt,g,p)=>{p.jogVel.setFrom(0,0,0),p.applyPhysics(dt,g)}},tackle={transitions:{run:(p,g)=>p.stateTimer>.4},update:(dt,g,p,transition)=>{g.ball.carrier&&p.jogVel.copyFrom(p.pos.c.dirTo(g.ball.carrier.pos).scale(.5*p.jogSpeed)),p.applyPhysics(dt,g)}},tackledGround={transitions:{run:(p,g)=>p.stateTimer>.4},update:(dt,g,p)=>{p.jogVel.setFrom(0,0,0),p.applyPhysics(dt,g)}},bounce={transitions:{run:(p,g)=>p.stateTimer>.4},update:(dt,g,p)=>{p.jogVel.setFrom(0,0,0),p.applyPhysics(dt,g)}},actionStateMachine={idle,run,jump,mark,bump,ruckTap,spoil,standingMark,kick,block,pickUp,tackle,tackleSpill,tackleAssist,tackled,tackledGround,bounce,handball};function collidesCylindrical(a2,b){const[aw,ah]=a2.collideBounds(),[bw,bh]=b.collideBounds(),dx=a2.pos[0]-b.pos[0],dz=a2.pos[2]-b.pos[2],horizDistSq=dx*dx+dz*dz,ra=.5*aw,rb=.5*bw,combinedR=ra+rb,aBottom=a2.pos[1],aTop=a2.pos[1]+ah,bBottom=b.pos[1],bTop=b.pos[1]+bh,verticalOverlap=aBottom<bTop&&aTop>bBottom;return horizDistSq<=combinedR*combinedR&&verticalOverlap}function getIntentWeightBias(intent){switch(intent){case"mark":return 1.3;case"block":return 1.4;case"spoil":return 1.1;case"shepherd":return 1.25;case"contestAnyway":return 1;case"crumb":return .7;case"hangBack":return .5;default:return 1}}class Entity{constructor(pos){this.pos=v3(pos[0],pos[1],pos[2]),this.vel=v3(0,0,0),this.width=1.6,this.height=2.4,this.usesGravity=!0,this.gravity=v3(0,-9.8,0),this.bounce=0,this.floorY=0}update(dt,game){this.pos.scaleAndAdd(this.vel,dt),this.usesGravity&&this.pos[1]>this.floorY&&this.vel.scaleAndAdd(this.gravity,dt),this.pos[1]<this.floorY&&(this.pos[1]=this.floorY,Math.abs(this.vel[1])>.5?this.vel[1]=-this.vel[1]*this.bounce:this.vel[1]=0)}render(renderer){renderer.renderSprite(this.pos,this.width,this.height,1,0)}collidesWith(e){return collidesCylindrical(this,e)}collideBounds(){return[.5,1.8]}}const playerAnimationSets=Object.freeze({home:Object.freeze({idle:[[0,0,0]],run:[[1,0,0],[2,0,0],[3,0,0],[4,0,0],[5,0,0],[6,0,0]],kickRightFoot:[[1,0,0],[2,0,0]],kickLeftFoot:[[4,0,0],[5,0,0]],handpassRightHand:[[1,0,0],[0,0,0]],handpassLeftHand:[[4,0,0],[0,0,0]],jumpMark:[[1,0,0],[2,0,0],[0,0,0]],jumpSpoil:[[1,0,0],[2,0,0],[0,0,0]]}),away:Object.freeze({idle:[[0,4,0]],run:[[1,4,0],[2,4,0],[3,4,0],[4,4,0],[5,4,0],[6,4,0]],kickRightFoot:[[1,4,0],[2,4,0]],kickLeftFoot:[[4,4,0],[5,4,0]],handpassRightHand:[[1,4,0],[0,4,0]],handpassLeftHand:[[4,4,0],[0,4,0]],jumpMark:[[1,4,0],[2,4,0],[0,4,0]],jumpSpoil:[[1,4,0],[2,4,0],[0,4,0]]})}),teams=Object.freeze({0:"Carlton",1:"West Coast",2:"Sydney",3:"Brisbane",4:"West Melbourne",5:"Collingwood",6:"Hawthorne",7:"Geelong",8:"Adelaide",9:"Fremantle",10:"Western Sydney",11:"Port Adelaide",12:"Melbourne",13:"Saint Kilda",14:"North Melbourne",15:"Essendon",16:"Richmond",17:"Gold Coast"}),teamAbbrevs=Object.freeze({0:"CRL",1:"WCO",2:"SYD",3:"BRS",4:"WME",5:"COL",6:"HAW",7:"GEL",8:"ADL",9:"FRM",10:"WSY",11:"PAD",12:"MEL",13:"STK",14:"NME",15:"ESS",16:"RCH",17:"GCO"}),personAnimationSets=Object.freeze({ruddy:{front:[0,12,0],back:[0,13,0],headCount:4,bodyRowOffset:9},pasty:{front:[0,14,0],back:[0,15,0],headCount:3,bodyRowOffset:10},swarthy:{front:[0,16,0],back:[0,17,0],headCount:3,bodyRowOffset:11}}),uniformAnimationSets=Object.freeze({home:{front:[0,5,0],back:[0,6,0]},away:{front:[0,7,0],back:[0,8,0]}}),bodyAnimationSets=Object.freeze({idle:[[0,0,0]],run:[[1,0,0],[2,0,0],[3,0,0],[4,0,0],[5,0,0],[6,0,0]],kickRightFoot:[[1,0,0],[2,0,0]],kickLeftFoot:[[4,0,0],[5,0,0]],handpassRightHand:[[1,0,0],[0,0,0]],handpassLeftHand:[[4,0,0],[0,0,0]],jumpMark:[[1,0,0],[2,0,0],[0,0,0]],jumpSpoil:[[1,0,0],[2,0,0],[0,0,0]]});class Player extends Entity{constructor(name,team,teamId,pos,playing=!1){super(pos),this.intent="idle",this.intentTarget=null,this.intentVelocity=null,this.positionPos=Vec3.fromArray(pos),this.teamId=teamId,this.complexion=choose(["ruddy","pasty","swarthy"]),this.faceId=getRandomInt(personAnimationSets[this.complexion].headCount),this.name=name,this.team=team,this.playing=playing,this.build=["FF","FB","CHF","CHB","Ruck"].includes(name)?"big":"small",this.width=1.6,this.height=2.4,this.jogVel=v3(0,0,0),this.joltVel=v3(0,0,0),this.energy=10,this.statsEnergy=10,this.statsWeight=(this.build==="big"?85:75)+Math.random()*10,this.statsStrength=(this.build==="big"?60:40)+Math.random()*30,this.statsSpeed=(this.build==="big"?6:8)+Math.random()*3,this.jogSpeed=5,this.joltSpeed=this.statsSpeed-5,this.statsHeight=(this.build==="big"?1.8:1.6)+Math.random()*.5,this.name==="Ruck"&&this.statsHeight<1.9&&(this.statsHeight=1.9+Math.random()*.2),this.statsJump=5,this.statsKickRange=45,(this.name==="CHF"||this.name==="CHB"||this.name==="FB")&&(this.statsKickRange=50+Math.random()*10),this.name==="FF"&&(this.statsKickRange=50+Math.random()*5),this.statsHandpassRange=25,this.statsAgility=5,this.joltDecayRate=8,this.animations=playerAnimationSets[team]??playerAnimationSets.home,this.animState="idle",this.actionState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=8,this.stateTimer=0,this.animSprite=[[0,0,0]],this.label=Label.a({hints:{h:.04,w:.1},align:"center"})}get targetPos(){const target=this.intentTarget===null?this.pos.c:this.intentTarget;return"pos"in target?target.pos.c:target}get stunned(){return this.actionState==="tackle"||this.actionState==="tackled"}collideBounds(){return[.8,this.statsHeight]}getEffectiveCollisionRadius(){return this.intent==="shepherd"||this.intent==="block"?.8*1.4:this.intent==="crumb"||this.intent==="hangBack"?.8*.8:.8}tryTackle(game){const ball=game.ball;for(const other of game.players){if(other===this||!ball.carried||ball.carrier!==other||other.team===this.team||!this.collidesWith(other)||other.actionState==="tackleSpill"||other.intent==="freeKick")continue;const toTarget=other.pos.c.sub(this.pos);toTarget[1]=0,toTarget.normalize();const EPSILON2=1e-8,facing=this.jogVel.c;if(facing[1]=0,facing.len()<EPSILON2||facing.c.normalize().dot(toTarget)>.1){const target=other;return this.stateTimer=1,this.actionState="tackle",this.intent="tackle",this.intentTarget=target,this.joltVel.setFrom(0,0,0),target.joltVel.setFrom(0,0,0),target.actionState="tackleSpill",target.stateTimer=.5,target.intent="tackled",target.intentTarget=this,"tackle"}}return null}applyPhysics(dt,game){const prevVy=this.vel[1];this.vel.copyFrom(this.jogVel).add(this.joltVel),this.vel[1]=prevVy,this.pos[1]<=this.floorY&&this.joltVel.scale(Math.exp(-this.joltDecayRate*dt)),super.update(dt,game),this.checkPlayerCollisions(dt,game)}kickBall(game,target){const ball=game.ball;if(!ball.carried||ball.carrier!==this)return;let aimXZ;if(target){const d=("pos"in target?target.pos:target).c.sub(this.pos);aimXZ=v2(d[0],d[2])}else aimXZ=v2(this.vel[0]||0,this.vel[2]||(this.team==="home"?-1:1));aimXZ.len()>this.statsKickRange&&aimXZ.normalize().scale(this.statsKickRange);const vel=computeKickVelocity(this,applyKickInaccuracy(aimXZ),!1);if(!vel)return;const speed=vel.len();if(speed<.001)return;const dir=vel.c.normalize();ball.launch(dir,speed,"kick")}handpassBall(game,target){var _a;const ball=game.ball;if(!ball.carried||ball.carrier!==this)return;let aimXZ;if(target){const d=("pos"in target?target.pos:target).c.sub(this.pos);aimXZ=v2(d[0],d[2])}else aimXZ=v2(this.vel[0]||0,this.vel[2]||(this.team==="home"?-1:1));aimXZ.len()>this.statsHandpassRange&&aimXZ.normalize().scale(this.statsHandpassRange);const loft=(_a=this.intentVelocity)==null?void 0:_a[1],vel=computeKickVelocity(this,aimXZ,!0,loft);if(!vel)return;const speed=vel.len();if(speed<.001)return;const dir=vel.c.normalize();ball.launch(dir,speed,"handball")}update(dt,game){this.oldPos=this.pos.c;const oldActionState=this.actionState;let newActionState=null;const stateDef=actionStateMachine[oldActionState],transitions=stateDef==null?void 0:stateDef.transitions;if(transitions){for(const[target,condition]of Object.entries(transitions))if(condition(this,game)){newActionState=target;break}}const stateToUse=newActionState??oldActionState,transition=stateToUse!==oldActionState;transition?this.stateTimer=0:this.stateTimer+=dt;let setPieceBlocked=!1;if(game.setPiece&&(setPieceBlocked=game.setPiece.enforce(this,dt)),!setPieceBlocked){const handler=actionStateMachine[stateToUse];handler!=null&&handler.update&&handler.update(dt,game,this,transition)}this.updateAnimation(dt,newActionState,game.ball),this.updateAim(game),newActionState!==null&&(this.actionState=newActionState),(Number.isNaN(this.pos[0])||Number.isNaN(this.pos[2]))&&this.pos}updateAim(game){if(this===game.player){const controls=game.controls,aimTarget=controls.state.aimTarget;if(this.actionState==="run"&&game.ball.carrier===this&&controls.state.kickHeldTime>0){const aim=fromValues(0,0);if(aimTarget&&add(aim,aim,aimTarget),aimTarget){const ratio=Math.hypot(aimTarget[0],aimTarget[1])/this.statsKickRange;game.aimTarget.tint=ratio>=.8?[1,0,0,1]:[1,1,1,1]}else game.aimTarget.tint=[1,1,1,1];game.aimTarget.setPosition([this.pos[0]+aim[0],.02,this.pos[2]+aim[1]+.8])}else game.player===this&&(game.aimTarget.setPosition(v3(this.pos[0],.02,this.pos[2]+.8)),game.aimTarget.tint=[1,1,1,1])}}updateAnimation(dt,stateTriggered,ball){const sequence=this.animations[this.animState];if(sequence.length===0)return;this.animTimer+=dt;const frameDuration=1/this.animFPS;this.animTimer>=frameDuration&&(this.animTimer-=frameDuration,this.animFrame=this.animFrame+1),stateTriggered==="kick"&&(this.animState="kickRightFoot",this.animFrame=0,this.animTimer=0),this.vel[1]>.1&&this.animState!=="jumpMark"&&(this.animState="jumpMark",this.animFrame=0,this.animTimer=0),this.animState==="jumpMark"&&this.pos[1]<=this.floorY+.01&&this.vel[1]<=0&&(this.animState=this.vel.len()>.1?"run":"idle",this.animFrame=0,this.animTimer=0),this.animState==="run"&&this.vel.len()===0&&(this.animState="idle",this.animFrame=0,this.animTimer=0),this.animState==="idle"&&this.vel.len()!==0&&(this.animState="run",this.animFrame=0,this.animTimer=0);const loop=this.animState==="run"||this.animState==="idle";this.animFrame>=sequence.length&&(this.animFrame=loop?0:sequence.length-1,loop||(this.animState="run",this.animFrame=0,this.animTimer=0));const uniformFrame=uniformAnimationSets.home.back.slice();uniformFrame[0]+=this.teamId,this.team==="away"&&(uniformFrame[1]+=2);const headFrame=personAnimationSets[this.complexion].back.slice();headFrame[0]+=this.faceId;const bodyFrame=bodyAnimationSets[this.animState][this.animFrame].slice()??[0,0,0];bodyFrame[1]+=personAnimationSets[this.complexion].bodyRowOffset;const Z_THRESHOLD=.15;(this.jogVel[2]>Z_THRESHOLD?"away":this.jogVel[2]<-Z_THRESHOLD?"home":this.pos[2]<ball.pos[2]?"away":"home")==="away"&&(bodyFrame[0]+=7,uniformFrame[1]-=1,headFrame[1]-=1),this.animSprite=[uniformFrame,headFrame,bodyFrame]}render(renderer){const zFudge=v3(0,.005,.01);let s=1;for(let[col,row,flags]of this.animSprite)renderer.renderSprite(this.pos.c.scaleAndAdd(zFudge,s),this.width,this.height,col,row),s++;{const gl=renderer.gl;gl.useProgram(renderer.program),gl.bindVertexArray(renderer.quadVao),gl.uniform4f(renderer.uTint,1,1,1,1),gl.uniform4f(renderer.uTint,1,1,1,1);const[col,row]=[2,3];renderer.setTileUV(col,row),gl.uniform1i(renderer.uTilingU,0),gl.uniform1i(renderer.uTilingV,0);const model=create$2();translate(model,model,[this.pos[0],.015,this.pos[2]]),rotateX(model,model,-Math.PI/2),scale(model,model,[2,2,1]),gl.uniformMatrix4fv(renderer.uModel,!1,model),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)}}checkPlayerCollisions(dt,game){if(this.intent==="freeKick")return;const ball=game.ball;for(const other of game.players){if(other===this||!other.playing||other.intent==="freeKick"||this.actionState==="tackle"&&this.intentTarget===other||this.actionState==="tackleSpill"&&this.intentTarget===other||other.actionState==="tackle"&&other.intentTarget===this||other.actionState==="tackleSpill"&&other.intentTarget===this||this.pos.dist(ball.pos)>50&&other.pos.dist(ball.pos)>50)continue;const offset=this.pos.c.sub(other.pos);offset[1]=0;const len2=offset.len(),overlap=(.8+.8)/2-len2;if(overlap<=0)continue;len2<1e-4?(offset[0]=Math.random()-.5,offset[2]=Math.random()-.5,offset.normalize()):offset.scale(1/len2);const w1=this.statsWeight*getIntentWeightBias(this.intent),w2=other.statsWeight*getIntentWeightBias(other.intent),total=w1+w2,push=offset.c.scale(overlap),pushThis=push.c.scale(w2/total),pushOther=push.c.scale(w1/total);this.pos[0]+=pushThis[0],this.pos[2]+=pushThis[2],other.pos[0]-=pushOther[0],other.pos[2]-=pushOther[2]}}}class Ball extends Entity{constructor(pos){super(pos),this.carried=!1,this.origin=v3(0,0,0),this.carrier=null,this.width=1.6,this.height=2.4,this.bounce=.5,this.animations=Object.freeze({idle:[[0,1,0]],backSpin:[[1,1,0],[2,1,0],[3,1,0],[4,1,0],[5,1,0],[6,1,0],[7,1,0],[8,1,0]],forwardSpin:[[8,1,0],[7,1,0],[6,1,0],[5,1,0],[4,1,0],[3,1,0],[2,1,0],[1,1,0]],backSpinRight:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]],backSpinLeft:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinRight:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinLeft:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]]}),this.animState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=12,this.lastTouchedBy=null,this.lastTouchedType=null,this.lastTouchedAt=null,this.hasBounced=!1}update(dt,game){if(this.carried&&this.carrier){const carrier=this.carrier,dirZ=carrier.vel[2]>0?1:carrier.vel[2]<0||carrier.team==="home"?-1:1,offset=v3(0,.5,.2*dirZ);this.pos.copyFrom(this.carrier.pos).add(offset),this.origin.copyFrom(this.pos)}else{const falling=this.vel[1]<0;super.update(dt,game);const newBounce=falling&&this.vel[1]>0&&this.pos[1]<=this.floorY;this.hasBounced=this.hasBounced||newBounce,newBounce&&this.vel.scale(.9),this.pos[1]<=this.floorY&&(this.vel.scale(.97),this.origin.copyFrom(this.pos))}this.updateAnimation(dt)}collideBounds(){return[.4,.5]}catchCollidesWith(player){if(this.lastTouchedBy===player&&!this.hasBounced)return!1;const[pw,ph]=player.collideBounds(),[bw,bh]=this.collideBounds(),dx=this.pos[0]-player.pos[0],dz=this.pos[2]-player.pos[2],horiz=dx*dx+dz*dz,radius=.5*pw+.5*bw+.2,ballTop=this.pos[1]+bh,ballBottom=this.pos[1],playerReach=player.pos[1]+ph+.4,verticalOverlap=ballBottom<=playerReach&&ballTop>=player.pos[1];return player.name,horiz<=radius*radius,horiz<=radius*radius&&verticalOverlap}pickup(carrier,pickupHeight=0){this.carried=!0,this.carrier=carrier,this.lastTouchedBy=carrier,this.lastTouchedType=null,this.lastTouchedAt=null,this.hasBounced=!1;const dirZ=carrier.vel[2]>0?1:carrier.vel[2]<0||carrier.team==="home"?-1:1;this.pos.copyFrom(carrier.pos).add(v3(0,pickupHeight,dirZ*.2)),this.origin.copyFrom(this.pos),this.vel.setFrom(0,0,0)}launch(direction,speed,type="kick"){this.carried=!1,this.carrier=null,this.vel.copyFrom(direction).scale(speed),this.lastTouchedType=type,this.lastTouchedAt=this.pos.c,this.hasBounced=!1}updateAnimation(dt){this.animTimer+=dt;const frameDuration=1/this.animFPS;this.animTimer>=frameDuration&&(this.animTimer-=frameDuration,this.animFrame=this.animFrame+1);const prevState=this.animState;this.carried?this.animState="idle":this.lastTouchedType==="kick"&&!this.hasBounced?this.animState=this.vel[2]<0?"backSpin":"forwardSpin":this.lastTouchedType==="handball"&&!this.hasBounced?this.animState=this.vel[2]<0?"backSpinRight":"forwardSpinLeft":this.hasBounced?Math.abs(this.vel[1])<.05&&this.pos[1]<=this.floorY+.01?this.animState="idle":this.animState=this.vel[2]<0?"forwardSpin":"backSpin":this.animState="idle",this.animState!==prevState&&(this.animFrame=0,this.animTimer=0);const sequence=this.animations[this.animState];sequence.length!==0&&this.animFrame>=sequence.length&&(this.animFrame=0)}render(renderer){var _a;const sequence=(_a=this.animations)==null?void 0:_a[this.animState],[col,row,flags]=(sequence==null?void 0:sequence[this.animFrame])??[0,1,void 0];renderer.renderSprite(this.pos,this.width,this.height,col,row);{const gl=renderer.gl;gl.useProgram(renderer.program),gl.bindVertexArray(renderer.quadVao);const[col2,row2]=[2,3];renderer.setTileUV(col2,row2),gl.uniform1i(renderer.uTilingU,0),gl.uniform1i(renderer.uTilingV,0);const model=create$2();translate(model,model,[this.pos[0],.01,this.pos[2]]),rotateX(model,model,-Math.PI/2),scale(model,model,[2,2,1]),gl.uniformMatrix4fv(renderer.uModel,!1,model),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)}}}class AimTarget{constructor(pos=[0,.001,0]){this.pos=Vec3.fromArray(pos),this.size=2,this.spriteCoord=[4,3],this.tint=[.5,.25,1,1]}setPosition(newPos){this.pos[0]=newPos[0],this.pos[2]=newPos[2]}render(renderer){const gl=renderer.gl;gl.useProgram(renderer.program),gl.bindVertexArray(renderer.quadVao);const[col,row]=this.spriteCoord;renderer.setTileUV(col,row),gl.uniform1i(renderer.uTilingU,0),gl.uniform1i(renderer.uTilingV,0),gl.uniform4f(renderer.uTint,this.tint[0],this.tint[1],this.tint[2],this.tint[3]);const model=create$2();translate(model,model,[this.pos[0],.02,this.pos[2]]),rotateX(model,model,-Math.PI/2),scale(model,model,[this.size,this.size,1]),gl.uniformMatrix4fv(renderer.uModel,!1,model),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)}}var _InputManager_instances,onTouchStart_fn,onTouchMove_fn,onTouchEnd_fn;class InputManager{constructor(canvas){__privateAdd(this,_InputManager_instances);this.state={moveX:0,moveZ:0,kickPressed:!1,kickReleased:!1,kickAimActive:!1,quickDisposePressed:!1,switchPressed:!1,menuPressed:!1,kickHeldTime:0,aimTarget:null},this.keyMoveUp="w",this.keyMoveLeft="a",this.keyMoveDown="s",this.keyMoveRight="d",this.keyKick="k",this.keyQuick="j",this.keySwitch=" ";const keyControlData=localStorage.getItem("footy/keybinds");keyControlData?(this.keyControls=JSON.parse(keyControlData),this.keyMoveUp=this.keyControls.keyMoveUp,this.keyMoveLeft=this.keyControls.keyMoveLeft,this.keyMoveDown=this.keyControls.keyMoveDown,this.keyMoveRight=this.keyControls.keyMoveRight,this.keyMoveKick=this.keyControls.keyMoveKick,this.keyMoveSwitch=this.keyControls.keyMoveSwitch):this.keyControls={keyMoveUp:this.keyMoveUp,keyMoveLeft:this.keyMoveLeft,keyMoveDown:this.keyMoveDown,keyMoveRight:this.keyMoveRight,keyMoveKick:this.keyMoveKick,keyMoveSwitch:this.keyMoveSwitch},this.keys={},this.lastKeys={},this.touchMove=null,this.touchAim=null,this.gamepadAimActive=!1,this.lastGpButtons={},this.kPressTime=0,this.gamepadActive=!1,canvas.addEventListener("touchstart",__privateMethod(this,_InputManager_instances,onTouchStart_fn).bind(this),{passive:!1}),canvas.addEventListener("touchmove",__privateMethod(this,_InputManager_instances,onTouchMove_fn).bind(this),{passive:!1}),canvas.addEventListener("touchend",__privateMethod(this,_InputManager_instances,onTouchEnd_fn).bind(this)),window.addEventListener("keydown",e=>{e.key,this.keys[e.key.toLowerCase()]=!0}),window.addEventListener("keyup",e=>this.keys[e.key.toLowerCase()]=!1)}endUpdate(){this.state.kickAimActive||(this.state.aimTarget=null),this.state.moveX=0,this.state.moveZ=0,this.state.kickPressed=!1,this.state.kickReleased=!1,this.state.menuPressed=!1,this.state.quickDisposePressed=!1,this.state.switchPressed=!1}update(dt){var _a,_b,_c;const kDown=!!this.keys[this.keyKick],kPrev=!!this.lastKeys[this.keyKick];if(this.state.quickDisposePressed=this.keys[this.keyQuick]&&!this.lastKeys[this.keyQuick],this.state.switchPressed=this.keys[this.keySwitch]&&!this.lastKeys[this.keySwitch],this.state.menuPressed=this.keys.escape&&!this.lastKeys.escape,kDown&&!kPrev&&(this.state.kickPressed=!0,this.kPressTime=0,this.state.aimTarget=[0,-10],this.state.kickAimActive=!0),kDown?(this.kPressTime+=dt,this.state.aimTarget&&(this.keys[this.keyMoveLeft]&&(this.state.aimTarget[0]-=30*dt),this.keys[this.keyMoveRight]&&(this.state.aimTarget[0]+=30*dt),this.keys[this.keyMoveUp]&&(this.state.aimTarget[1]-=60*dt),this.keys[this.keyMoveDown]&&(this.state.aimTarget[1]+=60*dt))):(this.keys[this.keyMoveLeft]&&(this.state.moveX-=1),this.keys[this.keyMoveRight]&&(this.state.moveX+=1),this.keys[this.keyMoveUp]&&(this.state.moveZ-=1),this.keys[this.keyMoveDown]&&(this.state.moveZ+=1)),!kDown&&kPrev&&(this.state.kickReleased=!0,this.state.kickAimActive=!1),this.state.kickHeldTime=this.kPressTime,this.touchMove&&(this.state.moveX=this.touchMove.dx,this.state.moveZ=this.touchMove.dy,this.touchMove.finished&&(Math.abs(this.touchMove.dx)<.01&&Math.abs(this.touchMove.dy)<.01&&(this.state.switchPressed=!0),this.touchMove=null)),this.touchAim){this.kPressTime+=dt;const dx=this.touchAim.dx,dz=this.touchAim.dy,magZ=100,magX=100;this.state.aimTarget=[-dx*magZ,-dz*magX],this.state.kickHeldTime=this.kPressTime,this.touchAim.finished&&(this.touchAim,Math.abs(this.touchAim.dx)<.01&&Math.abs(this.touchAim.dy)<.01&&this.state.kickHeldTime<.5?this.state.quickDisposePressed=!0:(this.state.kickReleased=!0,this.state.kickAimActive=!1),this.touchAim=null)}let gp=(_a=navigator.getGamepads)==null?void 0:_a.call(navigator)[0];if(gp&&(Math.abs(gp.axes[0])>.1||Math.abs(gp.axes[1])>.1||Math.abs(gp.axes[2])>.1||Math.abs(gp.axes[3])>.1)&&(this.gamepadActive=!0),gp&&this.gamepadActive){this.state.moveX+=Math.abs(gp.axes[0])>.1?gp.axes[0]:0,this.state.moveZ+=Math.abs(gp.axes[1])>.1?gp.axes[1]:0,this.state.switchPressed=((_b=gp.buttons[4])==null?void 0:_b.pressed)&&!this.lastGpButtons[4].pressed,this.state.quickDisposePressed=((_c=gp.buttons[5])==null?void 0:_c.pressed)&&!this.lastGpButtons[5].pressed;const aimX=gp.axes[2]||0,aimZ=gp.axes[3]||0,aimMag=Math.max(Math.hypot(aimX,aimZ),1e-4);this.gamepadAimActive?(this.kPressTime+=dt,this.state.kickHeldTime+=this.kPressTime,aimZ>.025?this.state.aimTarget&&(this.state.aimTarget=[this.state.aimTarget[0]-aimX/aimMag,this.state.aimTarget[1]-aimZ/aimMag]):(this.state.kickReleased=!0,this.state.kickAimActive=!1,this.gamepadAimActive=!1)):aimZ>.1&&(this.state.aimTarget=[0,0],this.kPressTime=0,this.state.kickHeldTime=this.kPressTime,this.state.kickPressed=!0,this.gamepadAimActive=!0,this.state.kickAimActive=!0),this.lastGpButtons=gp.buttons.slice()}this.lastKeys={...this.keys}}getState(){return this.state}}_InputManager_instances=new WeakSet,onTouchStart_fn=function(e){e.preventDefault();for(const t of e.changedTouches)t.clientX<window.innerWidth/2?this.touchMove={id:t.identifier,startX:t.clientX,startY:t.clientY,dx:0,dy:0,finsihed:!1}:(this.touchAim={id:t.identifier,startX:t.clientX,startY:t.clientY,dx:0,dy:0,finished:!1},this.state.kickPressed=!0,this.kPressTime=0)},onTouchMove_fn=function(e){e.preventDefault();for(const t of e.changedTouches)this.touchMove&&t.identifier===this.touchMove.id&&(this.touchMove.dx=(t.clientX-this.touchMove.startX)/window.innerWidth,this.touchMove.dy=(t.clientY-this.touchMove.startY)/window.innerHeight),this.touchAim&&t.identifier===this.touchAim.id&&(this.touchAim.dx=(t.clientX-this.touchAim.startX)/window.innerWidth,this.touchAim.dy=(t.clientY-this.touchAim.startY)/window.innerHeight,this.state.kickAimActive=!0)},onTouchEnd_fn=function(e){e.preventDefault();for(const t of e.changedTouches)this.touchAim&&t.identifier===this.touchAim.id&&(this.touchAim.finished=!0),this.touchMove&&t.identifier===this.touchMove.id&&(this.touchMove.finished=!0)};function splitmix64(seed){let state=BigInt(seed)&0xFFFFFFFFFFFFFFFFn;return function(){state=state+0x9E3779B97F4A7C15n&0xFFFFFFFFFFFFFFFFn;let z=state;return z=(z^z>>30n)*0xBF58476D1CE4E5B9n&0xFFFFFFFFFFFFFFFFn,z=(z^z>>27n)*0x94D049BB133111EBn&0xFFFFFFFFFFFFFFFFn,z=z^z>>31n,z}}class PRNG2{constructor(){__publicField(this,"_seed",0)}random(){return Math.random()}seed(seed){throw new Error("Seeding is not available in the default PRNG class. You can set another with `eskv.rand.setPRNG`.")}getRandomInt(m1,m2=0){return m2!=0?m1+Math.floor(this.random()*(m2-m1)):Math.floor(this.random()*m1)}getRandomPos(maxX,maxY){return[this.getRandomInt(maxX),this.getRandomInt(maxY)]}randomRange(min=0,max=1){return Math.floor(this.random()*(max-min+1))+min}randomFloat(min=0,max=1){return this.random()*(max-min)+min}shuffle(arr){let temp,r;for(let i=1;i<arr.length;i++)r=this.randomRange(0,i),temp=arr[i],arr[i]=arr[r],arr[r]=temp;return arr}choose(array){return array[Math.floor(this.random()*array.length)]}chooseN(arr,n){let result=new Array(n),len2=arr.length,taken=new Array(len2);if(n>len2)throw new RangeError("chooeN: more elements requested than available");for(;n--;){let x=Math.floor(this.random()*len2);result[n]=arr[x in taken?taken[x]:x],taken[x]=--len2 in taken?taken[len2]:len2}return result}}function sfc32(a2,b,c,d){return function(){a2>>>=0,b>>>=0,c>>>=0,d>>>=0;var t=a2+b|0;return a2=b^b>>>9,b=c+(c<<3)|0,c=c<<21|c>>>11,d=d+1|0,t=t+d|0,c=c+t|0,(t>>>0)/4294967296}}function mulberry32(a2){return function(){var t=a2+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function xoshiro128ss(a2,b,c,d){return function(){var t=b<<9,r=b*5;return r=(r<<7|r>>>25)*9,c^=a2,d^=b,b^=c,a2^=d,c^=t,d=d<<11|d>>>21,(r>>>0)/4294967296}}function jsf32(a2,b,c,d){return function(){a2|=0,b|=0,c|=0,d|=0;var t=a2-(b<<27|b>>>5)|0;return a2=b^(c<<17|c>>>15),b=c+d|0,c=d+t|0,d=a2+t|0,(d>>>0)/4294967296}}class PRNG_sfc322 extends PRNG2{constructor(){super(...arguments);__publicField(this,"_seed",1);__publicField(this,"d",3735928559);__publicField(this,"xorSeed",Math.floor(Date.now())^this.d);__publicField(this,"random",sfc32(2654435769,608135816,3084996962,this.xorSeed))}seed(seed){this._seed=seed,this.xorSeed=seed^this.d;const sm=splitmix64(this.xorSeed);this.random=sfc32(sm(),sm(),sm(),sm())}}class PRNG_mulberry322 extends PRNG2{constructor(){super(...arguments);__publicField(this,"_seed",1);__publicField(this,"d",3735928559);__publicField(this,"xorSeed",Math.floor(Date.now())^this.d);__publicField(this,"random",mulberry32(this.xorSeed))}seed(seed){this._seed=seed,this.xorSeed=seed^this.d,this.random=mulberry32(this.xorSeed)}}class PRNG_xoshiro128ss2 extends PRNG2{constructor(){super(...arguments);__publicField(this,"_seed",1);__publicField(this,"d",3735928559);__publicField(this,"xorSeed",Math.floor(Date.now())^this.d);__publicField(this,"random",xoshiro128ss(2654435769,608135816,3084996962,this.xorSeed))}seed(seed){this._seed=seed,this.xorSeed=seed^this.d;const sm=splitmix64(this.xorSeed);this.random=xoshiro128ss(sm(),sm(),sm(),sm())}}class PRNG_jsf322 extends PRNG2{constructor(){super(...arguments);__publicField(this,"_seed",1);__publicField(this,"d",3735928559);__publicField(this,"xorSeed",Math.floor(Date.now())^this.d);__publicField(this,"random",jsf32(2654435769,608135816,3084996962,this.xorSeed))}seed(seed){this._seed=seed,this.xorSeed=seed^this.d;const sm=splitmix64(this.xorSeed);this.random=jsf32(sm(),sm(),sm(),sm())}}var defaultPRNG=new PRNG_sfc322;function setPRNG(name){switch(name){case"Math.random":defaultPRNG=new PRNG2;return;case"sfc32":defaultPRNG=new PRNG_sfc322;return;case"mulberry32":defaultPRNG=new PRNG_mulberry322;return;case"xoshiro128ss":defaultPRNG=new PRNG_xoshiro128ss2;return;case"jsf32":defaultPRNG=new PRNG_jsf322;return;default:throw Error(`Unknown PRNG ${name}`)}}function setSeed(seed){return defaultPRNG.seed(seed)}function stringToSeed(str){let hash=5381;for(let i=0;i<str.length;i++)hash=(hash<<5)+hash+str.charCodeAt(i),hash=hash&4294967295;return hash>>>0}function ratePlayer(p){return p.statsStrength+p.statsSpeed+p.statsAgility+p.statsKickRange*.2+p.statsHandpassRange*.1+p.statsJump}function generateTeam(teamId,seed){setPRNG("mulberry32"),setSeed(seed);const positions=generateFieldPositions(),roster=[];for(const[name,pos]of Object.entries(positions))roster.push(new Player(name,"home",teamId,pos));const rating=roster.reduce((a2,p)=>a2+ratePlayer(p),0)/roster.length;return{id:teamId,name:teams[teamId],abbrev:teamAbbrevs[teamId],rating}}function generateAllTeams(){const baseSeed=Date.now(),teamData=[];for(let i=0;i<Object.keys(teams).length;i++){const seed=stringToSeed(`team-${i}-${baseSeed}`);teamData.push(generateTeam(i,seed))}return teamData.sort((a2,b)=>b.rating-a2.rating),teamData.forEach((t,i)=>{t.rank=i+1}),teamData}function createTop8Tournament(){const allTeams=generateAllTeams(),finalists=allTeams.slice(0,8),round0=[{home:finalists[0],away:finalists[3]},{home:finalists[1],away:finalists[2]},{home:finalists[4],away:finalists[7]},{home:finalists[5],away:finalists[6]}];return{allTeams,finalists,round:0,schedule:[round0]}}class FPS extends Label{constructor(){super(...arguments);__publicField(this,"_counter",0);__publicField(this,"_frames",0);__publicField(this,"_worst",300);__publicField(this,"_tref",Date.now());__publicField(this,"_badFrameCount",0)}update(app,millis){super.update(app,millis);const tref=app.now;this._counter+=tref-this._tref,this._frames+=1;const currentFPS=1e3/(tref-this._tref);this._tref=tref,this._badFrameCount+=currentFPS<50?1:0,currentFPS<this._worst&&(this._worst=currentFPS),this._counter>=1e3&&(this.text=`FPS: ${Math.round(this._frames/this._counter*1e3)} (worst: ${Math.round(this._worst)}, # >20ms: ${Math.round(this._badFrameCount)})`,this._counter=0,this._frames=0,this._worst=300,this._badFrameCount=0)}}class MenuButton extends BoxLayout{on_touch_down(event,object,touch){return this.collide(touch.rect)?(`${touch.rect}`,touch.grab(this),this.bgColor="rgba(128,128,128,0.5)",!0):!1}on_touch_up(event,object,touch){return touch.grabbed===this?(touch.ungrab(),this.bgColor=null,this.collide(touch.rect)&&(`${touch.rect}`,Game.get().baseWidget.addChild(PauseMenu.a(PauseMenu.props)),Game.get().gameActive=!1),!0):!1}}class InGameBanner extends BoxLayout{constructor(){super(),this.game=Game.get(),this.labels={timer:Label.a({text:"20:00",align:"left",color:"white",sizeGroup:"bannerText"}),quarter:Label.a({text:"Q1",align:"left",color:"white",sizeGroup:"bannerText"}),home:Label.a({text:"H 0.0 (0)",align:"center",color:"white",sizeGroup:"bannerText"}),away:Label.a({text:"A 0.0 (0)",align:"center",color:"white",sizeGroup:"bannerText"}),commentary:Label.a({id:"commentary",wrap:!0,text:"",align:"center",hints:{w:1,h:"6"},alpha:1,timer:1e3,colorBase:[255,255,255]}).d("color",c=>`rgba(${c.colorBase[0]},${c.colorBase[1]},${c.colorBase[2]},${c.alpha})`)},this.labels.commentary.listen("text",(e,o,v)=>{if(v!==""){const wa=new WidgetAnimation;o.alpha=1,wa.add({alpha:1},o.timer),wa.add({alpha:0},1e3),wa.start(o)}}),this.menuButton=MenuButton.a({hints:{w:1,h:1}}),this.centerWidget=BoxLayout.a({orientation:"vertical",hints:{w:.5}}),this.centerWidget.children=[this.menuButton],this.menuButton.children=[this.labels.commentary],this.topRow=BoxLayout.a({orientation:"horizontal",paddingX:.05,bgColor:"#0008"}),this.topRow.children=[this.labels.quarter,this.labels.timer,this.centerWidget,this.labels.home,this.labels.away],this.children=[this.topRow],this.homeName="A",this.awayName="B",this.homeGoal=0,this.homeBehind=0,this.awayGoal=0,this.awayBehind=0,this.quarter=0,this.timeLeft=0,this.updateHome(),this.updateAway(),this.updateTimer(),this.updateLayout()}commentary(text,team=null,time=1e3){this.labels.commentary.timer=time;const base="rgba(255,255,255,1)";this.labels.commentary.color=base,this.labels.commentary.text=text}updateLayout(){this.game.aspectRatio>1?(this.children=[this.topRow],this.menuButton.children=[this.labels.commentary],this.centerWidget.hints.w=.5,this.hints.h="6"):(this.menuButton.children=[],this.centerWidget.hints.w=.1,this.children=[this.topRow,this.labels.commentary],this.hints.h="12")}on_homeName(event,object,value){this.updateHome()}on_awayName(event,object,value){this.updateAway()}on_homeGoal(event,obj,value){this.updateHome()}on_homeBehind(event,obj,value){this.updateHome()}on_awayGoal(event,obj,value){this.updateAway()}on_awayBehind(event,obj,value){this.updateAway()}on_timeLeft(_,__,value){this.updateTimer()}on_quarter(_,__,value){this.updateTimer()}updateHome(){this.labels.home.text=`${this.homeName} ${this.homeGoal}.${this.homeBehind} (${this.homeGoal*6+this.homeBehind})`}updateAway(){this.labels.away.text=`${this.awayName} ${this.awayGoal}.${this.awayBehind} (${this.awayGoal*6+this.awayBehind})`}updateTimer(){const min=Math.floor(this.timeLeft/60).toString().padStart(2,"0"),sec=Math.floor(this.timeLeft%60).toString().padStart(2,"0");this.labels.timer.text=`${min}:${sec}`,this.labels.quarter.text=`Q${this.quarter}`}resetScores(){this.homeGoal=0,this.homeBehind=0,this.awayGoal=0,this.awayBehind=0}getData(){return{home:{g:this.homeGoal,b:this.homeBehind,t:this.homeGoal*6+this.homeBehind},away:{g:this.awayGoal,b:this.awayBehind,t:this.awayGoal*6+this.awayBehind}}}update(app,millis){super.update(app,millis),app.now}}__publicField(InGameBanner,"props",Object.freeze({orientation:"vertical",hints:{x:0,y:0,w:1,h:"6"}}));class ScoreBoard extends BoxLayout{constructor(){super(),this.game=Game.get(),this.labels={homeName:Label.a({text:"0",align:"left",color:"white"}),homeGoals:Label.a({text:"0",align:"center",color:"white"}),homeBehinds:Label.a({text:"0",align:"center",color:"white"}),homeTotal:Label.a({text:"0",align:"center",color:"white"}),awayName:Label.a({text:"0",align:"left",color:"white"}),awayGoals:Label.a({text:"0",align:"center",color:"white"}),awayBehinds:Label.a({text:"0",align:"center",color:"white"}),awayTotal:Label.a({text:"0",align:"center",color:"white"})};const grid=GridLayout.a({numX:4});grid.children=[Label.a({text:"",align:"left",color:"white"}),Label.a({text:"G",align:"center",color:"white"}),Label.a({text:"B",align:"center",color:"white"}),Label.a({text:"T",align:"center",color:"white"}),this.labels.homeName,this.labels.homeGoals,this.labels.homeBehinds,this.labels.homeTotal,this.labels.awayName,this.labels.awayGoals,this.labels.awayBehinds,this.labels.awayTotal],this.children=[grid],this.homeName="A",this.awayName="B",this.homeGoal=0,this.homeBehind=0,this.awayGoal=0,this.awayBehind=0}on_homeName(event,object,value){this.labels.homeName.text=value}on_awayName(event,object,value){this.labels.awayName.text=value}on_homeGoal(event,obj,value){this.labels.homeGoals.text=value.toString(),this.labels.homeTotal.text=(value*6+this.homeBehind).toString()}on_homeBehind(event,obj,value){this.labels.homeBehinds.text=value.toString(),this.labels.homeTotal.text=(this.homeGoal*6+value).toString()}on_awayGoal(event,obj,value){this.labels.awayGoals.text=value.toString(),this.labels.awayTotal.text=(value*6+this.awayBehind).toString()}on_awayBehind(event,obj,value){this.labels.awayBehinds.text=value.toString(),this.labels.awayTotal.text=(this.awayGoal*6+value).toString()}resetScores(){this.homeGoal=0,this.homeBehind=0,this.awayGoal=0,this.awayBehind=0}getData(){return{home:{g:this.homeGoal,b:this.homeBehind,t:this.homeGoal*6+this.homeBehind},away:{g:this.awayGoal,b:this.awayBehind,t:this.awayGoal*6+this.awayBehind}}}populateFromBanner(banner){this.homeName=banner.homeName,this.awayName=banner.awayName,this.homeGoal=banner.homeGoal,this.homeBehind=banner.homeBehind,this.awayGoal=banner.awayGoal,this.awayBehind=banner.awayBehind}}__publicField(ScoreBoard,"props",Object.freeze({orientation:"horizontal",hints:{x:.02,y:.02,w:.5,h:.14},bgColor:"#0008"}));class PauseMenu extends BoxLayout{constructor(){super(),this.game=Game.get(),this.game.gameActive=!1,this.children=[Label.a({text:"Pie Break",color:"rgba(192, 50, 50, 1)",hints:{h:.5}}),Button.a({text:"Continue",sizeGroup:"menuButton",hints:{w:.8}}).listen("press",()=>this.continue()),Button.a({text:"Exit to menu",sizeGroup:"menuButton",hints:{w:.8}}).listen("press",()=>this.exitToMenu())]}continue(){this.parent&&(this.game.gameActive=!0,this.parent.children=this.parent.children.filter(w=>w!==this))}exitToMenu(){this.parent&&this.game.endGame()}}__publicField(PauseMenu,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,y:.2,w:.4,h:.4},bgColor:"rgba(0,0,0,0.5)",outlineColor:"rgba(255,255,255,1)"}));class EndQuarterMenu extends BoxLayout{constructor(){super(),this.game=Game.get(),this.game.gameActive=!1,this.game.scoreBoard.hints={w:.9},this.game.scoreBoard.populateFromBanner(this.game.banner);const q=this.game.banner.quarter,text=`End of ${["1st","2nd","3rd","Game"][q-1]??"Game"}${q<4?" Quarter":""}`,buttonText=q<4?"Next Quarter":"Main Menu";this.children=[Label.a({text,color:"rgba(192, 50, 50, 1)",hints:{h:.2}}),this.game.scoreBoard,Button.a({text:buttonText,sizeGroup:"menuButton",hints:{h:.15}}).listen("press",()=>this.next())]}next(){this.parent&&(this.game.banner.quarter>=4?this.game.endGame():(this.parent.children=this.parent.children.filter(w=>w!==this),this.game.banner.quarter+=1,this.game.banner.timeLeft=this.game.quarterTime,this.game.setPiece=new CenterBounceSetPiece(this.game),this.game.gameActive=!0))}}__publicField(EndQuarterMenu,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.2,y:.25,w:.6,h:.6},bgColor:"rgba(0,0,0,0.5)",outlineColor:"rgba(255,255,255,1)"}));class MainMenu extends BoxLayout{constructor(){super(),this.game=Game.get(),this.game.gameActive=!1,this.children=[Label.a({text:"The Footy",color:"rgba(192, 50, 50, 1)",hints:{h:.3}}),Button.a({text:"Training",sizeGroup:"menuButton",hints:{w:.8}}).listen("press",()=>this.openTraining()),Button.a({text:"Quick Play",sizeGroup:"menuButton",hints:{w:.8}}).listen("press",()=>this.openQuickPlay()),Button.a({text:"Tournament",sizeGroup:"menuButton",hints:{w:.8}}).listen("press",()=>this.openTournament()),Button.a({text:"Career",sizeGroup:"menuButton",hints:{w:.8}}).listen("press",()=>this.openCareer()),Button.a({text:"Options",sizeGroup:"menuButton",hints:{w:.8}}).listen("press",()=>this.openOptions())]}openTraining(){this.parent&&(this.parent.addChild(a(TrainingMenu,TrainingMenu.props)),this.parent.children=this.parent.children.filter(w=>w!==this))}openQuickPlay(){this.parent&&(this.parent.addChild(a(QuickPlayMenu,QuickPlayMenu.props)),this.parent.children=this.parent.children.filter(w=>w!==this))}openTournament(){this.parent&&(this.parent.addChild(a(TournamentMenu,TournamentMenu.props)),this.parent.children=this.parent.children.filter(w=>w!==this))}openCareer(){this.parent&&(this.parent.addChild(a(CareerMenu,CareerMenu.props)),this.parent.children=this.parent.children.filter(w=>w!==this))}openOptions(){this.parent&&(this.parent.addChild(a(OptionsMenu,OptionsMenu.props)),this.parent.children=this.parent.children.filter(w=>w!==this))}}__publicField(MainMenu,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,y:.2,w:.4,h:.6},bgColor:"rgba(0,0,0,0.5)",outlineColor:"rgba(255,255,255,1)"}));class TrainingMenu extends BoxLayout{constructor(){super(),this.game=Game.get();const[home,away]=this.game.randomMatchup();this.home=home,this.away=away,this.quarterTime=5,this.children=[Label.a({text:"Training",color:"rgba(192, 50, 50, 1)",hints:{h:.3}}),Button.a({text:"Kicking",sizeGroup:"menuButton"}).listen("press",()=>this.startKicking()),Button.a({text:"Handpass",sizeGroup:"menuButton"}).listen("press",()=>this.startHandpass()),Button.a({text:"Back",sizeGroup:"menuButton"}).listen("press",()=>this.goBack())],this.updateProperties({})}startKicking(){this.parent&&(this.game.gameActive=!0,this.parent.children=this.parent.children.filter(w=>w!==this),this.game.banner.commentary(`HOLD K THEN W/A/S/D
TO AIM KICK DOWNFIELD`,null,5e3),this.game.setupTraining(this.home,this.away,this.quarterTime,"kicking"))}startHandpass(){this.parent&&(this.game.gameActive=!0,this.game.banner.commentary(`RUN WITH W/A/S/D
TAP J TO HANDPASS IN THAT DIR`,null,5e3),this.parent.children=this.parent.children.filter(w=>w!==this),this.game.setupTraining(this.home,this.away,this.quarterTime,"handpass"))}goBack(){this.parent&&(this.parent.addChild(MainMenu.a(MainMenu.props)),this.parent.children=this.parent.children.filter(w=>w!==this))}}__publicField(TrainingMenu,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,y:.2,w:.4,h:.5},bgColor:"rgba(0,0,0,0.5)",outlineColor:"rgba(255,255,255,1)"}));class QuickPlayMenu extends BoxLayout{constructor(){super(),this.game=Game.get(),this.timeButton=Button.a({text:"Quarters:",sizeGroup:"menuButton"}).listen("press",()=>this.nextQuarterTime()),this.homeButton=Button.a({text:"Home:",sizeGroup:"menuButton"}).listen("press",()=>this.nextHomeTeam()),this.awayButton=Button.a({text:"Away:",sizeGroup:"menuButton"}).listen("press",()=>this.nextAwayTeam());const[home,away]=this.game.randomMatchup();this.home=home,this.away=away,this.quarterTime=5,this.children=[Label.a({text:"Quick Play Setup",color:"rgba(192, 50, 50, 1)",hints:{h:.3}}),this.timeButton,this.homeButton,this.awayButton,Button.a({text:"Randomize Matchup",sizeGroup:"menuButton"}).listen("press",()=>this.randomizeMatchup()),Button.a({text:"Start Game",sizeGroup:"menuButton"}).listen("press",()=>this.startGame()),Button.a({text:"Back",sizeGroup:"menuButton"}).listen("press",()=>this.goBack())],this.updateProperties({})}randomizeMatchup(){[this.home,this.away]=this.game.randomMatchup()}nextHomeTeam(){this.home=(this.home+1)%18}nextAwayTeam(){this.away=(this.away+1)%18}nextQuarterTime(){this.quarterTime<=1?this.quarterTime=2:this.quarterTime<=2?this.quarterTime=5:this.quarterTime<=5?this.quarterTime=10:this.quarterTime<=10?this.quarterTime=20:this.quarterTime<=20&&(this.quarterTime=1)}on_home(e,o,v){this.homeButton.text="Home: "+teamAbbrevs[this.home]}on_away(e,o,v){this.awayButton.text="Away: "+teamAbbrevs[this.away]}on_quarterTime(e,o,v){this.timeButton.text="Quarters: "+this.quarterTime+" min."}startGame(){this.parent&&(this.game.gameActive=!0,this.parent.children=this.parent.children.filter(w=>w!==this),this.game.setupGame(this.home,this.away,this.quarterTime))}goBack(){this.parent&&(this.parent.addChild(MainMenu.a(MainMenu.props)),this.parent.children=this.parent.children.filter(w=>w!==this))}}__publicField(QuickPlayMenu,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,y:.2,w:.4,h:.6},bgColor:"rgba(0,0,0,0.5)",outlineColor:"rgba(255,255,255,1)"}));class TournamentMenu extends BoxLayout{constructor(){super(),this.game=Game.get(),this.game.tournament||(this.game.tournament=createTop8Tournament());const matchLabels=this.game.tournament.schedule[this.game.tournament.round].map(m=>Label.a({text:`${m.home.rank}. ${m.home.abbrev} vs ${m.away.rank}. ${m.away.abbrev}`}));this.children=[Label.a({text:"Top 8 Finals",color:"rgba(192, 50, 50, 1)",hints:{h:.2}}),...matchLabels,Button.a({text:"Begin Tournament",sizeGroup:"menuButton"}).listen("press",()=>this.startTournament()),Button.a({text:"Back"}).listen("press",()=>this.goBack())],this.updateProperties({})}startTournament(){if(this.parent){const match=this.game.tournament.schedule[this.game.tournament.round][0];this.parent.children=this.parent.children.filter(w=>w!==this),this.game.setupGame(match.home.id,match.away.id,5)}}goBack(){this.parent&&(this.parent.addChild(MainMenu.a(MainMenu.props)),this.parent.children=this.parent.children.filter(w=>w!==this))}}__publicField(TournamentMenu,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,y:.2,w:.4,h:.6},bgColor:"rgba(0,0,0,0.5)",outlineColor:"rgba(255,255,255,1)"}));class CareerMenu extends BoxLayout{constructor(){super(),this.game=Game.get(),this.children=[Label.a({text:"Career Mode",color:"rgba(192, 50, 50, 1)",hints:{h:.3}}),Button.a({text:"Manage Team",disable:!0}),Button.a({text:"Facilities",disable:!0}),Button.a({text:"Start Season",disable:!0}).listen("press",()=>this.startSeason()),Button.a({text:"Back"}).listen("press",()=>this.goBack())],this.updateProperties({})}startSeason(){this.parent&&(this.game.gameActive=!0,this.parent.children=this.parent.children.filter(w=>w!==this))}goBack(){this.parent&&(this.parent.addChild(MainMenu.a(MainMenu.props)),this.parent.children=this.parent.children.filter(w=>w!==this))}}__publicField(CareerMenu,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,y:.2,w:.4,h:.6},bgColor:"rgba(0,0,0,0.5)",outlineColor:"rgba(255,255,255,1)"}));class OptionsMenu extends BoxLayout{constructor(){super(),this.game=App.get(),this.children=[Label.a({text:"Options"}),Button.a({text:"Audio"}),Button.a({text:"Graphics"}),Button.a({text:"Back"}).listen("press",()=>this.goBack())]}goBack(){this.parent&&(this.parent.addChild(MainMenu.a(MainMenu.props)),this.parent.children=this.parent.children.filter(w=>w!==this))}}__publicField(OptionsMenu,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,y:.2,w:.4,h:.6},bgColor:"rgba(0,0,0,0.5)",outlineColor:"rgba(255,255,255,1)"}));function makeCtx(game){const ball=game.ball,carrier=ball.carrier??null,home=game.homePlayers.filter(p=>p.playing),away=game.awayPlayers.filter(p=>p.playing),ballPos=carrier?carrier.pos:ball.pos,distToBall=new Map;for(const p of game.players)distToBall.set(p,p.pos.dist(ballPos));const closestOn=team=>team.reduce((b,p)=>b==null||distToBall.get(p)<distToBall.get(b)?p:b,null);return{game,ball,carrier,home,away,ballPos,distToBall,closestHome:closestOn(home),closestAway:closestOn(away)}}function decideIntents(game){for(const p of game.players)p.playing&&(p.intentTarget=null,p.intentVelocity=null);const ctx=makeCtx(game);if(game.setPiece instanceof FreeKickSetPiece)return decideIntentsFreeKick(game.setPiece,ctx);if(game.setPiece instanceof CenterBounceSetPiece)return decideIntentsCenterBounce(game.setPiece);if(game.setPiece instanceof BoundaryThrowInSetPiece)return decideIntentsBoundaryThrowIn(game.setPiece);if(ctx.carrier){const mates=ctx.carrier.team==="home"?ctx.home:ctx.away,opps=ctx.carrier.team==="home"?ctx.away:ctx.home;return decideIntentsCarry(ctx.carrier,mates,opps,ctx)}return game.currentContest?decideIntentsAerialContest(ctx):decideIntentsGroundContest(ctx)}function greedyMarkAssign(defenders,attackers){const usedDefs=new Set,usedAtts=new Set,pairs=[],pool=[];for(const d of defenders)for(const a2 of attackers)pool.push({d:d.pos.dist(a2.pos),def:d,att:a2});pool.sort((A,B)=>A.d-B.d);for(const e of pool)usedDefs.has(e.def)||usedAtts.has(e.att)||(usedDefs.add(e.def),usedAtts.add(e.att),pairs.push([e.def,e.att]));return pairs}function decideIntentsCarry(carrier,teammates,opponents,ctx){var _a,_b,_c;const{game,distToBall}=ctx;if(carrier===game.player){const state2=game.controls.state,aim=state2.aimTarget?carrier.pos.c.add(Vec3.fromArrayXZ(state2.aimTarget)):null;if(state2.quickDisposePressed){carrier.intentVelocity=null;const[,target]=findDisposalTarget(game,carrier,teammates,opponents,v3(state2.moveX,0,state2.moveZ),!0);carrier.intent="handball",carrier.intentTarget=target??null}else if(aim&&(state2.kickReleased||aim.dist(carrier.pos)>=carrier.statsKickRange))carrier.intent="kickToTarget",carrier.intentTarget=aim,carrier.intentVelocity=null;else{const moveVec=v3(state2.moveX,0,state2.moveZ);moveVec.lenSq()>.01?(carrier.intent="runCarry",carrier.intentVelocity=moveVec.normalize().scale(carrier.jogSpeed+carrier.joltSpeed)):(carrier.intent="holdBall",carrier.intentVelocity=((_a=carrier.jogVel)==null?void 0:_a.c)??null)}}else if(!opponents.some(o=>o.pos.dist(carrier.pos)<5)&&carrier.pos.dist(goals[carrier.team])>carrier.statsKickRange-10){carrier.intent="runCarry";const dir=findSafeRunDirection(carrier,game);dir&&(carrier.intentVelocity=dir.scale(carrier.jogSpeed+carrier.joltSpeed))}else{carrier.intentVelocity=null;const[intent,target]=findDisposalTarget(game,carrier,teammates,opponents);carrier.intent=intent,carrier.intentTarget=target??null}const inFrontMates=teammates.filter(p=>isInLeadRange(p,ctx.ballPos)),behindMates=teammates.filter(p=>!inFrontMates.includes(p));for(const m of teammates){if(m===carrier)continue;m.pos.dist(carrier.pos)<12&&(shouldClearOut(m,game)||!isInLeadRange(m,ctx.ballPos))&&(m.intent="pushBack",m.intentTarget=m.positionPos.c)}const leadCandidates=inFrontMates.filter(m=>m!==carrier&&shouldLeadNow(m,game));setLeadingDirs(leadCandidates,opponents,game);const leadSet=new Set(leadCandidates);for(const m of inFrontMates)m===carrier||leadSet.has(m)||(m.pos.dist(carrier.pos)<20?(m.intent="supportRun",m.intentTarget=carrier.pos.c.add([m.pos[0]<carrier.pos[0]?-5:5,0,0])):m.intent||(m.intent="idle",m.intentTarget=null));for(const m of behindMates)m!==carrier&&(shouldReturnToPosition(m,game)?(m.intent="pushBack",m.intentTarget=m.positionPos.c):m.intent||(m.intent="idle",m.intentTarget=null));const tacklers=opponents.filter(o=>o.pos.dist(carrier.pos)<25&&inFront(o,carrier.pos)).sort((a2,b)=>distToBall.get(a2)-distToBall.get(b)).slice(0,2);for(const d of tacklers)d.intent="contestAnyway",d.intentTarget=carrier;if(isFrontHalf(carrier)&&inKickRangeOfGoal(carrier)){const defs=opponents;if(!defs.some(p=>p.intent==="dropDeep")){const ownGoal=goals[((_b=opponents[0])==null?void 0:_b.team)??"away"],pick=defs.reduce((best,p)=>!best||p.pos.dist(ownGoal)<best.pos.dist(ownGoal)?p:best,null);pick&&!tacklers.includes(pick)&&(pick.intent="dropDeep",pick.intentTarget=ownGoal.c.add(ownGoal.c.sub([0,FIELD_LENGTH$1/2,0]).normalize().scale(6)))}}const attackAhead=[carrier,...inFrontMates],freeDefs=opponents.filter(d=>!tacklers.includes(d)),pairs=greedyMarkAssign(freeDefs,attackAhead),markedDefs=new Set(pairs.map(([d])=>d));for(const[def,att]of pairs)def.intent="markUp",def.intentTarget=att;for(const d of freeDefs){if(markedDefs.has(d))continue;d.intent="fillSpace";const dirGoal=goals[d.team].c.sub(d.positionPos).zeroY().normalize();d.intentTarget=d.positionPos.c.scaleAndAdd(dirGoal,10)}const player=game.player,state=game.controls.state;if(player&&player!==carrier&&(state.moveX!==0||state.moveZ!==0)){player.intent="contestAnyway";const moveVec=v3(state.moveX,0,state.moveZ);moveVec.lenSq()>.01?player.intentVelocity=moveVec.normalize().scale(player.jogSpeed+player.joltSpeed):player.intentVelocity=((_c=player.jogVel)==null?void 0:_c.c)??null}}function decideIntentsFreeKick(setPiece,ctx){var _a;const{game}=ctx,{kicker,defender,markPos}=setPiece,teammates=game.teammatesOf(kicker),opponents=game.opponentsOf(kicker);defender&&(defender.intent="standMark",defender.intentTarget=markPos),kicker.intent="freeKick";const goalZ=kicker.team==="home"?0:FIELD_LENGTH$1,goalDir=v3(0,0,goalZ).sub(markPos).zeroY().normalize();if(setPiece.state==="backup")kicker.intentVelocity=setPiece.backupPos.c.dirFrom(kicker.pos).scale(kicker.jogSpeed),setPiece.backupPos.dist(kicker.pos)<.1&&(setPiece.state="turn");else if(setPiece.state==="turn"){kicker.intentVelocity=null;const desiredPos=setPiece.markPos.c.scaleAndAdd(goalDir,-14);kicker.intentTarget=desiredPos.dist(kicker.pos)>=.1?desiredPos:null,kicker.intentTarget===null&&(setPiece.state="kick")}else if(setPiece.state==="kick"&&kicker!==game.player){kicker.intent="kickToTarget",kicker.intentVelocity=null;const[intent,target]=findDisposalTarget(game,kicker,teammates,opponents,v3(0,0,-1));target&&(kicker.intent=intent,kicker.intentTarget=target)}if(kicker===game.player&&game.controls){const state=game.controls.state,aim=state.aimTarget?kicker.pos.c.add(Vec3.fromArrayXZ(state.aimTarget)):null;if(state.quickDisposePressed){kicker.intentVelocity=null;const[,target]=findDisposalTarget(game,kicker,teammates,opponents,v3(state.moveX,0,state.moveZ),!0);kicker.intent="handball",kicker.intentTarget=target??null}else if(aim&&(state.kickReleased||aim.dist(kicker.pos)>=kicker.statsKickRange))kicker.intent="kickToTarget",kicker.intentTarget=aim,kicker.intentVelocity=null;else if(state.moveX!==0||state.moveZ!==0||state.kickAimActive){const moveVec=v3(state.moveX,0,state.moveZ);kicker.intent="freeKick",moveVec.lenSq()>.01?kicker.intentVelocity=moveVec.normalize().scale(kicker.jogSpeed+kicker.joltSpeed):state.kickAimActive?(setPiece.state,kicker.intentVelocity=goalDir.scale(kicker.jogSpeed)):kicker.intentVelocity=((_a=kicker.jogVel)==null?void 0:_a.c)??null}}const attackersAhead=teammates.filter(a2=>a2!==kicker&&a2.playing).filter(a2=>a2.pos.c.sub(markPos).zeroY().dot(goals[kicker.team].c.sub(markPos).zeroY())>0),leadCandidatesFk=attackersAhead.filter(m=>shouldLeadNow(m,game));setLeadingDirs(leadCandidatesFk,opponents,game);const leadSetFk=new Set(leadCandidatesFk);for(const m of teammates){if(m===kicker)continue;const ahead=attackersAhead.includes(m),nearMark=m.positionPos.dist(markPos)<15;if(!leadSetFk.has(m))if(ahead)shouldClearOut(m,game),m.intent="pushBack",m.intentTarget=m.positionPos.c;else if(m.intent="pushBack",nearMark){const lateral=goalDir.rotateXZ(Math.random()<.5?Math.PI/2:-Math.PI/2);m.intentTarget=markPos.c.scaleAndAdd(lateral,15)}else m.intentTarget=m.positionPos.c}const otherDefs=opponents.filter(f=>f!==defender),pairs=greedyMarkAssign(otherDefs,attackersAhead),used=new Set(pairs.map(([d])=>d));for(const[d,a2]of pairs)d.intent="markUp",d.intentTarget=a2;const guardCandidates=otherDefs.filter(d=>!used.has(d)&&d.positionPos.dist(markPos)<20),guardCount=Math.min(2,Math.floor(Math.random()*3));for(const g of guardCandidates.slice(0,guardCount)){used.add(g),g.intent="fillSpace";const side=goalDir.rotateXZ(Math.random()<.5?Math.PI/2:-Math.PI/2),dist2=10+Math.random()*5;g.intentTarget=markPos.c.scaleAndAdd(side,dist2)}for(const d of otherDefs){if(used.has(d))continue;d.intent="fillSpace";const away=d.positionPos.c.sub(markPos).zeroY();away.len()<.001&&away.setFrom(Math.random()-.5,0,Math.random()-.5),d.intentTarget=markPos.c.scaleAndAdd(away.normalize(),20)}}function decideIntentsAerialContest(ctx){var _a,_b,_c;const{game,ball}=ctx,everyone=[...ctx.home,...ctx.away],ranks=[];for(const p of everyone){if(p.pos[1]>0||game.currentContest&&p.pos.dist(game.currentContest.point)>40)continue;const r=computeBestIntercept(p.pos.c,p.statsHeight+.3,p.statsJump,p.jogSpeed+p.joltSpeed,ball.pos,ball.vel,Math.abs(ball.gravity[1]),game.dt),airborne=r.mode==="apex"||r.mode==="subApex",t=r.time??p.pos.dist(ball.pos)/Math.max(p.jogSpeed+p.joltSpeed,1e-6);ranks.push({p,t,fallback:r.time===void 0,airborne,jump:!!r.jumpNow,vel:r.runVel??null,point:r.point?Vec3.fromArray(r.point):((_a=game.currentContest)==null?void 0:_a.point)??null,r})}if(ranks.sort((A,B)=>(A.airborne?1:A.fallback?100:10)*A.t-(B.airborne?1:B.fallback?100:10)*B.t),ball.lastTouchedType==="handball"&&Math.abs(ball.vel[1])<2&&ball.lastTouchedBy){const oppBest=ranks.filter(r=>r.p.team!==ball.lastTouchedBy.team).reduce((m,r)=>Math.min(m,r.t),1/0),landTimes=timeToGround(ball.pos,ball.vel,Math.abs(ball.gravity[1])),flightTime=landTimes.length?Math.max(...landTimes):0;for(const r of ranks){if(r.p.team!==ball.lastTouchedBy.team)continue;const maxT=Math.min(flightTime,oppBest-.05),speed=r.p.jogSpeed+r.p.joltSpeed;for(let t=maxT;t>=r.t;t-=.1){const pos=getPositionAtTime(ball.pos,ball.vel,ball.gravity,t);if(r.p.pos.dist(pos)<=speed*t){r.t=t,r.point=pos;break}}}ranks.sort((A,B)=>(A.airborne?1:A.fallback?100:10)*A.t-(B.airborne?1:B.fallback?100:10)*B.t)}if(ranks[0]){`${ranks[0].p.intent}${ranks[0].p.intentTarget}${ranks[0].p.intentVelocity}`;const first=ranks[0];first.p.intent=first.airborne?first.jump?"jumpMark":"mark":"contestAnyway",first.point&&(first.p.intentTarget=first.point),first.vel&&(first.p.intentVelocity=first.vel),`${ranks[0].p.name}${ranks[0].p.intent}${ranks[0].p.intentVelocity}${ranks[0].p.vel}`,ranks[0].p.jogSpeed+ranks[0].p.joltSpeed,`${ranks[0].jump}${ranks[0].p.pos.dist(ranks[0].point??v3(0,0,0))}${ranks[0].p.pos.dist(ball.pos)}${ranks[0].p.pos.c}`,ranks[0]}for(let second of ranks.slice(1)){if(second.p.team===ranks[0].p.team){second.p.intent="contestAnyway",second.p.intentTarget=second.point,second.vel&&(second.p.intentVelocity=second.vel);continue}second.p.intent=second.airborne?second.jump?"jumpSpoil":"spoil":"contestAnyway",second.point&&(second.p.intentTarget=second.point),second.vel&&(second.p.intentVelocity=second.vel);break}for(const r of ranks){const p=r.p;if(p.intent)continue;const landing=r.point??((_b=game.currentContest)==null?void 0:_b.point)??((_c=game.currentContest)==null?void 0:_c.point)??ball.pos,dist2=p.pos.dist(landing);if(dist2>25)continue;(p.team==="home"?ctx.home:ctx.away).some(t=>t!==p&&(t.intent==="mark"||t.intent==="jumpMark"))&&(dist2>3&&dist2<10?(p.intent="crumb",p.intentTarget=getCrumbSpot(p,landing)):(p.team==="home"?ctx.away:ctx.home).some(o=>o.pos.dist(landing)<3)&&(p.intent="block",p.intentTarget=landing))}for(const p of everyone){if(p.intent)continue;const foes=p.team==="home"?ctx.away:ctx.home,opp=findClosestOpponent$1(p,foes);opp&&p.pos.dist(opp.pos)<15?(p.intent="markUp",p.intentTarget=opp):(p.intent="fillSpace",p.intentTarget=p.positionPos.c)}}function decideIntentsGroundContest(ctx){var _a;const{game,ball}=ctx,sortedHome=ctx.home.slice().sort((a2,b)=>a2.pos.dist(ball.pos)/a2.statsSpeed-b.pos.dist(ball.pos)/b.statsSpeed),sortedAway=ctx.away.slice().sort((a2,b)=>a2.pos.dist(ball.pos)/a2.statsSpeed-b.pos.dist(ball.pos)/b.statsSpeed),sorted=[...sortedHome,...sortedAway];for(const p of sorted)p.intent="idle";sortedHome[0]&&(sortedHome[0].intent="gatherLoose",sortedHome[0].intentTarget=ball),sortedAway[0]&&(sortedAway[0].intent="gatherLoose",sortedAway[0].intentTarget=ball);for(const team of[sortedHome,sortedAway])for(const p of team.slice(1,3))p.pos.dist(ball.pos)<10&&(p.intent="supportRun",p.intentTarget=ball.pos.c.add([p.pos[0]<ball.pos[0]?-5:5,0,0]));for(const p of sorted){if(p.intent!=="idle")continue;const foes=p.team==="home"?ctx.away:ctx.home,opp=findClosestOpponent$1(p,foes);opp&&p.pos.dist(opp.pos)<14?(p.intent="markUp",p.intentTarget=opp):(p.intent="fillSpace",p.intentTarget=p.positionPos.c.lerp(ball.pos.c,.3))}const player=game.player,state=game.controls.state;if(player&&(state.moveX!==0||state.moveZ!==0)){const moveVec=v3(state.moveX,0,state.moveZ);moveVec.lenSq()>.01?player.intentVelocity=moveVec.normalize().scale(player.jogSpeed+player.joltSpeed):player.intentVelocity=((_a=player.jogVel)==null?void 0:_a.c)??null}}function decideIntentsCenterBounce(setPiece,ctx){var _a;const{homeRuck,awayRuck,game}=setPiece;for(let player of[homeRuck,awayRuck])if(setPiece.waitTimer<=0){const result=computeBestIntercept(player.pos.c,player.statsHeight+.3,player.statsJump,player.jogSpeed+player.joltSpeed,game.ball.pos,game.ball.vel,Math.abs(game.ball.gravity[1]),game.dt);player.intent=result.jumpNow||player.pos[1]>0?"jumpRuckTap":"ruckTap",player.intentVelocity=result.runVel??null,player.intentTarget=null}for(let player of[...homeRuck?game.teammatesOf(homeRuck):[],...awayRuck?game.teammatesOf(awayRuck):[]])if(player.intent==="crumb"){const state=game.controls.state;if(player===game.player&&(state.moveX!==0||state.moveZ!==0)){const moveVec=v3(state.moveX,0,state.moveZ);moveVec.lenSq()>.01?player.intentVelocity=moveVec.normalize().scale(player.jogSpeed+player.joltSpeed):player.intentVelocity=((_a=player.jogVel)==null?void 0:_a.c)??null}else{const assignment=setPiece.crumbAssignments.get(player);assignment&&(player.intentTarget=assignment.ruck.pos.c.add(assignment.offset))}}else player.intent="pushBack",player.intentTarget=player.positionPos.c}function decideIntentsBoundaryThrowIn(setPiece,ctx){const game=setPiece.game;for(let player of[setPiece.homeRuck,setPiece.awayRuck])if(player!==null&&setPiece.waitTimer<=0){const result=computeBestIntercept(player.pos.c,player.statsHeight+.3,player.statsJump,player.jogSpeed+player.joltSpeed,game.ball.pos,game.ball.vel,Math.abs(game.ball.gravity[1]),game.dt);player.intent=result.jumpNow||player.pos[1]>0?"jumpRuckTap":"ruckTap",player.intentVelocity=result.runVel??null,player.intentTarget=null}for(let player of[...game.teammatesOf(setPiece.homeRuck),...game.teammatesOf(setPiece.awayRuck)])if(player.intent==="crumb")if(player===game.player&&(game.controls.state.moveX!==0||game.controls.state.moveZ!==0)){const state=game.controls.state,moveVec=v3(state.moveX,0,state.moveZ);player.intent="crumb",player.intentVelocity=moveVec.normalize().scale(player.jogSpeed+player.joltSpeed)}else{const assignment=setPiece.crumbAssignments.get(player);assignment&&(player.intentTarget=assignment.ruck.pos.c.add(assignment.offset),game.currentContest&&player.intentTarget instanceof Vec3&&(player.intentVelocity=player.intentTarget.c.sub(player.pos).scale(1/(game.currentContest.time-game.now))))}else player.intent="pushBack",player.intentTarget=player.positionPos.c}App.rules.add("Label",{fontName:"Titillium Web"});App.rules.add("Button",{bgColor:"#222C",outlineColor:"#FFF8",color:"white",fontName:"Titillium Web",hints:{w:.8},sizeGroup:"menuButton"});class Game extends App{constructor(glCanvas,uiCanvas,spriteSheet){if(super(),this.glCanvas=glCanvas,this.uiCanvas=uiCanvas,this.gl=glCanvas.getContext("webgl2",{alpha:!1,preserveDrawingBuffer:!1}),!this.gl)throw new Error("WebGL2 not supported");this.prefDimH=-1,this.prefDimW=-1,this.tileSize=16,this.currentContest=null,this.now=Date.now(),this.prefDimH=-1,this.prefDimW=-1,this.canvasName="uicanvas",this.aspectRatio=window.innerWidth/window.innerHeight,this.banner=InGameBanner.a(InGameBanner.props),this.scoreBoard=ScoreBoard.a(ScoreBoard.props),this.continuousFrameUpdates=!0,this.renderer=new Renderer(this.gl,glCanvas,spriteSheet),this.controls=new InputManager(uiCanvas),this.setPiece=null,this.trainingSetPiece=null,this.entities=[],this.aimTarget=new AimTarget([5,.001,FIELD_LENGTH$1/2]),this.quarterTime=300,this.ball=new Ball(v3(0,0,FIELD_LENGTH$1/2)),this.entities.push(this.ball),this.players=[],this.homePlayers=[],this.awayPlayers=[],this.player=null,this.chasers=0,this.followers=0,this.homeId=0,this.awayId=1,this.closestPlayers={home:null,away:null},this.cameraTarget=v3(0,10,FIELD_LENGTH$1/2),this.cameraPos=v3(0,10,FIELD_LENGTH$1/2+15),this.renderer.fovy=45*Math.PI/180,this.resize(),window.addEventListener("resize",()=>this.resize()),this.lastTime=performance.now(),this.gameActive=!1,this.roamAngle=0,this.roamRadius=40,this.entities=[],this.aimTarget=new AimTarget([5,.001,FIELD_LENGTH$1/2]),this.ball=new Ball(v3(0,0,FIELD_LENGTH$1/2)),this.entities.push(this.ball),this.chasers=0,this.followers=0,this.tournament=null,this.dt=1/60,this.baseWidget.children=[MainMenu.a(MainMenu.props)]}teammates(team){return team==="home"?this.homePlayers:this.awayPlayers}teammatesOf(player){return player.team==="home"?this.homePlayers.filter(p=>p!==player):this.awayPlayers.filter(p=>p!==player)}opponentsOf(player){return player.team==="away"?this.homePlayers.slice():this.awayPlayers.slice()}static get(){if(!Game.appInstance)throw Error("Footy has not been initialized.");return Game.appInstance}randomMatchup(){setPRNG$1("mulberry32"),setSeed$1(stringToSeed$1(`DATE ${Date.now()}`));for(let i=0;i<1e3;++i)getRandomInt(20);const homeId=getRandomInt(18);let awayId=getRandomInt(18);for(;homeId===awayId;)awayId=getRandomInt(18);return[homeId,awayId]}setupGame(homeId,awayId,quarterTime){this.baseWidget.children=[this.banner,FPS.a({hints:{bottom:1,x:0,w:1,h:.05},align:"right"})],this.scoreBoard.hints={...ScoreBoard.props.hints},this.scoreBoard.resetScores(),(homeId===null||awayId===null)&&([homeId,awayId]=this.randomMatchup()),this.homeId=homeId,this.awayId=awayId,this.quarterTime=quarterTime?quarterTime*60:300,this.roamAngle=0,this.roamRadius=40,this.setPiece=null,this.trainingSetPiece=null,this.entities=[],this.aimTarget=new AimTarget([5,.001,FIELD_LENGTH$1/2]),this.ball=new Ball(v3(0,0,FIELD_LENGTH$1/2)),this.entities.push(this.ball),this.players=[],this.homePlayers=[],this.awayPlayers=[],this.player=null,this.chasers=0,this.followers=0;const homePositions=generateFieldPositions(),awayPositions=generateFieldPositions(!0),teamPositions=[[homePositions,"home",homeId],[awayPositions,"away",awayId]];for(let[positions,team,teamId]of teamPositions)for(const[name,pos]of Object.entries(positions)){const player=new Player(name,team,teamId,pos,!name.toLowerCase().startsWith("bench"));this.entities.push(player),this.players.push(player),player.playing&&(team==="home"?this.homePlayers.push(player):this.awayPlayers.push(player)),name==="RR"&&team==="home"&&(this.player=player)}this.banner.homeName=teamAbbrevs[homeId],this.banner.awayName=teamAbbrevs[awayId],this.banner.timeLeft=this.quarterTime,this.banner.quarter=1,this.banner.resetScores(),this.closestPlayers={home:null,away:null},this.currentContest=null,this.setPiece=new CenterBounceSetPiece(this),this.cameraTarget.setFrom(0,10,FIELD_LENGTH$1/2),this.gameActive=!0}setupTraining(homeId,awayId,quarterTime,trainingType="kicking"){if(this.baseWidget.children=[this.banner,FPS.a({hints:{bottom:1,x:0,w:1,h:.05},align:"right"})],this.scoreBoard.hints={...ScoreBoard.props.hints},this.scoreBoard.resetScores(),(homeId===null||awayId===null)&&([homeId,awayId]=this.randomMatchup()),this.homeId=homeId,this.awayId=awayId,this.quarterTime=quarterTime?quarterTime*60:300,this.roamAngle=0,this.roamRadius=40,this.setPiece=null,this.entities=[],this.aimTarget=new AimTarget([5,.001,FIELD_LENGTH$1]),this.ball=new Ball(v3(0,0,FIELD_LENGTH$1)),this.entities.push(this.ball),this.players=[],this.player=null,this.chasers=0,this.followers=0,trainingType==="kicking"){const player1=new Player("player1","home",homeId,v3(0,0,FIELD_LENGTH$1),!0),player2=new Player("player2","home",homeId,v3(0,0,FIELD_LENGTH$1*3/4),!0),player3=new Player("player3","home",homeId,v3(1,0,FIELD_LENGTH$1/2),!0),player4=new Player("player4","home",homeId,v3(1,0,FIELD_LENGTH$1/4),!0);this.players=[player1,player2,player3,player4],this.player=player1}else if(trainingType==="handpass"){const player1=new Player("player1","home",homeId,v3(0,0,FIELD_LENGTH$1*12/12),!0),player2=new Player("player2","home",homeId,v3(10,0,FIELD_LENGTH$1*11/12),!0),player3=new Player("player3","home",homeId,v3(20,0,FIELD_LENGTH$1*10/12),!0),player4=new Player("player4","home",homeId,v3(10,0,FIELD_LENGTH$1*9/12),!0),player5=new Player("player5","home",homeId,v3(0,0,FIELD_LENGTH$1*8/12),!0),player6=new Player("player6","home",homeId,v3(-10,0,FIELD_LENGTH$1*7/12),!0),player7=new Player("player7","home",homeId,v3(-20,0,FIELD_LENGTH$1*6/12),!0),player8=new Player("player8","home",homeId,v3(-10,0,FIELD_LENGTH$1*5/12),!0),player9=new Player("player9","home",homeId,v3(0,0,FIELD_LENGTH$1*4/12),!0),player10=new Player("player10","home",homeId,v3(10,0,FIELD_LENGTH$1*3/12),!0),player11=new Player("player11","home",homeId,v3(20,0,FIELD_LENGTH$1*2/12),!0),player12=new Player("player12","home",homeId,v3(10,0,FIELD_LENGTH$1*1/12),!0);this.players=[player1,player2,player3,player4,player5,player6,player7,player8,player9,player10,player11,player12],this.player=player1}this.homePlayers=[],this.awayPlayers=[];for(const p of this.players)p.positionPos.copyFrom(p.pos),this.entities.push(p),p.team==="home"&&this.homePlayers.push(p),p.team==="away"&&this.awayPlayers.push(p);this.banner.homeName=teamAbbrevs[homeId],this.banner.awayName=teamAbbrevs[awayId],this.banner.timeLeft=this.quarterTime,this.banner.quarter=1,this.scoreBoard.resetScores(),this.scoreBoard.homeName=this.banner.homeName,this.scoreBoard.awayName=this.banner.awayName,this.closestPlayers={home:null,away:null},this.currentContest=null,this.cameraTarget.setFrom(0,10,FIELD_LENGTH$1),this.trainingSetPiece=trainingType==="kicking"?new TrainingKicking(this):trainingType==="handpass"?new TrainingHandpass(this):null,this.gameActive=!0}update(){this._udpateActive=!0,this.now=Date.now();const dt0=(this.now-this.lastTime)/1e3,dt=Math.min(dt0,1/30);if(this.dt=dt,this.gameActive){this.controls.update(dt),this.updateBallContest(),this.updateClosestPlayers(),this.updatePlayerIntents();const before=this.ball.pos.c;for(const entity of this.entities)entity.update(dt,this);this.trainingSetPiece&&this.trainingSetPiece.update(dt),this.setPiece&&(this.setPiece.update(dt),this.setPiece.finished&&(this.setPiece=null)),this.checkTimeAndBoundary(dt,before),this.updateCamera(),this.updatePlayerControl(),this.renderer.renderScene(this,this.entities),this.controls.state.menuPressed&&(this.baseWidget.addChild(PauseMenu.a(PauseMenu.props)),this.gameActive=!1),this.controls.endUpdate()}else{{const t=this.now/5e4,flyX=Math.sin(t)*50,flyZ=FIELD_LENGTH$1/2+Math.sin(t*2)*50,lookAhead=4,lookX=Math.sin(t+lookAhead*.05)*50,lookZ=FIELD_LENGTH$1/2+Math.sin((t+lookAhead*.05)*2)*50;this.cameraPos.setFrom(flyX,10,flyZ),this.cameraTarget.setFrom(lookX,9,lookZ)}this.renderer.renderScene(this,[]),this.controls.update(dt),this.controls.state.menuPressed&&this.baseWidget.children.some(w=>w instanceof PauseMenu)&&(this.baseWidget.children=this.baseWidget.children.filter(w=>!(w instanceof PauseMenu)),this.gameActive=!0),this.controls.endUpdate()}super.update(),this.lastTime=this.now}endGame(showScore=!1){this.gameActive=!1,this.entities=[],this.players=[],this.setPiece=null,this.player=null,this.baseWidget.children=[showScore?a(EndQuarterMenu,EndQuarterMenu.props):MainMenu.a(MainMenu.props)]}checkTimeAndBoundary(dt,before){var _a,_b;if(this.banner.timeLeft-=dt,this.banner.timeLeft<=0){this.banner.timeLeft=0,this.gameActive=!1,this.baseWidget.addChild(a(EndQuarterMenu,EndQuarterMenu.props));return}if(!this.setPiece){let crossing=checkBoundaryCrossing(before,this.ball.pos);if(crossing!==null){if(crossing==="outOfBounds"&&this.ball.lastTouchedType==="kick"&&!this.ball.hasBounced&&this.ball.lastTouchedBy){const freeTeam=this.ball.lastTouchedBy.team==="home"?"away":"home";let kicker=null,minDist=1/0;for(const p of this.players)if(p.team===freeTeam&&p.playing){const d=p.pos.dist(this.ball.pos);d<minDist&&(minDist=d,kicker=p)}kicker&&(this.banner.commentary("OUT ON THE FULL",freeTeam),this.setPiece=new FreeKickSetPiece(this,kicker,this.ball.pos.c.zeroY()),crossing=null)}if(crossing==="goalAway"&&(this.ball.lastTouchedType!=="kick"||((_a=this.ball.lastTouchedBy)==null?void 0:_a.team)==="home")?(crossing="behindAway",this.banner.awayBehind+=1):crossing==="goalHome"&&(this.ball.lastTouchedType!=="kick"||((_b=this.ball.lastTouchedBy)==null?void 0:_b.team)==="away")?(crossing="behindHome",this.banner.homeBehind+=1):crossing==="innerLeftPostAway"||crossing==="innerRightPostAway"?(crossing="behindAway",this.banner.awayBehind+=1):(crossing==="innerLeftPostHome"||crossing==="innerRightPostHome")&&(crossing="behindHome",this.banner.homeBehind+=1),crossing==="behindAway"){this.banner.awayBehind+=1;const kicker=this.players.find(p=>p.name==="FB"&&p.team==="home");kicker&&(kicker.pos.copyFrom(goals.away),this.banner.commentary("BEHIND","away"),this.setPiece=new FreeKickSetPiece(this,kicker,v3(0,0,FIELD_LENGTH$1-15)));return}if(crossing==="behindHome"){this.banner.homeBehind+=1;const kicker=this.players.find(p=>p.name==="FB"&&p.team==="away");kicker&&(kicker.pos.copyFrom(goals.home),this.banner.commentary("BEHIND","home"),this.setPiece=new FreeKickSetPiece(this,kicker,v3(0,0,15)));return}if(crossing==="goalAway"||crossing==="goalHome"||crossing==="outOfBounds"){if(crossing==="goalAway"&&(this.banner.awayGoal+=1),crossing==="goalHome"&&(this.banner.homeGoal+=1),crossing==="goalAway"||crossing==="goalHome"){const team=crossing==="goalAway"?"away":"home";this.banner.commentary("GOAL!",team),this.setPiece=new CenterBounceSetPiece(this)}else crossing==="outOfBounds"&&(this.banner.commentary("OUT OF BOUNDS"),this.setPiece=new BoundaryThrowInSetPiece(this,this.ball.pos.c));return}if(this.ball.hasBounced&&isOutOfBounds(this.ball.pos))if(this.ball.lastTouchedBy!==null&&this.ball.lastTouchedType==="kick"){const team=this.ball.lastTouchedBy.team==="away"?"home":"away",kicker=this.closestPlayers[team];if(kicker!==null){const ballPos=boundaryIntersection((this.ball.lastTouchedAt??this.ball.pos).c);this.banner.commentary("FREE KICK",team),this.setPiece=new FreeKickSetPiece(this,kicker,Vec3.fromArray(ballPos))}}else{const ballPos=boundaryIntersection((this.ball.lastTouchedAt??this.ball.pos).c);this.banner.commentary("OUT OF BOUNDS"),this.setPiece=new BoundaryThrowInSetPiece(this,Vec3.fromArray(ballPos))}}}}updateClosestPlayers(){const ball=this.ball,closest={home:1/0,away:1/0},closestPlayers={home:null,away:null};for(let p of this.players){if(!p.playing||p===ball.carrier)continue;const candidate=p.pos.dist(ball.pos);candidate<closest[p.team]&&(closest[p.team]=candidate,closestPlayers[p.team]=p)}this.closestPlayers=closestPlayers}updatePlayerIntents(){decideIntents(this)}updateBallContest(){const ball=this.ball;if(!(!ball.carrier&&(ball.pos[1]>ball.floorY+.05||Math.abs(ball.vel[1])>.1))){this.currentContest=null;return}const gravity=ball.gravity[1]??-9.8,vy=ball.vel[1],y=ball.pos[1]-ball.floorY,a2=.5*gravity,b=vy,c=y;let tGround=0;const disc=b*b-4*a2*c;if(disc>=0&&Math.abs(a2)>1e-5){const sqrtD=Math.sqrt(disc),t1=(-b+sqrtD)/(2*a2),t2=(-b-sqrtD)/(2*a2);tGround=Math.max(t1,t2)}const landing=ball.pos.c.scaleAndAdd(ball.vel,tGround);landing[1]=ball.floorY,this.currentContest={point:landing,time:this.now+tGround,source:ball.lastTouchedBy??ball}}updatePlayerControl(){const homePlayers=this.homePlayers,carrier=this.ball.carrier;if(this.currentContest!==null)return;if(!carrier){if(Math.abs(this.controls.state.moveX)>0||Math.abs(this.controls.state.moveZ)>0)return;let best2=null,bestDistSq2=this.player?this.player.pos.distSq(this.ball.pos)-100:1/0;for(const p of homePlayers){if(p.actionState==="tackle"||p.intent==="ruckTap"||p.intent.startsWith("jump"))continue;const distSq=squaredDistance(p.pos,this.ball.pos),bias=(Math.abs(p.positionPos[0]-this.ball.pos[0])<10?-10:0)+(p.energy<.3?-5:0)+(p.pos[2]>this.ball.pos[2]?-10:0);distSq+bias<bestDistSq2&&(best2=p,bestDistSq2=distSq+bias)}best2&&best2!==this.player&&(this.player=best2);return}if(carrier.team==="home"){this.player!==carrier&&this.player!==null&&(this.player=carrier);return}let best=null,bestDistSq=1/0;for(const p of homePlayers){if(p.actionState==="tackle")continue;const distSq=squaredDistance(p.pos,carrier.pos),bias=(Math.abs(p.positionPos[0]-this.ball.pos[0])<10?-10:0)+(p.energy<.3?-5:0)+(p.pos[2]>carrier.pos[2]?-10:0);distSq+bias<bestDistSq&&(best=p,bestDistSq=distSq+bias)}best&&best!==this.player&&(this.player=best)}updateCamera(opts={}){var _a;const{baseHeight=10,pullback=25,heightAdjust=-5,pullbackAdjust=10,maxAspect=1.5,ndcBiasHome=.75,ndcBiasAway=0,lateralHeightAdjust=10,lateralPullbackAdjust=20,lateralFollowRatio=.5}=opts,ball=this.ball,carrier=ball.carrier,aspect=this.glCanvas.width/this.glCanvas.height,fovY=this.renderer.fovy,setPieceTarget=(_a=this.setPiece)==null?void 0:_a.cameraTarget(),aspectDelta=maxAspect-Math.min(aspect,maxAspect),baseTarget=setPieceTarget?setPieceTarget.pos??setPieceTarget:carrier?carrier.team==="home"?carrier.pos.c.zeroY().add([0,0,aspectDelta*pullbackAdjust/2]):carrier.pos.c.zeroY().add([0,0,Math.max(0,Math.min(20+aspectDelta*pullbackAdjust/2,FIELD_LENGTH$1+5-carrier.pos.z))]):ball.vel[2]<=0?ball.pos.c.zeroY().add([0,0,aspectDelta*pullbackAdjust/2]):ball.pos.c.zeroY().add([0,0,Math.max(0,Math.min(10+aspectDelta*pullbackAdjust/2,FIELD_LENGTH$1+5-ball.pos.z))]);let cameraHeight=baseHeight-aspectDelta*heightAdjust,cameraBack=pullback+aspectDelta*pullbackAdjust;const lateral=Math.min(1,Math.abs(baseTarget[0])/FIELD_RADIUS_X$1);cameraHeight+=lateral*lateralHeightAdjust,cameraBack+=lateral*lateralPullbackAdjust;const desiredNDC_Y=!!carrier&&carrier.team==="home"?ndcBiasHome:ndcBiasAway,verticalBias=Math.tan(fovY/2)*cameraBack*desiredNDC_Y,targetX=baseTarget[0],halfFovX=Math.atan(Math.tan(fovY/2)*aspect),depth=Math.max(.001,cameraBack-verticalBias),halfWidthAtSubject=Math.tan(halfFovX)*depth,lo=Math.max(-FIELD_RADIUS_X$1,targetX-halfWidthAtSubject),hi=Math.min(FIELD_RADIUS_X$1,targetX+halfWidthAtSubject),lookX=Math.max(lo,Math.min(hi,lateralFollowRatio*targetX)),lookTarget=baseTarget.c;lookTarget.setFrom(lookX,baseTarget[1],baseTarget[2]-verticalBias);const dist2=this.cameraTarget.dist(lookTarget),CAM_SPEED=Math.max(1/(1+3*dist2),.05);this.cameraTarget.lerp(lookTarget,CAM_SPEED*this.dt/.016),this.cameraPos=this.cameraTarget.c.add([0,cameraHeight,cameraBack])}resize(){this.glCanvas.width=window.innerWidth,this.glCanvas.height=window.innerHeight;const aspect=window.innerWidth/window.innerHeight;this.aspectRatio=aspect;const baseFov=45*Math.PI/180,maxFov=85*Math.PI/180,fovScale=Math.max(0,(1.777-aspect)/1);this.renderer.fovy=baseFov+fovScale*(maxFov-baseFov),this.renderer.updateProjection(),this.banner.updateLayout()}}const spriteSheetUrl="/footy-testing/assets/spritesheet-BF0REUxm.png";function main(spriteSheet){const uiCanvas=document.getElementById("uicanvas");if(!uiCanvas)throw console.error("UI Canvas element not found"),new Error("UI Canvas element not found");const glCanvas=document.getElementById("glcanvas");if(!glCanvas)throw console.error("WebGL2 Canvas element not found"),new Error("WebGL2 Canvas element not found");new Game(glCanvas,uiCanvas,spriteSheet).start()}function loadFont(){return document.fonts.load('10px "Titillium Web"').then(value=>{document.fonts.ready})}Promise.all([loadImage(spriteSheetUrl),loadFont()]).then(([image])=>{if(!image.complete)throw console.error("Failed to load sprite sheet"),new Error("Sprite sheet not loaded");main(image)}).catch(err=>{console.error("Initialization failed:",err)});
