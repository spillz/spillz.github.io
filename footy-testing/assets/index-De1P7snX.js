var __defProp=Object.defineProperty;var __typeError=msg=>{throw TypeError(msg)};var __defNormalProp=(obj,key,value)=>key in obj?__defProp(obj,key,{enumerable:!0,configurable:!0,writable:!0,value}):obj[key]=value;var __publicField=(obj,key,value)=>__defNormalProp(obj,typeof key!="symbol"?key+"":key,value),__accessCheck=(obj,member,msg)=>member.has(obj)||__typeError("Cannot "+msg);var __privateAdd=(obj,member,value)=>member.has(obj)?__typeError("Cannot add the same private member more than once"):member instanceof WeakSet?member.add(obj):member.set(obj,value);var __privateMethod=(obj,member,method)=>(__accessCheck(obj,member,"access private method"),method);(function(){const relList=document.createElement("link").relList;if(relList&&relList.supports&&relList.supports("modulepreload"))return;for(const link of document.querySelectorAll('link[rel="modulepreload"]'))processPreload(link);new MutationObserver(mutations=>{for(const mutation of mutations)if(mutation.type==="childList")for(const node of mutation.addedNodes)node.tagName==="LINK"&&node.rel==="modulepreload"&&processPreload(node)}).observe(document,{childList:!0,subtree:!0});function getFetchOpts(link){const fetchOpts={};return link.integrity&&(fetchOpts.integrity=link.integrity),link.referrerPolicy&&(fetchOpts.referrerPolicy=link.referrerPolicy),link.crossOrigin==="use-credentials"?fetchOpts.credentials="include":link.crossOrigin==="anonymous"?fetchOpts.credentials="omit":fetchOpts.credentials="same-origin",fetchOpts}function processPreload(link){if(link.ep)return;link.ep=!0;const fetchOpts=getFetchOpts(link);fetch(link.href,fetchOpts)}})();var EPSILON=1e-6,ARRAY_TYPE=typeof Float32Array<"u"?Float32Array:Array;function create$3(){var out=new ARRAY_TYPE(16);return ARRAY_TYPE!=Float32Array&&(out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[11]=0,out[12]=0,out[13]=0,out[14]=0),out[0]=1,out[5]=1,out[10]=1,out[15]=1,out}function clone(a2){var out=new ARRAY_TYPE(16);return out[0]=a2[0],out[1]=a2[1],out[2]=a2[2],out[3]=a2[3],out[4]=a2[4],out[5]=a2[5],out[6]=a2[6],out[7]=a2[7],out[8]=a2[8],out[9]=a2[9],out[10]=a2[10],out[11]=a2[11],out[12]=a2[12],out[13]=a2[13],out[14]=a2[14],out[15]=a2[15],out}function identity(out){return out[0]=1,out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[5]=1,out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[10]=1,out[11]=0,out[12]=0,out[13]=0,out[14]=0,out[15]=1,out}function multiply(out,a2,b){var a00=a2[0],a01=a2[1],a02=a2[2],a03=a2[3],a10=a2[4],a11=a2[5],a12=a2[6],a13=a2[7],a20=a2[8],a21=a2[9],a22=a2[10],a23=a2[11],a30=a2[12],a31=a2[13],a32=a2[14],a33=a2[15],b0=b[0],b1=b[1],b2=b[2],b3=b[3];return out[0]=b0*a00+b1*a10+b2*a20+b3*a30,out[1]=b0*a01+b1*a11+b2*a21+b3*a31,out[2]=b0*a02+b1*a12+b2*a22+b3*a32,out[3]=b0*a03+b1*a13+b2*a23+b3*a33,b0=b[4],b1=b[5],b2=b[6],b3=b[7],out[4]=b0*a00+b1*a10+b2*a20+b3*a30,out[5]=b0*a01+b1*a11+b2*a21+b3*a31,out[6]=b0*a02+b1*a12+b2*a22+b3*a32,out[7]=b0*a03+b1*a13+b2*a23+b3*a33,b0=b[8],b1=b[9],b2=b[10],b3=b[11],out[8]=b0*a00+b1*a10+b2*a20+b3*a30,out[9]=b0*a01+b1*a11+b2*a21+b3*a31,out[10]=b0*a02+b1*a12+b2*a22+b3*a32,out[11]=b0*a03+b1*a13+b2*a23+b3*a33,b0=b[12],b1=b[13],b2=b[14],b3=b[15],out[12]=b0*a00+b1*a10+b2*a20+b3*a30,out[13]=b0*a01+b1*a11+b2*a21+b3*a31,out[14]=b0*a02+b1*a12+b2*a22+b3*a32,out[15]=b0*a03+b1*a13+b2*a23+b3*a33,out}function translate(out,a2,v){var x=v[0],y=v[1],z=v[2],a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23;return a2===out?(out[12]=a2[0]*x+a2[4]*y+a2[8]*z+a2[12],out[13]=a2[1]*x+a2[5]*y+a2[9]*z+a2[13],out[14]=a2[2]*x+a2[6]*y+a2[10]*z+a2[14],out[15]=a2[3]*x+a2[7]*y+a2[11]*z+a2[15]):(a00=a2[0],a01=a2[1],a02=a2[2],a03=a2[3],a10=a2[4],a11=a2[5],a12=a2[6],a13=a2[7],a20=a2[8],a21=a2[9],a22=a2[10],a23=a2[11],out[0]=a00,out[1]=a01,out[2]=a02,out[3]=a03,out[4]=a10,out[5]=a11,out[6]=a12,out[7]=a13,out[8]=a20,out[9]=a21,out[10]=a22,out[11]=a23,out[12]=a00*x+a10*y+a20*z+a2[12],out[13]=a01*x+a11*y+a21*z+a2[13],out[14]=a02*x+a12*y+a22*z+a2[14],out[15]=a03*x+a13*y+a23*z+a2[15]),out}function scale$1(out,a2,v){var x=v[0],y=v[1],z=v[2];return out[0]=a2[0]*x,out[1]=a2[1]*x,out[2]=a2[2]*x,out[3]=a2[3]*x,out[4]=a2[4]*y,out[5]=a2[5]*y,out[6]=a2[6]*y,out[7]=a2[7]*y,out[8]=a2[8]*z,out[9]=a2[9]*z,out[10]=a2[10]*z,out[11]=a2[11]*z,out[12]=a2[12],out[13]=a2[13],out[14]=a2[14],out[15]=a2[15],out}function rotateX(out,a2,rad){var s=Math.sin(rad),c=Math.cos(rad),a10=a2[4],a11=a2[5],a12=a2[6],a13=a2[7],a20=a2[8],a21=a2[9],a22=a2[10],a23=a2[11];return a2!==out&&(out[0]=a2[0],out[1]=a2[1],out[2]=a2[2],out[3]=a2[3],out[12]=a2[12],out[13]=a2[13],out[14]=a2[14],out[15]=a2[15]),out[4]=a10*c+a20*s,out[5]=a11*c+a21*s,out[6]=a12*c+a22*s,out[7]=a13*c+a23*s,out[8]=a20*c-a10*s,out[9]=a21*c-a11*s,out[10]=a22*c-a12*s,out[11]=a23*c-a13*s,out}function perspectiveNO(out,fovy,aspect,near,far){var f=1/Math.tan(fovy/2);if(out[0]=f/aspect,out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[5]=f,out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[11]=-1,out[12]=0,out[13]=0,out[15]=0,far!=null&&far!==1/0){var nf=1/(near-far);out[10]=(far+near)*nf,out[14]=2*far*near*nf}else out[10]=-1,out[14]=-2*near;return out}var perspective=perspectiveNO;function lookAt(out,eye,center,up){var x0,x1,x2,y0,y1,y2,z0,z1,z2,len2,eyex=eye[0],eyey=eye[1],eyez=eye[2],upx=up[0],upy=up[1],upz=up[2],centerx=center[0],centery=center[1],centerz=center[2];return Math.abs(eyex-centerx)<EPSILON&&Math.abs(eyey-centery)<EPSILON&&Math.abs(eyez-centerz)<EPSILON?identity(out):(z0=eyex-centerx,z1=eyey-centery,z2=eyez-centerz,len2=1/Math.sqrt(z0*z0+z1*z1+z2*z2),z0*=len2,z1*=len2,z2*=len2,x0=upy*z2-upz*z1,x1=upz*z0-upx*z2,x2=upx*z1-upy*z0,len2=Math.sqrt(x0*x0+x1*x1+x2*x2),len2?(len2=1/len2,x0*=len2,x1*=len2,x2*=len2):(x0=0,x1=0,x2=0),y0=z1*x2-z2*x1,y1=z2*x0-z0*x2,y2=z0*x1-z1*x0,len2=Math.sqrt(y0*y0+y1*y1+y2*y2),len2?(len2=1/len2,y0*=len2,y1*=len2,y2*=len2):(y0=0,y1=0,y2=0),out[0]=x0,out[1]=y0,out[2]=z0,out[3]=0,out[4]=x1,out[5]=y1,out[6]=z1,out[7]=0,out[8]=x2,out[9]=y2,out[10]=z2,out[11]=0,out[12]=-(x0*eyex+x1*eyey+x2*eyez),out[13]=-(y0*eyex+y1*eyey+y2*eyez),out[14]=-(z0*eyex+z1*eyey+z2*eyez),out[15]=1,out)}function create$2(){var out=new ARRAY_TYPE(3);return ARRAY_TYPE!=Float32Array&&(out[0]=0,out[1]=0,out[2]=0),out}function length(a2){var x=a2[0],y=a2[1],z=a2[2];return Math.sqrt(x*x+y*y+z*z)}function fromValues$2(x,y,z){var out=new ARRAY_TYPE(3);return out[0]=x,out[1]=y,out[2]=z,out}function set(out,x,y,z){return out[0]=x,out[1]=y,out[2]=z,out}function scale(out,a2,b){return out[0]=a2[0]*b,out[1]=a2[1]*b,out[2]=a2[2]*b,out}function squaredDistance(a2,b){var x=b[0]-a2[0],y=b[1]-a2[1],z=b[2]-a2[2];return x*x+y*y+z*z}function squaredLength(a2){var x=a2[0],y=a2[1],z=a2[2];return x*x+y*y+z*z}function dot(a2,b){return a2[0]*b[0]+a2[1]*b[1]+a2[2]*b[2]}var len=length;(function(){var vec=create$2();return function(a2,stride,offset,count,fn,arg){var i,l;for(stride||(stride=3),offset||(offset=0),count?l=Math.min(count*stride+offset,a2.length):l=a2.length,i=offset;i<l;i+=stride)vec[0]=a2[i],vec[1]=a2[i+1],vec[2]=a2[i+2],fn(vec,vec,arg),a2[i]=vec[0],a2[i+1]=vec[1],a2[i+2]=vec[2];return a2}})();function create$1(){var out=new ARRAY_TYPE(4);return ARRAY_TYPE!=Float32Array&&(out[0]=0,out[1]=0,out[2]=0,out[3]=0),out}function fromValues$1(x,y,z,w){var out=new ARRAY_TYPE(4);return out[0]=x,out[1]=y,out[2]=z,out[3]=w,out}function transformMat4(out,a2,m){var x=a2[0],y=a2[1],z=a2[2],w=a2[3];return out[0]=m[0]*x+m[4]*y+m[8]*z+m[12]*w,out[1]=m[1]*x+m[5]*y+m[9]*z+m[13]*w,out[2]=m[2]*x+m[6]*y+m[10]*z+m[14]*w,out[3]=m[3]*x+m[7]*y+m[11]*z+m[15]*w,out}(function(){var vec=create$1();return function(a2,stride,offset,count,fn,arg){var i,l;for(stride||(stride=4),offset||(offset=0),count?l=Math.min(count*stride+offset,a2.length):l=a2.length,i=offset;i<l;i+=stride)vec[0]=a2[i],vec[1]=a2[i+1],vec[2]=a2[i+2],vec[3]=a2[i+3],fn(vec,vec,arg),a2[i]=vec[0],a2[i+1]=vec[1],a2[i+2]=vec[2],a2[i+3]=vec[3];return a2}})();function create(){var out=new ARRAY_TYPE(2);return ARRAY_TYPE!=Float32Array&&(out[0]=0,out[1]=0),out}function fromValues(x,y){var out=new ARRAY_TYPE(2);return out[0]=x,out[1]=y,out}function add(out,a2,b){return out[0]=a2[0]+b[0],out[1]=a2[1]+b[1],out}(function(){var vec=create();return function(a2,stride,offset,count,fn,arg){var i,l;for(stride||(stride=2),offset||(offset=0),count?l=Math.min(count*stride+offset,a2.length):l=a2.length,i=offset;i<l;i+=stride)vec[0]=a2[i],vec[1]=a2[i+1],fn(vec,vec,arg),a2[i]=vec[0],a2[i+1]=vec[1];return a2}})();class Vec3 extends Float32Array{constructor(x=0,y=0,z=0){super(3),this[0]=x,this[1]=y,this[2]=z}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}set x(v){this[0]=v}set y(v){this[1]=v}set z(v){this[2]=v}get c(){return new Vec3(this[0],this[1],this[2])}zeroX(){return this[0]=0,this}zeroY(){return this[1]=0,this}zeroZ(){return this[2]=0,this}setFrom(x,y,z){return this[0]=x,this[1]=y,this[2]=z,this}add(v){return this[0]+=v[0],this[1]+=v[1],this[2]+=v[2],this}sub(v){return this[0]-=v[0],this[1]-=v[1],this[2]-=v[2],this}scale(s){return this[0]*=s,this[1]*=s,this[2]*=s,this}scaleAndAdd(v,s){return this[0]+=v[0]*s,this[1]+=v[1]*s,this[2]+=v[2]*s,this}normalize(){const len2=Math.hypot(this[0],this[1],this[2]);return len2>1e-6?this.scale(1/len2):this.setFrom(0,0,0)}dot(v){return this[0]*v[0]+this[1]*v[1]+this[2]*v[2]}cross(v){return new Vec3(this[1]*v[2]-this[2]*v[1],this[2]*v[0]-this[0]*v[2],this[0]*v[1]-this[1]*v[0])}lenSq(){return this[0]**2+this[1]**2+this[2]**2}len(){return Math.hypot(this[0],this[1],this[2])}dist(v){return Math.hypot(this[0]-v[0],this[1]-v[1],this[2]-v[2])}distSq(v){return(this[0]-v[0])*(this[0]-v[0])+(this[1]-v[1])*(this[1]-v[1])+(this[2]-v[2])*(this[2]-v[2])}copyFrom(v){return this[0]=v[0],this[1]=v[1],this[2]=v[2],this}toArray(){return[this[0],this[1],this[2]]}static fromXZ(x,z){return new Vec3(x,0,z)}static fromXY(x,y){return new Vec3(x,y,0)}static fromArrayXZ(arr){return new Vec3(arr[0],0,arr[1])}static fromArrayXY(arr){return new Vec3(arr[0],arr[1],0)}static fromArray(arr){return new Vec3(arr[0],arr[1],arr[2])}static direction(from,to){return new Vec3(to[0]-from[0],to[1]-from[1],to[2]-from[2]).normalize()}lerp(to,t){return this[0]+=(to[0]-this[0])*t,this[1]+=(to[1]-this[1])*t,this[2]+=(to[2]-this[2])*t,this}lerpEased(target,t,easing){const te=easing?easing(t):t;return this[0]+=(target[0]-this[0])*te,this[1]+=(target[1]-this[1])*te,this[2]+=(target[2]-this[2])*te,this}get xz(){return new Vec2$1(this[0],this[2])}get xy(){return new Vec2$1(this[0],this[1])}get yz(){return new Vec2$1(this[1],this[2])}toDir(target){return this.sub(target).normalize()}dirTo(target){return Vec3.fromArray(target).sub(this).normalize()}dirFrom(target){return this.c.sub(target).normalize()}moveTo(target,amount,overRun=!1){const dx=target[0]-this[0],dy=target[1]-this[1],dz=target[2]-this[2],dist2=Math.hypot(dx,dy,dz);if(dist2<1e-5)return this;const f=overRun?amount/dist2:Math.min(1,amount/dist2);return this[0]+=dx*f,this[1]+=dy*f,this[2]+=dz*f,this}moveDir(dir,amount){const dx=dir[0],dy=dir[1],dz=dir[2],dist2=Math.hypot(dx,dy,dz);return dist2<1e-5?this:(this[0]+=dx*amount/dist2,this[1]+=dy*amount/dist2,this[2]+=dz*amount/dist2,this)}rotateXZ(angleRad){const cos=Math.cos(angleRad),sin=Math.sin(angleRad);return[this[0],this[2]]=[this[0]*cos-this[2]*sin,this[0]*sin+this[2]*cos],this}}let Vec2$1=class Vec2 extends Float32Array{constructor(x=0,y=0){super(2),this[0]=x,this[1]=y}get x(){return this[0]}get y(){return this[1]}set x(v){this[0]=v}set y(v){this[1]=v}get c(){return new Vec2(this[0],this[1])}set(x,y){return this[0]=x,this[1]=y,this}add(v){return this[0]+=v[0],this[1]+=v[1],this}sub(v){return this[0]-=v[0],this[1]-=v[1],this}scale(s){return this[0]*=s,this[1]*=s,this}normalize(){const len2=Math.hypot(this[0],this[1]);return len2>1e-6?this.scale(1/len2):this.set(0,0)}dot(v){return this[0]*v[0]+this[1]*v[1]}lenSq(){return this[0]**2+this[1]**2}len(){return Math.sqrt(this.lenSq())}dist(v){return Math.hypot(this[0]-v[0],this[1]-v[1])}distSq(v){return(this[0]-v[0])*(this[0]-v[0])+(this[1]-v[1])*(this[1]-v[1])}copyFrom(v){return this[0]=v[0],this[1]=v[1],this}toArray(){return[this[0],this[1]]}static fromArray(arr){return new Vec2(arr[0],arr[1])}static direction(from,to){return new Vec2(to[0]-from[0],to[1]-from[1]).normalize()}lerp(to,t){return this[0]+=(to[0]-this[0])*t,this[1]+=(to[1]-this[1])*t,this}lerpEased(target,t,easing=void 0){const te=easing?easing(t):t;return this[0]+=(target[0]-this[0])*te,this[1]+=(target[1]-this[1])*te,this[2]+=(target[2]-this[2])*te,this}toDir(target){return this.sub(target).normalize()}moveTo(target,amount,overRun=!1){const dx=target[0]-this[0],dy=target[1]-this[1],dist2=Math.hypot(dx,dy);if(dist2<1e-5)return this;const f=overRun?amount/dist2:Math.min(1,amount/dist2);return this[0]+=dx*f,this[1]+=dy*f,this}moveDir(dir,amount){const dx=dir[0],dy=dir[1],dist2=Math.hypot(dx,dy);return dist2<1e-5?this:(this[0]+=dx*amount/dist2,this[1]+=dy*amount/dist2,this)}};const v3=(x=0,y=0,z=0)=>new Vec3(x,y,z),v2=(x=0,y=0)=>new Vec2$1(x,y);function splitmix64(seed){let state=BigInt(seed)&0xFFFFFFFFFFFFFFFFn;return function(){state=state+0x9E3779B97F4A7C15n&0xFFFFFFFFFFFFFFFFn;let z=state;return z=(z^z>>30n)*0xBF58476D1CE4E5B9n&0xFFFFFFFFFFFFFFFFn,z=(z^z>>27n)*0x94D049BB133111EBn&0xFFFFFFFFFFFFFFFFn,z=z^z>>31n,z}}class PRNG{constructor(){__publicField(this,"_seed",0)}random(){return Math.random()}seed(seed){throw new Error("Seeding is not available in the default PRNG class. You can set another with `eskv.rand.setPRNG`.")}getRandomInt(m1,m2=0){return m2!=0?m1+Math.floor(this.random()*(m2-m1)):Math.floor(this.random()*m1)}getRandomPos(maxX,maxY){return[this.getRandomInt(maxX),this.getRandomInt(maxY)]}randomRange(min=0,max=1){return Math.floor(this.random()*(max-min+1))+min}randomFloat(min=0,max=1){return this.random()*(max-min)+min}shuffle(arr){let temp,r2;for(let i=1;i<arr.length;i++)r2=this.randomRange(0,i),temp=arr[i],arr[i]=arr[r2],arr[r2]=temp;return arr}choose(array){return array[Math.floor(this.random()*array.length)]}chooseN(arr,n){let result=new Array(n),len2=arr.length,taken=new Array(len2);if(n>len2)throw new RangeError("chooeN: more elements requested than available");for(;n--;){let x=Math.floor(this.random()*len2);result[n]=arr[x in taken?taken[x]:x],taken[x]=--len2 in taken?taken[len2]:len2}return result}}function sfc32(a2,b,c,d){return function(){a2>>>=0,b>>>=0,c>>>=0,d>>>=0;var t=a2+b|0;return a2=b^b>>>9,b=c+(c<<3)|0,c=c<<21|c>>>11,d=d+1|0,t=t+d|0,c=c+t|0,(t>>>0)/4294967296}}function mulberry32(a2){return function(){var t=a2+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function xoshiro128ss(a2,b,c,d){return function(){var t=b<<9,r2=b*5;return r2=(r2<<7|r2>>>25)*9,c^=a2,d^=b,b^=c,a2^=d,c^=t,d=d<<11|d>>>21,(r2>>>0)/4294967296}}function jsf32(a2,b,c,d){return function(){a2|=0,b|=0,c|=0,d|=0;var t=a2-(b<<27|b>>>5)|0;return a2=b^(c<<17|c>>>15),b=c+d|0,c=d+t|0,d=a2+t|0,(d>>>0)/4294967296}}class PRNG_sfc32 extends PRNG{constructor(){super(...arguments);__publicField(this,"_seed",1);__publicField(this,"d",3735928559);__publicField(this,"xorSeed",Math.floor(Date.now())^this.d);__publicField(this,"random",sfc32(2654435769,608135816,3084996962,this.xorSeed))}seed(seed){this._seed=seed,this.xorSeed=seed^this.d;const sm=splitmix64(this.xorSeed);this.random=sfc32(sm(),sm(),sm(),sm())}}class PRNG_mulberry32 extends PRNG{constructor(){super(...arguments);__publicField(this,"_seed",1);__publicField(this,"d",3735928559);__publicField(this,"xorSeed",Math.floor(Date.now())^this.d);__publicField(this,"random",mulberry32(this.xorSeed))}seed(seed){this._seed=seed,this.xorSeed=seed^this.d,this.random=mulberry32(this.xorSeed)}}class PRNG_xoshiro128ss extends PRNG{constructor(){super(...arguments);__publicField(this,"_seed",1);__publicField(this,"d",3735928559);__publicField(this,"xorSeed",Math.floor(Date.now())^this.d);__publicField(this,"random",xoshiro128ss(2654435769,608135816,3084996962,this.xorSeed))}seed(seed){this._seed=seed,this.xorSeed=seed^this.d;const sm=splitmix64(this.xorSeed);this.random=xoshiro128ss(sm(),sm(),sm(),sm())}}class PRNG_jsf32 extends PRNG{constructor(){super(...arguments);__publicField(this,"_seed",1);__publicField(this,"d",3735928559);__publicField(this,"xorSeed",Math.floor(Date.now())^this.d);__publicField(this,"random",jsf32(2654435769,608135816,3084996962,this.xorSeed))}seed(seed){this._seed=seed,this.xorSeed=seed^this.d;const sm=splitmix64(this.xorSeed);this.random=jsf32(sm(),sm(),sm(),sm())}}var defaultPRNG=new PRNG_sfc32;function setPRNG(name){switch(name){case"Math.random":defaultPRNG=new PRNG;return;case"sfc32":defaultPRNG=new PRNG_sfc32;return;case"mulberry32":defaultPRNG=new PRNG_mulberry32;return;case"xoshiro128ss":defaultPRNG=new PRNG_xoshiro128ss;return;case"jsf32":defaultPRNG=new PRNG_jsf32;return;default:throw Error(`Unknown PRNG ${name}`)}}function getRandomInt(m1,m2=0){return defaultPRNG.getRandomInt(m1,m2)}function getRandomPos(max1,max2){return defaultPRNG.getRandomPos(max1,max2)}function randomFloat(min=0,max=1){return defaultPRNG.randomFloat(min,max)}function choose(array){return defaultPRNG.choose(array)}function setSeed(seed){return defaultPRNG.seed(seed)}function stringToSeed(str){let hash=5381;for(let i=0;i<str.length;i++)hash=(hash<<5)+hash+str.charCodeAt(i),hash=hash&4294967295;return hash>>>0}function solveQuadratic(a2,b,c){const discriminant=b*b-4*a2*c;if(discriminant<0)return[];const sqrtD=Math.sqrt(discriminant),t1=(-b-sqrtD)/(2*a2),t2=(-b+sqrtD)/(2*a2);return[t1,t2].filter(t=>t>=0)}function getPositionAtTime(pos0,vel0,g,t){return pos0.c.scaleAndAdd(vel0,t).scaleAndAdd(g,.5*t*t)}function timeToHeight(pos0,vel0,g,h){const a2=-.5*g,b=vel0[1],c=pos0[1]-h;return solveQuadratic(a2,b,c).filter(t=>t>=0)}function timeToGround(pos0,vel0,g){return timeToHeight(pos0,vel0,g,0)}function applyKickInaccuracy(aimTarget,magnitude=.15){const dist2=Math.hypot(aimTarget[0],aimTarget[1]),noiseX=2*(Math.random()-.5)*dist2*magnitude,noiseZ=2*(Math.random()-.5)*dist2*magnitude;return[aimTarget[0]+noiseX,aimTarget[1]+noiseZ]}function oscillateAimTarget(aimTarget,time,magnitude=.15,frequency=2,kickRange,rangeExponent=1){const dist2=Math.hypot(aimTarget[0],aimTarget[1]),ratio=kickRange?Math.min(dist2/kickRange,1)**rangeExponent:1,offsetX=Math.sin(time*Math.PI*2*frequency)*dist2*magnitude*ratio;return[aimTarget[0]+offsetX,aimTarget[1]]}function getLaunchParamsFor(origin,target,gravity,angleDeg=30){const diff=v3(target[0]-origin[0],0,target[2]-origin[2]),dist2=diff.len();if(dist2<.1)return null;const angleRad=angleDeg*Math.PI/180,sin2θ=Math.sin(2*angleRad);if(Math.abs(sin2θ)<1e-5)return null;const speed=Math.sqrt(dist2*gravity/sin2θ),dirXZ=diff.normalize();return{direction:v3(dirXZ[0]*Math.cos(angleRad),Math.sin(angleRad),dirXZ[2]*Math.cos(angleRad)),speed}}function computeKickVelocity(player,aimTarget,isHandpass=!1,overrideVy=void 0,startOffsetY=0,endOffsetY=isHandpass?player.statsHeight-.1:0,originOverride=null){const gravity=-player.gravity[1],originPos=originOverride??player.pos,originY=originPos[1]+startOffsetY,targetY=originPos[1]+endOffsetY,origin=v3(originPos[0],originY,originPos[2]),aimDist=Math.hypot(aimTarget[0],aimTarget[1]),effectiveHandRange=isHandpass?Math.max(player.statsHandpassRange*player.buffHandball,0):0,baseHandAngle=10,maxHandAngle=28,comfortableParams=isHandpass?getLaunchParamsFor(v3(0,0,0),v3(Math.max(effectiveHandRange,player.statsHandpassRange||.1),0,0),gravity,baseHandAngle):null;if(comfortableParams&&comfortableParams.speed*Math.cos(baseHandAngle*Math.PI/180),overrideVy!==void 0){const dy=targetY-originY;if(overrideVy*overrideVy<2*gravity*dy)return null;const roots2=solveQuadratic(-.5*gravity,overrideVy,-dy).filter(r2=>r2>0);if(roots2.length===0)return null;const t=Math.max(...roots2),vx=aimTarget[0]/t,vz=aimTarget[1]/t;return v3(vx,overrideVy,vz)}let angle=30;if(isHandpass)if(effectiveHandRange>0){const ratio=Math.min(Math.max(aimDist/effectiveHandRange,0),1),highSpeedCutoff=.6,easedRatio=ratio<=highSpeedCutoff?0:(ratio-highSpeedCutoff)/(1-highSpeedCutoff);angle=baseHandAngle+(maxHandAngle-baseHandAngle)*easedRatio}else angle=baseHandAngle;const target=v3(origin[0]+aimTarget[0],targetY,origin[2]+aimTarget[1]),params=getLaunchParamsFor(origin,target,gravity,angle);return params?params.direction.scale(params.speed):null}function computeAerialInterceptJumpApex(playerPos,playerHeight,jumpVel,maxSpeed,ballPos,ballVel,gravity,deltaTime=1/60){const g=gravity,apexTime=jumpVel/g,apexHeight=jumpVel*jumpVel/(2*g),a2=-.5*g,b=ballVel[1],c=ballPos[1]-(playerPos[1]+playerHeight+apexHeight),D=b*b-4*a2*c;if(D<0)return{ok:!1,runVel:v3(0,0,0),jumpNow:!1};const s=Math.sqrt(D),t1=(-b-s)/(2*a2),t2=(-b+s)/(2*a2),cand=[t1,t2].filter(t=>t>=apexTime&&b-g*t<0).sort((x,y)=>x-y);for(const t of cand){const bx=ballPos[0]+ballVel[0]*t,by=ballPos[1]+ballVel[1]*t-.5*g*t*t,bz=ballPos[2]+ballVel[2]*t,v=v3(bx-playerPos[0],0,bz-playerPos[2]).scale(1/t);if(v.len()<=maxSpeed)return{ok:!0,runVel:v,jumpNow:t-apexTime<=deltaTime,time:t,point:v3(bx,by,bz)}}return{ok:!1,runVel:v3(0,0,0),jumpNow:!1}}function computeBallLanding(ballPos,ballVel,gravity,groundY=0){const a2=-.5*gravity,b=ballVel[1],c=ballPos[1]-groundY;if(c<=0)return{ok:!0,time:0,point:v3(ballPos[0],groundY,ballPos[2]),note:"already at/below ground"};const disc=b*b-4*a2*c;if(disc<0)return{ok:!1,time:null,point:null,note:"never reaches ground"};const sqrtD=Math.sqrt(disc),t1=(-b+sqrtD)/(2*a2),t2=(-b-sqrtD)/(2*a2),ts=[t1,t2].filter(t3=>t3>=0);if(!ts.length)return{ok:!1,time:null,point:null,note:"roots < 0"};const t=Math.max(...ts),x=ballPos[0]+ballVel[0]*t,z=ballPos[2]+ballVel[2]*t;return{ok:!0,time:t,point:v3(x,groundY,z)}}function computeAerialInterceptAnyJumpHeight(playerPos,playerHeight,jumpVel,maxSpeed,ballPos,ballVel,gravity,deltaTime=1/60){const g=gravity,apexHeight=jumpVel*jumpVel/(2*g),yMin=playerPos[1]+playerHeight,yMax=yMin+apexHeight,a2=-.5*g,b=ballVel[1],cTop=ballPos[1]-yMax,cBot=ballPos[1]-yMin,discTop=b*b-4*a2*cTop,discBot=b*b-4*a2*cBot;if(discTop<0&&discBot<0)return{ok:!1,note:"ball never within jump reach"};const tEnter=discTop>=0?Math.max((-b-Math.sqrt(discTop))/(2*a2),0):0,tExit=discBot>=0?Math.max((-b-Math.sqrt(discBot))/(2*a2),tEnter+.01):tEnter+.01,dx=ballPos[0]-playerPos[0],dz=ballPos[2]-playerPos[2],vx=ballVel[0],vz=ballVel[2],s2=maxSpeed*maxSpeed,A=vx*vx+vz*vz-s2,B=2*(dx*vx+dz*vz),C=dx*dx+dz*dz;let t=null;if(Math.abs(A)<1e-6)if(Math.abs(B)<1e-6)t=C===0?0:null;else{const root=-C/B;root>=tEnter&&root<=tExit&&(t=root)}else{const D=B*B-4*A*C;if(D>=0){const sqrtD=Math.sqrt(D),r1=(-B-sqrtD)/(2*A),r2=(-B+sqrtD)/(2*A),r3=[r1,r2].filter(rt=>rt>=tEnter&&rt<=tExit);r3.length&&(t=Math.min(...r3))}}if(t===null)return{ok:!1,note:"no reachable time at maxSpeed"};const bx=ballPos[0]+vx*t,by=ballPos[1]+ballVel[1]*t-.5*g*t*t,bz=ballPos[2]+vz*t,a22=-.5*g,b2=jumpVel,c2=playerPos[1]-by,D2=b2*b2-4*a22*c2;if(D2<0)return{ok:!1,note:"no valid jump τ for intercept height"};const sqrtD2=Math.sqrt(D2),τ1=(-b2+sqrtD2)/(2*a22),τ2=(-b2-sqrtD2)/(2*a22),τ=Math.min(τ1,τ2),jumpStart=t-τ;if(jumpStart<0||τ<0)return{ok:!1,note:"jumpStart < 0 or τ < 0"};const runVel=v3((bx-playerPos[0])/t,0,(bz-playerPos[2])/t);return{ok:!0,time:t,point:v3(bx,by,bz),runVel,jumpStart,jumpNow:jumpStart<=deltaTime}}function computeGroundIntercept(playerPos,maxSpeed,ballPos,ballVel,gravity,lossPer5m=.2){const[px,,pz]=playerPos,[bx0,,bz0]=ballPos,[vx,,vz]=ballVel,S=maxSpeed,S2=S*S,EPS=1e-6,land=computeBallLanding(ballPos,ballVel,gravity,0),tL=land!=null&&land.ok&&land.time!=null?land.time:null,bL=land!=null&&land.ok&&land.point?land.point:null,quadEarliest=(A,B,C)=>{if(Math.abs(A)<1e-10){if(Math.abs(B)<1e-10)return C<=0?0:void 0;const t=-C/B;return t>=0?t:void 0}const D=B*B-4*A*C;if(D<0)return;const s=Math.sqrt(D),d=2*A,t1=(-B-s)/d,t2=(-B+s)/d;if(t1>=0&&t2>=0)return Math.min(t1,t2);if(t1>=0)return t1;if(t2>=0)return t2},dx0=bx0-px,dz0=bz0-pz,v22=vx*vx+vz*vz,tPre=tL===null?void 0:quadEarliest(v22-S2,2*(dx0*vx+dz0*vz),dx0*dx0+dz0*dz0);if(tPre!==void 0&&tL!==null&&tPre<=tL+EPS){const tx2=bx0+vx*tPre,tz2=bz0+vz*tPre,rx2=tx2-px,rz2=tz2-pz;return{ok:!0,time:tPre,point:v3(tx2,0,tz2),runVel:tPre>EPS?v3(rx2/tPre,0,rz2/tPre):v3(0,0,0),note:"pre-bounce intercept"}}if(tL!=null&&bL){const dirNorm=Math.hypot(vx,vz)||1,ux=vx/dirNorm,uz=vz/dirNorm,v0b=dirNorm,b=-Math.log(1-Math.max(0,Math.min(.99,lossPer5m)))/5,bxL=bL[0],bzL=bL[2],f=tau=>{const s=Math.log1p(b*v0b*tau)/b,tx2=bxL+ux*s,tz2=bzL+uz*s;return Math.hypot(tx2-px,tz2-pz)-S*(tL+tau)};let lo=0,hi=.2,fhi=f(hi),it=0;for(;fhi>0&&it++<40&&(lo=hi,hi*=2,fhi=f(hi),!(hi>20)););if(fhi<=0){for(let k=0;k<36;k++){const mid=(lo+hi)/2,fm=f(mid);fm<=0?(hi=mid,fhi=fm):lo=mid}const t=tL+hi,s=Math.log1p(b*v0b*(t-tL))/b,tx2=bxL+ux*s,tz2=bzL+uz*s,rx2=tx2-px,rz2=tz2-pz;return{ok:!0,time:t,point:v3(tx2,0,tz2),runVel:t>EPS?v3(rx2/t,0,rz2/t):v3(0,0,0),note:"post-bounce intercept (decay)"}}}if(bL){const rx2=bL[0]-px,rz2=bL[2]-pz,dist2=Math.hypot(rx2,rz2),t=Math.max(tL??0,dist2/S);return{ok:!0,time:t,point:bL,runVel:t>EPS?v3(rx2/t,0,rz2/t):v3(0,0,0),note:"fallback: landing"}}const tAny=quadEarliest(v22-S2,2*(dx0*vx+dz0*vz),dx0*dx0+dz0*dz0);if(tAny===void 0)return{ok:!1,time:null,point:null,runVel:null,note:"no intercept"};const tx=bx0+vx*tAny,tz=bz0+vz*tAny,rx=tx-px,rz=tz-pz;return{ok:!0,time:tAny,point:v3(tx,0,tz),runVel:v3(rx/tAny,0,rz/tAny),note:"projection intercept"}}function computeBestIntercept(playerPos,playerHeight,jumpVel,maxSpeed,ballPos,ballVel,gravity,deltaTime){const apex=computeAerialInterceptJumpApex(playerPos,playerHeight,jumpVel,maxSpeed,ballPos,ballVel,gravity,deltaTime);if(apex.ok&&apex.runVel)return{...apex,mode:"apex"};const sub=computeAerialInterceptAnyJumpHeight(playerPos,playerHeight,jumpVel,maxSpeed,ballPos,ballVel,gravity,deltaTime);if(sub.ok&&sub.runVel&&sub.point)return{...sub,mode:"subApex"};const ground=computeGroundIntercept(playerPos,maxSpeed,ballPos,ballVel,gravity);return ground.ok&&ground.point&&ground.runVel?{...ground,mode:"ground"}:{ok:!1,note:"No viable intercept within speed/jump constraints"}}function createShaderProgram(gl,vsSource,fsSource){const compile=(src,type)=>{const shader=gl.createShader(type);if(!shader)throw new Error("Failed to create shader");if(gl.shaderSource(shader,src),gl.compileShader(shader),!gl.getShaderParameter(shader,gl.COMPILE_STATUS))throw new Error(gl.getShaderInfoLog(shader));return shader},vs=compile(vsSource,gl.VERTEX_SHADER),fs=compile(fsSource,gl.FRAGMENT_SHADER),program=gl.createProgram();if(gl.attachShader(program,vs),gl.attachShader(program,fs),gl.linkProgram(program),!gl.getProgramParameter(program,gl.LINK_STATUS))throw new Error(gl.getProgramInfoLog(program));return program}async function loadImage(url){const image=new Image;return image.src=url,await image.decode(),image}const FIELD_WIDTH=160,FIELD_LENGTH$1=170,FIELD_RADIUS_X$1=FIELD_WIDTH/2,FIELD_RADIUS_Z$1=FIELD_LENGTH$1/2,FENCE_PADDING=5,FENCE_RADIUS_X=FIELD_RADIUS_X$1+FENCE_PADDING,FENCE_RADIUS_Z=FIELD_RADIUS_Z$1+FENCE_PADDING,INV_FENCE_RADIUS_X_SQ=1/(FENCE_RADIUS_X*FENCE_RADIUS_X),INV_FENCE_RADIUS_Z_SQ=1/(FENCE_RADIUS_Z*FENCE_RADIUS_Z),GOAL_WIDTH=6,BEHIND_WIDTH=6,POST_THICKNESS=.5,goals=Object.freeze({home:v3(0,0,0),away:v3(0,0,FIELD_LENGTH$1)}),computeGoalPostZ=(x,north)=>{const xNorm=x/FIELD_RADIUS_X$1,term=Math.sqrt(Math.max(0,1-xNorm*xNorm));return FIELD_RADIUS_Z$1+(north?1:-1)*FIELD_RADIUS_Z$1*term},GOAL_POSTS_NORTH=Object.freeze([v3(-.5*GOAL_WIDTH-BEHIND_WIDTH,0,computeGoalPostZ(-.5*GOAL_WIDTH-BEHIND_WIDTH,!0)),v3(-.5*GOAL_WIDTH,0,computeGoalPostZ(-.5*GOAL_WIDTH,!0)),v3(.5*GOAL_WIDTH,0,computeGoalPostZ(.5*GOAL_WIDTH,!0)),v3(.5*GOAL_WIDTH+BEHIND_WIDTH,0,computeGoalPostZ(.5*GOAL_WIDTH+BEHIND_WIDTH,!0))]),GOAL_POSTS_SOUTH=Object.freeze([v3(-.5*GOAL_WIDTH-BEHIND_WIDTH,0,computeGoalPostZ(-.5*GOAL_WIDTH-BEHIND_WIDTH,!1)),v3(-.5*GOAL_WIDTH,0,computeGoalPostZ(-.5*GOAL_WIDTH,!1)),v3(.5*GOAL_WIDTH,0,computeGoalPostZ(.5*GOAL_WIDTH,!1)),v3(.5*GOAL_WIDTH+BEHIND_WIDTH,0,computeGoalPostZ(.5*GOAL_WIDTH+BEHIND_WIDTH,!1))]),GOAL_POSTS=Object.freeze({Away:GOAL_POSTS_NORTH,Home:GOAL_POSTS_SOUTH});function isOutOfBounds(pos){const xNorm=pos[0]/FIELD_RADIUS_X$1,zNorm=(pos[2]-FIELD_RADIUS_Z$1)/FIELD_RADIUS_Z$1;return xNorm*xNorm+zNorm*zNorm>1}function boundaryIntersection(point){const center=fromValues$2(0,0,FIELD_RADIUS_Z$1),dx=point[0]-center[0],dz=point[2]-center[2];if(dx===0&&dz===0)return fromValues$2(0,0,center[2]+FIELD_RADIUS_Z$1);const a2=FIELD_RADIUS_X$1,b=FIELD_RADIUS_Z$1,A=dx*dx/(a2*a2)+dz*dz/(b*b),t=1/Math.sqrt(A),x=center[0]+t*dx,z=center[2]+t*dz;return fromValues$2(x,0,z)}function segmentBoundaryIntersection(a2,b){const x0=a2[0],z0=a2[2],x1=b[0],z1=b[2],dx=x1-x0,dz=z1-z0,cx=x0,cz=z0-FIELD_RADIUS_Z$1,A=dx*dx/(FIELD_RADIUS_X$1*FIELD_RADIUS_X$1)+dz*dz/(FIELD_RADIUS_Z$1*FIELD_RADIUS_Z$1),B=2*(cx*dx/(FIELD_RADIUS_X$1*FIELD_RADIUS_X$1)+cz*dz/(FIELD_RADIUS_Z$1*FIELD_RADIUS_Z$1)),C=cx*cx/(FIELD_RADIUS_X$1*FIELD_RADIUS_X$1)+cz*cz/(FIELD_RADIUS_Z$1*FIELD_RADIUS_Z$1)-1,discr=B*B-4*A*C;if(discr<0||A===0)return null;const sqrtDiscr=Math.sqrt(discr),t1=(-B-sqrtDiscr)/(2*A),t2=(-B+sqrtDiscr)/(2*A);let t=Number.POSITIVE_INFINITY;for(const candidate of[t1,t2])candidate>=0&&candidate<=1&&candidate<t&&(t=candidate);return isFinite(t)?fromValues$2(x0+dx*t,0,z0+dz*t):null}function fenceNorm(pos){const dx=pos[0],dz=pos[2]-FIELD_RADIUS_Z$1;return dx*dx*INV_FENCE_RADIUS_X_SQ+dz*dz*INV_FENCE_RADIUS_Z_SQ}function segmentFenceIntersection(a2,b){const x0=a2[0],z0=a2[2]-FIELD_RADIUS_Z$1,x1=b[0],z1=b[2]-FIELD_RADIUS_Z$1,dx=x1-x0,dz=z1-z0,A=dx*dx*INV_FENCE_RADIUS_X_SQ+dz*dz*INV_FENCE_RADIUS_Z_SQ,B=2*(x0*dx*INV_FENCE_RADIUS_X_SQ+z0*dz*INV_FENCE_RADIUS_Z_SQ),C=x0*x0*INV_FENCE_RADIUS_X_SQ+z0*z0*INV_FENCE_RADIUS_Z_SQ-1,discr=B*B-4*A*C;if(discr<0||A===0)return null;const sqrtDiscr=Math.sqrt(discr),t1=(-B-sqrtDiscr)/(2*A),t2=(-B+sqrtDiscr)/(2*A);let t=Number.POSITIVE_INFINITY;for(const candidate of[t1,t2])candidate>=0&&candidate<=1&&candidate<t&&(t=candidate);return isFinite(t)?fromValues$2(x0+dx*t,0,FIELD_RADIUS_Z$1+z0+dz*t):null}function clampToFenceBoundary(pos){const dx=pos[0],dz=pos[2]-FIELD_RADIUS_Z$1,norm=fenceNorm(pos);if(norm===0){pos[0]=0,pos[2]=FIELD_RADIUS_Z$1;return}const scale2=1/Math.sqrt(norm);pos[0]=dx*scale2,pos[2]=FIELD_RADIUS_Z$1+dz*scale2}function preventFenceCrossing(before,after){if(fenceNorm(after)<=1)return!1;if(fenceNorm(before)>1)return clampToFenceBoundary(after),!0;const intersection=segmentFenceIntersection(before,after);return intersection?(after[0]=intersection[0],after[2]=intersection[2],!0):(clampToFenceBoundary(after),!0)}function checkBoundaryCrossing(before,after){const iobBefore=isOutOfBounds(before),iobAfter=isOutOfBounds(after);if(!iobBefore&&iobAfter){const intersection=segmentBoundaryIntersection(before,after);if(!intersection)return null;const x=intersection[0],z=intersection[2],tag=z>FIELD_RADIUS_Z$1?"Away":"Home",posts=GOAL_POSTS[tag],postLabels=["outerLeftPost","innerLeftPost","innerRightPost","outerRightPost"];for(let i=0;i<posts.length;i++){const px=posts[i][0],pz=posts[i][2];if((x-px)*(x-px)+(z-pz)*(z-pz)<POST_THICKNESS*POST_THICKNESS)return`${postLabels[i]}${tag}`}const goalHalfWidth=GOAL_WIDTH/2,behindLeftStart=-goalHalfWidth-BEHIND_WIDTH,behindRightEnd=goalHalfWidth+BEHIND_WIDTH;if(tag==="Away"){if(Math.abs(x)<=goalHalfWidth)return"goalAway";if(x>=behindLeftStart&&x<-goalHalfWidth||x>goalHalfWidth&&x<=behindRightEnd)return"behindAway"}else{if(Math.abs(x)<=goalHalfWidth)return"goalHome";if(x>=behindLeftStart&&x<-goalHalfWidth||x>goalHalfWidth&&x<=behindRightEnd)return"behindHome"}return"outOfBounds"}return null}function generateFieldPositions(flip=!1){const r2={fullBack:70,halfBack:35,halfForward:-35,fullForward:-70},angleMap={LFP:-45,FF:0,RFP:45,LHF:-50,CHF:0,RHF:50,LHB:-50,CHB:0,RHB:50,LBP:-45,FB:0,RBP:45};function setPos(angle,radius){const angleRad=angle*Math.PI/180,x=FIELD_RADIUS_X$1*Math.sin(angleRad)*(Math.abs(radius)/FIELD_RADIUS_Z$1)-(flip?2:-2),z=FIELD_RADIUS_Z$1+radius*(flip?-1:1);return v3(x,0,z)}const benchX=-FIELD_RADIUS_X$1-4,benchZ=offset=>FIELD_RADIUS_Z$1+(flip?1:-1)*offset;return{LFP:setPos(angleMap.LFP,r2.fullForward+10),FF:setPos(angleMap.FF,r2.fullForward),RFP:setPos(angleMap.RFP,r2.fullForward+10),LHF:setPos(angleMap.LHF,r2.halfForward),CHF:setPos(angleMap.CHF,r2.halfForward),RHF:setPos(angleMap.RHF,r2.halfForward),LW:v3(-25,0,FIELD_RADIUS_Z$1-(flip?2:-2)),C:v3(8,0,FIELD_RADIUS_Z$1-(flip?-5:5)),RW:v3(25,0,FIELD_RADIUS_Z$1-(flip?2:-2)),LHB:setPos(angleMap.LHB,r2.halfBack),CHB:setPos(angleMap.CHB,r2.halfBack),RHB:setPos(angleMap.RHB,r2.halfBack),LBP:setPos(angleMap.LBP,r2.fullBack-10),FB:setPos(angleMap.FB,r2.fullBack),RBP:setPos(angleMap.RBP,r2.fullBack-10),Ruck:v3(0,0,FIELD_RADIUS_Z$1-(flip?10:-10)),RR:v3(-10,0,FIELD_RADIUS_Z$1-(flip?10:-10)),Rover:v3(10,0,FIELD_RADIUS_Z$1-(flip?10:-10)),Bench1:v3(benchX,0,benchZ(10)),Bench2:v3(benchX,0,benchZ(13)),Bench3:v3(benchX,0,benchZ(16)),Bench4:v3(benchX,0,benchZ(19)),Bench5:v3(benchX,0,benchZ(22))}}function createFieldEllipseMesh(radiusX,radiusZ,segments,tileScale=1){const uvRepeatX=radiusX*2/1.6/tileScale,uvRepeatZ=radiusZ*2/2/tileScale,vertices=[0,0,0,.5,.5],indices=[];for(let i=0;i<=segments;i++){const angle=i/segments*2*Math.PI,x=Math.cos(angle)*radiusX,z=Math.sin(angle)*radiusZ,u=x/(radiusX*2)*uvRepeatX+.5,v=z/(radiusZ*2)*uvRepeatZ+.5;vertices.push(x,0,z,u,v),i>0&&indices.push(0,i,i+1)}return{vertices:new Float32Array(vertices),indices:new Uint16Array(indices)}}function createFieldLineMesh(W=160,L=170,arcR=50,CS=50,thickness=.4){const verts=[],indices=[];let index=0;function pushLineStrip(x0List,z0List,x1List,z1List){const startIndex=index;for(let i=0;i<x0List.length;i++)verts.push(x0List[i],0,z0List[i]),verts.push(x1List[i],0,z1List[i]),index+=2;for(let i=0;i<x0List.length-1;i++){const i0=startIndex+i*2,i1=i0+1,i2=i0+2,i3=i0+3;indices.push(i0,i1,i2,i2,i1,i3)}}function lineSegment(x0,z0,x1,z1,thickness2){const dx=x1-x0,dz=z1-z0,len2=Math.hypot(dx,dz),nx=-dz/len2,nz=dx/len2,t=thickness2/2,x0a=x0+nx*t,z0a=z0+nz*t,x0b=x0-nx*t,z0b=z0-nz*t,x1a=x1+nx*t,z1a=z1+nz*t,x1b=x1-nx*t,z1b=z1-nz*t;pushLineStrip([x0a,x1a],[z0a,z1a],[x0b,x1b],[z0b,z1b])}function ringSegment(cx,cz,r2,thickness2,steps){const r0=r2-thickness2/2,r1=r2+thickness2/2,x0s=[],z0s=[],x1s=[],z1s=[];for(let i=0;i<=steps;i++){const a3=i/steps*2*Math.PI;x0s.push(cx+Math.cos(a3)*r0),z0s.push(cz+Math.sin(a3)*r0),x1s.push(cx+Math.cos(a3)*r1),z1s.push(cz+Math.sin(a3)*r1)}pushLineStrip(x0s,z0s,x1s,z1s)}const a2=W/2,b=L/2;{const x0s=[],z0s=[],x1s=[],z1s=[];for(let i=0;i<=64;i++){const theta=i/64*2*Math.PI,x=Math.cos(theta),z=Math.sin(theta);x0s.push(x*(a2-thickness/2)),z0s.push(z*(b-thickness/2)),x1s.push(x*(a2+thickness/2)),z1s.push(z*(b+thickness/2))}pushLineStrip(x0s,z0s,x1s,z1s)}const pts=[[-CS/2,-CS/2],[CS/2,-CS/2],[CS/2,CS/2],[-CS/2,CS/2]];for(let i=0;i<4;i++){const[x0,z0]=pts[i],[x1,z1]=pts[(i+1)%4];lineSegment(x0,z0,x1,z1,thickness)}function findValidArcAngles(goalZ){const towardCenter=goalZ>0?-1:1,validAngles=[];for(let i=0;i<=1e3;i++){const theta=-Math.PI+i/1e3*2*Math.PI,x=Math.sin(theta)*arcR,z=goalZ+towardCenter*Math.cos(theta)*arcR,normX=x/a2,normZ=z/b;normX*normX+normZ*normZ<=1&&validAngles.push(theta)}return validAngles.length===0?[-Math.PI/3,Math.PI/3]:[validAngles[0],validAngles[validAngles.length-1]]}for(let goalZ of[-L/2,L/2]){const towardCenter=goalZ>0?-1:1,[thetaStart,thetaEnd]=findValidArcAngles(goalZ),arcSteps=40,r0=arcR-thickness/2,r1=arcR+thickness/2,x0s=[],z0s=[],x1s=[],z1s=[];for(let i=0;i<=arcSteps;i++){const t=thetaStart+i/arcSteps*(thetaEnd-thetaStart),xInner=Math.sin(t)*r0,zInner=goalZ+towardCenter*Math.cos(t)*r0,xOuter=Math.sin(t)*r1,zOuter=goalZ+towardCenter*Math.cos(t)*r1;x0s.push(xInner),z0s.push(zInner),x1s.push(xOuter),z1s.push(zOuter)}pushLineStrip(x0s,z0s,x1s,z1s)}const GS_W=6.4,GS_L=9;for(let zSign of[-1,1]){const z=zSign*(L/2),z0=z,z1=z-zSign*GS_L,x0=-GS_W/2,x1=GS_W/2;lineSegment(x0,z0,x1,z0,thickness),lineSegment(x1,z0,x1,z1,thickness),lineSegment(x1,z1,x0,z1,thickness),lineSegment(x0,z1,x0,z0,thickness)}return ringSegment(0,0,3,thickness,48),ringSegment(0,0,10,thickness,64),lineSegment(-10,0,10,0,thickness),{vertices:new Float32Array(verts),indices:new Uint16Array(indices)}}function createFenceMesh(radiusX,radiusZ,offset=FENCE_PADDING,segments=128){const verts=[],indices=[],rX=radiusX+offset,rZ=radiusZ+offset,height=2.4,uScale=1/2;for(let i=0;i<=segments;i++){const theta=i/segments*2*Math.PI,x=Math.cos(theta)*rX,z=Math.sin(theta)*rZ,u=i*uScale;verts.push(x,0,z,u,1),verts.push(x,height,z,u,0)}for(let i=0;i<segments;i++){const base=i*2;indices.push(base,base+1,base+2),indices.push(base+2,base+1,base+3)}return{fenceVertices:new Float32Array(verts),fenceIndices:new Uint16Array(indices)}}function createStadiumMesh(rx0,rz0,rx1,rz1,h0,h1,segments=64){const verts=[],indices=[],avgRadius=(rx0+rz0+rx1+rz1)/4,uPerSegment=2*Math.PI*avgRadius/segments/3.2,vMax=Math.abs(h1-h0)/4.8;for(let i=0;i<=segments;i++){const theta=i/segments*2*Math.PI,cos=Math.cos(theta),sin=Math.sin(theta),x0=cos*rx0,z0=sin*rz0,x1=cos*rx1,z1=sin*rz1,u=i*uPerSegment;verts.push(x0,h0,z0,u,vMax),verts.push(x1,h1,z1,u,0)}for(let i=0;i<segments;i++){const base=i*2;indices.push(base,base+1,base+2),indices.push(base+2,base+1,base+3)}return{vertices:new Float32Array(verts),indices:new Uint16Array(indices)}}function createEllipticalStadiumRoofMesh(rx0,rz0,rx1,rz1,h1,segments=64){const verts=[],indices=[],h2=h1+5,h3=h2+4,rxMid=.5*(rx0+rx1),rzMid=.5*(rz0+rz1),rxInner=rxMid,rzInner=rzMid,tileU=3.2,tileV=4.8,avgRadius=.5*(rx1+rz1),uPerSegment=2*Math.PI*avgRadius/segments/tileU,vSlope=(h2-h1)/tileV,vDome=(h3-h2)/tileV;for(let i=0;i<=segments;i++){const theta=i/segments*2*Math.PI,cos=Math.cos(theta),sin=Math.sin(theta),u=i*uPerSegment,x1=cos*rx1,z1=sin*rz1,x2=cos*rxMid,z2=sin*rzMid,x3=cos*rxInner,z3=sin*rzInner;verts.push(x1,h1,z1,u,vSlope+vDome),verts.push(x2,h2,z2,u,vDome),verts.push(x3,h3,z3,u,0)}for(let i=0;i<segments;i++){const b=i*3;indices.push(b,b+1,b+3),indices.push(b+3,b+1,b+4),indices.push(b+1,b+2,b+4),indices.push(b+4,b+2,b+5)}return{vertices:new Float32Array(verts),indices:new Uint16Array(indices)}}function createAimTrajectoryMesh(start,velocity,gravity=-9.8,segments=32,width=.5){const verts=[],indices=[],y0=start[1],vy=velocity[1],g=gravity,disc=vy*vy-2*g*y0;if(disc<0)return{vertices:new Float32Array,indices:new Uint16Array};const t_flight=(-vy-Math.sqrt(disc))/g,dt=t_flight/segments,horizVel=[velocity[0],velocity[2]],horizLen=Math.hypot(...horizVel),nx=-horizVel[1]/horizLen,nz=horizVel[0]/horizLen;for(let i=0;i<=segments;i++){const t=i*dt,x=start[0]+velocity[0]*t,y=start[1]+velocity[1]*t+.5*g*t*t,z=start[2]+velocity[2]*t,taper=.2+.8*(t/t_flight),dynamicHalfW=width/2*taper,xL=x+nx*dynamicHalfW,zL=z+nz*dynamicHalfW,xR=x-nx*dynamicHalfW,zR=z-nz*dynamicHalfW;verts.push(xL,y,zL),verts.push(xR,y,zR)}const vertCount=verts.length/3;for(let i=0;i<vertCount-2;i+=2)indices.push(i,i+1,i+2),indices.push(i+2,i+1,i+3);return{vertices:new Float32Array(verts),indices:new Uint16Array(indices)}}const vertexSrc=`#version 300 es
    in vec3 a_position;
    in vec2 a_texcoord;
    uniform mat4 u_projection, u_view, u_model;
    out vec2 v_texcoord;
    void main() {
        gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
        v_texcoord = a_texcoord;
    }
`,fragSrc=`#version 300 es
precision mediump float;

uniform sampler2D u_texture;
uniform vec4 u_tileUV;
uniform bool u_tilingU;
uniform bool u_tilingV;
uniform vec4 u_tint;

in vec2 v_texcoord;
out vec4 outColor;

void main() {
    vec2 tileUV = v_texcoord;

    if (u_tilingU) tileUV.x = fract(tileUV.x);
    if (u_tilingV) tileUV.y = fract(tileUV.y);

    vec2 texCoord = mix(u_tileUV.xy, u_tileUV.zw, tileUV);

    vec2 texelSize = 1.0 / vec2(textureSize(u_texture, 0));
    vec2 epsilon = 0.5 * texelSize;
    texCoord = clamp(texCoord, u_tileUV.xy + epsilon, u_tileUV.zw - epsilon);

    vec4 texColor = texture(u_texture, texCoord);
    if (texColor.a < 0.01) discard;

    outColor = texColor * u_tint;
}
`,lineVertSrc=`#version 300 es
    in vec3 a_position;
    uniform mat4 u_projection;
    uniform mat4 u_view;
    uniform mat4 u_model;
    void main() {
        gl_Position = u_projection * u_view * u_model * vec4(a_position, 1.0);
    }`,lineFragSrc=`#version 300 es
    precision mediump float;
    uniform vec4 u_color;
    out vec4 out_color;
    void main() {
        out_color = u_color;
    }
`,SPRITE_WIDTH=16,SPRITE_HEIGHT=24,SHEET_WIDTH=512,SHEET_HEIGHT=768,SPRITE_PAD_X=0,SPRITE_PAD_Y=0,STRIDE_WIDTH=SPRITE_WIDTH+SPRITE_PAD_X,STRIDE_HEIGHT=SPRITE_HEIGHT+SPRITE_PAD_Y,FIELD_LENGTH=170,FIELD_RADIUS_X=80,FIELD_RADIUS_Z=FIELD_LENGTH/2;class Renderer{constructor(gl,canvas,spriteSheet){this.gl=gl,this.canvas=canvas,this.spriteSheet=spriteSheet,this.sheetCols=32,this.sheetRows=32,this.program=createShaderProgram(gl,vertexSrc,fragSrc),this.uProjection=gl.getUniformLocation(this.program,"u_projection"),this.uView=gl.getUniformLocation(this.program,"u_view"),this.uModel=gl.getUniformLocation(this.program,"u_model"),this.uTileUV=gl.getUniformLocation(this.program,"u_tileUV"),this.uTilingU=gl.getUniformLocation(this.program,"u_tilingU"),this.uTilingV=gl.getUniformLocation(this.program,"u_tilingV"),this.uTint=gl.getUniformLocation(this.program,"u_tint"),this.uTexture=gl.getUniformLocation(this.program,"u_texture"),this.aPos=gl.getAttribLocation(this.program,"a_position"),this.aUV=gl.getAttribLocation(this.program,"a_texcoord"),this.lineProgram=createShaderProgram(gl,lineVertSrc,lineFragSrc),this.lineProj=gl.getUniformLocation(this.lineProgram,"u_projection"),this.lineView=gl.getUniformLocation(this.lineProgram,"u_view"),this.lineModel=gl.getUniformLocation(this.lineProgram,"u_model"),this.linePos=gl.getAttribLocation(this.lineProgram,"a_position"),this.uLineColor=gl.getUniformLocation(this.lineProgram,"u_color"),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!0);const verts=new Float32Array([-.5,0,0,1,.5,0,1,1,.5,1,1,0,-.5,1,0,0]),indicesSprite=new Uint16Array([0,1,2,0,2,3]);this.quadVao=gl.createVertexArray(),gl.bindVertexArray(this.quadVao);const vboSprite=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vboSprite),gl.bufferData(gl.ARRAY_BUFFER,verts,gl.STATIC_DRAW),gl.vertexAttribPointer(this.aPos,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(this.aPos),gl.vertexAttribPointer(this.aUV,2,gl.FLOAT,!1,16,8),gl.enableVertexAttribArray(this.aUV);const eboSprite=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,eboSprite),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,indicesSprite,gl.STATIC_DRAW);const{vertices,indices}=createFieldEllipseMesh(FIELD_RADIUS_X,FIELD_RADIUS_Z,64,16);this.fieldVao=gl.createVertexArray(),gl.bindVertexArray(this.fieldVao);const vboField=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vboField),gl.bufferData(gl.ARRAY_BUFFER,vertices,gl.STATIC_DRAW),gl.vertexAttribPointer(this.aPos,3,gl.FLOAT,!1,20,0),gl.enableVertexAttribArray(this.aPos),gl.vertexAttribPointer(this.aUV,2,gl.FLOAT,!1,20,12),gl.enableVertexAttribArray(this.aUV);const eboField=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,eboField),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,indices,gl.STATIC_DRAW),this.fieldIndices=indices.length,this.fieldLineMesh=createFieldLineMesh(),this.lineVao=gl.createVertexArray(),gl.bindVertexArray(this.lineVao);const vboLine=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vboLine),gl.bufferData(gl.ARRAY_BUFFER,this.fieldLineMesh.vertices,gl.STATIC_DRAW);const eboLine=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,eboLine),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.fieldLineMesh.indices,gl.STATIC_DRAW),gl.vertexAttribPointer(this.linePos,3,gl.FLOAT,!1,12,0),gl.enableVertexAttribArray(this.linePos),this.goalPostPositions=[...GOAL_POSTS.Away.map(p=>[p[0],p[1],p[2]-FIELD_RADIUS_Z]),...GOAL_POSTS.Home.map(p=>[p[0],p[1],p[2]-FIELD_RADIUS_Z])];const{fenceVertices,fenceIndices}=createFenceMesh(FIELD_RADIUS_X,FIELD_RADIUS_Z);this.fenceVao=gl.createVertexArray(),gl.bindVertexArray(this.fenceVao);const vbo=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vbo),gl.bufferData(gl.ARRAY_BUFFER,fenceVertices,gl.STATIC_DRAW),gl.vertexAttribPointer(this.aPos,3,gl.FLOAT,!1,20,0),gl.enableVertexAttribArray(this.aPos),gl.vertexAttribPointer(this.aUV,2,gl.FLOAT,!1,20,12),gl.enableVertexAttribArray(this.aUV);const ebo=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,ebo),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,fenceIndices,gl.STATIC_DRAW),this.fenceIndices=fenceIndices.length;const radiusFenceX=FENCE_RADIUS_X,radiusFenceZ=FENCE_RADIUS_Z,stadiumMesh=createStadiumMesh(radiusFenceX+.5,radiusFenceZ+.5,radiusFenceX+30,radiusFenceZ+30,0,20);this.stadiumVao=gl.createVertexArray(),gl.bindVertexArray(this.stadiumVao);const vboStadium=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vboStadium),gl.bufferData(gl.ARRAY_BUFFER,stadiumMesh.vertices,gl.STATIC_DRAW),gl.vertexAttribPointer(this.aPos,3,gl.FLOAT,!1,20,0),gl.enableVertexAttribArray(this.aPos),gl.vertexAttribPointer(this.aUV,2,gl.FLOAT,!1,20,12),gl.enableVertexAttribArray(this.aUV);const eboStadium=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,eboStadium),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,stadiumMesh.indices,gl.STATIC_DRAW),this.stadiumIndices=stadiumMesh.indices.length;const roofMesh=createEllipticalStadiumRoofMesh(radiusFenceX+.5,radiusFenceZ+.5,radiusFenceX+30,radiusFenceZ+30,20);this.stadiumRoofVao=gl.createVertexArray(),gl.bindVertexArray(this.stadiumRoofVao);const vboRoof=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vboRoof),gl.bufferData(gl.ARRAY_BUFFER,roofMesh.vertices,gl.STATIC_DRAW),gl.vertexAttribPointer(this.aPos,3,gl.FLOAT,!1,20,0),gl.enableVertexAttribArray(this.aPos),gl.vertexAttribPointer(this.aUV,2,gl.FLOAT,!1,20,12),gl.enableVertexAttribArray(this.aUV);const eboRoof=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,eboRoof),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,roofMesh.indices,gl.STATIC_DRAW),this.stadiumRoofIndices=roofMesh.indices.length,gl.bindVertexArray(null),this.trajVao=gl.createVertexArray(),this.trajVbo=gl.createBuffer(),this.trajEbo=gl.createBuffer();const maxPoints=128;gl.bindVertexArray(this.trajVao),gl.bindBuffer(gl.ARRAY_BUFFER,this.trajVbo);const maxVertices=maxPoints*2;gl.bufferData(gl.ARRAY_BUFFER,maxVertices*12,gl.DYNAMIC_DRAW),gl.vertexAttribPointer(this.linePos,3,gl.FLOAT,!1,12,0),gl.enableVertexAttribArray(this.linePos),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.trajEbo),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,6*(maxPoints-1)*Uint16Array.BYTES_PER_ELEMENT,gl.DYNAMIC_DRAW),gl.pixelStorei(gl.UNPACK_ALIGNMENT,1),gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1),this.texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,this.texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this.spriteSheet),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,this.texture),gl.enable(gl.DEPTH_TEST),gl.depthFunc(gl.LEQUAL),this.fovy=45*Math.PI/180,this.projection=create$3(),this.view=create$3(),this.model=create$3(),this.updateProjection()}updateProjection(){this.projection=create$3(),perspective(this.projection,this.fovy,this.canvas.width/this.canvas.height,.1,1e3)}renderSprite(pos,width,height,col,row,tint=[1,1,1,1],flags=0){const{gl,program,quadVao,uModel,uTileUV,sheetCols,sheetRows}=this;gl.useProgram(program),gl.bindVertexArray(quadVao);const model=create$3();translate(model,model,pos),flags&ANIM_FLAG_FLAT&&rotateX(model,model,-Math.PI/2);const scale2=[width,height,1];flags&ANIM_FLAG_SQUASH&&(scale2[1]*=.9,translate(model,model,[0,-.05,0])),scale$1(model,model,scale2),gl.uniformMatrix4fv(uModel,!1,model),this.setTileUV(col,row),gl.uniform1i(this.uTilingU,0),gl.uniform1i(this.uTilingV,0),tint?gl.uniform4f(this.uTint,tint[0],tint[1],tint[2],tint[3]):gl.uniform4f(this.uTint,1,1,1,1),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)}setTileUV(col,row,tileWidthPx=SPRITE_WIDTH,tileHeightPx=SPRITE_HEIGHT){const u0=(col*STRIDE_WIDTH+SPRITE_PAD_X/2)/SHEET_WIDTH,v0=(row*STRIDE_HEIGHT+SPRITE_PAD_Y/2)/SHEET_HEIGHT,u1=(col*STRIDE_WIDTH+SPRITE_PAD_X/2+tileWidthPx)/SHEET_WIDTH,v1=(row*STRIDE_HEIGHT+SPRITE_PAD_Y/2+tileHeightPx)/SHEET_HEIGHT;this.gl.uniform4f(this.uTileUV,u0,v0,u1,v1)}getApproxVisibleFieldWidthAtZ(cameraPos,zWorld){const aspect=this.canvas.width/this.canvas.height,fov=Math.PI/4;return 2*(cameraPos[2]-zWorld)*Math.tan(fov/2)*aspect}renderScene(game,entities){const gl=this.gl;gl.viewport(0,0,this.canvas.width,this.canvas.height),gl.clearColor(.2,.6,.2,1),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),lookAt(this.view,game.cameraPos,game.cameraTarget,[0,1,0]),gl.useProgram(this.program),gl.uniformMatrix4fv(this.uProjection,!1,this.projection),gl.uniformMatrix4fv(this.uView,!1,this.view),gl.uniform4f(this.uTint,1,1,1,1),gl.activeTexture(gl.TEXTURE0),gl.uniform1i(this.uTexture,0),gl.bindVertexArray(this.fieldVao),identity(this.model),translate(this.model,this.model,[0,0,FIELD_RADIUS_Z]),gl.uniformMatrix4fv(this.uModel,!1,this.model),this.setTileUV(0,2),gl.uniform1i(this.uTilingU,1),gl.uniform1i(this.uTilingV,1),gl.drawElements(gl.TRIANGLES,this.fieldIndices,gl.UNSIGNED_SHORT,0),gl.enable(gl.CULL_FACE),gl.cullFace(gl.FRONT),gl.frontFace(gl.CCW),gl.uniformMatrix4fv(this.uModel,!1,this.model),gl.bindVertexArray(this.stadiumVao),this.setTileUV(7,2),gl.uniform1i(this.uTilingU,1),gl.uniform1i(this.uTilingV,1),gl.drawElements(gl.TRIANGLES,this.stadiumIndices,gl.UNSIGNED_SHORT,0),this.setTileUV(8,2),gl.uniform1i(this.uTilingU,1),gl.uniform1i(this.uTilingV,1),gl.bindVertexArray(this.stadiumRoofVao),gl.drawElements(gl.TRIANGLES,this.stadiumRoofIndices,gl.UNSIGNED_SHORT,0),gl.disable(gl.CULL_FACE),gl.bindVertexArray(this.fenceVao),this.setTileUV(3,2,48,24),gl.uniform1i(this.uTilingU,1),gl.uniform1i(this.uTilingV,0),gl.drawElements(gl.TRIANGLES,this.fenceIndices,gl.UNSIGNED_SHORT,0),gl.useProgram(this.lineProgram),gl.uniform4f(this.uLineColor,1,1,1,1),gl.uniformMatrix4fv(this.lineProj,!1,this.projection),gl.uniformMatrix4fv(this.lineView,!1,this.view);const model=create$3();translate(model,this.model,[0,.01,0]),gl.uniformMatrix4fv(this.lineModel,!1,model),gl.bindVertexArray(this.lineVao),gl.drawElements(gl.TRIANGLES,this.fieldLineMesh.indices.length,gl.UNSIGNED_SHORT,0),gl.useProgram(this.program),gl.uniform4f(this.uTint,1,1,1,1),gl.bindVertexArray(this.quadVao),this.setTileUV(1,2),gl.uniform1i(this.uTilingU,0),gl.uniform1i(this.uTilingV,1);for(let i=0;i<this.goalPostPositions.length;i++){const[x,y,z]=this.goalPostPositions[i],baseHeight=i%4===0||i%4===3?6:10,dx=game.cameraPos[0]-x,dz=game.cameraPos[2]-(z+FIELD_RADIUS_Z),dist2=Math.sqrt(dx*dx+dz*dz),scaleLOD=dist2>50?1.5:dist2>150?2:1,postModel=clone(this.model);translate(postModel,postModel,[x,y,z]),scale$1(postModel,postModel,[scaleLOD,baseHeight,1]),gl.uniformMatrix4fv(this.uModel,!1,postModel),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)}gl.bindVertexArray(this.quadVao);for(const entity of entities)entity instanceof Entity&&entity.render(this);if(game.ball.carrier){const carrier=game.ball.carrier,teamTint=carrier.actionState==="tackled"?[1,0,0,1]:[1,1,1,1],bob=.2*Math.sin(performance.now()/200),pos=[carrier.pos[0],carrier.pos[1]+2.4*carrier.statsHeight/1.75+.2+bob,carrier.pos[2]];this.renderSprite(pos,1,2.4,carrier.team==="away"?5:6,3,teamTint,0)}const aimTarget=game.controls.getState().aimTarget;if(game.player&&game.aimTarget.render(this),game.currentContest&&game.currentContest.handTarget&&game.handAimTarget.render(this),game.player&&game.ball.carrier===game.player&&game.player.actionState==="run"&&game.controls.state.kickAimActive&&aimTarget!==null){const wiggleAim=oscillateAimTarget(aimTarget,performance.now()/1e3,.15,2,game.player.statsKickRange),vel=computeKickVelocity(game.player,wiggleAim,!1);if(!vel)return;const pos=game.player.pos.c,mesh=createAimTrajectoryMesh(pos,vel,-9.8,32);gl.useProgram(this.lineProgram);const[r2,g,b,a2]=game.aimTarget.tint;gl.uniform4f(this.uLineColor,r2,g,b,a2),gl.uniformMatrix4fv(this.lineProj,!1,this.projection),gl.uniformMatrix4fv(this.lineView,!1,this.view);const model2=create$3();translate(model2,model2,[0,.01,0]),gl.uniformMatrix4fv(this.lineModel,!1,model2),gl.bindVertexArray(this.trajVao),gl.bindBuffer(gl.ARRAY_BUFFER,this.trajVbo),gl.bufferSubData(gl.ARRAY_BUFFER,0,mesh.vertices),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.trajEbo),gl.bufferSubData(gl.ELEMENT_ARRAY_BUFFER,0,mesh.indices),gl.drawElements(gl.TRIANGLES,mesh.indices.length,gl.UNSIGNED_SHORT,0)}}}class Vec22 extends Array{constructor(vec=[0,0]){super(),this[0]=vec[0],this[1]=vec[1]}equals(vec){return this.length===vec.length&&this[0]===vec[0]&&this[1]===vec[1]}static random(vec){return new Vec22(getRandomPos(vec[0],vec[1]))}add(vec){return new Vec22([this[0]+vec[0],this[1]+vec[1]])}sub(vec){return new Vec22([this[0]-vec[0],this[1]-vec[1]])}floor(){return new Vec22([Math.floor(this[0]),Math.floor(this[1])])}ceil(){return new Vec22([Math.floor(this[0]),Math.floor(this[1])])}scale(scalar){return new Vec22([this[0]*scalar,this[1]*scalar])}mul(vec){return new Vec22([this[0]*vec[0],this[1]*vec[1]])}div(vec){return new Vec22([this[0]/vec[0],this[1]/vec[1]])}dot(vec){return this[0]*vec[0]+this[1]*vec[1]}dist(vec){return Math.hypot(this[0]-vec[0],this[1]-vec[1])}abs(){return new Vec22([Math.abs(this[0]),Math.abs(this[1])])}sum(){return this[0]+this[1]}relativeTo(rect){return this.sub(rect.pos).div(rect.size)}absoluteFrom(rect){return this.mul(rect.size).add(rect.pos)}relativeToPS(pos,sz){return this.sub(pos).scale(1/sz)}absoluteFromPS(pos,sz){return this.scale(sz).add(pos)}set x(val){this[0]=val}set y(val){this[1]=val}get x(){return this[0]}get y(){return this[1]}}class Rect extends Array{constructor(rect=null){if(super(),rect===null){this[0]=0,this[1]=0,this[2]=0,this[3]=0;return}this[0]=rect[0],this[1]=rect[1],this[2]=rect[2],this[3]=rect[3]}set x(val){this[0]=val}set y(val){this[1]=val}set w(val){this[2]=val}set h(val){this[3]=val}set pos(vec){this[0]=vec[0],this[1]=vec[1]}set size(vec){this[2]=vec[0],this[3]=vec[1]}get size(){return new Vec22([this[2],this[3]])}get pos(){return new Vec22([this[0],this[1]])}get x(){return this[0]}get y(){return this[1]}get w(){return this[2]}get h(){return this[3]}get right(){return this[0]+this[2]}get bottom(){return this[1]+this[3]}get center_x(){return this[0]+this[2]/2}get center_y(){return this[1]+this[3]/2}get center(){return new Vec22([this.center_x,this.center_y])}grow(amount){return new Rect([this[0]-amount,this[1]-amount,this[2]+2*amount,this[3]+2*amount])}get flooredCenter(){return new Vec22([Math.floor(this[0]+this[2]/2),Math.floor(this[1]+this[3]/2)])}translate(pos){return new Rect([this.x+pos[0],this.y+pos[1],this.w,this.h])}shrinkBorders(value){return new Rect([this.x+value,this.y+value,this.w-value*2,this.h-value*2])}scaleBorders(scale2){return new Rect([this.x+this.w*(1-scale2)/2,this.y+this.h*(1-scale2)/2,this.w*scale2,this.h*scale2])}mult(scalar){return new Rect([this[0]*scalar,this[1]*scalar,this[2]*scalar,this[3]*scalar])}multXY(vec){return new Rect([this[0]*vec[0],this[1]*vec[1],this[2]*vec[0],this[3]*vec[1]])}scale(scalar,centered=!0){if(centered){let news=[this[2]*scalar,this[3]*scalar];return new Rect([this[0]+.5*(this[2]-news[0]),this[1]+.5*(this[3]-news[1]),news[0],news[1]])}else{let news=[this[2]*scalar,this[3]*scalar];return new Rect([this[0],this[1],news[0],news[1]])}}collideRadius(rect,radius=null){let d=[this.center_x-rect.center_x,this.center_y-rect.center_y];return radius===null&&(radius=Math.min(this.w,this.h,rect.w,rect.h)/2),d[0]*d[0]+d[1]*d[1]<radius*radius}collide(rect){return this.x<rect.x+rect.w&&this.x+this.w>rect.x&&this.y<rect.y+rect.h&&this.h+this.y>rect.y}contains(rect){return this.x<=rect.x&&this.y<=rect.y&&this.x+this.w>=rect.x+rect.w&&this.y+this.h>=rect.y+rect.h}contact(rect){return this.x<=rect.x+rect.w&&this.x+this.w>=rect.x&&this.y<=rect.y+rect.h&&this.h+this.y>=rect.y}contactRadius(rect,radius=null){let d=[this.center_x-rect.center_x,this.center_y-rect.center_y];return radius===null&&(radius=Math.min(this.w,this.h,rect.w,rect.h)),d[0]*d[0]+d[1]*d[1]<=radius*radius}}class Grid2D extends Array{constructor(tileDim=[0,0],initialData=void 0){initialData===void 0?super(tileDim[0]*tileDim[1]):super(...initialData),this.tileDim=new Vec22(tileDim),this.hidden=!1,this._cacheData=null}clone(){return new Grid2D(this.tileDim,this)}get(pos){return this[pos[0]+pos[1]*this.tileDim[0]]}set(pos,val){this[pos[0]+pos[1]*this.tileDim[0]]=val}*iterBetween(pos1,pos2,tol=0){var x1,y1,x2,y2;if([x1,y1]=pos1,[x2,y2]=pos2,!(Math.abs(y2-y1)==0&&Math.abs(x2-x1)==0))if(Math.abs(y2-y1)>Math.abs(x2-x1)){var slope=(x2-x1)/(y2-y1);if(y1>y2)for(var y=y1;y>=y2;y--){var xa=x1+(y-y1)*slope;yield[xa,y]}else for(var y=y1;y<=y2;y++){var xa=x1+(y-y1)*slope;yield[xa,y]}}else{var slope=(y2-y1)/(x2-x1);if(x1>x2)for(var x=x1;x>=x2;x--){var ya=y1+(x-x1)*slope;yield[x,ya]}else for(var x=x1;x<=x2;x++){var ya=y1+(x-x1)*slope;yield[x,ya]}}}*iterInBetween(pos1,pos2){var x1,y1,x2,y2;if([x1,y1]=pos1,[x2,y2]=pos2,!(Math.abs(y2-y1)==0&&Math.abs(x2-x1)==0))if(Math.abs(y2-y1)>Math.abs(x2-x1)){var slope=(x2-x1)/(y2-y1);if(y1>y2)for(var y=y1-1;y>y2;y--){var x=Math.round(x1+(y-y1)*slope);yield[x,y]}else for(var y=y1+1;y<y2;y++){var x=Math.round(x1+(y-y1)*slope);yield[x,y]}}else{var slope=(y2-y1)/(x2-x1);if(x1>x2)for(var x=x1-1;x>x2;x--){var y=Math.round(y1+(x-x1)*slope);yield[x,y]}else for(var x=x1+1;x<x2;x++){var y=Math.round(y1+(x-x1)*slope);yield[x,y]}}}*iterTypesBetween(pos1,pos2,types){for(var pos of this.iterBetween(pos1,pos2))types.includes(this.get(pos))&&(yield pos)}*iterTypesInBetween(pos1,pos2,types){for(var pos of this.iterInBetween(pos1,pos2))types.includes(this.get(pos))&&(yield pos)}hasTypesBetween(pos1,pos2,types){for(var pos of this.iterTypesBetween(pos1,pos2,types))return!0;return!1}hasTypesInBetween(pos1,pos2,types){for(var pos of this.iterTypesInBetween(pos1,pos2,types))return!0;return!1}*iterAll(sub_rect=null){const[tw,th]=this.tileDim;if(sub_rect!==null)for(var y=sub_rect[1];y<Math.min(th,sub_rect[1]+sub_rect[3]);y++)for(var x=sub_rect[0];x<Math.min(tw,sub_rect[0]+sub_rect[2]);x++)yield[x,y];else for(var y=0;y<th;y++)for(var x=0;x<tw;x++)yield[x,y]}*iterTypes(types,sub_rect){for(var pos of this.iterAll(sub_rect))types.includes(this.get(pos))&&(yield pos)}*iterAdjacent(pos,diagonal=!1){pos=new Vec22(pos);const dirs=diagonal?[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]]:[[0,-1],[1,0],[0,1],[-1,0]];for(let dir of dirs){const npos=pos.add(dir);npos[0]>=0&&npos[0]<this.tileDim[0]&&npos[1]>=0&&npos[1]<this.tileDim[1]&&(yield npos)}}hasAdjacent(pos,types,diagonal=!1){for(let npos of this.iterAdjacent(pos,diagonal))if(types.includes(this.get(npos)))return!0;return!1}*iterInRange(pos,radius){var x,y;[x,y]=pos;const[tw,th]=this.tileDim;radius==null&&(radius=3);for(var rad=Math.ceil(radius),yoff=-rad;yoff<rad+1;yoff++)for(var xoff=-rad;xoff<rad+1;xoff++)if(xoff*xoff+yoff*yoff<=radius*radius){var x0=x+xoff,y0=y+yoff;0<=y0&&y0<th&&0<=x0&&x0<tw&&(yield[x0,y0])}}*iterTypesInRange(pos,types,radius,blocker_types=null){for(var pos0 of this.iterInRange(pos,radius))blocker_types!==null&&this.hasTypesBetween(pos,pos0,blocker_types)||types.includes(this.get(pos0))&&(yield pos0)}numInRange(pos,types,radius,blocker_types=null){var num=0;for(var pos0 of this.iterTypesInRange(pos,types,radius,blocker_types))num++;return num}*iterRectBoundary(rect){const[tw,th]=this.tileDim;let xl=Math.min(Math.max(rect.x,0),tw),xu=Math.min(Math.max(rect.x+rect.w,0),tw),yl=Math.min(Math.max(rect.y,0),th),yu=Math.min(Math.max(rect.y+rect.h,0),th);for(let x0=xl;x0<xu;x0++)yield[x0,yl];for(let x0=xl;x0<xu;x0++)yield[x0,yu];for(let y0=yl;y0<yu;y0++)yield[xl,y0];for(let y0=yl;y0<yu;y0++)yield[xu,y0]}*iterRect(rect,mustFit=!0){const[tw,th]=this.tileDim;if(rect instanceof Rect||(rect=new Rect(rect)),mustFit&&(rect.x<0||rect.y<0||rect.right>tw||rect.bottom>th))return;let xl=Math.max(rect.x,0),xu=Math.min(rect.x+rect.w,tw),yl=Math.max(rect.y,0),yu=Math.min(rect.y+rect.h,th);for(let y0=yl;y0<yu;y0++)for(let x0=xl;x0<xu;x0++)yield[x0,y0]}numInRect(rect,targets,mustFit=!0){let num=0;for(var pos of this.iterRect(rect,mustFit))targets.includes(this.get(pos))&&num++;return num}}const minFontSize$1=8,scaleFactor$1=48*(1/window.devicePixelRatio||1);function sizeText(ctx,text,size,fontName,centered,rect,color){let scale2=1;size<minFontSize$1&&(scale2=1/scaleFactor$1,ctx.save(),ctx.scale(scale2,scale2)),ctx.fillStyle=color,ctx.font=(size>=minFontSize$1?size:Math.ceil(size/scale2))+"px "+fontName,rect.x;let w=scale2*ctx.measureText(text).width;return size<minFontSize$1&&ctx.restore(),[w,2*size]}function getTextData(ctx,text,size,fontName,halign,valign,rect,color){let scale2=1;size<minFontSize$1&&(scale2=1/scaleFactor$1,ctx.save(),ctx.scale(scale2,scale2)),ctx.fillStyle=color,ctx.font=(size>=minFontSize$1?size:Math.ceil(size/scale2))+"px "+fontName;let textX=rect.x,metrics=ctx.measureText(text),textY=rect.y;switch(halign){case"left":break;case"center":textX+=(rect.w-scale2*metrics.width)/2;break;case"right":textX+=rect.w-scale2*metrics.width;break}switch(valign){case"top":break;case"middle":textY+=rect.h/2;break;case"bottom":textY+=rect.h;break}let textData={outText:[[text,textX/scale2,textY/scale2]],color,fontName,size,valign};return size<minFontSize$1&&ctx.restore(),textData}function drawText(ctx,textData,color=null){let scale2=1,size=textData.size;switch(color==null&&(color=textData.color),size<minFontSize$1&&(scale2=1/scaleFactor$1,ctx.save(),ctx.scale(scale2,scale2)),textData.valign){case"top":ctx.textBaseline="top";break;case"middle":ctx.textBaseline="middle";break;case"bottom":ctx.textBaseline="bottom";break}ctx.fillStyle=color,ctx.font=(size>=minFontSize$1?size:Math.ceil(size/scale2))+"px "+textData.fontName;let[t,x,y]=textData.outText[0];ctx.fillText(t,x,y),size<minFontSize$1&&ctx.restore()}function sizeWrappedText(ctx,text,size,fontName,centered,rect,color,wordwrap=!0){if(!text)return[rect.w,size];let scale2=1;size<minFontSize$1&&(scale2=1/scaleFactor$1,ctx.save(),ctx.scale(scale2,scale2)),ctx.font=(size>=minFontSize$1?size:Math.ceil(size/scale2))+"px "+fontName;let h=0,paraText="",guess=Math.min(Math.max(1,Math.ceil(text.length*(rect.w/(ctx.measureText(text).width||1))/scale2)),text.length);for(;text!==""||paraText!=="";){if(paraText===""){const n=text.indexOf(`
`);n>=0?(paraText=text.slice(0,n),text=text.slice(n+1)):(paraText=text,text="")}guess=Math.max(1,Math.min(guess,paraText.length));let nextLine=paraText.slice(0,guess),w=scale2*ctx.measureText(nextLine).width;if(w>rect.w&&guess>1)for(;w>rect.w&&guess>1;)guess--,nextLine=paraText.slice(0,guess),w=scale2*ctx.measureText(nextLine).width;if(w<rect.w&&guess<paraText.length){for(;w<rect.w&&guess<paraText.length;)guess++,nextLine=paraText.slice(0,guess),w=scale2*ctx.measureText(nextLine).width;w>rect.w&&guess--}if(wordwrap&&guess>0){const lastChar=nextLine.at?nextLine.at(-1)??"":nextLine[nextLine.length-1]??"",nextChar=guess<paraText.length?paraText[guess]:" ",isSpace=(c=>c===" "||c==="	");if(!isSpace(lastChar)&&!isSpace(nextChar)){const lastSpace=Math.max(nextLine.lastIndexOf(" "),nextLine.lastIndexOf("	"));lastSpace>=0&&(guess-=nextLine.length-lastSpace-1)}}guess=Math.max(1,guess),nextLine=paraText.slice(0,guess),paraText=paraText.slice(guess),wordwrap&&(paraText=paraText.trimStart()),h+=size,guess=Math.min(guess,Math.max(1,paraText.length))}return h+=size,size<minFontSize$1&&ctx.restore(),[rect.w,h]}function getWrappedTextData(ctx,text,size,fontName,halign,valign,rect,color,wordwrap=!0){let scale2=1;size<minFontSize$1&&(scale2=1/scaleFactor$1,ctx.save(),ctx.scale(scale2,scale2)),ctx.fillStyle=color,ctx.font=(size>=minFontSize$1?size:Math.ceil(size/scale2))+"px "+fontName;let y=rect.y;const outText=[];let paraText="";const totalW=ctx.measureText(text).width||1;let guess=Math.min(Math.max(1,Math.ceil(text.length*(rect.w/totalW/scale2))),Math.max(1,text.length));for(;text!==""||paraText!=="";){if(paraText===""){const n=text.indexOf(`
`);n>=0?(paraText=text.slice(0,n),text=text.slice(n+1)):(paraText=text,text="")}guess=Math.max(1,Math.min(guess,paraText.length));let nextLine=paraText.slice(0,guess),w=scale2*ctx.measureText(nextLine).width;if(w>rect.w&&guess>1)for(;w>rect.w&&guess>1;)guess--,nextLine=paraText.slice(0,guess),w=scale2*ctx.measureText(nextLine).width;if(w<rect.w&&guess<paraText.length){for(;w<rect.w&&guess<paraText.length;)guess++,nextLine=paraText.slice(0,guess),w=scale2*ctx.measureText(nextLine).width;w>rect.w&&guess--}if(wordwrap&&guess<paraText.length&&guess>0){const lastChar=nextLine.at?nextLine.at(-1)??"":nextLine[nextLine.length-1]??"",nextChar=guess<paraText.length?paraText[guess]:" ",isSpace=(c=>c===" "||c==="	");if(!isSpace(lastChar)&&!isSpace(nextChar)){const lastSpace=Math.max(nextLine.lastIndexOf(" "),nextLine.lastIndexOf("	"));lastSpace>=0&&(guess-=nextLine.length-lastSpace-1)}}guess=Math.max(1,Math.min(guess,paraText.length)),nextLine=paraText.slice(0,guess),paraText=paraText.slice(guess),wordwrap&&(paraText=paraText.trimStart()),w=scale2*ctx.measureText(nextLine).width;let x=rect.x;switch(halign){case"center":x+=(rect.w-w)/2;break;case"right":x+=rect.w-w;break}outText.push([nextLine,x/scale2,y/scale2]),y+=size,guess=Math.min(guess,Math.max(1,paraText.length))}const h=y-rect.y;let off=0;switch(valign){case"middle":off=(rect.h-h)/2+size/2;break;case"bottom":off=rect.h-h+size;break;case"top":default:off=0;break}const textData={size,fontName,outText,off:off/scale2,color,valign};return size<minFontSize$1&&ctx.restore(),textData}function drawWrappedText(ctx,textData,color=null){let scale2=1,size=textData.size;switch(color===null&&(color=textData.color),size<minFontSize$1&&(scale2=1/scaleFactor$1,ctx.save(),ctx.scale(scale2,scale2)),textData.valign){case"top":ctx.textBaseline="top";break;case"middle":ctx.textBaseline="middle";break;case"bottom":ctx.textBaseline="bottom";break}ctx.fillStyle=color,ctx.font=(size>=minFontSize$1?size:Math.ceil(size/scale2))+"px "+textData.fontName;for(let tdat of textData.outText)ctx.fillText(tdat[0],tdat[1],tdat[2]+(textData.off??0));size<minFontSize$1&&ctx.restore()}const clamp=(num,min,max)=>Math.min(Math.max(num,min),max);function dist(pos1,pos2){return new Vec22(pos1).dist(pos2)}function colorString(vec){let r2,g,b;return[r2,g,b]=new MathArray(vec).scale(255).map(x=>Math.floor(x)),"#"+r2.toString(16).padStart(2,"0")+g.toString(16).padStart(2,"0")+b.toString(16).padStart(2,"0")}class MathArray extends Array{constructor(...arr){arr.length==1&&arr[0]instanceof Array?super(...arr[0]):super(...arr)}static asRandomFloats(size,low=0,high=1){let a2=new MathArray(size);for(let i=0;i<a2.length;i++)a2[i]=randomFloat(low,high);return a2}sum(){let s=0;return this.forEach(el=>s+=el),s}mean(){return this.sum()/this.length}max(){return Math.max.apply(null,this)}min(){return Math.min.apply(null,this)}vars(){let s=0;return this.forEach(el=>s+=el*el),(s-this.length*this.mean()^2)/(this.length-1)}var(){let s=0;return this.forEach(el=>s+=el*el),s/this.length-this.mean()^2}std(){return Math.sqrt(this.var())}add(arr2){let a2=new MathArray(this);if(arr2 instanceof Array)for(let i=0;i<this.length;i++)a2[i]+=arr2[i];else for(let i=0;i<this.length;i++)a2[i]+=arr2;return a2}mul(arr2){let a2=new MathArray(this);if(arr2 instanceof Array)for(let i=0;i<this.length;i++)a2[i]*=arr2[i];else for(let i=0;i<this.length;i++)a2[i]*=arr2;return a2}scale(scalar){const arr=Array();for(let val of this)arr.push(val*scalar);return arr}dot(arr2){return this.mul(arr2).sum()}abs(){return Math.abs.apply(null,this)}lag(k){let a2=new MathArray;for(let i=-k;i<this.length-k;i++)i<0||i>=this.length?a2.push(NaN):a2.push(this[i]);return a2}filter(func){return new MathArray(super.filter(func))}dropNaN(){return this.filter(el=>!Number.isNaN(el))}}class Touch{constructor(props={}){__publicField(this,"identifier",-1);__publicField(this,"pos",[0,0]);__publicField(this,"state","touch_up");__publicField(this,"device","touch");__publicField(this,"nativeObject",null);__publicField(this,"nativeEvent",null);for(let p in props)this[p]=props[p]}copy(){return new Touch({pos:[...this.pos],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}asChildTouch(widget){return new Touch({pos:[...widget.toChild(this.pos)],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}get rect(){return new Rect([...this.pos,0,0])}set x(value){this.pos[0]=value}set y(value){this.pos[1]=value}get x(){return this.pos[0]}get y(){return this.pos[1]}get grabbed(){return App.get().inputHandler.grabbed}grab(widget){App.get().inputHandler.grab(widget)}ungrab(){App.get().inputHandler.ungrab()}}class InputHandler{constructor(app){__publicField(this,"grabbed",null);__publicField(this,"mouseTouchEmulation",!0);__publicField(this,"mouseev",null);__publicField(this,"keyStates",{});__publicField(this,"focusedWidget",null);__publicField(this,"_connectedGamepads",new Set);__publicField(this,"_gamepadButtonState",new Map);__publicField(this,"_gamepadAxisState",new Map);__publicField(this,"_gamepadDigitalState",new Map);__publicField(this,"gamepadRepeatDelay",250);__publicField(this,"gamepadRepeatInterval",150);__publicField(this,"gamepadAxisThreshold",.5);this.app=app,this.canvas=app.canvas;let canvas=this.canvas,that=this;if(document.addEventListener("keydown",function(ev){that.process_key(ev,"key_down")},!0),document.addEventListener("keyup",function(ev){that.process_key(ev,"key_up")},!0),canvas.addEventListener("mousedown",function(ev){that.process_mouse(ev,"mouse_down")},!0),canvas.addEventListener("mousemove",function(ev){that.process_mouse(ev,"mouse_move")},!0),canvas.addEventListener("mouseout",function(ev){that.process_mouse(ev,"mouse_cancel")},!0),canvas.addEventListener("mouseup",function(ev){that.process_mouse(ev,"mouse_up")},!0),canvas.addEventListener("touchstart",function(ev){that.process_touch(ev,"touch_down")},!1),canvas.addEventListener("touchmove",function(ev){that.process_touch(ev,"touch_move")},!1),canvas.addEventListener("touchcancel",function(ev){that.process_touch(ev,"touch_cancel")},!1),canvas.addEventListener("touchend",function(ev){that.process_touch(ev,"touch_up")},!1),canvas.addEventListener("wheel",function(ev){that.process_wheel(ev,"wheel")},!0),window.history.replaceState(null,document.title,location.pathname+"#!/backbutton"),window.history.pushState(null,document.title,location.pathname),window.addEventListener("popstate",function(ev){that.process_back(ev,"back_button")},!1),window.addEventListener("gamepadconnected",ev=>{this._connectedGamepads.add(ev.gamepad.index),this.onFocusScopeChanged()}),window.addEventListener("gamepaddisconnected",ev=>{this._connectedGamepads.delete(ev.gamepad.index)}),typeof navigator<"u"&&typeof navigator.getGamepads=="function"){const pads=navigator.getGamepads();if(pads)for(const gp of pads)gp&&this._connectedGamepads.add(gp.index)}this.onFocusScopeChanged()}grab(widget){this.grabbed=widget}ungrab(){this.grabbed=null}isKeyUp(key){return key in this.keyStates&&this.keyStates[key]}isKeyDown(key){return key in this.keyStates&&this.keyStates[key]}process_key(ev,name){this.app.requestFrameUpdate();const oldKeyState=this.keyStates[ev.key];name==="key_up"?this.keyStates[ev.key]=!1:name==="key_down"&&(this.keyStates[ev.key]=!0);let handled=!1;name==="key_down"&&(handled=this.handleKeyDown(ev)),handled&&ev.preventDefault(),this.app.emit(name,{states:this.keyStates,oldState:oldKeyState,event:ev})}handleKeyDown(ev){const target=ev.target,isTextTarget=target instanceof HTMLInputElement||target instanceof HTMLTextAreaElement;if(isTextTarget&&["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(ev.key))return!1;switch(ev.key){case"Tab":return this.moveFocusSequential(ev.shiftKey?-1:1);case"ArrowLeft":return this.moveFocus("left");case"ArrowRight":return this.moveFocus("right");case"ArrowUp":return this.moveFocus("up");case"ArrowDown":return this.moveFocus("down");case"Enter":return isTextTarget?!1:this.activateFocusedWidget();case"Escape":return this.escapeFocusedWidget();default:return!1}}focusWidget(widget){if(widget&&!this.isWidgetFocusable(widget)&&(widget=null),widget){const scope=this.getFocusScopeRoot();if(!this.isDescendantOf(widget,scope))return!1}return this.focusedWidget===widget||(this.focusedWidget&&(this.focusedWidget.focus=!1),this.focusedWidget=widget??null,this.focusedWidget&&(this.focusedWidget.focus=!0,this.ensureWidgetVisible(this.focusedWidget)),this.app.requestFrameUpdate()),!0}ensureWidgetVisible(widget){if(!(widget instanceof Widget))return;const appRect=this.getWidgetAppRect(widget);widget.bubbleEvent("focus_visible",{target:widget,appRect})}clearFocus(){return this.focusWidget(null)}getFocusScopeRoot(){const modals=this.app._modalWidgets??[];return modals.length>0?modals[modals.length-1]:this.app.baseWidget}isDescendantOf(widget,ancestor){if(widget===ancestor)return!0;let current=widget.parent;for(;current instanceof Widget;){if(current===ancestor)return!0;current=current.parent}return!1}isWidgetFocusable(widget){return!(!(widget instanceof Widget)||!widget.canFocus||"disable"in widget&&widget.disable||"disabled"in widget&&widget.disabled||"visible"in widget&&widget.visible===!1)}getFocusableWidgets(scope=this.getFocusScopeRoot()){const focusables=[];for(let widget of scope.iter(!0,!1))this.isWidgetFocusable(widget)&&focusables.push(widget);return focusables}ensureFocusValid(){const scope=this.getFocusScopeRoot(),focusables=this.getFocusableWidgets(scope);return this.focusedWidget&&!focusables.includes(this.focusedWidget)&&this.focusWidget(null),{scope,focusables}}onFocusScopeChanged(){const{focusables}=this.ensureFocusValid();!this.focusedWidget&&focusables.length>0&&this.focusWidget(focusables[0])}moveFocusSequential(delta){const{focusables}=this.ensureFocusValid();if(focusables.length===0)return!1;let index=this.focusedWidget?focusables.indexOf(this.focusedWidget):-1;return index===-1?index=delta>0?0:focusables.length-1:index=(index+delta+focusables.length)%focusables.length,this.focusWidget(focusables[index]),!0}getWidgetGlobalRect(widget){return this.getWidgetAppRect(widget)}getWidgetAppRect(widget){var _a;if(!(widget instanceof Widget))return new Rect([0,0,0,0]);const rect=widget.rect,points=[new DOMPoint(rect[0],rect[1]),new DOMPoint(rect[0]+rect[2],rect[1]),new DOMPoint(rect[0]+rect[2],rect[1]+rect[3]),new DOMPoint(rect[0],rect[1]+rect[3])];let current=widget;for(;current instanceof Widget;){const parent=current.parent;if(!parent)break;const transform=(_a=parent.getTransform)==null?void 0:_a.call(parent);if(transform)for(let i=0;i<points.length;i++){const transformed=transform.transformPoint(points[i]);points[i]=new DOMPoint(transformed.x,transformed.y)}current=parent}const xs=points.map(pt=>pt.x),ys=points.map(pt=>pt.y),minX=Math.min(...xs),maxX=Math.max(...xs),minY=Math.min(...ys),maxY=Math.max(...ys);return new Rect([minX,minY,maxX-minX,maxY-minY])}moveFocus(direction){const{focusables}=this.ensureFocusValid();if(focusables.length===0)return!1;if(!this.focusedWidget)return this.focusWidget(focusables[0]),!0;const dirVec={left:[-1,0],right:[1,0],up:[0,-1],down:[0,1]}[direction];if(!dirVec)return!1;const currentRect=this.getWidgetGlobalRect(this.focusedWidget);let best=null,bestScore=1/0;for(const widget of focusables){if(widget===this.focusedWidget)continue;const rect=this.getWidgetGlobalRect(widget),dx=rect.center_x-currentRect.center_x,dy=rect.center_y-currentRect.center_y;if(dx*dirVec[0]+dy*dirVec[1]<=0)continue;const distance=Math.hypot(dx,dy);if(distance===0)continue;const score=Math.abs(dx*dirVec[1]-dy*dirVec[0])/distance*1e3+distance;score<bestScore&&(bestScore=score,best=widget)}return best?(this.focusWidget(best),!0):this.moveFocusSequential(direction==="left"||direction==="up"?-1:1)}activateFocusedWidget(){const{focusables}=this.ensureFocusValid();if(!this.focusedWidget){if(focusables.length===0)return!1;this.focusWidget(focusables[0])}return this.focusedWidget?this.focusedWidget.bubbleEvent("activate",null):!1}escapeFocusedWidget(){const{scope}=this.ensureFocusValid();return this.focusedWidget&&this.focusedWidget.bubbleEvent("escape",null)?!0:(scope==null?void 0:scope.bubbleEvent("escape",null))??!1}pollGamepads(){var _a,_b,_c,_d,_e,_f,_g,_h,_i,_j,_k,_l,_m,_n;if(this._connectedGamepads.size===0||typeof navigator>"u"||typeof navigator.getGamepads!="function")return;const pads=navigator.getGamepads();if(!pads)return;const now=typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now();for(const index of Array.from(this._connectedGamepads)){const gp=pads[index];gp&&(this.handleAxis(index,"x",((_a=gp.axes)==null?void 0:_a[0])??0,"left","right",now),this.handleAxis(index,"y",((_b=gp.axes)==null?void 0:_b[1])??0,"up","down",now),this.handleDigitalDirection(index,"left",((_d=(_c=gp.buttons)==null?void 0:_c[14])==null?void 0:_d.pressed)??!1,now),this.handleDigitalDirection(index,"right",((_f=(_e=gp.buttons)==null?void 0:_e[15])==null?void 0:_f.pressed)??!1,now),this.handleDigitalDirection(index,"up",((_h=(_g=gp.buttons)==null?void 0:_g[12])==null?void 0:_h.pressed)??!1,now),this.handleDigitalDirection(index,"down",((_j=(_i=gp.buttons)==null?void 0:_i[13])==null?void 0:_j.pressed)??!1,now),this.handleGamepadButton(index,0,((_l=(_k=gp.buttons)==null?void 0:_k[0])==null?void 0:_l.pressed)??!1,()=>this.activateFocusedWidget()),this.handleGamepadButton(index,1,((_n=(_m=gp.buttons)==null?void 0:_m[1])==null?void 0:_n.pressed)??!1,()=>this.escapeFocusedWidget()))}}handleGamepadButton(index,buttonIndex,pressed,callback){const key=`${index}:${buttonIndex}`,wasPressed=this._gamepadButtonState.get(key)??!1;pressed&&!wasPressed&&callback()&&this.app.requestFrameUpdate(),this._gamepadButtonState.set(key,pressed)}handleDigitalDirection(index,direction,pressed,now){const key=`${index}:${direction}`;let state=this._gamepadDigitalState.get(key);state||(state={active:!1,holdStart:0,lastRepeat:0},this._gamepadDigitalState.set(key,state)),pressed?state.active?now-state.holdStart>this.gamepadRepeatDelay&&(!state.lastRepeat||now-state.lastRepeat>this.gamepadRepeatInterval)&&(this.moveFocus(direction),state.lastRepeat=now):(state.active=!0,state.holdStart=now,state.lastRepeat=0,this.moveFocus(direction)):state.active&&(state.active=!1,state.holdStart=0,state.lastRepeat=0)}handleAxis(index,axisName,value,negativeDir,positiveDir,now){const key=`${index}:${axisName}`;let state=this._gamepadAxisState.get(key);state||(state={dir:0,holdStart:0,lastRepeat:0},this._gamepadAxisState.set(key,state));let dir=0;value<=-this.gamepadAxisThreshold?dir=-1:value>=this.gamepadAxisThreshold&&(dir=1),dir!==state.dir?(state.dir=dir,state.holdStart=dir?now:0,state.lastRepeat=0,dir===-1?this.moveFocus(negativeDir):dir===1&&this.moveFocus(positiveDir)):dir!==0&&now-state.holdStart>this.gamepadRepeatDelay&&(!state.lastRepeat||now-state.lastRepeat>this.gamepadRepeatInterval)&&(this.moveFocus(dir===-1?negativeDir:positiveDir),state.lastRepeat=now)}process_touch(ev,name){if(this.app.requestFrameUpdate(),this.grabbed!==null)for(let to of ev.changedTouches){let pos=this.grabbed.appToChild([to.clientX,to.clientY]),t=new Touch({pos,state:name,nativeObject:to,nativeEvent:ev,identifier:to.identifier});this.grabbed.emit(name,t)}else for(let to of ev.changedTouches){let t=new Touch({pos:this.app.toChild([to.clientX,to.clientY]),state:name,nativeObject:to,nativeEvent:ev,identifier:to.identifier});this.app.childEmit(name,t,!0)}ev.preventDefault()}process_back(ev,name){location.hash==="#!/backbutton"&&(history.replaceState(null,document.title,location.pathname),this.app.childEmit("back_button",ev))}process_mouse(ev,name){if(this.app.requestFrameUpdate(),this.mouseev=ev,ev.preventDefault(),this.mouseTouchEmulation){let mapping={mouse_up:"touch_up",mouse_down:"touch_down",mouse_move:"touch_move",mouse_cancel:"touch_cancel"};if(ev.buttons!==1&&name!=="mouse_up")return;if(this.grabbed!==null){let pos0=[ev.clientX,ev.clientY],pos=this.grabbed.appToChild(pos0),t=new Touch({pos,state:mapping[name],nativeObject:ev,identifier:-1});this.grabbed.emit(mapping[name],t)}else{let t=new Touch({pos:this.app.toChild([ev.clientX,ev.clientY]),state:mapping[name],nativeObject:ev,identifier:-1});this.app.childEmit(mapping[name],t,!0)}}else this.grabbed!==null?this.grabbed.emit(name,ev):this.app.childEmit(name,ev,!0)}process_wheel(ev,name){if(this.mouseev!=null){if(this.app.requestFrameUpdate(),this.grabbed!=null){let pos=this.grabbed.appToChild([this.mouseev.clientX,this.mouseev.clientY]),t=new Touch({pos,state:name,nativeObject:ev});return this.grabbed.emit(name,t)}else{let t=new Touch({pos:this.app.toChild([this.mouseev.clientX,this.mouseev.clientY]),state:name,nativeObject:ev});this.app.childEmit(name,t,!0)}ev.preventDefault()}}vibrate(intensity1,intensity2,duration){window.navigator.vibrate(duration)}}function evaluatedProperty(key,value,context,root){if(typeof value=="string"||value instanceof String){if(key.startsWith("on_"))return new Function("resources","parent","root",`return function(event, object, value) {${value}}`).bind(context)(App.resources,context.parent,root);if(value.trim().startsWith("(")&&value.indexOf("=>")<value.indexOf(`
`)){const func=new Function("resources","parent","root",`return ${value}`).bind(context)(App.resources,context.parent,root);return func.markupMethod=!0,func}const objs=new Set;let objCount=0;if(value[0]!=="'"&&value[0]!=='"')for(let m of value.matchAll(/(?!\.)\b([a-z]\w*)\.([a-z_]\w*)\b/ig)){const c=m[1];c!=="this"&&c!=="parent"&&c!=="root"&&c!=="resources"&&objs.add(c),objCount++}if(objCount===0)return new Function("resources",`return ${value};`)(App.resources);const objStr=[...objs].join(", "),functionBody=`return function (${objStr}) { return ${value} }`,dynamicFunc=new Function("resources","parent","root",functionBody)(App.resources,context.parent,root).bind(context);return dynamicFunc.text=`(${objStr}) => ${value}`,dynamicFunc}return value}function instanceClassData(widget,objectData,rootWidget){const props={},clsName=widget.constructor.name,merged={...App.rules.get(clsName),...objectData};for(let p in merged){const val=merged[p];if(p==="children"&&val instanceof Array){const ch=[];for(let c of val)if(c instanceof Object&&"cls"in c){const[cls,clsExtends]=App.classes[c.cls],childWidget=cls.a();instanceClassData(childWidget,c,rootWidget),ch.push(childWidget)}else throw Error(`Unknown child class ${c} on clsName ${clsName}`);widget instanceof App?widget.baseWidget.children=ch:widget.children=ch}else if(p!=="cls")try{props[p]=evaluatedProperty(p,val,widget,rootWidget)}catch{props[p]=val}}widget.updateProperties(props)}class Timer{constructor(time,initElapsed=0,callback=null){this.elapsed=0,this.timer=time,this.triggered=!1,this.callback=callback,initElapsed>0&&this.tick(initElapsed)}finished(){return this.elapsed>=this.timer}tick(millis){return this.elapsed>=this.timer?(this.triggered&&(this.triggered=!1),!1):(this.elapsed+=millis,this.elapsed>=this.timer?(this.callback!=null&&this.callback("timer",this),this.triggered=!0,!0):!1)}reset(time=-1,initElapsed=0){this.triggered=!1,time>=0&&(this.timer=time),initElapsed>0?this.tick(initElapsed):this.elapsed=0}}const minFontSize=8,scaleFactor=48*(1/window.devicePixelRatio||1);function tokenizeRich(text){const tokens=[],re=/\[(?:\s*(fg|bg|s|a)\s*=\s*([^\]\s]+)\s*)+\]|\[\/\]|\[\[|\]\]/g;let i=0,m;for(;m=re.exec(text);){const j=m.index;j>i&&tokens.push({type:"text",text:text.slice(i,j)});const tag=m[0];if(tag==="[[")tokens.push({type:"text",text:"["});else if(tag==="]]")tokens.push({type:"text",text:"]"});else if(tag==="[/]")tokens.push({type:"tagClose"});else{const attrs={},inner=tag.slice(1,-1);for(const kv of inner.trim().split(/\s+/)){const mm=/^(fg|bg|s|a)\s*=\s*(.+)$/.exec(kv);mm&&(attrs[mm[1]]=mm[2])}tokens.push({type:"tagOpen",attrs})}i=re.lastIndex}return i<text.length&&tokens.push({type:"text",text:text.slice(i)}),tokens}function buildRuns(tokens){const stack=[{fg:null,bg:null,s:1,a:1}],runs=[];for(const t of tokens){if(t.type==="text"){t.text&&runs.push({text:t.text,style:{...stack[stack.length-1]}});continue}if(t.type==="tagOpen"){const top={...stack[stack.length-1]};if(t.attrs.fg&&(top.fg=t.attrs.fg),t.attrs.bg&&(top.bg=t.attrs.bg),t.attrs.s){const mult=parseFloat(t.attrs.s);isFinite(mult)&&mult>0&&(top.s*=mult)}if(t.attrs.a){const alpha=parseFloat(t.attrs.a);isFinite(alpha)&&(top.a*=Math.max(0,Math.min(1,alpha)))}stack.push(top);continue}stack.length>1&&stack.pop()}return runs}function atomizeRuns(runs){const atoms=[];for(const r2 of runs){const parts=r2.text.split(/(\n|\s+)/);for(const p of parts)p!==""&&atoms.push({text:p,style:r2.style})}return atoms}function measureAtom(ctx,atom,baseSize,fontName){var _a;const s=baseSize*(((_a=atom.style)==null?void 0:_a.s)||1),fontPx=Math.max(1,Math.round(s)),oldFont=ctx.font;ctx.font=`${fontPx}px ${fontName}`;const w=ctx.measureText(atom.text).width;return ctx.font=oldFont,{width:w,sizePx:fontPx}}function wrapRich(ctx,atoms,baseSize,fontName,maxWidth){const lines=[],line=[];let lineWidth=0;const flush=()=>{const merged=[];for(const seg of line){const last=merged[merged.length-1];last&&last.fg===seg.fg&&last.bg===seg.bg&&last.a===seg.a&&last.sizePx===seg.sizePx?(last.text+=seg.text,last.width+=seg.width):merged.push({...seg})}lines.push(merged),line.length=0,lineWidth=0};for(const atom of atoms){if(atom.text===`
`){flush();continue}const{width,sizePx}=measureAtom(ctx,atom,baseSize,fontName),isSpace=/^\s+$/.test(atom.text);lineWidth+width>maxWidth&&line.length>0?(flush(),isSpace||(line.push({text:atom.text,width,sizePx,fg:atom.style.fg??null,bg:atom.style.bg??null,a:atom.style.a??1}),lineWidth+=width)):(line.push({text:atom.text,width,sizePx,fg:atom.style.fg??null,bg:atom.style.bg??null,a:atom.style.a??1}),lineWidth+=width)}return flush(),lines}function setFont(ctx,px,fontName){const prev=ctx.font;return ctx.font=`${px}px ${fontName}`,prev}function sizeRichText(ctx,text,size,fontName,rect,color,wordwrap=!0){let scale2=1;size<minFontSize&&(scale2=1/scaleFactor,ctx.save(),ctx.scale(scale2,scale2)),setFont(ctx,size>=minFontSize?size:Math.ceil(size/scale2),fontName);const runs=buildRuns(tokenizeRich(text)),atoms=wordwrap?atomizeRuns(runs):runs.map(r2=>({...r2})),lines=wordwrap?wrapRich(ctx,atoms,size/scale2,fontName,rect.w/scale2):[wrapRich(ctx,atoms,size/scale2,fontName,1e9)[0]||[]];let totalH=0;for(const segs of lines){let lineH=0;for(const seg of segs)lineH=Math.max(lineH,seg.sizePx);totalH+=lineH||size}return totalH+=lines.length?0:size,size<minFontSize&&ctx.restore(),[rect.w,totalH*scale2]}function getRichText(ctx,text,size,fontName,halign,valign,rect,color,wordwrap=!0){let scale2=1;size<minFontSize&&(scale2=1/scaleFactor,ctx.save(),ctx.scale(scale2,scale2));const basePx=size>=minFontSize?size:Math.ceil(size/scale2);setFont(ctx,basePx,fontName);const runs=buildRuns(tokenizeRich(text)),atoms=wordwrap?atomizeRuns(runs):runs.map(r2=>({...r2})),lines=wordwrap?wrapRich(ctx,atoms,basePx,fontName,rect.w/scale2):[wrapRich(ctx,atoms,basePx,fontName,1e9)[0]||[]],laid=[];let y=rect.y/scale2,maxLineHeights=[];for(const segs of lines){let lineW=0,lineH=0;for(const seg of segs)lineW+=seg.width,lineH=Math.max(lineH,seg.sizePx);let x=rect.x/scale2;halign==="center"?x+=(rect.w/scale2-lineW)/2:halign==="right"&&(x+=rect.w/scale2-lineW),laid.push({x,y,segs,lineH}),maxLineHeights.push(lineH||basePx),y+=lineH||basePx}const textH=maxLineHeights.reduce((a2,b)=>a2+b,0);let off=0;switch(valign){case"middle":off=(rect.h/scale2-textH)/2;break;case"bottom":off=rect.h/scale2-textH;break}const richData={fontName,lines:laid.map(L=>({x:L.x,y:L.y,lineH:L.lineH,segments:L.segs})),off,valign,baseColor:color,baseSizePx:basePx,size};return size<minFontSize&&ctx.restore(),richData}function drawRichText(ctx,richData,overrideColor=null){let scale2=1;const size=richData.size;size<minFontSize&&(scale2=1/scaleFactor,ctx.save(),ctx.scale(scale2,scale2)),ctx.textBaseline="top";for(const L of richData.lines){let x=L.x;const yTop=L.y+(richData.off??0);for(const seg of L.segments){if(!seg.text)continue;const prevFont=ctx.font;ctx.font=`${seg.sizePx}px ${richData.fontName}`;const pad=Math.round(seg.sizePx*.15);if(seg.bg){const prevFill2=ctx.fillStyle;ctx.fillStyle=seg.bg;const prevAlpha2=ctx.globalAlpha;ctx.globalAlpha*=seg.a??1,ctx.fillRect(x-pad,yTop-pad,seg.width+pad*2,L.lineH+pad*2),ctx.globalAlpha=prevAlpha2,ctx.fillStyle=prevFill2}const fg=overrideColor??seg.fg??richData.baseColor,prevFill=ctx.fillStyle,prevAlpha=ctx.globalAlpha;ctx.fillStyle=fg,ctx.globalAlpha=prevAlpha*(seg.a??1),ctx.fillText(seg.text,x,yTop),ctx.globalAlpha=prevAlpha,ctx.fillStyle=prevFill,x+=seg.width,ctx.font=prevFont}}size<minFontSize&&ctx.restore()}class Resource{update(app,millis){}}class Rules{constructor(){this.rules=new Map}add(widgetClass,ruleProperties,replace=!0){let curRuleset=this.rules.get(widgetClass);if(curRuleset&&!replace)for(let p in curRuleset)curRuleset[p]=ruleProperties[p];else this.rules.set(widgetClass,ruleProperties)}get(widgetClass){return this.rules.get(widgetClass)??{}}remove(widgetClass){return this.rules.delete(widgetClass)}}class EventConnection{constructor(listener,event,callback){this.listener=listener,this.event=event,this.callback=callback}}class EventManager{constructor(){this.connections=new Map}listen(listener,emitterEvent,callback){const[first,second]=emitterEvent.split(".",2);emitterEvent=second??first;const emitterId=second===void 0?listener.id??listener:first;let conn=new EventConnection(listener,emitterEvent,callback),conns=this.connections.get(emitterId);conns?conns.add(conn):this.connections.set(emitterId,new Set([conn]))}emit(emitter,event,data){const conns=this.connections.get(emitter.id??emitter);if(!conns)return!1;for(let conn of conns)if(conn.event===event&&conn.callback(event,emitter,data,conn.listener))return!0;return!1}disconnect(widget){this.connections.delete(widget.id??widget);for(let emitter of this.connections.keys()){const deleteList=[],conns=this.connections.get(emitter);if(conns){for(let conn of conns)conn.listener===widget&&deleteList.push(conn);deleteList.forEach(conn=>conns.delete(conn))}}}}class WidgetAnimation{constructor(){__publicField(this,"stack",[]);__publicField(this,"widget",null);__publicField(this,"props",{});__publicField(this,"initProps",{});__publicField(this,"elapsed",0)}add(props,duration=1e3){this.stack.push([props,duration])}update(app,millis){if(this.widget===null)return;let targetProps=this.stack[0][0],duration=this.stack[0][1];if(this.elapsed==0){this.initProps={};for(let p in targetProps)this.initProps[p]=this.widget[p]}let skip=this.elapsed+millis-duration;this.elapsed=skip<0?this.elapsed+millis:duration;let wgt=duration==0?1:this.elapsed/duration;if(skip<0)for(let p in this.initProps){let x=targetProps[p];typeof x=="number"&&(this.widget[p]=(1-wgt)*this.initProps[p]+wgt*x)}else{for(let p in this.initProps){let x=targetProps[p];typeof x=="number"&&(this.widget[p]=x)}if(this.stack=this.stack.slice(1),this.elapsed=skip,this.stack.length==0)this.cancel();else{this.initProps={};for(let p in this.stack[0][0])this.initProps[p]=this.widget[p]}}}start(widget){this.widget=widget,widget._animation=this}cancel(){this.widget!==null&&(this.widget._animation=null,this.widget.emit("animationComplete",this))}}function a(klass,arg1,arg2){var _a;Widget._ALLOW_CONSTRUCT=!0;const obj=new klass;Widget._ALLOW_CONSTRUCT=!1;let id=null,props={};return typeof arg1=="string"?(id=arg1,props=arg2??{}):props=arg1??{},id&&(obj.id=id),obj instanceof Widget&&instanceClassData(obj,{},obj),(_a=obj.updateProperties)==null||_a.call(obj,props),obj}const _Widget=class _Widget extends Rect{constructor(){super();__publicField(this,"bgColor",null);__publicField(this,"outlineColor",null);__publicField(this,"focus",!1);__publicField(this,"canFocus",!1);__publicField(this,"focusOutlineColor","rgba(255, 255, 255, 0.85)");__publicField(this,"focusOutlineWidth",null);__publicField(this,"_animation",null);__publicField(this,"_layoutNotify",!1);__publicField(this,"hints",{});if(!_Widget._ALLOW_CONSTRUCT)throw new Error(`[ESKV] Do not use 'new ${typeof this}()'. Use '${typeof this}.a(...)' instead.`);return _Widget._ALLOW_CONSTRUCT=!1,this.parent=null,this._processTouches=!1,this._deferredProps=null,this._children=[],this._needsLayout=!0,new Proxy(this,{set(target,name,value,receiver){return typeof name=="string"&&(["x","y","w","h","children","rect"].includes(name)||name[0]=="_")?Reflect.set(target,name,value,receiver):(Reflect.set(target,name,value,receiver),typeof name=="string"&&Reflect.apply(target.emit,receiver,[name,value]),!0)}})}static a(arg1,arg2=void 0){var _a;_Widget._ALLOW_CONSTRUCT=!0;const obj=new this;_Widget._ALLOW_CONSTRUCT=!1;let id=null,props={};return typeof arg1=="string"?(id=arg1,props=arg2??{}):props=arg1??{},id&&(obj.id=id),obj instanceof _Widget&&instanceClassData(obj,{},obj),(_a=obj.updateProperties)==null||_a.call(obj,props),obj}i(id){return this.id=id,this}p(props){return this.updateProperties(props),this}sh(hints,mode="replace"){return mode==="merge"?this.hints=Object.assign({},this.hints??{},hints):this.hints=hints,this}b(property,callback){return this._deferredProps||(this._deferredProps={}),this._deferredProps[property]=callback,this}c(child){if(child instanceof _Widget)this.addChild(child);else for(const ch of child)this.addChild(ch);return this}d(property,computeFn){return this._deferredProps||(this._deferredProps={}),this._deferredProps[property]=computeFn,this}set rect(rect){this[0]=rect[0],this[1]=rect[1],this[2]=rect[2],this[3]=rect[3],this._needsLayout=!0}get rect(){return new Rect([this[0],this[1],this[2],this[3]])}deferredProperties(app){let properties=this._deferredProps;this._deferredProps=null;for(let p in properties)if(!p.startsWith("on_")&&!p.startsWith("_")&&typeof properties[p]=="function"){let func=properties[p],args,rval;[args,rval]=(func.text??func.toString()).split("=>"),args=args.replace("(","").replace(")","").split(",").map(a2=>a2.trim());let objs=args.map(a2=>app.findById(a2)),obmap={};for(let a2 of args)obmap[a2]=app.findById(a2);const re=/(\w+)\.(\w+)|(\w+)\[['"](\w+)['"]\]/g;for(let pat of rval.matchAll(re)){let pr,ob;if([ob,pr]=pat.slice(1),ob==="this")this.listen(pr,(evt,obj,data)=>{try{this[p]=func(...objs)}catch(error){}});else if(ob in obmap)try{this.listen(`${ob}.${pr}`,(evt,obj,data)=>{try{this[p]=func(...objs)}catch(error){}})}catch(error){`${ob}`}}try{this[p]=func(...objs)}catch(error){}}}updateProperties(properties){for(let p in properties)!p.startsWith("on_")&&!p.startsWith("_")&&typeof properties[p]=="function"&&!("markupMethod"in properties[p])?this._deferredProps=properties:this[p]=properties[p]}listen(emitterEvent,func){return App.get()._eventManager.listen(this,emitterEvent,func),this}emit(event,data){return"on_"+event in this&&this["on_"+event](event,this,data)?!0:App.get()._eventManager.emit(this,event,data)}bubbleEvent(event,data,includeSelf=!0){let current=includeSelf?this:this.parent;for(;current instanceof _Widget;){if(current.emit(event,data))return!0;current=current.parent}return!1}*iter(recursive=!0,inView=!0){if(yield this,!!recursive)for(let c of this._children)yield*c.iter(...arguments)}*iterParents(){this.parent!==null&&(yield this.parent,this.parent!=App.get()&&(yield*this.parent.iterParents()))}findById(id){for(let w of this.iter(!0,!1))if("id"in w&&w.id==id)return w;return null}*iterByPropertyValue(property,value){for(let w of this.iter(!0,!1))property in w&&w[property]==value&&(yield w)}getTransformRecurse(includeSelf=!1,widget=null){let transform=this!==widget&&this.parent!==null?this.parent.getTransformRecurse(!0,widget):new DOMMatrix;if(!includeSelf)return transform;let newT=this.getTransform();return newT?transform.multiply(newT):transform}getTransform(){return null}applyTransform(pt,invert=!1,recurse=!1,includeSelf=!1,firstWidget=null){let tx=recurse?this.getTransformRecurse(includeSelf,firstWidget):this.getTransform();if(!tx)return pt;invert&&(tx=tx.inverse());let dp=tx.transformPoint(new DOMPoint(pt.x,pt.y));return new Vec22([dp.x,dp.y])}appToWidget(pos,recurse=!0){if(this.parent){let pt=this.parent.getTransformRecurse().inverse().transformPoint(new DOMPoint(pos[0],pos[1]));return new Vec22([pt.x,pt.y])}return pos}appToChild(pos,recurse=!0){let pt=this.getTransformRecurse(!0).inverse().transformPoint(new DOMPoint(pos[0],pos[1]));return new Vec22([pt.x,pt.y])}toChild(pos){let tx=this.getTransform();if(!tx)return pos;let pt=tx.inverse().transformPoint(new DOMPoint(pos[0],pos[1]));return new Vec22([pt.x,pt.y])}addChild(child,pos=-1){return pos==-1?this._children.push(child):this._children=[...this._children.slice(0,pos),child,...this._children.slice(pos)],this.emit("child_added",child),child.parent=this,this._needsLayout=!0,this}addNew(klass,props_or_id,props){return this.addChild(a(klass,props_or_id,props)),this}removeChild(child,disconnect=!0){var _a;this._children=this.children.filter(c=>c!=child),disconnect&&App.get()._eventManager.disconnect(child);const inputHandler=(_a=App.appInstance)==null?void 0:_a.inputHandler;(inputHandler==null?void 0:inputHandler.focusedWidget)===child&&inputHandler.focusWidget(null),this.emit("child_removed",child),child.parent=null,this._needsLayout=!0}get children(){return this._children}set children(children){var _a;for(let c of this._children){const inputHandler=(_a=App.appInstance)==null?void 0:_a.inputHandler;(inputHandler==null?void 0:inputHandler.focusedWidget)===c&&inputHandler.focusWidget(null),this.emit("child_removed",c),c.parent=null,this._needsLayout=!0}this._children=[];for(let c of children)this.addChild(c)}set x(val){this._needsLayout=!0,this[0]=val}set center_x(val){this._needsLayout=!0,this[0]=val-this[2]/2}set right(val){this._needsLayout=!0,this[0]=val-this[2]}set y(val){this._needsLayout=!0,this[1]=val}set center_y(val){this._needsLayout=!0,this[1]=val-this[3]/2}set bottom(val){this._needsLayout=!0,this[1]=val-this[3]}set w(val){this._needsLayout=!0,this[2]=val}set h(val){this._needsLayout=!0,this[3]=val}get x(){return this[0]}get center_x(){return this[0]+this[2]/2}get right(){return this[0]+this[2]}get y(){return this[1]}get center_y(){return this[1]+this[3]/2}get bottom(){return this[1]+this[3]}get w(){return this[2]}get h(){return this[3]}on_wheel(event,object,wheel){for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,wheel))return!0;return!1}on_touch_down(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,t))return!0}else for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,touch))return!0;return!1}on_touch_up(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,t))return!0}else for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,touch))return!0;return!1}on_touch_move(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,t))return!0}else for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,touch))return!0;return!1}on_touch_cancel(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,t))return!0}else for(let i=this._children.length-1;i>=0;i--)if(this._children[i].emit(event,touch))return!0;return!1}on_activate(event,object,data){return!1}on_escape(event,object,data){return!1}on_back_button(event,object,history2){return!1}getMetric(widget,target,rule,parentWidth=null,parentHeight=null){let app=App.get();if(rule===null)return widget[target];let value=0,base="relative";for(parentWidth=parentWidth??this.w,parentHeight=parentHeight??this.h;;){if(rule.constructor==String){let r2=rule.slice(-2);if(r2=="ww"){value=+rule.slice(0,-2)*widget.w;break}if(r2=="wh"){value=+rule.slice(0,-2)*widget.h;break}if(r2=="aw"){value=+rule.slice(0,-2)*app.dimW,base="absolute";break}if(r2=="ah"){value=+rule.slice(0,-2)*app.dimH,base="absolute";break}let r1=rule.slice(-1);if(r1=="w"){value=+rule.slice(0,-1)*parentWidth;break}if(r1=="h"){value=+rule.slice(0,-1)*parentHeight;break}value=+rule;break}if(target=="w"||target=="x"||target=="center_x"||target=="right"){value=+rule;break}value=+rule;break}return base=="relative"&&(["x","center_x","right"].includes(target)&&(value+=this.x),["y","center_y","bottom"].includes(target)&&(value+=this.y)),value}applyHintMetric(widget,target,rule,parentWidth=null,parentHeight=null){let app=App.get();if(rule===null)return;let value=0,base="relative";for(parentWidth=parentWidth??this.w,parentHeight=parentHeight??this.h;;){if(rule.constructor==String){let r2=rule.slice(-2);if(r2=="ww"){value=+rule.slice(0,-2)*widget.w;break}if(r2=="wh"){value=+rule.slice(0,-2)*widget.h;break}if(r2=="aw"){value=+rule.slice(0,-2)*app.dimW,base="absolute";break}if(r2=="ah"){value=+rule.slice(0,-2)*app.dimH,base="absolute";break}let r1=rule.slice(-1);if(r1=="w"){value=+rule.slice(0,-1)*parentWidth;break}if(r1=="h"){value=+rule.slice(0,-1)*parentHeight;break}value=+rule;break}if(target=="w"||target=="x"||target=="center_x"||target=="right"){value=+rule*parentWidth;break}value=+rule*parentHeight;break}base=="relative"&&(["x","center_x","right"].includes(target)&&(value+=this.x),["y","center_y","bottom"].includes(target)&&(value+=this.y)),widget[target]=value}applyHints(c,w=null,h=null){let hints=c.hints;w=w??this.w,h=h??this.h,"w"in hints&&hints.w!=null&&hints.w.constructor==String&&hints.w.slice(-2)=="wh"?(hints.h!==void 0&&this.applyHintMetric(c,"h",hints.h,w,h),hints.w!==void 0&&this.applyHintMetric(c,"w",hints.w,w,h)):(hints.w!==void 0&&this.applyHintMetric(c,"w",hints.w,w,h),hints.h!==void 0&&this.applyHintMetric(c,"h",hints.h,w,h));for(let ht in hints)ht!="w"&&ht!="h"&&this.applyHintMetric(c,ht,hints[ht],w,h)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;for(let c of this.children)this.applyHints(c),c.layoutChildren()}_draw(app,ctx,millis){this.draw(app,ctx);let transform=this.getTransform();if(transform){ctx.save(),ctx.transform(transform.a,transform.b,transform.c,transform.d,transform.e,transform.f);for(let c of this._children)c._draw(app,ctx,millis);ctx.restore();return}for(let c of this._children)c._draw(app,ctx,millis)}draw(app,ctx){let r2=this.rect;if(ctx.beginPath(),ctx.rect(r2[0],r2[1],r2[2],r2[3]),this.bgColor!=null){const origFill=ctx.fillStyle;ctx.fillStyle=this.bgColor,ctx.fill(),ctx.fillStyle=origFill}if(this.outlineColor!=null||this.focus&&this.canFocus){const originalLineWidth=ctx.lineWidth,originalStroke=ctx.strokeStyle,baseLineWidth=this.getMetric(this,"lineWidth",this.hints.lineWidth??`${1/app.tileSize}`);if(this.outlineColor!=null&&(ctx.lineWidth=baseLineWidth,ctx.strokeStyle=this.outlineColor,ctx.stroke()),this.focus&&this.canFocus){const focusWidth=this.focusOutlineWidth!=null?this.getMetric(this,"focusOutlineWidth",this.focusOutlineWidth):Math.max(baseLineWidth,2/app.tileSize);ctx.lineWidth=focusWidth,ctx.strokeStyle=this.focusOutlineColor,ctx.stroke()}ctx.lineWidth=originalLineWidth,ctx.strokeStyle=originalStroke}}update(app,millis){this._deferredProps!=null&&this.deferredProperties(app),this._animation!=null&&(this._animation.update(app,millis),app.requestFrameUpdate()),this._needsLayout&&(this.layoutChildren(),app.requestFrameUpdate());for(let c of this._children)c.update(app,millis)}};__publicField(_Widget,"_ALLOW_CONSTRUCT",!1);let Widget=_Widget;const _App=class _App extends Widget{static registerClass(name,cls,baseClsName){_App.classes[name]=[cls,baseClsName]}constructor(){if(_App.appInstance!=null)return _App.appInstance;Widget._ALLOW_CONSTRUCT=!0,super(),Widget._ALLOW_CONSTRUCT=!1,_App.appInstance=this,window.app=this,this._eventManager=new EventManager,this.id="app",this.canvas=null,this.canvasName="canvas",this.canvas=null,this.canvasName="canvas",this.w=-1,this.h=-1,this._baseWidget=a(Widget,{hints:{x:0,y:0,w:1,h:1}}),this._baseWidget.parent=this,this._modalWidgets=[],this._udpateActive=!0,this.pixelSize=1,this.integerTileSize=!1,this.exactDimensions=!1,this.prefDimW=32,this.prefDimH=16,this.dimW=this.prefDimW,this.dimH=this.prefDimH,this.tileSize=this.getTileScale()*this.pixelSize,this.tileSize=this.getTileScale()*this.pixelSize,this.offsetX=0,this.offsetY=0,this.shakeX=0,this.shakeX=0,this.shakeY=0,this.shakeAmount=0,this.timer_tick=null,this.timers=[],this.continuousFrameUpdates=!1,this._requestedFrameUpdate=!1}get baseWidget(){return this._baseWidget}addTimer(duration,callback){let t=new Timer(duration,0,callback);return this.timers.push(t),t}removeTimer(timer){this.timers=this.timers.filter(t=>t!=timer),this.timers=this.timers.filter(t=>t!=timer)}addModal(modal){var _a;this._modalWidgets.push(modal),this._needsLayout=!0,(_a=this.inputHandler)==null||_a.onFocusScopeChanged()}removeModal(modal){var _a;this._modalWidgets=this._modalWidgets.filter(m=>m!=modal),this._modalWidgets=this._modalWidgets.filter(m=>m!=modal),(_a=this.inputHandler)==null||_a.onFocusScopeChanged()}static get(){return _App.appInstance||(_App.appInstance=new _App),_App.appInstance}start(){let that=this;this.setupCanvas(),this.inputHandler=new InputHandler(this),window.onresize=(()=>that.updateWindowSize()),this.updateWindowSize(),setTimeout(()=>this._start(),1)}_start(){this.update()}childEmit(event,data,topModalOnly=!1){if(topModalOnly&&this._modalWidgets.length>0)return this._modalWidgets[this._modalWidgets.length-1].emit(event,data);if(this._baseWidget.emit(event,data))return!0;for(let mw of this._modalWidgets)if(mw.emit(event,data))return!0;return!1}*iter(recursive=!0,inView=!0){yield this,yield*this._baseWidget.iter(...arguments);for(let mw of this._modalWidgets)yield*mw.iter(...arguments)}findById(id){for(let w of this.iter(!0,!1))if("id"in w&&w.id==id)return w;return null}*iterByPropertyValue(property,value){for(let w of this.iter(!0,!1))property in w&&w[property]===value&&(yield w)}update(){var _a,_b;this._requestedFrameUpdate=!1,this._udpateActive=!0;let millis=15,n_timer_tick=Date.now();this.timer_tick!=null&&(millis=Math.min(n_timer_tick-this.timer_tick,30)),(this.timers.length>0||this._needsLayout)&&this.requestFrameUpdate();for(let t of this.timers)t.tick(millis);(_b=(_a=this.inputHandler)==null?void 0:_a.pollGamepads)==null||_b.call(_a),this._needsLayout&&this.layoutChildren();for(let res of _App.resources.values())res.update(this,millis);this._baseWidget.update(this,millis);for(let mw of this._modalWidgets)mw.update(this,millis);this.ctx&&this._draw(this,this.ctx,millis),this.continuousFrameUpdates&&this.requestFrameUpdate(),this.timer_tick=n_timer_tick,this._udpateActive=!1,this._requestedFrameUpdate&&(this._requestedFrameUpdate=!1,this.requestFrameUpdate())}requestFrameUpdate(){this._requestedFrameUpdate||(this._udpateActive?this._requestedFrameUpdate=!0:(this._udpateActive=!0,window.requestAnimationFrame(()=>this.update())))}_draw(app,ctx,millis){if(!this.canvas)return;ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.shakeX=0,this.shakeY=0,this.screenShake(),ctx.save();let tx=this.getTransform();tx&&ctx.transform(tx.a,tx.b,tx.c,tx.d,tx.e,tx.f),this._baseWidget._draw(app,ctx,millis);for(let mw of this._modalWidgets)mw._draw(app,ctx,millis);ctx.restore()}getTransform(recurse=!0){return new DOMMatrix().translate(this.offsetX+this.shakeX,this.offsetY+this.shakeY).scale(this.tileSize,this.tileSize)}on_prefDimW(e,o,v){this.updateWindowSize()}on_prefDimH(e,o,v){this.updateWindowSize()}on_tileSize(e,o,v){this.prefDimH<0&&this.prefDimW<0&&this.updateWindowSize()}computeDeviceScale(){const dpr=window.devicePixelRatio||1,scale2=1080/(Math.min(window.innerWidth,window.innerHeight)*dpr);return Math.max(1,Math.min(scale2,3))}updateWindowSize(){this.x=0,this.y=0,this.w=window.innerWidth,this.h=window.innerHeight,this.pixelSize=this.computeDeviceScale(),(this.prefDimH>=0||this.prefDimW>=0)&&(this.tileSize=this.getTileScale()),this.fitDimensionsToTileSize(this.tileSize),this.canvas!==null&&this.setupCanvas();try{screen.orientation.unlock()}catch{}this._needsLayout=!0,this.requestFrameUpdate()}getTileScale(){let sh=this.h,sw=this.w,scale2=1/this.pixelSize;return this.prefDimW<0&&this.prefDimH<0?this.tileSize>0&&(scale2=this.tileSize/this.pixelSize):this.prefDimW<0?scale2=sh/this.prefDimH/this.pixelSize:this.prefDimH<0?scale2=sw/this.prefDimW/this.pixelSize:scale2=Math.min(sh/this.prefDimH/this.pixelSize,sw/this.prefDimW/this.pixelSize),this.integerTileSize&&scale2>1&&(scale2=Math.floor(scale2)),scale2*this.pixelSize}fitDimensionsToTileSize(scale2){let sh=this.h,sw=this.w;if(this.exactDimensions){this.prefDimW<0&&this.prefDimH<0?(this.dimW=sw/this.tileSize,this.dimH=sh/this.tileSize):this.prefDimH<0?(this.dimW=this.prefDimW,this.dimH=sh/this.tileSize):this.prefDimW<0?(this.dimW=sw/this.tileSize,this.dimH=this.prefDimH):(this.dimH=this.prefDimH,this.dimW=this.prefDimW);return}this.dimH=Math.floor(sh/scale2),this.dimW=Math.floor(sw/scale2)}setupCanvas(){const canvas=document.getElementById(this.canvasName);if(!(canvas instanceof HTMLCanvasElement))throw"No canvas element named "+this.canvasName;this.canvas=canvas,this.canvas.width=this.w,this.canvas.height=this.h,this.ctx=this.canvas.getContext("2d"),this.ctx&&(this.ctx.imageSmoothingEnabled=!1,this.offsetX=Math.floor((this.w-this.tileSize*this.dimW)/2),this.offsetY=Math.floor((this.h-this.tileSize*this.dimH)/2))}applyHints(c){super.applyHints(c,this.dimW,this.dimH)}screenShake(){this.shakeAmount&&this.shakeAmount--;let shakeAngle=Math.random()*Math.PI*2;this.shakeX=Math.round(Math.cos(shakeAngle)*this.shakeAmount),this.shakeY=Math.round(Math.sin(shakeAngle)*this.shakeAmount)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.applyHints(this._baseWidget),this._baseWidget.layoutChildren();for(let mw of this._modalWidgets)this.applyHints(mw),mw.layoutChildren()}};__publicField(_App,"appInstance",null),__publicField(_App,"rules",new Rules),__publicField(_App,"resources",new Map),__publicField(_App,"classes",{});let App=_App;class Label extends Widget{constructor(){super();__publicField(this,"fontSize",null);__publicField(this,"sizeGroup","");__publicField(this,"clip",!1);__publicField(this,"ignoreSizeForGroup",!1);__publicField(this,"fontName",'"Nimbus Mono PS", "Courier New", monospace');__publicField(this,"text","");__publicField(this,"wrap",!1);__publicField(this,"richText",!1);__publicField(this,"wrapAtWord",!0);__publicField(this,"align","center");__publicField(this,"valign","middle");__publicField(this,"color","white");this._textData=null}on_align(e,object,v){this._needsLayout=!0}on_valign(e,object,v){this._needsLayout=!0}on_wrap(e,object,v){this._needsLayout=!0}on_richText(e,object,v){this._needsLayout=!0}on_wrapAtWord(e,object,v){this._needsLayout=!0}on_text(e,object,v){this._needsLayout=!0}on_fontSize(e,object,v){this._needsLayout=!0}on_fontName(e,object,v){this._needsLayout=!0}layoutChildren(){let ctx=App.get().ctx;if(!ctx)return;let fontSize=this.fontSize===null?null:this.getMetric(this,"fontSize",this.fontSize);if("h"in this.hints&&this.hints.h==null&&fontSize!==null&&(this[3]=this.richText?sizeRichText(ctx,this.text,fontSize,this.fontName,this.rect,this.color,this.wrap)[1]:this.wrap?sizeWrappedText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[1]:sizeText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color)[1]),"w"in this.hints&&this.hints.w==null&&fontSize!==null&&(this[2]=this.richText?sizeRichText(ctx,this.text,fontSize,this.fontName,this.rect,this.color,this.wrap)[0]:this.wrap?sizeWrappedText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[0]:sizeText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color)[0]),fontSize=fontSize===null?this.h/2:fontSize,this.fontSize===null&&this.rect.w!==void 0){let i=0,w,h;for(;i<50;){if(this.richText?[w,h]=sizeRichText(ctx,this.text,fontSize,this.fontName,this.rect,this.color,this.wrap):this.wrap?[w,h]=sizeWrappedText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord):[w,h]=sizeText(ctx,this.text,fontSize,this.fontName,this.align=="center",this.rect,this.color),(this.h>=h||"h"in this.hints&&this.hints.h==null||fontSize<.01)&&(this.w>=w||"w"in this.hints&&this.hints.w==null)){"h"in this.hints&&this.hints.h==null&&(this.h=h),"w"in this.hints&&this.hints.w==null&&(this.w=w);break}const err=Math.min(1.1,this.w/w,this.h/h);this.wrap?fontSize*=err**.5:fontSize*=err**1.1,i++}fontSize===void 0&&(fontSize=.001*App.get().h)}this.sizeGroup!==""?(this._bestFontSize=fontSize,this._textData=null):this.richText?this._textData=getRichText(ctx,this.text,fontSize,this.fontName,this.align,this.valign,this.rect,this.color,this.wrap):this.wrap?this._textData=getWrappedTextData(ctx,this.text,fontSize,this.fontName,this.align,this.valign,this.rect,this.color,this.wrapAtWord):this._textData=getTextData(ctx,this.text,fontSize,this.fontName,this.align,this.valign,this.rect,this.color),super.layoutChildren()}sizeToGroup(ctx){if(this._bestFontSize===void 0)return;let fontSize=1/0;for(let lbl of App.get().iterByPropertyValue("sizeGroup",this.sizeGroup))fontSize>lbl._bestFontSize&&!lbl.ignoreSizeForGroup&&(fontSize=lbl._bestFontSize);if(fontSize>0)for(let lbl of App.get().iterByPropertyValue("sizeGroup",this.sizeGroup)){const fs=lbl.clip||!lbl.ignoreSizeForGroup?fontSize:lbl._bestFontSize;lbl.richText?lbl._textData=getRichText(ctx,lbl.text,fs,lbl.fontName,lbl.align,lbl.valign,lbl.rect,lbl.color,lbl.wrap):lbl.wrap?lbl._textData=getWrappedTextData(ctx,lbl.text,fs,lbl.fontName,lbl.align,lbl.valign,lbl.rect,lbl.color,lbl.wrapAtWord):lbl._textData=getTextData(ctx,lbl.text,fs,lbl.fontName,lbl.align,lbl.valign,lbl.rect,lbl.color)}}draw(app,ctx){if(super.draw(app,ctx),this.clip){ctx.save();const r2=this.rect;ctx.rect(r2.x,r2.y,r2.w,r2.h),ctx.clip()}!this._textData&&this.sizeGroup!==""&&this.sizeToGroup(ctx),this._textData&&(this.richText?drawRichText(ctx,this._textData):this.wrap?drawWrappedText(ctx,this._textData,this.color):drawText(ctx,this._textData,this.color)),this.clip&&ctx.restore()}}class Button extends Label{constructor(){super();__publicField(this,"bgColor",colorString([.5,.5,.5]));__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.4,.4,.4]));__publicField(this,"disable",!1);__publicField(this,"canFocus",!0)}on_touch_down(event,object,touch){var _a;return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,(_a=App.get().inputHandler)==null||_a.focusWidget(this),!0):!1}on_touch_up(event,object,touch){return super.on_touch_up(event,object,touch)?!0:touch.grabbed!=this?!1:(touch.ungrab(),!this.disable&&this.collide(touch.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(event,object,touch){return super.on_touch_move(event,object,touch)?!0:(touch.grabbed==this&&!this.disable&&(this._touching=this.collide(touch.rect)),!1)}on_activate(event,object,data){var _a;return this.disable?!1:((_a=App.get().inputHandler)==null||_a.focusWidget(this),this.emit("press",null),!0)}draw(app,ctx){let saved=this.bgColor,saved2=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(app,ctx),this.bgColor=saved,this.color=saved2}}class BasicButton extends Widget{constructor(){super();__publicField(this,"color",colorString([.8,.8,.8]));__publicField(this,"bgColor",colorString([.5,.5,.5]));__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.4,.4,.4]));__publicField(this,"disable",!1);__publicField(this,"canFocus",!0)}on_touch_down(event,object,touch){var _a;return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,(_a=App.get().inputHandler)==null||_a.focusWidget(this),!0):!1}on_touch_up(event,object,touch){return super.on_touch_up(event,object,touch)?!0:touch.grabbed!=this?!1:(touch.ungrab(),!this.disable&&this.collide(touch.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(event,object,touch){return super.on_touch_move(event,object,touch)?!0:(touch.grabbed==this&&!this.disable&&(this._touching=this.collide(touch.rect)),!1)}on_activate(event,object,data){var _a;return this.disable?!1:((_a=App.get().inputHandler)==null||_a.focusWidget(this),this.emit("press",null),!0)}draw(app,ctx){let saved=this.bgColor,saved2=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(app,ctx),this.bgColor=saved,this.color=saved2}}class ToggleButton extends Label{constructor(){super();__publicField(this,"bgColor",colorString([.5,.5,.5]));__publicField(this,"pressColor",colorString([.7,.7,.7]));__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.4,.4,.4]));__publicField(this,"disable",!1);__publicField(this,"_press",!1);__publicField(this,"group",null);__publicField(this,"singleSelect",!0);__publicField(this,"canFocus",!0)}get press(){return this._press}set press(value){this._press=value}on_touch_down(event,object,touch){var _a;return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,(_a=App.get().inputHandler)==null||_a.focusWidget(this),!0):!1}on_touch_up(event,object,touch){if(touch.grabbed!==this)return!1;if(touch.ungrab(),this._touching=!1,this.collide(touch.rect)){if(this.group===null||!this.singleSelect)this.press=!this.press;else{if(this.parent!==null)for(let w of this.parent.iterByPropertyValue("group",this.group))w!==this&&(w._press=!1);this.press=!0}return!0}return!1}on_touch_move(event,object,touch){return touch.grabbed===this?(this._touching=this.collide(touch.rect),!0):!1}on_activate(event,object,data){var _a;if(this.disable)return!1;if((_a=App.get().inputHandler)==null||_a.focusWidget(this),this.group===null||!this.singleSelect)this.press=!this.press;else{if(this.parent!==null)for(let w of this.parent.iterByPropertyValue("group",this.group))w!==this&&(w._press=!1);this.press=!0}return!0}draw(app,ctx){let saved=this.bgColor,saved2=this.color;this.press&&(this.bgColor=this.pressColor),this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(app,ctx),this.bgColor=saved,this.color=saved2}}class CheckBox extends Widget{constructor(){super();__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"color",colorString([.6,.6,.6]));__publicField(this,"bgColor",colorString([.5,.5,.5]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.3,.3,.3]));__publicField(this,"disable",!1);__publicField(this,"check",!1);__publicField(this,"group",null);__publicField(this,"canFocus",!0)}on_touch_down(event,object,touch){var _a;return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,(_a=App.get().inputHandler)==null||_a.focusWidget(this),!0):!1}on_touch_up(event,object,touch){if(super.on_touch_up(event,object,touch))return!0;if(this.parent===null||touch.grabbed!=this)return!1;if(touch.ungrab(),!this.disable&&this.collide(touch.rect)){if(this._touching=!1,this.group==null)this.check=!this.check;else{for(let w of this.parent.iterByPropertyValue("group",this.group))w!=this&&(w.check=!1);this.check=!0}return!0}return!1}on_touch_move(event,object,touch){return super.on_touch_move(event,object,touch)?!0:touch.grabbed==this&&!this.disable?(this._touching=this.collide(touch.rect),!0):!1}on_activate(event,object,data){var _a;if(this.disable)return!1;if((_a=App.get().inputHandler)==null||_a.focusWidget(this),this.group==null)this.check=!this.check;else if(this.parent!==null){for(let w of this.parent.iterByPropertyValue("group",this.group))w!=this&&(w.check=!1);this.check=!0}return!0}draw(app,ctx){if(this.group!=null){let r3=this.rect;r3.w=r3.h=.5*Math.min(r3.w,r3.h),r3.x=this.x+(this.w-r3.w)/2,r3.y=this.y+(this.h-r3.h)/2;let ts2=App.get().tileSize,ctx2=App.get().ctx;if(!ctx2)return;ctx2.strokeStyle=this.disable?this.disableColor1:this.bgColor,ctx2.lineWidth=1/ts2,ctx2.beginPath(),ctx2.arc(r3.center_x,r3.center_y,r3.w/2,0,2*Math.PI),ctx2.stroke(),(this._touching||this.disable)&&(ctx2.fillStyle=this.disable?this.disableColor1:this.selectColor,ctx2.fill()),this.check&&(ctx2.fillStyle=this.disable?this.disableColor2:this.color,ctx2.beginPath(),ctx2.arc(r3.center_x,r3.center_y,r3.w/3,0,2*Math.PI),ctx2.fill());return}let r2=this.rect;r2.w=r2.h=.5*Math.min(r2.w,r2.h),r2.x=this.x+(this.w-r2.w)/2,r2.y=this.y+(this.h-r2.h)/2;let ts=app.tileSize;ctx.beginPath(),ctx.strokeStyle=this.bgColor,this.disable&&(ctx.strokeStyle=this.disableColor1),ctx.lineWidth=1/ts,ctx.rect(r2[0],r2[1],r2[2],r2[3]),ctx.stroke(),this._touching&&(ctx.fillStyle=this.selectColor,ctx.fill()),this.check&&(ctx.strokeStyle=this.color,this.disable&&(ctx.strokeStyle=this.disableColor2),ctx.beginPath(),ctx.lineWidth=r2.w/5,ctx.moveTo(r2.x,r2.y),ctx.lineTo(r2.right,r2.bottom),ctx.moveTo(r2.right,r2.y),ctx.lineTo(r2.x,r2.bottom),ctx.stroke())}}class Slider extends Widget{constructor(){super();__publicField(this,"selectColor",colorString([.7,.7,.8]));__publicField(this,"color",colorString([.6,.6,.6]));__publicField(this,"bgColor",colorString([.4,.4,.4]));__publicField(this,"disableColor1",colorString([.2,.2,.2]));__publicField(this,"disableColor2",colorString([.3,.3,.3]));__publicField(this,"disable",!1);__publicField(this,"min",0);__publicField(this,"max",1);__publicField(this,"curMax",1);__publicField(this,"unboundedStopMultiple",10);__publicField(this,"exponentialSlider",!1);__publicField(this,"step",null);__publicField(this,"orientation","horizontal");__publicField(this,"value",0);__publicField(this,"sliderSize",.2)}setValue(touch){let max=this.max??this.curMax,value=0;this.orientation=="horizontal"&&(value=clamp((touch.rect.x-this.x-this.w*this.sliderSize/2)/(this.w*(1-this.sliderSize)),0,1)),this.orientation=="vertical"&&(value=clamp((touch.rect.y-this.y-this.h*this.sliderSize/2)/(this.h*(1-this.sliderSize)),0,1)),this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?value=value>.5?max/this.unboundedStopMultiple+(value-.5)/.5*(max-max/this.unboundedStopMultiple):this.min+value/.5*(max/this.unboundedStopMultiple-this.min):value=this.min+(max-this.min)*value,this.step!=null&&(value=Math.round(value/this.step)*this.step),this.value=value}on_touch_down(event,object,touch){return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touch=!0,this.setValue(touch),!0):!1}updateMax(){this.max===null&&(this.curMax=this.unboundedStopMultiple*this.value)}on_touch_up(event,object,touch){return touch.grabbed!=this?super.on_touch_up(event,object,touch):(touch.ungrab(),!this.disable&&this.collide(touch.rect)&&(this._touching=!1,this.setValue(touch)),this.updateMax(),!0)}on_touch_move(event,object,touch){return touch.grabbed!==this?super.on_touch_move(event,object,touch):(this.disable||(this._touching=this.collide(touch.rect),this.setValue(touch)),!1)}draw(app,ctx){let ts=app.tileSize,r2=this.rect;if(this.orientation=="horizontal"){r2.w-=this.sliderSize*this.w,r2.x+=this.sliderSize/2*this.w;let rad=Math.min(this.sliderSize/2*this.w,this.h/2)/2;ctx.strokeStyle=this.disable?this.disableColor1:this.bgColor,ctx.beginPath(),ctx.lineWidth=4/ts,ctx.moveTo(r2.x,r2.center_y),ctx.lineTo(r2.right,r2.center_y),ctx.stroke();let max=this.max??this.curMax,vPos;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?vPos=this.value>max/this.unboundedStopMultiple?(.5+.5*(this.value-max/this.unboundedStopMultiple)/(max-max/this.unboundedStopMultiple))*r2.w:.5*(this.value-this.min)/(max/this.unboundedStopMultiple-this.min)*r2.w:vPos=(this.value-this.min)/(max-this.min)*r2.w,ctx.strokeStyle=this.disable?this.disableColor2:this.bgColor,ctx.beginPath(),ctx.arc(r2.x+vPos,r2.center_y,rad,0,2*Math.PI),ctx.stroke(),ctx.fillStyle=this.color,(this._touching||this.disable)&&(ctx.fillStyle=this.disable?this.disableColor1:this.selectColor),ctx.fill()}if(this.orientation=="vertical"){r2.h-=this.sliderSize*this.h,r2.y+=this.sliderSize/2*this.h;let rad=Math.min(this.sliderSize/2*this.h,this.w/2)/2;ctx.strokeStyle=this.disable?this.disableColor1:this.bgColor,ctx.beginPath(),ctx.lineWidth=4/ts,ctx.moveTo(r2.center_x,r2.y),ctx.lineTo(r2.center_x,r2.bottom),ctx.stroke();let max=this.max??this.curMax,vPos;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?vPos=this.value>max/this.unboundedStopMultiple?(.5+.5*(this.value-max/this.unboundedStopMultiple)/(max-max/this.unboundedStopMultiple))*r2.h:.5*(this.value-this.min)/(max/this.unboundedStopMultiple-this.min)*r2.h:vPos=(this.value-this.min)/(max-this.min)*r2.h,ctx.strokeStyle=this.disable?this.disableColor2:this.bgColor,ctx.beginPath(),ctx.arc(r2.center_x,r2.y+vPos,rad,0,2*Math.PI),ctx.stroke(),ctx.fillStyle=this.color,(this._touching||this.disable)&&(ctx.fillStyle=this.disable?this.disableColor1:this.selectColor),ctx.fill()}}}class TextInput extends Label{constructor(){super();__publicField(this,"_activeDOMInput",null);__publicField(this,"editing",!1);__publicField(this,"disable",!1);__publicField(this,"canFocus",!0);__publicField(this,"_inputSanitizer");this._textData=null}on_touch_down(event,object,touch){var _a;return super.on_touch_down(event,object,touch)?!0:!this.disable&&this.collide(touch.rect)?(touch.grab(this),this._touching=!0,(_a=App.get().inputHandler)==null||_a.focusWidget(this),!0):(this.clearDOM(),!1)}on_touch_up(event,object,touch){return super.on_touch_up(event,object,touch)?!0:touch.grabbed!=this?!1:!this.disable&&this.collide(touch.rect)?(this._touching=!1,this.addDOMInput(),!0):(this.clearDOM(),!1)}on_layout(event,object,value){this.clearDOM()}_syncTextareaVAlign(inp,rt,lhPx){var _a,_b;const blockH=Math.max(1,((_b=(_a=this._textData)==null?void 0:_a.lines)==null?void 0:_b.length)||1)*lhPx;let padTop=0;this.valign==="middle"?padTop=Math.max(0,(rt.h-blockH)/2):this.valign==="bottom"&&(padTop=Math.max(0,rt.h-blockH)),inp.style.paddingTop=`${Math.floor(padTop)}px`}DOMInputRect(){let r2=this.rect,t=this.getTransformRecurse(),rt=new Rect,dp1=t.transformPoint(new DOMPoint(r2.x,r2.y)),dp2=t.transformPoint(new DOMPoint(r2.right,r2.bottom));return[rt.x,rt.y]=[dp1.x,dp1.y],[rt.w,rt.h]=[dp2.x,dp2.y],rt.w-=rt.x,rt.h-=rt.y,rt}addDOMInput(){var _a;if(!this._textData||this._activeDOMInput)return;const app=App.get(),canvasdiv=document.getElementById("eskvapp");if(!canvasdiv)return;const type=this.wrap?"textarea":"input",inp=document.createElement(type);if(!(inp instanceof HTMLInputElement)&&!(inp instanceof HTMLTextAreaElement))return;const rt=this.DOMInputRect(),color=this.color??"white",bgColor=this.bgColor??"black",fsPx=Math.max(1,this._textData.size*app.tileSize),lhPx=Math.round(fsPx*1.25);inp.value=this.text,inp.style.position="absolute",inp.style.top=`${Math.floor(rt.y*100)/100}px`,inp.style.left=`${Math.floor(rt.x*100)/100}px`,inp.style.width=`${Math.floor(rt.w*100)/100}px`,inp.style.height=`${Math.floor(rt.h*100)/100}px`,inp.style.fontSize=`${fsPx}px`,inp.style.lineHeight=`${lhPx}px`,inp.style.fontFamily=this.fontName,inp.style.color=color,inp.style.background=bgColor,inp.style.textAlign=this.align,inp.style.border="none",inp.style.outline="none",inp.style.padding="0",inp.style.margin="0",inp.style.boxSizing="border-box",inp.style.caretColor=color,type==="textarea"?(inp.setAttribute("wrap","soft"),inp.style.whiteSpace="pre-wrap",inp.style.overflowWrap=this.wrapAtWord?"break-word":"anywhere",inp.style.wordBreak=this.wrapAtWord?"normal":"break-all",inp.style.resize="none",inp.style.overflowY="auto",this._syncTextareaVAlign(inp,rt,lhPx),inp.addEventListener("input",()=>this._syncTextareaVAlign(inp,this.DOMInputRect(),lhPx))):(inp.style.whiteSpace="nowrap",inp.style.overflow="hidden"),this._activeDOMInput=inp,canvasdiv.appendChild(inp),inp.addEventListener("focusout",()=>this.clearDOM()),(_a=App.get().inputHandler)==null||_a.focusWidget(this),inp.focus(),inp.select(),this.editing=!0}clearDOM(){if(this._activeDOMInput!=null){this.text=this._inputSanitizer?this._inputSanitizer(this._activeDOMInput.value,this):this._activeDOMInput.value;let inp=this._activeDOMInput;this._activeDOMInput=null,inp.remove(),this.editing=!1,this._needsLayout=!0;let iph=App.get().inputHandler;(iph==null?void 0:iph.grabbed)===this&&iph.ungrab()}}layoutChildren(){if(super.layoutChildren(),this._activeDOMInput!=null){let rt=this.DOMInputRect(),inp=this._activeDOMInput;if(inp.style.top=(Math.floor(rt.y*100)/100).toString()+"px",inp.style.left=(Math.floor(rt.x*100)/100).toString()+"px",inp.style.width=(Math.floor(rt.w*100)/100).toString()+"px",inp.style.height=(Math.floor(rt.h*100)/100).toString()+"px",this._activeDOMInput instanceof HTMLTextAreaElement&&this.wrap){const fsPx=parseFloat(this._activeDOMInput.style.fontSize)||16,lhPx=parseFloat(this._activeDOMInput.style.lineHeight)||Math.round(fsPx*1.25);this._syncTextareaVAlign(this._activeDOMInput,rt,lhPx)}}}on_activate(event,object,data){return this.disable?!1:(this.addDOMInput(),!0)}on_escape(event,object,data){return this.editing?(this.clearDOM(),!0):!1}}class ImageWidget extends Widget{constructor(){super();__publicField(this,"image",new Image);__publicField(this,"bgColor",null);__publicField(this,"outlineColor",null);__publicField(this,"src",null);__publicField(this,"lockAspect",!0);__publicField(this,"scaleToFit",!0);__publicField(this,"antiAlias",!0);__publicField(this,"angle",0);__publicField(this,"anchor","center");__publicField(this,"mirror",!1)}on_src(event,object,data){this.src?this.image.src=this.src:this.image.src=""}layoutChildren(){this._layoutNotify&&this.emit("layout",null);let app=App.get();"w"in this.hints&&this.hints.w==null&&(this[2]=this.image.width/app.tileSize),"h"in this.hints&&this.hints.h==null&&(this[3]=this.image.height/app.tileSize),this._needsLayout=!1,super.layoutChildren()}draw(app,ctx){if(super.draw(app,ctx),!this.image.complete||this.image.naturalHeight==0)return;let r2=this.rect;if(this.scaleToFit||(r2.x+=r2.w/2-this.image.width/2/app.tileSize,r2.y+=r2.h/2-this.image.height/2/app.tileSize,r2.w=this.image.width/app.tileSize,r2.h=this.image.height/app.tileSize),this.lockAspect){let srcAspect=this.image.height/this.image.width,dstAspect=r2.h/r2.w,rh=r2.h,rw=r2.w;srcAspect<dstAspect&&(rh=r2.w*srcAspect),srcAspect>dstAspect&&(rw=r2.h/srcAspect),r2.x+=r2.w/2-rw/2,r2.y+=r2.h/2-rh/2,r2.w=rw,r2.h=rh}ctx.save(),ctx.imageSmoothingEnabled=this.antiAlias;let anchor=this.anchor;anchor=="center"?anchor=[r2.w/2,r2.h/2]:anchor=[anchor[0]*r2.w,anchor[1]*r2.h],this.mirror&&ctx.scale(-1,1),ctx.translate(r2.x+anchor[0],r2.y+anchor[1]),this.angle!=0&&ctx.rotate(this.angle),ctx.translate(-anchor[0],-anchor[1]),ctx.drawImage(this.image,0,0,this.image.width,this.image.height,0,0,r2.w,r2.h),ctx.restore()}}class BoxLayout extends Widget{constructor(){super();__publicField(this,"spacingX",0);__publicField(this,"spacingY",0);__publicField(this,"paddingX",0);__publicField(this,"paddingY",0);__publicField(this,"orientation","vertical");__publicField(this,"order","forward")}*iterChildren(){if(this.order==="forward")for(let c of this._children)yield c;else for(let i=this._children.length-1;i>=0;i--)yield this._children[i]}on_numX(event,object,data){this._needsLayout=!0}on_numY(event,object,data){this._needsLayout=!0}on_spacingX(event,object,data){this._needsLayout=!0}on_spacingY(event,object,data){this._needsLayout=!0}on_paddingX(event,object,data){this._needsLayout=!0}on_paddingY(event,object,data){this._needsLayout=!0}on_orientation(event,object,data){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let spacingX=this.getMetric(this,"spacingX",this.spacingX),spacingY=this.getMetric(this,"spacingY",this.spacingY),paddingX=this.getMetric(this,"paddingX",this.paddingX),paddingY=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation==="vertical"){let num=this.children.length,h=this.h-spacingY*(num-1)-2*paddingY,w=this.w-2*paddingX,fixedh=0;for(let c of this.iterChildren())c.w=w,this.applyHints(c,w,h),"h"in c.hints&&(c.hints.h===null&&c.layoutChildren(),fixedh+=c.h,num--);let ch=(h-fixedh)/num,cw=w;(num===0&&h>0||ch<0)&&this.hints.h!==null&&(paddingY=(h-fixedh)/2);let y=this.y+paddingY,x=this.x+paddingX;for(let c of this.iterChildren())c.y=y,"w"in c.hints||(c.w=cw),"h"in c.hints||(c.h=ch),!("x"in c.hints)&&!("center_x"in c.hints)&&!("right"in c.hints)&&(c.x=x,w!==c.w&&(c.x+=(w-c.w)/2)),c.layoutChildren(),y+=spacingY+c.h;if(num===0&&this.hints.h===null){const oldH=this[3];this[3]=y+2*paddingY-this.y,Math.abs(oldH-this[3])>1e-6&&(App.get()._needsLayout=!0)}return}if(this.orientation==="horizontal"){let num=this.children.length,h=this.h-2*paddingY,w=this.w-spacingX*(num-1)-2*paddingX,fixedw=0;for(let c of this.iterChildren())c.h=h,this.applyHints(c,w,h),"w"in c.hints&&(c.hints.w===null&&c.layoutChildren(),fixedw+=c.w,num--);let ch=h,cw=(w-fixedw)/num;(num===0&&w>0||cw<0)&&this.hints.w!==null&&(paddingX=(w-fixedw)/2);let y=this.y+paddingY,x=this.x+paddingX;for(let c of this.iterChildren())c.x=x,"w"in c.hints||(c.w=cw),"h"in c.hints||(c.h=ch),!("y"in c.hints)&&!("center_y"in c.hints)&&!("bottom"in c.hints)&&(c.y=y,h!==c.h&&(c.y+=(h-c.h)/2)),c.layoutChildren(),x+=spacingX+c.w;if(num===0&&this.hints.w===null){const oldW=this[2];this[2]=x+2*paddingX-this.x,Math.abs(oldW-this[2])>1e-6&&(App.get()._needsLayout=!0)}}}}class Notebook extends Widget{constructor(){super();__publicField(this,"activePage",0)}on_wheel(event,object,wheel){const ch=this.children[this.activePage]??void 0;return!!(ch!==void 0&&ch.emit(event,wheel))}on_touch_down(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_up(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_move(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_cancel(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_activePage(e,o,v){this._needsLayout=!0}_draw(app,ctx,millis){this.draw(app,ctx);let transform=this.getTransform();if(transform){ctx.save(),ctx.transform(transform.a,transform.b,transform.c,transform.d,transform.e,transform.f);let w2=this.children[this.activePage]??void 0;w2!==void 0&&w2._draw(app,ctx,millis),ctx.restore();return}let w=this.children[this.activePage]??void 0;w!==void 0&&w._draw(app,ctx,millis)}}class TabbedNotebook extends Notebook{constructor(){super();__publicField(this,"tabHeightHint","1");__publicField(this,"tabGroupName","tabbedNotebookGroup");this.buttonBox=a(BoxLayout,{orientation:"horizontal",hints:{h:this.tabHeightHint,w:null}}),this.buttonScroller=a(ScrollView,{id:"_scrollview",hints:{h:this.tabHeightHint,w:1},children:[this.buttonBox]}),this._children=[this.buttonScroller],this.buttonScroller.parent=this,this.updateButtons()}on_tabHeightHint(e,o,v){this.buttonBox.hints.h=this.tabHeightHint}on_child_added(e,o,v){this.updateButtons()}on_child_removed(e,o,v){this.updateButtons()}on_wheel(event,object,wheel){const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,wheel))return!0;const ch=this.children[this.activePage]??void 0;return!!(ch!==void 0&&ch.emit(event,wheel))}on_touch_down(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,t))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,touch))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_up(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,t))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,touch))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_move(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,t))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,touch))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}on_touch_cancel(event,object,touch){let newT=this.getTransform();if(newT){let t=touch.copy(),dp=newT.inverse().transformPoint(new DOMPoint(t.pos[0],t.pos[1]));t.pos=[dp.x,dp.y];const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,t))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,t))return!0}else{const bb=this._children[0]??void 0;if(bb!==void 0&&bb.emit(event,touch))return!0;const ch=this.children[this.activePage]??void 0;if(ch!==void 0&&ch.emit(event,touch))return!0}return!1}get children(){return this._children.slice(1)}set children(children){for(let c of this._children.slice(1))this.emit("child_removed",c),c.parent=null,this._needsLayout=!0,this.updateButtons();this._children=this._children.slice(0,1);for(let c of children)this.addChild(c)}updateButtons(){this.buttonBox.children=[];let i=0;for(let page of this.children){const tb=a(ToggleButton,{text:page.name??String(i+1),group:this.tabGroupName,singleSelect:!0,press:this.activePage===i,fontSize:"0.5",hints:{h:null,w:null}});tb.listen("press",(e,o,v)=>{this.activePage=this.buttonBox.children.findIndex(w=>w===o)}),this.buttonBox.addChild(tb),i++}}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;const bb=this._children[0];this.applyHints(bb),bb.x=this.x,bb.y=this.y,bb.layoutChildren();const h=this.h-bb.h,w=this.w;for(let c of this.children)c.y=this.y+bb.h,c.x=this.x,c.w=w,c.h=h,c.layoutChildren()}_draw(app,ctx,millis){this.draw(app,ctx);let transform=this.getTransform();if(transform){ctx.save(),ctx.transform(transform.a,transform.b,transform.c,transform.d,transform.e,transform.f);let bb2=this._children[0]??void 0;bb2!==void 0&&bb2._draw(app,ctx,millis);let w2=this.children[this.activePage]??void 0;w2!==void 0&&w2._draw(app,ctx,millis),ctx.restore();return}let bb=this._children[0]??void 0;bb!==void 0&&bb._draw(app,ctx,millis);let w=this.children[this.activePage]??void 0;w!==void 0&&w._draw(app,ctx,millis)}}class GridLayout extends Widget{constructor(){super();__publicField(this,"numX",1);__publicField(this,"numY",1);__publicField(this,"spacingX",0);__publicField(this,"spacingY",0);__publicField(this,"paddingX",0);__publicField(this,"paddingY",0);__publicField(this,"orientation","horizontal")}on_numX(event,object,string){this._needsLayout=!0}on_numY(event,object,string){this._needsLayout=!0}on_spacingX(event,object,string){this._needsLayout=!0}on_spacingY(event,object,string){this._needsLayout=!0}on_paddingX(event,object,string){this._needsLayout=!0}on_paddingY(event,object,string){this._needsLayout=!0}on_orientation(event,object,string){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let spacingX=this.getMetric(this,"spacingX",this.spacingX),spacingY=this.getMetric(this,"spacingY",this.spacingY),paddingX=this.getMetric(this,"paddingX",this.paddingX),paddingY=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation==="horizontal"){const numX2=Math.max(1,this.numX),numY2=Math.max(1,Math.ceil(this.children.length/numX2));let hAvail2=this.h-spacingY*(numY2-1)-2*paddingY,wAvail2=this.w-spacingX*(numX2-1)-2*paddingX,_colWidths2=new Array(numX2).fill(0),_rowHeights2=new Array(numY2).fill(0),r3=0,c2=0,i2=0;for(let ch3 of this.children)this.applyHints(ch3,wAvail2,hAvail2),"w"in ch3.hints&&ch3.hints.w===null&&ch3.layoutChildren(),"h"in ch3.hints&&ch3.hints.h===null&&ch3.layoutChildren(),"w"in ch3.hints&&(_colWidths2[c2]=Math.max(ch3.w,_colWidths2[c2])),"h"in ch3.hints&&(_rowHeights2[r3]=Math.max(ch3.h,_rowHeights2[r3])),(i2+1)%numX2===0?(r3++,c2=0):c2++,i2++;let fixedW2=0,fixedH2=0,nfX2=0,nfY2=0;for(let cw3 of _colWidths2)fixedW2+=cw3,cw3>0&&nfX2++;for(let rh of _rowHeights2)fixedH2+=rh,rh>0&&nfY2++;if(nfX2===numX2&&this.hints&&this.hints.w===null){const oldW=this[2],newW=fixedW2+spacingX*(numX2-1)+2*paddingX;Math.abs(oldW-newW)>1e-6&&(this[2]=newW,typeof App<"u"&&App.get&&(App.get()._needsLayout=!0))}if(nfY2===numY2&&this.hints&&this.hints.h===null){const oldH=this[3],newH=fixedH2+spacingY*(numY2-1)+2*paddingY;Math.abs(oldH-newH)>1e-6&&(this[3]=newH,typeof App<"u"&&App.get&&(App.get()._needsLayout=!0))}hAvail2=this.h-spacingY*(numY2-1)-2*paddingY,wAvail2=this.w-spacingX*(numX2-1)-2*paddingX;let ch2=numY2>nfY2?(hAvail2-fixedH2)/(numY2-nfY2):0,cw2=numX2>nfX2?(wAvail2-fixedW2)/(numX2-nfX2):0;this.hints&&this.hints.h!==null&&nfY2===numY2&&hAvail2>fixedH2&&(paddingY=(hAvail2-fixedH2)/2),this.hints&&this.hints.w!==null&&nfX2===numX2&&wAvail2>fixedW2&&(paddingX=(wAvail2-fixedW2)/2);let y2=this.y+paddingY,x2=this.x+paddingX;r3=0,c2=0;for(let k=0;k<this.children.length;k++){const el=this.children[k],cw0=_colWidths2[c2]===0?cw2:_colWidths2[c2],ch0=_rowHeights2[r3]===0?ch2:_rowHeights2[r3];"w"in el.hints||(el.w=cw0),"h"in el.hints||(el.h=ch0),el.x=x2,el.y=y2,el.layoutChildren(),(k+1)%numX2===0?(x2=this.x+paddingX,y2+=spacingY+ch0,c2=0,r3++):(x2+=spacingX+cw0,c2++)}return}const numY=Math.max(1,this.numY),numX=Math.max(1,Math.ceil(this.children.length/numY));let hAvail=this.h-spacingY*(numY-1)-2*paddingY,wAvail=this.w-spacingX*(numX-1)-2*paddingX,_colWidths=new Array(numX).fill(0),_rowHeights=new Array(numY).fill(0),r2=0,c=0,i=0;for(let ch2 of this.children)this.applyHints(ch2,wAvail,hAvail),"w"in ch2.hints&&ch2.hints.w===null&&ch2.layoutChildren(),"h"in ch2.hints&&ch2.hints.h===null&&ch2.layoutChildren(),"w"in ch2.hints&&(_colWidths[c]=Math.max(ch2.w,_colWidths[c])),"h"in ch2.hints&&(_rowHeights[r2]=Math.max(ch2.h,_rowHeights[r2])),(i+1)%numY===0?(c++,r2=0):r2++,i++;let fixedW=0,fixedH=0,nfX=0,nfY=0;for(let cw2 of _colWidths)fixedW+=cw2,cw2>0&&nfX++;for(let rh of _rowHeights)fixedH+=rh,rh>0&&nfY++;if(nfX===numX&&this.hints&&this.hints.w===null){const oldW=this[2],newW=fixedW+spacingX*(numX-1)+2*paddingX;Math.abs(oldW-newW)>1e-6&&(this[2]=newW,typeof App<"u"&&App.get&&(App.get()._needsLayout=!0))}if(nfY===numY&&this.hints&&this.hints.h===null){const oldH=this[3],newH=fixedH+spacingY*(numY-1)+2*paddingY;Math.abs(oldH-newH)>1e-6&&(this[3]=newH,typeof App<"u"&&App.get&&(App.get()._needsLayout=!0))}hAvail=this.h-spacingY*(numY-1)-2*paddingY,wAvail=this.w-spacingX*(numX-1)-2*paddingX;let ch=numY>nfY?(hAvail-fixedH)/(numY-nfY):0,cw=numX>nfX?(wAvail-fixedW)/(numX-nfX):0;this.hints&&this.hints.h!==null&&nfY===numY&&hAvail>fixedH&&(paddingY=(hAvail-fixedH)/2),this.hints&&this.hints.w!==null&&nfX===numX&&wAvail>fixedW&&(paddingX=(wAvail-fixedW)/2);let y=this.y+paddingY,x=this.x+paddingX;r2=0,c=0;for(let k=0;k<this.children.length;k++){const el=this.children[k],cw0=_colWidths[c]===0?cw:_colWidths[c],ch0=_rowHeights[r2]===0?ch:_rowHeights[r2];"w"in el.hints||(el.w=cw0),"h"in el.hints||(el.h=ch0),el.x=x,el.y=y,el.layoutChildren(),(k+1)%numY===0?(y=this.y+paddingY,x+=spacingX+cw0,r2=0,c++):(y+=spacingY+ch0,r2++)}}}class ScrollView extends Widget{constructor(){super();__publicField(this,"_scrollX",0);__publicField(this,"_scrollY",0);__publicField(this,"scrollX",0);__publicField(this,"scrollY",0);__publicField(this,"scrollW",!0);__publicField(this,"scrollH",!0);__publicField(this,"wAlign","center");__publicField(this,"hAlign","top");__publicField(this,"uiZoom",!0);__publicField(this,"uiMove",!0);__publicField(this,"zoom",1);__publicField(this,"vel",null);__publicField(this,"velCutoff",1e-5);__publicField(this,"velDecay",.95);__publicField(this,"unboundedH",!1);__publicField(this,"unboundedW",!1);__publicField(this,"_zoomCenter",null);this._processTouches=!0,this._oldTouch=null,this._lastDist=null}on_child_added(event,object,child){this.children.length==1&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0,child.listen("rect",(event2,obj,data)=>this._needsLayout=!0),child.listen("w",(event2,obj,data)=>this._needsLayout=!0),child.listen("h",(event2,obj,data)=>this._needsLayout=!0))}on_child_removed(event,object,child){this.children.length==0&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0)}on_focus_visible(event,object,data){const target=data==null?void 0:data.target,appRect=data==null?void 0:data.appRect;if(!(target instanceof Widget)||!appRect)return!1;let isDescendant=!1;for(const parent of target.iterParents())if(parent===this){isDescendant=!0;break}if(!isDescendant||this.children.length===0)return!1;const childPoints=[[appRect[0],appRect[1]],[appRect[0]+appRect[2],appRect[1]],[appRect[0]+appRect[2],appRect[1]+appRect[3]],[appRect[0],appRect[1]+appRect[3]]].map(([x,y])=>this.appToChild([x,y])),xs=childPoints.map(([x])=>x),ys=childPoints.map(([,y])=>y),minX=Math.min(...xs),maxX=Math.max(...xs),minY=Math.min(...ys),maxY=Math.max(...ys),viewportW=this.w/this.zoom,viewportH=this.h/this.zoom;let nextScrollX=this.scrollX,nextScrollY=this.scrollY;if((this.scrollW||this.unboundedW)&&viewportW>0){const left=minX,right=maxX,viewLeft=this.scrollX,viewRight=this.scrollX+viewportW;left<viewLeft&&(nextScrollX=left),right>viewRight&&(nextScrollX=Math.max(nextScrollX,right-viewportW))}if((this.scrollH||this.unboundedH)&&viewportH>0){const top=minY,bottom=maxY,viewTop=this.scrollY,viewBottom=this.scrollY+viewportH;top<viewTop&&(nextScrollY=top),bottom>viewBottom&&(nextScrollY=Math.max(nextScrollY,bottom-viewportH))}return nextScrollX!==this.scrollX&&(this.scrollX=nextScrollX),nextScrollY!==this.scrollY&&(this.scrollY=nextScrollY),!1}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.children[0][0]=0,this.children[0][1]=0,this.scrollW||(this.children[0][2]=this.w),this.scrollH||(this.children[0][3]=this.h);for(let c of this.children)c.layoutChildren()}fitToClient(){this.zoom=Math.min(this.w/this.children[0].w,this.h/this.children[0].h),this.scrollX=.5*this.scrollableW,this.scrollY=.5*this.scrollableH}on_uiZoom(event,object,value){this._needsLayout=!0}on_hAlign(event,object,value){this._needsLayout=!0}on_vAlign(event,object,value){this._needsLayout=!0}*iter(recursive=!0,inView=!0){if(yield this,!!recursive)if(inView)for(let c of this._children)this.contains(c)&&(yield*c.iter(...arguments));else for(let c of this._children)yield*c.iter(...arguments)}on_scrollW(event,object,value){this._needsLayout=!0,this.scrollX=0}on_scrollH(event,object,value){this._needsLayout=!0,this.scrollY=0}on_scrollX(event,object,value){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedW){this._scrollX=this.scrollX;return}let align=0;switch(this.wAlign){case"center":align=.5*this.scrollableW;break;case"right":align=1*this.scrollableW}this._scrollX=this.scrollableW<=0||this.scrollableW>=this.children[0].w?align:value,this._scrollX=clamp(value,0,this.scrollableW)}on_scrollY(event,object,value){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedH){this._scrollY=this.scrollY;return}let align=0;switch(this.hAlign){case"middle":align=.5*this.scrollableH;break;case"bottom":align=1*this.scrollableH}this._scrollY=this.scrollableH<=0||this.scrollableH>=this.children[0].h?align:value,this._scrollY=clamp(value,0,this.scrollableH)}update(app,millis){if(super.update(app,millis),this.vel!==null){this.scrollX+=this.vel.x*millis,this.scrollY+=this.vel.y*millis,this.vel=this.vel.scale(this.velDecay**(millis/30));let a2=this.vel.abs();a2.x<=this.velCutoff/this.zoom&&a2.y<=this.velCutoff/this.zoom&&(this.vel=null)}}getTransform(){const ts=App.get().tileSize;return new DOMMatrix().translate(Math.floor((this.x-this._scrollX*this.zoom)*ts)/ts,Math.floor((this.y-this._scrollY*this.zoom)*ts)/ts).scale(this.zoom,this.zoom)}on_touch_down(event,object,touch){this.vel=null;let r2=touch.rect;if(this._lastDist=null,this.collide(r2)){let millis=Date.now(),tl=touch.asChildTouch(this);return this._oldTouch=[tl.x,tl.y,tl.identifier,millis,null],super.on_touch_down(event,object,touch)||touch.grab(this),!0}return!1}on_touch_up(event,object,touch){if(touch.grabbed!==this)return!1;if(this._oldTouch!=null){let ovel=this._oldTouch[4],tl=new Vec22([this._oldTouch[0],this._oldTouch[1]]),tln=touch.asChildTouch(this),millis=Math.max(Date.now()-this._oldTouch[3],1),vx=this.scrollableW>0||this.unboundedW?(tln.x-tl.x)/millis:0,vy=this.scrollableH>0||this.unboundedH?(tln.y-tl.y)/millis:0;this.vel=new Vec22([-vx,-vy]),ovel&&(this.vel=this.vel.add(ovel).scale(.5))}return this._oldTouch=null,this._lastDist=null,this._zoomCenter=null,touch.ungrab(),!1}on_touch_move(event,object,touch){if(touch.grabbed!==this)return!1;let r2=touch.rect;if(this.collide(r2)){let tl=touch.asChildTouch(this);if((this.uiMove&&touch.nativeEvent==null||touch.nativeEvent instanceof TouchEvent&&touch.nativeEvent.touches.length==1)&&this._oldTouch!=null&&touch.identifier==this._oldTouch[2]){this.scrollW&&(this.scrollX=this.scrollableW==0?0:this._scrollX+(this._oldTouch[0]-tl.x)),this.scrollH&&(this.scrollY=this.scrollableH==0?0:this._scrollY+(this._oldTouch[1]-tl.y));let tln=touch.asChildTouch(this),ot=this._oldTouch,time=Date.now(),vel=new Vec22([0,0]),ovel=new Vec22([0,0]);if(ot!=null){let millis=Math.max(time-ot[3],1),vx=this.scrollableW>0||this.unboundedW?(tln.x-tl.x)/millis:0,vy=this.scrollableH>0||this.unboundedH?(tln.y-tl.y)/millis:0;vel=new Vec22([vx,vy]),ovel=ot[4]!==null?ot[4]:ovel}let nvel=vel.abs().sum()===0?vel:vel.add(ovel).scale(.5);this._oldTouch=[tln.x,tln.y,touch.identifier,time,nvel]}if(this.uiZoom&&touch.nativeEvent&&touch.nativeEvent instanceof TouchEvent&&touch.nativeEvent.touches.length==2){let t0=touch.nativeEvent.touches[0],t1=touch.nativeEvent.touches[1],d=dist([t0.clientX,t0.clientY],[t1.clientX,t1.clientY]);if(this._lastDist!=null){let scrollPosCenterW=this._scrollX+this.w/this.zoom/2,scrollPosCenterH=this._scrollY+this.h/this.zoom/2,touchPixelPos0=[t0.clientX,t0.clientY],touchPixelPos1=[t1.clientX,t1.clientY],scrollableTouchPosBefore0=this.appToChild(touchPixelPos0),scrollableTouchPosBefore1=this.appToChild(touchPixelPos1),sTargetCenterPosBefore=[(scrollableTouchPosBefore0[0]+scrollableTouchPosBefore1[0])/2,(scrollableTouchPosBefore0[1]+scrollableTouchPosBefore1[1])/2];this._zoomCenter===null&&(this._zoomCenter=new Vec22(sTargetCenterPosBefore));let zoom=this.zoom*d/this._lastDist,minZoom=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(zoom,minZoom);let scrollableTouchPosAfter0=this.appToChild(touchPixelPos0),scrollableTouchPosAfter1=this.appToChild(touchPixelPos1),sTargetCenterPosAfter=[(scrollableTouchPosAfter0[0]+scrollableTouchPosAfter1[0])/2,(scrollableTouchPosAfter0[1]+scrollableTouchPosAfter1[1])/2];this.scrollX=scrollPosCenterW+sTargetCenterPosBefore[0]-sTargetCenterPosAfter[0]-this.w/this.zoom/2,this.scrollY=scrollPosCenterH+sTargetCenterPosBefore[1]-sTargetCenterPosAfter[1]-this.h/this.zoom/2}this._lastDist=d}}return!1}on_touch_cancel(event,object,touch){return this._lastDist=null,touch.grabbed===this?(touch.ungrab(),!0):!!super.on_touch_cancel(event,object,touch)}on_wheel(event,object,touch){let app=App.get();if(!app.inputHandler)return!0;let sx=this._scrollX+this.w/this.zoom/2,sy=this._scrollY+this.h/this.zoom/2,wheel=touch.nativeObject;if(!this.collide(touch.rect)&&(!this.unboundedW||!this.unboundedH)||!(wheel instanceof WheelEvent))return!1;if(this.uiZoom&&app.inputHandler.isKeyDown("Control")){let loc=touch.asChildTouch(this);loc.pos[0],loc.pos[1];let zoom=this.zoom*Math.exp(-wheel.deltaY/app.h),minZoom=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(zoom,minZoom);let moc=touch.asChildTouch(this);return moc.pos[0],moc.pos[1],this.scrollX=this.scrollableW==0&&!this.unboundedW?0:sx-this.w/this.zoom/2,this.scrollY=this.scrollableH==0&&!this.unboundedH?0:sy-this.h/this.zoom/2,this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}else{if(this.uiMove&&this.scrollW&&app.inputHandler.isKeyDown("Shift"))return this.scrollX+=this.scrollableW==0&&!this.unboundedW?0:this.w/this.zoom*(wheel.deltaY/app.w),this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),!0;if(this.uiMove&&this.scrollH)return this.scrollY+=this.scrollableH==0&&!this.unboundedH?0:this.h/this.zoom*(wheel.deltaY/app.h),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}return!1}get scrollableW(){return this.children.length==0?0:this.unboundedW?this.children[0].w-this.w/this.zoom:Math.max(this.children[0].w-this.w/this.zoom,0)}get scrollableH(){return this.children.length==0?0:this.unboundedH?this.children[0].h-this.h/this.zoom:Math.max(this.children[0].h-this.h/this.zoom,0)}_draw(app,ctx,millis){this.draw(app,ctx);let r2=this.rect;r2[0]=Math.floor(r2[0]*app.tileSize*app.pixelSize)/(app.tileSize*app.pixelSize),r2[1]=Math.floor(r2[1]*app.tileSize*app.pixelSize)/(app.tileSize*app.pixelSize),r2[2]=Math.floor(r2[2]*app.tileSize*app.pixelSize)/(app.tileSize*app.pixelSize),r2[3]=Math.floor(r2[3]*app.tileSize*app.pixelSize)/(app.tileSize*app.pixelSize),ctx.save(),ctx.beginPath(),ctx.rect(r2[0],r2[1],r2[2],r2[3]),ctx.clip();let newT=this.getTransform();newT&&ctx.transform(newT.a,newT.b,newT.c,newT.d,newT.e,newT.f),this.children[0]._draw(app,ctx,millis),ctx.restore()}}class ModalView extends BoxLayout{constructor(){super();__publicField(this,"closeOnTouchOutside",!0);__publicField(this,"bgColor","slate");__publicField(this,"outlineColor","gray");__publicField(this,"dim",!0);__publicField(this,"dimScale",.8)}get visible(){return App.get()._modalWidgets.indexOf(this)>=0}popup(){if(this.parent==null){let app=App.get();return this.parent=app,app.addModal(this),!0}return!1}close(exitVal=0){if(this.parent!=null){this.emit("close",exitVal);let app=App.get();return this.parent=null,app.removeModal(this),!0}return!1}on_touch_down(event,object,touch){return this.closeOnTouchOutside&&!this.collide(touch.rect)?(this.close(),!0):super.on_touch_down(event,object,touch)}draw(app,ctx){if(this.dim){let r2=App.get().baseWidget.rect,ctx2=App.get().ctx;if(!ctx2)return;ctx2.fillStyle="rgba(0,0,0,"+this.dimScale+")",ctx2.rect(r2[0],r2[1],r2[2],r2[3]),ctx2.fill(),super.draw(app,ctx2)}}on_escape(event,object,data){return this.visible?(this.close(),!0):!1}}function unpackSpriteInfo(ind,len2,sw){const flipped=Math.floor(ind/len2/4)>0;ind=ind%(len2*4);const angle=Math.floor(ind/len2);ind=ind%len2;const indY=Math.floor(ind/sw),indX=ind%sw;return[flipped,angle,indY,indX]}class SpriteSheet extends Resource{constructor(srcFile,spriteSize=16,padding=0,owner=null){super();__publicField(this,"animations",new Map);__publicField(this,"autoTiles",new Map);__publicField(this,"tileStamps",new Map);__publicField(this,"aliases",new Map);this.spriteSize=spriteSize,this.padding=padding,this.sw=0,this.sh=0,this.len=0,this.sheet=new Image,this.canvas=this.sheet,this.sheet.onload=ev=>{this.sw=Math.floor(this.sheet.width/this.spriteSize),this.sh=Math.floor(this.sheet.height/this.spriteSize),this.len=this.sw*this.sh,this.padding>0&&(this.canvas=this.padSheet(this.padding)),owner===null?(App.get().emit("sheetLoaded",this.canvas),App.get()._needsLayout=!0):owner.emit("sheetLoaded",this.canvas)},this.sheet.src=srcFile}padSheet(pad=0){const newWidth=this.sw*(this.spriteSize+pad),newHeight=this.sh*(this.spriteSize+pad),newCanvas=new OffscreenCanvas(newWidth,newHeight),newCtx=newCanvas.getContext("2d");newCtx.clearRect(0,0,newWidth,newHeight);for(let y=0;y<this.sh;y++)for(let x=0;x<this.sw;x++){const sx=x*this.spriteSize,sy=y*this.spriteSize,dx=x*(this.spriteSize+pad),dy=y*(this.spriteSize+pad);newCtx.drawImage(this.sheet,sx,sy,this.spriteSize,this.spriteSize,dx,dy,this.spriteSize,this.spriteSize)}return newCanvas}getAlias(index){for(let k of this.aliases.keys())if(this.aliases.get(k)===index)return k}update(app,millis){super.update(app,millis);for(let a2 of this.animations.values())a2.update(app,millis)}sheetToDataURL(){const canvas=document.createElement("canvas");canvas.width=this.sheet.width,canvas.height=this.sheet.height;const ctx=canvas.getContext("2d");return ctx?(ctx.drawImage(this.sheet,0,0),canvas.toDataURL("image/png")):void 0}serialize(){const data={};data.spriteSize=this.spriteSize,data.padding=this.padding,data.src=this.sheetToDataURL();const animations={};for(let k of this.animations.keys())animations[String(k)]=this.animations.get(k);data.animations=animations;const aliases={};for(let k of this.aliases.keys())aliases[k]=this.aliases.get(k);return data.aliases=aliases,data}deserialize(data){this.spriteSize=data.spriteSize,this.padding=data.padding,this.sheet=new Image,this.canvas=this.sheet,this.sheet.onload=ev=>{this.sw=Math.floor(this.sheet.width/this.spriteSize),this.sh=Math.floor(this.sheet.height/this.spriteSize),this.len=this.sw*this.sh,App.get().emit("sheetLoaded",this.sheet),App.get()._needsLayout=!0,this.padding>0&&(this.canvas=this.padSheet(this.padding))},this.sheet.src=data.src,this.animations=new Map;for(let k in data.animations)this.animations.set(parseInt(k),data.animations[k]);this.aliases=new Map;for(let k in data.aliases)this.aliases.set(k,data.aliases[k])}drawIndexed(ctx,ind,x,y,extraAngle=0,flipX=!1,dx=0,dy=0){var _a;if(ind<-1&&(ind=((_a=this.animations.get(ind))==null?void 0:_a.tileValue)??-1),ind>=0){let[flipped,angle,indY,indX]=unpackSpriteInfo(ind,this.len,this.sw);flipped=flipped&&!flipX||!flipped&&flipX,angle=(angle+extraAngle)%4,!flipped&&angle===0?this.draw(ctx,[indX,indY],x+dx,y+dy):this.drawRotated(ctx,[indX,indY],x+.5,y+.5,angle*90,flipped,[.5-dx,.5-dy])}}draw(ctx,spriteLoc,x,y,flipX=!1){let flipped=flipX?-1:1;flipX&&ctx.scale(-1,1);const sz=this.spriteSize,szp=this.spriteSize+this.padding;ctx.drawImage(this.canvas,spriteLoc[0]*szp,spriteLoc[1]*szp,sz,sz,flipped*x,y,flipped,1),flipX&&ctx.scale(-1,1)}drawScaled(ctx,spriteLoc,x,y,scale2,flipX=!1){let flipped=flipX?-1:1;flipX&&ctx.scale(-1,1);const sz=this.spriteSize,szp=this.spriteSize+this.padding;ctx.drawImage(this.canvas,spriteLoc[0]*szp,spriteLoc[1]*szp,sz,sz,flipped*x,y,flipped*scale2,scale2),flipX&&ctx.scale(-1,1)}drawRotated(ctx,spriteLoc,x,y,angle,flipx=!1,anchor="center"){ctx.save(),anchor=="center"?anchor=[1/2,1/2]:anchor=[anchor[0],anchor[1]],ctx.translate(x,y),ctx.rotate(angle*Math.PI/180),flipx&&ctx.scale(-1,1),ctx.translate(-anchor[0],-anchor[1]);const sz=this.spriteSize,szp=this.spriteSize+this.padding;ctx.drawImage(this.canvas,spriteLoc[0]*szp,spriteLoc[1]*szp,sz,sz,0,0,1,1),ctx.restore()}drawRotatedMultitile(ctx,spriteLoc,x,y,angle,flipx=!1,anchor="center"){ctx.save();let tw=spriteLoc[2],th=spriteLoc[3];anchor=="center"?anchor=[tw*1/2,th*1/2]:anchor=[anchor[0],anchor[1]],ctx.translate(x+anchor[0],y+anchor[1]),ctx.rotate(angle*Math.PI/180),flipx&&ctx.scale(-1,1),ctx.translate(-anchor[0],-anchor[1]);const sz=this.spriteSize,szp=this.spriteSize+this.padding;ctx.drawImage(this.canvas,spriteLoc[0]*szp,spriteLoc[1]*szp,sz*tw,sz*th,0,0,tw,th),ctx.restore()}}class LayeredAnimationFrame extends Array{constructor(frames,offsets){super();for(let i=0;i<frames.length;++i)offsets[i]?this.push(frames[i],offsets[i][0],offsets[i][1]):this.push(frames[i],0,0)}*iter(){for(let i=0;i<this.length/3;i++)yield[this[i*3],this[i*3+1],this[i*3+2]]}}function laf(frames=[],offsets=[]){return new LayeredAnimationFrame(frames,offsets)}class SpriteWidget extends Widget{constructor(){super(...arguments);__publicField(this,"spriteSheet",null);__publicField(this,"frames",[]);__publicField(this,"timePerFrame",30);__publicField(this,"timeLeft",0);__publicField(this,"activeFrame",0);__publicField(this,"id","");__publicField(this,"facing",0);__publicField(this,"flipX",!1);__publicField(this,"flipY",!1);__publicField(this,"oneShot",!1)}update(app,millis){if(super.update(app,millis),this.timeLeft-=millis,this.timeLeft<=0){if(this.oneShot&&this.activeFrame===this.frames.length-1){this.timeLeft=1/0,this.emit("animationComplete",this.activeFrame);return}this.activeFrame++,this.activeFrame>=this.frames.length&&(this.activeFrame=0),this.timeLeft+=this.timePerFrame}this.frames.length>0&&this.timeLeft!==1/0&&app.requestFrameUpdate()}restart(){this.activeFrame=0,this.timeLeft=this.timePerFrame}on_frames(e,o,v){this.restart()}get frame(){return this.frames[this.activeFrame]??-1}draw(app,ctx){var _a;if(this.spriteSheet===null||!((_a=this.spriteSheet.sheet)!=null&&_a.complete))return;const tx=Math.floor(this.x*this.spriteSheet.spriteSize)/this.spriteSheet.spriteSize,ty=Math.floor(this.y*this.spriteSheet.spriteSize)/this.spriteSheet.spriteSize;if(ctx.translate(tx,ty),ctx.scale(this.w,this.h),this.bgColor!==null){const color=ctx.fillStyle;ctx.fillStyle=this.bgColor,ctx.fillRect(0,0,1,1),ctx.fillStyle=color}if(this.frame instanceof LayeredAnimationFrame)for(let[f,dx,dy]of this.frame.iter())this.spriteSheet.drawIndexed(ctx,f,0,0,this.facing,this.flipX,dx,dy);else this.spriteSheet.drawIndexed(ctx,this.frame,0,0,this.facing,this.flipX);ctx.scale(1/this.w,1/this.h),ctx.translate(-tx,-ty)}}class TileMap extends Widget{constructor(props={}){super(),this.defaultValue=-1,this._data=new Grid2D,this._vLayer=null,this._aLayer=null,this._cacheTileDim=new Vec22,this.tileDim=new Vec22,this.hints={w:null,h:null},this.spriteSheet=null,this.clipRegion=null,this.alphaValue=.5,this.useCache=!0,props&&this.updateProperties(props)}serialize(){const data={};return data._data=this._data.slice(),data.tileDim=this.tileDim.slice(),data.spriteSheet=Array(...App.resources.keys()).find(k=>App.resources[k]===this.spriteSheet)??null,data}get(pos){return this._data.get(pos)}set(pos,value){this._data.set(pos,value),this._data._cacheData=null}get data(){return this._data}deserialize(data){this.tileDim=new Vec22(data.tileDim??[0,0]);const _data=data._data;for(let i=0;i<_data.length;i++)this._data[i]=_data[i];this.spriteSheet=App.resources[data.spriteSheet]??null,this._data._cacheData=null}on_tileDim(evt,obj,val){this.resizeData(),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new Vec22(this.tileDim)}resizeData(){let cacheData=[];for(let y=0;y<this._cacheTileDim[1];y++)for(let x=0;x<this._cacheTileDim[0];x++)cacheData.push(this.get([x,y]));this._data.tileDim=new Vec22(this.tileDim),this._data.length=this.tileDim[0]*this.tileDim[1],this._data.fill(this.defaultValue);let i=0;for(let y=0;y<this._cacheTileDim[1];y++)for(let x=0;x<this._cacheTileDim[0];x++)x<this.tileDim[0]&&y<this.tileDim[1]&&this.set([x,y],cacheData[i]),++i;this._data._cacheData=null}draw(app,ctx){if(super.draw(app,ctx),this.spriteSheet===null||!this.spriteSheet.sheet.complete||!this.spriteSheet.sheet.complete||this.spriteSheet.sheet.naturalHeight==0)return;let[x0,y0]=[0,0],[x1,y1]=this.tileDim;if(this.clipRegion&&([x0,y0]=this.clipRegion.pos,[x1,y1]=this.clipRegion.pos.add(this.clipRegion.size).add([1,1]),x0=Math.min(Math.max(x0,0),this.tileDim[0]),x1=Math.min(Math.max(x1,0),this.tileDim[0]),y0=Math.min(Math.max(y0,0),this.tileDim[1]),y1=Math.min(Math.max(y1,0),this.tileDim[1])),Math.floor(this.spriteSheet.sheet.width/this.spriteSheet.spriteSize),Math.floor(this.spriteSheet.sheet.height/this.spriteSheet.spriteSize),this.useCache){if(this._data._cacheData===null&&this.cacheCanvas(),this._data._cacheData===null)return;const s=this.spriteSheet.spriteSize;if(ctx.drawImage(this._data._cacheData,s*x0,s*y0,s*(x1-x0),s*(y1-y0),this.x+x0,this.y+y0,x1-x0,y1-y0),this._aLayer===null&&this._vLayer===null)for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=this._data[p];ind<-1&&this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y)}else if(this._aLayer&&this._vLayer){const aL=this._aLayer,vL=this._vLayer,origAlpha=ctx.globalAlpha,dat=this._data;for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=dat[p];ind<-1&&vL[p]>0&&(aL[p]===0?(ctx.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y),ctx.globalAlpha=origAlpha):this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y))}}}else if(this._aLayer===null&&this._vLayer===null)for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=this._data[p];this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y)}else if(this._aLayer&&this._vLayer){const aL=this._aLayer,vL=this._vLayer,origAlpha=ctx.globalAlpha,dat=this._data;for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=dat[p];ind!==-1&&vL[p]>0&&(aL[p]===0?(ctx.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y),ctx.globalAlpha=origAlpha):this.spriteSheet.drawIndexed(ctx,ind,x+this.x,y+this.y))}}}clearCache(){this.data._cacheData=null}cacheCanvas(){if(this._data._cacheData=null,!this.spriteSheet||!this.spriteSheet.sheet||this.tileDim[0]<=0||this.tileDim[1]<=0)return;const _cacheData=new OffscreenCanvas(this.tileDim[0]*this.spriteSheet.spriteSize,this.tileDim[1]*this.spriteSheet.spriteSize),cacheCtx=_cacheData.getContext("2d");if(!cacheCtx)return;cacheCtx.scale(this.spriteSheet.spriteSize,this.spriteSheet.spriteSize);let[x0,y0]=[0,0],[x1,y1]=this.tileDim;if(this._aLayer===null&&this._vLayer===null)for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=this._data[p];ind>=0&&this.spriteSheet.drawIndexed(cacheCtx,ind,x,y)}else if(this._aLayer&&this._vLayer){const aL=this._aLayer,vL=this._vLayer,origAlpha=cacheCtx.globalAlpha,dat=this._data;for(let x=x0;x<x1;x++)for(let y=y0;y<y1;y++){let p=x+y*this.tileDim[0],ind=dat[p];ind>=0&&vL[p]>0&&(aL[p]===0?(cacheCtx.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(cacheCtx,ind,x,y),cacheCtx.globalAlpha=origAlpha):this.spriteSheet.drawIndexed(cacheCtx,ind,x,y))}}this._data._cacheData=_cacheData}}class LayeredTileMap extends TileMap{constructor(props={}){super(),this._layerData=[this._data],this.numLayers=1,this.activeLayer=0,this.visibilityLayer=-1,this.alphaLayer=-1,props&&this.updateProperties(props)}on_alphaLayer(e,o,v){this._aLayer=this.alphaLayer>=0?this._layerData[this.alphaLayer]:null}on_visibilityLayer(e,o,v){this._vLayer=this.visibilityLayer>=0?this._layerData[this.visibilityLayer]:null}serialize(){const data={},layerCopy=[];for(let l of this._layerData)layerCopy.push(l.slice());return data._layerData=layerCopy,data.activeLayer=this.activeLayer,data.numLayers=this.numLayers,data.tileDim=this.tileDim.slice(),data.spriteSheet=Array(...App.resources.keys()).find(k=>App.resources[k]===this.spriteSheet)??null,data}deserialize(data){this.numLayers=data.numLayers,this.activeLayer=data.activeLayer,this.tileDim=new Vec22(data.tileDim??[0,0]);const n=data._layerData.length;this._layerData.length=n;for(let i=0;i<n;i++){const lout=this._layerData[i],lin=data._layerData[i];for(let j=0;j<lin.lenth;j++)lout[j]=lin[j]}this.spriteSheet=App.resources[data.spriteSheet]??null,this.clearCache()}on_tileDim(evt,obj,val){if("_layerData"in this){for(let l of this._layerData)this._data=l,this.resizeData();this.activeLayer>=0&&(this._data=this._layerData[this.activeLayer]),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new Vec22(this.tileDim)}}on_numLayers(evt,obj,val){const oldLen=this._layerData.length;this._layerData.length=this.numLayers;for(let i=oldLen;i<this.numLayers;i++){const layer=new Grid2D(this.tileDim).fill(this.defaultValue);this._layerData[i]=layer}this.activeLayer>=this.numLayers&&(this.activeLayer=this.numLayers-1)}on_activeLayer(evt,obj,val){this._data=this._layerData[this.activeLayer]}get layer(){return this._layerData}getFromLayer(layer,pos){return this._layerData[layer][pos[0]+pos[1]*this.tileDim[0]]}setInLayer(layer,pos,val){this._layerData[layer][pos[0]+pos[1]*this.tileDim[0]]=val,this._layerData[layer]._cacheData=null}clearCache(){for(let l of this._layerData)l._cacheData=null}draw(app,ctx){for(let l of this._layerData)l.hidden||(this._data=l,super.draw(app,ctx));this._data=this._layerData[this.activeLayer]}}App.registerClass("Widget",Widget,"");App.registerClass("App",App,"");App.registerClass("Label",Label,"");App.registerClass("Button",Button,"");App.registerClass("ToggleButton",ToggleButton,"");App.registerClass("BasicButton",BasicButton,"");App.registerClass("TextInput",TextInput,"");App.registerClass("CheckBox",CheckBox,"");App.registerClass("Slider",Slider,"");App.registerClass("ImageWidget",ImageWidget,"");App.registerClass("BoxLayout",BoxLayout,"");App.registerClass("GridLayout",GridLayout,"");App.registerClass("ScrollView",ScrollView,"");App.registerClass("ModalView",ModalView,"");App.registerClass("Notebook",Notebook,"");App.registerClass("TabbedNotebook",TabbedNotebook,"");App.registerClass("SpriteWidget",SpriteWidget,"");App.registerClass("TileMap",TileMap,"");App.registerClass("LayeredTileMap",LayeredTileMap,"");const LEAD_RANGE=40,RETURN_DIST=60;function computeGoalShotTarget(player,goalTarget,kickRange,distToGoal){const horizontalDist=Math.max(0,distToGoal),extraDistance=Math.min(10,Math.max(0,kickRange-horizontalDist));let direction=goalTarget.c.sub(player.pos).zeroY();return direction.lenSq()>1e-6?direction=direction.normalize():direction=v3(0,0,player.team==="home"?-1:1),goalTarget.c.add(direction.scale(extraDistance))}const KICK_ANGLE_SHORT_DEG=25,KICK_ANGLE_MID_DEG=30,KICK_ANGLE_LONG_DEG=40,KICK_ANGLE_SHORT_RATIO=.7;function getKickAngleDeg(distance,statsKickRange){const maxRange=Math.max(statsKickRange,1e-6),shortRange=KICK_ANGLE_SHORT_RATIO*maxRange,clampedDistance=Math.min(Math.max(distance,0),maxRange);if(clampedDistance<=shortRange){const t2=shortRange>0?clampedDistance/shortRange:0;return KICK_ANGLE_SHORT_DEG+(KICK_ANGLE_MID_DEG-KICK_ANGLE_SHORT_DEG)*t2}const rangeSpan=Math.max(maxRange-shortRange,1e-6),t=(clampedDistance-shortRange)/rangeSpan;return KICK_ANGLE_MID_DEG+(KICK_ANGLE_LONG_DEG-KICK_ANGLE_MID_DEG)*t}function distToSegmentXZ(p,a2,b){const ax=a2[0],az=a2[2],bx=b[0],bz=b[2],px=p[0],pz=p[2],abx=bx-ax,abz=bz-az,apx=px-ax,apz=pz-az,abLenSq=abx*abx+abz*abz;if(abLenSq<1e-5)return Math.hypot(apx,apz);const t=Math.max(0,Math.min(1,(apx*abx+apz*abz)/abLenSq)),cx=ax+abx*t,cz=az+abz*t;return Math.hypot(px-cx,pz-cz)}function ahead(player,target){const targetZ="pos"in target?target.pos.z:target.z;return player.team==="home"?player.pos.z<targetZ:player.pos.z>targetZ}function inFront(player,target){const f=player.vel.xz,v=("pos"in target?target.pos:target).c.sub(player.pos).xz;return f.dot(v)>=0}function predictCatchPoint(player,mate,handpass=!0,mateVelOverride=void 0){const offset=mate.pos.c.sub(player.pos);let aimXZ=v2(offset[0],offset[2]);const aimDist=aimXZ.len();if(handpass){const handRange=(player.statsHandpassRange??0)*(player.buffHandball??1);handRange>1e-6&&aimDist>handRange&&(aimXZ=aimXZ.scale(handRange/aimDist))}const vel=computeKickVelocity(player,aimXZ,handpass);if(!vel)return mate.pos.c;const gravity=-player.gravity[1],originY=player.pos[1],endOffsetY=handpass?player.statsHeight-.1:0,verticalRoots=solveQuadratic(-.5*gravity,vel[1],originY-(originY+endOffsetY)).filter(t=>t>0);let flight=verticalRoots.length?Math.max(...verticalRoots):0;if(flight<=0){const flatSpeed=Math.hypot(vel[0],vel[2]),dist2=aimXZ.len();flight=flatSpeed>1e-6?dist2/flatSpeed:0}let dt=Math.min(flight,handpass?.55:.95);const aimDir=aimXZ.len()>1e-5?aimXZ.c.normalize():v2(0,0),mateVel=mateVelOverride??mate.vel,mateVelXZ=v2(mateVel[0],mateVel[2]),approachSpeed=aimDir.lenSq()>0?mateVelXZ.dot(aimDir):0,topSpeed=(mate.jogSpeed??0)+(mate.joltSpeed??0);if(topSpeed>.001){if(approachSpeed<-.1){const ratio=Math.min(1,Math.abs(approachSpeed)/topSpeed);dt*=1-.65*ratio}else if(approachSpeed>.1){const ratio=Math.min(1,approachSpeed/topSpeed);dt*=1+(handpass?.35:.65)*ratio}}return dt=Math.max(0,Math.min(dt,flight)),mate.pos.c.scaleAndAdd(mateVel,dt)}function estimatePassFlightTime(player,vel,aimXZ,handpass=!0){const gravity=-player.gravity[1],originY=player.pos[1],endOffsetY=handpass?player.statsHeight-.1:0,verticalRoots=solveQuadratic(-.5*gravity,vel[1],originY-(originY+endOffsetY)).filter(t=>t>0);let flight=verticalRoots.length?Math.max(...verticalRoots):0;if(flight<=0){const flatSpeed=Math.hypot(vel[0],vel[2]),dist2=Math.hypot(aimXZ[0],aimXZ[1]);flight=flatSpeed>1e-6?dist2/flatSpeed:0}return flight}function computeHandpassPlan(carrier,mate,opponents){const mateVel=mate.intentVelocity??mate.vel,mateRun=v3(mateVel[0],0,mateVel[2]),runSpeed=mateRun.len();if(runSpeed<.6)return null;const runDir=mateRun.normalize(),toCarrier=carrier.pos.c.sub(mate.pos).zeroY();if(toCarrier.lenSq()>1e-4&&runDir.dot(toCarrier.normalize())>.55)return null;const fallback=predictCatchPoint(carrier,mate,!0,mateVel),fallbackOffset=fallback.c.sub(carrier.pos),fallbackXZ=v2(fallbackOffset[0],fallbackOffset[2]);if(fallbackXZ.len()<.5)return null;const velToFallback=computeKickVelocity(carrier,fallbackXZ,!0);if(!velToFallback)return null;let fallbackFlight=estimatePassFlightTime(carrier,velToFallback,fallbackXZ,!0);if(!Number.isFinite(fallbackFlight)||fallbackFlight<=0)return null;const handRange=carrier.statsHandpassRange*(carrier.buffHandball??1),mateHeight=mate.pos[1],clampToRange=candidate2=>{if(carrier.pos.c.zeroY().dist(candidate2.c.zeroY())>handRange){const dir=candidate2.c.sub(carrier.pos).zeroY(),len2=dir.len();if(len2<1e-4)return null;const scaled=carrier.pos.c.add(dir.scale(handRange/len2));return scaled[1]=candidate2[1],scaled}return candidate2},initialLead=Math.min(handRange-.3,Math.max(0,runSpeed*fallbackFlight));let candidate=mate.pos.c.scaleAndAdd(runDir,initialLead);candidate[1]=mateHeight;let bestCandidate=null,bestThreat=1/0,bestFlight=fallbackFlight;for(let iter=0;iter<3;iter++){const offset=candidate.c.sub(carrier.pos),aimXZ=v2(offset[0],offset[2]);if(aimXZ.len()<.5)break;const vel=computeKickVelocity(carrier,aimXZ,!0);if(!vel)break;const flight=estimatePassFlightTime(carrier,vel,aimXZ,!0);if(flight<=0)break;const lead=Math.max(0,Math.min(handRange-.5,runSpeed*flight)),next=mate.pos.c.scaleAndAdd(runDir,lead);next[1]=mateHeight;const dest=clampToRange(next)??next,threat2=pathThreat(carrier,dest,opponents,1);threat2<bestThreat&&(bestThreat=threat2,bestCandidate=dest.c,bestFlight=flight);const delta=dest.c.sub(candidate);if(delta.len()<.25){candidate=dest;break}candidate=candidate.c.add(delta.scale(.6)),candidate[1]=mateHeight}const destination=clampToRange(bestCandidate??candidate);if(!destination||isOutOfBounds(destination)||carrier.pos.c.zeroY().dist(destination.c.zeroY())<2.2)return null;const destDir=destination.c.sub(mate.pos).zeroY();if(destDir.lenSq()<.5||destDir.normalize().dot(runDir)<.35)return null;const threat=pathThreat(carrier,destination,opponents,1);return{destination:destination.c,fallback:fallback.c,flightTime:bestFlight,threat,runDirection:runDir.c}}function chooseHandpassCatchPoint(carrier,mate,opponents){const plan=computeHandpassPlan(carrier,mate,opponents);if(plan)return plan.destination.c;const goalDir=carrier.team==="home"?-1:1,handRange=carrier.statsHandpassRange*(carrier.buffHandball??1),mateDist=carrier.pos.dist(mate.pos),base=mate.pos.c,toMate=base.c.sub(carrier.pos).zeroY(),lateralSign=Math.sign(toMate[0])||(goalDir<0?-1:1),lateralGap=Math.min(Math.abs(toMate[0])+2.5,8);let best=base,bestScore=-1/0;const forwardMax=Math.max(0,Math.min(handRange-.5,mateDist+8)),lateralOptions=[lateralGap,Math.max(lateralGap-2,0),Math.abs(toMate[0]),0];for(let forward=forwardMax;forward>=0;forward-=.5)for(const lateral of lateralOptions){const candidate=mate.pos.c;if(candidate[2]+=goalDir*forward,lateral>.05&&(candidate[0]=carrier.pos[0]+lateralSign*lateral),isOutOfBounds(candidate))continue;const dist2=carrier.pos.dist(candidate);if(dist2>handRange+.25||dist2+.25<mateDist)continue;const threat=pathThreat(carrier,candidate,opponents,1.2);if(threat>.65)continue;const forwardGain=goalDir*(candidate[2]-carrier.pos[2]),spacingGain=dist2-mateDist,score=forwardGain*3+spacingGain*2-threat*25;score>bestScore&&(bestScore=score,best=candidate)}return best}function pathThreat(player,target,opponents,baseReach=1.5){const segStart=player.pos,segEnd="pos"in target?target.pos:target,segVec=segEnd.c.sub(segStart),segLen=segVec.len();if(segLen<.5)return 1;const g=-player.gravity[1],handRange=player.statsHandpassRange*player.buffHandball,angleDeg=segLen<=handRange?10:30,params=getLaunchParamsFor(segStart,segEnd.c.add([0,player.statsHeight-.1,0]),g,angleDeg);if(!params)return 1;const travelTime=segLen/Math.max(params.speed,1e-6),segDir=segVec.c.normalize();let worst=0;for(const opp of opponents){const rel=opp.pos.c.sub(segStart),t=segDir.dot(rel);if(t<0||t>segLen)continue;const distSeg=distToSegmentXZ(opp.pos,segStart,segEnd),lateralSpeed=(opp.jogSpeed??0)+(opp.joltSpeed??0),maxR=baseReach+lateralSpeed*travelTime,r2=Math.max(0,Math.min(1,1-distSeg/Math.max(maxR,1e-6))),midWeight=1-Math.abs(t/segLen-.5)*.6;if(worst=Math.max(worst,r2*midWeight),worst===1)break}return worst}function laneCheck(A,B,vB,opponents,T){const Ax=A.x,Az=A.z,Bx=B.x,Bz=B.z,ABx=Bx-Ax,ABz=Bz-Az,L2=ABx*ABx+ABz*ABz;if(L2<1e-12)return{blocked:!1,gapScore:0,ux:1,uz:0,Cx:Bx,Cz:Bz,L:0};const L=Math.sqrt(L2),invL=1/L,ux=ABx*invL,uz=ABz*invL,T_over_L=T*invL,vAlong=vB.x*ux+vB.z*uz,leadMeters=Math.max(0,vAlong)*T*.6,Cx=Bx+ux*leadMeters,Cz=Bz+uz*leadMeters,sCatch=L+leadMeters,BOXOUT_IGNORE_BEHIND=1,BACK_REACH_SCALE=.6,MAX_GAP_BONUS=12;let minAheadDist2=1/0,blocked=!1;for(let i=0;i<opponents.length;i++){const o=opponents[i],ox=o.pos.x,oz=o.pos.z,OBx=ox-Bx,OBz=oz-Bz;if(OBx*ux+OBz*uz>=0){const d2=OBx*OBx+OBz*OBz;d2<minAheadDist2&&(minAheadDist2=d2)}const AxOx=ox-Ax,AzOz=oz-Az,s=AxOx*ux+AzOz*uz;if(s<=0||s>=sCatch)continue;const lateral=Math.abs(AxOx*uz-AzOz*ux),tHere=s*T_over_L;let reach=1.2+((o.jogSpeed??0)+(o.joltSpeed??0))*tHere;sCatch>L&&s<=L-BOXOUT_IGNORE_BEHIND&&(reach*=BACK_REACH_SCALE),lateral<=reach&&(blocked=!0)}const gapScore=minAheadDist2===1/0?MAX_GAP_BONUS:Math.min(Math.sqrt(minAheadDist2),MAX_GAP_BONUS)*(blocked?.2:1);return{blocked,gapScore,ux,uz,Cx,Cz,L}}function findDisposalTarget(game,player,teammates,opponents,passDir,preferHandpass=!1){var _a;const gravity=Math.abs(game.ball.gravity[1]),coneThreshold=0,uPass=passDir&&(passDir.x!==0||passDir.z!==0)?passDir.c.zeroY().normalize():null,goalDir=player.team==="home"?-1:1,kickRange=player.statsKickRange*player.buffKick,handRange=player.statsHandpassRange*player.buffHandball;let bestTarget,bestScore=-1/0,bestNeedsLoft=!1,bestTargetIsGoal=!1,planForBest=null;const goalTarget=goals[player.team];if((!preferHandpass||player.pos.dist(goalTarget)<kickRange-20)&&inFront(player,goalTarget)){const longKickTarget=player.pos.c.add(player.pos.c.dirTo(goalTarget).scale(kickRange));if(isOutOfBounds(longKickTarget))bestTarget=longKickTarget,bestScore=40-player.pos.dist(goalTarget),bestTargetIsGoal=!1;else{const laneBad=pathThreat(player,longKickTarget,opponents,2.5);bestTarget=longKickTarget,bestScore=kickRange/2-laneBad*kickRange/2,bestTargetIsGoal=!1}}const distToGoal=player.pos.c.zeroY().dist(goalTarget.c.zeroY());if(distToGoal<=kickRange+5&&isFrontHalf(player)){const shotBonus=120-distToGoal;shotBonus>bestScore&&(bestScore=shotBonus,bestTarget=goalTarget.c,bestNeedsLoft=!1,bestTargetIsGoal=!0)}const debugScoreData=[[bestTarget,bestScore]];for(const mate of teammates){if(mate===player)continue;if(uPass){const toMate=mate.pos.c.sub(player.pos).zeroY().normalize();if(toMate.dot(uPass)<coneThreshold){debugScoreData.push([mate,`Out of pass cone ${passDir}: ${toMate.dot(uPass)} < ${coneThreshold}`]);continue}}const horizDist=player.pos.c.zeroY().dist(mate.pos.c.zeroY());if(horizDist>(preferHandpass?handRange+5:kickRange+10)){debugScoreData.push([mate,`Out of range ${horizDist}`]);continue}const kickAngleDeg=getKickAngleDeg(horizDist,player.statsKickRange),launch=getLaunchParamsFor(player.pos,mate.pos,gravity,kickAngleDeg);if(!launch){debugScoreData.push([mate,`No launch from ${player.pos} to ${mate.pos} dist ${player.pos.dist(mate.pos)}`]);continue}const T=horizDist/launch.speed,{blocked,gapScore,ux,uz,Cx,Cz,L}=laneCheck(player.pos,mate.pos,mate.vel,opponents,T),forwardZ=(mate.pos.z-player.pos.z)*goalDir,v22=mate.vel.x*mate.vel.x+mate.vel.z*mate.vel.z,moveAlign=v22>1e-4?(mate.vel.x*ux+mate.vel.z*uz)/Math.sqrt(v22):0,Rsel=horizDist<=handRange?6:11,R2=Rsel*Rsel;let oppsNearby=0;for(const o of opponents){const dx=o.pos.x-Cx,dz=o.pos.z-Cz;dx*dx+dz*dz>R2||dx*ux+dz*uz<0||oppsNearby++}const densityPenalty=oppsNearby*(horizDist<=handRange?8:6),shortPenalty=!preferHandpass&&horizDist<=handRange?8:0,backwardPenalty=forwardZ<-10?(Math.abs(forwardZ)-10)*.5:0,blockedPenalty=blocked?30:0,score=forwardZ-backwardPenalty+15*moveAlign+gapScore-blockedPenalty-densityPenalty-shortPenalty+Math.random();debugScoreData.push([player,`score ${score}: ${forwardZ} - ${backwardPenalty} + ${moveAlign*15} + ${gapScore} - ${densityPenalty} - ${shortPenalty} + rand*2`]),score>bestScore&&(bestScore=score,bestTarget=mate,bestNeedsLoft=blocked,bestTargetIsGoal=!1)}if(!bestTarget)return player.pos,`${passDir}`,["handball",void 0];let targetPos,isHand=!1;if(bestTarget instanceof Player){const mate=bestTarget,matePlan=computeHandpassPlan(player,mate,opponents);planForBest=matePlan??null;const handCatch=predictCatchPoint(player,mate,!0),kickCatch=predictCatchPoint(player,mate,!1),handDist=handCatch.c.zeroY().dist(player.pos.c.zeroY()),kickDist=kickCatch.c.zeroY().dist(player.pos.c.zeroY()),canHand=handDist<=handRange+.5,canKick=kickDist<=kickRange+2,preferKick=bestTargetIsGoal||!preferHandpass&&(!canHand||canKick&&kickDist+1.5<handDist);isHand=canHand&&!preferKick,targetPos=isHand?matePlan?matePlan.destination.c:chooseHandpassCatchPoint(player,mate,opponents):kickCatch.c,isHand||(planForBest=null)}else targetPos=bestTarget instanceof Vec3?bestTarget.c:Vec3.fromArray(bestTarget),!bestTargetIsGoal&&player.pos.c.zeroY().dist(targetPos.c.zeroY())<=handRange&&(isHand=!0);if(!isHand&&targetPos.dist(player.pos)>kickRange&&targetPos.copyFrom(player.pos.c.scaleAndAdd(player.pos.c.dirTo(targetPos),kickRange)),bestTargetIsGoal&&(targetPos=computeGoalShotTarget(player,goalTarget,kickRange,distToGoal),isHand=!1),player.intentVelocity=null,isHand&&bestNeedsLoft&&(player.intentVelocity=v3(0,5,0)),game.ball.carrier===player)if(isHand&&bestTarget instanceof Player)game.contestManager.updateHandTarget(bestTarget,planForBest??computeHandpassPlan(player,bestTarget,opponents));else{const contest=((_a=game.currentContest)==null?void 0:_a.type)==="carried"?game.currentContest:null;contest&&contest.carrier===player&&game.contestManager.updateHandTarget(null)}return player.pos,player.pos.dist(bestTarget.pos??bestTarget),`${targetPos}`,bestTarget.pos,isHand?["handball",targetPos]:[bestTargetIsGoal?"kickToGoal":"kickToTarget",targetPos]}function isInLeadRange(player,ballPos){const direction=player.team==="home"?-1:1,dz=(player.pos[2]-ballPos[2])*direction;return dz>0&&dz<=LEAD_RANGE}function shouldClearOut(player,game){if(game.ball.carrier===player)return!1;if(game.setPiece&&"kicker"in game.setPiece&&game.setPiece.kicker instanceof Player){const kicker=game.setPiece.kicker;if(kicker.team===player.team&&player.pos.dist(kicker.pos)<20)return!0}return player.intent==="lead"&&player.stateTimer>3||game.players.filter(p=>p!==player&&p.playing&&p.team===player.team&&p.pos.dist(player.pos)<8).length>=3}function shouldReturnToPosition(player,game){player.intent==="pushBack"&&player.pos.dist(player.positionPos)>5&&(player.intentTarget=player.positionPos.c);const ballPos=game.ball.carrier?game.ball.carrier.pos:game.ball.pos,direction=player.team==="home"?-1:1,ahead2=(player.positionPos[2]-ballPos[2])*direction;return player.pos.dist(ballPos)>RETURN_DIST&&player.pos.dist(player.positionPos)>5||game.players.filter(p=>p!==player&&p.playing&&p.team===player.team&&p.pos.dist(player.pos)<10).length>=2&&player.pos.dist(player.positionPos)>5||ahead2>LEAD_RANGE&&player.pos.dist(player.positionPos)>5}function shouldLeadNow(player,game){const ballCarrier=game.ball.carrier;if(!ballCarrier||ballCarrier.team!==player.team)return!1;const zGap=(player.pos[2]-ballCarrier.pos[2])*(player.team==="home"?-1:1);if(zGap<5||zGap>50)return!1;const dist2=player.pos.dist(ballCarrier.pos);return!(dist2<25||dist2>75||game.players.filter(p=>p!==player&&p.playing&&p.team===player.team&&p.intent==="lead"&&p.pos.dist(player.pos)<20).length>2)}function setLeadingDirs(offense,defense,game){const ballCarrier=game.ball.carrier;if(!ballCarrier)return;const sign=ballCarrier.team==="home"?-1:1,forward=v3(0,0,sign),angles=[-40,-20,0,20,40],leadDist=20,candidates=angles.map(a2=>{const dir=forward.c.rotateXZ(a2*Math.PI/180),pos=ballCarrier.pos.c.scaleAndAdd(dir,leadDist),score=defense.reduce((m,d)=>Math.min(m,d.pos.dist(pos)),1/0);return{dir,pos,score}}).sort((A,B)=>B.score-A.score),assigned=new Set;for(const cand of candidates){let best=null,bestDist=1/0;for(const p of offense){if(assigned.has(p))continue;const dist2=p.pos.dist(cand.pos);dist2<bestDist&&(best=p,bestDist=dist2)}best&&(assigned.add(best),best.intent="lead",best.intentTarget=null,best.intentVelocity=best.pos.c.dirTo(cand.pos).scale(best.jogSpeed+best.joltSpeed))}for(const p of offense)assigned.has(p)||(p.pos.dist(p.positionPos)>5?(p.intent="pushBack",p.intentTarget=p.positionPos.c,p.intentVelocity=null):(p.intent="idle",p.intentTarget=null,p.intentVelocity=null))}function getCrumbSpot(player,landing){const sign=player.team==="home"?-1:1,lateral=(Math.random()-.5)*2;return v3(landing[0]+lateral,landing[1],landing[2]+sign*3)}function findSafeRunDirection(player,game,stepAngleDeg=15,maxAngleDeg=90,checkDist=2,dangerRadius=5){const forward=player.pos.c.dirTo(goals[player.team]),anglesToTry=[0];for(let a2=stepAngleDeg;a2<=maxAngleDeg;a2+=stepAngleDeg)anglesToTry.push(+a2),anglesToTry.push(-a2);for(const angleDeg of anglesToTry){const angleRad=angleDeg*Math.PI/180,dir=forward.c.rotateXZ(angleRad),testPos=player.pos.c.scaleAndAdd(dir,checkDist);let safe=!0;for(const opponent of game.players){if(opponent.team===player.team||!opponent.playing)continue;if(opponent.pos.dist(testPos)<dangerRadius){safe=!1;break}}if(safe)return dir}return null}function findClosestOpponent$1(player,opponents){return opponents.reduce((best,opp)=>!best||player.pos.distSq(opp.pos)<player.pos.distSq(best.pos)?opp:best,void 0)}function isFrontHalf(player,game){const axis=goals[player.team].c.sub([0,FIELD_LENGTH$1/2,0]).xz,rel=player.pos.c.sub([0,FIELD_LENGTH$1/2,0]).xz;return axis.dot(rel)>0}function inKickRangeOfGoal(carrier,game){const kickRange=carrier.statsKickRange*carrier.buffKick;return carrier.pos.dist(goals[carrier.team])<=kickRange+30}function toRatingAttributes(stats){if("height"in stats&&"weight"in stats&&"strength"in stats&&"speed"in stats)return stats;if("statsHeight"in stats&&"statsWeight"in stats&&"statsStrength"in stats&&"statsSpeed"in stats)return{height:stats.statsHeight,weight:stats.statsWeight,strength:stats.statsStrength,speed:stats.statsSpeed,agility:stats.statsAgility,kickRange:stats.statsKickRange,handpassRange:stats.statsHandpassRange,jump:stats.statsJump,buffStrength:stats.buffStrength,buffSpeed:stats.buffSpeed,buffKick:stats.buffKick,buffHandball:stats.buffHandball};throw new TypeError("Unsupported stats shape provided to rating calculator")}function calculatePlayerRating(stats){const{height,weight,strength,speed,agility,kickRange,handpassRange,jump:jump2,buffStrength,buffSpeed,buffKick,buffHandball}=toRatingAttributes(stats);return height*100+weight+strength*(buffStrength??1)+speed*(buffSpeed??1)*10+agility*5+kickRange*(buffKick??1)+handpassRange*(buffHandball??1)+jump2*5}function calculateTeamAverageRating(roster){if(!Array.isArray(roster)||roster.length===0)return 0;const ratings=roster.map(player=>{try{return calculatePlayerRating(player)}catch{return 0}}).filter(value=>typeof value=="number"&&Number.isFinite(value));return ratings.length===0?0:ratings.reduce((sum,value)=>sum+value,0)/ratings.length}function calculateTeamRatings(teams2){const teamSummaries=(Array.isArray(teams2)?teams2:[]).map(team=>({id:team==null?void 0:team.id,average:calculateTeamAverageRating(Array.isArray(team==null?void 0:team.roster)?team.roster:[])})),validAverages=teamSummaries.map(summary=>summary.average).filter(value=>typeof value=="number"&&Number.isFinite(value)),minAverage=validAverages.length>0?Math.min(...validAverages):0,span=(validAverages.length>0?Math.max(...validAverages):0)-minAverage;return new Map(teamSummaries.map(({id,average})=>{if(typeof id!="number")return[id,.5];const base=Number.isFinite(average)?average:minAverage,normalized=span>1e-6&&Number.isFinite(base)?.5+(base-minAverage)/span*4.5:validAverages.length>0?5:.5,clamped=Math.max(.5,Math.min(5,normalized));return[id,clamped]}))}function calculateTeamRankings(teams2){const ratingMap=calculateTeamRatings(teams2),entries=Array.from(ratingMap.entries());entries.sort((a2,b)=>{const ratingA=Number.isFinite(a2[1])?a2[1]:0,ratingB=Number.isFinite(b[1])?b[1]:0;if(Math.abs(ratingB-ratingA)>1e-6)return ratingB-ratingA;const idA=typeof a2[0]=="number"?a2[0]:Number.POSITIVE_INFINITY,idB=typeof b[0]=="number"?b[0]:Number.POSITIVE_INFINITY;return idA-idB});const ranking=new Map;for(let i=0;i<entries.length;i+=1){const[id,rating]=entries[i];typeof id=="number"&&ranking.set(id,{rank:i+1,rating:Number.isFinite(rating)?rating:.5})}if(Array.isArray(teams2)){for(const team of teams2)if(!(!team||typeof team.id!="number")&&!ranking.has(team.id)){const rating=ratingMap.get(team.id)??.5;ranking.set(team.id,{rank:ranking.size+1,rating})}}return ranking}const BUFFS=Object.freeze({kick:{name:"Kick Range",levels:[0,1,2,3],multipliers:[1,1.1,1.25,1.4]},handball:{name:"Handpass Range",levels:[0,1,2,3],multipliers:[1,1.1,1.25,1.4]},speed:{name:"Speed Boost",levels:[0,1,2,3],multipliers:[1,1.05,1.1,1.2]},strength:{name:"Strength Boost",levels:[0,1,2,3],multipliers:[1,1.05,1.1,1.2]}}),STAR_ZERO=485,STAR_SCALE=35;function ratingToStars(rating){const stars2=(rating-STAR_ZERO)/STAR_SCALE;return Math.max(1,Math.min(5,stars2))}const STAR_DISTRIBUTION=Object.freeze([{tier:1,weight:.35},{tier:2,weight:.25},{tier:3,weight:.15},{tier:4,weight:.1},{tier:5,weight:.05}]),STAR_DISTRIBUTION_TOTAL=STAR_DISTRIBUTION.reduce((sum,entry)=>sum+(entry.weight??0),0)||1;function sampleBaseStarTier(){const roll=Math.random()*STAR_DISTRIBUTION_TOTAL;let accum=0;for(const{tier,weight}of STAR_DISTRIBUTION)if(accum+=weight,roll<=accum)return tier;return STAR_DISTRIBUTION[STAR_DISTRIBUTION.length-1].tier}function buffProfileForTier(tier){const safeTier=Number.isFinite(tier)?tier:1;return safeTier>=4.5?{perBuffCap:3,potentialRange:[12,15]}:safeTier>=3.5?{perBuffCap:3,potentialRange:[9,13]}:safeTier>=2.5?{perBuffCap:2,potentialRange:[7,11]}:safeTier>=1.5?{perBuffCap:2,potentialRange:[5,9]}:{perBuffCap:1,potentialRange:[3,6]}}function randomIntInRange(min,max){const low=Math.ceil(Math.min(min,max)),high=Math.floor(Math.max(min,max));return!Number.isFinite(low)||!Number.isFinite(high)?0:high<low?low:low+Math.floor(Math.random()*(high-low+1))}function totalBuffCapacity(perBuffCap){const cap=Number.isFinite(perBuffCap)?perBuffCap:1/0;return Object.keys(BUFFS).reduce((acc,buffId)=>{const meta=BUFFS[buffId];if(!meta)return acc;const maxForBuff=Math.min(Math.max(0,cap),meta.levels.length-1);return acc+Math.max(0,maxForBuff)},0)}function perBuffLevelCap(perBuffCap,buffId){const meta=BUFFS[buffId];if(!meta)return 0;const cap=Number.isFinite(perBuffCap)?perBuffCap:1/0;return Math.max(0,Math.min(meta.levels.length-1,cap))}function countBuffLevels(activeBuffs){if(!activeBuffs)return 0;let total=0;for(const level of Object.values(activeBuffs))typeof level=="number"&&level>0&&(total+=level);return total}function applyBuffToStats(stats,buffId,level=1){const meta=BUFFS[buffId];if(!meta)throw new Error(`Unknown buff ${buffId}`);stats.activeBuffs||(stats.activeBuffs={});const safeLevel=Number.isFinite(level)?Math.max(0,Math.floor(level)):0,clampedLevel=Math.min(safeLevel,meta.levels.length-1);stats.activeBuffs[buffId]=clampedLevel;const prop="buff"+buffId.charAt(0).toUpperCase()+buffId.slice(1);stats[prop]=meta.multipliers[clampedLevel]??1}function developmentProgressFromGames(games){if(!Number.isFinite(games)||games<=0)return 0;const seasons=games/20;return Math.max(0,Math.min(1,seasons/10))}function allocateBuffLevels(stats,desiredLevels,perBuffCap){const buffIds=Object.keys(BUFFS);let currentLevels=countBuffLevels(stats.activeBuffs);const totalCapacity=totalBuffCapacity(perBuffCap),target=Math.min(desiredLevels,totalCapacity);for(;currentLevels<target;){const candidates=buffIds.filter(buffId2=>{const cap=perBuffLevelCap(perBuffCap,buffId2);return cap<=0?!1:(stats.activeBuffs[buffId2]??0)<cap});if(candidates.length===0)break;const buffId=choose(candidates),current=stats.activeBuffs[buffId]??0,nextLevel=Math.min(current+1,perBuffLevelCap(perBuffCap,buffId));if(nextLevel<=current)break;applyBuffToStats(stats,buffId,nextLevel),currentLevels+=nextLevel-current}}function syncBuffDevelopmentForStats(stats){if(!stats)return;stats.activeBuffs||(stats.activeBuffs={});const perBuffCap=Number.isFinite(stats.buffPerAbilityCap)?Math.max(0,stats.buffPerAbilityCap):1/0,capacity=totalBuffCapacity(perBuffCap);Number.isFinite(stats.buffDevelopmentPotential)?stats.buffDevelopmentPotential=Math.max(0,Math.min(stats.buffDevelopmentPotential,capacity)):stats.buffDevelopmentPotential=capacity;const games=Number.isFinite(stats.games)?stats.games:0,potential=Number.isFinite(stats.buffDevelopmentPotential)?stats.buffDevelopmentPotential:0,desiredLevels=Math.floor(potential*developmentProgressFromGames(games)),currentLevels=countBuffLevels(stats.activeBuffs);desiredLevels<=currentLevels||allocateBuffLevels(stats,desiredLevels,perBuffCap)}function addExperienceToStats(stats,games=1){if(!stats)return;if((typeof stats.games!="number"||!Number.isFinite(stats.games))&&(stats.games=0),(typeof stats.experience!="number"||!Number.isFinite(stats.experience))&&(stats.experience=Math.max(0,stats.games)),!stats._experienceVarianceSeeded){const baseGames=Number.isFinite(stats.games)?stats.games:0;Math.abs(stats.experience-baseGames)<.01&&(stats.experience=baseGames+Math.random()*4),stats._experienceVarianceSeeded=!0}if((typeof stats.level!="number"||!Number.isFinite(stats.level))&&(stats.level=1),typeof stats.maxLevel!="number"||!Number.isFinite(stats.maxLevel)){const baseline=typeof stats.level=="number"&&Number.isFinite(stats.level)?stats.level:1;stats.maxLevel=baseline+12}stats.games+=games,stats.experience+=games;const progress=stats.experience,newLevel=Math.floor(progress/10)+1,cappedLevel=Math.min(newLevel,stats.maxLevel??newLevel);cappedLevel>stats.level&&(stats.level=cappedLevel),syncBuffDevelopmentForStats(stats)}function starTierForAge(age,debutAge,peakAge,declineAge,baseTier,peakTier){const clampedAge=Math.max(debutAge,age);if(clampedAge<=peakAge){const riseSpan=Math.max(1,peakAge-debutAge),riseT=Math.min(1,Math.max(0,(clampedAge-debutAge)/riseSpan)),tier2=baseTier+(peakTier-baseTier)*riseT;return Math.min(5,Math.max(1,tier2))}const declineSpan=Math.max(1,declineAge-peakAge),declineT=Math.min(1,Math.max(0,(clampedAge-peakAge)/declineSpan)),tier=peakTier-(peakTier-baseTier)*declineT;return Math.min(5,Math.max(1,tier))}const POSITION_KEYS=Object.freeze(Object.keys(generateFieldPositions()));function capitalize(s){return s.charAt(0).toUpperCase()+s.slice(1).toLowerCase()}const seen=new Set,fifo=[],seenL=new Set,fifoL=[],NAME_LIMIT=1e4,LAST_LIMIT=8e4,Cap=typeof capitalize=="function"?capitalize:(s=>s.charAt(0).toUpperCase()+s.slice(1).toLowerCase()),r=Math.random,pick=a2=>a2[r()*a2.length|0],FIRST_MALE=["Liam","Noah","Jack","Oliver","Leo","Max","Tom","Ben","Eli","Owen","Kai","Hugo","Felix","Sam","Daniel","Joseph","Theodore","Jonah","Micah","Luca","Marco","Matteo","Giuseppe","Nikos","Andreas","Arjun","Rohan","Vikram","Aman","Ali","Omar","Hassan","Samir","Wei","Jun","Ming","Hao","Lei","Minh","Thanh","Tuan","Nam","Quan","Huy","Sione","Tui","Manu","Nikolai","Marko","Ivan","Jarrah","Yarran","Warrin"],roots=["ash","oak","elm","pine","thorn","briar","fern","ford","brook","ridge","stone","wood","field","hall","vale","moor","cliff","lake","heath","grove","north","south","west","east","gray","whit","black","red","gold","silver","king","fox","wolf","bear","hawk","hart","river","storm","flint","lock","croft","bridge","mill","well","lark","swift","harbor","shore","hill","meadow","glen","bramble","peak","crown"],ang=["son","ton","ley","ford","field","wood","well","ridge","brook","hall","worth","more","man","ly","ham","bury","hurst","shaw","water","side","bridge"],celtP=["Mc","O'"],LAST_IT=["Rossi","Russo","Ferrari","Esposito","Bianchi","Romano","Gallo","Costa","Greco","Conti","De Luca","Rizzo","Lombardi","Santoro","Moretti","Caruso","De Santis","Giordano"],LAST_VN=["Nguyen","Tran","Le","Pham","Huynh","Hoang","Vu","Dang","Bui","Do","Phan","Vo","Truong","Dinh","Ngo"],LAST_GR=["Papadopoulos","Pappas","Georgiou","Nikolaidis","Economou","Katsaros","Stamatakis"],LAST_ZH=["Wang","Li","Zhang","Liu","Chen","Yang","Huang","Zhao","Wu","Zhou","Xu","Sun","Zhu"],LAST_IN=["Singh","Patel","Kumar","Shah","Reddy","Iyer","Gupta","Verma","Joshi","Nair","Mehta","Khan"],LAST_AR=["Haddad","Mansour","Khoury","Nassar","Saad","Hariri","Saleh","Aziz","Farhat"],LAST_BA=["Petrovic","Jovanovic","Nikolic","Markovic","Kovacevic","Popovic","Dimitrov","Ivanov","Stojanovski"],LAST_PL=["Kowalski","Nowak","Wisniewski","Zielinski","Kaminski"],LAST_PI=["Tupuola","Taufua","Leota","Tuala","Tuivasa","Tupou"],LAST_AF=["Okafor","Mensah","Diallo","Abebe","Adebayo"],LAST_TR=["Yilmaz","Demir","Kaya","Aydin","Aslan"],LAST_IR=["Hosseini","Mohammadi","Rahimi","Ahmadi","Rezaei"],LAST_OC=["Smith","Baker","Carter","Taylor","Wright","Turner","Cooper","Fletcher","Miller","Weaver","Potter","Sawyer","Hunter","Archer","Fisher"],LAST_GROUPS=[["IT",LAST_IT],["VN",LAST_VN],["GR",LAST_GR],["ZH",LAST_ZH],["IN",LAST_IN],["AR",LAST_AR],["BA",LAST_BA],["PL",LAST_PL],["PI",LAST_PI],["AF",LAST_AF],["TR",LAST_TR],["IR",LAST_IR],["OC",LAST_OC]],COMPLEXIONS=["ruddy","pasty","swarthy"],complex={IT:[.333,.333,.334],VN:[.1,.45,.45],GR:[.2,.4,.4],ZH:[.1,.45,.45],IN:[.1,.45,.45],AR:[.333,.333,.334],BA:[.45,.45,.1],PL:[.45,.45,.1],PI:[.2,.4,.4],AF:[.1,.45,.45],TR:[.333,.333,.334],IR:[.333,.333,.334],OC:[.45,.45,.1],ANG:[.45,.45,.1],CELT:[.45,.45,.1]},vow="aeiouy",isV=(c=>vow.includes((c||"").toLowerCase())),join=(root,suf)=>{let L=root.toLowerCase(),R=(suf||"").toLowerCase();return R?(L.slice(-1)===R[0]&&(R=R.slice(1)),!isV(L.slice(-1))&&!isV(R[0])&&(R="e"+R),Cap(L+R)):Cap(L)};function makeLast(){const roll=r();if(roll<.6){let total=0;for(const[,arr]of LAST_GROUPS)total+=arr.length;let t=r()*total;for(const[tag,arr]of LAST_GROUPS)if((t-=arr.length)<0)return{last:arr[r()*arr.length|0],tag};return{last:pick(LAST_OC),tag:"OC"}}return roll<.7?{last:pick(celtP)+Cap(pick(roots)),tag:"CELT"}:{last:join(pick(roots),pick(ang)),tag:"ANG"}}const remember=(full,last)=>{seen.has(full)||(seen.add(full),fifo.push(full),fifo.length>NAME_LIMIT&&seen.delete(fifo.shift())),seenL.has(last)||(seenL.add(last),fifoL.push(last),fifoL.length>LAST_LIMIT&&seenL.delete(fifoL.shift()))},wIdx=w=>{const s=w[0]+w[1]+w[2]||1;let t=Math.random()*s;return t<w[0]?0:t<w[0]+w[1]?1:2};function chooserFromMap(map,irony=.08){return({tag})=>{const w=map[tag]||map.OC||[1,1,1];let idx=wIdx(w);return Math.random()<irony&&(idx=w[0]<=w[1]&&w[0]<=w[2]?0:w[1]<=w[2]?1:2),COMPLEXIONS[idx]}}const mappedChooser=chooserFromMap(complex);function makeName(chooser=mappedChooser){let tries=0,first=pick(FIRST_MALE),rec=makeLast(),last=rec.last,full="";do{if(seenL.has(last)&&tries<32){tries++,rec=makeLast(),last=rec.last;continue}if(Math.random()<.06){const b=makeLast().last;b!==last&&(last+="-"+b)}full=first+" "+last,seen.has(full)&&tries++>6&&(full=first+" "+last+" "+String.fromCharCode(65+(Math.random()*26|0))+".")}while((seen.has(full)||seenL.has(last))&&tries<40);remember(full,last);const complexion=chooser?chooser({tag:rec.tag}):COMPLEXIONS[Math.random()*3|0];return{name:full,complexion}}class PlayerStats{constructor(position){this.position=position,this.energy=10;const{name,complexion}=makeName();this.name=name,this.complexion=complexion,this.faceId=getRandomInt(personAnimationSets[this.complexion].headCount),this.build=["FF","FB","CHF","CHB","Ruck"].includes(position)?"big":"small",this.weight=(this.build==="big"?85:75)+Math.random()*10,this.speed=(this.build==="big"?6:8)+Math.random()*3,this.height=(this.build==="big"?1.8:1.65)+Math.random()*.2,position==="Ruck"&&this.height<1.9&&(this.height=1.9+Math.random()*.2);const strengthFactor=1.2+(this.weight/this.height**2-25)*.05;this.strength=this.weight*strengthFactor+(Math.random()*10-5),this.jump=(this.build==="big"?4.5:5.25)+Math.random(),this.kickRange=45+Math.random()*(this.build==="big"?20:10),this.handpassRange=23+Math.random()*6,this.agility=(this.build==="big"?4.5:5.5)+Math.random()*1.5,this.fitness=80,this.morale=80,this.age=Math.floor(18+Math.random()*13),this.playerCondition=100,this.careerHealth=200-(this.age-18)*5+Math.round(Math.random()*20-10),this.debutAge=18+Math.random()*2,this.peakAge=24+Math.random()*4,this.declineAge=this.peakAge+3+Math.random()*2,this.baseStarTier=sampleBaseStarTier();const peakBump=Math.random()*2;this.peakStarTier=Math.min(5,this.baseStarTier+peakBump),this.starTier=starTierForAge(this.age,this.debutAge,this.peakAge,this.declineAge,this.baseStarTier,this.peakStarTier),this.games=Math.max(0,Math.round((this.age-18)*20+(Math.random()*10-5))),this.experience=this.games+Math.random()*4,this._experienceVarianceSeeded=!0,this.level=Math.floor(this.experience/10)+1,this.maxLevel=this.level+randomIntInRange(10,15),this.activeBuffs={},this.buffKick=1,this.buffHandball=1,this.buffSpeed=1,this.buffStrength=1;const buffProfile=buffProfileForTier(this.starTier);this.buffPerAbilityCap=buffProfile.perBuffCap;const capacity=totalBuffCapacity(this.buffPerAbilityCap),rawPotential=randomIntInRange(buffProfile.potentialRange[0],buffProfile.potentialRange[1]);this.buffDevelopmentPotential=Math.max(0,Math.min(rawPotential,capacity)),this.syncBuffDevelopment(),applyStarAdjustments(this);const baseSalary=Math.round(8e4+Math.min(5,this.age-18)*2e4+(this.rating-500)*5e3+(Math.random()*1e4-5e3));this.contractLength=1+Math.floor(Math.random()*4),this.contractAmount=baseSalary,this.salary=this.contractAmount}get rating(){return calculatePlayerRating(this)??0}static rating(player){return calculatePlayerRating(player)??0}applyBuff(buffId,level=1){applyBuffToStats(this,buffId,level)}syncBuffDevelopment(){syncBuffDevelopmentForStats(this)}addExperience(games=1){addExperienceToStats(this,games)}}function applyStarAdjustments(stats){const quality=(stats.starTier-3)/2,attrScale=1+quality*.18,powerScale=1+quality*.22,rangeScale=1+quality*.16;stats.speed*=attrScale,stats.agility*=attrScale,stats.jump*=attrScale,stats.strength*=powerScale,stats.kickRange*=rangeScale,stats.handpassRange*=rangeScale;const ensureBuff=(buffId,minimumLevel)=>{stats.activeBuffs||(stats.activeBuffs={});const cap=perBuffLevelCap(stats.buffPerAbilityCap??1/0,buffId);if(cap<=0)return;const current=stats.activeBuffs[buffId]??0,target=Math.max(current,Math.min(cap,Math.max(0,minimumLevel)));target>current&&applyBuffToStats(stats,buffId,target)};stats.starTier>=4.5?(ensureBuff("kick",2),ensureBuff("speed",2),ensureBuff("strength",2)):stats.starTier>=3.5&&(ensureBuff("kick",1),ensureBuff("speed",1));const targetRating=STAR_ZERO+stats.starTier*STAR_SCALE,currentRating=stats.rating;if(currentRating>0){const ratio=Math.max(.75,Math.min(1.35,targetRating/currentRating)),tuneScale=Math.sqrt(ratio);stats.speed*=tuneScale,stats.agility*=tuneScale,stats.jump*=tuneScale,stats.strength*=tuneScale,stats.kickRange*=tuneScale,stats.handpassRange*=tuneScale}}function generatePlayerPool(seed,teamCount=18){setPRNG("mulberry32"),setSeed(typeof seed=="number"?seed:Date.now());const pool={};for(const position of POSITION_KEYS){const players=[];for(let i=0;i<teamCount;i++)players.push(new PlayerStats(position));players.sort((a2,b)=>b.rating-a2.rating),pool[position]=players}return pool}function updateAging(p){const build=["FF","FB","CHF","CHB","Ruck"].includes(p.position)?"big":"small",prevAge=p.age,prevWeight=p.weight;p.speed,p.agility;const prevTier=typeof p.starTier=="number"?p.starTier:typeof p.baseStarTier=="number"?p.baseStarTier:3;p.age+=1;const baseTier=typeof p.baseStarTier=="number"?p.baseStarTier:prevTier,peakTier=typeof p.peakStarTier=="number"?p.peakStarTier:Math.min(5,baseTier+1.5),debutAge=typeof p.debutAge=="number"?p.debutAge:Math.max(18,p.age-4),peakAge=typeof p.peakAge=="number"?p.peakAge:26,declineAge=typeof p.declineAge=="number"?p.declineAge:peakAge+4,newTier=starTierForAge(p.age,debutAge,peakAge,declineAge,baseTier,peakTier);p.baseStarTier=baseTier,p.peakStarTier=peakTier,p.debutAge=debutAge,p.peakAge=peakAge,p.declineAge=declineAge,p.starTier=newTier;const tierDelta=newTier-prevTier,weightGain=build==="big"?1:.5;p.weight+=weightGain;let speedChange=0,agilityChange=0;if(p.age<25?(speedChange=.01,agilityChange=.01):p.age>29&&(speedChange=build==="big"?-.02:-.01,agilityChange=build==="big"?-.03:-.015),tierDelta>0?(speedChange+=tierDelta*.04,agilityChange+=tierDelta*.04):tierDelta<0&&(speedChange+=tierDelta*.05,agilityChange+=tierDelta*.05),p.speed*=1+speedChange,p.agility*=1+agilityChange,tierDelta!==0){const attrScale=1+tierDelta*.08,rangeScale=1+tierDelta*.06;p.strength*=attrScale,p.kickRange*=rangeScale,p.handpassRange*=rangeScale,p.jump*=1+tierDelta*.05}return{age:p.age-prevAge,weight:p.weight-prevWeight,speed:speedChange,agility:agilityChange}}const soundKick1="/footy-testing/assets/kick1-C-IPGYhp.mp3",soundKick2="/footy-testing/assets/kick2-DW6ROn8h.mp3",soundKick3="data:audio/mpeg;base64,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",soundKick4="data:audio/mpeg;base64,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",soundKick5="data:audio/mpeg;base64,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",soundKick6="data:audio/mpeg;base64,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",soundHit1="/footy-testing/assets/hit1-CCByiU1t.mp3",soundHit2="/footy-testing/assets/hit2-C_ISA5js.mp3",soundHit3="/footy-testing/assets/hit3-DgUmt23V.mp3",soundHit4="/footy-testing/assets/hit4-CcHOFiQ2.mp3",soundWhistle1="/footy-testing/assets/whistle1-D1FMp0EL.mp3",soundWhistle2="/footy-testing/assets/whistle2-gOnfmE7z.mp3",soundWhistle3="/footy-testing/assets/whistle3-EdQy1_Cd.mp3",soundWhistle4="/footy-testing/assets/whistle4-Yn_E7eZQ.mp3",soundWhistle5="/footy-testing/assets/whistle5-BvYPh2PA.mp3",soundWhistle6="/footy-testing/assets/whistle6-rHOBugHZ.mp3",soundBounce1="/footy-testing/assets/bounce1-C3t8MnL9.mp3",soundBounce2="/footy-testing/assets/bounce2-DJFKqXJg.mp3",soundBounce3="data:audio/mpeg;base64,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ydHs2aqmps/w3/V9bEQC4ABr/v7rosaRSdFwx/+y79X0v7tf//3f/+dXs6we5iXZhLulVEMxtoHEJIEDQoCC4VjoUCqDJoKyo/MKflqzOneAK0J9SXQgMiRE0hNAIkYPbbiW4LAETRwBJ4VpSVc1bd8kCJJakKJXZSZwWo+zUTA+l5U6cSadlInRJnyE8+ajiNbczTNPWJVc5hs74ytyc0qv0m25bWkpOOaz7JKpfCM6+bH25+s1ss1z4UfywUhQ3NIAIvqB/vo0JAKWjTXJaFq2+hf/+hX2ej/6v3//1wztvZqIbf6QkoAbhJl+stzQIQEVUNL0qbBVwUU9S7o41+DHZf6aly4iFyBMq0bWGm26drRtCJdyMViZqSJR6NdFRuChInqlNdBqMvCUqkiTWZ2iF9CMWmoinccEKFIjO4Og1GtOBr5KXGaBZQzQ6FGeEcM1XaC4KMiClHM9Vhkflb3gNWSgyje1WsGGUgCAOsAAdGzpMhBx16sj//uUZPuAFFJNVfssM9IegBimAAAAEr17T80kzoB1AGLkEAAAkaz3fZ//sb/9X+oj/bs7kBFVl5EvP/rabgJoyY1WLyFboaWMTDAy2Tl1kVX8WFR2pnTeUiAQFJmDQoNYbNo+IrLrTGEadJpoV0TJKwzBGjQwSchilLE1LVYWRJ5clpyYWnWHZyKaTSlsZftwWWbr67xeskrqyqcYWknCUWtk+v8TZV1XJRrwjiu3OWqbLrXKK62R96n373e14bKTQyUUTvcimgQwikDab8KN4o7ajYw977//t+3/t/6lCwmgeQaAZwZw3EYZDAgBAMSClP45D2DdKT/zFwvM3DkxAxjE5E/zE4AMLBYRhUGkj/ClQVEBlwAoPC2AfwMfDIAbMI24oQAkQaiGNTQUFxkguaFRDfxUgstEJRrBfkPR+QQY8fxeEHLpodKJ5Jf45wpEY0UCRAuF9FWpJ/5aRIqsgxAS8Vt0da/8do7iJE6dl4ukVIspa/V/+ii7M6zJaRAj//uUZPuAFGdeVXsJHHoeABipAAAAEl1hT/WEgChbACLmgAAAMwVFNv9QkDQuCXdq1f//89/Pf89////py3//WytMQU1FMy4xMDBVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV//tUZP8ABWFSTv5yYIAS4AiwwAAAAAABpBwAACAAADSDgAAEVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV",soundBounce4="data:audio/mpeg;base64,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",soundGoalPost1="/footy-testing/assets/goalpost-CJiqRzl3.mp3",soundHorn="/footy-testing/assets/horn-4gyjimrm.mp3",kick1=new Audio(soundKick1),kick2=new Audio(soundKick2),kick3=new Audio(soundKick3),kick4=new Audio(soundKick4),kick5=new Audio(soundKick5),kick6=new Audio(soundKick6),hit1=new Audio(soundHit1),hit2=new Audio(soundHit2),hit3=new Audio(soundHit3),hit4=new Audio(soundHit4);hit1.volume=.1;hit2.volume=.1;hit3.volume=.1;hit4.volume=.1;const bounce1=new Audio(soundBounce1),bounce2=new Audio(soundBounce2),bounce3=new Audio(soundBounce3),bounce4=new Audio(soundBounce4);bounce1.volume=.25;bounce2.volume=.25;bounce3.volume=.25;bounce4.volume=.25;const whistle1=new Audio(soundWhistle1),whistle2=new Audio(soundWhistle2),whistle3=new Audio(soundWhistle3),whistle4=new Audio(soundWhistle4),whistle5=new Audio(soundWhistle5),whistle6=new Audio(soundWhistle6);whistle1.volume=.25;whistle2.volume=.25;whistle3.volume=.25;whistle4.volume=.25;whistle5.volume=.25;whistle6.volume=.25;const goalPost=new Audio(soundGoalPost1);goalPost.volume=.5;const horn=new Audio(soundHorn),groupKick=[kick1,kick3,kick4,kick5,kick6],groupHit=[hit1,hit2,hit3],groupBounce=[bounce1,bounce2,bounce3,bounce4],groupWhistle=[whistle1,whistle2,whistle3,whistle4,whistle5,whistle6],audio=Object.freeze({kick1,kick2,kick3,kick4,kick5,kick6,hit1,hit2,hit3,hit4,bounce1,bounce2,bounce3,bounce4,whistle1,whistle2,whistle3,whistle4,whistle5,whistle6,groupKick,groupHit,groupBounce,groupWhistle,goalPost,horn,kick:()=>choose(groupKick),hit:()=>choose(groupHit),bounce:()=>choose(groupBounce),whistle:()=>choose(groupWhistle)}),BALL_LAUNCH_HORIZONTAL_NOISE=.15;function findClosestOpponent(kicker,players,markPos){let closest=null,minDist=1/0;for(const p of players)if(p.team!==kicker.team){const d=p.pos.dist(markPos);d<minDist&&(minDist=d,closest=p)}return closest}class SetPiece{constructor(game){this.game=game,this.timer=0,this.finished=!1}update(dt){this.timer+=dt}enforce(player,dt){return!1}cameraTarget(){return null}cleanup(){}}function shortenB(B,A,radiusX=FIELD_RADIUS_X$1,radiusZ=FIELD_RADIUS_Z$1,pad=FENCE_PADDING){const ex=radiusX+pad-.5,ez=radiusZ+pad-.5,bx=B.x,bz=B.z-radiusZ,ax=A.x,az=A.z-radiusZ;if(bx*bx/(ex*ex)+bz*bz/(ez*ez)<=1)return;const dx=B.x-A.x,dz=B.z-A.z,alpha=dx*dx/(ex*ex)+dz*dz/(ez*ez),beta=2*(ax*dx/(ex*ex)+az*dz/(ez*ez)),gamma=ax*ax/(ex*ex)+az*az/(ez*ez)-1,disc=beta*beta-4*alpha*gamma;if(disc<0)return;const sqrtD=Math.sqrt(disc),t1=(-beta-sqrtD)/(2*alpha),t2=(-beta+sqrtD)/(2*alpha);let tHit=1/0;t1>=0&&t1<=1&&(tHit=Math.min(tHit,t1)),t2>=0&&t2<=1&&(tHit=Math.min(tHit,t2)),isFinite(tHit)&&(B.x=A.x+tHit*dx,B.z=A.z+tHit*dz)}class FreeKickSetPiece extends SetPiece{constructor(game,kicker,markPos,startPos){super(game),this.kicker=kicker,this.state="backup",this.markPos=markPos.c.zeroY(),this.markPos.z=kicker.team==="home"?Math.min(this.markPos.z,FIELD_LENGTH$1-10):Math.max(this.markPos.z,10),this.game=game;const goalShot=kicker.pos.dist(goals[kicker.team])<kicker.statsKickRange+10;this.maxTimer=goalShot?15:10,this.timer=this.maxTimer,game=this.game,kicker=this.kicker;const goalZ=kicker.team==="home"?0:FIELD_LENGTH$1,goalPos=v3(0,0,goalZ);startPos&&(kicker.pos.copyFrom(startPos),kicker.vel.setFrom(0,0,0),kicker.jogVel.setFrom(0,0,0),kicker.joltVel.setFrom(0,0,0));const goalDir=goalPos.c.sub(this.markPos).zeroY().normalize(),kickerDistance=goalShot?20:15,backupPos=this.markPos.c.scaleAndAdd(goalDir,-kickerDistance);shortenB(backupPos,this.markPos),this.backupPos=backupPos,kicker.intent="freeKick",kicker.intentTarget=backupPos,game.ball.pos.copyFrom(kicker.pos),game.ball.pickup(kicker),kicker.team==="home"&&(this.game.player=kicker),this.defender=findClosestOpponent(kicker,game.players,this.markPos),this.defenderMarkAssignment={targetPos:this.markPos.c,arrived:!1},this.defender&&(this.defender.forceActionState("run",this.game),this.defender.intent="standMark",this.defender.intentTarget=this.markPos),this.game.contestManager.enterFreeKick({markPos:this.markPos,kicker,defender:this.defender}),audio.whistle5.play()}update(dt){if(this.timer-=dt,this.timer<=0){this.kicker.intent="idle",this.kicker.intentTarget=null,this.defender&&(this.defender.intent="contestAnyway",this.defender.intentTarget=this.kicker),this.finished=!0,this.game.banner.commentary("PLAY ON");return}const{kicker,markPos,game}=this,ball=game.ball,stillHolding=ball.carrier===kicker;this.defender&&!this.defenderMarkAssignment.arrived&&this.defender.pos.dist(this.markPos)<1&&(this.defenderMarkAssignment.arrived=!0,this.defender.forceActionState("standingMark",this.game),this.defender.stateTimer=10,this.defender.intent="standMark",this.defender.intentTarget=this.markPos,this.defender.jogVel.setFrom(0,0,0),this.defender.joltVel.setFrom(0,0,0));const goalDir=v3(0,0,kicker.team==="home"?0:FIELD_LENGTH$1).c.sub(markPos).zeroY().normalize(),backupDir=kicker.pos.c.dirTo(this.backupPos),lateralDir=v3(-goalDir[2],0,goalDir[0]),markToKicker=kicker.pos.c.sub(markPos).zeroY(),alongDist=markToKicker.dot(goalDir),lateralDist=Math.abs(markToKicker.dot(lateralDir));kicker.vel.c.zeroY();let playedOn=!1;if((lateralDist>2.5&&this.state!=="backup"||alongDist>.05||alongDist<-25||Math.abs(kicker.vel.c.normalize().dot(backupDir))<.75)&&(playedOn=!0),playedOn&&isOutOfBounds(kicker.pos)){game.contestManager.enterOutOfBounds({point:kicker.pos.c.zeroY()}),this.finished=!0,game.scheduleEvent(DELAY_AFTER_STOPPAGE,()=>{game.setPiece=new BoundaryThrowInSetPiece(game,kicker.pos.c)}),game.banner.commentary("OUT OF BOUNDS");return}if(!stillHolding){game.contestManager.resumeOpenPlay(ball,game.now),this.defender!==null&&(this.defender.stateTimer=0,this.defender.intent="spoil",this.defender.forceActionState("run",this.game),this.defender.intentTarget=kicker.pos.c),this.kicker.intent="idle",this.finished=!0;return}if(this.timer<this.maxTimer-1&&playedOn){game.contestManager.resumeOpenPlay(ball,game.now),game.banner.commentary("PLAY ON!"),this.defender!==null&&(this.defender.stateTimer=0,this.defender.intent="spoil",this.defender.forceActionState("run",this.game),this.defender.intentTarget=kicker.pos.c),this.kicker.intent="idle",this.finished=!0;return}}enforce(player,dt){const{defender,markPos}=this;return player===defender&&this.defenderMarkAssignment.arrived&&(player.pos.copyFrom(markPos),player.vel.setFrom(0,player.vel[1],0),player.jogVel.setFrom(0,0,0),player.joltVel.setFrom(0,0,0)),!1}}class CenterBounceSetPiece extends SetPiece{constructor(game){super(game),this.bouncePos=v3(0,0,FIELD_LENGTH$1/2),game.contestManager.enterGround({point:this.bouncePos.c,source:game.ball,time:game.now}),this.game=game;const ball=game.ball;ball.carried=!1,ball.carrier=null,ball.pos.setFrom(0,0,FIELD_LENGTH$1/2),ball.vel.setFrom(0,0,0),ball.origin.copyFrom(ball.pos),ball.lastTouchedBy=null,ball.lastTouchedType=null,this.ballLaunched=!1,this.waitTimer=5;for(const p of game.players)p.playing&&(p.pos.copyFrom(p.positionPos),p.vel.setFrom(0,0,0),p.jogVel.setFrom(0,0,0),p.joltVel.setFrom(0,0,0),p.forceActionState("idle",this.game),p.intent="centerBounceFreeze",p.intentTarget=null);const homePlayers=game.players.filter(p=>p.team==="home"&&p.playing),awayPlayers=game.players.filter(p=>p.team==="away"&&p.playing);this.homeRuck=this.findRuck(homePlayers),this.awayRuck=this.findRuck(awayPlayers),this.homeRuck&&(this.homeRuck.intent="ruckTap",this.homeRuck.intentTarget=v3(0,0,0)),this.awayRuck&&(this.awayRuck.intent="ruckTap",this.awayRuck.intentTarget=v3(0,0,0)),this.crumbers=game.players.filter(p=>["RR","Rover","C"].includes(p.position)),this.crumbAssignments=new Map,this.crumbers.forEach((c,i)=>{const ruck=c.team==="home"?this.homeRuck:this.awayRuck,angle=(i%2===0?-1:1)*(Math.PI/4),offset=v3(Math.sin(angle)*(Math.random()*4+4),0,Math.cos(angle)*(Math.random()*4+4));c.intent="crumb",ruck?(c.intentTarget=ruck.pos.c.add(offset),this.crumbAssignments.set(c,{ruck,offset})):c.intentTarget=this.bouncePos.c.add(offset)});const homeCrumbers=this.crumbers.filter(p=>p.team==="home"),prefer=["RR","Rover","C"];let control=null;for(const pos of prefer)if(control=homeCrumbers.find(p=>p.position===pos)??null,control)break;!control&&homeCrumbers.length>0&&(control=homeCrumbers[0]),control||(control=this.homeRuck??homePlayers[0]??null),control&&(this.game.player=control),this.jumped=new Set,this.tapResolved=!1,this.moveStartTimes=new Map,this.ballLaunchTime=0,audio.whistle3.play()}findRuck(players){if(players.length===0)return null;let ruck=players.find(p=>p.position==="Ruck");return ruck||(ruck=players.reduce((a2,b)=>a2&&a2.statsHeight>b.statsHeight?a2:b,players[0])),ruck??null}update(dt){super.update(dt);const ball=this.game.ball;if(!this.ballLaunched){if(this.waitTimer-=dt,this.waitTimer<=0){this.game.banner.commentary("BALL UP!");const launchDir=v3((Math.random()-.5)*BALL_LAUNCH_HORIZONTAL_NOISE,1,(Math.random()-.5)*BALL_LAUNCH_HORIZONTAL_NOISE).normalize();ball.launch(launchDir,15,null),this.ballLaunched=!0,this.ballLaunchTime=this.timer,this.homeRuck&&this.homeRuck.forceActionState("run",this.game),this.awayRuck&&this.awayRuck.forceActionState("run",this.game)}return}if(ball.carried||ball.hasBounced){this.finished=!0;for(let p of this.game.players)p.playing&&(p.intent="idle")}}}class BoundaryThrowInSetPiece extends SetPiece{constructor(game,pos){super(game),game.contestManager.enterGround({point:pos.c,source:game.ball,time:game.now}),this.game=game,this.throwPos=pos.c,this.waitTimer=5,this.ballLaunched=!1;const ball=game.ball;ball.carried=!1,ball.carrier=null,ball.pos.copyFrom(pos),ball.vel.setFrom(0,0,0),ball.origin.copyFrom(pos),ball.lastTouchedBy=null,ball.lastTouchedType=null;for(const p of game.players)p.playing&&(p.pos.copyFrom(p.positionPos),p.vel.setFrom(0,0,0),p.jogVel.setFrom(0,0,0),p.joltVel.setFrom(0,0,0),p.forceActionState("idle",this.game),p.intentTarget=null);const center=v3(0,0,FIELD_LENGTH$1/2);this.fieldDir=center.c.sub(pos).zeroY().normalize(),this.landingPos=pos.c.add(this.fieldDir.c.scale(20)),this.ruckPos=pos.c.add(this.fieldDir.c.scale(25));const homePlayers=game.players.filter(p=>p.team==="home"&&p.playing),awayPlayers=game.players.filter(p=>p.team==="away"&&p.playing);this.homeRuck=this.findRuck(homePlayers),this.awayRuck=this.findRuck(awayPlayers),this.homeRuck&&(this.homeRuck.pos.copyFrom(this.ruckPos),this.homeRuck.vel.setFrom(0,0,0),this.homeRuck.jogVel.setFrom(0,0,0),this.homeRuck.joltVel.setFrom(0,0,0),this.homeRuck.intent="ruckTap",this.homeRuck.intentTarget=v3(0,0,0),this.homeRuck.forceActionState("idle",this.game)),this.awayRuck&&(this.awayRuck.pos.copyFrom(this.ruckPos),this.awayRuck.vel.setFrom(0,0,0),this.awayRuck.jogVel.setFrom(0,0,0),this.awayRuck.joltVel.setFrom(0,0,0),this.awayRuck.intent="ruckTap",this.homeRuck.intentTarget=v3(0,0,0),this.homeRuck.forceActionState("idle",this.game));const byTeam={home:game.players.filter(p=>p.team==="home"&&p!==this.homeRuck&&p.playing),away:game.players.filter(p=>p.team==="away"&&p!==this.awayRuck&&p.playing)};this.crumbers=[];for(const team of Object.keys(byTeam)){const list=byTeam[team].sort((a2,b)=>a2.pos.dist(this.landingPos)-b.pos.dist(this.landingPos));let selected=list.filter(p=>p.positionPos.dist(this.landingPos)<40).slice(0,5);if(selected.length<2){const extras=list.filter(p=>!selected.includes(p)).slice(0,2-selected.length);selected.push(...extras)}selected=selected.slice(0,5),selected.forEach(p=>{p.intent="crumb",p.intentTarget=this.landingPos}),this.crumbers=this.crumbers.concat(selected)}this.crumbAssignments=new Map,this.crumbers.forEach((c,i)=>{const ruck=c.team==="home"?this.homeRuck:this.awayRuck,angle=(i%2===0?-1:1)*(Math.PI/4),offset=v3(Math.sin(angle)*(Math.random()*4+4),0,Math.cos(angle)*(Math.random()*4+4));c.intent="crumb",ruck?(c.intentTarget=ruck.pos.c.add(offset),this.crumbAssignments.set(c,{ruck,offset})):c.intentTarget=this.landingPos.c.add(offset)}),this.jumped=new Set,audio.whistle3.play()}cameraTarget(){return this.game.ball.pos.c}findRuck(players){const skip=this.game.player,candidates=players.filter(p=>p!==skip);let ruck=candidates.find(p=>p.position==="Ruck");return ruck&&ruck.pos.dist(this.landingPos)/ruck.jogSpeed<=this.waitTimer?ruck:candidates.sort((a2,b)=>{const da=a2.pos.dist(this.landingPos),db=b.pos.dist(this.landingPos);return Math.abs(da-db)<.001?b.statsHeight-a2.statsHeight:da-db})[0]??null}update(dt){super.update(dt);const ball=this.game.ball;if(!this.ballLaunched){if(this.waitTimer-=dt,this.waitTimer<=0){this.game.banner.commentary("BALL UP!");const params=getLaunchParamsFor(ball.pos.c,this.landingPos,Math.abs(ball.gravity[1]),60),noise=()=>(Math.random()-.5)*BALL_LAUNCH_HORIZONTAL_NOISE;if(params){const direction=params.direction.c.add(v3(noise(),0,noise())).normalize();ball.launch(direction,params.speed,null)}else{const fallbackDir=this.fieldDir.c.add(v3(noise(),0,noise())).normalize();ball.launch(fallbackDir,10,null)}this.ballLaunched=!0,this.awayRuck.forceActionState("run",this.game),this.homeRuck.forceActionState("run",this.game)}return}if(ball.vel[1]<0){for(const r2 of[this.homeRuck,this.awayRuck])if(r2&&!this.jumped.has(r2)){const g=ball.gravity[1]??-9.8;(-ball.vel[1]-Math.sqrt(Math.max(0,ball.vel[1]**2-2*g*(ball.pos[1]-r2.statsHeight))))/g<=.2&&(r2.vel[1]=r2.statsJump,this.jumped.add(r2))}}(ball.carried||ball.hasBounced)&&(this.finished=!0)}}class TrainingKicking extends SetPiece{update(){var _a;const contestType=(_a=this.game.currentContest)==null?void 0:_a.type;if(this.game.ball.hasBounced)this.game.banner.commentary("NO DROPS",null,2e3);else if(contestType==="outOfBounds")this.game.banner.commentary("NO OUT OF BOUNDS",null,2e3);else if(contestType==="behind")this.game.banner.commentary("BEHIND",null,2e3);else if(contestType==="goal")this.game.banner.commentary("GOAL!!",null,2e3);else return;this.game.setupTraining(this.game.homeId,this.game.awayId,5,"kicking")}}class TrainingHandpass extends SetPiece{update(){var _a;const contestType=(_a=this.game.currentContest)==null?void 0:_a.type;if(this.game.ball.hasBounced)this.game.banner.commentary("NO DROPPED BALLS",null,2e3);else if(contestType==="outOfBounds")this.game.banner.commentary("NO OUT OF BOUNDS",null,2e3);else if(contestType==="behind")this.game.banner.commentary("BEHIND",null,2e3);else if(contestType==="goal")this.game.banner.commentary("GOAL!!",null,2e3);else if(this.game.ball.lastTouchedType==="kick"&&this.game.ball.pos.dist(goals.home)>50)this.game.banner.commentary(`NO KICKS
GET CLOSER TO TARGET`,null,2e3);else return;this.game.setupTraining(this.game.homeId,this.game.awayId,5,"handpass")}}class GeneralOverviewTutorial extends SetPiece{constructor(game){super(game),this.initialized=!1,this.state="collect",this.showedPickUp=!1,this.showedScoring=!1,this.showedKickPrompt=!1,this.startZ=goals.away[2]-1}initOnce(){const p=this.game.player,ball=this.game.ball;if(!p||!ball)return;this.startZ=goals.away[2]-1,p.pos.setFrom(0,0,this.startZ),p.vel.setFrom(0,0,0),p.jogVel.setFrom(0,0,0),p.joltVel.setFrom(0,0,0);for(const q of this.game.players)q!==p&&(q.pos.setFrom(5e3,0,5e3),q.vel.setFrom(0,0,0),q.jogVel.setFrom(0,0,0),q.joltVel.setFrom(0,0,0));ball.pos.setFrom(p.pos[0],0,p.pos[2]-15),ball.vel.setFrom(0,0,0),ball.hasBounced=!1,ball.carrier=null,this.game.cameraTarget.setFrom(0,10,p.pos[2]-30),this.game.banner.commentary("Run forward and collect the ball.",null,2500),this.initialized=!0,this.state="collect"}update(){var _a;if(!this.initialized){this.initOnce();return}const g=this.game,p=g.player,ball=g.ball;if(!p||!ball)return;const haveBall=ball.carrier===p;switch(this.state){case"collect":{ball.hasBounced&&!haveBall&&(g.banner.commentary("Pick it up clean — no drops.",null,2e3),ball.pos.setFrom(p.pos[0],0,p.pos[2]-5),ball.vel.setFrom(0,0,0),ball.hasBounced=!1),haveBall&&!this.showedPickUp&&(this.showedPickUp=!0,g.banner.commentary("Good — you have possession.",null,1600),this.state="explain");break}case"explain":{this.showedScoring||(this.showedScoring=!0,g.banner.commentary("Kick between the tall posts for 6; between tall and short for 1.",null,3200)),this.showedKickPrompt||(this.showedKickPrompt=!0,g.banner.commentary("Run closer to the goal, then aim between the two center uprights.",null,3600)),ball.lastTouchedType==="kick"&&(g.banner.commentary("Nice kick! Watch the result.",null,1600),this.state="waitKick");break}case"waitKick":{const result=(_a=g.currentContest)==null?void 0:_a.type;result==="goal"?(g.banner.commentary("GOAL — six points!",null,2200),g.contestManager.enterGround({point:ball.pos.c,source:ball,time:g.now}),this.state="done"):result==="behind"?(g.banner.commentary("Behind — one point.",null,2200),ball.pos.setFrom(p.pos[0],0,p.pos[2]-12),ball.vel.setFrom(0,0,0),ball.hasBounced=!1,ball.carrier=null,g.contestManager.enterGround({point:ball.pos.c,source:ball,time:g.now}),this.state="explain"):result==="outOfBounds"?(g.banner.commentary("Out of bounds — try to aim between the posts.",null,2600),ball.pos.setFrom(p.pos[0],0,p.pos[2]-12),ball.vel.setFrom(0,0,0),ball.hasBounced=!1,ball.carrier=null,g.contestManager.enterGround({point:ball.pos.c,source:ball,time:g.now}),this.state="explain"):!haveBall&&ball.hasBounced&&Math.abs(ball.pos[2]-p.pos[2])<8&&(g.banner.commentary("Gather and go again.",null,1600),this.state="collect");break}}}}const PRESSURE_RADIUS=5,PRESSURE_KICK_DELAY=1,PRESSURE_HAND_DELAY=.5;function aiUnderPressure(player,game){return game.players.some(other=>other!==player&&other.playing&&other.team!==player.team&&other.pos.dist(player.pos)<PRESSURE_RADIUS)}function canAIDispose(player,game,type){if(player===game.player||!aiUnderPressure(player,game))return!0;const contest=game.currentContest;if(!contest||contest.carrier!==player||contest.type!=="carried"&&contest.type!=="tackled")return!0;const start=typeof contest.time=="number"?contest.time:game.now;return(game.now-start)/1e3>=(type==="kick"?PRESSURE_KICK_DELAY:PRESSURE_HAND_DELAY)}function catchOrTapBall(player,game){const ball=game.ball;if(!(game.currentContest&&["behind","goal","outOfBounds"].includes(game.currentContest.type))&&!ball.carried&&ball.catchCollidesWith(player)){if(ball.hasBounced){ball.pickup(player,ball.pos[1]),game.contestManager.enterCarried({carrier:player,handTarget:null,time:game.now});return}const isRuck=player.intent==="ruckTap"||player.intent==="jumpRuckTap",isSpoil=player.intent==="spoil"||player.intent==="jumpSpoil";if(ball.lastTouchedType==="tap"&&isRuck)return;if(isRuck&&ball.lastTouchedType===null||isSpoil||ball.vel[1]>0&&ball.lastTouchedType!=="handball"){ball.pickup(player,ball.pos[1]);const mates=game.players.filter(p=>p.team===player.team&&p!==player&&p.playing&&p.pos.dist(player.pos)<15),aimDir=mates.length>0?player.pos.dirTo(choose(mates).pos):v3(Math.random()-.5,0,Math.random()-.5).normalize();ball.launch(aimDir,10,"tap"),audio.kick().play(),isRuck&&(game.stats&&game.stats.recordRuckTap(player),game.banner.commentary(`RUCKTAP [${teamAbbrevs[player.teamId]}]`,player.team)),isSpoil&&game.banner.commentary(`SPOIL [${teamAbbrevs[player.teamId]}]`,player.team),ball.hasBounced=!1}else if(ball.lastTouchedType==="kick"&&ball.pos.dist(ball.origin)>15){audio.hit().play(),game.stats&&game.stats.recordMark(player);const markClear=!game.players.some(p=>p.team!==player.team&&p.pos.dist(player.pos)<5),dirZ=player.team==="home"?-1:1,behind=player.pos.c.add(v3(0,0,dirZ*8)),spaceBehind=!isOutOfBounds(behind)&&!game.players.some(p=>p.team!==player.team&&p.pos.dist(behind)<5);if(markClear&&spaceBehind&&(player.team==="away"||player.team==="home"&&game.controls.state.moveX!==0&&game.controls.state.moveZ!==0)){game.banner.commentary("PLAY ON"),setTimeout(()=>audio.whistle4.play(),250),ball.pickup(player),game.contestManager.enterCarried({carrier:player,handTarget:null,time:game.now});return}else game.banner.commentary(`MARK [${teamAbbrevs[player.teamId]}]`,player.team),game.setPiece=new FreeKickSetPiece(game,player,player.pos.c)}else ball.lastTouchedBy!==player&&(ball.pickup(player),game.contestManager.enterCarried({carrier:player,handTarget:null,time:game.now}))}}const bump={transitions:{run:(p,g)=>p.stateTimer>.3},update:(dt,g,p,transition)=>{if(transition&&(audio.hit().play(),p.intentTarget instanceof Player)){const pushDir=p.intentTarget.pos.c.sub(p.pos).zeroY().normalize();p.intentTarget.joltVel.add(pushDir.scale(4))}p.jogVel.setFrom(0,0,0),p.applyPhysics(dt,g)}},block={transitions:{run:(p,g)=>!0},update:(dt,g,p,transition)=>{if(transition&&p.intentTarget&&"pos"in p.intentTarget){audio.hit().play();const pushDir=p.pos.dirTo(p.intentTarget.pos??p.intentTarget).normalize();p.joltVel.copyFrom(pushDir.scale(8))}p.applyPhysics(dt,g)}},idle={transitions:{tackle:(p,g)=>{var _a;return g.ball.carrier!==null&&g.ball.carrier.team!==p.team&&p.collidesWith(g.ball.carrier)&&((_a=g.currentContest)==null?void 0:_a.type)==="carried"},tackled:(p,g)=>{var _a;return((_a=g.currentContest)==null?void 0:_a.type)==="tackled"&&g.currentContest.carrier===p&&g.currentContest.outcome==="tackled"},tackleSpill:(p,g)=>{var _a;return((_a=g.currentContest)==null?void 0:_a.type)==="tackled"&&g.currentContest.carrier===p&&g.currentContest.outcome==="tackleSpill"},run:(p,g)=>{const aiMovement=new Set(["runCarry","supportRun","lead","pushForward","fillSpace","markUp","crumb","gatherLoose","contestAnyway","freeKick","mark","jumpMark","spoil","jumpSpoil","ruckTap","jumpRuckTap"]).has(p.intent)&&(!!p.intentVelocity||!!p.intentTarget),isHuman=p===g.player,moveVecLen=len([g.controls.state.moveX,0,g.controls.state.moveZ]),humanMovement=isHuman&&moveVecLen>.1;return aiMovement||humanMovement},spoil:(p,g)=>p.intent==="spoil"&&g.ball.catchCollidesWith(p),mark:(p,g)=>p.intent==="mark"&&g.ball.catchCollidesWith(p),ruckTap:(p,g)=>p.intent==="ruckTap"&&g.ball.catchCollidesWith(p),jump:(p,g)=>{var _a;return(_a=p.intent)==null?void 0:_a.startsWith("jump")},pickUp:(p,g)=>!g.ball.carried&&g.ball.catchCollidesWith(p)},update:(dt,g,p)=>{p.joltVel.setFrom(0,0,0);const alpha=1-Math.exp(-dt/.2);p.energy=Math.min(p.energy+dt,p.statsEnergy),p.jogVel.lerp(p.joltVel,alpha),p.applyPhysics(dt,g)}},run={transitions:{tackle:(p,g)=>{var _a;return((_a=g.currentContest)==null?void 0:_a.type)==="carried"&&g.ball.carrier!==null&&g.ball.carrier.team!==p.team&&p.collidesWith(g.ball.carrier)},tackled:(p,g)=>{var _a;return((_a=g.currentContest)==null?void 0:_a.type)==="tackled"&&g.currentContest.carrier===p&&g.currentContest.outcome==="tackled"},tackleSpill:(p,g)=>{var _a;return((_a=g.currentContest)==null?void 0:_a.type)==="tackled"&&g.currentContest.carrier===p&&g.currentContest.outcome==="tackleSpill"},kick:(p,g)=>(p.intent==="kickToTarget"||p.intent==="kickToGoal")&&g.ball.carrier===p&&canAIDispose(p,g,"kick"),handball:(p,g)=>p.intent==="handball"&&g.ball.carrier===p&&canAIDispose(p,g,"handball"),spoil:(p,g)=>p.intent==="spoil"&&g.ball.catchCollidesWith(p),mark:(p,g)=>p.intent==="mark"&&g.ball.catchCollidesWith(p),ruckTap:(p,g)=>p.intent==="ruckTap"&&g.ball.catchCollidesWith(p),jump:(p,g)=>{var _a;return((_a=p.intent)==null?void 0:_a.startsWith("jump"))&&!g.ball.carried&&!g.ball.hasBounced},pickUp:(p,g)=>!g.ball.carried&&g.ball.catchCollidesWith(p)},update:(dt,g,p)=>{var _a,_b;if((_b=(_a=g.setPiece)==null?void 0:_a.enforce)!=null&&_b.call(_a,p,dt))return;const EPSILON2=1e-4,agility=p.statsAgility??5,alpha=1-Math.exp(-10*agility*dt);if(p.intentVelocity){const desiredDir=p.intentVelocity.c.normalize(),desiredSpeed=p.intentVelocity.len(),jogSpeed=Math.min(desiredSpeed,p.jogSpeed),jogIsMoving=p.jogVel.lenSq()>EPSILON2;desiredSpeed>jogSpeed&&p.joltVel.copyFrom(desiredDir).scale(desiredSpeed-jogSpeed);const blendedDir=jogIsMoving?p.jogVel.c.normalize().lerp(desiredDir,desiredSpeed>jogSpeed?alpha:alpha*2).normalize():desiredDir;p.jogVel.copyFrom(blendedDir).scale(jogSpeed)}else if(p.intentTarget){const toTarget=p.targetPos.c.zeroY().sub(p.pos.c.zeroY()),dist2=toTarget.len(),desiredSpeed=Math.min(p.jogSpeed+p.joltSpeed,dist2/dt);let jogSpeed=Math.min(p.jogSpeed,dist2/dt);jogSpeed<.5&&p.intent!=="ruckTap"&&p.intent!=="mark"&&p.intent!=="spoil"&&p.intent!=="contestAnyway"&&(jogSpeed=0);const desiredDir=toTarget.normalize(),blendedDir=p.jogVel.lenSq()>EPSILON2?p.jogVel.c.normalize().lerp(desiredDir,alpha).normalize():desiredDir;desiredSpeed>jogSpeed&&p.joltVel.copyFrom(desiredDir).scale(desiredSpeed-jogSpeed),p.jogVel.copyFrom(blendedDir).scale(jogSpeed)}else p.jogVel.lerp(v3(0,0,0),alpha),p.joltVel.setFrom(0,0,0);p.joltVel.len()>0?(p.energy>0&&(p.energy-=dt),p.energy<=0&&(p.energy=0,p.joltVel.scale(.5))):p.energy=Math.min(p.energy+dt,p.statsEnergy),p.applyPhysics(dt,g)}},jump={transitions:{mark:(p,g)=>p.intent==="jumpMark"&&g.ball.catchCollidesWith(p),spoil:(p,g)=>p.intent==="jumpSpoil"&&g.ball.catchCollidesWith(p),ruckTap:(p,g)=>p.intent==="jumpRuckTap"&&g.ball.catchCollidesWith(p),run:(p,g)=>p.pos[1]<=p.floorY},update:(dt,g,p,transition)=>{if(transition&&p.pos[1]<=p.floorY&&["jumpMark","jumpSpoil","jumpRuckTap"].includes(p.intent)){if(p.intentVelocity!==null){const desiredVel=p.intentVelocity.len(),desiredDir=p.intentVelocity.c.normalize();desiredVel>p.jogSpeed?(p.jogVel.copyFrom(desiredDir.c.scale(p.jogSpeed)),p.joltVel.copyFrom(desiredDir.c.scale(desiredVel-p.jogSpeed))):p.jogVel.copyFrom(p.intentVelocity)}p.vel[1]=p.statsJump}p.applyPhysics(dt,g)}},mark={transitions:{run:(p,g)=>p.stateTimer>.05&&p.pos[1]<=0,jump:(p,g)=>p.stateTimer>.05&&p.pos[1]>0},update:(dt,g,p,transition)=>{transition&&catchOrTapBall(p,g),p.applyPhysics(dt,g)}},spoil={transitions:{run:(p,g)=>p.stateTimer>.05&&p.pos[1]<=0,jump:(p,g)=>p.stateTimer>.05&&p.pos[1]>0},update:(dt,g,p,transition)=>{transition&&catchOrTapBall(p,g),p.applyPhysics(dt,g)}},ruckTap={transitions:{run:(p,g)=>p.stateTimer>.05&&p.pos[1]<=0,jump:(p,g)=>p.stateTimer>.05&&p.pos[1]>0},update:(dt,g,p,transition)=>{transition&&catchOrTapBall(p,g),p.applyPhysics(dt,g)}},standingMark={transitions:{run:(p,g)=>!g.setPiece||p.intent==="runCarry"&&len(p.jogVel)>.5},update:(dt,g,p)=>{p.jogVel.setFrom(0,0,0),p.applyPhysics(dt,g)}},kick={transitions:{run:(p,g)=>p.stateTimer>.3},update:(dt,g,p,transition)=>{transition&&p.intentTarget&&p.kickBall(g,p.targetPos),p.applyPhysics(dt,g)}},handball={transitions:{run:(p,g)=>p.stateTimer>.4},update:(dt,g,p,transition)=>{transition&&p.handpassBall(g,p.intentTarget),p.applyPhysics(dt,g)}},pickUp={transitions:{run:(p,g)=>p.stateTimer>.2},update:(dt,g,p,transition)=>{transition&&!g.ball.carried&&catchOrTapBall(p,g),p.applyPhysics(dt,g)}},tackled={transitions:{kick:(p,g)=>(p.intent==="kickToTarget"||p.intent==="kickToGoal")&&g.ball.carrier===p&&canAIDispose(p,g,"kick"),handball:(p,g)=>p.intent==="handball"&&g.ball.carrier===p&&canAIDispose(p,g,"handball"),tackleSpill:(p,g)=>{var _a;const contest=((_a=g.currentContest)==null?void 0:_a.type)==="tackled"?g.currentContest:null;if(!contest||contest.carrier!==p)return!1;const tacklerStr=[...contest.tacklers].reduce((s,t)=>s+t.statsStrength,0),total=tacklerStr+p.statsStrength,spillChance=tacklerStr/total+g.dt*.005,spill=Math.random()<g.dt*spillChance;return spill&&g.contestManager.updateTackleOutcome("tackleSpill"),spill},run:(p,g)=>{var _a;if(g.setPiece instanceof FreeKickSetPiece&&g.setPiece.kicker!==p)return!0;const contest=((_a=g.currentContest)==null?void 0:_a.type)==="tackled"?g.currentContest:null;if(!contest||contest.carrier!==p)return!0;const tacklerStr=[...contest.tacklers].reduce((s,t)=>s+t.statsStrength,0),relative=p.statsStrength/(tacklerStr||1),freeKickTime=Math.max(.3,Math.min(1,.5*relative)),done=p.stateTimer>freeKickTime*2;return done&&g.ball.carrier&&g.contestManager.enterCarried({carrier:g.ball.carrier,handTarget:null}),done}},update:(dt,g,p)=>{var _a;p.jogVel.normalize().scale(.5*p.jogSpeed);const contest=((_a=g.currentContest)==null?void 0:_a.type)==="tackled"?g.currentContest:null,tacklerStr=contest&&contest.carrier===p?[...contest.tacklers].reduce((s,t)=>s+t.statsStrength,0):0,relative=tacklerStr?p.statsStrength/tacklerStr:1,fkTime=Math.max(.3,Math.min(1,.5*relative));if(p.stateTimer>fkTime){const offender=contest?[...contest.tacklers][0]:null;g.banner.commentary("HOLDING THE BALL!",(offender==null?void 0:offender.team)??null),offender&&(g.stats&&g.stats.recordTackle(offender),g.setPiece=new FreeKickSetPiece(g,offender,g.ball.pos.c))}p.applyPhysics(dt,g)}},tackleSpill={transitions:{run:(p,g)=>{var _a;return p.stateTimer>.4?(((_a=g.currentContest)==null?void 0:_a.type)==="tackled"&&g.ball.carrier===p&&g.contestManager.enterCarried({carrier:g.ball.carrier,handTarget:null}),!0):!1}},update:(dt,g,p,transition)=>{var _a;if(transition){const tackler=((_a=g.currentContest)==null?void 0:_a.type)==="tackled"?[...g.currentContest.tacklers][0]:null;g.stats&&tackler&&g.stats.recordTackle(tackler),g.banner.commentary("BALL SPILLS FREE!",(tackler==null?void 0:tackler.team)??null);const dir=p.jogVel.c.normalize();g.ball.launch(dir,p.jogSpeed+p.joltSpeed,null),g.ball.lastTouchedBy=p}p.jogVel.normalize().scale(.5*p.jogSpeed),p.applyPhysics(dt,g)}},tackleAssist={transitions:{run:(p,g)=>p.stateTimer>.4},update:(dt,g,p)=>{p.jogVel.setFrom(0,0,0),p.applyPhysics(dt,g)}},tackle={transitions:{run:(p,g)=>{var _a;const contest=((_a=g.currentContest)==null?void 0:_a.type)==="tackled"?g.currentContest:null;return!contest||!contest.tacklers.has(p)?!0:p.stateTimer>.4?(!g.contestManager.removeTackler(p)&&g.ball.carrier&&g.contestManager.enterCarried({carrier:g.ball.carrier,handTarget:null}),!0):!1}},update:(dt,g,p,transition)=>{if(transition){audio.hit().play();const target=g.ball.carrier;if(target&&target.team!==p.team&&p.collidesWith(target)){const tacklerStr=p.statsStrength,carrierStr=target.statsStrength,total=tacklerStr+carrierStr,breakChance=Math.max(0,(carrierStr-tacklerStr)/total);if(Math.random()<breakChance)p.intentTarget=null,p.joltVel.setFrom(0,0,0);else{p.intentTarget=target,p.joltVel.setFrom(0,0,0),target.joltVel.setFrom(0,0,0);const spillChance=tacklerStr/total,outcome=Math.random()<spillChance?"tackleSpill":"tackled";!g.currentContest||g.currentContest.type!=="tackled"||g.currentContest.carrier!==target?g.contestManager.enterTackled({carrier:target,tackler:p,outcome}):g.contestManager.addTackler(p)}}}p.intentTarget&&"pos"in p.intentTarget?p.jogVel.copyFrom(p.pos.c.dirTo(p.intentTarget.pos).scale(.5*p.jogSpeed)):p.jogVel.setFrom(0,0,0),p.applyPhysics(dt,g)}},tackledGround={transitions:{run:(p,g)=>p.stateTimer>.4},update:(dt,g,p)=>{p.jogVel.setFrom(0,0,0),p.applyPhysics(dt,g)}},bounce={transitions:{run:(p,g)=>p.stateTimer>.4},update:(dt,g,p)=>{p.jogVel.setFrom(0,0,0),p.applyPhysics(dt,g)}},actionStateMachine={idle,run,jump,mark,bump,ruckTap,spoil,standingMark,kick,block,pickUp,tackle,tackleSpill,tackleAssist,tackled,tackledGround,bounce,handball},ANIM_FLAG_SQUASH=1,ANIM_FLAG_FLAT=2;function collidesCylindrical(a2,b){const[aw,ah]=a2.collideBounds(),[bw,bh]=b.collideBounds(),dx=a2.pos[0]-b.pos[0],dz=a2.pos[2]-b.pos[2],horizDistSq=dx*dx+dz*dz,ra=.5*aw,rb=.5*bw,combinedR=ra+rb,aBottom=a2.pos[1],aTop=a2.pos[1]+ah,bBottom=b.pos[1],bTop=b.pos[1]+bh,verticalOverlap=aBottom<bTop&&aTop>bBottom;return horizDistSq<=combinedR*combinedR&&verticalOverlap}function segmentCircleIntersection(ax,az,bx,bz,cx,cz,r2){const dx=bx-ax,dz=bz-az,fx=ax-cx,fz=az-cz,a2=dx*dx+dz*dz,b=2*(fx*dx+fz*dz),c=fx*fx+fz*fz-r2*r2,discriminant=b*b-4*a2*c;if(discriminant<0||a2===0)return null;const sqrt=Math.sqrt(discriminant),t1=(-b-sqrt)/(2*a2),t2=(-b+sqrt)/(2*a2);return t1>=0&&t1<=1?t1:t2>=0&&t2<=1?t2:null}function getIntentWeightBias(intent){switch(intent){case"mark":return 1.3;case"block":return 1.4;case"spoil":return 1.1;case"shepherd":return 1.25;case"contestAnyway":return 1;case"crumb":return .7;case"hangBack":return .5;default:return 1}}class Entity{constructor(pos){this.pos=v3(pos[0],pos[1],pos[2]),this.vel=v3(0,0,0),this.width=1.6,this.height=2.4,this.usesGravity=!0,this.gravity=v3(0,-9.8,0),this.bounce=0,this.floorY=0}update(dt,game){this.pos.scaleAndAdd(this.vel,dt),this.usesGravity&&this.pos[1]>this.floorY&&this.vel.scaleAndAdd(this.gravity,dt),this.pos[1]<this.floorY&&(this.pos[1]=this.floorY,Math.abs(this.vel[1])>.5?this.vel[1]=-this.vel[1]*this.bounce:this.vel[1]=0)}render(renderer){renderer.renderSprite(this.pos,this.width,this.height,1,0,void 0,0)}collidesWith(e){return collidesCylindrical(this,e)}collideBounds(){return[.5,1.8]}}const teams=Object.freeze({0:"Carlton",1:"West Coast",2:"Sydney",3:"Brisbane",4:"West Melbourne",5:"Collingwood",6:"Hawthorne",7:"Geelong",8:"Adelaide",9:"Fremantle",10:"Western Sydney",11:"Port Adelaide",12:"Melbourne",13:"Saint Kilda",14:"North Melbourne",15:"Essendon",16:"Richmond",17:"Gold Coast"}),teamAbbrevs=Object.freeze({0:"CRL",1:"WCO",2:"SYD",3:"BRS",4:"WME",5:"COL",6:"HAW",7:"GEL",8:"ADL",9:"FRM",10:"WSY",11:"PAD",12:"MEL",13:"STK",14:"NME",15:"ESS",16:"RCH",17:"GCO"}),teamIds=Object.keys(teamAbbrevs).map(m=>Number(m)),personAnimationSets=Object.freeze({ruddy:{front:[0,12,0],back:[0,13,0],headCount:4,bodyRowOffset:9},pasty:{front:[0,14,0],back:[0,15,0],headCount:3,bodyRowOffset:10},swarthy:{front:[0,16,0],back:[0,17,0],headCount:3,bodyRowOffset:11}}),uniformAnimationSets=Object.freeze({home:{front:[0,5,0],back:[0,6,0]},away:{front:[0,7,0],back:[0,8,0]}}),bodyAnimationSets=Object.freeze({idle:[[0,0,0]],run:[[1,0,0],[2,0,0],[3,0,0],[4,0,0],[5,0,0],[6,0,0]],kickRightFoot:[[1,0,0],[2,0,0]],kickLeftFoot:[[4,0,0],[5,0,0]],handpassRightHand:[[1,0,0],[0,0,0]],handpassLeftHand:[[4,0,0],[0,0,0]],jumpMark:[[1,0,0],[2,0,0],[0,0,0]],jumpSpoil:[[1,0,0],[2,0,0],[0,0,0]],tackle:[[11,0,ANIM_FLAG_SQUASH],[12,0,ANIM_FLAG_SQUASH]],tackled:[[11,0,ANIM_FLAG_SQUASH],[12,0,ANIM_FLAG_SQUASH]],tackleSpill:[[11,0,ANIM_FLAG_SQUASH],[12,0,ANIM_FLAG_SQUASH]],tackledGround:[[12,0,ANIM_FLAG_SQUASH]],bump:[[11,0,ANIM_FLAG_SQUASH]],mark:[[7,0,0]],spoil:[[10,0,0]],ruckTap:[[10,0,0]]});class Player extends Entity{constructor(position,team,teamId,pos,stats,playing=!1){super(pos),this.intent="idle",this.intentTarget=null,this.intentVelocity=null,this.positionPos=Vec3.fromArray(pos),this.teamId=teamId,this.complexion=stats.complexion??choose(["ruddy","pasty","swarthy"]),this.faceId=stats.faceId??getRandomInt(personAnimationSets[this.complexion].headCount),this.position=position,this.name=stats.name,this.team=team,this.playing=playing,this.build=["FF","FB","CHF","CHB","Ruck"].includes(position)?"big":"small",this.width=1.6,this.height=2.4,this.jogVel=v3(0,0,0),this.joltVel=v3(0,0,0),this.energy=10,this.statsEnergy=stats.energy,this.statsWeight=stats.weight,this.statsStrength=stats.strength,this.statsSpeed=stats.speed,this.jogSpeed=5,this.joltSpeed=this.statsSpeed-5,this.statsHeight=stats.height,this.statsJump=stats.jump,this.statsKickRange=stats.kickRange,this.statsHandpassRange=stats.handpassRange,this.statsAgility=stats.agility,this.statsFitness=stats.fitness,this.statsMorale=stats.morale,this.joltDecayRate=8,this.animState="idle",this.actionState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=8,this.stateTimer=0,this.animSprite=[[0,0,0]],this.label=Label.a({hints:{h:.04,w:.1},align:"center"}),this.playerCondition=stats.playerCondition,this.careerHealth=stats.careerHealth,this.contractLength=stats.contractLength,this.contractAmount=stats.contractAmount,this.salary=stats.contractAmount,this.age=stats.age,this.games=stats.games??0,this.experience=stats.experience??0,this.level=stats.level??1,this._experienceVarianceSeeded=stats._experienceVarianceSeeded??!1,this.activeBuffs={...stats.activeBuffs??{}},this.buffKick=stats.buffKick??1,this.buffHandball=stats.buffHandball??1,this.buffSpeed=stats.buffSpeed??1,this.buffStrength=stats.buffStrength??1,this.baseStarTier=stats.baseStarTier??3,this.peakStarTier=stats.peakStarTier??this.baseStarTier,this.starTier=stats.starTier??this.baseStarTier,this.debutAge=stats.debutAge??Math.max(18,this.age-2),this.peakAge=stats.peakAge??this.age+1,this.declineAge=stats.declineAge??this.age+4}get targetPos(){const target=this.intentTarget===null?this.pos.c:this.intentTarget;return"pos"in target?target.pos.c:target}get stunned(){return this.actionState==="tackle"||this.actionState==="tackled"}collideBounds(){return[.8,this.statsHeight]}getEffectiveCollisionRadius(){return this.intent==="shepherd"||this.intent==="block"?.8*1.4:this.intent==="crumb"||this.intent==="hangBack"?.8*.8:.8}applyPhysics(dt,game){const before=this.pos.c,prevVy=this.vel[1];this.vel.copyFrom(this.jogVel).add(this.joltVel),this.vel[1]=prevVy,this.pos[1]<=this.floorY&&this.joltVel.scale(Math.exp(-this.joltDecayRate*dt)),super.update(dt,game),preventFenceCrossing(before,this.pos)&&(this.vel[0]=0,this.vel[2]=0,this.jogVel[0]=0,this.jogVel[2]=0,this.joltVel[0]=0,this.joltVel[2]=0),this.checkPlayerCollisions(dt,game)}kickBall(game,target){const ball=game.ball;if(!ball.carried||ball.carrier!==this)return;let aimXZ;if(target){const d=("pos"in target?target.pos:target).c.sub(this.pos);aimXZ=v2(d[0],d[2])}else aimXZ=v2(this.vel[0]||0,this.vel[2]||(this.team==="home"?-1:1));const kickRange=this.statsKickRange*this.buffKick;aimXZ.len()>kickRange&&aimXZ.normalize().scale(kickRange);const applyNoise=!(game.player===this&&target);let aimForKick=aimXZ;if(applyNoise){const baseMagnitude=this.intent==="kickToGoal"?.15:.075,buff=Math.max(this.buffKick??1,.1),noiseMagnitude=baseMagnitude/buff;aimForKick=v2(...applyKickInaccuracy(aimXZ,noiseMagnitude))}const ballOffsetXZ=v2(ball.pos[0]-this.pos[0],ball.pos[2]-this.pos[2]),aimFromBall=Vec2$1.fromArray(aimForKick).sub(ballOffsetXZ),startOffsetY=ball.pos[1]-this.pos[1],vel=computeKickVelocity(this,aimFromBall,!1,void 0,startOffsetY,0,ball.pos);if(!vel)return;const speed=vel.len();if(speed<.001)return;const dir=vel.c.normalize();ball.launch(dir,speed,"kick"),audio.kick().play(),game.stats&&game.stats.recordKick(this)}handpassBall(game,target){var _a,_b;const ball=game.ball;if(!ball.carried||ball.carrier!==this)return;const contest=((_a=game.currentContest)==null?void 0:_a.type)==="carried"?game.currentContest:null;let catchPoint=null;if(contest&&contest.carrier===this){const planMatch=target&&typeof target=="object"&&"pos"in target?contest.handTarget===target:!target;planMatch&&contest.handTargetDest?catchPoint=contest.handTargetDest.c:planMatch&&contest.handTargetPlan&&(catchPoint=contest.handTargetPlan.destination.c)}if(!catchPoint&&target&&(catchPoint=("pos"in target?target.pos:target).c),!catchPoint){const fallback=this.intentVelocity??v3(this.vel[0]||0,0,this.vel[2]||(this.team==="home"?-1:1));catchPoint=this.pos.c.add(fallback.lenSq()>1e-6?fallback:v3(0,0,this.team==="home"?-1:1))}const towardCatch=catchPoint.c.sub(this.pos);let aimXZ=v2(towardCatch[0],towardCatch[2]);aimXZ.lenSq()<1e-6&&(aimXZ=v2(this.vel[0]||0,this.vel[2]||(this.team==="home"?-1:1)));const handRange=this.statsHandpassRange*this.buffHandball;aimXZ.len()>handRange&&aimXZ.normalize().scale(handRange);const loft=(_b=this.intentVelocity)==null?void 0:_b[1],startOffsetY=ball.pos[1]-this.pos[1],endOffsetY=this.statsHeight-.1,ballOffsetXZ=v2(ball.pos[0]-this.pos[0],ball.pos[2]-this.pos[2]),aimFromBall=aimXZ.c.sub(ballOffsetXZ);let vel=computeKickVelocity(this,aimFromBall,!0,loft,startOffsetY,endOffsetY,ball.pos);if(!vel&&loft!==void 0&&(vel=computeKickVelocity(this,aimFromBall,!0,void 0,startOffsetY,endOffsetY,ball.pos)),!vel)return;const speed=vel.len();if(speed<.001)return;const dir=vel.c.normalize();ball.launch(dir,speed,"handball"),audio.kick().play(),game.stats&&game.stats.recordHandpass(this)}update(dt,game){this.oldPos=this.pos.c;const oldActionState=this.actionState;let newActionState=null;const stateDef=actionStateMachine[oldActionState],transitions=stateDef==null?void 0:stateDef.transitions;if(transitions){for(const[target,condition]of Object.entries(transitions))if(condition(this,game)){newActionState=target;break}}const stateToUse=newActionState??oldActionState,transition=stateToUse!==oldActionState;transition?this.stateTimer=0:this.stateTimer+=dt;let setPieceBlocked=!1;if(game.setPiece&&(setPieceBlocked=game.setPiece.enforce(this,dt)),!setPieceBlocked){const handler=actionStateMachine[stateToUse];handler!=null&&handler.update&&handler.update(dt,game,this,transition)}const animationTrigger=newActionState;this.updateAnimation(dt,animationTrigger,game.ball),this.updateAim(game),newActionState!==null&&(this.actionState=newActionState),(Number.isNaN(this.pos[0])||Number.isNaN(this.pos[2]))&&this.pos}forceActionState(nextState,game){this.actionState=nextState,this.stateTimer=0,this.animTimer=0,this.animFrame=0,this.updateAnimation(0,nextState,game.ball)}updateAim(game){if(this===game.player){const controls=game.controls,aimTarget=controls.state.aimTarget;if(this.intentTarget instanceof Player?(game.handAimTarget.tint=[.2,1,.2,1],game.handAimTarget.setPosition([this.intentTarget.pos[0],.02,this.intentTarget.pos[2]+.8])):game.handAimTarget.tint=[.2,1,.2,0],this.actionState==="run"&&game.ball.carrier===this&&controls.state.kickHeldTime>0){const aim=fromValues(0,0);if(aimTarget&&add(aim,aim,aimTarget),aimTarget){const dist2=Math.hypot(aimTarget[0],aimTarget[1]),maxRange=this.statsKickRange*this.buffKick,ratio=dist2/maxRange;game.aimTarget.tint=ratio>=.8?[1,0,0,1]:[1,1,1,1]}else game.aimTarget.tint=[1,1,1,1];game.aimTarget.setPosition([this.pos[0]+aim[0],.02,this.pos[2]+aim[1]+.8])}else game.aimTarget.setPosition(v3(this.pos[0],.02,this.pos[2]+.8)),game.aimTarget.tint=[1,1,1,1]}}updateAnimation(dt,stateTriggered,ball){stateTriggered&&stateTriggered!=="kick"&&stateTriggered in bodyAnimationSets&&(this.animState=stateTriggered,this.animFrame=0,this.animTimer=0),stateTriggered==="kick"&&(this.animState="kickRightFoot",this.animFrame=0,this.animTimer=0),stateTriggered==="handball"&&(this.animState="handpassRightHand",this.animFrame=0,this.animTimer=0);const sequence=bodyAnimationSets[this.animState];if(!sequence||sequence.length===0)return;this.animTimer+=dt;const frameDuration=1/this.animFPS;this.animTimer>=frameDuration&&(this.animTimer-=frameDuration,this.animFrame=this.animFrame+1),this.vel[1]>.1&&this.animState!=="jumpMark"&&(this.animState="jumpMark",this.animFrame=0,this.animTimer=0),this.animState==="jumpMark"&&this.pos[1]<=this.floorY+.01&&this.vel[1]<=0&&(this.animState=this.vel.len()>.1?"run":"idle",this.animFrame=0,this.animTimer=0),this.animState==="run"&&this.vel.len()===0&&(this.animState="idle",this.animFrame=0,this.animTimer=0),this.animState==="idle"&&this.vel.len()!==0&&(this.animState="run",this.animFrame=0,this.animTimer=0);const loop=["run","idle","tackled","tackleSpill","tackledGround"].includes(this.animState);this.animFrame>=sequence.length&&(this.animFrame=loop?0:sequence.length-1,loop||(this.animState="run",this.animFrame=0,this.animTimer=0));const uniformFrame=uniformAnimationSets.home.back.slice();uniformFrame[0]+=this.teamId,this.team==="away"&&(uniformFrame[1]+=2);const headFrame=personAnimationSets[this.complexion].back.slice();headFrame[0]+=this.faceId;const bodyFrame=bodyAnimationSets[this.animState][this.animFrame].slice()??[0,0,0];bodyFrame[1]+=personAnimationSets[this.complexion].bodyRowOffset,this.animState==="tackle"&&(uniformFrame[2]|=ANIM_FLAG_SQUASH,headFrame[2]|=ANIM_FLAG_SQUASH),this.animState==="tackledGround"&&(uniformFrame[2]|=ANIM_FLAG_FLAT,headFrame[2]|=ANIM_FLAG_FLAT,bodyFrame[2]|=ANIM_FLAG_FLAT);const Z_THRESHOLD=.15;(this.jogVel[2]>Z_THRESHOLD?"away":this.jogVel[2]<-Z_THRESHOLD?"home":this.pos[2]<ball.pos[2]?"away":"home")==="away"&&(bodyFrame[0]+=13,uniformFrame[1]-=1,headFrame[1]-=1),this.animSprite=[uniformFrame,headFrame,bodyFrame]}render(renderer){const zFudge=v3(0,.005,.01);let s=1;for(let[col,row,flags]of this.animSprite)renderer.renderSprite(this.pos.c.scaleAndAdd(zFudge,s),this.width*this.statsWeight/85,this.height*this.statsHeight/1.7,col,row,void 0,flags),s++;{const gl=renderer.gl;gl.useProgram(renderer.program),gl.bindVertexArray(renderer.quadVao),gl.uniform4f(renderer.uTint,1,1,1,1),gl.uniform4f(renderer.uTint,1,1,1,1);const[col,row]=[2,3];renderer.setTileUV(col,row),gl.uniform1i(renderer.uTilingU,0),gl.uniform1i(renderer.uTilingV,0);const model=create$3();translate(model,model,[this.pos[0],.015,this.pos[2]]),rotateX(model,model,-Math.PI/2),scale$1(model,model,[2,2,1]),gl.uniformMatrix4fv(renderer.uModel,!1,model),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)}}checkPlayerCollisions(dt,game){var _a;if(this.intent==="freeKick"||this.actionState==="standingMark")return;const ball=game.ball;for(const other of game.players){if(other===this||!other.playing||other.intent==="freeKick"||other.actionState==="standingMark")continue;if(((_a=game.currentContest)==null?void 0:_a.type)==="tackled"){const contest=game.currentContest,carrier=contest.carrier;if(this===carrier&&contest.tacklers.has(other)||other===carrier&&contest.tacklers.has(this))continue}if(this.pos.dist(ball.pos)>50&&other.pos.dist(ball.pos)>50)continue;const offset=this.pos.c.sub(other.pos);offset[1]=0;const len2=offset.len(),r1=this.getEffectiveCollisionRadius(),r2=other.getEffectiveCollisionRadius(),overlap=(r1+r2)/2-.1-len2;if(overlap<=0)continue;len2<1e-4?(offset[0]=Math.random()-.5,offset[2]=Math.random()-.5,offset.normalize()):offset.scale(1/len2);const w1=this.statsWeight*getIntentWeightBias(this.intent),w2=other.statsWeight*getIntentWeightBias(other.intent),total=w1+w2,push=offset.c.scale(overlap),pushThis=push.c.scale(w2/total),pushOther=push.c.scale(w1/total);this.pos[0]+=pushThis[0],this.pos[2]+=pushThis[2],other.pos[0]-=pushOther[0],other.pos[2]-=pushOther[2]}}}const BALL_GRAB_TIME=.2;class Ball extends Entity{constructor(pos){super(pos),this.carried=!1,this.origin=v3(0,0,0),this.carrier=null,this.width=1.6,this.height=2.4,this.bounce=.5,this.animations=Object.freeze({idle:[[0,1,0]],backSpin:[[1,1,0],[2,1,0],[3,1,0],[4,1,0],[5,1,0],[6,1,0],[7,1,0],[8,1,0]],forwardSpin:[[8,1,0],[7,1,0],[6,1,0],[5,1,0],[4,1,0],[3,1,0],[2,1,0],[1,1,0]],backSpinRight:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]],backSpinLeft:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinRight:[[19,1,0],[18,1,0],[17,1,0],[16,1,0],[15,1,0],[14,1,0],[13,1,0],[12,1,0]],forwardSpinLeft:[[12,1,0],[13,1,0],[14,1,0],[15,1,0],[16,1,0],[17,1,0],[18,1,0],[19,1,0]]}),this.animState="idle",this.animFrame=0,this.animTimer=0,this.animFPS=12,this.lastTouchedBy=null,this.lastTouchedType=null,this.lastTouchedAt=null,this.hasBounced=!1,this.postCollision=null,this.holdPoint=v3(0,0,0),this.grabTimer=0}update(dt,game){if(this.carried&&this.carrier){const carrier=this.carrier,dirZ=carrier.vel[2]>0?1:carrier.vel[2]<0||carrier.team==="home"?-1:1,offset=v3(0,.5,.2*dirZ);if(this.holdPoint.copyFrom(this.carrier.pos).add(offset),this.grabTimer<BALL_GRAB_TIME){const remain=BALL_GRAB_TIME-this.grabTimer,t=Math.min(1,dt/remain);this.pos.lerp(this.holdPoint,t),this.grabTimer+=dt}else this.pos.copyFrom(this.holdPoint);this.origin.copyFrom(this.pos)}else{const before=this.pos.c,falling=this.vel[1]<0;super.update(dt,game);const hitGround=this.pos[1]<=this.floorY;falling&&this.vel[1]>0&&hitGround&&(this.vel.scale(.9),this.hasBounced?audio.bounce4.play():audio.bounce3.play(),this.hasBounced=!0),hitGround&&(this.vel.scale(.97),this.origin.copyFrom(this.pos)),this.handlePostCollision(before)}this.updateAnimation(dt)}handlePostCollision(before){const postSets=[{tag:"Away",posts:GOAL_POSTS_NORTH},{tag:"Home",posts:GOAL_POSTS_SOUTH}],ax=before[0],az=before[2],bx=this.pos[0],bz=this.pos[2],labels=["outerLeftPost","innerLeftPost","innerRightPost","outerRightPost"];for(const set2 of postSets)for(let i=0;i<set2.posts.length;i++){const p=set2.posts[i],t=segmentCircleIntersection(ax,az,bx,bz,p[0],p[2],POST_THICKNESS);if(t===null)continue;const ix=ax+(bx-ax)*t,iz=az+(bz-az)*t,nx=ix-p[0],nz=iz-p[2],len2=Math.hypot(nx,nz)||1,n0=nx/len2,n2=nz/len2,dot2=this.vel[0]*n0+this.vel[2]*n2;this.vel[0]-=2*dot2*n0,this.vel[2]-=2*dot2*n2,this.vel[0]*=.8,this.vel[2]*=.8,this.pos[0]=ix+n0*POST_THICKNESS,this.pos[2]=iz+n2*POST_THICKNESS,audio.goalPost.play(),this.hasBounced=!0,this.postCollision=`${labels[i]}${set2.tag}`;return}}collideBounds(){return[.4,.5]}catchCollidesWith(player){if(this.lastTouchedBy===player&&!this.hasBounced)return!1;const[pw,ph]=player.collideBounds(),[bw,bh]=this.collideBounds(),dx=this.pos[0]-player.pos[0],dz=this.pos[2]-player.pos[2],horiz=dx*dx+dz*dz,radius=.5*pw+.5*bw+.2,ballTop=this.pos[1]+bh,ballBottom=this.pos[1],playerReach=player.pos[1]+ph+.4,verticalOverlap=ballBottom<=playerReach&&ballTop>=player.pos[1];return horiz<=radius*radius&&verticalOverlap}pickup(carrier,pickupHeight=0){this.carried=!0,this.carrier=carrier,this.lastTouchedBy=carrier,this.lastTouchedType=null,this.lastTouchedAt=null,this.hasBounced=!1;const dirZ=carrier.vel[2]>0?1:carrier.vel[2]<0||carrier.team==="home"?-1:1;this.holdPoint.copyFrom(carrier.pos).add(v3(0,pickupHeight,dirZ*.2)),this.grabTimer=0,this.origin.copyFrom(this.pos),this.vel.setFrom(0,0,0)}launch(direction,speed,type="kick"){this.carried=!1,this.carrier=null,this.vel.copyFrom(direction).scale(speed),this.lastTouchedType=type,this.lastTouchedAt=this.pos.c,this.hasBounced=!1}updateAnimation(dt){this.animTimer+=dt;const frameDuration=1/this.animFPS;this.animTimer>=frameDuration&&(this.animTimer-=frameDuration,this.animFrame=this.animFrame+1);const prevState=this.animState;this.carried?this.animState="idle":this.lastTouchedType==="kick"&&!this.hasBounced?this.animState=this.vel[2]<0?"backSpin":"forwardSpin":this.lastTouchedType==="handball"&&!this.hasBounced?this.animState=this.vel[2]<0?"backSpinRight":"forwardSpinLeft":this.hasBounced?Math.abs(this.vel[1])<.05&&this.pos[1]<=this.floorY+.01?this.animState="idle":this.animState=this.vel[2]<0?"forwardSpin":"backSpin":this.animState="idle",this.animState!==prevState&&(this.animFrame=0,this.animTimer=0);const sequence=this.animations[this.animState];sequence.length!==0&&this.animFrame>=sequence.length&&(this.animFrame=0)}render(renderer){var _a;const sequence=(_a=this.animations)==null?void 0:_a[this.animState],[col,row,flags]=(sequence==null?void 0:sequence[this.animFrame])??[0,1,void 0];renderer.renderSprite(this.pos,this.width,this.height,col,row,void 0,flags??0);{const gl=renderer.gl;gl.useProgram(renderer.program),gl.bindVertexArray(renderer.quadVao);const[col2,row2]=[2,3];renderer.setTileUV(col2,row2),gl.uniform1i(renderer.uTilingU,0),gl.uniform1i(renderer.uTilingV,0);const model=create$3();translate(model,model,[this.pos[0],.01,this.pos[2]]),rotateX(model,model,-Math.PI/2),scale$1(model,model,[2,2,1]),gl.uniformMatrix4fv(renderer.uModel,!1,model),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)}}}class AimTarget{constructor(pos=[0,.001,0]){this.pos=Vec3.fromArray(pos),this.size=2,this.spriteCoord=[4,3],this.tint=[.5,.25,1,1]}setPosition(newPos){this.pos[0]=newPos[0],this.pos[2]=newPos[2]}render(renderer){const gl=renderer.gl;gl.useProgram(renderer.program),gl.bindVertexArray(renderer.quadVao);const[col,row]=this.spriteCoord;renderer.setTileUV(col,row),gl.uniform1i(renderer.uTilingU,0),gl.uniform1i(renderer.uTilingV,0),gl.uniform4f(renderer.uTint,this.tint[0],this.tint[1],this.tint[2],this.tint[3]);const model=create$3();translate(model,model,[this.pos[0],.02,this.pos[2]]),rotateX(model,model,-Math.PI/2),scale$1(model,model,[this.size,this.size,1]),gl.uniformMatrix4fv(renderer.uModel,!1,model),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)}}var _InputManager_instances,getPad_fn,onMouseDown_fn,onMouseMove_fn,onMouseUp_fn,onTouchStart_fn,onTouchMove_fn,onTouchEnd_fn;class InputManager{constructor(canvas){__privateAdd(this,_InputManager_instances);this.canvas=canvas,this.state={moveX:0,moveZ:0,kickPressed:!1,kickReleased:!1,kickAimActive:!1,quickDisposePressed:!1,switchPressed:!1,menuPressed:!1,kickHeldTime:0,aimTarget:null},this.keyMoveUp="w",this.keyMoveLeft="a",this.keyMoveDown="s",this.keyMoveRight="d",this.keyKick="k",this.keyQuick="j",this.keySwitch=" ";const keyControlData=localStorage.getItem("footy/keybinds");keyControlData?(this.keyControls=JSON.parse(keyControlData),this.keyMoveUp=this.keyControls.keyMoveUp,this.keyMoveLeft=this.keyControls.keyMoveLeft,this.keyMoveDown=this.keyControls.keyMoveDown,this.keyMoveRight=this.keyControls.keyMoveRight,this.keyMoveKick=this.keyControls.keyMoveKick,this.keyMoveSwitch=this.keyControls.keyMoveSwitch):this.keyControls={keyMoveUp:this.keyMoveUp,keyMoveLeft:this.keyMoveLeft,keyMoveDown:this.keyMoveDown,keyMoveRight:this.keyMoveRight,keyMoveKick:this.keyMoveKick,keyMoveSwitch:this.keyMoveSwitch},this.keys={},this.lastKeys={},this.touchMove=null,this.touchAim=null,this.gpIndex=-1,this.gamepadAimActive=!1,this.lastGpButtons=[],this.kPressTime=0,this.gamepadActive=!1,this.mouseMode=!1,this.mouseAim=null,this.mouseKickActive=!1,this.mouseKickStart=!1,this.mouseQuickDisposeQueued=!1,this.lastMouseMode=!1,canvas.addEventListener("touchstart",__privateMethod(this,_InputManager_instances,onTouchStart_fn).bind(this),{passive:!1}),canvas.addEventListener("touchmove",__privateMethod(this,_InputManager_instances,onTouchMove_fn).bind(this),{passive:!1}),canvas.addEventListener("touchend",__privateMethod(this,_InputManager_instances,onTouchEnd_fn).bind(this)),canvas.addEventListener("mousedown",__privateMethod(this,_InputManager_instances,onMouseDown_fn).bind(this)),window.addEventListener("mousemove",__privateMethod(this,_InputManager_instances,onMouseMove_fn).bind(this)),window.addEventListener("mouseup",__privateMethod(this,_InputManager_instances,onMouseUp_fn).bind(this)),canvas.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("keydown",e=>{const key=e.key.toLowerCase();this.keys[key]=!0,(key===this.keyKick||key===this.keyQuick)&&(this.mouseMode=!1)}),window.addEventListener("keyup",e=>this.keys[e.key.toLowerCase()]=!1)}endUpdate(){this.state.kickAimActive||(this.state.aimTarget=null),this.state.moveX=0,this.state.moveZ=0,this.state.kickPressed=!1,this.state.kickReleased=!1,this.state.menuPressed=!1,this.state.quickDisposePressed=!1,this.state.switchPressed=!1}update(dt){var _a,_b,_c,_d;const keyboardKick=!!this.keys[this.keyKick]&&!this.mouseMode,keyboardKickPrev=!!this.lastKeys[this.keyKick]&&!this.lastMouseMode;if(this.state.quickDisposePressed=this.keys[this.keyQuick]&&!this.lastKeys[this.keyQuick],this.state.switchPressed=this.keys[this.keySwitch]&&!this.lastKeys[this.keySwitch],this.state.menuPressed=this.keys.escape&&!this.lastKeys.escape,keyboardKick&&!keyboardKickPrev&&(this.state.kickPressed=!0,this.kPressTime=0,this.state.aimTarget=[0,-10],this.state.kickAimActive=!0),keyboardKick?(this.kPressTime+=dt,this.state.aimTarget&&(this.keys[this.keyMoveLeft]&&(this.state.aimTarget[0]-=30*dt),this.keys[this.keyMoveRight]&&(this.state.aimTarget[0]+=30*dt),this.keys[this.keyMoveUp]&&(this.state.aimTarget[1]-=60*dt),this.keys[this.keyMoveDown]&&(this.state.aimTarget[1]+=60*dt))):(this.keys[this.keyMoveLeft]&&(this.state.moveX-=1),this.keys[this.keyMoveRight]&&(this.state.moveX+=1),this.keys[this.keyMoveUp]&&(this.state.moveZ-=1),this.keys[this.keyMoveDown]&&(this.state.moveZ+=1)),!keyboardKick&&keyboardKickPrev&&(this.state.kickReleased=!0,this.state.kickAimActive=!1),this.mouseKickStart&&(this.state.kickPressed=!0,this.state.kickAimActive=!0,this.state.aimTarget=this.state.aimTarget??[0,-10],this.mouseKickStart=!1),this.mouseKickActive&&this.mouseAim){this.kPressTime+=dt,this.state.kickAimActive=!0;const dx=this.mouseAim.dx,dz=this.mouseAim.dy,magZ=100,magX=100;this.state.aimTarget=[-dx*magX,-dz*magZ],this.state.kickHeldTime=this.kPressTime,this.mouseAim.finished&&(Math.abs(dx)<.01&&Math.abs(dz)<.01&&this.state.kickHeldTime<.5?this.state.quickDisposePressed=!0:this.state.kickReleased=!0,this.state.kickAimActive=!1,this.mouseKickActive=!1,this.mouseAim=null)}if(this.state.kickHeldTime=this.kPressTime,this.touchMove&&(this.state.moveX=this.touchMove.dx,this.state.moveZ=this.touchMove.dy,this.touchMove.finished&&(Math.abs(this.touchMove.dx)<.01&&Math.abs(this.touchMove.dy)<.01&&(this.state.switchPressed=!0),this.touchMove=null)),this.touchAim){this.kPressTime+=dt;const dx=this.touchAim.dx,dz=this.touchAim.dy,magZ=100,magX=100;this.state.aimTarget=[-dx*magX,-dz*magZ],this.state.kickHeldTime=this.kPressTime,this.touchAim.finished&&(Math.abs(this.touchAim.dx)<.01&&Math.abs(this.touchAim.dy)<.01&&this.state.kickHeldTime<.5?this.state.quickDisposePressed=!0:(this.state.kickReleased=!0,this.state.kickAimActive=!1),this.touchAim=null)}let gp=__privateMethod(this,_InputManager_instances,getPad_fn).call(this);if(gp&&(Math.abs(gp.axes[0])>.1||Math.abs(gp.axes[1])>.1||Math.abs(gp.axes[2])>.1||Math.abs(gp.axes[3])>.1)&&(this.gamepadActive=!0),gp&&this.gamepadActive){this.state.moveX+=Math.abs(gp.axes[0])>.1?gp.axes[0]:0,this.state.moveZ+=Math.abs(gp.axes[1])>.1?gp.axes[1]:0;const lastLeftBumper=((_a=this.lastGpButtons[4])==null?void 0:_a.pressed)??!1;this.state.switchPressed=((_b=gp.buttons[4])==null?void 0:_b.pressed)&&!lastLeftBumper;const lastRightBumper=((_c=this.lastGpButtons[5])==null?void 0:_c.pressed)??!1;this.state.quickDisposePressed=((_d=gp.buttons[5])==null?void 0:_d.pressed)&&!lastRightBumper;const aimX=gp.axes[2]||0,aimZ=gp.axes[3]||0,aimMag=Math.max(Math.hypot(aimX,aimZ),1e-4);this.gamepadAimActive?(this.kPressTime+=dt,this.state.kickHeldTime+=this.kPressTime,aimZ>.025?this.state.aimTarget&&(this.state.aimTarget=[this.state.aimTarget[0]-aimX/aimMag,this.state.aimTarget[1]-aimZ/aimMag]):(this.state.kickReleased=!0,this.state.kickAimActive=!1,this.gamepadAimActive=!1)):aimZ>.1&&(this.state.aimTarget=[0,0],this.kPressTime=0,this.state.kickHeldTime=this.kPressTime,this.state.kickPressed=!0,this.gamepadAimActive=!0,this.state.kickAimActive=!0),this.lastGpButtons=gp.buttons.slice()}this.mouseQuickDisposeQueued&&(this.state.quickDisposePressed=!0,this.mouseQuickDisposeQueued=!1),this.lastKeys={...this.keys},this.lastMouseMode=this.mouseMode}getState(){return this.state}}_InputManager_instances=new WeakSet,getPad_fn=function(){var _a;const pads=((_a=navigator.getGamepads)==null?void 0:_a.call(navigator))??[];if(this.gpIndex>=0){const p=pads[this.gpIndex];if(p&&p.connected)return p}const foundIdx=Array.from(pads).findIndex(p=>p&&p.connected);return this.gpIndex=foundIdx,foundIdx!==-1?pads[foundIdx]:null},onMouseDown_fn=function(e){if(e.button===0){e.preventDefault();const width=window.innerWidth||1,height=window.innerHeight||1;this.mouseMode=!0,this.mouseAim={startX:e.clientX,startY:e.clientY,dx:0,dy:0,width,height,finished:!1},this.mouseKickActive=!0,this.mouseKickStart=!0,this.kPressTime=0}else e.button===2&&(e.preventDefault(),this.mouseMode=!0,this.mouseQuickDisposeQueued=!0)},onMouseMove_fn=function(e){if(!this.mouseAim||!this.mouseKickActive)return;const width=this.mouseAim.width||window.innerWidth||1,height=this.mouseAim.height||window.innerHeight||1;this.mouseAim.dx+=e.movementX/width,this.mouseAim.dy+=e.movementY/height},onMouseUp_fn=function(e){e.button===0&&this.mouseAim&&(e.preventDefault(),this.mouseAim.finished=!0)},onTouchStart_fn=function(e){e.preventDefault();for(const t of e.changedTouches)t.clientX<window.innerWidth/2?this.touchMove={id:t.identifier,startX:t.clientX,startY:t.clientY,dx:0,dy:0,finished:!1}:(this.touchAim={id:t.identifier,startX:t.clientX,startY:t.clientY,dx:0,dy:0,finished:!1},this.state.kickPressed=!0,this.kPressTime=0)},onTouchMove_fn=function(e){e.preventDefault();for(const t of e.changedTouches)this.touchMove&&t.identifier===this.touchMove.id&&(this.touchMove.dx=(t.clientX-this.touchMove.startX)/window.innerWidth,this.touchMove.dy=(t.clientY-this.touchMove.startY)/window.innerHeight),this.touchAim&&t.identifier===this.touchAim.id&&(this.touchAim.dx=(t.clientX-this.touchAim.startX)/window.innerWidth,this.touchAim.dy=(t.clientY-this.touchAim.startY)/window.innerHeight,this.state.kickAimActive=!0)},onTouchEnd_fn=function(e){e.preventDefault();for(const t of e.changedTouches)this.touchAim&&t.identifier===this.touchAim.id&&(this.touchAim.finished=!0),this.touchMove&&t.identifier===this.touchMove.id&&(this.touchMove.finished=!0)};function SLOT_KEY(i){return`thefooty/careerSlot${i}`}const FORWARD_POSITIONS=new Set(["LFP","FF","RFP","LHF","CHF","RHF"]),BACK_POSITIONS=new Set(["LBP","FB","RBP","LHB","CHB","RHB"]),MIDFIELD_POSITIONS=new Set(["RR","Rover","C","LW","RW","Ruck Rover"]),RUCK_POSITIONS=new Set(["Ruck","RUCK","RU"]);class CareerTeam{constructor({id,name,abbrev,offense,defense,roster=[]}){this.id=id,this.name=name,this.abbrev=abbrev,this.offense=offense,this.defense=defense,this.roster=roster}get rating(){const average=calculateTeamAverageRating(this.roster);return Number.isFinite(average)&&average>0?ratingToStars(average):0}}class CareerMatch{constructor({home,away}){this.home=home,this.away=away}static fromIds(homeId,awayId,teamLookup){const home=teamLookup.get(homeId),away=teamLookup.get(awayId);if(!home||!away)throw new Error(`Unable to resolve teams for match: ${homeId} vs ${awayId}`);return new CareerMatch({home,away})}}class CareerMatchResult extends CareerMatch{constructor({home,away,homeScore=0,awayScore=0,homeGoals=0,homeBehinds=0,awayGoals=0,awayBehinds=0}){super({home,away}),this.homeScore=homeScore,this.awayScore=awayScore,this.homeGoals=homeGoals,this.homeBehinds=homeBehinds,this.awayGoals=awayGoals,this.awayBehinds=awayBehinds}static fromMatch(match){return new CareerMatchResult({home:match.home,away:match.away})}}class CareerFinalsRound{constructor({name,matches=[],results=[]}){this.name=name,this.matches=matches,this.results=results}}class Career{constructor({name,created,teams:teams2,playerTeamId,season,round,salaryCap,schedule,results,finals,freeAgents,version,pendingLevelUps=[]}){this.name=name??"",this.created=created??Date.now(),this.teams=teams2??[],this.playerTeamId=playerTeamId??0,this.season=season??0,this.round=round??0,this.salaryCap=salaryCap??0,this.schedule=schedule??[],this.results=results??[],this.finals=finals??[],this.freeAgents=freeAgents??[],this.version=version??0,this.pendingLevelUps=pendingLevelUps??[]}getTeamById(id){return this.teams.find(t=>t.id===id)??null}getFinalsRoundName(index){var _a;return((_a=this.finals[index])==null?void 0:_a.name)??finalsRoundNames[index]??`Finals Round ${index+1}`}get seasonLength(){return this.schedule.length}get isFinals(){return this.round>=this.seasonLength}get finalsIndex(){return Math.max(0,this.round-this.seasonLength)}get currentFinalsRound(){return this.isFinals?this.finalsIndex:-1}getMatches(abs=this.round){var _a;return abs<this.seasonLength?this.schedule[abs]??[]:((_a=this.finals[this.finalsIndex])==null?void 0:_a.matches)??[]}getResultsRef(abs=this.round){if(abs<this.seasonLength)return{kind:"season",arr:this.results[abs]??(this.results[abs]=[])};const fr=this.finals[this.finalsIndex];return{kind:"finals",arr:fr?fr.results:[]}}advanceRound(){this.round+=1,this.isFinals&&advanceTournament(this,computeLadder(this))}}function buffPriorityForPlayer(player){const pos=(player==null?void 0:player.position)||"";return RUCK_POSITIONS.has(pos)?["strength","handball","kick","speed"]:FORWARD_POSITIONS.has(pos)?["kick","speed","strength","handball"]:BACK_POSITIONS.has(pos)?["strength","handball","speed","kick"]:MIDFIELD_POSITIONS.has(pos)?["speed","handball","kick","strength"]:["speed","strength","kick","handball"]}function chooseBuffForAI(player){const active=player.activeBuffs||{},available=Object.keys(BUFFS).filter(id=>{const meta=BUFFS[id];return(active[id]??0)<meta.levels.length-1});if(available.length===0)return null;const priorities=buffPriorityForPlayer(player);for(const buffId of priorities)if(available.includes(buffId))return buffId;return available.sort((a2,b)=>(active[a2]??0)-(active[b]??0)),available[0]}function loadSlot(index){const raw=localStorage.getItem(SLOT_KEY(index));if(!raw)return null;const data=JSON.parse(raw);if(!Array.isArray(data))return data;const[version,name,created,playerTeamId,season,round,salaryCap,teamArr,scheduleArr,resultsArr,finalsArr,freeAgentsArr,pendingLevelUpsArr]=data,teams2=teamArr.map(arrayToCareerTeam),teamById=new Map(teams2.map(t=>[t.id,t])),resolveTeam=teamId=>{const team=teamById.get(teamId);if(!team)throw new Error(`Unknown team id ${teamId} while loading career slot`);return team},schedule=scheduleArr.map(r2=>r2.map(m=>new CareerMatch({home:resolveTeam(m[0]),away:resolveTeam(m[1])}))),results=resultsArr.map(r2=>r2.map(m=>new CareerMatchResult({home:resolveTeam(m[0]),away:resolveTeam(m[1]),homeScore:m[2],awayScore:m[3],homeGoals:m[4],homeBehinds:m[5],awayGoals:m[6],awayBehinds:m[7]})));let finals=[];if(finalsArr){const[scheduleRounds,resultsRounds]=finalsArr;finals=(scheduleRounds||[]).map((roundMatches,idx)=>{const matches=roundMatches.map(m=>new CareerMatch({home:resolveTeam(m[0]),away:resolveTeam(m[1])})),roundResults=((resultsRounds||[])[idx]||[]).map(m=>new CareerMatchResult({home:resolveTeam(m[0]),away:resolveTeam(m[1]),homeScore:m[2],awayScore:m[3],homeGoals:m[4],homeBehinds:m[5],awayGoals:m[6],awayBehinds:m[7]}));return new CareerFinalsRound({name:finalsRoundNames[idx]??`Finals Round ${idx+1}`,matches,results:roundResults})})}const freeAgents=freeAgentsArr.map(arrayToPlayerStats),pendingLevelUps=Array.isArray(pendingLevelUpsArr)?pendingLevelUpsArr.map(entry=>{if(!Array.isArray(entry)||entry.length<2)return null;const[teamId,playerIndex]=entry,team=teamById.get(teamId),player=team==null?void 0:team.roster[playerIndex];return!team||!player?null:{teamId,playerIndex,player}}).filter(entry=>entry!==null):[];return new Career({name,created,teams:teams2,playerTeamId,season,round,salaryCap,schedule,results,finals,freeAgents,version,pendingLevelUps})}function arrayToCareerTeam(arr){return new CareerTeam({id:arr[0],name:arr[1],abbrev:arr[2],offense:arr[3],defense:arr[4],roster:Array.isArray(arr[5])?arr[5].map(arrayToPlayerStats):[]})}function playerStatsToArray(obj){return[obj.position,obj.name,obj.age,obj.playerCondition,obj.careerHealth,obj.salary,obj.complexion,obj.faceId,obj.energy,obj.weight,obj.strength,obj.speed,obj.height,obj.jump,obj.kickRange,obj.handpassRange,obj.agility,obj.fitness,obj.morale,obj.contractLength,obj.contractAmount,obj.games,obj.experience,obj.level,obj.activeBuffs,obj.maxLevel]}function arrayToPlayerStats(arr){const obj=new PlayerStats(arr[0]);return[obj.position,obj.name,obj.age,obj.playerCondition,obj.careerHealth,obj.salary,obj.complexion,obj.faceId,obj.energy,obj.weight,obj.strength,obj.speed,obj.height,obj.jump,obj.kickRange,obj.handpassRange,obj.agility,obj.fitness,obj.morale,obj.contractLength,obj.contractAmount,obj.games,obj.experience,obj.level,obj.activeBuffs,obj.maxLevel]=arr,obj}function saveSlot(index,data){const teams2=data.teams.map(t=>[t.id,t.name,t.abbrev,t.offense,t.defense,t.roster.map(playerStatsToArray)]),schedule=data.schedule.map(r2=>r2.map(m=>[m.home.id,m.away.id])),results=data.results.map(r2=>r2.map(m=>[m.home.id,m.away.id,m.homeScore,m.awayScore,m.homeGoals,m.homeBehinds,m.awayGoals,m.awayBehinds])),finals=data.finals.length?[data.finals.map(r2=>r2.matches.map(m=>[m.home.id,m.away.id])),data.finals.map(r2=>r2.results.map(m=>[m.home.id,m.away.id,m.homeScore,m.awayScore,m.homeGoals,m.homeBehinds,m.awayGoals,m.awayBehinds]))]:null,freeAgents=data.freeAgents.map(p=>[p.position,p.name,p.age,p.playerCondition,p.careerHealth,p.contractLength,p.contractAmount,p.complexion,p.faceId,p.energy,p.weight,p.strength,p.speed,p.height,p.jump,p.kickRange,p.handpassRange,p.agility,p.fitness,p.morale,p.games,p.experience,p.level,p.activeBuffs,p.maxLevel]),pendingLevelUps=(data.pendingLevelUps||[]).map(entry=>{const team=data.teams.find(t=>t.id===entry.teamId);if(!team)return null;const index2=team.roster.indexOf(entry.player??team.roster[entry.playerIndex]);return index2<0?null:[entry.teamId,index2]}).filter(entry=>Array.isArray(entry)),stored=[data.version,data.name,data.created,data.playerTeamId,data.season,data.round,data.salaryCap,teams2,schedule,results,finals,freeAgents,pendingLevelUps];localStorage.setItem(SLOT_KEY(index),JSON.stringify(stored))}function handleLevelUp(career,player,humanControlled,team=null){player.activeBuffs=player.activeBuffs||{};const rosterTeam=team||career.teams.find(t=>t.roster.includes(player))||null,playerIndex=rosterTeam?rosterTeam.roster.indexOf(player):-1;if(humanControlled){if(career.pendingLevelUps||(career.pendingLevelUps=[]),playerIndex===-1||!rosterTeam)return;const existing=career.pendingLevelUps.find(entry=>entry.teamId===rosterTeam.id&&entry.playerIndex===playerIndex);existing?existing.player=player:career.pendingLevelUps.push({teamId:rosterTeam.id,playerIndex,player});return}const buffId=chooseBuffForAI(player);if(!buffId)return;const newLevel=(player.activeBuffs[buffId]??0)+1;applyBuffToStats(player,buffId,newLevel)}function awardExperienceForTeam(career,team,games=1,humanControlled=!1){if(!(!team||!Array.isArray(team.roster))){for(const player of team.roster){const prevLevel=player.level??1;addExperienceToStats(player,games),(player.level??prevLevel)>prevLevel&&handleLevelUp(career,player,humanControlled,team)}career.pendingLevelUps&&(career.pendingLevelUps=career.pendingLevelUps.filter(entry=>entry&&entry.playerIndex>=0&&entry.player))}}function deleteSlot(index){localStorage.removeItem(SLOT_KEY(index))}function downloadSlot(index){const data=loadSlot(index);if(!data)return;const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"}),url=URL.createObjectURL(blob),a2=document.createElement("a");a2.href=url,a2.download=`career-slot-${index}.json`,a2.click(),URL.revokeObjectURL(url)}async function uploadSlot(index,file){const text=await file.text(),data=JSON.parse(text);Array.isArray(data)?localStorage.setItem(SLOT_KEY(index),text):saveSlot(index,data)}function applyAging(career){const changes=new Map;for(const team of career.teams)for(const p of team.roster)changes.set(p,updateAging(p));for(const p of career.freeAgents||[])updateAging(p);return changes}function buildScheduleFromFixtures(fixtures,teamMap){return fixtures.map(r2=>r2.matches.map(m=>new CareerMatch({home:teamMap.get(m.home.id)??m.home,away:teamMap.get(m.away.id)??m.away})))}function createNewCareer(index){const teams2=generateAllTeams().map(t=>new CareerTeam({id:t.id,name:t.name,abbrev:t.abbrev,offense:t.offense,defense:t.defense,roster:t.roster??[]})),lowestRating=Math.min(...teams2.map(t=>t.rating)),worst=teams2.find(t=>t.rating<=lowestRating)??teams2[teams2.length-1],now=new Date,slotName=`${worst.abbrev} ${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`,fixtures=generateSeasonFixtures(teams2),teamById=new Map(teams2.map(t=>[t.id,t])),schedule=buildScheduleFromFixtures(fixtures,teamById),career=new Career({name:slotName,created:now.getTime(),teams:teams2,playerTeamId:worst.id,season:1,round:0,salaryCap:15e6,schedule,results:[],finals:[],freeAgents:[],version:1,pendingLevelUps:[]});return index<0?(simulateRegularSeasonInPlace(career),career.round=career.schedule.length-1,career):(saveSlot(index,career),career)}function computeLadder(career){const rankingMap=calculateTeamRankings(career.teams),table=career.teams.map(t=>{const summary=rankingMap.get(t.id);return{id:t.id,name:t.name,abbrev:t.abbrev,wins:0,losses:0,draws:0,pointsFor:0,pointsAgainst:0,rank:0,teamRating:(summary==null?void 0:summary.rating)??.5,baseRank:(summary==null?void 0:summary.rank)??Number.POSITIVE_INFINITY}});for(let r2=0;r2<career.round;r2++){const round=career.results[r2];if(round)for(const m of round){const home=table.find(t=>{var _a;return t.id===((_a=m.home)==null?void 0:_a.id)}),away=table.find(t=>{var _a;return t.id===((_a=m.away)==null?void 0:_a.id)});!home||!away||typeof m.homeScore!="number"||typeof m.awayScore!="number"||(home.pointsFor+=m.homeScore,home.pointsAgainst+=m.awayScore,away.pointsFor+=m.awayScore,away.pointsAgainst+=m.homeScore,m.homeScore>m.awayScore?(home.wins++,away.losses++):m.homeScore<m.awayScore?(away.wins++,home.losses++):(home.draws++,away.draws++))}}return table.sort((a2,b)=>{if(b.wins!==a2.wins)return b.wins-a2.wins;const diffA=a2.pointsFor-a2.pointsAgainst,diffB=b.pointsFor-b.pointsAgainst;return diffB!==diffA?diffB-diffA:a2.baseRank-b.baseRank}),table.forEach((t,i)=>{t.rank=i+1}),table.map(({baseRank,...rest})=>rest)}function startNewSeason(career){career.schedule=buildScheduleFromFixtures(generateSeasonFixtures(career.teams),new Map(career.teams.map(t=>[t.id,t]))),career.results=[],career.round=0,career.finals=[],career.season+=1}const finalsRoundNames=["Qualifying and elimination finals","Semi-finals","Preliminary finals","Grand final"];function ratePlayer(p){return ratingToStars(calculatePlayerRating(p))}const POSITION_SEQUENCE=Object.freeze(Object.keys(generateFieldPositions())),SALARY_CAP=15e6,BENCH_PREFIX="Bench",KEY_POSITIONS=new Set(["FF","FB","CHF","CHB","Ruck"]),KEY_POSITION_REQUIREMENTS=Object.freeze({default:{height:1.9,weight:88},Ruck:{height:1.95,weight:92}}),LINE_GROUPS=Object.freeze({Forward:["LFP","FF","RFP"],HalfForward:["LHF","CHF","RHF"],Centre:["LW","C","RW"],HalfBack:["LHB","CHB","RHB"],Back:["LBP","FB","RBP"],Midfield:["Ruck","RR","Rover"]}),LINE_NAMES=Object.freeze(Object.keys(LINE_GROUPS)),LINE_IMPROVEMENT_THRESHOLD=4,LINE_SURPLUS_TOLERANCE=6,LINE_CANDIDATE_COUNT=2,SALARY_BUFFER_MIN=2e5,SALARY_BUFFER_MAX=5e5,TEAM_PRESTIGE=Object.freeze({0:1.1,1:.98,2:1.05,3:.94,4:1.02,5:1.12,6:1,7:1.04,8:.96,9:.9,10:.91,11:.97,12:1.08,13:.92,14:.88,15:1.06,16:1.09,17:.9}),SALARY_FLOOR=8e4;function generateAllTeams(){const baseSeed=Date.now(),poolSeed=stringToSeed(`pool-${baseSeed}`),playerPool=generatePlayerPool(poolSeed,teamIds.length),draftSeed=stringToSeed(`draft-${baseSeed}`),{teamStates}=draftLeague(teamIds,playerPool,draftSeed);for(const state of teamStates)applySalaryDistribution(state,SALARY_CAP);runTradeSweep(teamStates);for(const state of teamStates)applySalaryDistribution(state,SALARY_CAP);return teamStates.map(state=>finalizeTeamState(state))}function createDraftState(teamId){return{id:teamId,prestige:TEAM_PRESTIGE[teamId]??1,players:[],positionMap:new Map,payroll:0,totalRating:0,salaryTarget:void 0,salaryBuffer:void 0}}function draftLeague(teamIds2,playerPool,seed){setPRNG("mulberry32"),setSeed(seed);const teamStates=teamIds2.map(id=>createDraftState(id)),prestigeValues=teamStates.map(t=>t.prestige),minPrestige=Math.min(...prestigeValues),maxPrestige=Math.max(...prestigeValues);let positionIndex=0;for(const position of POSITION_SEQUENCE){const available=playerPool[position]?playerPool[position].slice():[];if(available.length<teamStates.length)throw new Error(`Insufficient players generated for position ${position}`);const baseOrder=buildDraftOrder(teamStates,minPrestige,maxPrestige),order=positionIndex++%2===1?baseOrder.slice().reverse():baseOrder;for(const team of order){const prestigeNorm=normalizePrestige(team.prestige,minPrestige,maxPrestige),pickIndex=selectPlayerIndex(available,prestigeNorm),[player]=available.splice(pickIndex,1);player.position=position,team.players.push(player),team.positionMap.set(position,player)}}return{teamStates,minPrestige,maxPrestige}}function normalizePrestige(value,min,max){return!isFinite(min)||!isFinite(max)||Math.abs(max-min)<1e-5?.5:(value-min)/(max-min)}function buildDraftOrder(teamStates,minPrestige,maxPrestige){const remaining=teamStates.slice(),order=[];for(;remaining.length;){const weights=remaining.map(team=>draftWeight(team,minPrestige,maxPrestige)),totalWeight=weights.reduce((sum,w)=>sum+w,0);let roll=Math.random()*(totalWeight||1),pickedIndex=remaining.length-1;for(let i=0;i<remaining.length;i++)if(roll-=weights[i],roll<=0){pickedIndex=i;break}order.push(remaining[pickedIndex]),remaining.splice(pickedIndex,1)}return order}function draftWeight(team,minPrestige,maxPrestige){const base=.35+normalizePrestige(team.prestige,minPrestige,maxPrestige)*.65;return Math.max(.05,base*base)}function selectPlayerIndex(available,prestigeNorm){if(available.length<=1)return 0;const limit=Math.min(available.length,6),temperature=.35+(1-prestigeNorm)*.65;let bestIdx=0,bestScore=-1/0;for(let idx=0;idx<limit;idx++){const player=available[idx],weight=Math.exp(-idx/Math.max(.1,temperature*limit)),score=player.rating*weight+Math.random()*5;score>bestScore&&(bestScore=score,bestIdx=idx)}return bestIdx}function applySalaryDistribution(team,salaryCap){if(!team.players.length){team.payroll=0,team.totalRating=0;return}if(typeof team.salaryTarget!="number"||team.salaryTarget<=0){const buffer=computeSalaryBuffer(team.id),baseSpend2=SALARY_FLOOR*team.players.length,target=Math.max(baseSpend2,salaryCap-buffer);team.salaryBuffer=buffer,team.salaryTarget=Math.min(salaryCap,target)}const targetPayroll=Math.min(salaryCap,team.salaryTarget??salaryCap),baseSpend=SALARY_FLOOR*team.players.length,remaining=Math.max(0,targetPayroll-baseSpend),weights=team.players.map(p=>Math.max(1,p.rating-400)),weightTotal=weights.reduce((sum,w)=>sum+w,0);team.players.forEach((player,idx)=>{let salary=SALARY_FLOOR;remaining>0&&weightTotal>0&&(salary+=remaining*(weights[idx]/weightTotal)),salary=Math.round(salary/1e3)*1e3,salary<SALARY_FLOOR&&(salary=SALARY_FLOOR),player.contractAmount=salary,player.salary=salary});let diff=team.players.reduce((sum,p)=>sum+(p.contractAmount??0),0)-targetPayroll;if(diff>0){const sorted=team.players.slice().sort((a2,b)=>(b.contractAmount??0)-(a2.contractAmount??0));for(const player of sorted){if(diff<=0)break;const reducible=Math.max(0,(player.contractAmount??0)-SALARY_FLOOR),delta=Math.min(reducible,diff);player.contractAmount-=delta,player.salary=player.contractAmount,diff-=delta}}else if(diff<0){let shortage=-diff;const sorted=team.players.slice().sort((a2,b)=>b.rating-a2.rating);for(;shortage>0&&sorted.length;)for(const player of sorted){if(shortage<=0)break;const delta=Math.min(shortage,1e3);player.contractAmount+=delta,player.salary=player.contractAmount,shortage-=delta}}team.payroll=team.players.reduce((sum,p)=>sum+(p.contractAmount??0),0),team.totalRating=team.players.reduce((sum,p)=>sum+p.rating,0)}function evaluatePlayer(stats){const rating=calculatePlayerRating(stats),star=typeof stats.starTier=="number"?stats.starTier:ratingToStars(rating);return{star:Number.isFinite(star)?star:0,rating:Number.isFinite(rating)?rating:0}}function canFillPosition(position,stats){if(!(position in KEY_POSITION_REQUIREMENTS))return!0;const requirements=KEY_POSITION_REQUIREMENTS[position]??KEY_POSITION_REQUIREMENTS.default;return requirements?"height"in stats&&"weight"in stats?stats.height>=requirements.height&&stats.weight>=requirements.weight:stats.statsHeight>=requirements.height&&stats.statsWeight>=requirements.weight:!0}function rebalanceBenchPlayers(state){const benchPositions=POSITION_SEQUENCE.filter(pos=>pos.startsWith(BENCH_PREFIX));if(benchPositions.length===0)return;const fieldPositions=POSITION_SEQUENCE.filter(pos=>!pos.startsWith(BENCH_PREFIX)),locked=new Set;let swapped=!0,iterations=0;const iterationLimit=benchPositions.length*fieldPositions.length+5,midfieldPositions=new Set(["RR","Rover","C"]),priorityFor=position=>KEY_POSITIONS.has(position)?0:midfieldPositions.has(position)?1:2;for(;swapped&&iterations<iterationLimit;){swapped=!1,iterations+=1;const benchEntries=benchPositions.map(pos=>{const stats=state.positionMap.get(pos);if(!stats)return null;const{star,rating}=evaluatePlayer(stats);return{pos,stats,star,rating}}).filter(entry=>entry!==null).sort((a2,b)=>b.star-a2.star||b.rating-a2.rating),fieldEntries=fieldPositions.map(pos=>{const stats=state.positionMap.get(pos);if(!stats)return null;const{star,rating}=evaluatePlayer(stats);return{pos,stats,star,rating}}).filter(entry=>entry!==null).sort((a2,b)=>priorityFor(a2.pos)-priorityFor(b.pos)||a2.star-b.star||a2.rating-b.rating);if(!benchEntries.length||!fieldEntries.length)break;for(const bench of benchEntries){if(locked.has(bench.pos))continue;const target=fieldEntries.find(field=>bench.star-field.star<=1-1e-6?!1:canFillPosition(field.pos,bench.stats));if(!target){locked.add(bench.pos);continue}const benchStats=bench.stats,fieldStats=target.stats;state.positionMap.set(bench.pos,fieldStats),state.positionMap.set(target.pos,benchStats),benchStats&&typeof benchStats=="object"&&(benchStats.position=target.pos),fieldStats&&typeof fieldStats=="object"&&(fieldStats.position=bench.pos),swapped=!0,locked.clear();break}}}function finalizeTeamState(state){rebalanceBenchPlayers(state),generateFieldPositions();const roster=[];for(const position of POSITION_SEQUENCE){const stats=state.positionMap.get(position);stats&&roster.push(stats)}const rating=roster.reduce((a2,p)=>a2+ratePlayer(p),0)/roster.length,forwardPos=["LFP","FF","RFP","LHF","CHF","RHF"],backPos=["LBP","FB","RBP","LHB","CHB","RHB"],forwardPlayers=roster.filter(p=>forwardPos.includes(p.position)),backPlayers=roster.filter(p=>backPos.includes(p.position)),offense=forwardPlayers.reduce((a2,p)=>a2+ratePlayer(p),0)/forwardPlayers.length,defense=backPlayers.reduce((a2,p)=>a2+ratePlayer(p),0)/backPlayers.length,rosterData=roster;return{id:state.id,name:teams[state.id],abbrev:teamAbbrevs[state.id],rating,offense,defense,roster:rosterData}}function runTradeSweep(teamStates){for(let iteration=0;iteration<3;iteration++){let moved=!1;for(let i=0;i<teamStates.length;i++)for(let j=i+1;j<teamStates.length;j++){const teamA=teamStates[i],teamB=teamStates[j];for(;attemptComplementaryTrade(teamA,teamB);)moved=!0}if(!moved)break}}function attemptComplementaryTrade(team,other){const summaryA=analyzeLines(team),summaryB=analyzeLines(other),needCandidatesA=summaryA.sorted.slice(0,Math.min(LINE_CANDIDATE_COUNT,summaryA.sorted.length)),surplusCandidatesA=summaryA.sorted.slice(-Math.min(LINE_CANDIDATE_COUNT,summaryA.sorted.length)),needCandidatesB=summaryB.sorted.slice(0,Math.min(LINE_CANDIDATE_COUNT,summaryB.sorted.length)),surplusCandidatesB=summaryB.sorted.slice(-Math.min(LINE_CANDIDATE_COUNT,summaryB.sorted.length));for(const needLineA of needCandidatesA)for(const surplusLineB of surplusCandidatesB)if(needLineA===surplusLineB)for(const needLineB of needCandidatesB)for(const surplusLineA of surplusCandidatesA){if(needLineB!==surplusLineA||needLineA===surplusLineA||needLineB===surplusLineB)continue;const specA=buildLineSpec(summaryA,needLineA,surplusLineA),specB=buildLineSpec(summaryB,needLineB,surplusLineB);if(!(!specA||!specB)&&evaluateLineTrade(specA,specB))return executeLineTrade(team,specA,other,specB),!0}return!1}function computeSalaryBuffer(teamId){const normalized=(Math.sin((teamId+1)*43758.5453)+1)/2,span=SALARY_BUFFER_MAX-SALARY_BUFFER_MIN,buffer=SALARY_BUFFER_MIN+normalized*span;return Math.round(buffer/1e3)*1e3}function analyzeLines(team){const lines={};for(const line of LINE_NAMES){const entries=[];for(const position of LINE_GROUPS[line]){const player=team.positionMap.get(position);player&&entries.push({player,position})}const avg=entries.length?entries.reduce((sum,entry)=>sum+entry.player.rating,0)/entries.length:0;lines[line]={entries,avg}}const sorted=LINE_NAMES.slice().sort((a2,b)=>lines[a2].avg-lines[b].avg);return{lines,sorted}}function buildLineSpec(summary,needLine,surplusLine){const needData=summary.lines[needLine],surplusData=summary.lines[surplusLine];if(!needData||!surplusData||!needData.entries.length||!surplusData.entries.length)return null;const needSlot=selectWeakestEntry(needData.entries),surplusSlot=selectStrongestEntry(surplusData.entries);return!needSlot||!surplusSlot||needSlot===surplusSlot?null:{needLine,surplusLine,needSlot,surplusSlot,needEntries:needData.entries,surplusEntries:surplusData.entries,needAvg:needData.avg,surplusAvg:surplusData.avg}}function selectWeakestEntry(entries){return entries.reduce((worst,entry)=>worst&&worst.player.rating<=entry.player.rating?worst:entry,entries[0])}function selectStrongestEntry(entries){return entries.reduce((best,entry)=>best&&best.player.rating>=entry.player.rating?best:entry,entries[0])}function averageWithReplacement(entries,replacedEntry,newRating){return entries.length?(entries.reduce((sum,entry)=>sum+entry.player.rating,0)-replacedEntry.player.rating+newRating)/entries.length:0}function evaluateLineTrade(specA,specB){const incomingA=specB.surplusSlot.player,incomingB=specA.surplusSlot.player,newNeedAvgA=averageWithReplacement(specA.needEntries,specA.needSlot,incomingA.rating),newNeedAvgB=averageWithReplacement(specB.needEntries,specB.needSlot,incomingB.rating);if(newNeedAvgA-specA.needAvg<LINE_IMPROVEMENT_THRESHOLD||newNeedAvgB-specB.needAvg<LINE_IMPROVEMENT_THRESHOLD)return!1;const newSurplusAvgA=averageWithReplacement(specA.surplusEntries,specA.surplusSlot,specA.needSlot.player.rating),newSurplusAvgB=averageWithReplacement(specB.surplusEntries,specB.surplusSlot,specB.needSlot.player.rating);return!(specA.surplusAvg-newSurplusAvgA>LINE_SURPLUS_TOLERANCE||specB.surplusAvg-newSurplusAvgB>LINE_SURPLUS_TOLERANCE)}function executeLineTrade(teamA,specA,teamB,specB){const outgoingA=specA.surplusSlot.player,outgoingB=specB.surplusSlot.player,needPlayerA=specA.needSlot.player,needPlayerB=specB.needSlot.player,surplusIdxA=teamA.players.indexOf(outgoingA),needIdxA=teamA.players.indexOf(needPlayerA),surplusIdxB=teamB.players.indexOf(outgoingB),needIdxB=teamB.players.indexOf(needPlayerB);if(surplusIdxA<0||needIdxA<0||surplusIdxB<0||needIdxB<0)return;const surplusPosA=specA.surplusSlot.position,needPosA=specA.needSlot.position,surplusPosB=specB.surplusSlot.position,needPosB=specB.needSlot.position;teamA.players[surplusIdxA]=needPlayerA,needPlayerA.position=surplusPosA,teamA.positionMap.set(surplusPosA,needPlayerA),teamB.players[surplusIdxB]=needPlayerB,needPlayerB.position=surplusPosB,teamB.positionMap.set(surplusPosB,needPlayerB),teamA.players[needIdxA]=outgoingB,outgoingB.position=needPosA,teamA.positionMap.set(needPosA,outgoingB),teamB.players[needIdxB]=outgoingA,outgoingA.position=needPosB,teamB.positionMap.set(needPosB,outgoingA),teamA.payroll=teamA.players.reduce((sum,p)=>sum+(p.contractAmount??0),0),teamB.payroll=teamB.players.reduce((sum,p)=>sum+(p.contractAmount??0),0),teamA.totalRating=teamA.players.reduce((sum,p)=>sum+p.rating,0),teamB.totalRating=teamB.players.reduce((sum,p)=>sum+p.rating,0)}function generateSeasonFixtures(teamList){const teams2=teamList.slice(),n=teams2.length,rounds=[],rotate=teams2.slice(),fixed=rotate.shift(),baseRounds=n-1;for(let r2=0;r2<baseRounds;r2++){const lineup=[fixed,...rotate],matches=[];for(let i=0;i<n/2;i++)matches.push({home:lineup[i],away:lineup[n-1-i]});rounds.push(matches),rotate.push(rotate.shift())}const roundIndices=[...Array(baseRounds).keys()];shuffle(roundIndices);for(const idx of roundIndices.slice(0,6)){const matches=rounds[idx].map(m=>({home:m.home,away:m.away}));rounds.push(matches)}const maxAttempts=100;for(let attempt=0;attempt<maxAttempts;attempt++){const workingRounds=rounds.map(r2=>({matches:r2.map(m=>({home:m.home,away:m.away}))})),shuffled=teams2.slice();shuffle(shuffled);const pairs=[];for(let i=0;i<shuffled.length;i+=2)pairs.push([shuffled[i],shuffled[i+1]]);const usedRounds=new Set;let success=!0;for(const[a2,b]of pairs){let foundRound=-1,matchIndex=-1;for(let r2=0;r2<workingRounds.length;r2++){if(usedRounds.has(r2))continue;const idx=workingRounds[r2].matches.findIndex(m=>m.home===a2&&m.away===b||m.home===b&&m.away===a2);if(idx>=0){foundRound=r2,matchIndex=idx;break}}if(foundRound===-1){success=!1;break}workingRounds[foundRound].matches.splice(matchIndex,1),usedRounds.add(foundRound)}if(success)return workingRounds}throw new Error("Unable to assign unique bye rounds")}function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}}const HOME_FIELD_RATING_BONUS=12/STAR_SCALE,DEFAULT_POSITION_FALLBACK=Math.max(.5,Math.min(5,ratingToStars(550))),FORWARD_MATCHUPS=Object.freeze([["LFP","RBP"],["FF","FB"],["RFP","LBP"],["LHF","RHB"],["CHF","CHB"],["RHF","LHB"]]),MIDFIELD_MATCHUPS=Object.freeze([["LW","RW"],["C","C"],["RW","LW"],["Ruck","Ruck"],["RR","RR"],["Rover","Rover"]]);function buildPositionRatings(team){const ratings=new Map;if(!team||!Array.isArray(team.roster))return{ratings,fallback:DEFAULT_POSITION_FALLBACK};let total=0,count=0;for(const player of team.roster){if(!player||typeof player!="object")continue;const pos=typeof player.position=="string"?player.position:"";if(!pos)continue;let rating=DEFAULT_POSITION_FALLBACK;try{const{star}=evaluatePlayer(player);rating=Math.max(.5,Math.min(5,star))}catch{rating=DEFAULT_POSITION_FALLBACK}!Number.isFinite(rating)||rating<=0||(ratings.set(pos,rating),total+=rating,count+=1)}const fallback=count>0?total/count:DEFAULT_POSITION_FALLBACK;return{ratings,fallback}}function ratingForPosition(cache,position){const value=cache.ratings.get(position);return typeof value=="number"&&Number.isFinite(value)&&value>0?value:cache.fallback}function resolveMatchups(offense,defense,matchups,role,ratingBonus){let goals2=0,behinds=0;const baseShots=role==="forward"?1.8:.9,diffScale=role==="forward"?35/STAR_SCALE:45/STAR_SCALE,goalBase=role==="forward"?.57:.42,goalDiffFactor=.0012*STAR_SCALE;for(const[attackPos,defendPos]of matchups){const attackRating=ratingForPosition(offense,attackPos)+ratingBonus,defendRating=ratingForPosition(defense,defendPos),diff=attackRating-defendRating,expectedShots=baseShots+diff/diffScale,noise=(Math.random()-.5)*.6,rawShots=Math.max(0,expectedShots+noise),wholeShots=Math.floor(rawShots);let shots=wholeShots;const fractional=rawShots-wholeShots;if(Math.random()<fractional&&(shots+=1),shots<=0)continue;const goalProb=Math.max(.2,Math.min(.85,goalBase+diff*goalDiffFactor));for(let i=0;i<shots;i+=1)Math.random()<goalProb?goals2+=1:behinds+=1}return{goals:goals2,behinds}}function simulateMatch(home,away){const homeRatings=buildPositionRatings(home),awayRatings=buildPositionRatings(away),homeForward=resolveMatchups(homeRatings,awayRatings,FORWARD_MATCHUPS,"forward",HOME_FIELD_RATING_BONUS),homeMidfield=resolveMatchups(homeRatings,awayRatings,MIDFIELD_MATCHUPS,"midfield",HOME_FIELD_RATING_BONUS/2),awayForward=resolveMatchups(awayRatings,homeRatings,FORWARD_MATCHUPS,"forward",0),awayMidfield=resolveMatchups(awayRatings,homeRatings,MIDFIELD_MATCHUPS,"midfield",0),homeGoals=homeForward.goals+homeMidfield.goals,homeBehinds=homeForward.behinds+homeMidfield.behinds,awayGoals=awayForward.goals+awayMidfield.goals,awayBehinds=awayForward.behinds+awayMidfield.behinds,homeScore=homeGoals*6+homeBehinds,awayScore=awayGoals*6+awayBehinds;return{homeGoals,homeBehinds,homeScore,awayGoals,awayBehinds,awayScore}}function simulateRegularSeasonInPlace(career){career.results=career.schedule.map(round=>round.map(m=>new CareerMatchResult({home:m.home,away:m.away,...simulateMatch(m.home,m.away)})))}function advanceTournament(career,ladder){const roundIndex=career.currentFinalsRound,rankById=new Map(ladder.map(t=>[t.id,t.rank])),bySeed=(a2,b)=>(rankById.get(a2.id)??999)-(rankById.get(b.id)??999),matchWinner=m=>m.homeScore>m.awayScore?m.home:m.away,matchLoser=m=>m.homeScore>m.awayScore?m.away:m.home,next=[];if(roundIndex===0)next.push(new CareerMatch({home:career.teams[ladder[0].id],away:career.teams[ladder[3].id]}),new CareerMatch({home:career.teams[ladder[1].id],away:career.teams[ladder[2].id]}),new CareerMatch({home:career.teams[ladder[4].id],away:career.teams[ladder[7].id]}),new CareerMatch({home:career.teams[ladder[5].id],away:career.teams[ladder[6].id]}));else{const priorRound=career.finals[roundIndex-1],priorResult=priorRound==null?void 0:priorRound.results;if(roundIndex===1){const qf=priorResult.slice(0,2),ef=priorResult.slice(2,4),qfLosers=qf.map(matchLoser).sort(bySeed),efWinners=ef.map(matchWinner).sort(bySeed);next.push(new CareerMatch({home:qfLosers[0],away:efWinners[efWinners.length-1]}),new CareerMatch({home:qfLosers[1],away:efWinners[0]}))}else if(roundIndex===2){const qfWinners=career.finals[0].results.slice(0,2).map(matchWinner).sort(bySeed),semiWinners=priorResult.map(matchWinner).sort(bySeed);next.push(new CareerMatch({home:qfWinners[0],away:semiWinners[semiWinners.length-1]}),new CareerMatch({home:qfWinners[1],away:semiWinners[0]}))}else if(roundIndex===3){const prelimWinners=priorResult.map(matchWinner);next.push(new CareerMatch({home:prelimWinners[0],away:prelimWinners[1]}))}else return!1}return career.finals[roundIndex]={name:career.getFinalsRoundName(roundIndex),matches:next,results:[]},!0}class FPS extends Label{constructor(){super(...arguments);__publicField(this,"_counter",0);__publicField(this,"_frames",0);__publicField(this,"_worst",300);__publicField(this,"_tref",Date.now());__publicField(this,"_badFrameCount",0)}update(app,millis){super.update(app,millis);const tref=app.now;this._counter+=tref-this._tref,this._frames+=1;const currentFPS=1e3/(tref-this._tref);this._tref=tref,this._badFrameCount+=currentFPS<50?1:0,currentFPS<this._worst&&(this._worst=currentFPS),this._counter>=1e3&&(this.text=`FPS: ${Math.round(this._frames/this._counter*1e3)} (worst: ${Math.round(this._worst)}, # >20ms: ${Math.round(this._badFrameCount)})`,this._counter=0,this._frames=0,this._worst=300,this._badFrameCount=0)}}class MenuButton extends BoxLayout{on_touch_down(event,object,touch){return this.collide(touch.rect)?(touch.grab(this),this.bgColor="rgba(128,128,128,0.5)",!0):!1}on_touch_up(event,object,touch){return touch.grabbed===this?(touch.ungrab(),this.bgColor=null,this.collide(touch.rect)&&(Game.get().baseWidget.addChild(PauseMenu.a(PauseMenu.props)),Game.get().gameActive=!1),!0):!1}}function stars(value,scale2,zero=0){const raw=(value-zero)/scale2,clamped=Number.isFinite(raw)?Math.max(0,Math.min(5,raw)):0;let halfSteps=Math.round(clamped*2),result="";for(let i=0;i<5;i+=1)halfSteps>=2?(result+="★",halfSteps-=2):halfSteps===1?(result+="⯨",halfSteps-=1):result+="_";return result}function buffIcons(level,max=3){return"⬢".repeat(level).padEnd(max,"⬡")}class InGameBanner extends Widget{constructor(){super(),this.game=Game.get(),this.labels={timer:Label.a({text:"20:00",align:"left",color:"white",sizeGroup:"bannerText"}),quarter:Label.a({text:"Q1",align:"left",color:"white",sizeGroup:"bannerText"}),home:Label.a({text:"H 0.0 (0)",align:"center",color:"white",sizeGroup:"bannerText"}),away:Label.a({text:"A 0.0 (0)",align:"center",color:"white",sizeGroup:"bannerText"}),commentary:Label.a({id:"commentary",wrap:!0,text:"",align:"center",hints:{center_x:.5,y:0,w:.4,h:"10"},alpha:1,timer:1e3,colorBase:[255,255,255]}).d("color",commentary=>`rgba(${commentary.colorBase[0]},${commentary.colorBase[1]},${commentary.colorBase[2]},${commentary.alpha})`).listen("text",(e,o,v)=>{if(v!==""){const wa=new WidgetAnimation;o.alpha=1,wa.add({alpha:1},o.timer),wa.add({alpha:0},1e3),wa.start(o)}})},this.menuButton=MenuButton.a({hints:{w:1,h:1}}),this.centerWidget=BoxLayout.a({orientation:"vertical",hints:{w:.5}}),this.centerWidget.children=[this.menuButton],this.topRow=BoxLayout.a({orientation:"horizontal",spacingX:.02,hints:{x:0,y:0,w:1,h:"8"},bgColor:"#0004"}),this.topRow.children=[this.labels.quarter,this.labels.timer,this.centerWidget,this.labels.home,this.labels.away],this.children=[this.topRow,this.labels.commentary],this.homeName="A",this.awayName="B",this.homeGoal=0,this.homeBehind=0,this.awayGoal=0,this.awayBehind=0,this.quarter=0,this.timeLeft=0,this.updateHome(),this.updateAway(),this.updateTimer(),this.updateLayout()}commentary(text,team=null,time=1e3){this.labels.commentary.timer=time,this.labels.commentary.text=text}updateLayout(){this.game.aspectRatio>1?(this.centerWidget.hints.w=.4,this.labels.commentary.hints={center_x:.5,y:0,w:.4,h:"10"}):(this.centerWidget.hints.w=.1,this.labels.commentary.hints={center_x:.5,y:"8",w:1,h:"10"}),this._needsLayout=!0}on_homeName(event,object,value){this.updateHome()}on_awayName(event,object,value){this.updateAway()}on_homeGoal(event,obj,value){this.updateHome()}on_homeBehind(event,obj,value){this.updateHome()}on_awayGoal(event,obj,value){this.updateAway()}on_awayBehind(event,obj,value){this.updateAway()}on_timeLeft(_,__,value){this.updateTimer()}on_quarter(_,__,value){this.updateTimer()}updateHome(){this.labels.home.text=`${this.homeName} ${this.homeGoal}.${this.homeBehind} (${this.homeGoal*6+this.homeBehind})`}updateAway(){this.labels.away.text=`${this.awayName} ${this.awayGoal}.${this.awayBehind} (${this.awayGoal*6+this.awayBehind})`}updateTimer(){const min=Math.floor(this.timeLeft/60).toString().padStart(2,"0"),sec=Math.floor(this.timeLeft%60).toString().padStart(2,"0");this.labels.timer.text=`${min}:${sec}`,this.labels.quarter.text=`Q${this.quarter}`}resetScores(){this.homeGoal=0,this.homeBehind=0,this.awayGoal=0,this.awayBehind=0}getData(){return{home:{g:this.homeGoal,b:this.homeBehind,t:this.homeGoal*6+this.homeBehind},away:{g:this.awayGoal,b:this.awayBehind,t:this.awayGoal*6+this.awayBehind}}}update(app,millis){super.update(app,millis),app.now}}__publicField(InGameBanner,"props",Object.freeze({orientation:"vertical",hints:{x:0,y:0,w:1,h:"8"}}));class ScoreBoard extends BoxLayout{constructor(){super(),this.game=Game.get(),this.labels={homeName:Label.a({text:"0",align:"left",color:"white",sizeGroup:"scoreBaord",hints:{h:"8"}}),homeGoals:Label.a({text:"0",align:"center",color:"white",sizeGroup:"scoreBaord",hints:{h:"8"}}),homeBehinds:Label.a({text:"0",align:"center",color:"white",sizeGroup:"scoreBaord",hints:{h:"8"}}),homeTotal:Label.a({text:"0",align:"center",color:"white",sizeGroup:"scoreBaord",hints:{h:"8"}}),awayName:Label.a({text:"0",align:"left",color:"white",sizeGroup:"scoreBaord",hints:{h:"8"}}),awayGoals:Label.a({text:"0",align:"center",color:"white",sizeGroup:"scoreBaord",hints:{h:"8"}}),awayBehinds:Label.a({text:"0",align:"center",color:"white",sizeGroup:"scoreBaord",hints:{h:"8"}}),awayTotal:Label.a({text:"0",align:"center",color:"white",sizeGroup:"scoreBaord",hints:{h:"8"}})};const grid=GridLayout.a({numX:4});grid.children=[Label.a({text:"",align:"left",color:"white",sizeGroup:"scoreBoard",hints:{h:"8"}}),Label.a({text:"G",align:"center",color:"white",sizeGroup:"scoreBoard",hints:{h:"8"}}),Label.a({text:"B",align:"center",color:"white",sizeGroup:"scoreBoard",hints:{h:"8"}}),Label.a({text:"T",align:"center",color:"white",sizeGroup:"scoreBoard",hints:{h:"8"}}),this.labels.homeName,this.labels.homeGoals,this.labels.homeBehinds,this.labels.homeTotal,this.labels.awayName,this.labels.awayGoals,this.labels.awayBehinds,this.labels.awayTotal],this.children=[grid],this.homeName="A",this.awayName="B",this.homeGoal=0,this.homeBehind=0,this.awayGoal=0,this.awayBehind=0}on_homeName(event,object,value){this.labels.homeName.text=value}on_awayName(event,object,value){this.labels.awayName.text=value}on_homeGoal(event,obj,value){this.labels.homeGoals.text=value.toString(),this.labels.homeTotal.text=(value*6+this.homeBehind).toString()}on_homeBehind(event,obj,value){this.labels.homeBehinds.text=value.toString(),this.labels.homeTotal.text=(this.homeGoal*6+value).toString()}on_awayGoal(event,obj,value){this.labels.awayGoals.text=value.toString(),this.labels.awayTotal.text=(value*6+this.awayBehind).toString()}on_awayBehind(event,obj,value){this.labels.awayBehinds.text=value.toString(),this.labels.awayTotal.text=(this.awayGoal*6+value).toString()}resetScores(){this.homeGoal=0,this.homeBehind=0,this.awayGoal=0,this.awayBehind=0}getData(){return{home:{g:this.homeGoal,b:this.homeBehind,t:this.homeGoal*6+this.homeBehind},away:{g:this.awayGoal,b:this.awayBehind,t:this.awayGoal*6+this.awayBehind}}}populateFromBanner(banner){this.homeName=banner.homeName,this.awayName=banner.awayName,this.homeGoal=banner.homeGoal,this.homeBehind=banner.homeBehind,this.awayGoal=banner.awayGoal,this.awayBehind=banner.awayBehind}}__publicField(ScoreBoard,"props",Object.freeze({orientation:"horizontal",hints:{w:.8,h:.5},bgColor:"#0008"}));class StatsTable extends BoxLayout{constructor(){super(),this.game=Game.get(),this.grid=GridLayout.a({numX:9,h:152,hints:{w:1}});const scroll=ScrollView.a({scrollH:!0,scrollW:!1,hints:{w:1,h:1}}).c(this.grid);this.children=[scroll],this.team="home"}populate(){var _a,_b;const cells=["Player","M","K","Hb","HO","Tk","Sh","G","B"].map(text=>Label.a({text,align:text==="Player"?"left":"center",color:"white",hints:{h:"6"},sizeGroup:"statsTable"})),rows=((_a=this.game.stats)==null?void 0:_a.getTeamPlayerStats(this.team))??[];for(const{player,stats}of rows)cells.push(Label.a({text:`${player.name.split(" ").at(-1)} (${player.position})`,align:"left",color:"white",hints:{h:"6",w:.25},sizeGroup:"statsTable"})),cells.push(Label.a({text:stats.marks.toString(),align:"center",color:"white",hints:{h:"6"},sizeGroup:"statsTable"})),cells.push(Label.a({text:stats.kicks.toString(),align:"center",color:"white",hints:{h:"6"},sizeGroup:"statsTable"})),cells.push(Label.a({text:stats.handpasses.toString(),align:"center",color:"white",hints:{h:"6"},sizeGroup:"statsTable"})),cells.push(Label.a({text:stats.ruckTaps.toString(),align:"center",color:"white",hints:{h:"6"},sizeGroup:"statsTable"})),cells.push(Label.a({text:stats.tackles.toString(),align:"center",color:"white",hints:{h:"6"},sizeGroup:"statsTable"})),cells.push(Label.a({text:stats.shepherds.toString(),align:"center",color:"white",hints:{h:"6"},sizeGroup:"statsTable"})),cells.push(Label.a({text:stats.goals.toString(),align:"center",color:"white",hints:{h:"6"},sizeGroup:"statsTable"})),cells.push(Label.a({text:stats.behinds.toString(),align:"center",color:"white",hints:{h:"6"},sizeGroup:"statsTable"}));const totals=(_b=this.game.stats)==null?void 0:_b.getTeamTotals(this.team);totals&&(cells.push(Label.a({text:"Total",align:"left",color:"yellow",hints:{h:"6",w:.25},sizeGroup:"statsTable"})),cells.push(Label.a({text:totals.marks.toString(),align:"center",color:"yellow",hints:{h:"6"},sizeGroup:"statsTable"})),cells.push(Label.a({text:totals.kicks.toString(),align:"center",color:"yellow",hints:{h:"6"},sizeGroup:"statsTable"})),cells.push(Label.a({text:totals.handpasses.toString(),align:"center",color:"yellow",hints:{h:"6"},sizeGroup:"statsTable"})),cells.push(Label.a({text:totals.ruckTaps.toString(),align:"center",color:"yellow",hints:{h:"6"},sizeGroup:"statsTable"})),cells.push(Label.a({text:totals.tackles.toString(),align:"center",color:"yellow",hints:{h:"6"},sizeGroup:"statsTable"})),cells.push(Label.a({text:totals.shepherds.toString(),align:"center",color:"yellow",hints:{h:"6"},sizeGroup:"statsTable"})),cells.push(Label.a({text:totals.goals.toString(),align:"center",color:"yellow",hints:{h:"6"},sizeGroup:"statsTable"})),cells.push(Label.a({text:totals.behinds.toString(),align:"center",color:"yellow",hints:{h:"6"},sizeGroup:"statsTable"}))),this.grid.children=cells}on_team(event,obj,value){this.populate()}}__publicField(StatsTable,"props",Object.freeze({orientation:"vertical",hints:{w:1,h:1},bgColor:"#0008"}));class PlayerStatsTable extends BoxLayout{constructor(){super(),this.game=Game.get(),this.grid=GridLayout.a({numX:7,hints:{h:null},spacingX:.05});const scroll=ScrollView.a({scrollH:!0,scrollW:!1,hints:{w:1,h:1}}).c(this.grid);this.children=[scroll],this.team="home",this.populate()}populate(){const cells=["Player","Kick","Hgt","Wgt","Jmp","Str","Rating"].map(text=>Label.a({text,align:text==="Player"?"left":"center",color:"white",hints:{h:"6"},sizeGroup:"playerStat"})),players=this.game.players.filter(p=>p.team===this.team);for(const p of players)cells.push(Label.a({sizeGroup:"playerStat",text:`${p.name.split(" ").at(-1)} (${p.position})`,align:"left",color:"white",hints:{h:"6",w:.25}})),cells.push(Label.a({sizeGroup:"playerStat",text:Math.round(p.statsKickRange).toString(),align:"center",color:"white",hints:{h:"6"}})),cells.push(Label.a({sizeGroup:"playerStat",text:Math.round(p.statsHeight*100).toString(),align:"center",color:"white",hints:{h:"6"}})),cells.push(Label.a({sizeGroup:"playerStat",text:Math.round(p.statsWeight).toString(),align:"center",color:"white",hints:{h:"6"}})),cells.push(Label.a({sizeGroup:"playerStat",text:Math.round(p.statsJump).toString(),align:"center",color:"white",hints:{h:"6"}})),cells.push(Label.a({sizeGroup:"playerStat",text:Math.round(p.statsStrength).toString(),align:"center",color:"white",hints:{h:"6"}})),cells.push(Label.a({sizeGroup:"playerStat",text:stars(PlayerStats.rating(p),STAR_SCALE,STAR_ZERO),align:"center",color:"white",hints:{h:"6"}}));this.grid.children=cells}on_team(e,o,v){this.populate()}}__publicField(PlayerStatsTable,"props",Object.freeze({orientation:"vertical",hints:{w:1,h:1},bgColor:"#0008"}));class PauseMenu extends BoxLayout{constructor(){super(),this.game=Game.get(),this.game.gameActive=!1,this.viewButtons=BoxLayout.a({orientation:"horizontal",hints:{w:.9,h:"8"},spacingX:.02}),this.contentBox=BoxLayout.a({orientation:"vertical",hints:{w:.9,h:"36"}}),this.viewButtons.children=[ToggleButton.a({group:"team",text:this.game.banner.homeName,hints:{h:"8"},press:!0}).listen("press",()=>this.showStats("home")),ToggleButton.a({group:"team",text:this.game.banner.awayName,hints:{h:"8"}}).listen("press",()=>this.showStats("away"))],this.contentBox.children=[PlayerStatsTable.a({team:"home"})],this.children=[Label.a({text:"Pie Break",color:"rgba(192, 50, 50, 1)",hints:{h:"18"}}),this.viewButtons,this.contentBox,Button.a({text:"Continue",sizeGroup:"menuButton",hints:{w:.8,h:"8"}}).listen("press",()=>this.continue()),Button.a({text:"Exit to menu",sizeGroup:"menuButton",hints:{w:.8,h:"8"}}).listen("press",()=>this.exitToMenu())]}continue(){this.parent&&(this.game.gameActive=!0,this.parent.removeChild(this))}exitToMenu(){this.parent&&this.game.endGame(!1,!0)}showStats(team){this.contentBox.children=[PlayerStatsTable.a({team})]}}__publicField(PauseMenu,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{center_x:.5,center_y:.5,w:.6,h:null},bgColor:"rgba(0,0,0,0.65)",outlineColor:"rgba(255,255,255,1)"}));class EndQuarterMenu extends BoxLayout{constructor(){super(),this.game=Game.get(),this.game.gameActive=!1,this.game.scoreBoard.hints={w:.9,h:"24"},this.game.scoreBoard.populateFromBanner(this.game.banner);const q=this.game.banner.quarter,text=`End of ${["1st","2nd","3rd","Game"][q-1]??"Game"}${q<4?" Quarter":""}`,buttonText=q<4?"Next Quarter":"Exit Game";this.viewButtons=BoxLayout.a({orientation:"horizontal",hints:{w:.9,h:"8"},spacingX:.02}),this.contentBox=BoxLayout.a({orientation:"vertical",hints:{w:.9,h:"36"}}),this.contentBox.children=[this.game.scoreBoard],this.viewButtons.children=[ToggleButton.a({group:"info",text:"Score",hints:{h:"6"},press:!0}).listen("press",()=>this.showScore()),ToggleButton.a({group:"info",text:this.game.banner.homeName+" Stats",hints:{h:"6"},sizeGroup:"bannerButtons"}).listen("press",()=>this.showStats("home")),ToggleButton.a({group:"info",text:this.game.banner.awayName+" Stats",hints:{h:"6"},sizeGroup:"bannerButtons"}).listen("press",()=>this.showStats("away")),ToggleButton.a({group:"info",text:this.game.banner.homeName+" Roster",hints:{h:"6"},sizeGroup:"bannerButtons"}).listen("press",()=>this.showPlayerStats("home")),ToggleButton.a({group:"info",text:this.game.banner.awayName+" Roster",hints:{h:"6"},sizeGroup:"bannerButtons"}).listen("press",()=>this.showPlayerStats("away"))],this.children=[Label.a({text,color:"rgba(192, 50, 50, 1)",hints:{h:"18"}}),this.viewButtons,this.contentBox,Button.a({text:buttonText,sizeGroup:"menuButton",hints:{h:"8",w:.8}}).listen("press",()=>this.next())]}next(){this.parent&&(this.game.banner.quarter>=4?this.game.endGame():(this.parent.removeChild(this),this.game.banner.quarter+=1,this.game.banner.timeLeft=this.game.quarterTime,this.game.setPiece=new CenterBounceSetPiece(this.game),this.game.gameActive=!0))}showScore(){this.contentBox.children=[this.game.scoreBoard]}showStats(team){this.contentBox.children=[StatsTable.a({...StatsTable.props,team})],this._needsLayout=!0}showPlayerStats(team){this.contentBox.children=[PlayerStatsTable.a({...PlayerStatsTable.props,team})]}}__publicField(EndQuarterMenu,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.2,center_y:.5,w:.6,h:null},bgColor:"rgba(0,0,0,0.65)",outlineColor:"rgba(255,255,255,1)"}));class MainMenu extends BoxLayout{constructor(){super(),this.game=Game.get(),this.game.gameActive=!1,this.children=[Label.a({text:"The Footy",color:"rgba(192, 50, 50, 1)",hints:{h:"18"}}),Button.a({text:"Training",sizeGroup:"menuButton",hints:{w:.8,h:"8"}}).listen("press",()=>this.openTraining()),Button.a({text:"Quick Play",sizeGroup:"menuButton",hints:{w:.8,h:"8"}}).listen("press",()=>this.openQuickPlay()),Button.a({text:"Finals",sizeGroup:"menuButton",hints:{w:.8,h:"8"}}).listen("press",()=>this.openTournament()),Button.a({text:"Career",sizeGroup:"menuButton",hints:{w:.8,h:"8"}}).listen("press",()=>this.openCareer()),Button.a({text:"Options",sizeGroup:"menuButton",hints:{w:.8,h:"8"}}).listen("press",()=>this.openOptions())]}openTraining(){this.parent&&(this.parent.addChild(a(TrainingMenu,TrainingMenu.props)),this.parent.removeChild(this))}openQuickPlay(){this.parent&&(this.parent.addChild(a(QuickPlayMenu,QuickPlayMenu.props)),this.parent.removeChild(this))}openTournament(){this.parent&&(this.parent.addChild(a(TournamentSetup,TournamentSetup.props)),this.parent.removeChild(this))}openCareer(){this.parent&&(this.parent.addChild(a(CareerSlotMenu,CareerSlotMenu.props)),this.parent.removeChild(this))}openOptions(){this.parent&&(this.parent.addChild(a(OptionsMenu,OptionsMenu.props)),this.parent.removeChild(this))}}__publicField(MainMenu,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,center_y:.5,w:.4,h:null},bgColor:"rgba(0,0,0,0.65)",outlineColor:"rgba(255,255,255,1)"}));class TrainingMenu extends BoxLayout{constructor(){super(),this.game=Game.get();const[home,away]=this.game.randomMatchup();this.home=home,this.away=away,this.quarterTime=5,this.children=[Label.a({text:"Training",color:"rgba(192, 50, 50, 1)",hints:{h:"18"}}),Button.a({text:"Tutorial",sizeGroup:"menuButton",hints:{w:.8,h:"8"}}).listen("press",()=>this.startTutorial()),Button.a({text:"Kicking",sizeGroup:"menuButton",hints:{w:.8,h:"8"}}).listen("press",()=>this.startKicking()),Button.a({text:"Handpass",sizeGroup:"menuButton",hints:{w:.8,h:"8"}}).listen("press",()=>this.startHandpass()),Button.a({text:"Back",sizeGroup:"menuButton",hints:{w:.8,h:"8"}}).listen("press",()=>this.goBack())],this.updateProperties({})}startTutorial(){this.parent&&(this.game.gameActive=!0,this.parent.removeChild(this),this.game.banner.commentary("Welcome! Follow prompts to learn basics.",null,5e3),this.game.setupTraining(this.home,this.away,this.quarterTime,"tutorial"))}startKicking(){this.parent&&(this.game.gameActive=!0,this.parent.removeChild(this),this.game.banner.commentary(`HOLD K THEN W/A/S/D
TO AIM KICK DOWNFIELD`,null,5e3),this.game.setupTraining(this.home,this.away,this.quarterTime,"kicking"))}startHandpass(){this.parent&&(this.game.gameActive=!0,this.game.banner.commentary(`RUN WITH W/A/S/D
TAP J TO HANDPASS IN THAT DIR`,null,5e3),this.parent.removeChild(this),this.game.setupTraining(this.home,this.away,this.quarterTime,"handpass"))}goBack(){this.parent&&(this.parent.addChild(MainMenu.a(MainMenu.props)),this.parent.removeChild(this))}}__publicField(TrainingMenu,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,center_y:.5,w:.4,h:null},bgColor:"rgba(0,0,0,0.65)",outlineColor:"rgba(255,255,255,1)"}));class QuickPlayMenu extends BoxLayout{constructor(){super(),this.game=Game.get(),this.timeButton=Button.a({text:"Quarters:",sizeGroup:"menuButton",hints:{w:.8,h:"8"}}).listen("press",()=>this.nextQuarterTime()),this.homeButton=Button.a({text:"Home:",sizeGroup:"menuButton",hints:{w:.8,h:"8"}}).listen("press",()=>this.nextHomeTeam()),this.awayButton=Button.a({text:"Away:",sizeGroup:"menuButton",hints:{w:.8,h:"8"}}).listen("press",()=>this.nextAwayTeam());const[home,away]=this.game.randomMatchup();this.home=home,this.away=away,this.quarterTime=5,this.children=[Label.a({text:"Quick Play Setup",color:"rgba(192, 50, 50, 1)",hints:{h:"18"}}),this.timeButton,this.homeButton,this.awayButton,Button.a({text:"Randomize Matchup",sizeGroup:"menuButton",hints:{w:.8,h:"8"}}).listen("press",()=>this.randomizeMatchup()),Button.a({text:"Start Game",sizeGroup:"menuButton",hints:{w:.8,h:"8"}}).listen("press",()=>this.startGame()),Button.a({text:"Back",sizeGroup:"menuButton",hints:{w:.8,h:"8"}}).listen("press",()=>this.goBack())],this.updateProperties({})}randomizeMatchup(){[this.home,this.away]=this.game.randomMatchup()}nextHomeTeam(){this.home=(this.home+1)%18}nextAwayTeam(){this.away=(this.away+1)%18}nextQuarterTime(){this.quarterTime<=1?this.quarterTime=2:this.quarterTime<=2?this.quarterTime=5:this.quarterTime<=5?this.quarterTime=10:this.quarterTime<=10?this.quarterTime=20:this.quarterTime<=20&&(this.quarterTime=1)}on_home(e,o,v){this.homeButton.text="Home: "+teamAbbrevs[this.home]}on_away(e,o,v){this.awayButton.text="Away: "+teamAbbrevs[this.away]}on_quarterTime(e,o,v){this.timeButton.text="Quarters: "+this.quarterTime+" min."}startGame(){this.parent&&(this.game.gameActive=!0,this.parent.removeChild(this),this.game.setupGame(this.home,this.away,this.quarterTime))}goBack(){this.parent&&(this.parent.addChild(MainMenu.a(MainMenu.props)),this.parent.removeChild(this))}}__publicField(QuickPlayMenu,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,center_y:.5,w:.4,h:null},bgColor:"rgba(0,0,0,0.65)",outlineColor:"rgba(255,255,255,1)"}));class TournamentSetup extends BoxLayout{constructor(){super(),this.game=Game.get(),this.game.tournament=createNewCareer(-1);const t=this.game.tournament;t.advanceRound();const ladder=computeLadder(t);this.teamButtonBox=BoxLayout.a({orientation:"horizontal",hints:{h:"4",w:1},spacingX:"1",paddingX:"1"}).c(ladder.slice(8).map(tm=>Button.a({text:`${tm.abbrev}`}).listen("press",()=>this.chooseTeam(tm.id))));const ranking=ladder.map(tm=>tm.rank<=8?Button.a({text:`${tm.rank}. ${tm.abbrev} ${tm.wins}-${tm.losses}-${tm.draws}`,sizeGroup:"menuButton",hints:{w:.5,h:"6"}}).listen("press",()=>this.chooseTeam(tm.id)):Label.a({text:`${tm.rank}. ${tm.abbrev} ${tm.wins}-${tm.losses}-${tm.draws}`,sizeGroup:"menuButton",hints:{w:.5,h:"6"}}));this.rankingBox=BoxLayout.a({hints:{h:null,w:"20"}}).c(ranking),this.children=[Label.a({text:"Finals Play",color:"rgba(192, 50, 50, 1)",hints:{h:"18"}}),Label.a({text:"Season standings",hints:{h:"6"}}),ScrollView.a({scrollH:!0,scrollW:!1,outlineColor:"white"}).c(this.rankingBox),Label.a({text:"Select your finals team",hints:{h:"6"}}),Button.a({text:"Back",hints:{h:"8",w:.8}}).listen("press",()=>this.goBack())]}chooseTeam(teamId){if(this.game.tournament&&(this.game.tournament.playerTeamId=teamId,this.parent)){const parent=this.parent;this.parent.removeChild(this),parent.addChild(TournamentUpcoming.a(TournamentUpcoming.props))}}goBack(){this.parent&&(this.parent.addChild(MainMenu.a(MainMenu.props)),this.parent.removeChild(this))}}__publicField(TournamentSetup,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,y:.1,w:.4,h:.8},bgColor:"rgba(0,0,0,0.65)",outlineColor:"rgba(255,255,255,1)"}));class TournamentUpcoming extends BoxLayout{constructor(){super(),this.game=Game.get();const t=this.game.tournament;if(!t)return;const teamRanks=new Map(computeLadder(t).map(tm=>[tm.id,tm.rank])),matches=t.finals[t.finalsIndex].matches,playerId=t.playerTeamId?t.playerTeamId:null,matchLabels=matches.map(m=>{let text=`${teamRanks.get(m.home.id)}. ${m.home.abbrev} vs ${teamRanks.get(m.away.id)}. ${m.away.abbrev}`;return playerId!==null&&(m.home.id===playerId?text=`${teamRanks.get(m.home.id)}. [fg=yellow]${m.home.abbrev}[/] vs ${teamRanks.get(m.away.id)}. ${m.away.abbrev}`:m.away.id===playerId&&(text=`${teamRanks.get(m.home.id)}. ${m.home.abbrev} vs ${teamRanks.get(m.away.id)}. [fg=yellow]${m.away.abbrev}[/]`)),Label.a({text,hints:{h:"8"},richText:!0})}),playerMatchIndex=t.playerTeamId?matches.findIndex(m=>m.home.id===t.playerTeamId||m.away.id===t.playerTeamId):-1,actionButtons=BoxLayout.a({orientation:"horizontal",hints:{h:"8",w:.8},spacingX:"0.02w"}).c(Button.a({text:"Play",hints:{h:"8",w:.5},disable:playerMatchIndex===-1}).listen("press",()=>this.playMatch())).c(Button.a({text:"Simulate All",hints:{h:"8",w:.5}}).listen("press",()=>this.simulateRound()));this.children=[Label.a({text:finalsRoundNames[t.finalsIndex],color:"rgba(192, 50, 50, 1)",hints:{h:"18"}}),Label.a({text:"Schedule",hints:{h:"8"}}),...matchLabels,actionButtons,Button.a({text:"Back",hints:{h:"8",w:.8}}).listen("press",()=>this.goBack())],playerMatchIndex===-1&&setTimeout(()=>this.simulateRound(),0)}simulateRound(){const t=this.game.tournament;if(!t)return;if(!t.isFinals)throw Error("Tournament is not in final mode");const results=t.finals[t.finalsIndex].matches.map(m=>({...m,...simulateMatch(m.home,m.away)}));t.finals[t.finalsIndex].results=results,this.parent&&(this.parent.addChild(TournamentSummary.a(TournamentSummary.props)),this.parent.removeChild(this))}playMatch(){const t=this.game.tournament;if(!t||!t.isFinals)return;const matches=t.finals[t.finalsIndex].matches,playerTeamId=t.playerTeamId;if(!playerTeamId){this.simulateRound();return}const matchIndex=matches.findIndex(m=>m.home.id===playerTeamId||m.away.id===playerTeamId);if(matchIndex===-1){this.simulateRound();return}const results=matches.map(m=>new CareerMatchResult({home:m.home,away:m.away}));for(let i=0;i<matches.length;i++)i!==matchIndex&&Object.assign(results[i],simulateMatch(matches[i].home,matches[i].away));t.finals[t.finalsIndex].results=results;const match=matches[matchIndex],opponent=match.home.id===playerTeamId?match.away:match.home;this.game.tournamentGame={round:t.finalsIndex,matchIndex,playerIsHome:match.home.id===playerTeamId},this.game.setupGame(playerTeamId,opponent.id,5)}goBack(){this.parent&&(this.parent.addChild(MainMenu.a(MainMenu.props)),this.parent.removeChild(this))}}__publicField(TournamentUpcoming,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,center_y:.5,w:.4,h:null},bgColor:"rgba(0,0,0,0.65)",outlineColor:"rgba(255,255,255,1)"}));class TournamentSummary extends BoxLayout{constructor(){if(super(),this.game=Game.get(),!this.game.tournament)throw new Error("No tournament is active in the game");this.viewRound=this.game.tournament.finalsIndex,this.game.tournament,this.resultsBox=BoxLayout.a({orientation:"vertical",hints:{h:null}}),this.roundButtons=BoxLayout.a({orientation:"horizontal",hints:{h:"8",w:.8},paddingX:"0.1w",spacingX:"0.02w"}),this.children=[Label.a({text:`${finalsRoundNames[this.viewRound]}`,wrap:!0,color:"rgba(192, 50, 50, 1)",hints:{h:"18"}}),Label.a({text:"Results",hints:{h:"8"}}),this.resultsBox,this.roundButtons,Button.a({text:this.viewRound<3?"Next round":"Back to menu",sizeGroup:"menuButton",hints:{w:.8,h:"8"}}).listen("press",()=>this.nextRound())],this.populateButtons(),this.showResults(this.viewRound),this.updateProperties({})}populateButtons(){const t=this.game.tournament;if(!t)return;const buttons=t.finals.map((_,i)=>Button.a({text:`${i+1}`,hints:{h:"8",w:.15}}).listen("press",()=>this.showResults(i)));this.roundButtons.children=[Label.a({text:"Round",align:"left",hints:{h:"8",w:null}}),...buttons]}showResults(index){const t=this.game.tournament;if(!t)return;this.viewRound=index;const res=t.finals[index].results,playerId=t.playerTeamId;this.resultsBox.children=res.map(r2=>{let text;return playerId===r2.home.id?text=`[fg=yellow]${r2.home.abbrev} ${r2.homeScore}[/] - ${r2.awayScore} ${r2.away.abbrev}`:playerId===r2.away.id?text=`${r2.home.abbrev} ${r2.homeScore} - [fg=yellow]${r2.awayScore} ${r2.away.abbrev}[/]`:text=`${r2.home.abbrev} ${r2.homeScore} - ${r2.awayScore} ${r2.away.abbrev}`,Label.a({text,hints:{h:"8"},richText:!0})}),this.children[0]instanceof Label&&(this.children[0].text=`${finalsRoundNames[index]}`)}nextRound(){const t=this.game.tournament;t&&(t.advanceRound(),t.finalsIndex<4?this.parent&&(this.parent.addChild(TournamentUpcoming.a(TournamentUpcoming.props)),this.parent.removeChild(this)):this.parent&&(this.parent.addChild(MainMenu.a(MainMenu.props)),this.parent.removeChild(this)))}}__publicField(TournamentSummary,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,center_y:.5,w:.4,h:null},bgColor:"rgba(0,0,0,0.65)",outlineColor:"rgba(255,255,255,1)"}));class CareerSlotMenu extends BoxLayout{constructor(){super(),this.game=Game.get(),this.refresh()}refresh(){const rows=[Label.a({text:"Career Slots",color:"rgba(192, 50, 50, 1)",hints:{h:"18"}})];for(let i=0;i<5;i++){let slot;try{slot=loadSlot(i)}catch{slot={name:"Bad slot"}}const label=slot?slot.name:"Empty";rows.push(BoxLayout.a({orientation:"horizontal",hints:{h:"8",w:.8},spacingX:"0.02w"}).c(Button.a({text:label,hints:{h:"8"}}).listen("press",()=>this.select(i))).c(Button.a({text:"📥",hints:{w:null,h:"8"},disable:!slot}).listen("press",()=>downloadSlot(i))).c(Button.a({text:"📤",hints:{w:null,h:"8"}}).listen("press",()=>this.upload(i))).c(Button.a({text:"🗑️",hints:{w:null,h:"8"},disable:!slot}).listen("press",()=>{deleteSlot(i),this.refresh()})))}rows.push(Button.a({text:"Back",hints:{w:.8,h:"8"}}).listen("press",()=>this.goBack())),this.children=rows}select(index){let slot=loadSlot(index);slot||(slot=createNewCareer(index)),this.game.career=slot,this.game.careerSlot=index,this.parent&&(this.parent.addChild(CareerHub.a(CareerHub.props)),this.parent.removeChild(this))}upload(index){const input=document.createElement("input");input.type="file",input.accept="application/json",input.onchange=async()=>{const file=input.files?input.files[0]:null;if(file)try{await uploadSlot(index,file),this.refresh()}catch(e){console.error("Failed to upload career",e)}},input.click()}goBack(){this.parent&&(this.parent.addChild(MainMenu.a(MainMenu.props)),this.parent.removeChild(this))}}__publicField(CareerSlotMenu,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{center_x:.5,center_y:.5,w:.5,h:null},bgColor:"rgba(0,0,0,0.65)",outlineColor:"rgba(255,255,255,1)"}));class CareerPostSeason extends BoxLayout{constructor(){super(),this.game=Game.get();const c=this.game.career;if(!c)throw Error("This is no active career loaded");c.freeAgents||(c.freeAgents=[]);const agingChanges=applyAging(c);this.retirements=[],this.expiring=[],this.progression=[];for(const team of c.teams){const remain=[];for(const p of team.roster){p.contractLength-=1;const delta=agingChanges.get(p);p.age>34||p.careerHealth<=0?this.retirements.push({team:team.abbrev,player:p}):p.contractLength<=0?(this.expiring.push({team:team.abbrev,player:p}),c.freeAgents.push(p)):remain.push(p),team.id===c.playerTeamId&&delta&&this.progression.push({player:p,delta})}team.roster=remain}const seasoned=c.freeAgents.filter(p=>p.age>=23),retLabels=this.retirements.length?this.retirements.map(r2=>Label.a({text:`${r2.team} ${r2.player.name} (${r2.player.age})`,hints:{h:"6"}})):[Label.a({text:"None",hints:{h:"6"}})],expLabels=this.expiring.length?this.expiring.map(r2=>Label.a({text:`${r2.team} ${r2.player.name} $${Math.round(r2.player.salary/1e3)}k`,hints:{h:"6"}})):[Label.a({text:"None",hints:{h:"6"}})],faLabels=seasoned.length?seasoned.map(p=>Label.a({text:`${p.position} ${p.name} $${Math.round(p.salary/1e3)}k`,hints:{h:"6"}})):[Label.a({text:"None",hints:{h:"6"}})],fmtPct=v=>`${v>0?"+":""}${Math.round(v*100)}%`;this.progression.length?this.progression.map(r2=>{const parts=[];return r2.delta.weight&&parts.push(`Weight ${r2.delta.weight>0?"+":""}${r2.delta.weight.toFixed(1)}kg`),r2.delta.speed&&parts.push(`Speed ${fmtPct(r2.delta.speed)}`),r2.delta.agility&&parts.push(`Agility ${fmtPct(r2.delta.agility)}`),Label.a({text:`${r2.player.name} ${parts.join(" ")}`,hints:{h:"6"}})}):Label.a({text:"None",hints:{h:"6"}});const rows=[Label.a({text:"Career Slots",color:"rgba(192, 50, 50, 1)",hints:{h:"18"}})];rows.push(Label.a({text:`${retLabels.length} Retirements`,hints:{h:"6"}}),Label.a({text:`${expLabels.length} Out of Contract`,hints:{h:"6"}}),Label.a({text:`${c.freeAgents.length} Free Agents`,hints:{h:"6"}}),Label.a({text:`${faLabels.length} Progression`,hints:{h:"6"}}),Button.a({text:"Continue",hints:{w:.8,h:"8"}}).listen("press",()=>this.finish())),this.children=rows}finish(){if(!this.game.career)throw Error("No active career in game");if(this.game.careerSlot===null)throw Error("No active careerSlot in game");startNewSeason(this.game.career),saveSlot(this.game.careerSlot,this.game.career),this.parent&&(this.parent.addChild(CareerHub.a(CareerHub.props)),this.parent.removeChild(this))}}__publicField(CareerPostSeason,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,center_y:.5,w:.4,h:null},bgColor:"rgba(0,0,0,0.65)",outlineColor:"rgba(255,255,255,1)"}));class CareerHub extends BoxLayout{constructor(){super(),this.game=Game.get(),this.updateView()}updateView(){var _a,_b,_c,_d,_e,_f,_g,_h,_i;const c=this.game.career;if(!c)throw Error("No career in Game");c.pendingLevelUps&&(c.pendingLevelUps=c.pendingLevelUps.filter(entry=>entry&&entry.player));const team=c.teams[c.playerTeamId],salaryTotal=team.roster.reduce((s,p)=>s+p.salary,0);if(c.round>=c.schedule.length&&c.finals.length===0){if(this.game.careerSlot===null)throw Error("No careerSlot in Game");c.advanceRound(),saveSlot(this.game.careerSlot,c)}const ladder=computeLadder(c);let matchText="Season complete";if(`${c.season}`,c.round+1,c.round<c.schedule.length){const upcoming=c.schedule[c.round];if(upcoming){const m=upcoming.find(m2=>{var _a2,_b2;return((_a2=m2.home)==null?void 0:_a2.id)===team.id||((_b2=m2.away)==null?void 0:_b2.id)===team.id});if(m){const homeRank=((_a=ladder.find(t=>{var _a2;return t.id===((_a2=m.home)==null?void 0:_a2.id)}))==null?void 0:_a.rank)??"",awayRank=((_b=ladder.find(t=>{var _a2;return t.id===((_a2=m.away)==null?void 0:_a2.id)}))==null?void 0:_b.rank)??"";matchText=`${homeRank}. ${(_c=m.home)==null?void 0:_c.abbrev} vs ${awayRank}. ${(_d=m.away)==null?void 0:_d.abbrev}`}}}else if(c.currentFinalsRound<c.finals.length){`${c.season}${c.getFinalsRoundName(c.currentFinalsRound)}`;const m=(((_e=c.finals[c.currentFinalsRound])==null?void 0:_e.matches)??[]).find(m2=>{var _a2,_b2;return((_a2=m2.home)==null?void 0:_a2.id)===team.id||((_b2=m2.away)==null?void 0:_b2.id)===team.id});if(m){const homeRank=((_f=ladder.find(t=>{var _a2;return t.id===((_a2=m.home)==null?void 0:_a2.id)}))==null?void 0:_f.rank)??"",awayRank=((_g=ladder.find(t=>{var _a2;return t.id===((_a2=m.away)==null?void 0:_a2.id)}))==null?void 0:_g.rank)??"";matchText=`${homeRank}. ${(_h=m.home)==null?void 0:_h.abbrev} vs ${awayRank}. ${(_i=m.away)==null?void 0:_i.abbrev}`}else matchText=c.getFinalsRoundName(c.currentFinalsRound)}else`${c.season}`;const extraButtons=[];c.finals.length>0&&c.currentFinalsRound>=c.finals.length&&extraButtons.push(Button.a({text:"Enter post season",hints:{w:.8,h:"8"}}).listen("press",()=>this.enterPostSeason()));const pendingCount=c.pendingLevelUps?c.pendingLevelUps.length:0;if(pendingCount){const label=pendingCount>1?`⭐ Advancements (${pendingCount})`:"⭐ Advancement";extraButtons.push(Button.a({text:label,hints:{w:.8,h:"8"},disable:pendingCount===0}).listen("press",()=>this.openAdvancements()))}this.children=[Label.a({text:team.name,color:"rgba(192, 50, 50, 1)",hints:{h:"18"}}),Label.a({text:`Season ${c.season} - Round ${c.round+1}`,hints:{h:"6"}}),Label.a({text:`Salary: $${Math.round(salaryTotal/1e6*100)/100}m / $${Math.round(c.salaryCap/1e6*100)/100}m`,hints:{h:"6"}}),Label.a({text:`Next: ${matchText}`,hints:{h:"6"}}),BoxLayout.a({orientation:"horizontal",hints:{w:.8,h:"8"},spacingX:.02}).c(Button.a({text:"Roster"}).listen("press",()=>this.openRoster())).c(Button.a({text:"Matches"}).listen("press",()=>this.openMatches())),BoxLayout.a({orientation:"horizontal",hints:{w:.8,h:"8"},spacingX:.02}).c(Button.a({text:"Ladder"}).listen("press",()=>this.openLadder())).c(Button.a({text:"Coach",disable:!0})),...extraButtons,Button.a({text:"Back to menu",hints:{w:.8,h:"8"}}).listen("press",()=>this.goBack())]}openRoster(){this.parent&&(this.parent.addChild(CareerRoster.a(CareerRoster.props)),this.parent.removeChild(this))}openMatches(){if(this.parent){const c=this.game.career;if(!c)throw Error("No active career in Game");const viewRound=c.round<c.schedule.length?c.round:c.schedule.length+c.currentFinalsRound;this.parent.addChild(CareerMatches.a({...CareerMatches.props,viewRound})),this.parent.removeChild(this)}}openLadder(){this.parent&&(this.parent.addChild(CareerLadder.a(CareerLadder.props)),this.parent.removeChild(this))}openAdvancements(){const c=this.game.career;if(!c)throw Error("No active career in Game");if(!this.parent||!c.pendingLevelUps||c.pendingLevelUps.length===0)return;let entry=null;for(;c.pendingLevelUps.length>0&&!entry;){const candidate=c.pendingLevelUps.shift();candidate&&candidate.player&&(entry=candidate)}if(!entry){this.updateView();return}this.parent&&(this.parent.addChild(LevelUpMenu.a({...LevelUpMenu.props,entry})),this.parent.removeChild(this))}enterPostSeason(){this.parent&&(this.parent.addChild(CareerPostSeason.a(CareerPostSeason.props)),this.parent.removeChild(this))}goBack(){this.parent&&(this.parent.addChild(MainMenu.a(MainMenu.props)),this.parent.removeChild(this))}}__publicField(CareerHub,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,center_y:.5,w:.4,h:null},bgColor:"rgba(0,0,0,0.65)",outlineColor:"rgba(255,255,255,1)"}));class CareerRoster extends BoxLayout{constructor(){super(),this.game=Game.get();const c=this.game.career;if(!c)throw Error("No active career in Game");this.teamId=c.playerTeamId,this.teamGrid=GridLayout.a({numX:9,hints:{w:.8,h:"12"},spacingX:"0.02w",spacingY:"0.01h"}),this.teamGrid.children=c.teams.map(t=>ToggleButton.a({text:t.abbrev,hints:{h:"6"},color:c.playerTeamId===t.id?"yellow":"white",group:"teamButtons",press:this.teamId===t.id}).listen("press",()=>{this.teamId=t.id,this.updateRoster()})),this.list=BoxLayout.a({orientation:"vertical",hints:{h:null}});const scroll=ScrollView.a({scrollW:!1,hints:{w:.8,h:"36"}}).c(this.list);this.children=[Label.a({text:"Roster",color:"rgba(192, 50, 50, 1)",hints:{h:"18"}}),this.teamGrid,scroll,BoxLayout.a({orientation:"horizontal",hints:{h:"8",w:.8},spacingX:"0.02w"}).c(Button.a({text:"Trade",hints:{w:.33,h:"8"},disable:!0})).c(Button.a({text:"Release",hints:{w:.33,h:"8"},disable:!0})).c(Button.a({text:"Recruit",hints:{w:.33,h:"8"},disable:!0})),Button.a({text:"Back",hints:{w:.8,h:"8"}}).listen("press",()=>this.goBack())],setTimeout(()=>this.updateRoster(),0)}updateRoster(){const c=this.game.career;if(!c)throw Error("No active career in Game");const team=c.teams.find(t=>t.id===this.teamId)??c.teams[0];this.list.children=team.roster.map(p=>BoxLayout.a({orientation:"horizontal",hints:{h:"6"}}).c(Label.a({text:`${p.position} ${p.name} $${Math.round(p.salary/1e3)}k ${p.contractLength}yr ${p.age}yrs ${stars(p.rating,STAR_SCALE,STAR_ZERO)}`,hints:{w:.9}})).c(Button.a({text:"ℹ️",hints:{w:.1}}).listen("press",()=>this.openPlayer(p))))}openPlayer(p){this.parent&&(this.parent.addChild(CareerPlayerScreen.a({...CareerPlayerScreen.props,player:p,teamId:this.teamId})),this.parent.removeChild(this))}goBack(){this.parent&&(this.parent.addChild(CareerHub.a(CareerHub.props)),this.parent.removeChild(this))}}__publicField(CareerRoster,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,center_y:.5,w:.4,h:null},bgColor:"rgba(0,0,0,0.65)",outlineColor:"rgba(255,255,255,1)"}));class CareerPlayerScreen extends BoxLayout{constructor(){if(super(),this.game=Game.get(),this.player=null,!this.game.career)throw Error("No active career in Game");this.teamId=this.game.career.playerTeamId,setTimeout(()=>this.updateView(),0)}updateView(){const p=this.player;if(!p)return;const stats=[`Position: ${p.position}`,`Age (yrs): ${p.age}`,`Height (cm): ${Math.round(p.height*100)}`,`Weight (kg): ${Math.round(p.weight)}`,`Games Played: ${p.games}`,`Salary: $${Math.round(p.salary/1e3)}k`,`Contract (yrs left): ${p.contractLength}`,`Condition (%): ${p.playerCondition}`,`Career Health (games left): ${p.careerHealth}`,`Strength (kg bench): ${Math.round(p.strength*10)/10}`,`Speed (m/s): ${Math.round(p.speed*10)/10}`,`Agility: ${Math.round(p.agility*10)/10}`,`Jump (m/s): ${Math.round(p.jump*10)/10}`,`Kick Range (m): ${Math.round(p.kickRange)}`,`Handpass Range (m): ${Math.round(p.handpassRange)}`,`Fitness: ${p.fitness}`,`Morale: ${p.morale}`],buffLines=Object.entries(BUFFS).map(([id,meta])=>{var _a;const lvl=((_a=p.activeBuffs)==null?void 0:_a[id])??0;return`${meta.name}: ${buffIcons(lvl)}`}),statsBox=GridLayout.a({numX:2,spacingX:"0.02w",spacingY:"0.01h",paddingX:"0.01w",paddingY:"0.01h"});statsBox.children=[...stats,...buffLines].map(t=>Label.a({text:t,sizeGroup:"playerStats",hints:{h:"4"}}));const face=p.faceId+(p.complexion==="pasty"?32:0)+(p.complexion==="swarthy"?64:0),uniform=this.teamId+128,arms=(p.complexion==="ruddy"?160:0)+(p.complexion==="pasty"?192:0)+(p.complexion==="swarthy"?224:0),portrait=SpriteWidget.a({hints:{w:"22",h:"22"},bgColor:"rgba(255,255,255,0.2)",frames:[laf([uniform,arms,face],[[0,0],[0,0]])],spriteSheet:this.game.uiSprites}),body=BoxLayout.a({orientation:"horizontal",hints:{w:.85,h:"48"},spacingX:"0.03w"}).c(portrait).c(statsBox),header=BoxLayout.a({orientation:"horizontal",hints:{w:.85,h:"12"},spacingX:"0.02w"}).c(Button.a({text:"<",hints:{w:.12,h:"12"}}).listen("press",()=>this.prevPlayer())).c(Label.a({text:p.name,color:"rgba(192, 50, 50, 1)",hints:{w:.6,h:"12"},align:"center"})).c(Button.a({text:">",hints:{w:.12,h:"12"}}).listen("press",()=>this.nextPlayer()));this.children=[header,body,Button.a({text:"Back",hints:{w:.85,h:"6"}}).listen("press",()=>this.goBack())]}prevPlayer(){var _a;if(!this.game.career)throw new Error("No active career in Game");const roster=((_a=this.game.career.teams.find(t=>t.id===this.teamId))==null?void 0:_a.roster)??[];if(!this.player||roster.length===0)return;const prevIdx=(roster.indexOf(this.player)-1+roster.length)%roster.length;this.player=roster[prevIdx],this.updateView()}nextPlayer(){var _a;if(!this.game.career)throw new Error("No active career in Game");const roster=((_a=this.game.career.teams.find(t=>t.id===this.teamId))==null?void 0:_a.roster)??[];if(!this.player||roster.length===0)return;const nextIdx=(roster.indexOf(this.player)+1)%roster.length;this.player=roster[nextIdx],this.updateView()}goBack(){this.parent&&(this.parent.addChild(CareerRoster.a({...CareerRoster.props,teamId:this.teamId})),this.parent.removeChild(this))}}__publicField(CareerPlayerScreen,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{center_x:.5,center_y:.5,w:.8,h:null},bgColor:"rgba(0,0,0,0.65)",outlineColor:"rgba(255,255,255,1)"}));class CareerLadder extends BoxLayout{constructor(){super(),this.game=Game.get();const c=this.game.career;if(!c)throw new Error("No active career in Game");const rows=computeLadder(c).map(t=>{const color=t.id===c.playerTeamId?"yellow":"white",ratingText=stars(t.teamRating,1),left=Label.a({text:`${t.rank}. ${t.name} (${t.abbrev}) ${ratingText}`,align:"left",color}),right=Label.a({text:`${t.wins}-${t.losses}-${t.draws}`,align:"right",hints:{w:null},color});return BoxLayout.a({orientation:"horizontal",hints:{h:"6"}}).c(left).c(right)}),scroll=ScrollView.a({scrollW:!1,hints:{w:.8,h:"48"}}).c(BoxLayout.a({hints:{h:null}}).c(rows));this.children=[Label.a({text:"Ladder",color:"rgba(192, 50, 50, 1)",hints:{h:"18"}}),scroll,Button.a({text:"Back",hints:{w:.8,h:"8"}}).listen("press",()=>this.goBack())]}goBack(){this.parent&&(this.parent.addChild(CareerHub.a(CareerHub.props)),this.parent.removeChild(this))}}__publicField(CareerLadder,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,center_y:.5,w:.4,h:null},bgColor:"rgba(0,0,0,0.65)",outlineColor:"rgba(255,255,255,1)"}));class CareerMatches extends BoxLayout{constructor(){super(),this.game=Game.get();const c=this.game.career;c?this.viewRound=c.round<c.schedule.length?c.round:c.schedule.length+c.currentFinalsRound:this.viewRound=0,setTimeout(()=>this.updateView(),0)}currentRoundIndex(){const c=this.game.career;if(!c)throw new Error("No active career in Game");return c.round}updateView(){var _a,_b;const c=this.game.career;if(!c)throw new Error("No active career in Game");const styler=(text,highlight)=>highlight?`[fg=yellow]${text}[/]`:text,ladder=computeLadder(c),totalRegular=c.schedule.length,totalFinals=c.finals.length,total=totalRegular+totalFinals;this.viewRound<0&&(this.viewRound=0),this.viewRound>=total&&(this.viewRound=total-1);const finalsMode=this.viewRound>=totalRegular,roundIndex=finalsMode?this.viewRound-totalRegular:this.viewRound,matches=finalsMode?((_a=c.finals[roundIndex])==null?void 0:_a.matches)??[]:c.schedule[roundIndex]??[],results=finalsMode?((_b=c.finals[roundIndex])==null?void 0:_b.results)??null:c.results[roundIndex]??null,title=finalsMode?c.getFinalsRoundName(roundIndex):`Round ${roundIndex+1}`,playerId=c.playerTeamId,activeTeams=(()=>{var _a2,_b2;if(finalsMode&&c.finals.length){const finalists=(((_a2=c.finals[0])==null?void 0:_a2.matches)??[]).flatMap(m=>[m.home,m.away]).filter(team=>team),active=new Set(finalists.map(t=>t.id));for(let r2=0;r2<roundIndex;r2++){const res=(_b2=c.finals[r2])==null?void 0:_b2.results;if(res)if(r2===0)for(const m of res.slice(2,4)){const loser=m.homeScore<m.awayScore?m.home:m.away;loser&&active.delete(loser.id)}else for(const m of res){const loser=m.homeScore<m.awayScore?m.home:m.away;loser&&active.delete(loser.id)}}return finalists.filter(t=>active.has(t.id))}return c.teams})(),playingIds=new Set(matches.flatMap(m=>{var _a2,_b2;return[(_a2=m.home)==null?void 0:_a2.id,(_b2=m.away)==null?void 0:_b2.id]}).filter(id=>typeof id=="number")),byeTeams=activeTeams.filter(t=>!playingIds.has(t.id)),labels=matches.map((m,i)=>{var _a2,_b2;const home=m.home,away=m.away,homeRank=home?((_a2=ladder.find(t=>t.id===home.id))==null?void 0:_a2.rank)??"":"",awayRank=away?((_b2=ladder.find(t=>t.id===away.id))==null?void 0:_b2.rank)??"":"",res=results?results[i]:null;let text=home&&away?`${homeRank}. ${styler(home.abbrev,home.id===playerId)} vs ${awayRank}. ${styler(away.abbrev,away.id===playerId)}`:"TBD";if(res&&typeof res.homeScore=="number"&&typeof res.awayScore=="number"){const hs=res.homeScore>=0?res.homeScore:"F",as=res.awayScore>=0?res.awayScore:"F";text+=` ${hs}-${as}`}return Label.a({text,hints:{h:"5"},richText:!0})});byeTeams.length>0&&labels.push(Label.a({text:`Bye: ${byeTeams.map(t=>styler(t.abbrev,t.id===playerId)).join(", ")}`,hints:{h:"5"},richText:!0}));const scroll=ScrollView.a({scrollW:!1,hints:{w:.8,h:"48"}}).c(BoxLayout.a({hints:{h:null}}).c(labels)),playerMatchIndex=matches.findIndex(m=>m.home&&m.home.id===playerId||m.away&&m.away.id===playerId),currentIndex=this.currentRoundIndex(),canAct=this.viewRound===currentIndex&&(!results||results.length===0);this.children=[Label.a({text:title,color:"rgba(192, 50, 50, 1)",hints:{h:"18"}}),scroll,BoxLayout.a({orientation:"horizontal",hints:{h:"6",w:.8},spacingX:"0.02w"}).c(Button.a({text:"Play",hints:{w:.5,h:"6"},disable:playerMatchIndex===-1||!canAct}).listen("press",()=>this.playMatch())).c(Button.a({text:"Simulate All",hints:{w:.5,h:"6"},disable:!canAct}).listen("press",()=>this.simulateRound())),BoxLayout.a({orientation:"horizontal",hints:{h:"6",w:.8},spacingX:"0.02w"}).c(Button.a({text:"<",hints:{w:.25,h:"6"},disable:this.viewRound<=0}).listen("press",()=>{this.viewRound-=1,this.updateView()})).c(Button.a({text:"@",hints:{w:.25,h:"6"},disable:this.viewRound===currentIndex}).listen("press",()=>{this.viewRound=currentIndex,this.updateView()})).c(Button.a({text:">",hints:{w:.25,h:"6"},disable:this.viewRound>=total-1}).listen("press",()=>{this.viewRound+=1,this.updateView()})),Button.a({text:"Back to Hub",hints:{w:.8,h:"6"}}).listen("press",()=>this.goBack())],canAct&&playerMatchIndex===-1&&setTimeout(()=>this.simulateRound(),0)}simulateRound(){const c=this.game.career;if(!c)throw new Error("No active career in Game");if(c.isFinals){const round=c.finals[c.currentFinalsRound],results=((round==null?void 0:round.matches)??[]).map(m=>{const sim=m.home&&m.away?simulateMatch(m.home,m.away):{};return new CareerMatchResult({home:m.home,away:m.away,...sim})});for(const res of results)res.home&&awardExperienceForTeam(c,res.home,1,res.home.id===c.playerTeamId),res.away&&awardExperienceForTeam(c,res.away,1,res.away.id===c.playerTeamId);round&&(round.results=results)}else{const results=(c.isFinals?c.finals[c.finalsIndex].matches:c.schedule[c.round]).map(m=>{const sim=m.home&&m.away?simulateMatch(m.home,m.away):{};return new CareerMatchResult({home:m.home,away:m.away,...sim})});for(const res of results)res.home&&awardExperienceForTeam(c,res.home,1,res.home.id===c.playerTeamId),res.away&&awardExperienceForTeam(c,res.away,1,res.away.id===c.playerTeamId);c.results[c.round]=results}if(this.viewRound=c.round,c.advanceRound(),this.game.careerSlot===null)throw new Error("No active careerSlot in Game");saveSlot(this.game.careerSlot,c),this.updateView()}playMatch(){const c=this.game.career;if(!c)throw new Error("No active career in Game");const finalsMode=c.isFinals,playerTeam=c.playerTeamId;if(finalsMode){const round=c.finals[c.currentFinalsRound],matches=(round==null?void 0:round.matches)??[],matchIndex=matches.findIndex(m=>m.home&&m.home.id===playerTeam||m.away&&m.away.id===playerTeam);if(matchIndex===-1){this.simulateRound();return}const results=matches.map(m=>CareerMatchResult.fromMatch(m));for(let i=0;i<matches.length;i++)if(i!==matchIndex){const simulated=results[i];simulated.home&&simulated.away&&(Object.assign(simulated,simulateMatch(matches[i].home,matches[i].away)),awardExperienceForTeam(c,simulated.home,1,simulated.home.id===c.playerTeamId),awardExperienceForTeam(c,simulated.away,1,simulated.away.id===c.playerTeamId))}round&&(round.results=results);const match=matches[matchIndex];if(!(match!=null&&match.home)||!(match!=null&&match.away)){this.simulateRound();return}const playerIsHome=match.home.id===playerTeam;if(this.game.careerSlot===null)throw new Error("No active careerSlot in Game");this.game.careerGame={round:c.currentFinalsRound,matchIndex,playerIsHome,slot:this.game.careerSlot,finals:!0};const teamIds2=playerIsHome?[match.home.id,match.away.id]:[match.away.id,match.home.id];this.game.setupGame(teamIds2[0],teamIds2[1],5)}else{const matches=c.schedule[c.round]??[],matchIndex=matches.findIndex(m=>m.home&&m.home.id===playerTeam||m.away&&m.away.id===playerTeam);if(matchIndex===-1){this.simulateRound();return}const results=matches.map(m=>CareerMatchResult.fromMatch(m));for(let i=0;i<matches.length;i++)if(i!==matchIndex){const simulated=results[i];simulated.home&&simulated.away&&(Object.assign(simulated,simulateMatch(matches[i].home,matches[i].away)),awardExperienceForTeam(c,simulated.home,1,simulated.home.id===c.playerTeamId),awardExperienceForTeam(c,simulated.away,1,simulated.away.id===c.playerTeamId))}c.results[c.round]=results;const match=matches[matchIndex];if(!(match!=null&&match.home)||!(match!=null&&match.away)){this.simulateRound();return}const playerIsHome=match.home.id===playerTeam,teamIds2=playerIsHome?[match.home.id,match.away.id]:[match.away.id,match.home.id];if(this.game.careerSlot===null)throw new Error("No active careerSlot in Game");this.game.careerGame={round:c.round,matchIndex,playerIsHome,slot:this.game.careerSlot,finals:!1},this.game.setupGame(teamIds2[0],teamIds2[1],5)}}goBack(){this.parent&&(this.parent.addChild(CareerHub.a(CareerHub.props)),this.parent.removeChild(this))}}__publicField(CareerMatches,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,center_y:.5,w:.4,h:null},bgColor:"rgba(0,0,0,0.65)",outlineColor:"rgba(255,255,255,1)"}));class OptionsMenu extends BoxLayout{constructor(){super(),this.game=App.get(),this.children=[Label.a({text:"Options",color:"rgba(192, 50, 50, 1)",hints:{h:"18"}}),Button.a({text:"Audio",disable:!0,hints:{w:.8,h:"8"}}),Button.a({text:"Graphics",disable:!0,hints:{w:.8,h:"8"}}),Button.a({text:"Back",hints:{w:.8,h:"8"}}).listen("press",()=>this.goBack())]}goBack(){this.parent&&(this.parent.addChild(MainMenu.a(MainMenu.props)),this.parent.removeChild(this))}}__publicField(OptionsMenu,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,center_y:.5,w:.4,h:null},bgColor:"rgba(0,0,0,0.65)",outlineColor:"rgba(255,255,255,1)"}));const _LevelUpMenu=class _LevelUpMenu extends BoxLayout{constructor(){super(),this.game=Game.get(),this.entry=null}on_entry(){this.entry&&this.updateView()}updateView(){var _a;const entry=this.entry,p=entry==null?void 0:entry.player;if(!p){setTimeout(()=>this.nextOrHub(),0);return}const buttons=[];for(const[id,meta]of Object.entries(BUFFS)){const next=(((_a=p.activeBuffs)==null?void 0:_a[id])??0)+1;next<meta.levels.length&&buttons.push(Button.a({text:`${meta.name} Lv.${next}`,hints:{w:.8,h:"8"}}).listen("press",()=>{id in BUFFS&&this.selectBuff(id)}))}buttons.length===0&&buttons.push(Label.a({text:"Max skills achieved",hints:{h:"8"}}),Button.a({text:"Next",hints:{w:.8,h:"8"}}).listen("press",()=>{this.nextOrHub()})),this.children=[Label.a({text:`${p.name} leveled up!`,color:"rgba(192, 50, 50, 1)",hints:{h:"18"}}),...buttons]}nextOrHub(){const parent=this.parent;if(!parent)throw Error("LevelUpMenu has no parent widget!");let nextEntry=null;const c=this.game.career;if(!c)throw new Error("No active career in Game");for(;c.pendingLevelUps&&c.pendingLevelUps.length>0&&!nextEntry;){const candidate=c.pendingLevelUps.shift();candidate&&candidate.player&&(nextEntry=candidate)}nextEntry?parent.addChild(_LevelUpMenu.a({..._LevelUpMenu.props,entry:nextEntry})):parent.addChild(CareerHub.a({...CareerHub.props,entry:nextEntry})),parent.removeChild(this)}selectBuff(buffId){const entry=this.entry,p=entry==null?void 0:entry.player;if(!p)return;p.activeBuffs=p.activeBuffs||{};const newLevel=(p.activeBuffs[buffId]??0)+1;applyBuffToStats(p,buffId,newLevel);const c=this.game.career;if(!c)throw new Error("No active career in Game");if(this.game.careerSlot===null)throw new Error("No active careerSlot in Game");saveSlot(this.game.careerSlot,c),this.nextOrHub()}};__publicField(_LevelUpMenu,"props",Object.freeze({orientation:"vertical",spacingY:"0.02h",paddingY:"0.02h",hints:{x:.3,center_y:.5,w:.4,h:null},bgColor:"rgba(0,0,0,0.65)",outlineColor:"rgba(255,255,255,1)"}));let LevelUpMenu=_LevelUpMenu;function makeCtx(game){const ball=game.ball,carrier=ball.carrier??null,home=game.homePlayers.filter(p=>p.playing),away=game.awayPlayers.filter(p=>p.playing),ballPos=carrier?carrier.pos:ball.pos,distToBall=new Map;for(const p of game.players)distToBall.set(p,p.pos.dist(ballPos));const closestOn=team=>team.reduce((b,p)=>b==null||distToBall.get(p)<distToBall.get(b)?p:b,null);return{game,ball,carrier,home,away,ballPos,distToBall,closestHome:closestOn(home),closestAway:closestOn(away)}}function decideIntents(game){for(const p of game.players)p.playing&&(p.intentTarget=null,p.intentVelocity=null);const ctx=makeCtx(game);if(game.queuedEvent!==null){for(const p of game.players)p.playing&&(p.intent="pushBack",p.intentTarget=Vec3.fromArray(p.positionPos));return}if(game.setPiece instanceof FreeKickSetPiece)return decideIntentsFreeKick(game.setPiece,ctx);if(game.setPiece instanceof CenterBounceSetPiece)return decideIntentsCenterBounce(game.setPiece);if(game.setPiece instanceof BoundaryThrowInSetPiece)return decideIntentsBoundaryThrowIn(game.setPiece);if(ctx.carrier){const mates=ctx.carrier.team==="home"?ctx.home:ctx.away,opps=ctx.carrier.team==="home"?ctx.away:ctx.home;return decideIntentsCarry(ctx.carrier,mates,opps,ctx)}return game.currentContest&&game.currentContest.type==="aerial"?decideIntentsAerialContest(ctx):decideIntentsGroundContest(ctx)}function greedyMarkAssign(defenders,attackers){const usedDefs=new Set,usedAtts=new Set,pairs=[],pool=[];for(const d of defenders)for(const a2 of attackers){if(!a2)continue;const targetPos=typeof a2=="object"&&"team"in a2||typeof a2=="object"&&"pos"in a2?a2.pos:a2;pool.push({d:d.pos.dist(targetPos),def:d,att:a2})}pool.sort((A,B)=>A.d-B.d);for(const e of pool)usedDefs.has(e.def)||usedAtts.has(e.att)||(usedDefs.add(e.def),usedAtts.add(e.att),pairs.push([e.def,e.att]));return pairs}function applyHumanMovementOverride(game,predicate=()=>!0,options={}){var _a;const player=game.player,controls=game.controls;if(!player||!controls||!predicate(player))return!1;const state=controls.state,moveX=(state==null?void 0:state.moveX)??0,moveZ=(state==null?void 0:state.moveZ)??0;if(moveX===0&&moveZ===0)return!1;const moveVec=v3(moveX,0,moveZ);return moveVec.lenSq()>.01?player.intentVelocity=moveVec.normalize().scale(player.jogSpeed+player.joltSpeed):player.intentVelocity=((_a=player.jogVel)==null?void 0:_a.c)??null,options.intent!==null&&(player.intent=options.intent??"contestAnyway"),(options.clearTarget??!0)&&(player.intentTarget=null),!0}function canCoverAttackers(defenders,attackers,maxDistance){if(attackers.length===0)return!0;const usedDefs=new Set,usedAtts=new Set,pool=[];for(const d of defenders)for(const a2 of attackers){const dist2=d.pos.dist(a2.pos);dist2<=maxDistance&&pool.push({d:dist2,def:d,att:a2})}pool.sort((A,B)=>A.d-B.d);for(const option of pool)if(!(usedDefs.has(option.def)||usedAtts.has(option.att))&&(usedDefs.add(option.def),usedAtts.add(option.att),usedAtts.size===attackers.length))return!0;return usedAtts.size===attackers.length}function decideIntentsCarry(carrier,teammates,opponents,ctx){var _a,_b,_c,_d,_e,_f;const{game,distToBall}=ctx,human=carrier===game.player,contest=((_a=game.currentContest)==null?void 0:_a.type)==="carried"?game.currentContest:null;let receivingMate=null,handpassPlan=null,handpassCatchPoint=null,handpassFallbackPoint=null;if(human){const state=game.controls.state,aimRel=state.aimTarget?oscillateAimTarget(state.aimTarget,performance.now()/1e3,.15,2,carrier.statsKickRange):null,aim=aimRel?carrier.pos.c.add(Vec3.fromArrayXZ(aimRel)):null,moveVec=v3(state.moveX,0,state.moveZ);if(moveVec.lenSq()>.01?updateAutoHandTarget(carrier,teammates,opponents,game):carrier.intentTarget=null,state.quickDisposePressed){carrier.intent="handball";const active=carrier.intentTarget,contest2=((_b=game.currentContest)==null?void 0:_b.type)==="carried"?game.currentContest:null;let targetPlayer=null,catchPoint=null;if(active&&typeof active=="object"&&"pos"in active){if(targetPlayer=active,contest2&&contest2.carrier===carrier&&contest2.handTarget===targetPlayer&&(catchPoint=((_c=contest2.handTargetDest)==null?void 0:_c.c)??((_d=contest2.handTargetPlan)==null?void 0:_d.destination.c)??null),!catchPoint){const targetVel=targetPlayer.intentVelocity??targetPlayer.vel;catchPoint=predictCatchPoint(carrier,targetPlayer,!0,targetVel)}catchPoint||(catchPoint=targetPlayer.pos.c)}else active instanceof Vec3?catchPoint=active.c:(Array.isArray(active)||active instanceof Float32Array)&&(catchPoint=Vec3.fromArray(active));catchPoint||(moveVec.lenSq()>1e-4?catchPoint=carrier.pos.c.add(moveVec.normalize().scale(10)):catchPoint=carrier.pos.c.add(v3(0,0,carrier.team==="home"?-10:10)));const passVec=catchPoint.c.sub(carrier.pos);carrier.intentVelocity=passVec.lenSq()>1e-6?passVec:null,carrier.intentTarget=targetPlayer??catchPoint}else aim&&(state.kickReleased||aim.dist(carrier.pos)>=carrier.statsKickRange)?(carrier.intent="kickToTarget",carrier.intentTarget=aim,carrier.intentVelocity=null):moveVec.lenSq()>.01?(carrier.intent="runCarry",carrier.intentVelocity=moveVec.normalize().scale(carrier.jogSpeed+carrier.joltSpeed)):(carrier.intent="holdBall",carrier.intentVelocity=((_e=carrier.jogVel)==null?void 0:_e.c)??null)}else{const kickRange=carrier.statsKickRange*(carrier.buffKick??1),distToGoal=carrier.pos.c.zeroY().dist(goals[carrier.team].c.zeroY()),mustShoot=distToGoal<=10,heldTime=game.now-(game.contestManager.time??game.now),underPressure=opponents.some(o=>o.pos.dist(carrier.pos)<7);if(!mustShoot&&!underPressure&&distToGoal>kickRange-10||heldTime<500){carrier.intent="runCarry";const dir=findSafeRunDirection(carrier,game);dir&&(carrier.intentVelocity=dir.scale(carrier.jogSpeed+carrier.joltSpeed))}else{carrier.intentVelocity=null;const[intent,target]=findDisposalTarget(game,carrier,teammates,opponents,void 0,heldTime<1e3);carrier.intent=intent,carrier.intentTarget=target??null,mustShoot&&(carrier.intent="kickToTarget",carrier.intentTarget=computeGoalShotTarget(carrier,goals[carrier.team],kickRange,distToGoal))}}if(contest&&contest.carrier===carrier){const target=contest.handTarget,plan=contest.handTargetPlan??null;if(target&&target.team===carrier.team&&target.playing&&target!==game.player)if(plan)receivingMate=target,handpassPlan=plan,handpassCatchPoint=plan.destination.c,handpassFallbackPoint=plan.fallback.c;else{const rawTarget=carrier.intent==="handball"?carrier.intentTarget:null;rawTarget&&(rawTarget instanceof Vec3?handpassCatchPoint=rawTarget.c:Array.isArray(rawTarget)||rawTarget instanceof Float32Array?handpassCatchPoint=Vec3.fromArray(rawTarget):typeof rawTarget=="object"&&"pos"in rawTarget&&(handpassCatchPoint=rawTarget.pos.c),handpassCatchPoint&&(receivingMate=target))}}const inFrontMates=teammates.filter(p=>isInLeadRange(p,ctx.ballPos)),behindMates=teammates.filter(p=>!inFrontMates.includes(p));for(const m of teammates){if(m===carrier||m===receivingMate)continue;m.pos.dist(carrier.pos)<12&&(shouldClearOut(m,game)||!isInLeadRange(m,ctx.ballPos))&&(m.intent="pushBack",m.intentTarget=m.positionPos.c)}const leadCandidates=inFrontMates.filter(m=>m!==carrier&&m!==receivingMate&&shouldLeadNow(m,game));setLeadingDirs(leadCandidates,opponents,game);const leadSet=new Set(leadCandidates);for(const m of inFrontMates)if(!(m===carrier||leadSet.has(m)||m===receivingMate))if(m.pos.dist(carrier.pos)<20){m.intent="supportRun";const lateralSign=m.pos[0]<carrier.pos[0]?-1:1;let supportTarget=carrier.pos.c.add([lateralSign*5,0,0]);const handRange=carrier.statsHandpassRange*(carrier.buffHandball??1);if(carrier.pos.dist(m.pos)<=handRange&&!opponents.some(o=>o.pos.dist(carrier.pos)<6&&o.pos.dist(m.pos)<6)){const goalDir=carrier.team==="home"?-1:1;supportTarget=carrier.pos.c.add([lateralSign*7,0,goalDir*6]);let closestOpp=null,closestDist=1/0;for(const opp of opponents){const d=opp.pos.dist(supportTarget);d<closestDist&&(closestDist=d,closestOpp=opp)}if(closestOpp&&closestDist<6){const away=supportTarget.c.sub(closestOpp.pos).zeroY();away.lenSq()>1e-4&&(supportTarget=closestOpp.pos.c.scaleAndAdd(away.normalize(),6))}isOutOfBounds(supportTarget)&&(supportTarget=carrier.pos.c.add([lateralSign*6,0,goalDir*4]))}m.intentTarget=supportTarget}else m.intent||(m.intent="idle",m.intentTarget=null);for(const m of behindMates)m===carrier||m===receivingMate||(shouldReturnToPosition(m,game)?(m.intent="pushBack",m.intentTarget=m.positionPos.c):m.intent||(m.intent="idle",m.intentTarget=null));if(receivingMate&&(handpassCatchPoint||handpassFallbackPoint)){const desired=handpassCatchPoint??(handpassPlan==null?void 0:handpassPlan.destination)??null;let targetPoint=desired,forceFallback=!1;if(handpassPlan&&desired){const currentThreat=pathThreat(carrier,desired,opponents,1),runDir=(receivingMate.intentVelocity??receivingMate.vel).c.zeroY(),destDir=desired.c.sub(receivingMate.pos).zeroY();let alignment=0;runDir.lenSq()>1e-4&&destDir.lenSq()>1e-4&&(alignment=runDir.normalize().dot(destDir.normalize())),(!(currentThreat<=.75)||alignment<-.05)&&handpassFallbackPoint&&(targetPoint=handpassFallbackPoint.c,forceFallback=!0)}if(targetPoint){const toCatch=targetPoint.c.sub(receivingMate.pos).zeroY();if(receivingMate.intent="supportRun",receivingMate.intentTarget=targetPoint.c,toCatch.lenSq()>.25){const dir=toCatch.normalize(),goalDir=v3(0,0,carrier.team==="home"?-1:1);if(!forceFallback&&dir.dot(goalDir)<-.15)receivingMate.intentVelocity=null;else{const maxSpeed=receivingMate.jogSpeed+receivingMate.joltSpeed,dampened=Math.min(maxSpeed*.9,toCatch.len()*2.2);receivingMate.intentVelocity=dir.scale(dampened)}}else receivingMate.intentVelocity=null}}const frontOpps=opponents.filter(o=>o.pos.dist(carrier.pos)<35&&ahead(o,carrier.pos)).sort((a2,b)=>distToBall.get(a2)-distToBall.get(b)),closeOpps=opponents.filter(o=>o.pos.dist(carrier.pos)<15&&!frontOpps.includes(o)).sort((a2,b)=>distToBall.get(a2)-distToBall.get(b)),tacklers=[];frontOpps.length>0&&tacklers.push(frontOpps.shift()),closeOpps.length>0&&tacklers.push(closeOpps.shift());for(const candidate of closeOpps){if(tacklers.length>=2)break;tacklers.includes(candidate)||tacklers.push(candidate)}for(const d of tacklers){d.intent="contestAnyway",d.intentTarget=carrier;const chase=carrier.pos.c.sub(d.pos).zeroY();chase.lenSq()>1e-4&&(d.intentVelocity=chase.normalize().scale(d.jogSpeed+d.joltSpeed))}const attackAhead=[carrier,...inFrontMates],lockedDefs=new Set(tacklers);if(isFrontHalf(carrier)&&inKickRangeOfGoal(carrier)){const defs=opponents.filter(p=>!tacklers.includes(p));if(!defs.some(p=>p.intent==="dropDeep")&&defs.length>0){const ownGoal=goals[((_f=opponents[0])==null?void 0:_f.team)??"away"],pick2=defs.reduce((best,p)=>!best||p.pos.dist(ownGoal)<best.pos.dist(ownGoal)?p:best,null);if(pick2){const otherDefs=opponents.filter(p=>p!==pick2),nearbyAttackers=attackAhead.filter(a2=>a2!==null&&pick2.pos.dist(a2.pos)<=30&&a2!==pick2).filter((a2,idx,arr)=>arr.indexOf(a2)===idx),hasCoverage=canCoverAttackers(otherDefs,nearbyAttackers,30),distToOwnGoal=player=>player.pos.dist(ownGoal),defendersAbleToCover=attacker=>otherDefs.filter(def=>{const dist2=def.pos.dist(attacker.pos);return!(dist2>30||attacker===carrier&&!(def.pos.dist(ownGoal)<distToOwnGoal(carrier)-1)&&dist2>10)});if(hasCoverage)pick2.intent="dropDeep",pick2.intentTarget=ownGoal.c.add(ownGoal.c.sub([0,FIELD_LENGTH$1/2,0]).normalize().scale(6)),lockedDefs.add(pick2);else{const uncoveredAhead=attackAhead.filter(att=>defendersAbleToCover(att).length===0).sort((a2,b)=>distToOwnGoal(a2)-distToOwnGoal(b)),target=uncoveredAhead.filter(att=>distToOwnGoal(att)<distToOwnGoal(carrier))[0]??uncoveredAhead[0]??carrier;if(target===carrier){pick2.intent="contestAnyway",pick2.intentTarget=carrier;const chase=carrier.pos.c.sub(pick2.pos).zeroY();chase.lenSq()>1e-4&&(pick2.intentVelocity=chase.normalize().scale(pick2.jogSpeed+pick2.joltSpeed))}else pick2.intent="markUp",pick2.intentTarget=target;lockedDefs.add(pick2)}}}}const freeDefs=opponents.filter(d=>!lockedDefs.has(d)&&d.intent!=="dropDeep"),markTargets=inKickRangeOfGoal(carrier)?[...attackAhead,goals[carrier.team]]:attackAhead,pairs=greedyMarkAssign(freeDefs,markTargets),markedDefs=new Set(pairs.map(([d])=>d));for(const[def,att]of pairs)def.intent="markUp",att&&typeof att=="object"&&"team"in att?def.intentTarget=att:att&&typeof att=="object"&&"pos"in att?def.intentTarget=att.pos:def.intentTarget=att;for(const d of freeDefs){if(markedDefs.has(d))continue;d.intent="fillSpace";const dirGoal=goals[d.team].c.sub(d.positionPos).zeroY().normalize();d.intentTarget=d.positionPos.c.scaleAndAdd(dirGoal,10)}applyHumanMovementOverride(game,p=>p!==carrier,{intent:"contestAnyway",clearTarget:!0})}const HAND_CONE_DOT=Math.cos(Math.PI/3);function updateAutoHandTarget(carrier,teammates,opponents,game){var _a;const runDir=carrier.vel.c.zeroY();if(runDir.lenSq()<1e-4){carrier.intentTarget=null;return}runDir.normalize();const contest=((_a=game.currentContest)==null?void 0:_a.type)==="carried"?game.currentContest:null;if(!contest||contest.carrier!==carrier){carrier.intentTarget=null;return}const existingTarget=contest.handTarget,existingPlan=contest.handTargetPlan??null;if(existingTarget&&existingPlan&&isValidHandPlan(carrier,existingTarget,existingPlan,runDir,opponents)){carrier.intentTarget=existingTarget;return}const choice=findBestHandTarget(carrier,teammates,opponents,runDir);choice?(game.contestManager.updateHandTarget(choice.mate,choice.plan),carrier.intentTarget=choice.mate):(game.contestManager.updateHandTarget(null,null),carrier.intentTarget=null)}function isValidHandPlan(carrier,target,plan,runDir,opponents){const handRange=carrier.statsHandpassRange*(carrier.buffHandball??1),dist2=carrier.pos.c.zeroY().dist(plan.destination.c.zeroY());if(dist2>handRange+.5||dist2<1.5)return!1;const toDest=plan.destination.c.sub(carrier.pos).zeroY();if(toDest.lenSq()<1e-4||toDest.normalize().dot(runDir)<HAND_CONE_DOT)return!1;const mateVel=target.intentVelocity??target.vel,mateRun=v3(mateVel[0],0,mateVel[2]);if(mateRun.lenSq()>1e-4){const toCarrier=carrier.pos.c.sub(target.pos).zeroY();if(toCarrier.lenSq()>1e-4&&mateRun.c.normalize().dot(toCarrier.normalize())>.55)return!1;const toPlan=plan.destination.c.sub(target.pos).zeroY();if(toPlan.lenSq()>1e-4&&mateRun.c.normalize().dot(toPlan.normalize())<.25)return!1}return!(pathThreat(carrier,plan.destination,opponents,1)>.85)}function findBestHandTarget(carrier,teammates,opponents,runDir){let bestChoice=null,bestScore=-1/0;const goalDir=carrier.team==="home"?-1:1;for(const mate of teammates){if(mate===carrier)continue;const plan=computeHandpassPlan(carrier,mate,opponents);if(!plan)continue;const toDest=plan.destination.c.sub(carrier.pos).zeroY(),dist2=toDest.len();if(dist2>carrier.statsHandpassRange+.25||dist2<1.5||toDest.normalize().dot(runDir)<HAND_CONE_DOT)continue;const forward=goalDir*(plan.destination[2]-carrier.pos[2]),spacing=plan.destination.c.zeroY().dist(mate.pos.c.zeroY()),destDir=plan.destination.c.sub(mate.pos).zeroY();let align=0;const mateVel=mate.intentVelocity??mate.vel,mateRun=v3(mateVel[0],0,mateVel[2]);mateRun.lenSq()>1e-4&&destDir.lenSq()>1e-4&&(align=mateRun.normalize().dot(destDir.normalize()));let score=forward*3+spacing*1.2+align*5;score-=plan.threat*35,dist2<2.5&&(score-=(2.5-dist2)*12),score>bestScore&&(bestScore=score,bestChoice={mate,plan})}return bestChoice}function decideIntentsFreeKick(setPiece,ctx){var _a;const{game}=ctx,{kicker,defender,markPos}=setPiece,teammates=game.teammatesOf(kicker),opponents=game.opponentsOf(kicker);defender&&(defender.intent="standMark",defender.intentTarget=markPos),kicker.intent="freeKick";const goalZ=kicker.team==="home"?0:FIELD_LENGTH$1,goalDir=v3(0,0,goalZ).sub(markPos).zeroY().normalize();if(setPiece.state==="backup")kicker.intentVelocity=setPiece.backupPos.c.dirFrom(kicker.pos).scale(kicker.jogSpeed),setPiece.backupPos.dist(kicker.pos)<.1&&(setPiece.state="turn");else if(setPiece.state==="turn"){kicker.intentVelocity=null;const distToMark=setPiece.backupPos.dist(setPiece.markPos),distUntilKick=Math.max(distToMark-8,1),desiredPos=setPiece.backupPos.c.scaleAndAdd(goalDir,distUntilKick);kicker.intentTarget=desiredPos.dist(kicker.pos)>=.1?desiredPos:null,(kicker.intentTarget===null||kicker.vel.lenSq()===0)&&(setPiece.state="kick")}else if(setPiece.state==="kick"&&kicker!==game.player){kicker.intent="kickToTarget",kicker.intentVelocity=null;const[intent,target]=findDisposalTarget(game,kicker,teammates,opponents,v3(0,0,-1));target&&(kicker.intent=intent,kicker.intentTarget=target)}if(kicker===game.player&&game.controls){const state=game.controls.state,aimRel=state.aimTarget?oscillateAimTarget(state.aimTarget,performance.now()/1e3,.15,2,kicker.statsKickRange):null,aim=aimRel?kicker.pos.c.add(Vec3.fromArrayXZ(aimRel)):null;if(state.quickDisposePressed){kicker.intentVelocity=null;const[,target]=findDisposalTarget(game,kicker,teammates,opponents,v3(state.moveX,0,state.moveZ),!0);kicker.intent="handball",kicker.intentTarget=target??null}else if(aim&&(state.kickReleased||aim.dist(kicker.pos)>=kicker.statsKickRange))kicker.intent="kickToTarget",kicker.intentTarget=aim,kicker.intentVelocity=null;else if(state.moveX!==0||state.moveZ!==0||state.kickAimActive){const moveVec=v3(state.moveX,0,state.moveZ);kicker.intent="freeKick",moveVec.lenSq()>.01?kicker.intentVelocity=moveVec.normalize().scale(kicker.jogSpeed+kicker.joltSpeed):state.kickAimActive?(setPiece.state,kicker.intentVelocity=goalDir.scale(kicker.jogSpeed)):kicker.intentVelocity=((_a=kicker.jogVel)==null?void 0:_a.c)??null}}const attackersAhead=teammates.filter(a2=>a2!==kicker&&a2.playing).filter(a2=>a2.pos.c.sub(markPos).zeroY().dot(goals[kicker.team].c.sub(markPos).zeroY())>0),leadCandidatesFk=attackersAhead.filter(m=>shouldLeadNow(m,game));setLeadingDirs(leadCandidatesFk,opponents,game);const leadSetFk=new Set(leadCandidatesFk);for(const m of teammates){if(m===kicker)continue;const ahead2=attackersAhead.includes(m),nearMark=m.positionPos.dist(markPos)<15;if(!leadSetFk.has(m))if(ahead2)shouldClearOut(m,game),m.intent="pushBack",m.intentTarget=m.positionPos.c;else if(m.intent="pushBack",nearMark){const lateral=goalDir.c.rotateXZ(Math.random()<.5?Math.PI/2:-Math.PI/2);m.intentTarget=markPos.c.scaleAndAdd(lateral,15)}else m.intentTarget=m.positionPos.c}const otherDefs=opponents.filter(f=>f!==defender),markTargetsFk=inKickRangeOfGoal(kicker)?[...attackersAhead,goals[kicker.team]]:attackersAhead,pairs=greedyMarkAssign(otherDefs,markTargetsFk),used=new Set(pairs.map(([d])=>d));for(const[d,a2]of pairs)d.intent="markUp",a2&&typeof a2=="object"&&"team"in a2?d.intentTarget=a2:a2&&typeof a2=="object"&&"pos"in a2?d.intentTarget=a2.pos:d.intentTarget=a2;const guardCandidates=otherDefs.filter(d=>!used.has(d)&&d.positionPos.dist(markPos)<20),guardCount=Math.min(2,Math.floor(Math.random()*3));for(const g of guardCandidates.slice(0,guardCount)){used.add(g),g.intent="fillSpace";const side=goalDir.c.rotateXZ(Math.random()<.5?Math.PI/2:-Math.PI/2),dist2=10+Math.random()*5;g.intentTarget=markPos.c.scaleAndAdd(side,dist2)}const zoneR=5;for(const d of otherDefs){if(used.has(d))continue;d.intent="fillSpace";let dir=d.pos.c.sub(markPos).zeroY();if(dir.len()<.001&&dir.setFrom(Math.random()-.5,0,Math.random()-.5),dir=dir.normalize(),dir.dot(goalDir)<0){const crossY=dir.cross(goalDir)[1];dir=Math.abs(crossY)<.001?goalDir.c.rotateXZ(Math.random()<.5?Math.PI/2:-Math.PI/2):crossY>0?goalDir.c.rotateXZ(Math.PI/2):goalDir.c.rotateXZ(-Math.PI/2)}const dist2=Math.max(zoneR+1,20);d.intentTarget=markPos.c.scaleAndAdd(dir,dist2)}applyHumanMovementOverride(game,p=>p.team!==kicker.team&&p!==defender)}function decideIntentsAerialContest(ctx){var _a,_b;const{game,ball}=ctx,everyone=[...ctx.home,...ctx.away],ranks=[];for(const p of everyone){if(p.pos[1]>0||game.currentContest&&game.currentContest.type!=="carried"&&p.pos.dist(game.currentContest.point)>40)continue;const r2=computeBestIntercept(p.pos.c,p.statsHeight+.3,p.statsJump,p.jogSpeed+p.joltSpeed,ball.pos,ball.vel,Math.abs(ball.gravity[1]),game.dt),airborne=r2.mode==="apex"||r2.mode==="subApex",t=r2.time??p.pos.dist(ball.pos)/Math.max(p.jogSpeed+p.joltSpeed,1e-6);ranks.push({p,t,fallback:r2.time===void 0,airborne,jump:!!r2.jumpNow,vel:r2.runVel??null,point:r2.point?Vec3.fromArray(r2.point):((_a=game.currentContest)==null?void 0:_a.type)==="aerial"?game.currentContest.point:null,r:r2})}if(ranks.sort((A,B)=>(A.airborne?1:A.fallback?100:10)*A.t-(B.airborne?1:B.fallback?100:10)*B.t),ball.lastTouchedType==="handball"&&Math.abs(ball.vel[1])<2&&ball.lastTouchedBy){const oppBest=ranks.filter(r2=>{var _a2;return r2.p.team!==((_a2=ball.lastTouchedBy)==null?void 0:_a2.team)}).reduce((m,r2)=>Math.min(m,r2.t),1/0),landTimes=timeToGround(ball.pos,ball.vel,Math.abs(ball.gravity[1])),flightTime=landTimes.length?Math.max(...landTimes):0;for(const r2 of ranks){if(r2.p.team!==ball.lastTouchedBy.team)continue;const maxT=Math.min(flightTime,oppBest-.05),speed=r2.p.jogSpeed+r2.p.joltSpeed;for(let t=maxT;t>=r2.t;t-=.1){const pos=getPositionAtTime(ball.pos,ball.vel,ball.gravity,t);if(r2.p.pos.dist(pos)<=speed*t){r2.t=t,r2.point=pos;break}}}ranks.sort((A,B)=>(A.airborne?1:A.fallback?100:10)*A.t-(B.airborne?1:B.fallback?100:10)*B.t)}if(ranks[0]){const first=ranks[0];first.p.intent=first.airborne?first.jump?"jumpMark":"mark":"contestAnyway",first.point&&(first.p.intentTarget=first.point),first.vel&&(first.p.intentVelocity=first.vel)}for(let second of ranks.slice(1)){if(second.p.team===ranks[0].p.team){second.p.intent="contestAnyway",second.p.intentTarget=second.point,second.vel&&(second.p.intentVelocity=second.vel);continue}second.p.intent=second.airborne?second.jump?"jumpSpoil":"spoil":"contestAnyway",second.point&&(second.p.intentTarget=second.point),second.vel&&(second.p.intentVelocity=second.vel);break}for(const r2 of ranks){const p=r2.p;if(p.intent)continue;const landing=r2.point??(((_b=game.currentContest)==null?void 0:_b.type)!=="carried"?game.currentContest.point:null)??ball.pos,dist2=p.pos.dist(landing);if(dist2>25)continue;(p.team==="home"?ctx.home:ctx.away).some(t=>t!==p&&(t.intent==="mark"||t.intent==="jumpMark"))&&(dist2>3&&dist2<10?(p.intent="crumb",p.intentTarget=getCrumbSpot(p,landing)):(p.team==="home"?ctx.away:ctx.home).some(o=>o.pos.dist(landing)<3)&&(p.intent="block",p.intentTarget=landing))}for(const p of everyone){if(p.intent)continue;const foes=p.team==="home"?ctx.away:ctx.home,opp=findClosestOpponent$1(p,foes);opp&&p.pos.dist(opp.pos)<15?(p.intent="markUp",p.intentTarget=opp):(p.intent="fillSpace",p.intentTarget=p.positionPos.c)}applyHumanMovementOverride(game)}function decideIntentsGroundContest(ctx){const{game,ball}=ctx,sortedHome=ctx.home.slice().sort((a2,b)=>a2.pos.dist(ball.pos)/a2.statsSpeed-b.pos.dist(ball.pos)/b.statsSpeed),sortedAway=ctx.away.slice().sort((a2,b)=>a2.pos.dist(ball.pos)/a2.statsSpeed-b.pos.dist(ball.pos)/b.statsSpeed),sorted=[...sortedHome,...sortedAway];for(const p of sorted)p.intent="idle";sortedHome[0]&&(sortedHome[0].intent="gatherLoose",sortedHome[0].intentTarget=ball),sortedAway[0]&&(sortedAway[0].intent="gatherLoose",sortedAway[0].intentTarget=ball);for(const team of[sortedHome,sortedAway])for(const p of team.slice(1,3))p.pos.dist(ball.pos)<10&&(p.intent="supportRun",p.intentTarget=ball.pos.c.add([p.pos[0]<ball.pos[0]?-5:5,0,0]));for(const p of sorted){if(p.intent!=="idle")continue;const foes=p.team==="home"?ctx.away:ctx.home,opp=findClosestOpponent$1(p,foes);opp&&p.pos.dist(opp.pos)<14?(p.intent="markUp",p.intentTarget=opp):(p.intent="fillSpace",p.intentTarget=p.positionPos.c.lerp(ball.pos.c,.3))}applyHumanMovementOverride(game)}function decideIntentsCenterBounce(setPiece,ctx){var _a;const{homeRuck,awayRuck,game}=setPiece;for(let player of[homeRuck,awayRuck])if(player&&setPiece.waitTimer<=0){const result=computeBestIntercept(player.pos.c,player.statsHeight+.3,player.statsJump,player.jogSpeed+player.joltSpeed,game.ball.pos,game.ball.vel,Math.abs(game.ball.gravity[1]),game.dt);player.intent=result.jumpNow||player.pos[1]>0?"jumpRuckTap":"ruckTap",player.intentVelocity=result.runVel??null,player.intentTarget=null}for(let player of[...homeRuck?game.teammatesOf(homeRuck):[],...awayRuck?game.teammatesOf(awayRuck):[]])if(player.intent==="crumb"){const state=game.controls.state;if(player===game.player&&(state.moveX!==0||state.moveZ!==0)){const moveVec=v3(state.moveX,0,state.moveZ);moveVec.lenSq()>.01?player.intentVelocity=moveVec.normalize().scale(player.jogSpeed+player.joltSpeed):player.intentVelocity=((_a=player.jogVel)==null?void 0:_a.c)??null}else{const assignment=setPiece.crumbAssignments.get(player);assignment&&(player.intentTarget=assignment.ruck.pos.c.add(assignment.offset))}}else player.intent="pushBack",player.intentTarget=player.positionPos.c}function decideIntentsBoundaryThrowIn(setPiece,ctx){const game=setPiece.game;for(let player of[setPiece.homeRuck,setPiece.awayRuck])if(player!==null&&setPiece.waitTimer<=0){const result=computeBestIntercept(player.pos.c,player.statsHeight+.3,player.statsJump,player.jogSpeed+player.joltSpeed,game.ball.pos,game.ball.vel,Math.abs(game.ball.gravity[1]),game.dt);player.intent=result.jumpNow||player.pos[1]>0?"jumpRuckTap":"ruckTap",player.intentVelocity=result.runVel??null,player.intentTarget=null}for(let player of[...game.teammatesOf(setPiece.homeRuck),...game.teammatesOf(setPiece.awayRuck)])if(player.intent==="crumb")if(player===game.player&&(game.controls.state.moveX!==0||game.controls.state.moveZ!==0)){const state=game.controls.state,moveVec=v3(state.moveX,0,state.moveZ);player.intent="crumb",player.intentVelocity=moveVec.normalize().scale(player.jogSpeed+player.joltSpeed)}else{const assignment=setPiece.crumbAssignments.get(player);assignment&&(player.intentTarget=assignment.ruck.pos.c.add(assignment.offset))}else player.intent="pushBack",player.intentTarget=player.positionPos.c}class GameStats{constructor(players=[]){this.playerStats=new Map,this.teamTotals={home:this._empty(),away:this._empty()},this.reset(players)}_empty(){return{marks:0,kicks:0,handpasses:0,ruckTaps:0,tackles:0,shepherds:0,goals:0,behinds:0}}reset(players=[]){this.playerStats.clear(),this.teamTotals={home:this._empty(),away:this._empty()};for(const p of players)this.playerStats.set(p,this._empty())}_inc(player,field){const stats=this.playerStats.get(player);stats&&(stats[field]+=1,this.teamTotals[player.team][field]+=1)}recordMark(player){this._inc(player,"marks")}recordKick(player){this._inc(player,"kicks")}recordHandpass(player){this._inc(player,"handpasses")}recordRuckTap(player){this._inc(player,"ruckTaps")}recordTackle(player){this._inc(player,"tackles")}recordShepherd(player){this._inc(player,"shepherds")}recordGoal(player){player&&this._inc(player,"goals")}recordBehind(player){player&&this._inc(player,"behinds")}getTeamTotals(team){return{...this.teamTotals[team]}}getTeamPlayerStats(team){const arr=[];for(const[p,s]of this.playerStats)p.team===team&&arr.push({player:p,stats:s});return arr}}class ContestManager{constructor(){this.type=null,this.point=null,this.time=null,this.source=null,this.carrier=null,this.handTarget=null,this.handTargetPlan=null,this.handTargetDest=null,this.handTargetEta=null,this.tacklers=null,this.outcome=null,this.team=null,this.markPos=null,this.kicker=null,this.defender=null,this.aerialMetadata=null}get current(){return this.type===null?null:this}enterAerial(payload){this._resetFields();const{point,time,source,type="aerial"}=payload;return this.type=type,this.point=point,this.time=time,this.source=source,this}enterGround(payload){this._resetFields();const{point,source,time=null}=payload;return this.type="ground",this.point=point,this.source=source,this.time=time,this}enterCarried(payload){const previousTime=this.time;this._resetFields();const{carrier,handTarget=null,time=null}=payload;return this.type="carried",this.carrier=carrier,this.handTarget=handTarget,this.time=time??previousTime??null,this}updateHandTarget(target,plan=null){return this.type!=="carried"?this.current:(this.handTarget=target,plan?(this.handTargetPlan={destination:plan.destination.c,fallback:plan.fallback.c,flightTime:plan.flightTime,threat:plan.threat,runDirection:plan.runDirection.c},this.handTargetDest=this.handTargetPlan.destination.c,this.handTargetEta=plan.flightTime):(this.handTargetPlan=null,this.handTargetDest=null,this.handTargetEta=null),this)}enterTackled(payload){const previousTime=this.time;this._resetFields();const{carrier,tackler,outcome,time=null}=payload;return this.type="tackled",this.carrier=carrier,this.tacklers=new Set([tackler]),this.outcome=outcome,this.time=time??previousTime??null,this}addTackler(tackler){return this.type!=="tackled"||!this.tacklers?this.current:(this.tacklers.add(tackler),this)}removeTackler(tackler){return this.type!=="tackled"||!this.tacklers?this.current:this.tacklers.has(tackler)?(this.tacklers.delete(tackler),this.tacklers.size===0?(this.clear("tackleResolved"),null):this):this}updateTackleOutcome(outcome){return this.type!=="tackled"?this.current:this.outcome===outcome?this:(this.outcome=outcome,this)}enterOutOfBounds(payload){return this._resetFields(),this.type="outOfBounds",this.point=payload.point,this}enterBehind(payload){return this._resetFields(),this.type="behind",this.point=payload.point,this.team=payload.team,this}enterGoal(payload){return this._resetFields(),this.type="goal",this.point=payload.point,this.team=payload.team,this}enterFreeKick(payload){this._resetFields();const{markPos,kicker,defender}=payload;return this.type="freeKick",this.markPos=markPos,this.kicker=kicker,this.defender=defender,this}clear(reason="manual"){return this._resetFields(),this.type=null,null}resumeOpenPlay(ball,now,hint=null){const contest=this.current;if(ball.carrier){if((contest==null?void 0:contest.type)==="tackled"||(contest==null?void 0:contest.type)==="carried"&&contest.carrier===ball.carrier)return contest;const handTarget=(contest==null?void 0:contest.type)==="carried"&&contest.carrier===ball.carrier?contest.handTarget:null;return this.enterCarried({carrier:ball.carrier,handTarget,time:now})}const source=ball.lastTouchedBy??ball;if(ball.lastTouchedType==="handball"&&this.handTargetDest){const dest=this.handTargetDest.c,eta=this.handTargetEta??0,contest2=this.enterAerial({point:dest,time:now+eta*1e3,source});return this.aerialMetadata={destination:dest.c},contest2}if(hint==="ground")return(contest==null?void 0:contest.type)!=="ground"?this.enterGround({point:ball.pos.c,source,time:now}):contest;const landing=this.predictLanding(ball,now);return landing?this.enterAerial({point:landing.point,time:landing.time,source}):(contest==null?void 0:contest.type)!=="ground"?this.enterGround({point:ball.pos.c,source,time:now}):contest}isBallAirborne(ball){return ball.pos[1]>ball.floorY+.05||Math.abs(ball.vel[1])>.1}predictLanding(ball,now){if(!this.isBallAirborne(ball))return null;const gravity=ball.gravity[1]??-9.8,vy=ball.vel[1],y=ball.pos[1]-ball.floorY,a2=.5*gravity,b=vy,c=y;let tGround=0;const disc=b*b-4*a2*c;if(disc>=0&&Math.abs(a2)>1e-5){const sqrtD=Math.sqrt(disc),t1=(-b+sqrtD)/(2*a2),t2=(-b-sqrtD)/(2*a2);tGround=Math.max(t1,t2)}const landing=ball.pos.c.scaleAndAdd(ball.vel,tGround);return landing[1]=ball.floorY,{point:landing,time:now+tGround}}_resetFields(){this.point=null,this.time=null,this.source=null,this.carrier=null,this.handTarget=null,this.handTargetPlan=null,this.handTargetDest=null,this.handTargetEta=null,this.tacklers=null,this.outcome=null,this.team=null,this.markPos=null,this.kicker=null,this.defender=null,this.aerialMetadata=null}}const uiSpritesUrl="/footy-testing/assets/ui-sprites-CG7LXoNY.png",DELAY_AFTER_STOPPAGE=3;function worldToScreen(worldPos,modelMatrix,viewMatrix,projMatrix,canvas){const mvp=create$3();multiply(mvp,viewMatrix,modelMatrix),multiply(mvp,projMatrix,mvp);const p=fromValues$1(worldPos[0],worldPos[1],worldPos[2],1);return transformMat4(p,p,mvp),p[0]/=p[3],p[1]/=p[3],[(p[0]*.5+.5)*canvas.width,(1-(p[1]*.5+.5))*canvas.height]}App.rules.add("Label",{fontName:"Titillium Web"});App.rules.add("Button",{bgColor:"#222C",outlineColor:"#FFF8",color:"white",fontName:"Titillium Web"});App.rules.add("ToggleButton",{bgColor:"#222C",outlineColor:"#FFF8",color:"white",fontName:"Titillium Web"});class Game extends App{constructor(glCanvas,uiCanvas,spriteSheet){if(super(),this.glCanvas=glCanvas,this.uiCanvas=uiCanvas,this.uiSprites=new SpriteSheet(uiSpritesUrl,16),this.gl=glCanvas.getContext("webgl2",{alpha:!1,preserveDrawingBuffer:!1}),!this.gl)throw new Error("WebGL2 not supported");this.prefDimH=100,this.prefDimW=100,this.contestManager=new ContestManager,this.now=Date.now(),this.canvasName="uicanvas",this.aspectRatio=window.innerWidth/window.innerHeight,this.banner=InGameBanner.a(InGameBanner.props),this.scoreBoard=ScoreBoard.a(ScoreBoard.props),this.continuousFrameUpdates=!0,this.renderer=new Renderer(this.gl,glCanvas,spriteSheet),this.controls=new InputManager(uiCanvas),document.addEventListener("pointerlockchange",()=>this.handlePointerLockChange()),this.setPiece=null,this.trainingSetPiece=null,this.entities=[],this.aimTarget=new AimTarget([5,.001,FIELD_LENGTH$1/2]),this.handAimTarget=new AimTarget([5,.001,FIELD_LENGTH$1/2]),this.handAimTarget.tint=[.2,1,.2,0],this.quarterTime=300,this.ball=new Ball(v3(0,0,FIELD_LENGTH$1/2)),this.entities.push(this.ball),this.players=[],this.homePlayers=[],this.awayPlayers=[],this.player=null,this.chasers=0,this.followers=0,this.homeId=0,this.awayId=1,this.stats=new GameStats,this.queuedEvent=null,this.closestPlayers={home:null,away:null},this.cameraTarget=v3(0,10,FIELD_LENGTH$1/2),this.cameraPos=v3(0,10,FIELD_LENGTH$1/2+15),this.renderer.fovy=45*Math.PI/180,this.resize(),window.addEventListener("resize",()=>this.resize()),this.lastTime=performance.now(),this.gameActive=!1,this.roamAngle=0,this.roamRadius=40,this.entities=[],this.aimTarget=new AimTarget([5,.001,FIELD_LENGTH$1/2]),this.handAimTarget=new AimTarget([5,.001,FIELD_LENGTH$1/2]),this.handAimTarget.tint=[.2,1,.2,0],this.ball=new Ball(v3(0,0,FIELD_LENGTH$1/2)),this.entities.push(this.ball),this.chasers=0,this.followers=0,this.manualSwitchExpiry=0,this.tournament=null,this.tournamentGame=null,this.career=null,this.careerSlot=null,this.careerGame=null,this.dt=1/60,this.baseWidget.children=[MainMenu.a(MainMenu.props)]}get currentContest(){return this.contestManager.current}teammates(team){return team==="home"?this.homePlayers:this.awayPlayers}teammatesOf(player){return player===null?[]:player.team==="home"?this.homePlayers.filter(p=>p!==player):this.awayPlayers.filter(p=>p!==player)}opponentsOf(player){return player.team==="away"?this.homePlayers.slice():this.awayPlayers.slice()}static get(){if(!Game.appInstance)throw Error("Footy has not been initialized.");return Game.appInstance}scheduleEvent(delaySec,action){this.queuedEvent||(this.queuedEvent={time:this.now+delaySec*1e3,action})}on_gameActive(_event,_app,active){var _a,_b;try{const canvas=this.uiCanvas;active?"pointerLockElement"in document&&document.pointerLockElement!==canvas&&((_a=canvas.requestPointerLock())==null||_a.then(()=>{})):"pointerLockElement"in document&&document.pointerLockElement===canvas&&((_b=document.exitPointerLock())==null||_b.then(()=>{}))}catch{}}handlePointerLockChange(){if("pointerLockElement"in document){const canvas=this.uiCanvas;if(document.pointerLockElement===canvas||!this.gameActive)return;this.gameActive=!1,this.baseWidget.addChild(PauseMenu.a(PauseMenu.props))}}randomMatchup(){setPRNG("mulberry32"),setSeed(stringToSeed(`DATE ${Date.now()}`));for(let i=0;i<1e3;++i)getRandomInt(20);const homeId=getRandomInt(18);let awayId=getRandomInt(18);for(;homeId===awayId;)awayId=getRandomInt(18);return[homeId,awayId]}setupGame(homeId,awayId,quarterTime){this.baseWidget.children=[this.banner,FPS.a({hints:{bottom:1,x:0,w:1,h:.05},align:"right"})],this.scoreBoard.hints={...ScoreBoard.props.hints},this.scoreBoard.resetScores(),(homeId===null||awayId===null)&&([homeId,awayId]=this.randomMatchup()),this.homeId=homeId,this.awayId=awayId,this.quarterTime=quarterTime?quarterTime*60:300,this.roamAngle=0,this.roamRadius=40,this.setPiece=null,this.trainingSetPiece=null,this.entities=[],this.aimTarget=new AimTarget([5,.001,FIELD_LENGTH$1/2]),this.handAimTarget=new AimTarget([5,.001,FIELD_LENGTH$1/2]),this.handAimTarget.tint=[.2,1,.2,0],this.ball=new Ball(v3(0,0,FIELD_LENGTH$1/2)),this.entities.push(this.ball),this.players=[],this.homePlayers=[],this.awayPlayers=[],this.player=null,this.chasers=0,this.followers=0;const homePositions=generateFieldPositions(),awayPositions=generateFieldPositions(!0),getRoster=id=>{if(this.tournament){const t=this.tournament.teams[id];if(t&&t.roster)return t.roster}if(this.career){const c=this.career.teams.find(t=>t.id===id);if(c&&c.roster)return c.roster}return null},teamPositions=[[homePositions,"home",homeId],[awayPositions,"away",awayId]];for(let[positions,team,teamId]of teamPositions){const roster=getRoster(teamId);for(const[position,pos]of Object.entries(positions)){let stats;roster&&(stats=roster.find(p=>p.position===position)),stats||(stats=new PlayerStats(position));const player=new Player(position,team,teamId,pos,stats,!position.toLowerCase().startsWith("bench"));this.entities.push(player),this.players.push(player),player.playing&&(team==="home"?this.homePlayers.push(player):this.awayPlayers.push(player)),this.baseWidget.addChild(player.label),position==="RR"&&team==="home"&&(this.player=player)}}this.stats=new GameStats(this.players),this.banner.homeName=teamAbbrevs[homeId],this.banner.awayName=teamAbbrevs[awayId],this.banner.timeLeft=this.quarterTime,this.banner.quarter=1,this.banner.resetScores(),this.closestPlayers={home:null,away:null},this.contestManager.enterGround({point:this.ball.pos.c,source:this.ball,time:this.now}),audio.horn.play(),this.setPiece=new CenterBounceSetPiece(this),this.cameraTarget.setFrom(0,10,FIELD_LENGTH$1/2),this.gameActive=!0,this.manualSwitchExpiry=0}setupTraining(homeId,awayId,quarterTime,trainingType="kicking"){if(this.queuedEvent=null,this.baseWidget.children=[this.banner,FPS.a({hints:{bottom:1,x:0,w:1,h:.05},align:"right"})],this.scoreBoard.hints={...ScoreBoard.props.hints},this.scoreBoard.resetScores(),(homeId===null||awayId===null)&&([homeId,awayId]=this.randomMatchup()),this.homeId=homeId,this.awayId=awayId,this.quarterTime=quarterTime?quarterTime*60:300,this.roamAngle=0,this.roamRadius=40,this.setPiece=null,this.entities=[],this.aimTarget=new AimTarget([5,.001,0]),this.handAimTarget=new AimTarget([5,.001,0]),this.handAimTarget.tint=[.2,1,.2,0],this.ball=new Ball(v3(0,0,FIELD_LENGTH$1-1)),this.entities.push(this.ball),this.players=[],this.player=null,this.chasers=0,this.followers=0,trainingType==="kicking"){const player1=new Player("player1","home",homeId,v3(0,0,FIELD_LENGTH$1-1),new PlayerStats("player1"),!0),player2=new Player("player2","home",homeId,v3(0,0,FIELD_LENGTH$1*3/4),new PlayerStats("player2"),!0),player3=new Player("player3","home",homeId,v3(1,0,FIELD_LENGTH$1/2),new PlayerStats("player3"),!0),player4=new Player("player4","home",homeId,v3(1,0,FIELD_LENGTH$1/4),new PlayerStats("player4"),!0);this.players=[player1,player2,player3,player4],this.player=player1}else if(trainingType==="handpass"){const player1=new Player("player1","home",homeId,v3(0,0,FIELD_LENGTH$1-1),new PlayerStats("player1"),!0),player2=new Player("player2","home",homeId,v3(10,0,FIELD_LENGTH$1*11/12),new PlayerStats("player2"),!0),player3=new Player("player3","home",homeId,v3(20,0,FIELD_LENGTH$1*10/12),new PlayerStats("player3"),!0),player4=new Player("player4","home",homeId,v3(10,0,FIELD_LENGTH$1*9/12),new PlayerStats("player4"),!0),player5=new Player("player5","home",homeId,v3(0,0,FIELD_LENGTH$1*8/12),new PlayerStats("player5"),!0),player6=new Player("player6","home",homeId,v3(-10,0,FIELD_LENGTH$1*7/12),new PlayerStats("player6"),!0),player7=new Player("player7","home",homeId,v3(-20,0,FIELD_LENGTH$1*6/12),new PlayerStats("player7"),!0),player8=new Player("player8","home",homeId,v3(-10,0,FIELD_LENGTH$1*5/12),new PlayerStats("player8"),!0),player9=new Player("player9","home",homeId,v3(0,0,FIELD_LENGTH$1*4/12),new PlayerStats("player9"),!0),player10=new Player("player10","home",homeId,v3(10,0,FIELD_LENGTH$1*3/12),new PlayerStats("player10"),!0),player11=new Player("player11","home",homeId,v3(20,0,FIELD_LENGTH$1*2/12),new PlayerStats("player11"),!0),player12=new Player("player12","home",homeId,v3(10,0,FIELD_LENGTH$1*1/12),new PlayerStats("player12"),!0);this.players=[player1,player2,player3,player4,player5,player6,player7,player8,player9,player10,player11,player12],this.player=player1}else if(trainingType==="tutorial"){const player1=new Player("player1","home",homeId,v3(0,0,FIELD_LENGTH$1-1),new PlayerStats("player1"),!0);this.players=[player1],this.player=player1}this.homePlayers=[],this.awayPlayers=[];for(const p of this.players)p.positionPos.copyFrom(p.pos),this.entities.push(p),this.baseWidget.addChild(p.label),p.team==="home"&&this.homePlayers.push(p),p.team==="away"&&this.awayPlayers.push(p);this.stats=new GameStats(this.players),this.banner.homeName=teamAbbrevs[homeId],this.banner.awayName=teamAbbrevs[awayId],this.banner.timeLeft=this.quarterTime,this.banner.quarter=1,this.scoreBoard.resetScores(),this.scoreBoard.homeName=this.banner.homeName,this.scoreBoard.awayName=this.banner.awayName,this.closestPlayers={home:null,away:null},this.contestManager.enterGround({point:this.ball.pos.c,source:this.ball,time:this.now}),this.cameraTarget.setFrom(0,10,FIELD_LENGTH$1),this.trainingSetPiece=trainingType==="kicking"?new TrainingKicking(this):trainingType==="handpass"?new TrainingHandpass(this):trainingType==="tutorial"?new GeneralOverviewTutorial(this):null,this.gameActive=!0,this.manualSwitchExpiry=0}update(){this._udpateActive=!0,this.now=Date.now();const dt0=(this.now-this.lastTime)/1e3,dt=Math.min(dt0,1/30);if(this.dt=dt,this.queuedEvent&&this.now>=this.queuedEvent.time){const ev=this.queuedEvent;this.queuedEvent=null,ev.action()}if(this.gameActive){this.controls.update(dt),this.updateBallContest(),this.updateClosestPlayers(),this.updatePlayerIntents();const before=this.ball.pos.c;for(const entity of this.entities){entity.update(dt,this);for(let p of this.players)if(p===this.ball.carrier||this.player===p){const[x,y]=worldToScreen(p.pos,create$3(),this.renderer.view,this.renderer.projection,this.uiCanvas);p.label.center_x=x/this.tileSize,p.label.y=y/this.tileSize,p.label.text=`${p.name.split(" ").at(-1)} (${p.position})`}else p.label.text!==""&&(p.label.text="")}this.trainingSetPiece&&this.trainingSetPiece.update(dt),this.setPiece&&(this.setPiece.update(dt),this.setPiece.finished&&(this.setPiece=null)),this.checkTimeAndBoundary(dt,before),this.updateCamera(),this.updatePlayerControl(),this.renderer.renderScene(this,this.entities),this.controls.state.menuPressed&&(this.baseWidget.addChild(PauseMenu.a(PauseMenu.props)),this.gameActive=!1),this.controls.endUpdate()}else{{const t=this.now/5e4,flyX=Math.sin(t)*50,flyZ=FIELD_LENGTH$1/2+Math.sin(t*2)*50,lookAhead=4,lookX=Math.sin(t+lookAhead*.05)*50,lookZ=FIELD_LENGTH$1/2+Math.sin((t+lookAhead*.05)*2)*50;this.cameraPos.setFrom(flyX,10,flyZ),this.cameraTarget.setFrom(lookX,9,lookZ)}this.renderer.renderScene(this,[]),this.controls.update(dt),this.controls.state.menuPressed&&this.baseWidget.children.some(w=>w instanceof PauseMenu)&&(this.baseWidget.children=this.baseWidget.children.filter(w=>!(w instanceof PauseMenu)),this.gameActive=!0),this.controls.endUpdate()}super.update(),this.lastTime=this.now}endGame(showScore=!1,forfeit=!1){const tourCtx=this.tournamentGame,careerCtx=this.careerGame;if(this.career){const homeTeam=this.career.teams.find(t=>t.id===this.homeId),awayTeam=this.career.teams.find(t=>t.id===this.awayId);awardExperienceForTeam(this.career,homeTeam,1,!!homeTeam&&homeTeam.id===this.career.playerTeamId),awardExperienceForTeam(this.career,awayTeam,1,!!awayTeam&&awayTeam.id===this.career.playerTeamId)}if(this.gameActive=!1,this.entities=[],this.players=[],this.setPiece=null,this.player=null,tourCtx&&this.tournament){const t=this.tournament,match=t.finals[t.finalsIndex].results[tourCtx.matchIndex],data=this.scoreBoard.getData();tourCtx.playerIsHome?(match.homeGoals=data.home.g,match.homeBehinds=data.home.b,match.homeScore=forfeit?-1:data.home.t,match.awayGoals=data.away.g,match.awayBehinds=data.away.b,match.awayScore=data.away.t):(match.homeGoals=data.away.g,match.homeBehinds=data.away.b,match.homeScore=data.away.t,match.awayGoals=data.home.g,match.awayBehinds=data.home.b,match.awayScore=forfeit?-1:data.home.t),this.tournamentGame=null,this.baseWidget.children=[TournamentSummary.a(TournamentSummary.props)]}else if(careerCtx&&this.career){const c=this.career;if(c.isFinals){const match=c.finals[c.finalsIndex].results[careerCtx.matchIndex],data=this.scoreBoard.getData();forfeit&&(match.homeScore=-1),careerCtx.playerIsHome?(match.homeScore=forfeit?-1:data.home.t,match.homeGoals=data.home.g,match.homeBehinds=data.home.b,match.awayScore=data.away.t,match.awayGoals=data.away.g,match.awayBehinds=data.away.b):(match.homeScore=data.away.t,match.homeGoals=data.away.g,match.homeBehinds=data.away.b,match.awayScore=forfeit?-1:data.home.t,match.awayGoals=data.home.g,match.awayBehinds=data.home.b)}else{const roundRes=c.results[careerCtx.round],match=roundRes[careerCtx.matchIndex],data=this.scoreBoard.getData();forfeit&&(match.homeScore=-1),careerCtx.playerIsHome?(match.homeScore=forfeit?-1:data.home.t,match.homeGoals=data.home.g,match.homeBehinds=data.home.b,match.awayScore=data.away.t,match.awayGoals=data.away.g,match.awayBehinds=data.away.b):(match.homeScore=data.away.t,match.homeGoals=data.away.g,match.homeBehinds=data.away.b,match.awayScore=forfeit?-1:data.home.t,match.awayGoals=data.home.g,match.awayBehinds=data.home.b),c.results[careerCtx.round]=roundRes}c.advanceRound(),saveSlot(careerCtx.slot,c),this.careerGame=null;const viewRound=c.round-1;this.baseWidget.children=[CareerMatches.a({...CareerMatches.props,viewRound})]}else this.baseWidget.children=[showScore?a(EndQuarterMenu,EndQuarterMenu.props):MainMenu.a(MainMenu.props)]}checkTimeAndBoundary(dt,before){var _a,_b;if(!this.queuedEvent){if(this.banner.timeLeft-=dt,this.banner.timeLeft<=0){this.banner.timeLeft=0,audio.horn.play(),this.scheduleEvent(DELAY_AFTER_STOPPAGE,()=>{this.gameActive=!1,this.baseWidget.addChild(a(EndQuarterMenu,EndQuarterMenu.props))});return}if(!this.setPiece){let crossing=checkBoundaryCrossing(before,this.ball.pos);if(this.ball.postCollision&&(crossing=this.ball.postCollision,this.ball.postCollision=null),crossing!==null){if(crossing==="outOfBounds"&&this.ball.lastTouchedType==="kick"&&!this.ball.hasBounced&&this.ball.lastTouchedBy){const freeTeam=this.ball.lastTouchedBy.team==="home"?"away":"home";let kicker=null,minDist=1/0;for(const p of this.players)if(p.team===freeTeam&&p.playing){const d=p.pos.dist(this.ball.pos);d<minDist&&(minDist=d,kicker=p)}if(kicker){const boundaryPoint=boundaryIntersection(this.ball.pos.c),markPos=Vec3.fromArray(boundaryPoint).zeroY(),startPos=markPos.c;this.banner.commentary("OUT ON THE FULL",freeTeam),this.scheduleEvent(DELAY_AFTER_STOPPAGE,()=>{this.setPiece=new FreeKickSetPiece(this,kicker,markPos.c,startPos)}),crossing=null;return}}if(crossing==="goalAway"&&(this.ball.carrier||this.ball.lastTouchedType!=="kick"||((_a=this.ball.lastTouchedBy)==null?void 0:_a.team)==="home")?crossing="behindAway":crossing==="goalHome"&&(this.ball.carrier||this.ball.lastTouchedType!=="kick"||((_b=this.ball.lastTouchedBy)==null?void 0:_b.team)==="away")?crossing="behindHome":crossing==="outerLeftPostAway"||crossing==="outerRightPostAway"||crossing==="innerLeftPostAway"||crossing==="innerRightPostAway"?crossing="behindAway":(crossing==="outerLeftPostHome"||crossing==="outerRightPostHome"||crossing==="innerLeftPostHome"||crossing==="innerRightPostHome")&&(crossing="behindHome"),crossing==="behindAway"){this.banner.awayBehind+=1,this.ball.lastTouchedBy&&this.stats.recordBehind(this.ball.lastTouchedBy),this.contestManager.enterBehind({team:"away",point:this.ball.pos.c});const kicker=this.players.find(p=>p.position==="FB"&&p.team==="home");kicker&&(this.banner.commentary("BEHIND","away"),this.scheduleEvent(DELAY_AFTER_STOPPAGE,()=>{kicker.pos.copyFrom(goals.away),this.setPiece=new FreeKickSetPiece(this,kicker,v3(0,0,FIELD_LENGTH$1-15),goals.away)}));return}if(crossing==="behindHome"){this.banner.homeBehind+=1,this.ball.lastTouchedBy&&this.stats.recordBehind(this.ball.lastTouchedBy),this.contestManager.enterBehind({team:"home",point:this.ball.pos.c});const kicker=this.players.find(p=>p.position==="FB"&&p.team==="away");kicker&&(this.banner.commentary("BEHIND","home"),this.scheduleEvent(DELAY_AFTER_STOPPAGE,()=>{kicker.pos.copyFrom(goals.home),this.setPiece=new FreeKickSetPiece(this,kicker,v3(0,0,15),goals.home)}));return}if(crossing==="goalAway"||crossing==="goalHome"||crossing==="outOfBounds"){if(crossing==="goalAway"&&(this.contestManager.enterGoal({team:"away",point:this.ball.pos.c}),this.banner.awayGoal+=1,this.ball.lastTouchedBy&&this.stats.recordGoal(this.ball.lastTouchedBy)),crossing==="goalHome"&&(this.contestManager.enterGoal({team:"home",point:this.ball.pos.c}),this.banner.homeGoal+=1,this.ball.lastTouchedBy&&this.stats.recordGoal(this.ball.lastTouchedBy)),crossing==="goalAway"||crossing==="goalHome"){const team=crossing==="goalAway"?"away":"home";this.trainingSetPiece instanceof GeneralOverviewTutorial?(this.banner.commentary("GOAL! Tutorial complete.",team),this.gameActive=!1,this.trainingSetPiece=null,this.setPiece=null,this.baseWidget.children=[TrainingMenu.a(TrainingMenu.props)]):(this.banner.commentary("GOAL!",team),this.scheduleEvent(DELAY_AFTER_STOPPAGE,()=>{this.setPiece=new CenterBounceSetPiece(this)}))}else if(crossing==="outOfBounds"){this.contestManager.enterOutOfBounds({point:this.ball.pos.c}),this.banner.commentary("OUT OF BOUNDS");const ballpos=this.ball.pos.c;this.scheduleEvent(DELAY_AFTER_STOPPAGE,()=>{this.setPiece=new BoundaryThrowInSetPiece(this,ballpos)})}return}}else if(this.ball.hasBounced&&isOutOfBounds(this.ball.pos))if(this.ball.lastTouchedBy!==null&&this.ball.lastTouchedType==="kick"){const team=this.ball.lastTouchedBy.team==="away"?"home":"away",kicker=this.closestPlayers[team];if(kicker!==null){const ballPos=boundaryIntersection((this.ball.lastTouchedAt??this.ball.pos).c);this.contestManager.enterOutOfBounds({point:Vec3.fromArray(ballPos)}),this.banner.commentary("FREE KICK",team),this.scheduleEvent(DELAY_AFTER_STOPPAGE,()=>{this.setPiece=new FreeKickSetPiece(this,kicker,Vec3.fromArray(ballPos))})}}else{const ballPos=boundaryIntersection((this.ball.lastTouchedAt??this.ball.pos).c);this.contestManager.enterOutOfBounds({point:Vec3.fromArray(ballPos)}),this.banner.commentary("OUT OF BOUNDS"),this.scheduleEvent(DELAY_AFTER_STOPPAGE,()=>{this.setPiece=new BoundaryThrowInSetPiece(this,Vec3.fromArray(ballPos))})}}}}updateClosestPlayers(){const ball=this.ball,closest={home:1/0,away:1/0},closestPlayers={home:null,away:null};for(let p of this.players){if(!p.playing||p===ball.carrier)continue;const candidate=p.pos.dist(ball.pos);candidate<closest[p.team]&&(closest[p.team]=candidate,closestPlayers[p.team]=p)}this.closestPlayers=closestPlayers}updatePlayerIntents(){decideIntents(this)}updateBallContest(){const ball=this.ball;let contest=this.currentContest;if(!(contest&&(contest.type==="goal"||contest.type==="behind"||contest.type==="outOfBounds"))){if((contest==null?void 0:contest.type)==="freeKick"){if(this.setPiece instanceof FreeKickSetPiece)return;contest=null}(contest==null?void 0:contest.type)!=="tackled"&&this.contestManager.resumeOpenPlay(ball,this.now)}}updatePlayerControl(){var _a;const carrier=this.ball.carrier,state=this.controls.state,activePlayer=this.player,humanTeam=activePlayer?activePlayer.team:"home",teamPlayers=humanTeam==="home"?this.homePlayers:this.awayPlayers,manualHoldActive=this.now<this.manualSwitchExpiry;if(state.switchPressed&&teamPlayers.length>0){const targetPos=((_a=this.currentContest)==null?void 0:_a.point)??(this.ball.carrier?this.ball.carrier.pos:this.ball.pos),origin=activePlayer?activePlayer.pos:targetPos,direction=fromValues$2(state.moveX,0,state.moveZ);let dirMag=length(direction);dirMag>.001?scale(direction,direction,1/dirMag):dirMag=0;const offset=create$2(),offsetNorm=create$2();let bestCandidate=null,bestScore=1/0;for(const teammate of teamPlayers){if(!teammate.playing||teammate===activePlayer||teammate.actionState==="tackle"||teammate.intent==="ruckTap"||teammate.intent.startsWith("jump"))continue;const distanceToTargetSq=squaredDistance(teammate.pos,targetPos);set(offset,teammate.pos[0]-origin[0],0,teammate.pos[2]-origin[2]);const fromOriginSq=squaredLength(offset);let score=distanceToTargetSq+fromOriginSq*.25;if(dirMag>0&&fromOriginSq>1e-4){scale(offsetNorm,offset,1/Math.sqrt(fromOriginSq));const align=Math.max(-1,Math.min(1,dot(direction,offsetNorm)));score+=(1-align)*20}this.ball.carrier&&this.ball.carrier===teammate&&(score-=25),score<bestScore&&(bestScore=score,bestCandidate=teammate)}if(bestCandidate&&bestCandidate!==activePlayer&&(this.player=bestCandidate),bestCandidate){this.manualSwitchExpiry=this.now+400;return}}if(this.currentContest&&!["carried","carrierHome","carrierAway"].includes(this.currentContest.type??""))return;if(!carrier){if(Math.abs(state.moveX)>0||Math.abs(state.moveZ)>0||manualHoldActive)return;let best2=null,bestDistSq2=activePlayer?activePlayer.pos.distSq(this.ball.pos)-100:1/0;for(const teammate of teamPlayers){if(!teammate.playing||teammate.actionState==="tackle"||teammate.intent==="ruckTap"||teammate.intent.startsWith("jump"))continue;const distSq=squaredDistance(teammate.pos,this.ball.pos),bias=(Math.abs(teammate.positionPos[0]-this.ball.pos[0])<10?-10:0)+(teammate.energy<.3?-5:0)+(teammate.pos[2]>this.ball.pos[2]?-10:0);distSq+bias<bestDistSq2&&(best2=teammate,bestDistSq2=distSq+bias)}best2&&best2!==activePlayer&&(this.player=best2);return}if(carrier.team===humanTeam){this.player!==carrier&&this.player!==null&&(this.player=carrier),this.manualSwitchExpiry=0;return}if(manualHoldActive)return;let best=null,bestDistSq=1/0;for(const teammate of teamPlayers){if(!teammate.playing||teammate.actionState==="tackle")continue;const distSq=squaredDistance(teammate.pos,carrier.pos),bias=(Math.abs(teammate.positionPos[0]-this.ball.pos[0])<10?-10:0)+(teammate.energy<.3?-5:0)+(teammate.pos[2]>carrier.pos[2]?-10:0);distSq+bias<bestDistSq&&(best=teammate,bestDistSq=distSq+bias)}best&&best!==this.player&&(this.player=best)}updateCamera(opts={}){var _a;const{baseHeight=10,pullback=25,heightAdjust=-5,pullbackAdjust=10,maxAspect=1.5,ndcBiasHome=.75,ndcBiasAway=0,lateralHeightAdjust=10,lateralPullbackAdjust=20,lateralFollowRatio=.5}=opts,ball=this.ball,carrier=ball.carrier,aspect=this.glCanvas.width/this.glCanvas.height,fovY=this.renderer.fovy,setPieceTarget=(_a=this.setPiece)==null?void 0:_a.cameraTarget(),aspectDelta=maxAspect-Math.min(aspect,maxAspect),baseTarget=setPieceTarget?setPieceTarget instanceof Entity?setPieceTarget.pos:setPieceTarget:carrier?carrier.team==="home"?carrier.pos.c.zeroY().add([0,0,aspectDelta*pullbackAdjust/2]):carrier.pos.c.zeroY().add([0,0,Math.max(0,Math.min(20+aspectDelta*pullbackAdjust/2,FIELD_LENGTH$1+5-carrier.pos.z))]):ball.vel[2]<=0?ball.pos.c.zeroY().add([0,0,aspectDelta*pullbackAdjust/2]):ball.pos.c.zeroY().add([0,0,Math.max(0,Math.min(10+aspectDelta*pullbackAdjust/2,FIELD_LENGTH$1+5-ball.pos.z))]);let cameraHeight=baseHeight-aspectDelta*heightAdjust+.75*Math.max(baseTarget.z-FIELD_LENGTH$1+10,0),cameraBack=pullback+aspectDelta*pullbackAdjust;const lateral=Math.min(1,Math.abs(baseTarget[0])/FIELD_RADIUS_X$1);cameraHeight+=lateral*lateralHeightAdjust,cameraBack+=lateral*lateralPullbackAdjust;const isHomeWithBall=!!carrier&&carrier.team==="home",desiredNDC_Y=isHomeWithBall?ndcBiasHome:ndcBiasAway,verticalBias=Math.tan(fovY/2)*cameraBack*desiredNDC_Y,targetX=baseTarget[0],halfFovX=Math.atan(Math.tan(fovY/2)*aspect),depth=Math.max(.001,cameraBack-verticalBias),halfWidthAtSubject=Math.tan(halfFovX)*depth,lo=Math.max(-FIELD_RADIUS_X$1,targetX-halfWidthAtSubject),hi=Math.min(FIELD_RADIUS_X$1,targetX+halfWidthAtSubject),lookX=Math.max(lo,Math.min(hi,lateralFollowRatio*(targetX+(isHomeWithBall?10*this.controls.state.moveX:0)))),lookTarget=baseTarget.c;lookTarget.setFrom(lookX,baseTarget[1],baseTarget[2]-verticalBias),lookTarget.z=Math.max(-1,Math.min(FIELD_LENGTH$1+1,lookTarget.z));const dist2=this.cameraTarget.dist(lookTarget),CAM_SPEED=Math.max(1/(1+3*dist2),.05);this.cameraTarget.lerp(lookTarget,CAM_SPEED*this.dt/.016),this.cameraPos=this.cameraTarget.c.add([0,cameraHeight,cameraBack])}resize(){this.glCanvas.width=window.innerWidth,this.glCanvas.height=window.innerHeight;const aspect=window.innerWidth/window.innerHeight;this.aspectRatio=aspect;const baseFov=45*Math.PI/180,maxFov=85*Math.PI/180,fovScale=Math.max(0,(1.777-aspect)/1);this.renderer.fovy=baseFov+fovScale*(maxFov-baseFov),this.renderer.updateProjection(),this.banner.updateLayout()}}const spriteSheetUrl="/footy-testing/assets/spritesheet-Dkd2tOiz.png";function main(spriteSheet){const uiCanvas=document.getElementById("uicanvas");if(!uiCanvas)throw console.error("UI Canvas element not found"),new Error("UI Canvas element not found");const glCanvas=document.getElementById("glcanvas");if(!glCanvas)throw console.error("WebGL2 Canvas element not found"),new Error("WebGL2 Canvas element not found");new Game(glCanvas,uiCanvas,spriteSheet).start()}function loadFont(){return document.fonts.load('10px "Titillium Web"').then(value=>document.fonts.ready)}Promise.all([loadImage(spriteSheetUrl),loadFont()]).then(([image])=>{if(!image.complete)throw console.error("Failed to load sprite sheet"),new Error("Sprite sheet not loaded");main(image)}).catch(err=>{console.error("Initialization failed:",err)});
