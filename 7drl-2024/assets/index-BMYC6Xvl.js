(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&e(n)}).observe(document,{childList:!0,subtree:!0});function i(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function e(s){if(s.ep)return;s.ep=!0;const r=i(s);fetch(s.href,r)}})();class vt{_seed=0;random(){return Math.random()}seed(t){}getRandomInt(t,i=0){return i!=0?t+Math.floor(this.random()*(i-t)):Math.floor(this.random()*t)}getRandomPos(t,i){return[this.getRandomInt(t),this.getRandomInt(i)]}randomRange(t,i){return Math.floor(this.random()*(i-t+1))+t}randomFloat(t=0,i=1){return this.random()*(i-t)+t}shuffle(t){let i,e;for(let s=1;s<t.length;s++)e=this.randomRange(0,s),i=t[s],t[s]=t[e],t[e]=i;return t}choose(t){return t[Math.floor(this.random()*t.length)]}chooseN(t,i){let e=new Array(i),s=t.length,r=new Array(s);if(i>s)throw new RangeError("chooeN: more elements requested than available");for(;i--;){let n=Math.floor(this.random()*s);e[i]=t[n in r?r[n]:n],r[n]=--s in r?r[s]:s}return e}}function at(h,t,i,e){return function(){h>>>=0,t>>>=0,i>>>=0,e>>>=0;var s=h+t|0;return h=t^t>>>9,t=i+(i<<3)|0,i=i<<21|i>>>11,e=e+1|0,s=s+e|0,i=i+s|0,(s>>>0)/4294967296}}class pt extends vt{_seed=1;d=3735928559;xorSeed=Math.floor(Date.now())^this.d;random=at(2654435769,608135816,3084996962,this.xorSeed);seed(t){this._seed=t,this.xorSeed=t^this.d,this.random=at(2654435769,608135816,3084996962,this.xorSeed)}}var gt=new pt;function Ct(h,t){return gt.getRandomPos(h,t)}function Mt(h=0,t=1){return gt.randomFloat(h,t)}function j(h,t){return new w([h,t])}function W(h){return new w(h)}class w extends Array{constructor(t=[0,0]){super(),this[0]=t[0],this[1]=t[1]}equals(t){return this.length===t.length&&this[0]===t[0]&&this[1]===t[1]}static random(t){return new w(Ct(t[0],t[1]))}add(t){return new w([this[0]+t[0],this[1]+t[1]])}sub(t){return new w([this[0]-t[0],this[1]-t[1]])}scale(t){return new w([this[0]*t,this[1]*t])}mul(t){return new w([this[0]*t[0],this[1]*t[1]])}div(t){return new w([this[0]/t[0],this[1]/t[1]])}dot(t){return this[0]*t[0]+this[1]*t[1]}dist(t){return Math.hypot(this[0]-t[0],this[1]-t[1])}abs(){return new w([Math.abs(this[0]),Math.abs(this[1])])}sum(){return this[0]+this[1]}relativeTo(t){return this.sub(t.pos).div(t.size)}absoluteFrom(t){return this.mul(t.size).add(t.pos)}relativeToPS(t,i){return this.sub(t).scale(1/i)}absoluteFromPS(t,i){return this.scale(i).add(t)}set x(t){this[0]=t}set y(t){this[1]=t}get x(){return this[0]}get y(){return this[1]}}class v extends Array{constructor(t=null){if(super(),t===null){this[0]=0,this[1]=0,this[2]=0,this[3]=0;return}this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3]}set x(t){this[0]=t}set y(t){this[1]=t}set w(t){this[2]=t}set h(t){this[3]=t}set pos(t){this[0]=t[0],this[1]=t[1]}set size(t){this[2]=t[2],this[3]=t[3]}get size(){return new w([this[2],this[3]])}get pos(){return new w([this[0],this[1]])}get x(){return this[0]}get y(){return this[1]}get w(){return this[2]}get h(){return this[3]}get right(){return this[0]+this[2]}get bottom(){return this[1]+this[3]}get center_x(){return this[0]+this[2]/2}get center_y(){return this[1]+this[3]/2}get center(){return new w([this.center_x,this.center_y])}grow(t){return new v([this[0]-t,this[1]-t,this[2]+2*t,this[3]+2*t])}get flooredCenter(){return new w([Math.floor(this[0]+this[2]/2),Math.floor(this[1]+this[3]/2)])}translate(t){return new v([this.x+t[0],this.y+t[1],this.w,this.h])}shrinkBorders(t){return new v([this.x+t,this.y+t,this.w-t*2,this.h-t*2])}scaleBorders(t){return new v([this.x+this.w*(1-t)/2,this.y+this.h*(1-t)/2,this.w*t,this.h*t])}mult(t){return new v([this[0]*t,this[1]*t,this[2]*t,this[3]*t])}multXY(t){return new v([this[0]*t[0],this[1]*t[1],this[2]*t[0],this[3]*t[1]])}scale(t,i=!0){if(i){let e=[this[2]*t,this[3]*t];return new v([this[0]+.5*(this[2]-e[0]),this[1]+.5*(this[3]-e[1]),e[0],e[1]])}else{let e=[this[2]*t,this[3]*t];return new v([this[0],this[1],e[0],e[1]])}}collideRadius(t,i=null){let e=[this.center_x-t.center_x,this.center_y-t.center_y];return i===null&&(i=Math.min(this.w,this.h,t.w,t.h)/2),e[0]*e[0]+e[1]*e[1]<i*i}collide(t){return this.x<t.x+t.w&&this.x+this.w>t.x&&this.y<t.y+t.h&&this.h+this.y>t.y}contains(t){return this.x<=t.x&&this.y<=t.y&&this.x+this.w>=t.x+t.w&&this.y+this.h>=t.y+t.h}contact(t){return this.x<=t.x+t.w&&this.x+this.w>=t.x&&this.y<=t.y+t.h&&this.h+this.y>=t.y}contactRadius(t,i=null){let e=[this.center_x-t.center_x,this.center_y-t.center_y];return i===null&&(i=Math.min(this.w,this.h,t.w,t.h)),e[0]*e[0]+e[1]*e[1]<=i*i}}class X extends Array{constructor(t=[0,0]){super(t[0]*t[1]),this.tileDim=new w(t),this.hidden=!1,this._cacheData=null}get(t){return this[t[0]+t[1]*this.tileDim[0]]}set(t,i){this[t[0]+t[1]*this.tileDim[0]]=i}*iterBetween(t,i,e=0){var s,r,n,l;if([s,r]=t,[n,l]=i,!(Math.abs(l-r)==0&&Math.abs(n-s)==0))if(Math.abs(l-r)>Math.abs(n-s)){var a=(n-s)/(l-r);if(r>l)for(var o=r;o>=l;o--){var u=s+(o-r)*a;yield[u,o]}else for(var o=r;o<=l;o++){var u=s+(o-r)*a;yield[u,o]}}else{var a=(l-r)/(n-s);if(s>n)for(var d=s;d>=n;d--){var f=r+(d-s)*a;yield[d,f]}else for(var d=s;d<=n;d++){var f=r+(d-s)*a;yield[d,f]}}}*iterInBetween(t,i){var e,s,r,n;if([e,s]=t,[r,n]=i,!(Math.abs(n-s)==0&&Math.abs(r-e)==0))if(Math.abs(n-s)>Math.abs(r-e)){var l=(r-e)/(n-s);if(s>n)for(var a=s-1;a>n;a--){var o=Math.round(e+(a-s)*l);yield[o,a]}else for(var a=s+1;a<n;a++){var o=Math.round(e+(a-s)*l);yield[o,a]}}else{var l=(n-s)/(r-e);if(e>r)for(var o=e-1;o>r;o--){var a=Math.round(s+(o-e)*l);yield[o,a]}else for(var o=e+1;o<r;o++){var a=Math.round(s+(o-e)*l);yield[o,a]}}}*iterTypesBetween(t,i,e){for(var s of this.iterBetween(t,i))e.includes(this.get(s))&&(yield s)}*iterTypesInBetween(t,i,e){for(var s of this.iterInBetween(t,i))e.includes(this.get(s))&&(yield s)}hasTypesBetween(t,i,e){for(var s of this.iterTypesBetween(t,i,e))return!0;return!1}hasTypesInBetween(t,i,e){for(var s of this.iterTypesInBetween(t,i,e))return!0;return!1}*iterAll(t=null){const[i,e]=this.tileDim;if(t!==null)for(var s=t[1];s<Math.min(e,t[1]+t[3]);s++)for(var r=t[0];r<Math.min(i,t[0]+t[2]);r++)yield[r,s];else for(var s=0;s<e;s++)for(var r=0;r<i;r++)yield[r,s]}*iterTypes(t,i){for(var e of this.iterAll(i))t.includes(this.get(e))&&(yield e)}*iterAdjacent(t){t=new w(t);for(let i of[[0,-1],[1,0],[0,1],[-1,0]]){const e=t.add(i);e[0]>=0&&e[0]<this.tileDim[0]&&e[1]>=0&&e[1]<this.tileDim[1]&&(yield e)}}hasAdjacent(t,i){for(let e of this.iterAdjacent(t))if(i.includes(this.get(t)))return!0;return!1}*iterInRange(t,i){var e,s;[e,s]=t;const[r,n]=this.tileDim;i==null&&(i=3);for(var l=Math.ceil(i),a=-l;a<l+1;a++)for(var o=-l;o<l+1;o++)if(o*o+a*a<=i*i){var u=e+o,d=s+a;0<=d&&d<n&&0<=u&&u<r&&(yield[u,d])}}*iterTypesInRange(t,i,e,s=null){for(var r of this.iterInRange(t,e))s!==null&&this.hasTypesBetween(t,r,s)||i.includes(this.get(r))&&(yield r)}numInRange(t,i,e,s=null){var r=0;for(var n of this.iterTypesInRange(t,i,e,s))r++;return r}*iterRectBoundary(t){const[i,e]=this.tileDim;let s=Math.min(Math.max(t.x,0),i),r=Math.min(Math.max(t.x+t.w,0),i),n=Math.min(Math.max(t.y,0),e),l=Math.min(Math.max(t.y+t.h,0),e);for(let a=s;a<r;a++)yield[a,n];for(let a=s;a<r;a++)yield[a,l];for(let a=n;a<l;a++)yield[s,a];for(let a=n;a<l;a++)yield[r,a]}*iterRect(t,i=!0){const[e,s]=this.tileDim;if(t instanceof v||(t=new v(t)),i&&(t.x<0||t.y<0||t.right>e||t.bottom>s))return;let r=Math.max(t.x,0),n=Math.min(t.x+t.w,e),l=Math.max(t.y,0),a=Math.min(t.y+t.h,s);for(let o=l;o<a;o++)for(let u=r;u<n;u++)yield[u,o]}numInRect(t,i,e=!0){let s=0;for(var r of this.iterRect(t,e))i.includes(this.get(r))&&s++;return s}}const D=8,E=48*(1/window.devicePixelRatio||1);function Q(h,t,i,e,s,r,n){let l=1;i<D&&(l=1/E,h.save(),h.scale(l,l)),h.fillStyle=n,h.font=(i>=D?i:Math.ceil(i/l))+"px "+e,r.x;let a=l*h.measureText(t).width;return i<D&&h.restore(),[a,2*i]}function ot(h,t,i,e,s,r,n,l){let a=1;i<D&&(a=1/E,h.save(),h.scale(a,a)),h.fillStyle=l,h.font=(i>=D?i:Math.ceil(i/a))+"px "+e;let o=n.x,u=h.measureText(t),d=n.y;switch(s){case"left":break;case"center":o+=(n.w-a*u.width)/2;break;case"right":o+=n.w-a*u.width;break}switch(r){case"top":break;case"middle":d+=n.h/2;break;case"bottom":d+=n.h;break}let c={outText:[[t,o/a,d/a]],color:l,fontName:e,size:i,valign:r};return i<D&&h.restore(),c}function St(h,t,i=null){let e=1,s=t.size;switch(i==null&&(i=t.color),s<D&&(e=1/E,h.save(),h.scale(e,e)),t.valign){case"top":h.textBaseline="top";break;case"middle":h.textBaseline="middle";break;case"bottom":h.textBaseline="bottom";break}h.fillStyle=i,h.font=(s>=D?s:Math.ceil(s/e))+"px "+t.fontName;let[r,n,l]=t.outText[0];h.fillText(r,n,l),s<D&&h.restore()}function tt(h,t,i,e,s,r,n,l=!0){let a=1;i<D&&(a=1/E,h.save(),h.scale(a,a)),h.font=(i>=D?i:Math.ceil(i/a))+"px "+e;let o=0,u="",d=Math.min(Math.max(1,Math.ceil(t.length*r.w/h.measureText(t).width/a)),t.length);for(;t!=""||u!="";){if(u==""){let g=t.indexOf(`
`);g>=0?(u=t.slice(0,g),t=t.slice(g+1)):(u=t,t="")}let f=u.slice(0,d),c=a*h.measureText(f).width;if(c>r.w&&d>1)for(;c>r.w&&d>1;)d--,f=u.slice(0,d),c=a*h.measureText(f).width;if(c<r.w&&d<u.length){for(;c<r.w&&d<u.length;)d++,f=u.slice(0,d),c=a*h.measureText(f).width;d--}if(l&&f[-1]!=""&&u[d]!=" "&&u[d]!="	"){let g=Math.max(f.lastIndexOf(" "),f.lastIndexOf("	"));g>=0&&(d-=f.length-g-1)}d=Math.max(1,d),f=u.slice(0,d),u=u.slice(d),l&&(u=u.trimStart()),o+=i}return o+=i,i<D&&h.restore(),[r.w,o]}function ut(h,t,i,e,s,r,n,l,a=!0){let o=1;i<D&&(o=1/E,h.save(),h.scale(o,o)),h.fillStyle=l,h.font=(i>=D?i:Math.ceil(i/o))+"px "+e;let u=n.y,d=[],f="",c=Math.min(Math.max(1,Math.ceil(t.length*(n.w/h.measureText(t).width)/o)),t.length);for(;t!=""||f!="";){if(f==""){let z=t.indexOf(`
`);z>=0?(f=t.slice(0,z),t=t.slice(z+1)):(f=t,t="")}let x=n.x,C=f.slice(0,c),L=o*h.measureText(C).width;if(L>n.w&&c>1)for(;L>n.w&&c>1;)c--,C=f.slice(0,c),L=o*h.measureText(C).width;if(L<n.w&&c<f.length){for(;L<n.w&&c<f.length;)c++,C=f.slice(0,c),L=o*h.measureText(C).width;c--}if(a&&c<f.length&&C[-1]!=""&&f[c]!=" "&&f[c]!="	"){let z=Math.max(C.lastIndexOf(" "),C.lastIndexOf("	"));z>=0&&(c-=C.length-z-1)}switch(c=Math.max(1,c),C=f.slice(0,c),f=f.slice(c),a&&(f=f.trimStart()),L=o*h.measureText(C).width,s){case"left":break;case"center":x+=(n.w-L)/2;break;case"right":x+=n.w-L;break}d.push([C,x/o,u/o]),u+=i}let g=u-n.y,_=0;switch(r){case"top":_=0;break;case"middle":_=(n.h-g)/2+i/2;break;case"bottom":_=n.h-g+i}let S={size:i,fontName:e,outText:d,off:_/o,color:l,valign:r};return i<D&&h.restore(),S}function xt(h,t,i=null){let e=1,s=t.size;switch(i===null&&(i=t.color),s<D&&(e=1/E,h.save(),h.scale(e,e)),t.valign){case"top":h.textBaseline="top";break;case"middle":h.textBaseline="middle";break;case"bottom":h.textBaseline="bottom";break}h.fillStyle=i,h.font=(s>=D?s:Math.ceil(s/e))+"px "+t.fontName;for(let r of t.outText)h.fillText(r[0],r[1],r[2]+(t.off??0));s<D&&h.restore()}const K=(h,t,i)=>Math.min(Math.max(h,t),i);function Tt(h,t){return new w(h).dist(t)}function M(h){let t,i,e;return[t,i,e]=new Y(h).scale(255).map(s=>Math.floor(s)),"#"+t.toString(16).padStart(2,"0")+i.toString(16).padStart(2,"0")+e.toString(16).padStart(2,"0")}class Y extends Array{constructor(...t){t.length==1&&t[0]instanceof Array?super(...t[0]):super(...t)}static asRandomFloats(t,i=0,e=1){let s=new Y(t);for(let r=0;r<s.length;r++)s[r]=Mt(i,e);return s}sum(){let t=0;return this.forEach(i=>t+=i),t}mean(){return this.sum()/this.length}max(){return Math.max.apply(null,this)}min(){return Math.min.apply(null,this)}vars(){let t=0;return this.forEach(i=>t+=i*i),(t-this.length*this.mean()^2)/(this.length-1)}var(){let t=0;return this.forEach(i=>t+=i*i),t/this.length-this.mean()^2}std(){return Math.sqrt(this.var())}add(t){let i=new Y(this);if(t instanceof Array)for(let e=0;e<this.length;e++)i[e]+=t[e];else for(let e=0;e<this.length;e++)i[e]+=t;return i}mul(t){let i=new Y(this);if(t instanceof Array)for(let e=0;e<this.length;e++)i[e]*=t[e];else for(let e=0;e<this.length;e++)i[e]*=t;return i}scale(t){const i=Array();for(let e of this)i.push(e*t);return i}dot(t){return this.mul(t).sum()}abs(){return Math.abs.apply(null,this)}lag(t){let i=new Y;for(let e=-t;e<this.length-t;e++)e<0||e>=this.length?i.push(NaN):i.push(this[e]);return i}filter(t){return new Y(super.filter(t))}dropNaN(){return this.filter(t=>!Number.isNaN(t))}}class B{identifier=-1;pos=[0,0];state="touch_up";device="touch";nativeObject=null;nativeEvent=null;constructor(t={}){for(let i in t)this[i]=t[i]}copy(){return new B({pos:[...this.pos],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}asChildTouch(t){return new B({pos:[...t.toChild(this.pos)],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}get rect(){return new v([...this.pos,0,0])}set x(t){this.pos[0]=t}set y(t){this.pos[1]=t}get x(){return this.pos[0]}get y(){return this.pos[1]}get grabbed(){return p.get().inputHandler.grabbed}grab(t){p.get().inputHandler.grab(t)}ungrab(){p.get().inputHandler.ungrab()}}class Dt{grabbed=null;mouseTouchEmulation=!0;mouseev=null;keyStates={};constructor(t){this.app=t,this.canvas=t.canvas;let i=this.canvas,e=this;document.addEventListener("keydown",function(s){e.process_key(s,"key_down")},!0),document.addEventListener("keyup",function(s){e.process_key(s,"key_up")},!0),i.addEventListener("mousedown",function(s){e.process_mouse(s,"mouse_down")},!0),i.addEventListener("mousemove",function(s){e.process_mouse(s,"mouse_move")},!0),i.addEventListener("mouseout",function(s){e.process_mouse(s,"mouse_cancel")},!0),i.addEventListener("mouseup",function(s){e.process_mouse(s,"mouse_up")},!0),i.addEventListener("touchstart",function(s){e.process_touch(s,"touch_down")},!1),i.addEventListener("touchmove",function(s){e.process_touch(s,"touch_move")},!1),i.addEventListener("touchcancel",function(s){e.process_touch(s,"touch_cancel")},!1),i.addEventListener("touchend",function(s){e.process_touch(s,"touch_up")},!1),i.addEventListener("wheel",function(s){e.process_wheel(s,"wheel")},!0),window.history.replaceState(null,document.title,location.pathname+"#!/backbutton"),window.history.pushState(null,document.title,location.pathname),window.addEventListener("popstate",function(s){e.process_back(s,"back_button")},!1)}grab(t){this.grabbed=t}ungrab(){this.grabbed=null}isKeyUp(t){return t in this.keyStates&&this.keyStates[t]}isKeyDown(t){return t in this.keyStates&&this.keyStates[t]}process_key(t,i){this.app.requestFrameUpdate();const e=this.keyStates[t.key];i==="key_up"?this.keyStates[t.key]=!1:i==="key_down"&&(this.keyStates[t.key]=!0),this.app.emit(i,{states:this.keyStates,oldState:e,event:t})}process_touch(t,i){if(this.app.requestFrameUpdate(),this.grabbed!==null)for(let e of t.changedTouches){let s=this.grabbed.appToChild([e.clientX,e.clientY]),r=new B({pos:s,state:i,nativeObject:e,nativeEvent:t,identifier:e.identifier});this.grabbed.emit(i,r)}else for(let e of t.changedTouches){let s=new B({pos:this.app.toChild([e.clientX,e.clientY]),state:i,nativeObject:e,nativeEvent:t,identifier:e.identifier});this.app.childEmit(i,s,!0)}t.preventDefault()}process_back(t,i){location.hash==="#!/backbutton"&&(history.replaceState(null,document.title,location.pathname),this.app.childEmit("back_button",t))}process_mouse(t,i){if(this.app.requestFrameUpdate(),this.mouseev=t,t.preventDefault(),this.mouseTouchEmulation){let e={mouse_up:"touch_up",mouse_down:"touch_down",mouse_move:"touch_move",mouse_cancel:"touch_cancel"};if(t.buttons!==1&&i!=="mouse_up")return;if(this.grabbed!==null){let s=[t.clientX,t.clientY],r=this.grabbed.appToChild(s),n=new B({pos:r,state:e[i],nativeObject:t,identifier:-1});this.grabbed.emit(e[i],n)}else{let s=new B({pos:this.app.toChild([t.clientX,t.clientY]),state:e[i],nativeObject:t,identifier:-1});this.app.childEmit(e[i],s,!0)}}else this.grabbed!==null?this.grabbed.emit(i,t):this.app.childEmit(i,t,!0)}process_wheel(t,i){if(this.mouseev!=null){if(this.app.requestFrameUpdate(),this.grabbed!=null){let e=this.grabbed.appToChild([this.mouseev.clientX,this.mouseev.clientY]),s=new B({pos:e,state:i,nativeObject:t});return this.grabbed.emit(i,s)}else{let e=new B({pos:this.app.toChild([this.mouseev.clientX,this.mouseev.clientY]),state:i,nativeObject:t});this.app.childEmit(i,e,!0)}t.preventDefault()}}vibrate(t,i,e){window.navigator.vibrate(e)}}function Pt(h,t,i,e){if(typeof t=="string"||t instanceof String){if(h.startsWith("on_"))return new Function("resources","parent","root",`return function(event, object, value) {${t}}`).bind(i)(p.resources,i.parent,e);if(t.trim().startsWith("(")&&t.indexOf("=>")<t.indexOf(`
`)){const o=new Function("resources","parent","root",`return ${t}`).bind(i)(p.resources,i.parent,e);return o.markupMethod=!0,o}const s=new Set;let r=0;if(t[0]!=="'"&&t[0]!=='"')for(let o of t.matchAll(/(?!\.)\b([a-z]\w*)\.([a-z_]\w*)\b/ig)){const u=o[1];u!=="this"&&u!=="parent"&&u!=="root"&&s.add(u),r++}if(r===0)return new Function("resources",`return ${t};`)(p.resources);const n=[...s].join(", "),l=`return function (${n}) { return ${t} }`,a=new Function("resources","parent","root",l)(p.resources,i.parent,e).bind(i);return a.text=`(${n}) => ${t}`,a}return t}function kt(h,t,i){t in h?h[t].push(i):h[t]=[i]}function Lt(h,t){const i=h.indexOf(t);if(i===-1)return[h,""];const e=h.substring(0,i),s=h.substring(i+1);return[e,s]}function zt(h,t,i){const e=i;let s=h[t];for(i=0;s[i]===" "&&i<s.length;i++);if(i<=e)throw Error(`Syntax error: invalid declaration on ${t}
${h[t-1]}
Declared object is neither a known class nor a valid property declaration`);let r=s;for(t++;i>e&&t<h.length;){for(s=h[t],i=0;s[i]===" "&&i<s.length;i++);i>e&&(r+=`
`+s,t++)}return[r,t,i]}function $(h,t,i,e,s){const r=e;let n=h[i];for(e=0;n[e]===" "&&e<n.length;e++);if(e<=r)return[i,e];const l=e;for(;;){if(i>=h.length)return[i,e];if(n=h[i],n.trim()===""||n.trim().startsWith("#")||n.trim().startsWith("//")){i++;continue}for(e=0;n[e]===" "&&e<n.length;e++);if(e>l)throw Error(`Syntax error on line ${i+1}
${n}`);if(e<l)return[i,e];if(n.includes(":"))if(n=n.trim(),n.endsWith(":")){const a=n.slice(0,n.length-1);if(a in p.classes){const o={cls:a};[i,e]=$(h,t,i+1,e,o),kt(s,"children",o)}else{let o;[o,i,e]=zt(h,i+1,e),s[a]=o}}else{const[a,o]=Lt(n,":").map(u=>u.trim());s[a]=o,i++}else throw Error(`Syntax error on line ${i+1}
${n}`)}}function lt(h,t,i){const e={},s=h.constructor.name,n={...p.rules.get(s),...t};for(let l in n){const a=n[l];if(l==="children"&&a instanceof Array){const o=[];for(let u of a)if(u instanceof Object&&"cls"in u){const[d,f]=p.classes[u.cls],c=new d;lt(c,u,i),o.push(c)}else throw Error(`Unknown child class ${u} on clsName ${s}`);h instanceof p?h.baseWidget.children=o:h.children=o}else if(l!=="cls")try{e[l]=Pt(l,a,h,i)}catch{e[l]=a}}h.updateProperties(e,!1)}function It(h,t){return{[h]:class extends t{}}[h]}function Wt(h){const t=h.split(`
`),i=[];let e=0,s=0,r=0;for(;r<t.length;){let n=t[r];if(n.trim()===""||n.trim().startsWith("#")||n.trim().startsWith("//")){r++;continue}for(s=0;s<n.length&&n[s]===" ";++s);if(s!==e)throw Error(`Indentation error -- level ${s} used when ${e} expected on line # ${r+1}.
`+n);if(n=n.trim(),n.endsWith(":")){const l=n.replace(":","");if(n.startsWith("<")&&n.includes("@")){const[a,o]=l.slice(1,-1).split("@"),u=It(a,p.classes[o][0]),d={};[r,s]=$(t,a,r+1,s,d),p.classes[a]=[u,o],p.rules.add(a,d)}else if(n.startsWith("<")){const a=l.slice(1,-1).split(",").map(o=>o.trim());for(let o of a){const[u,d]=p.classes[o],f=p.rules.get(o);[r,s]=$(t,u,r+1,s,f),p.rules.add(o,f)}}else{const a=new p.classes[l][0],o={};[r,s]=$(t,l,r+1,s,o),lt(a,o,a),i.push(a)}}else throw Error(`Syntax error: Invalid declation on ${r}
${n}`)}return i}class At{constructor(t,i=0,e=null){this.elapsed=0,this.timer=t,this.triggered=!1,this.callback=e,i>0&&this.tick(i)}finished(){return this.elapsed>=this.timer}tick(t){return this.elapsed>=this.timer?(this.triggered&&(this.triggered=!1),!1):(this.elapsed+=t,this.elapsed>=this.timer?(this.callback!=null&&this.callback("timer",this),this.triggered=!0,!0):!1)}reset(t=-1,i=0){this.triggered=!1,t>=0&&(this.timer=t),i>0&&this.tick(i)}}class Ht{update(t,i){}}class Bt{constructor(){this.rules=new Map}add(t,i,e=!0){let s=this.rules.get(t);if(s&&!e)for(let r in s)s[r]=i[r];else this.rules.set(t,i)}get(t){return this.rules.get(t)??{}}remove(t){return this.rules.delete(t)}}class jt{constructor(t,i,e){this.listener=t,this.event=i,this.callback=e}}class Ft{constructor(){this.connections=new Map}bind(t,i,e,s){let r=new jt(t,e,s),n=this.connections.get(i);n?n.add(r):this.connections.set(i,new Set([r]))}emit(t,i,e){const s=this.connections.get(t);if(!s)return!1;for(let r of s)if(r.event===i&&r.callback(i,t,e))return!0;return!1}disconnect(t){this.connections.delete(t);for(let i of this.connections.keys()){const e=[],s=this.connections.get(i);if(s){for(let r of s)r.listener===t&&e.push(r);e.forEach(r=>s.delete(r))}}}}class dt{stack=[];widget=null;props={};elapsed=0;add(t,i=1e3){this.stack.push([t,i])}update(t,i){if(this.widget===null)return;let e=this.stack[0][0],s=this.stack[0][1];if(this.elapsed==0){this.initProps={};for(let l in e)this.initProps[l]=this.widget[l]}let r=this.elapsed+i-s;this.elapsed=r<0?this.elapsed+i:s;let n=s==0?1:this.elapsed/s;if(r<0)for(let l in this.initProps){let a=e[l];typeof a=="number"&&(this.widget[l]=(1-n)*this.initProps[l]+n*a)}else{for(let l in this.initProps){let a=e[l];typeof a=="number"&&(this.widget[l]=a)}if(this.stack=this.stack.slice(1),this.elapsed=r,this.stack.length==0)this.cancel();else{this.initProps={};for(let l in this.stack[0][0])this.initProps[l]=this.widget[l]}}}start(t){this.widget=t,t._animation=this}cancel(){this.widget!==null&&(this.widget._animation=null,this.widget.emit("animationComplete",this))}}class k extends v{bgColor=null;outlineColor=null;_animation=null;_layoutNotify=!1;hints={};constructor(t=null){return super(),this.parent=null,this._processTouches=!1,this._deferredProps=null,this._children=[],this._needsLayout=!0,t!=null&&this.updateProperties(t),new Proxy(this,{set(i,e,s,r){return["x","y","w","h","children","rect"].includes[e]||e[0]=="_"?Reflect.set(i,e,s,r):(Reflect.set(i,e,s,r),typeof e=="string"&&Reflect.apply(i.emit,r,[e,s]),!0)}})}set rect(t){this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this._needsLayout=!0}get rect(){return new v([this[0],this[1],this[2],this[3]])}deferredProperties(t){let i=this._deferredProps;this._deferredProps=null;for(let e in i)if(!e.startsWith("on_")&&!e.startsWith("_")&&typeof i[e]=="function"){let s=i[e],r,n;[r,n]=(s.text??s.toString()).split("=>"),r=r.replace("(","").replace(")","").split(",").map(u=>u.trim());let l=r.map(u=>t.findById(u)),a={};for(let u of r)a[u]=t.findById(u);const o=/(\w+)\.(\w+)/g;for(let u of n.matchAll(o)){let d,f;if([f,d]=u.slice(1),f==="this")this.bind(d,(c,g,_)=>{try{this[e]=s(...l)}catch(S){console.log("Dynamic binding error",this,e,S)}});else if(f in a)try{a[f].bind(d,(c,g,_)=>{try{this[e]=s(...l)}catch(S){console.log("Dynamic binding error",this,e,S)}})}catch(c){console.log(`Warning: ${f} cannot be bound on`,this,`
property`,e,`
error`,c)}}try{this[e]=s(...l)}catch(u){console.log("Dynamic binding error",this,e,u)}}}updateProperties(t,i=!0){i&&lt(this,{},this);for(let e in t)!e.startsWith("on_")&&!e.startsWith("_")&&typeof t[e]=="function"&&!("markupMethod"in t[e])?this._deferredProps=t:this[e]=t[e]}bind(t,i,e=null){p.get()._eventManager.bind(e,this,t,i)}emit(t,i){return"on_"+t in this&&this["on_"+t](t,this,i)?!0:p.get()._eventManager.emit(this,t,i)}*iter(t=!0,i=!0){if(yield this,!!t)for(let e of this._children)yield*e.iter(...arguments)}*iterParents(){this.parent!==null&&(yield this.parent,this.parent!=p.get()&&(yield*this.parent.iterParents()))}findById(t){for(let i of this.iter(!0,!1))if("id"in i&&i.id==t)return i;return null}*iterByPropertyValue(t,i){for(let e of this.iter(!0,!1))t in e&&e[t]==i&&(yield e)}getTransformRecurse(t=!1,i=null){let e=this!==i&&this.parent!==null?this.parent.getTransformRecurse(!0,i):new DOMMatrix;if(!t)return e;let s=this.getTransform();return s?e.multiply(s):e}getTransform(){return null}applyTransform(t,i=!1,e=!1,s=!1,r=null){let n=e?this.getTransformRecurse(s,r):this.getTransform();if(!n)return t;i&&(n=n.inverse());let l=n.transformPoint(new DOMPoint(t.x,t.y));return new w([l.x,l.y])}appToWidget(t,i=!0){if(this.parent){let e=this.parent.getTransformRecurse().inverse().transformPoint(new DOMPoint(t[0],t[1]));return new w([e.x,e.y])}return t}appToChild(t,i=!0){let e=this.getTransformRecurse().inverse().transformPoint(new DOMPoint(t[0],t[1]));return new w([e.x,e.y])}toChild(t){let i=this.getTransform();if(!i)return t;let e=i.inverse().transformPoint(new DOMPoint(t[0],t[1]));return new w([e.x,e.y])}addChild(t,i=-1){i==-1?this._children.push(t):this._children=[...this._children.slice(0,i),t,...this._children.slice(i)],this.emit("child_added",t),t.parent=this,this._needsLayout=!0}removeChild(t,i=!0){this._children=this.children.filter(e=>e!=t),i&&p.get()._eventManager.disconnect(t),this.emit("child_removed",t),t.parent=null,this._needsLayout=!0}get children(){return this._children}set children(t){for(let i of this._children)this.emit("child_removed",i),i.parent=null,this._needsLayout=!0;this._children=[];for(let i of t)this.addChild(i)}set x(t){this._needsLayout=!0,this[0]=t}set center_x(t){this._needsLayout=!0,this[0]=t-this[2]/2}set right(t){this._needsLayout=!0,this[0]=t-this[2]}set y(t){this._needsLayout=!0,this[1]=t}set center_y(t){this._needsLayout=!0,this[1]=t-this[3]/2}set bottom(t){this._needsLayout=!0,this[1]=t-this[3]}set w(t){this._needsLayout=!0,this[2]=t}set h(t){this._needsLayout=!0,this[3]=t}get x(){return this[0]}get center_x(){return this[0]+this[2]/2}get right(){return this[0]+this[2]}get y(){return this[1]}get center_y(){return this[1]+this[3]/2}get bottom(){return this[1]+this[3]}get w(){return this[2]}get h(){return this[3]}on_wheel(t,i,e){for(let s=this._children.length-1;s>=0;s--)if(this._children[s].emit(t,e))return!0;return!1}on_touch_down(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];for(let l=this._children.length-1;l>=0;l--)if(this._children[l].emit(t,r))return!0}else for(let r=this._children.length-1;r>=0;r--)if(this._children[r].emit(t,e))return!0;return!1}on_touch_up(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];for(let l=this._children.length-1;l>=0;l--)if(this._children[l].emit(t,r))return!0}else for(let r=this._children.length-1;r>=0;r--)if(this._children[r].emit(t,e))return!0;return!1}on_touch_move(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];for(let l=this._children.length-1;l>=0;l--)if(this._children[l].emit(t,r))return!0}else for(let r=this._children.length-1;r>=0;r--)if(this._children[r].emit(t,e))return!0;return!1}on_touch_cancel(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];for(let l=this._children.length-1;l>=0;l--)if(this._children[l].emit(t,r))return!0}else for(let r=this._children.length-1;r>=0;r--)if(this._children[r].emit(t,e))return!0;return!1}on_back_button(t,i,e){return!1}getMetric(t,i,e,s=null,r=null){let n=p.get();if(e===null)return t[i];let l=0,a="relative";for(s=s??this.w,r=r??this.h;;){if(e.constructor==String){let o=e.slice(-2);if(o=="ww"){l=+e.slice(0,-2)*t.w;break}if(o=="wh"){l=+e.slice(0,-2)*t.h;break}if(o=="aw"){l=+e.slice(0,-2)*n.dimW,a="absolute";break}if(o=="ah"){l=+e.slice(0,-2)*n.dimH,a="absolute";break}let u=e.slice(-1);if(u=="w"){l=+e.slice(0,-1)*s;break}if(u=="h"){l=+e.slice(0,-1)*r;break}l=+e;break}if(i=="w"||i=="x"||i=="center_x"||i=="right"){l=+e;break}l=+e;break}return a=="relative"&&(["x","center_x","right"].includes(i)&&(l+=this.x),["y","center_y","bottom"].includes(i)&&(l+=this.y)),l}applyHintMetric(t,i,e,s=null,r=null){let n=p.get();if(e===null)return;let l=0,a="relative";for(s=s??this.w,r=r??this.h;;){if(e.constructor==String){let o=e.slice(-2);if(o=="ww"){l=+e.slice(0,-2)*t.w;break}if(o=="wh"){l=+e.slice(0,-2)*t.h;break}if(o=="aw"){l=+e.slice(0,-2)*n.dimW,a="absolute";break}if(o=="ah"){l=+e.slice(0,-2)*n.dimH,a="absolute";break}let u=e.slice(-1);if(u=="w"){l=+e.slice(0,-1)*s;break}if(u=="h"){l=+e.slice(0,-1)*r;break}l=+e;break}if(i=="w"||i=="x"||i=="center_x"||i=="right"){l=+e*s;break}l=+e*r;break}a=="relative"&&(["x","center_x","right"].includes(i)&&(l+=this.x),["y","center_y","bottom"].includes(i)&&(l+=this.y)),t[i]=l}applyHints(t,i=null,e=null){let s=t.hints;i=i??this.w,e=e??this.h,"w"in s&&s.w!=null&&s.w.constructor==String&&s.w.slice(-2)=="wh"?(s.h!==void 0&&this.applyHintMetric(t,"h",s.h,i,e),s.w!==void 0&&this.applyHintMetric(t,"w",s.w,i,e)):(s.w!==void 0&&this.applyHintMetric(t,"w",s.w,i,e),s.h!==void 0&&this.applyHintMetric(t,"h",s.h,i,e));for(let r in s)r!="w"&&r!="h"&&this.applyHintMetric(t,r,s[r],i,e)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;for(let t of this.children)this.applyHints(t),t.layoutChildren()}_draw(t,i,e){this.draw(t,i);let s=this.getTransform();if(s){i.save(),i.transform(s.a,s.b,s.c,s.d,s.e,s.f);for(let r of this._children)r._draw(t,i,e);i.restore();return}for(let r of this._children)r._draw(t,i,e)}draw(t,i){let e=this.rect;if(i.beginPath(),i.rect(e[0],e[1],e[2],e[3]),this.bgColor!=null&&(i.fillStyle=this.bgColor,i.fill()),this.outlineColor!=null){let s=i.lineWidth;i.lineWidth=1/t.tileSize,i.strokeStyle=this.outlineColor,i.stroke(),i.lineWidth=s}}update(t,i){this._deferredProps!=null&&this.deferredProperties(t),this._animation!=null&&(this._animation.update(t,i),t.requestFrameUpdate()),this._needsLayout&&(this.layoutChildren(),t.requestFrameUpdate());for(let e of this._children)e.update(t,i)}}class p extends k{static appInstance=null;static rules=new Bt;static resources=new Map;static classes={};static registerClass(t,i,e){p.classes[t]=[i,e]}constructor(t=null){if(p.appInstance!=null)return p.appInstance;super(),p.appInstance=this,window.app=this,this._eventManager=new Ft,this.id="app",this.w=-1,this.h=-1,this._baseWidget=new k({hints:{x:0,y:0,w:1,h:1}}),this._baseWidget.parent=this,this._modalWidgets=[],this._udpateActive=!0,this.pixelSize=1,this.integerTileSize=!1,this.exactDimensions=!1,this.prefDimW=32,this.prefDimH=16,this.dimW=this.prefDimW,this.dimH=this.prefDimH,this.tileSize=this.getTileScale()*this.pixelSize,this.canvasName="canvas",this.canvas=null,this.offsetX=0,this.offsetY=0,this.shakeX=0,this.shakeY=0,this.shakeAmount=0,this.timer_tick=null,this.timers=[],this.continuousFrameUpdates=!1,this._requestedFrameUpdate=!1,t&&this.updateProperties(t)}get baseWidget(){return this._baseWidget}addTimer(t,i){let e=new At(t,0,i);return this.timers.push(e),e}removeTimer(t){this.timers=this.timers.filter(i=>i!=t)}addModal(t){this._modalWidgets.push(t),this._needsLayout=!0}removeModal(t){this._modalWidgets=this._modalWidgets.filter(i=>i!=t)}static get(){return p.appInstance||(p.appInstance=new p),p.appInstance}start(){let t=this;this.setupCanvas(),this.inputHandler=new Dt(this),window.onresize=()=>t.updateWindowSize(),this.updateWindowSize(),window.onload=()=>this._start()}_start(){this.update()}childEmit(t,i,e=!1){if(e&&this._modalWidgets.length>0)return this._modalWidgets[this._modalWidgets.length-1].emit(t,i);if(this._baseWidget.emit(t,i))return!0;for(let s of this._modalWidgets)if(s.emit(t,i))return!0;return!1}*iter(t=!0,i=!0){yield this,yield*this._baseWidget.iter(...arguments);for(let e of this._modalWidgets)yield*e.iter(...arguments)}findById(t){for(let i of this.iter(!0,!1))if("id"in i&&i.id==t)return i;return null}*iterByPropertyValue(t,i){for(let e of this.iter(!0,!1))t in e&&e[t]===i&&(yield e)}update(){this._udpateActive=!0,this._requestedFrameUpdate=!1;let t=15,i=Date.now();this.timer_tick!=null&&(t=Math.min(i-this.timer_tick,30)),(this.timers.length>0||this._needsLayout)&&this.requestFrameUpdate();for(let e of this.timers)e.tick(t);this._needsLayout&&this.layoutChildren();for(let e of p.resources.values())e.update(this,t);this._baseWidget.update(this,t);for(let e of this._modalWidgets)e.update(this,t);this.ctx&&this._draw(this,this.ctx,t),this.continuousFrameUpdates&&this.requestFrameUpdate(),this.timer_tick=i,this._requestedFrameUpdate&&window.requestAnimationFrame(()=>this.update()),this._udpateActive=!1}requestFrameUpdate(){this._requestedFrameUpdate||(this._udpateActive?this._requestedFrameUpdate=!0:window.requestAnimationFrame(()=>this.update()))}_draw(t,i,e){if(!this.canvas)return;i.clearRect(0,0,this.canvas.width,this.canvas.height),this.shakeX=0,this.shakeY=0,this.screenShake(),i.save();let s=this.getTransform();s&&i.transform(s.a,s.b,s.c,s.d,s.e,s.f),this._baseWidget._draw(t,i,e);for(let r of this._modalWidgets)r._draw(t,i,e);i.restore()}getTransform(t=!0){return new DOMMatrix().translate(this.offsetX+this.shakeX,this.offsetY+this.shakeY).scale(this.tileSize,this.tileSize)}on_prefDimW(t,i,e){this.updateWindowSize()}on_prefDimH(t,i,e){this.updateWindowSize()}on_tileSize(t,i,e){this.prefDimH<0&&this.prefDimW<0&&this.updateWindowSize()}updateWindowSize(){this.x=0,this.y=0,this.w=window.innerWidth,this.h=window.innerHeight,this.prefDimH>=0&&this.prefDimW>=0&&(this.tileSize=this.getTileScale()),this.fitDimensionsToTileSize(this.tileSize),this.setupCanvas();try{screen.orientation.unlock()}catch{}this._needsLayout=!0,this.requestFrameUpdate()}getTileScale(){let t=this.h,i=this.w,e=1/this.pixelSize;return this.prefDimW<0&&this.prefDimH<0?this.tileSize>0&&(e=this.tileSize/this.pixelSize):this.prefDimW<0?e=t/this.prefDimH/this.pixelSize:this.prefDimH<0?e=i/this.prefDimW/this.pixelSize:e=Math.min(t/this.prefDimH/this.pixelSize,i/this.prefDimW/this.pixelSize),this.integerTileSize&&e>1&&(e=Math.floor(e)),e*this.pixelSize}fitDimensionsToTileSize(t){let i=this.h,e=this.w;if(this.exactDimensions){this.prefDimW<0&&this.prefDimH<0?(this.dimW=e/this.tileSize,this.dimH=i/this.tileSize):this.prefDimH<0?(this.dimW=this.prefDimW,this.dimH=i/this.tileSize):this.prefDimW<0?(this.dimW=e/this.tileSize,this.dimH=this.prefDimH):(this.dimH=this.prefDimH,this.dimW=this.prefDimW);return}this.dimH=Math.floor(i/t),this.dimW=Math.floor(e/t)}setupCanvas(){this.canvas=document.querySelector(this.canvasName),this.canvas&&(this.canvas.width=this.w,this.canvas.height=this.h,this.ctx=this.canvas.getContext("2d"),this.ctx&&(this.ctx.imageSmoothingEnabled=!1,this.offsetX=Math.floor((this.w-this.tileSize*this.dimW)/2),this.offsetY=Math.floor((this.h-this.tileSize*this.dimH)/2)))}applyHints(t){super.applyHints(t,this.dimW,this.dimH)}screenShake(){this.shakeAmount&&this.shakeAmount--;let t=Math.random()*Math.PI*2;this.shakeX=Math.round(Math.cos(t)*this.shakeAmount),this.shakeY=Math.round(Math.sin(t)*this.shakeAmount)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.applyHints(this._baseWidget),this._baseWidget.layoutChildren();for(let t of this._modalWidgets)this.applyHints(t),t.layoutChildren()}}class V extends k{fontSize=null;sizeGroup="";clip=!1;ignoreSizeForGroup=!1;fontName='"Nimbus Mono PS", "Courier New", monospace';text="";wrap=!1;wrapAtWord=!0;align="center";valign="middle";color="white";constructor(t=null){super(),this._textData=null,t!==null&&this.updateProperties(t)}on_align(t,i,e){this._needsLayout=!0}on_valign(t,i,e){this._needsLayout=!0}on_wrap(t,i,e){this._needsLayout=!0}on_wrapAtWord(t,i,e){this._needsLayout=!0}on_text(t,i,e){this._needsLayout=!0}on_fontSize(t,i,e){this._needsLayout=!0}on_fontName(t,i,e){this._needsLayout=!0}layoutChildren(){let i=p.get().ctx;if(!i)return;let e=this.fontSize===null?null:this.getMetric(this,"fontSize",this.fontSize);if("h"in this.hints&&this.hints.h==null&&e!==null&&(this[3]=this.wrap?tt(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[1]:Q(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color)[1]),"w"in this.hints&&this.hints.w==null&&e!==null&&(this[2]=this.wrap?tt(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[0]:Q(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color)[0]),e=e===null?this.h/2:e,this.fontSize===null&&this.rect.w!==void 0){let s=0,r,n;for(;s<50;){if(this.wrap?[r,n]=tt(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord):[r,n]=Q(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color),(this.h>=n||"h"in this.hints&&this.hints.h==null||e<.01)&&(this.w>=r||"w"in this.hints&&this.hints.w==null)){"h"in this.hints&&this.hints.h==null&&(this.h=n),"w"in this.hints&&this.hints.w==null&&(this.w=r);break}const l=Math.min(1.1,this.w/r,this.h/n);this.wrap?e*=l**.5:e*=l**1.1,s++}e===void 0&&(e=.001*p.get().h)}this.sizeGroup!==""?(this._bestFontSize=e,this._textData=null):this.wrap?this._textData=ut(i,this.text,e,this.fontName,this.align,this.valign,this.rect,this.color,this.wrapAtWord):this._textData=ot(i,this.text,e,this.fontName,this.align,this.valign,this.rect,this.color),super.layoutChildren()}sizeToGroup(t){if(this._bestFontSize===void 0)return;let i=1/0;for(let e of p.get().iterByPropertyValue("sizeGroup",this.sizeGroup))i>e._bestFontSize&&!e.ignoreSizeForGroup&&(i=e._bestFontSize);if(i>0)for(let e of p.get().iterByPropertyValue("sizeGroup",this.sizeGroup)){const s=e.clip||!e.ignoreSizeForGroup?i:e._bestFontSize;e.wrap?e._textData=ut(t,e.text,s,e.fontName,e.align,e.valign,e.rect,e.color,e.wrapAtWord):e._textData=ot(t,e.text,s,e.fontName,e.align,e.valign,e.rect,e.color)}}draw(t,i){if(super.draw(t,i),this.clip){i.save();const e=this.rect;i.rect(e.x,e.y,e.w,e.h),i.clip()}!this._textData&&this.sizeGroup!==""&&this.sizeToGroup(i),this._textData&&(this.wrap?xt(i,this._textData,this.color):St(i,this._textData,this.color)),this.clip&&i.restore()}}class Yt extends V{bgColor=M([.5,.5,.5]);selectColor=M([.7,.7,.8]);disableColor1=M([.2,.2,.2]);disableColor2=M([.4,.4,.4]);disable=!1;constructor(t=null){super(),t!==null&&this.updateProperties(t)}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):!1}on_touch_up(t,i,e){return super.on_touch_up(t,i,e)?!0:e.grabbed!=this?!1:(e.ungrab(),!this.disable&&this.collide(e.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(t,i,e){return super.on_touch_move(t,i,e)?!0:(e.grabbed==this&&!this.disable&&(this._touching=this.collide(e.rect)),!1)}draw(t,i){let e=this.bgColor,s=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(t,i),this.bgColor=e,this.color=s}}class Xt extends k{color=M([.8,.8,.8]);bgColor=M([.5,.5,.5]);selectColor=M([.7,.7,.8]);disableColor1=M([.2,.2,.2]);disableColor2=M([.4,.4,.4]);disable=!1;constructor(t=null){super(),t!==null&&this.updateProperties(t)}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):!1}on_touch_up(t,i,e){return super.on_touch_up(t,i,e)?!0:e.grabbed!=this?!1:(e.ungrab(),!this.disable&&this.collide(e.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(t,i,e){return super.on_touch_move(t,i,e)?!0:(e.grabbed==this&&!this.disable&&(this._touching=this.collide(e.rect)),!1)}draw(t,i){let e=this.bgColor,s=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(t,i),this.bgColor=e,this.color=s}}class mt extends V{bgColor=M([.5,.5,.5]);pressColor=M([.7,.7,.7]);selectColor=M([.7,.7,.8]);disableColor1=M([.2,.2,.2]);disableColor2=M([.4,.4,.4]);disable=!1;_press=!1;group=null;singleSelect=!0;constructor(t=null){super(),t!==null&&this.updateProperties(t)}get press(){return this._press}set press(t){this._press=t}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):!1}on_touch_up(t,i,e){if(e.grabbed!==this)return!1;if(e.ungrab(),this._touching=!1,this.collide(e.rect)){if(this.group===null||!this.singleSelect)this.press=!this.press;else{if(this.parent!==null)for(let s of this.parent.iterByPropertyValue("group",this.group))s!==this&&(s._press=!1);this.press=!0}return!0}return!1}on_touch_move(t,i,e){return e.grabbed===this?(this._touching=this.collide(e.rect),!0):!1}draw(t,i){let e=this.bgColor,s=this.color;this.press&&(this.bgColor=this.pressColor),this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(t,i),this.bgColor=e,this.color=s}}class Rt extends k{selectColor=M([.7,.7,.8]);color=M([.6,.6,.6]);bgColor=M([.5,.5,.5]);disableColor1=M([.2,.2,.2]);disableColor2=M([.3,.3,.3]);disable=!1;check=!1;group=null;constructor(t=null){super(),t!==null&&this.updateProperties(t)}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):!1}on_touch_up(t,i,e){if(super.on_touch_up(t,i,e))return!0;if(this.parent===null||e.grabbed!=this)return!1;if(e.ungrab(),!this.disable&&this.collide(e.rect)){if(this._touching=!1,this.group==null)this.check=!this.check;else{for(let s of this.parent.iterByPropertyValue("group",this.group))s!=this&&(s.check=!1);this.check=!0}return!0}return!1}on_touch_move(t,i,e){return super.on_touch_move(t,i,e)?!0:e.grabbed==this&&!this.disable?(this._touching=this.collide(e.rect),!0):!1}draw(t,i){if(this.group!=null){let r=this.rect;r.w=r.h=.5*Math.min(r.w,r.h),r.x=this.x+(this.w-r.w)/2,r.y=this.y+(this.h-r.h)/2;let n=p.get().tileSize,l=p.get().ctx;if(!l)return;l.strokeStyle=this.disable?this.disableColor1:this.bgColor,l.lineWidth=1/n,l.beginPath(),l.arc(r.center_x,r.center_y,r.w/2,0,2*Math.PI),l.stroke(),(this._touching||this.disable)&&(l.fillStyle=this.disable?this.disableColor1:this.selectColor,l.fill()),this.check&&(l.fillStyle=this.disable?this.disableColor2:this.color,l.beginPath(),l.arc(r.center_x,r.center_y,r.w/3,0,2*Math.PI),l.fill());return}let e=this.rect;e.w=e.h=.5*Math.min(e.w,e.h),e.x=this.x+(this.w-e.w)/2,e.y=this.y+(this.h-e.h)/2;let s=t.tileSize;i.beginPath(),i.strokeStyle=this.bgColor,this.disable&&(i.strokeStyle=this.disableColor1),i.lineWidth=1/s,i.rect(e[0],e[1],e[2],e[3]),i.stroke(),this._touching&&(i.fillStyle=this.selectColor,i.fill()),this.check&&(i.strokeStyle=this.color,this.disable&&(i.strokeStyle=this.disableColor2),i.beginPath(),i.lineWidth=e.w/5,i.moveTo(e.x,e.y),i.lineTo(e.right,e.bottom),i.moveTo(e.right,e.y),i.lineTo(e.x,e.bottom),i.stroke())}}class Ot extends k{selectColor=M([.7,.7,.8]);color=M([.6,.6,.6]);bgColor=M([.4,.4,.4]);disableColor1=M([.2,.2,.2]);disableColor2=M([.3,.3,.3]);disable=!1;min=0;max=1;curMax=1;unboundedStopMultiple=10;exponentialSlider=!1;step=null;orientation="horizontal";value=0;sliderSize=.2;constructor(t=null){super(),t!==null&&this.updateProperties(t)}setValue(t){let i=this.max??this.curMax,e=0;this.orientation=="horizontal"&&(e=K((t.rect.x-this.x-this.w*this.sliderSize/2)/(this.w*(1-this.sliderSize)),0,1)),this.orientation=="vertical"&&(e=K((t.rect.y-this.y-this.h*this.sliderSize/2)/(this.h*(1-this.sliderSize)),0,1)),this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?e=e>.5?i/this.unboundedStopMultiple+(e-.5)/.5*(i-i/this.unboundedStopMultiple):this.min+e/.5*(i/this.unboundedStopMultiple-this.min):e=this.min+(i-this.min)*e,this.step!=null&&(e=Math.round(e/this.step)*this.step),this.value=e}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touch=!0,this.setValue(e),!0):!1}updateMax(){this.max===null&&(this.curMax=this.unboundedStopMultiple*this.value)}on_touch_up(t,i,e){return e.grabbed!=this?super.on_touch_up(t,i,e):(e.ungrab(),!this.disable&&this.collide(e.rect)&&(this._touching=!1,this.setValue(e)),this.updateMax(),!0)}on_touch_move(t,i,e){return e.grabbed!==this?super.on_touch_move(t,i,e):(this.disable||(this._touching=this.collide(e.rect),this.setValue(e)),!1)}draw(t,i){let e=t.tileSize,s=this.rect;if(this.orientation=="horizontal"){s.w-=this.sliderSize*this.w,s.x+=this.sliderSize/2*this.w;let r=Math.min(this.sliderSize/2*this.w,this.h/2)/2;i.strokeStyle=this.disable?this.disableColor1:this.bgColor,i.beginPath(),i.lineWidth=4/e,i.moveTo(s.x,s.center_y),i.lineTo(s.right,s.center_y),i.stroke();let n=this.max??this.curMax,l;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?l=this.value>n/this.unboundedStopMultiple?(.5+.5*(this.value-n/this.unboundedStopMultiple)/(n-n/this.unboundedStopMultiple))*s.w:.5*(this.value-this.min)/(n/this.unboundedStopMultiple-this.min)*s.w:l=(this.value-this.min)/(n-this.min)*s.w,i.strokeStyle=this.disable?this.disableColor2:this.bgColor,i.beginPath(),i.arc(s.x+l,s.center_y,r,0,2*Math.PI),i.stroke(),i.fillStyle=this.color,(this._touching||this.disable)&&(i.fillStyle=this.disable?this.disableColor1:this.selectColor),i.fill()}if(this.orientation=="vertical"){s.h-=this.sliderSize*this.h,s.y+=this.sliderSize/2*this.h;let r=Math.min(this.sliderSize/2*this.h,this.w/2)/2;i.strokeStyle=this.disable?this.disableColor1:this.bgColor,i.beginPath(),i.lineWidth=4/e,i.moveTo(s.center_x,s.y),i.lineTo(s.center_x,s.bottom),i.stroke();let n=this.max??this.curMax,l;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?l=this.value>n/this.unboundedStopMultiple?(.5+.5*(this.value-n/this.unboundedStopMultiple)/(n-n/this.unboundedStopMultiple))*s.h:.5*(this.value-this.min)/(n/this.unboundedStopMultiple-this.min)*s.h:l=(this.value-this.min)/(n-this.min)*s.h,i.strokeStyle=this.disable?this.disableColor2:this.bgColor,i.beginPath(),i.arc(s.center_x,s.y+l,r,0,2*Math.PI),i.stroke(),i.fillStyle=this.color,(this._touching||this.disable)&&(i.fillStyle=this.disable?this.disableColor1:this.selectColor),i.fill()}}}class Et extends V{_activeDOMInput=null;focus=!0;disable=!1;_inputSanitizer=void 0;constructor(t={}){super(),this._textData=null,t!==null&&this.updateProperties(t)}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):(this.clearDOM(),!1)}on_touch_up(t,i,e){return super.on_touch_up(t,i,e)?!0:e.grabbed!=this?!1:!this.disable&&this.collide(e.rect)?(this._touching=!1,this.addDOMInput(),!0):(this.clearDOM(),!1)}on_layout(t,i,e){this.clearDOM()}DOMInputRect(){let t=this.rect,i=this.getTransformRecurse(),e=new v,s=i.transformPoint(new DOMPoint(t.x,t.y)),r=i.transformPoint(new DOMPoint(t.right,t.bottom));return[e.x,e.y]=[s.x,s.y],[e.w,e.h]=[r.x,r.y],e.w-=e.x,e.h-=e.y,e}addDOMInput(){if(!this._textData)return;p.get();let t=document.getElementById("eskvapp");if(!t)return;let i=this.wrap?"textarea":"input",e=document.createElement(i);if(!(e instanceof HTMLInputElement)&&!(e instanceof HTMLTextAreaElement))return;let s,r=this.DOMInputRect(),n=this.color!=null?this.color:"white",l=this.bgColor!=null?this.bgColor:"black";e.style.color=n,s=this._textData.size/this.h*r.h/this._textData.outText.length,i=="textarea"&&this._textData.outText.length,e.value=this.text,s=(Math.floor(s*100)/100).toString()+"px",e.style.fontSize=s,e.style.backgroundColor=l,e.style.top=(Math.floor(r.y*100)/100).toString()+"px",e.style.left=(Math.floor(r.x*100)/100).toString()+"px",e.style.width=(Math.floor(r.w*100)/100).toString()+"px",e.style.height=(Math.floor(r.h*100)/100).toString()+"px",e.style.fontFamily=this.fontName,this._activeDOMInput=e,t.appendChild(e),e.addEventListener("focusout",a=>this.clearDOM()),e.focus(),e.select(),this.focus=!0}clearDOM(){if(this._activeDOMInput!=null){this.text=this._inputSanitizer?this._inputSanitizer(this._activeDOMInput.value,this):this._activeDOMInput.value;let t=this._activeDOMInput;this._activeDOMInput=null,t.remove(),this.focus=!1,this._needsLayout=!0;let i=p.get().inputHandler;i?.grabbed===this&&i.ungrab()}}layoutChildren(){if(super.layoutChildren(),this._activeDOMInput!=null){let t=this.DOMInputRect(),i=this._activeDOMInput;i.style.top=(Math.floor(t.y*100)/100).toString()+"px",i.style.left=(Math.floor(t.x*100)/100).toString()+"px",i.style.width=(Math.floor(t.w*100)/100).toString()+"px",i.style.height=(Math.floor(t.h*100)/100).toString()+"px"}}}class Vt extends k{bgColor=null;outlineColor=null;src=null;lockAspect=!0;scaleToFit=!0;antiAlias=!0;angle=0;anchor="center";mirror=!1;constructor(t=null){super(),this.image=new Image,t!==null&&this.updateProperties(t),this.src&&(this.image.src=this.src)}on_src(t,i,e){this.src?this.image.src=this.src:this.image.src=""}layoutChildren(){this._layoutNotify&&this.emit("layout",null);let t=p.get();"w"in this.hints&&this.hints.w==null&&(this[2]=this.image.width/t.tileSize),"h"in this.hints&&this.hints.h==null&&(this[3]=this.image.height/t.tileSize),this._needsLayout=!1,super.layoutChildren()}draw(t,i){if(super.draw(t,i),!this.image.complete||this.image.naturalHeight==0)return;let e=1-2*(this.mirror?1:0),s=this.rect;if(this.scaleToFit||(s.x+=s.w/2-this.image.width/2/t.tileSize,s.y+=s.h/2-this.image.height/2/t.tileSize,s.w=this.image.width/t.tileSize,s.h=this.image.height/t.tileSize),this.lockAspect){let n=this.image.height/this.image.width,l=s.h/s.w,a=s.h,o=s.w;n<l&&(a=s.w*n),n>l&&(o=s.h/n),s.x+=s.w/2-o/2,s.y+=s.h/2-a/2,s.w=o,s.h=a}i.save(),i.imageSmoothingEnabled=this.antiAlias;let r=this.anchor;r=="center"?r=[s.w/2,s.h/2]:r=[r[0]*s.w,r[1]*s.h],i.translate(s.x+r[0],s.y+r[1]),this.angle!=0&&i.rotate(this.angle),e&&i.scale(-1,1),i.translate(-r[0],-r[1]),i.drawImage(this.image,0,0,this.image.width,this.image.height,0,0,s.w,s.h),i.restore()}}class Z extends k{spacingX=0;spacingY=0;paddingX=0;paddingY=0;orientation="vertical";order="forward";constructor(t=null){super(),t!==null&&this.updateProperties(t)}*iterChildren(){if(this.order==="forward")for(let t of this._children)yield t;else for(let t=this._children.length-1;t>=0;t--)yield this._children[t]}on_numX(t,i,e){this._needsLayout=!0}on_numY(t,i,e){this._needsLayout=!0}on_spacingX(t,i,e){this._needsLayout=!0}on_spacingY(t,i,e){this._needsLayout=!0}on_paddingX(t,i,e){this._needsLayout=!0}on_paddingY(t,i,e){this._needsLayout=!0}on_orientation(t,i,e){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let t=this.getMetric(this,"spacingX",this.spacingX),i=this.getMetric(this,"spacingY",this.spacingY),e=this.getMetric(this,"paddingX",this.paddingX),s=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation==="vertical"){let r=this.children.length,n=this.h-i*(r-1)-2*s,l=this.w-2*e,a=0;for(let c of this.iterChildren())c.w=l,this.applyHints(c,l,n),"h"in c.hints&&(c.hints.h===null&&c.layoutChildren(),a+=c.h,r--);let o=(n-a)/r,u=l;r===0&&n>0&&(s=(n-a)/2);let d=this.y+s,f=this.x+e;for(let c of this.iterChildren())c.y=d,!("x"in c.hints)&&!("center_x"in c.hints)&&!("right"in c.hints)&&(c.x=f),"w"in c.hints||(c.w=u),"h"in c.hints||(c.h=o),c.layoutChildren(),d+=i+c.h;r===0&&"h"in this.hints&&this.hints.h===null&&(this[3]=d+s-this.y);return}if(this.orientation==="horizontal"){let r=this.children.length,n=this.h-2*s,l=this.w-t*(r-1)-2*e,a=0;for(let c of this.iterChildren())c.h=n,this.applyHints(c,l,n),"w"in c.hints&&(c.hints.w===null&&c.layoutChildren(),a+=c.w,r--);let o=n,u=(l-a)/r;r===0&&l>0&&(e=(l-a)/2);let d=this.y+s,f=this.x+e;for(let c of this.iterChildren())c.x=f,!("y"in c.hints)&&!("center_y"in c.hints)&&!("bottom"in c.hints)&&(c.y=d),"w"in c.hints||(c.w=u),"h"in c.hints||(c.h=o),c.layoutChildren(),f+=t+c.w;r==0&&"w"in this.hints&&this.hints.w==null&&(this[2]=f+e-this.x)}}}class wt extends k{activePage=0;constructor(t=null){super(),t!==null&&this.updateProperties(t)}on_wheel(t,i,e){const s=this.children[this.activePage]??void 0;return!!(s!==void 0&&s.emit(t,e))}on_touch_down(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(t,r))return!0}else{const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(t,e))return!0}return!1}on_touch_up(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(t,r))return!0}else{const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(t,e))return!0}return!1}on_touch_move(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(t,r))return!0}else{const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(t,e))return!0}return!1}on_touch_cancel(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(t,r))return!0}else{const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(t,e))return!0}return!1}on_activePage(t,i,e){this._needsLayout=!0}_draw(t,i,e){this.draw(t,i);let s=this.getTransform();if(s){i.save(),i.transform(s.a,s.b,s.c,s.d,s.e,s.f);let n=this.children[this.activePage]??void 0;n!==void 0&&n._draw(t,i,e),i.restore();return}let r=this.children[this.activePage]??void 0;r!==void 0&&r._draw(t,i,e)}}class Nt extends wt{tabHeightHint="1";tabGroupName="tabbedNotebookGroup";constructor(t=null){super(),this.buttonBox=new Z({orientation:"horizontal",hints:{h:this.tabHeightHint,w:null}}),this.buttonScroller=new J({id:"_scrollview",hints:{h:this.tabHeightHint,w:1},children:[this.buttonBox]}),this._children=[this.buttonScroller],this.buttonScroller.parent=this,t!==null&&this.updateProperties(t),this.updateButtons()}on_tabHeightHint(t,i,e){this.buttonBox.hints.h=this.tabHeightHint}on_child_added(t,i,e){this.updateButtons()}on_child_removed(t,i,e){this.updateButtons()}on_wheel(t,i,e){const s=this._children[0]??void 0;if(s!==void 0&&s.emit(t,e))return!0;const r=this.children[this.activePage]??void 0;return!!(r!==void 0&&r.emit(t,e))}on_touch_down(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];const l=this._children[0]??void 0;if(l!==void 0&&l.emit(t,r))return!0;const a=this.children[this.activePage]??void 0;if(a!==void 0&&a.emit(t,r))return!0}else{const r=this._children[0]??void 0;if(r!==void 0&&r.emit(t,e))return!0;const n=this.children[this.activePage]??void 0;if(n!==void 0&&n.emit(t,e))return!0}return!1}on_touch_up(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];const l=this._children[0]??void 0;if(l!==void 0&&l.emit(t,r))return!0;const a=this.children[this.activePage]??void 0;if(a!==void 0&&a.emit(t,r))return!0}else{const r=this._children[0]??void 0;if(r!==void 0&&r.emit(t,e))return!0;const n=this.children[this.activePage]??void 0;if(n!==void 0&&n.emit(t,e))return!0}return!1}on_touch_move(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];const l=this._children[0]??void 0;if(l!==void 0&&l.emit(t,r))return!0;const a=this.children[this.activePage]??void 0;if(a!==void 0&&a.emit(t,r))return!0}else{const r=this._children[0]??void 0;if(r!==void 0&&r.emit(t,e))return!0;const n=this.children[this.activePage]??void 0;if(n!==void 0&&n.emit(t,e))return!0}return!1}on_touch_cancel(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];const l=this._children[0]??void 0;if(l!==void 0&&l.emit(t,r))return!0;const a=this.children[this.activePage]??void 0;if(a!==void 0&&a.emit(t,r))return!0}else{const r=this._children[0]??void 0;if(r!==void 0&&r.emit(t,e))return!0;const n=this.children[this.activePage]??void 0;if(n!==void 0&&n.emit(t,e))return!0}return!1}get children(){return this._children.slice(1)}set children(t){for(let i of this._children.slice(1))this.emit("child_removed",i),i.parent=null,this._needsLayout=!0,this.updateButtons();this._children=this._children.slice(0,1);for(let i of t)this.addChild(i)}updateButtons(){this.buttonBox.children=[];let t=0;for(let i of this.children){const e=new mt({text:i.name??String(t+1),group:this.tabGroupName,singleSelect:!0,press:this.activePage===t,fontSize:"0.5",hints:{h:null,w:null}});e.bind("press",(s,r,n)=>{this.activePage=this.buttonBox.children.findIndex(l=>l===r)}),this.buttonBox.addChild(e),t++}}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;const t=this._children[0];this.applyHints(t),t.x=this.x,t.y=this.y,t.layoutChildren();const i=this.h-t.h,e=this.w;for(let s of this.children)s.y=this.y+t.h,s.x=this.x,s.w=e,s.h=i,s.layoutChildren()}_draw(t,i,e){this.draw(t,i);let s=this.getTransform();if(s){i.save(),i.transform(s.a,s.b,s.c,s.d,s.e,s.f);let l=this._children[0]??void 0;l!==void 0&&l._draw(t,i,e);let a=this.children[this.activePage]??void 0;a!==void 0&&a._draw(t,i,e),i.restore();return}let r=this._children[0]??void 0;r!==void 0&&r._draw(t,i,e);let n=this.children[this.activePage]??void 0;n!==void 0&&n._draw(t,i,e)}}class qt extends k{numX=1;numY=1;spacingX=0;spacingY=0;paddingX=0;paddingY=0;orientation="horizontal";constructor(t=null){super(),t!==null&&this.updateProperties(t)}on_numX(t,i,e){this._needsLayout=!0}on_numY(t,i,e){this._needsLayout=!0}on_spacingX(t,i,e){this._needsLayout=!0}on_spacingY(t,i,e){this._needsLayout=!0}on_paddingX(t,i,e){this._needsLayout=!0}on_paddingY(t,i,e){this._needsLayout=!0}on_orientation(t,i,e){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let t=this.getMetric(this,"spacingX",this.spacingX),i=this.getMetric(this,"spacingY",this.spacingY),e=this.getMetric(this,"paddingX",this.paddingX),s=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation=="horizontal"){let r=this.numX,n=Math.ceil(this.children.length/this.numX),l=this.h-i*(n-1)-2*s,a=this.w-t*(r-1)-2*e,o=new Array(r).fill(0),u=new Array(n).fill(0),d=0,f=0,c=0;for(let y of this.children)this.applyHints(y,a,l),"w"in y.hints&&(o[f]=Math.max(y.w,o[f])),"h"in y.hints&&(u[d]=Math.max(y.h,u[d])),(c+1)%r==0?(d++,f=0):f++,c++;let g=0,_=0,S=0,x=0;for(let y of o)g+=y,y>0&&S++;for(let y of u)_+=y,y>0&&x++;let C=n>x?(l-_)/(n-x):0,L=r>S?(a-g)/(r-S):0,z=this.y+s,R=this.x+e;d=0,f=0;for(let y=0;y<this.children.length;y++){let I=this.children[y],N=o[f]==0?L:o[f],q=u[d]==0?C:u[d];"w"in I.hints||(I.w=N),"h"in I.hints||(I.h=q),I.x=R,I.y=z,I.layoutChildren(),(y+1)%r==0?(R=this.x+e,z+=i+q,f=0,d++):(R+=t+N,f++)}return}else{let r=Math.ceil(this.children.length/this.numY),n=this.numY,l=this.h-i*(n-1)-2*s,a=this.w-t*(r-1)-2*e,o=new Array(r).fill(0),u=new Array(n).fill(0),d=0,f=0,c=0;for(let y of this.children)this.applyHints(y,a,l),"w"in y.hints&&(o[f]=Math.max(y.w,o[f])),"h"in y.hints&&(u[d]=Math.max(y.h,u[d])),(c+1)%n==0?(f++,d=0):d++,c++;let g=0,_=0,S=0,x=0;for(let y of o)g+=y,y>0&&S++;for(let y of u)_+=y,y>0&&x++;let C=n>x?(l-_)/(n-x):0,L=r>S?(a-g)/(r-S):0,z=this.y+s,R=this.x+e;d=0,f=0;for(let y=0;y<this.children.length;y++){let I=this.children[y],N=o[f]==0?L:o[f],q=u[d]==0?C:u[d];"w"in I.hints||(I.w=N),"h"in I.hints||(I.h=q),I.x=R,I.y=z,I.layoutChildren(),(y+1)%n==0?(z=this.y+s,R+=t+N,d=0,f++):(z+=i+q,d++)}}}}class J extends k{_scrollX=0;_scrollY=0;scrollX=0;scrollY=0;scrollW=!0;scrollH=!0;wAlign="center";hAlign="top";uiZoom=!0;uiMove=!0;zoom=1;vel=null;velCutoff=1e-5;velDecay=.95;unboundedH=!1;unboundedW=!1;_zoomCenter=null;constructor(t=null){super(),t!==null&&this.updateProperties(t),this._processTouches=!0,this._oldTouch=null,this._lastDist=null}on_child_added(t,i,e){this.children.length==1&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0,e.bind("rect",(s,r,n)=>this._needsLayout=!0),e.bind("w",(s,r,n)=>this._needsLayout=!0),e.bind("h",(s,r,n)=>this._needsLayout=!0))}on_child_removed(t,i,e){this.children.length==0&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.children[0][0]=0,this.children[0][1]=0,this.scrollW||(this.children[0][2]=this.w),this.scrollH||(this.children[0][3]=this.h);for(let t of this.children)t.layoutChildren()}fitToClient(){this.zoom=Math.min(this.w/this.children[0].w,this.h/this.children[0].h),this.scrollX=.5*this.scrollableW,this.scrollY=.5*this.scrollableH}on_uiZoom(t,i,e){this._needsLayout=!0}on_hAlign(t,i,e){this._needsLayout=!0}on_vAlign(t,i,e){this._needsLayout=!0}*iter(t=!0,i=!0){if(yield this,!!t)if(i)for(let e of this._children)this.contains(e)&&(yield*e.iter(...arguments));else for(let e of this._children)yield*e.iter(...arguments)}on_scrollW(t,i,e){this._needsLayout=!0,this.scrollX=0}on_scrollH(t,i,e){this._needsLayout=!0,this.scrollY=0}on_scrollX(t,i,e){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedW){this._scrollX=this.scrollX;return}let s=0;switch(this.wAlign){case"center":s=.5*this.scrollableW;break;case"right":s=1*this.scrollableW}this._scrollX=this.scrollableW<=0||this.scrollableW>=this.children[0].w?s:e,this._scrollX=K(e,0,this.scrollableW)}on_scrollY(t,i,e){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedH){this._scrollY=this.scrollY;return}let s=0;switch(this.hAlign){case"middle":s=.5*this.scrollableH;break;case"bottom":s=1*this.scrollableH}this._scrollY=this.scrollableH<=0||this.scrollableH>=this.children[0].h?s:e,this._scrollY=K(e,0,this.scrollableH)}update(t,i){if(super.update(t,i),this.vel!==null){this.scrollX+=this.vel.x*i,this.scrollY+=this.vel.y*i,this.vel=this.vel.scale(this.velDecay**(i/30));let e=this.vel.abs();e.x<=this.velCutoff/this.zoom&&e.y<=this.velCutoff/this.zoom&&(this.vel=null)}}getTransform(){const t=p.get().tileSize;return new DOMMatrix().translate(Math.floor((this.x-this._scrollX*this.zoom)*t)/t,Math.floor((this.y-this._scrollY*this.zoom)*t)/t).scale(this.zoom,this.zoom)}on_touch_down(t,i,e){this.vel=null;let s=e.rect;if(this._lastDist=null,this.collide(s)){let r=Date.now(),n=e.asChildTouch(this);return this._oldTouch=[n.x,n.y,n.identifier,r,null],super.on_touch_down(t,i,e)||e.grab(this),!0}return!1}on_touch_up(t,i,e){if(e.grabbed!==this)return!1;if(this._oldTouch!=null){let s=this._oldTouch[4],r=new w([this._oldTouch[0],this._oldTouch[1]]),n=e.asChildTouch(this),l=Math.max(Date.now()-this._oldTouch[3],1),a=this.scrollableW>0||this.unboundedW?(n.x-r.x)/l:0,o=this.scrollableH>0||this.unboundedH?(n.y-r.y)/l:0;this.vel=new w([-a,-o]),s&&(this.vel=this.vel.add(s).scale(.5))}return this._oldTouch=null,this._lastDist=null,this._zoomCenter=null,e.ungrab(),!1}on_touch_move(t,i,e){if(e.grabbed!==this)return!1;let s=e.rect;if(this.collide(s)){let r=e.asChildTouch(this);if((this.uiMove&&e.nativeEvent==null||e.nativeEvent instanceof TouchEvent&&e.nativeEvent.touches.length==1)&&this._oldTouch!=null&&e.identifier==this._oldTouch[2]){this.scrollW&&(this.scrollX=this.scrollableW==0?0:this._scrollX+(this._oldTouch[0]-r.x)),this.scrollH&&(this.scrollY=this.scrollableH==0?0:this._scrollY+(this._oldTouch[1]-r.y));let n=e.asChildTouch(this),l=this._oldTouch,a=Date.now(),o=new w([0,0]),u=new w([0,0]);if(l!=null){let f=Math.max(a-l[3],1),c=this.scrollableW>0||this.unboundedW?(n.x-r.x)/f:0,g=this.scrollableH>0||this.unboundedH?(n.y-r.y)/f:0;o=new w([c,g]),u=l[4]!==null?l[4]:u}let d=o.abs().sum()===0?o:o.add(u).scale(.5);this._oldTouch=[n.x,n.y,e.identifier,a,d]}if(this.uiZoom&&e.nativeEvent&&e.nativeEvent instanceof TouchEvent&&e.nativeEvent.touches.length==2){let n=e.nativeEvent.touches[0],l=e.nativeEvent.touches[1],a=Tt([n.clientX,n.clientY],[l.clientX,l.clientY]);if(this._lastDist!=null){let o=this._scrollX+this.w/this.zoom/2,u=this._scrollY+this.h/this.zoom/2,d=[n.clientX,n.clientY],f=[l.clientX,l.clientY],c=this.appToChild(d),g=this.appToChild(f),_=[(c[0]+g[0])/2,(c[1]+g[1])/2];this._zoomCenter===null&&(this._zoomCenter=new w(_));let S=this.zoom*a/this._lastDist,x=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(S,x);let C=this.appToChild(d),L=this.appToChild(f),z=[(C[0]+L[0])/2,(C[1]+L[1])/2];this.scrollX=o+_[0]-z[0]-this.w/this.zoom/2,this.scrollY=u+_[1]-z[1]-this.h/this.zoom/2}this._lastDist=a}}return!1}on_touch_cancel(t,i,e){return this._lastDist=null,e.grabbed===this?(e.ungrab(),!0):!!super.on_touch_cancel(t,i,e)}on_wheel(t,i,e){let s=p.get();if(!s.inputHandler)return!0;let r=this._scrollX+this.w/this.zoom/2,n=this._scrollY+this.h/this.zoom/2,l=e.nativeObject;if(!this.collide(e.rect)&&(!this.unboundedW||!this.unboundedH)||!(l instanceof WheelEvent))return!1;if(this.uiZoom&&s.inputHandler.isKeyDown("Control")){let a=e.asChildTouch(this);a.pos[0],a.pos[1];let o=this.zoom*Math.exp(-l.deltaY/s.h),u=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(o,u);let d=e.asChildTouch(this);return d.pos[0],d.pos[1],this.scrollX=this.scrollableW==0&&!this.unboundedW?0:r-this.w/this.zoom/2,this.scrollY=this.scrollableH==0&&!this.unboundedH?0:n-this.h/this.zoom/2,this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}else{if(this.uiMove&&this.scrollW&&s.inputHandler.isKeyDown("Shift"))return this.scrollX+=this.scrollableW==0&&!this.unboundedW?0:this.w/this.zoom*(l.deltaY/s.w),this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),!0;if(this.uiMove&&this.scrollH)return this.scrollY+=this.scrollableH==0&&!this.unboundedH?0:this.h/this.zoom*(l.deltaY/s.h),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}return!1}get scrollableW(){return this.children.length==0?0:this.unboundedW?this.children[0].w-this.w/this.zoom:Math.max(this.children[0].w-this.w/this.zoom,0)}get scrollableH(){return this.children.length==0?0:this.unboundedH?this.children[0].h-this.h/this.zoom:Math.max(this.children[0].h-this.h/this.zoom,0)}_draw(t,i,e){this.draw(t,i);let s=this.rect;s[0]=Math.floor(s[0]*t.tileSize*t.pixelSize)/(t.tileSize*t.pixelSize),s[1]=Math.floor(s[1]*t.tileSize*t.pixelSize)/(t.tileSize*t.pixelSize),s[2]=Math.floor(s[2]*t.tileSize*t.pixelSize)/(t.tileSize*t.pixelSize),s[3]=Math.floor(s[3]*t.tileSize*t.pixelSize)/(t.tileSize*t.pixelSize),i.save(),i.beginPath(),i.rect(s[0],s[1],s[2],s[3]),i.clip();let r=this.getTransform();r&&i.transform(r.a,r.b,r.c,r.d,r.e,r.f),this.children[0]._draw(t,i,e),i.restore()}}class Gt extends Z{closeOnTouchOutside=!0;bgColor="slate";outlineColor="gray";dim=!0;dimScale=.8;constructor(t=null){super(),t!==null&&this.updateProperties(t)}popup(){if(this.parent==null){let t=p.get();return this.parent=t,t.addModal(this),!0}return!1}close(t=0){if(this.parent!=null){this.emit("close",t);let i=p.get();return this.parent=null,i.removeModal(this),!0}return!1}on_touch_down(t,i,e){return this.closeOnTouchOutside&&!this.collide(e.rect)?(this.close(),!0):super.on_touch_down(t,i,e)}draw(t,i){if(this.dim){let e=p.get().baseWidget.rect,s=p.get().ctx;if(!s)return;s.fillStyle="rgba(0,0,0,"+this.dimScale+")",s.rect(e[0],e[1],e[2],e[3]),s.fill(),super.draw(t,s)}}}function Ut(h,t,i){const e=Math.floor(h/t/4)>0;h=h%(t*4);const s=Math.floor(h/t);h=h%t;const r=Math.floor(h/i),n=h%i;return[e,s,r,n]}class et{constructor(t="",i=[],e=[],s={}){this.id=t,this.matchTiles=new Set(i),this.matchAdjTiles=new Set(e),this.autos=s}autoTile(t,i,e){let s=0,r=1;const n=i.get(t);if(this.matchTiles.has(n)){for(let a of[[0,-1],[1,0],[0,1],[-1,0]]){const o=t.add(a),u=i.get(o);this.matchAdjTiles.has(u)&&(s+=r),r*=2}const l=this.autos[s]??void 0;l&&e.set(t,l)}}get length(){return this.matchTiles.size}}class $t extends Ht{animations=new Map;autoTiles=new Map;tileStamps=new Map;aliases=new Map;constructor(t,i=16){super(),this.spriteSize=i,this.sw=0,this.sh=0,this.len=0,this.sheet=new Image,this.sheet.src=t,this.sheet.onload=e=>{this.sw=Math.floor(this.sheet.width/this.spriteSize),this.sh=Math.floor(this.sheet.height/this.spriteSize),this.len=this.sw*this.sh,p.get().emit("sheetLoaded",this.sheet),p.get()._needsLayout=!0}}getAlias(t){for(let i of this.aliases.keys())if(this.aliases.get(i)===t)return i}update(t,i){super.update(t,i);for(let e of this.animations.values())e.update(t,i)}sheetToDataURL(){const t=document.createElement("canvas");t.width=this.sheet.width,t.height=this.sheet.height;const i=t.getContext("2d");return i?(i.drawImage(this.sheet,0,0),t.toDataURL("image/png")):void 0}serialize(){const t={};t.spriteSize=this.spriteSize,t.src=this.sheetToDataURL();const i={};for(let s of this.animations.keys())i[String(s)]=this.animations.get(s);t.animations=i;const e={};for(let s of this.aliases.keys())e[s]=this.aliases.get(s);return t.aliases=e,t}deserialize(t){this.spriteSize=t.spriteSize,this.sheet=new Image,this.sheet.onload=i=>{this.sw=Math.floor(this.sheet.width/this.spriteSize),this.sh=Math.floor(this.sheet.height/this.spriteSize),this.len=this.sw*this.sh,p.get().emit("sheetLoaded",this.sheet),p.get()._needsLayout=!0},this.sheet.src=t.src,this.animations=new Map;for(let i in t.animations)this.animations.set(parseInt(i),t.animations[i]);this.aliases=new Map;for(let i in t.aliases)this.aliases.set(i,t.aliases[i])}drawIndexed(t,i,e,s,r=0,n=0,l=0){if(i<-1&&(i=this.animations.get(i)?.tileValue??-1),i>=0){let[a,o,u,d]=Ut(i,this.len,this.sw);o=(o+r)%4,!a&&o===0?this.draw(t,[d,u],e+n,s+l):this.drawRotated(t,[d,u],e+.5,s+.5,o*90,a,[.5-n,.5-l])}}draw(t,i,e,s,r=!1){let n=r?-1:1;r&&t.scale(-1,1),t.drawImage(this.sheet,i[0]*this.spriteSize,i[1]*this.spriteSize,this.spriteSize,this.spriteSize,n*e,s,n,1),r&&t.scale(-1,1)}drawScaled(t,i,e,s,r,n=!1){let l=n?-1:1;n&&t.scale(-1,1),t.drawImage(this.sheet,i[0]*this.spriteSize,i[1]*this.spriteSize,this.spriteSize,this.spriteSize,l*e,s,l*r,r),n&&t.scale(-1,1)}drawRotated(t,i,e,s,r,n=!1,l="center"){t.save(),l=="center"?l=[1/2,1/2]:l=[l[0],l[1]],t.translate(e,s),t.rotate(r*Math.PI/180),n&&t.scale(-1,1),t.translate(-l[0],-l[1]),t.drawImage(this.sheet,i[0]*this.spriteSize,i[1]*this.spriteSize,this.spriteSize,this.spriteSize,0,0,1,1),t.restore()}drawRotatedMultitile(t,i,e,s,r,n=!1,l="center"){t.save();let a=i[2],o=i[3];l=="center"?l=[a*1/2,o*1/2]:l=[l[0],l[1]],t.translate(e+l[0],s+l[1]),t.rotate(r*Math.PI/180),n&&t.scale(-1,1),t.translate(-l[0],-l[1]),t.drawImage(this.sheet,i[0]*this.spriteSize,i[1]*this.spriteSize,this.spriteSize*a,this.spriteSize*o,0,0,a,o),t.restore()}}class yt extends Array{constructor(t,i){super();for(let e=0;e<t.length;++e)i[e]?this.push(t[e],i[e][0],i[e][1]):this.push(t[e],0,0)}*iter(){for(let t=0;t<this.length/3;t++)yield this.slice(t*3,t*3+3)}}function b(h=[],t=[]){return new yt(h,t)}class G extends k{spriteSheet=null;frames=[];timePerFrame=30;timeLeft=0;activeFrame=0;id="";facing=0;flipX=!1;flipY=!1;constructor(t={}){super(),t&&this.updateProperties(t)}update(t,i){super.update(t,i),this.timeLeft-=i,this.timeLeft<=0&&(this.activeFrame++,this.activeFrame>=this.frames.length&&(this.activeFrame=0),this.timeLeft+=this.timePerFrame),this.frames.length>0&&t.requestFrameUpdate()}on_frames(t,i,e){this.activeFrame=0,this.timeLeft=this.timePerFrame,this._needsLayout=!0}get frame(){return this.frames[this.activeFrame]??-1}layoutChildren(){super.layoutChildren()}draw(t,i){if(this.spriteSheet===null||!this.spriteSheet.sheet.complete)return;const e=Math.floor(this.x*t.tileSize)/t.tileSize,s=Math.floor(this.y*t.tileSize)/t.tileSize;if(i.translate(e,s),i.scale(this.w,this.h),this.frame instanceof yt)for(let[r,n,l]of this.frame.iter())this.spriteSheet.drawIndexed(i,r,0,0,this.facing,n,l);else this.spriteSheet.drawIndexed(i,this.frame,0,0,this.facing);i.scale(1/this.w,1/this.h),i.translate(-e,-s)}}class bt extends k{constructor(t={}){super(),this.defaultValue=-1,this._data=new X,this._vLayer=null,this._aLayer=null,this._cacheTileDim=new w,this.tileDim=new w,this.hints={w:null,h:null},this.spriteSheet=null,this.clipRegion=null,this.alphaValue=.5,this.useCache=!0,t&&this.updateProperties(t)}serialize(){const t={};return t._data=this._data.slice(),t.tileDim=this.tileDim.slice(),t.spriteSheet=Array(...p.resources.keys()).find(i=>p.resources[i]===this.spriteSheet)??null,t}get(t){return this._data.get(t)}set(t,i){this._data.set(t,i),this._data._cacheData=null}get data(){return this._data}deserialize(t){this.tileDim=new w(t.tileDim??[0,0]);const i=t._data;for(let e=0;e<i.length;e++)this._data[e]=i[e];this.spriteSheet=p.resources[t.spriteSheet]??null,this._data._cacheData=null}on_tileDim(t,i,e){this.resizeData(),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new w(this.tileDim)}resizeData(){let t=[];for(let e=0;e<this._cacheTileDim[1];e++)for(let s=0;s<this._cacheTileDim[0];s++)t.push(this.get([s,e]));this._data.tileDim=new w(this.tileDim),this._data.length=this.tileDim[0]*this.tileDim[1],this._data.fill(this.defaultValue);let i=0;for(let e=0;e<this._cacheTileDim[1];e++)for(let s=0;s<this._cacheTileDim[0];s++)s<this.tileDim[0]&&e<this.tileDim[1]&&this.set([s,e],t[i]),++i;this._data._cacheData=null}draw(t,i){if(super.draw(t,i),this.spriteSheet===null||!this.spriteSheet.sheet.complete||!this.spriteSheet.sheet.complete||this.spriteSheet.sheet.naturalHeight==0)return;let[e,s]=[0,0],[r,n]=this.tileDim;if(this.clipRegion&&([e,s]=this.clipRegion.pos,[r,n]=this.clipRegion.pos.add(this.clipRegion.size).add([1,1]),e=Math.min(Math.max(e,0),this.tileDim[0]),r=Math.min(Math.max(r,0),this.tileDim[0]),s=Math.min(Math.max(s,0),this.tileDim[1]),n=Math.min(Math.max(n,0),this.tileDim[1])),Math.floor(this.spriteSheet.sheet.width/this.spriteSheet.spriteSize),Math.floor(this.spriteSheet.sheet.height/this.spriteSheet.spriteSize),this.useCache){if(this._data._cacheData===null&&this.cacheCanvas(),this._data._cacheData===null)return;const l=this.spriteSheet.spriteSize;if(i.drawImage(this._data._cacheData,l*e,l*s,l*(r-e),l*(n-s),this.x+e,this.y+s,r-e,n-s),this._aLayer===null&&this._vLayer===null)for(let a=e;a<r;a++)for(let o=s;o<n;o++){let u=a+o*this.tileDim[0],d=this._data[u];d<-1&&this.spriteSheet.drawIndexed(i,d,a+this.x,o+this.y)}else if(this._aLayer&&this._vLayer){const a=this._aLayer,o=this._vLayer,u=i.globalAlpha,d=this._data;for(let f=e;f<r;f++)for(let c=s;c<n;c++){let g=f+c*this.tileDim[0],_=d[g];_<-1&&o[g]>0&&(a[g]===0?(i.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(i,_,f+this.x,c+this.y),i.globalAlpha=u):this.spriteSheet.drawIndexed(i,_,f+this.x,c+this.y))}}}else if(this._aLayer===null&&this._vLayer===null)for(let l=e;l<r;l++)for(let a=s;a<n;a++){let o=l+a*this.tileDim[0],u=this._data[o];this.spriteSheet.drawIndexed(i,u,l+this.x,a+this.y)}else if(this._aLayer&&this._vLayer){const l=this._aLayer,a=this._vLayer,o=i.globalAlpha,u=this._data;for(let d=e;d<r;d++)for(let f=s;f<n;f++){let c=d+f*this.tileDim[0],g=u[c];g!==-1&&a[c]>0&&(l[c]===0?(i.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(i,g,d+this.x,f+this.y),i.globalAlpha=o):this.spriteSheet.drawIndexed(i,g,d+this.x,f+this.y))}}}clearCache(){this.data._cacheData=null}cacheCanvas(){if(this._data._cacheData=null,!this.spriteSheet||!this.spriteSheet.sheet||this.tileDim[0]<=0||this.tileDim[1]<=0)return;const t=new OffscreenCanvas(this.tileDim[0]*this.spriteSheet.spriteSize,this.tileDim[1]*this.spriteSheet.spriteSize),i=t.getContext("2d");if(!i)return;i.scale(this.spriteSheet.spriteSize,this.spriteSheet.spriteSize);let[e,s]=[0,0],[r,n]=this.tileDim;if(this._aLayer===null&&this._vLayer===null)for(let l=e;l<r;l++)for(let a=s;a<n;a++){let o=l+a*this.tileDim[0],u=this._data[o];u>=0&&this.spriteSheet.drawIndexed(i,u,l,a)}else if(this._aLayer&&this._vLayer){const l=this._aLayer,a=this._vLayer,o=i.globalAlpha,u=this._data;for(let d=e;d<r;d++)for(let f=s;f<n;f++){let c=d+f*this.tileDim[0],g=u[c];g>=0&&a[c]>0&&(l[c]===0?(i.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(i,g,d,f),i.globalAlpha=o):this.spriteSheet.drawIndexed(i,g,d,f))}}this._data._cacheData=t}}class rt extends bt{constructor(t={}){super(),this._layerData=[this._data],this.numLayers=1,this.activeLayer=0,this.visibilityLayer=-1,this.alphaLayer=-1,t&&this.updateProperties(t)}on_alphaLayer(t,i,e){this._aLayer=this.alphaLayer>=0?this._layerData[this.alphaLayer]:null}on_visibilityLayer(t,i,e){this._vLayer=this.visibilityLayer>=0?this._layerData[this.visibilityLayer]:null}serialize(){const t={},i=[];for(let e of this._layerData)i.push(e.slice());return t._layerData=i,t.activeLayer=this.activeLayer,t.numLayers=this.numLayers,t.tileDim=this.tileDim.slice(),t.spriteSheet=Array(...p.resources.keys()).find(e=>p.resources[e]===this.spriteSheet)??null,t}deserialize(t){this.numLayers=t.numLayers,this.activeLayer=t.activeLayer,this.tileDim=new w(t.tileDim??[0,0]);const i=t._layerData.length;this._layerData.length=i;for(let e=0;e<i;e++){const s=this._layerData[e],r=t._layerData[e];for(let n=0;n<r.lenth;n++)s[n]=r[n]}this.spriteSheet=p.resources[t.spriteSheet]??null,this.clearCache()}on_tileDim(t,i,e){if("_layerData"in this){for(let s of this._layerData)this._data=s,this.resizeData();this.activeLayer>=0&&(this._data=this._layerData[this.activeLayer]),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new w(this.tileDim)}}on_numLayers(t,i,e){const s=this._layerData.length;this._layerData.length=this.numLayers;for(let r=s;r<this.numLayers;r++){const n=new X(this.tileDim).fill(this.defaultValue);this._layerData[r]=n}this.activeLayer>=this.numLayers&&(this.activeLayer=this.numLayers-1)}on_activeLayer(t,i,e){this._data=this._layerData[this.activeLayer]}get layer(){return this._layerData}getFromLayer(t,i){return this._layerData[t][i[0]+i[1]*this.tileDim[0]]}setInLayer(t,i,e){this._layerData[t][i[0]+i[1]*this.tileDim[0]]=e,this._layerData[t]._cacheData=null}clearCache(){for(let t of this._layerData)t._cacheData=null}draw(t,i){for(let e of this._layerData)e.hidden||(this._data=e,super.draw(t,i));this._data=this._layerData[this.activeLayer]}}p.registerClass("Widget",k,"");p.registerClass("App",p,"");p.registerClass("Label",V,"");p.registerClass("Button",Yt,"");p.registerClass("ToggleButton",mt,"");p.registerClass("BasicButton",Xt,"");p.registerClass("TextInput",Et,"");p.registerClass("CheckBox",Rt,"");p.registerClass("Slider",Ot,"");p.registerClass("ImageWidget",Vt,"");p.registerClass("BoxLayout",Z,"");p.registerClass("GridLayout",qt,"");p.registerClass("ScrollView",J,"");p.registerClass("ModalView",Gt,"");p.registerClass("Notebook",wt,"");p.registerClass("TabbedNotebook",Nt,"");p.registerClass("SpriteWidget",G,"");p.registerClass("TileMap",bt,"");p.registerClass("LayeredTileMap",rt,"");class Kt extends G{constructor(t={}){super(),t&&this.updateProperties(t)}}const H={north:0,east:1,south:2,west:3,none:4},P={0:j(0,-1),1:j(1,0),2:j(0,1),3:j(-1,0),4:j(0,0)},Zt={0:1,1:2,2:4,3:8,4:0};function it(h){return h[1]<0?0:h[0]>0?1:h[1]>0?2:h[0]<0?3:4}const nt={randy:{standing:[b([326,4388],[[0,0],[0,-.25]])],walking:[b([323,4387],[[0,0],[0,-.25]]),b([324,4387],[[0,0],[0,-.25]]),b([4420,4388],[[0,0],[0,-.25]]),b([4419,4389],[[0,0],[0,-.25]]),b([4420,4389],[[0,0],[0,-.25]]),b([324,4388],[[0,0],[0,-.25]])],dead:[b([321,289],[[0,1],[0,0]])]},maria:{standing:[b([422,4484],[[0,0],[0,-.25]])],walking:[b([419,4483],[[0,0],[0,-.25]]),b([420,4483],[[0,0],[0,-.25]]),b([4516,4484],[[0,0],[0,-.25]]),b([4515,4485],[[0,0],[0,-.25]]),b([4516,4485],[[0,0],[0,-.25]]),b([420,4484],[[0,0],[0,-.25]])],dead:[b([417,385],[[0,1],[0,0]])]},greenShirt:{standing:[b([614,4676],[[0,0],[0,-.25]])],walking:[b([611,4675],[[0,0],[0,-.25]]),b([612,4675],[[0,0],[0,-.25]]),b([4708,4676],[[0,0],[0,-.25]]),b([4707,4677],[[0,0],[0,-.25]]),b([4708,4677],[[0,0],[0,-.25]]),b([612,4676],[[0,0],[0,-.25]])],dead:[b([609,577,641],[[0,1],[0,0]])]},whiteShirt:{standing:[b([518,484],[[0,0],[0,-.25]])],walking:[b([515,483],[[0,0],[0,-.25]]),b([516,483],[[0,0],[0,-.25]]),b([4612,484],[[0,0],[0,-.25]]),b([4611,4579],[[0,0],[0,-.25]]),b([4612,4579],[[0,0],[0,-.25]]),b([516,484],[[0,0],[0,-.25]])],dead:[b([513,481,545],[[0,1],[0,0]])]}};function Jt(h,t,i){if(t.equals(i))return[i];let e=new X(h.tileDim).fill(1/0);e.set(t,0);let s=[t],r=[],n=!1;for(;s.length>0&&!n;){let o=[];for(let d of s)for(let f of h.iterAdjacent(d)){let c=h.get(f);e.get(d)+c<e.get(f)&&(f.equals(i)&&(n=!0),e.set(f,e.get(d)+c),c>1&&!n?r.push([f,c]):o.push(f))}const u=[];for(let d of r)d[1]>1?(d[1]--,u.push(d)):o.push(d[0]);r=u,s=o}const l=[];if(e.get(i)===1/0)return l;let a=i;for(;!a.equals(t);){let o=1/0,u=null;for(let d of e.iterAdjacent(a)){const f=e.get(d);f<o&&(o=f,u=d)}l.unshift(a),u!==null&&(a=u)}return l}class O extends Kt{actions=new Set;actionInventory=null;facing=H.north;constitution=1;priorState="patrolling";state="patrolling";resumeState="patrolling";animationState="standing";animationGroup=null;gpos=j(0,0);patrolRoute=[];patrolTarget=-1;actionsThisTurn=2;visibleToPlayer=!1;history=[];suppressed=!1;movementBlockedCount=0;_coverPositions=new Set;_visibleLayer=new X;activeCharacter=!1;constructor(t={}){super(),this.spriteSheet=p.resources.sprites,this.frames=[452],this.w=1,this.h=1,t&&this.updateProperties(t)}on_actionInventory(t,i,e){if(this.actionInventory){const s=[];for(let r of this.actions)r.hints={w:"3",h:"3"},this.actionInventory.addChild(r);this.actionInventory.children=s}}addAction(t){return this.actions.has(t)?!1:(this.actions.add(t),t.hints={w:"3",h:"3"},this.actionInventory&&this.actionInventory.addChild(t),!0)}removeAction(t){return this.actions.has(t)?(this.actions.delete(t),this.actionInventory&&this.actionInventory.removeChild(t),!0):!1}on_animationState(t,i,e){this.animationGroup&&(this.frames=this.animationGroup[this.animationState])}canSee(t,i){const e=i.metaTileMap.layer[T.allowsSight],s=i.metaTileMap.layer[T.cover],r=e.tileDim[0];let n=!1;for(let l of e.iterInBetween(this.gpos,t.gpos)){if(e[l[0]+l[1]*r]===0||n)return!1;n=s[l[0]+l[1]*r]>0}return!0}setupForLevelStart(t,i){this._coverPositions=new Set,this._visibleLayer=new X([t.w,t.h]).fill(0);let e=0,s=j(1,1),r=j(1,1);for(;e<1e3&&(e++,s=W(i.getRandomPos(t.w,t.h)),t.metaTileMap.layer[T.layout].get(s)!==m.floor););for(e=0;e<1e3&&(e++,r=W(i.getRandomPos(t.w,t.h)),!(t.metaTileMap.layer[T.layout].get(r)===m.floor&&!r.equals(s))););this.patrolRoute=[s,r],this.gpos=W(r),[this.x,this.y]=this.gpos,this.animationGroup=this.id[0]==="d"?nt.greenShirt:nt.whiteShirt,this.animationState="standing"}rest(t){this.actionsThisTurn--,this.activeCharacter&&(this.updateFoV(t),this.updateCamera(t))}move(t,i){const e=this.gpos.add(P[t]),r=i.metaTileMap.getFromLayer(T.traversible,e);if(this.facing=t,r&Zt[t]&&!i.characters.reduce((n,l)=>n||l.gpos.equals(e)&&l.state!=="dead",!1)){this.pos=W(this.gpos),this.gpos=e;const n=new dt;n.add({x:this.gpos[0],y:this.gpos[1]},300),n.start(this),this.animationGroup!==null&&(this.animationState="walking",this.timePerFrame=60),this.actionsThisTurn--,this.movementBlockedCount=Math.max(this.movementBlockedCount-1,0)}else this.movementBlockedCount++;this.activeCharacter&&(this.updateFoV(i),this.updateCamera(i))}on_animationComplete(t,i,e){(this.animationState="walking")&&(this.animationState="standing")}takeDamage(t){t==="piercing"&&(this.state="dead",this.animationState="dead")}useAction(t,i,e){}updateFoV(t){const i=t.metaTileMap;this._coverPositions.clear(),this._visibleLayer.fill(0),i.activeLayer=T.allowsSight;const e=this.gpos;for(let s of i.data.iterRectBoundary(new v([...this.gpos,20,20]).translate([-10,-10]).translate(P[this.facing].scale(9)))){const r=W(s);let n=W(this.gpos),l=!1;for(let a of i.data.iterBetween(e,r)){let o=W([Math.round(a[0]),Math.round(a[1])]),u=W(o);const d=a[0]-o[0];d>0?u[0]+=1:d<0&&(u[0]-=1);const f=a[1]-o[1];f>0?u[1]+=1:f<0&&(u[1]-=1);let c=P[it(W(o).sub(n))],g=P[it(W(u).sub(n))];const _=i.get(o),S=i.get(u);let x=e.dist(o)>e.dist(u),C=!1;if((e.dist(o)===0||c[1]<0&&_&1||c[0]>0&&_&2||c[1]>0&&_&4||c[0]<0&&_&8)&&(C=!0),l?(this._coverPositions.add(o),x&&this._coverPositions.add(o)):(this._visibleLayer[o[0]+o[1]*i.w]=1,this.activeCharacter&&i.setInLayer(T.seen,o,1),x&&(this._visibleLayer[u[0]+u[1]*i.w]=1,this.activeCharacter&&i.setInLayer(T.seen,u,1))),!C)break;l=!1,(c[1]<0&&_&16||c[0]>0&&_&32||c[1]>0&&_&64||c[0]<0&&_&128||x&&g[1]<0&&S&16||x&&g[0]>0&&S&32||x&&g[1]>0&&S&64||x&&g[0]<0&&S&128)&&(l=!0),n=W(o)}}t.tileMap.clearCache()}updateCamera(t){const i=p.get().findById("scroller");if(i){const e=this.gpos.add(P[this.facing].scale(5)),s=e.dist(this.gpos);let r=Math.min(Math.max(e[0]+.5-i.w/i.zoom/2,0),t.w),n=Math.min(Math.max(e[1]+.5-i.h/i.zoom/2,0),t.h);const l=p.get().tileSize;r=Math.floor(r*l)/l,n=Math.floor(n*l)/l;const a=new dt;a.add({scrollX:r,scrollY:n},250*s/2),a.start(i)}}takeAction(t,i,e={}){if(this.actions.has(t)){const s=t.request(this,i,e);return s.result==="complete"&&(this.history.push([t,e]),this.actionsThisTurn--),s}return{result:"notAvailable"}}takeTurn(t){for(t.updateCharacterVisibility(!0);this.actionsThisTurn>0;)if(this.state==="patrolling"){if(this.patrolTarget<0&&(this.patrolTarget=0),this.patrolRoute.length===0)break;this.gpos.equals(this.patrolRoute[this.patrolTarget])&&(this.patrolTarget=(this.patrolTarget+1)%this.patrolRoute.length);const i=this.gpos,e=this.patrolRoute[this.patrolTarget],s=new X([t.w,t.h]);t.metaTileMap.layer[T.layout].forEach((n,l)=>{s[l]=n===m.wall?1/0:1});for(let n of t.characters)n!==this&&s.set(n.gpos,s.get(n.gpos)+(n.movementBlockedCount<=this.movementBlockedCount?4+this.movementBlockedCount*2:4));const r=Jt(s,i,e);r.length>0&&(this.move(it(r[0].sub(this.gpos)),t),this.history.push([new ht,{}])),this.actionsThisTurn--,t.updateCharacterVisibility(!0)}else this.state==="dead"&&this.actionsThisTurn--;this.actionsThisTurn=2}draw(t,i){(this.activeCharacter||this.visibleToPlayer)&&super.draw(t,i)}}class ct extends O{constructor(t={}){super(),this.spriteSheet=p.resources.sprites,this.frames=[259],t&&this.updateProperties(t)}setupForLevelStart(t){this._coverPositions=new Set,this.animationGroup=nt[this.id],this.animationState="standing",this.activeCharacter?(this._visibleLayer=t.metaTileMap._layerData[T.visible],this._visibleLayer.fill(0)):this._visibleLayer=new X([t.w,t.h]).fill(0)}canSee(t,i){const e=this._visibleLayer,[s,r]=t.gpos;return e[s+r*e.tileDim[0]]>0}getActionForKey(t){return[...this.actions].find(i=>i.keyControl===t)}}class ht extends Z{orientation="vertical";keyControl="";constructor(t={}){super(),this.hints={h:"5"},this.sprite=new G({spriteSheet:p.resources.sprites}),this.label=new V({hints:{h:"1"}}),this.children=[this.sprite,this.label],t&&this.updateProperties(t)}request(t,i,e){return{result:"notAvailable"}}get name(){return this.label.text}set name(t){this.label.text=t}}class Qt extends ht{keyControl="f";constructor(){super(),this.label.text="Rifle",this.sprite.frames=[736],this.ammo=200,this.mode="single"}request(t,i,e){if(e.targetCharacter instanceof O&&e.targetCharacter!==t)return this.fire(t,i,e.targetCharacter)?{result:"complete",message:"Target hit"}:{result:"complete",message:"Target missed"};if(this.ammo>0){const s=[];for(let r of i.characters)r!==t&&t.canSee(r,i)&&s.push(r);return s.length>0?{message:"Select target",result:"infoNeeded",validTargetCharacters:s}:{message:"No visible target",result:"notAvailable"}}else return{message:"Out of ammo",result:"notAvailable"}}fire(t,i,e){this.ammo-=this.mode==="single"?1:5;const s=e;return(this.mode==="single"?!0:i.rng.random()>.5)?(s.takeDamage("piercing"),!0):!1}}const T={layout:0,seen:1,visible:2,traversible:3,allowsSight:4,allowsSound:5,cover:6,moveCost:7},m={outside:0,floor:1,water:2,wall:3,doorway:4,window:5},te={tree:163},ft={0:103,1:74},ee={1:1120,2:96,4:1120,8:96,5:1120,10:96,3:97,6:1121,12:2145,9:3169,7:1122,11:98,13:3170,14:2146,15:99},st={wall:new et("mansionWalls",[m.wall],[m.wall,m.doorway,m.window],ee),doorway:new et("mansionDoorway",[m.doorway],[m.wall,m.doorway,m.window],{1:0,2:0,4:0,8:0,5:0,10:0}),window:new et("mansionWindow",[m.window],[m.wall,m.doorway,m.window],{1:0,2:0,4:0,8:0,5:0,10:0})};function ie(h,t){const i=t.w,e=t.h,s=t.pos;for(let r of h.data.iterBetween(s,s.add([i,0])))m.outside===h.get(r)&&h.set(r,m.wall);for(let r of h.data.iterBetween(s,s.add([0,e])))m.outside===h.get(r)&&h.set(r,m.wall);for(let r of h.data.iterBetween(s.add([0,e]),s.add([i,e])))m.outside===h.get(r)&&h.set(r,m.wall);for(let r of h.data.iterBetween(s.add([i,0]),s.add([i,e])))m.outside===h.get(r)&&h.set(r,m.wall)}function U(h,t){return h.get(t.add(P[0]))===m.wall&&h.get(t.add(P[2]))===m.wall&&h.get(t.add(P[1]))!==m.wall&&h.get(t.add(P[3]))!==m.wall||h.get(t.add(P[1]))===m.wall&&h.get(t.add(P[3]))===m.wall&&h.get(t.add(P[0]))!==m.wall&&h.get(t.add(P[2]))!==m.wall?(h.set(t,m.doorway),!0):!1}function se(h,t,i){for(let e of h.data.iterRect([t[0]+1,t[1]+1,t[2]-1,t[3]-1]))h.set(e,m.floor);ie(h,t)}function re(h,t,i){if(!h.data.hasTypesBetween([t[0],t[1]],[t[0]+t[2],t[1]],[m.doorway])){const e=t[0]+1+i.getRandomInt(t[2]-2);U(h,new w([e,t[1]]))}if(!h.data.hasTypesBetween([t[0],t[1]+t[3]],[t[0]+t[2],t[1]+t[3]],[m.doorway])){const e=t[0]+1+i.getRandomInt(t[2]-2);U(h,new w([e,t[1]+t[3]]))}if(!h.data.hasTypesBetween([t[0],t[1]],[t[0],t[1]+t[3]],[m.doorway])){const e=t[1]+1+i.getRandomInt(t[3]-2);U(h,new w([t[0],e]))}if(!h.data.hasTypesBetween([t[0]+t[2],t[1]],[t[0]+t[2],t[1]+t[3]],[m.doorway])){const e=t[1]+1+i.getRandomInt(t[3]-2);U(h,new w([t[0]+t[2],e]))}}function A(h,t,i,e,s,r,n=.5,l=0,a=0){if(h.w<=t*2&&h.h<=t*2||h.w<=i||h.h<=i)return h.x>0&&h.y>0&&h.x+h.w<r.w-1&&h.y+h.h<r.h-1?(e.push(h),!0):!1;if((h.w<t+i?0:h.h<t+i||h.w>h.h?1:h.h<h.w?0:s.random()>n?1:0)===0){if(h.h>=2*t+i&&h.w>=2*t&&s.random()>a){const f=Math.floor((h.h-2*t-i)/4),c=Math.floor(s.random()*(h.h-2*t-i-2*f))+t+f;if(A(new v([h.x,h.y+c,h.w,i]),t,i,e,s,r,0,l,a))return A(new v([h.x,h.y,h.w,c]),t,i,e,s,r,0,l,a),A(new v([h.x,h.y+c+i,h.w,h.h-c-i]),t,i,e,s,r,0,l,a),!0}const u=Math.floor((h.h-2*t)/4),d=Math.floor(s.random()*(h.h-2*t-2*u))+t+u;A(new v([h.x,h.y,h.w,d]),t,i,e,s,r,0,l,a),A(new v([h.x,h.y+d,h.w,h.h-d]),t,i,e,s,r,0,l,a)}else{if(h.w>=2*t+i&&h.h>=2*t&&s.random()>l){const f=Math.floor((h.w-2*t-i)/4),c=Math.floor(s.random()*(h.w-2*t-i-2*f))+t+f;if(A(new v([h.x+c,h.y,i,h.h]),t,i,e,s,r,1,l,a))return A(new v([h.x,h.y,c,h.h]),t,i,e,s,r,1,l,a),A(new v([h.x+c+i,h.y,h.w-c-i,h.h]),t,i,e,s,r,1,l,a),!0}const u=Math.floor((h.w-2*t)/4),d=Math.floor(s.random()*(h.w-2*t-2*u))+t+u;A(new v([h.x,h.y,d,h.h]),t,i,e,s,r,1,l,a),A(new v([h.x+d,h.y,h.w-d,h.h]),t,i,e,s,r,1,l,a)}return!0}function ne(h,t){h.w=80,h.h=40;const[i,e]=[h.w,h.h],s=new w([h.w,h.h]),r=h.tileMap;r.useCache=!0,r.numLayers=3,r.tileDim=s,r.activeLayer=0;const n=h.metaTileMap;n.defaultValue=0,n.numLayers=8,n.tileDim=s,n.activeLayer=0;for(const d of n.data.iterAll())n.set(d,m.outside);const l=[],a=new v([0,0,i,e]);A(a,5,3,l,t,a);for(let d of l)se(n,d);for(let d of l)re(n,d,t);const o=[];for(let d of n.data.iterAll()){const f=n.get(d);if(f===m.outside&&t.random()>.95&&o.push(d),f in ft)r.set(d,ft[f]);else{const g=new w(d);st.wall.autoTile(g,n,r),st.doorway.autoTile(g,n,r),st.window.autoTile(g,n,r)}const c=f===m.wall?0:15;n.setInLayer(T.traversible,d,c)}r.activeLayer=1;const u=n._layerData[T.allowsSight];n.activeLayer=T.layout;for(let d of n.data.iterAll()){n.setInLayer(T.seen,d,n.data.numInRange(d,[m.outside],1.5)>0?1:0);const f=n.getFromLayer(T.layout,d),c=d[0]+d[1]*i;u[c]|=f===m.wall?0:15}for(let d of o){r.set(d,te.tree);const f=d[0]+d[1]*i;u[f]|=240}r._vLayer=n._layerData[T.seen],r._aLayer=n._layerData[T.visible],r.clearCache()}class le extends k{_validCells=[];_validCharacters=[];activeCell=-1;constructor(t={}){super(),t&&this.updateProperties(t)}set validCharacters(t){this._validCharacters=t,this._validCells=this.validCharacters.map(i=>i.gpos),this.setupValidCells()}get validCharacters(){return this._validCharacters}set validCells(t){this._validCharacters=[],this._validCells=t,this.setupValidCells()}get validCells(){return this._validCells}setupValidCells(){const t=[];let i=0;for(let e of this._validCells)t.push(new G({spriteSheet:p.resources.sprites,x:e[0],y:e[1],w:1,h:1,frames:[this.activeCell===i?6:5]})),i++;this.children=t,this.activeCell=this._validCells.length>0?0:-1}on_activeCell(t,i,e){let s=0;for(let r of this.children)r instanceof G&&(r.frames=[this.activeCell===s?6:5]),s++}moveActiveCell(t){const i=this.validCells[this.activeCell];let e=0,s=1/0,r=-1,n=this.activeCell,l=0;for(let a of this.validCells){const o=a.sub(i),u=o.mul(t).sum()+j(1,1).sub(t.abs()).mul(o).sum();u>0&&u<s&&(s=u,r=l),u<0&&u<e&&(e=u,n=l),l++}this.activeCell=r>=0?r:n}}class he extends k{rng=new pt;clipRegion=new v;tileMap=new rt;metaTileMap=new rt;enemies=[new O({id:"alfred"}),new O({id:"bennie"}),new O({id:"charlie"}),new O({id:"devon"})];entities=new k({hints:{h:1,w:1}});playerCharacters=[new ct({id:"randy",x:0,y:0,activeCharacter:!0}),new ct({id:"maria",activeCharacter:!1})];characters=[...this.enemies,...this.playerCharacters];activeCharacter=this.playerCharacters[0];spriteSheet=null;constructor(t=null){super(),this.positionSelector=new le,this.children=[this.tileMap,this.entities,this.positionSelector,...this.enemies,...this.playerCharacters],t&&this.updateProperties(t)}setupLevel(){ne(this,this.rng),this.playerCharacters[0].setupForLevelStart(this,this.rng),this.enemies.forEach(t=>t.setupForLevelStart(this,this.rng)),this.playerCharacters[0].actionInventory=p.get().findById("firstPlayerInventory"),this.playerCharacters[0].addAction(new Qt)}on_spriteSheet(){this.tileMap.spriteSheet=this.spriteSheet}on_parent(t,i,e){const s=this.parent;s instanceof J&&(s.bind("scrollX",(r,n,l)=>this.updateClipRegion(n)),s.bind("scrollY",(r,n,l)=>this.updateClipRegion(n)),s.bind("zoom",(r,n,l)=>this.updateClipRegion(n)),this.updateClipRegion(s))}updateClipRegion(t){this.tileMap.clipRegion=new v([Math.floor(t._scrollX),Math.floor(t._scrollY),Math.ceil(t.w/t.zoom),Math.ceil(t.h/t.zoom)])}updateCharacterVisibility(t=!1){this.activeCharacter;for(let i of this.enemies)t&&(i.visibleToPlayer=!1),i.visibleToPlayer=i.visibleToPlayer||this.activeCharacter?._visibleLayer.get(i.gpos)===1}targetSelector(t,i,e){}prompt(t,i){}getCharacterAt(t){for(let i of this.characters)if(i.gpos.equals(t))return i;return null}}const ae=""+new URL("spritesheet-B0ZxbgTM.png",import.meta.url).href,oe=`

Game:
    prefDimW: 20
    prefDimH: 21
    integerTileSize: true
    tileSize: 16
    Notebook:
        hints: {w:1, h:1}
        id: 'notebook'
        BoxLayout:
            id: 'game'
            orientation: 'vertical'
            hints: {center_x:0.5, center_y:0.5, w:1, h:1}
            BoxLayout:
                hints: {h:'1'}
                orientation: 'horizontal'
                FPS:
                    align:'left'
                Label:
                    id: 'messageLabel'
                    text: 'Welcome to the mansion'
                    align: 'left'
                Button: 
                    text: 'Help'
                    hints: {w: '3'}
                    on_press:
                        const help = window.app.findById('help');
                        help.helpVal = 0;
                        const nb = window.app.findById('notebook');
                        nb.activePage = 1;
                Button: 
                    text:  \`\${scroller.zoom*100}%\`
                    hints: {w: '3'}
                    id: 'zoomButton'
                    on_press:
                        const scroller = window.app.findById('scroller');
                        if(!scroller) return;
                        const zoom = Math.floor(scroller.zoom + 1);
                        scroller.zoom = zoom<4? zoom:0.5;
            BoxLayout:
                bgColor: 'rgb(35,35,45)'
                orientation: 'horizontal'
                BoxLayout:
                    orientation: 'vertical'
                    hints: {w:'4'}
                    id: 'firstPlayer'
                    Label:
                        text:\`Randy \${randy.gpos}\`
                        hints: {h:'1'}
                        sizeGroup: 'actionItems'
                        align: 'left'
                    SpriteWidget:
                        spriteSheet: resources['sprites']
                        frames: [354]
                        hints: {w:'3', h:'3'}
                    BoxLayout:
                        hints: {h:null}
                        id: 'firstPlayerInventory'
                    Widget:
                        id: 'padding2'
                BoxLayout:
                    hints: {w:'4', h:null}
                    padding: '2'
                    orientation: 'vertical'
                    id: 'secondPlayer'
                    Widget:
                        id: 'padding2'
                    BoxLayout:
                        hints: {h:null}
                        id: 'secondPlayerInventory'
                    Label:
                        text:\`Maria \${Maria.status}\`
                        wrap: true;
                        hints: {h:'1'}
                        sizeGroup: 'actionItems'
                        align: 'right'
                    SpriteWidget:
                        spriteSheet: resources['sprites']
                        frames: [450]
                        hints: {w:'3', h:'3'}
                ScrollView:
                    id: 'scroller'
                    uiZoom: false
                    hints: {h:'20'}
                    MissionMap:
                        id: 'MissionMap'
                        hints: {w:null, h:null}
                        spriteSheet: resources['sprites']
        BoxLayout:
            hints: {h:1, w:1}
            h:20
            w:20
            orientation:'vertical'
            bgColor: 'rgb(25,25,35)'
            id: 'help'
            paddingX: '1'
            paddingY: '1'
            helpVal: 0
            on_helpVal:
                this.parent._needsLayout=true;
                const helpHeader = window.app.findById('helpHeader');
                helpHeader.text = [
                    'Controls',
                    'Instructions',
                    'Backstory',
                    'Agent Randy',
                    'Agent Maria',
                    'Director Stevens',
                    'Conrad Couli',
                    'Flint Ironsights',
                    'Mitch Crawford',
                    'Roland Kennedy',
                    'Irvina Schlitz',                            
                ][this.helpVal];
                const helpText = window.app.findById('helpText');
                helpText.text = [
                    'Use W/A/S/D to move, space to pause, 1-4 to use items.',
                    'Navigate the level to complete the mission objectives.',
                    'Intro: In the 22nd century, mankind has moved to the stars and conquered space. However, the realm of time is still one that has eluded them. Until now. Deep in the Unified Space Government’s most classified labs, the beginnings of time looping technology are being created.'+ 
                    '\\n\\nHowever, such a powerful technology always attracts those who want to use it for evil. Thanks to an inside mole, a group of reckless idealists have managed to get their hands on this technology. This group wants to wield the tech on a global sale by selling it to the highest bidder in violation of arms control laws. They hope that this will be the final step needed to bring about the “final revolution” that will ultimately achieve a stable universal government and a world where history can finally, truly be rewritten.'+
                    '\\n\\nGiven the severity of the situation, the Unified Space Government has given two of their top agents a secret, limited, and local version of the time loop tech to provide an edge on missions so that they can stop the syndicate before it’s too late.',
                    'Player Character 1. A tanky close-combat specialist. He began his work as a soldier fighting on the frontlines of various conflicts. His combat skills, even during severe ammo shortages, were noticed by those around him and he rose through the ranks. His special training included close-quarters combat training and cybernetic augments that make him more resilient to damage.',
                    'Player Character 2. A stealthy ranged specialist. A former agent in the United Space Government’s Intelligence division, she specialized in monitoring and, on occasion, eliminating targets with a minimum of fuss. She trained in the use of firearms and being able to move quickly yet silently.',
                    'The no-nonsense director of the player characters’ unit, who provides important details before each mission.',
                    'The head of one of the galaxy’s leading space travel companies, along with several companies that have gone bankrupt thanks to his leadership. His wealthy eccentricity, combined with an unhealthy interest in government-based conspiracy theories, has led him to offer financial assistance to the criminal conspiracy.',
                    'One of the galaxy’s most notorious dealers in military-grade and black market weapons. Often sells weapons to both sides in wars and may have helped stared a few.',
                    'A defector from the galaxy’s main government. Formerly a high-ranking agent, they’re believed to be the main suspect in leaking the time loop technology.',
                    'A moderate-ranking politician on a highly urbanized planet. He reached his current position by appealing to jingoists and is rumored to be linked to a few notorious hate groups. ',
                    'A scientist with an incredible curiosity… and a severe lack of empathy and restraint. They have avoided the authorities as they performed immoral experiments in highly regulated fields. Getting to field test a technology as powerful as time looping would be the height of her career.',
                ][this.helpVal];
                const helpSprite = window.app.findById('helpSprite');
                helpSprite.frames = [
                    [0], [0], [0], [355], [451], [0], [832], [833],[0],[834],[835]
                ][this.helpVal];
            Label:
                id: 'helpHeader'
                hints: {h:'2'}
            SpriteWidget:
                id: 'helpSprite'
                spriteSheet: resources['sprites']
                hints: {w:'3', h:'3'}
            Label:
                id: 'helpText'
                fontSize: '0.5'
                wrap: true
                vAlign: 'top'
                hints: {h:null}
            BoxLayout:
                hints: {h:'1', w:'8'}
                orientation: 'horizontal'
                Button:
                    text: 'Next'
                    bgColor: 'rgb(15,15,25)'
                    on_press:
                        const help = window.app.findById('help');
                        help.helpVal = (help.helpVal+1)%9;
                Button:
                    text: 'Exit'
                    bgColor: 'rgb(15,15,25)'
                    on_press:
                        const nb = window.app.findById('notebook');
                        nb.activePage = 0;
                
`;class ue extends V{_counter=0;_frames=0;_worst=300;_tref=Date.now();_badFrameCount=0;update(t,i){super.update(t,i);const e=Date.now();this._counter+=e-this._tref,this._frames+=1;const s=1e3/(e-this._tref);this._tref=e,this._badFrameCount+=s<50?1:0,s<this._worst&&(this._worst=s),this._counter>=1e3&&(this.text=`FPS: ${Math.round(this._frames/this._counter*1e3)} (worst: ${Math.round(this._worst)}, # >20ms: ${Math.round(this._badFrameCount)})`,this._counter=0,this._frames=0,this._worst=300,this._badFrameCount=0)}}class F extends p{activePlayerAction=null;activePlayerActionData=null;constructor(t={}){super(),F.resources.sprites=new $t(ae,16),this.continuousFrameUpdates=!0,window.focus(),this.canvas?.focus(),t&&this.updateProperties(t)}static get(){return p.get()}on_key_down(t,i,e){const s=this.inputHandler;if(s===void 0)return;const r=this.findById("MissionMap"),n=this.findById("randy"),l=this.findById("messageLabel");if(this.activePlayerAction){const a=this.activePlayerAction,o=this.activePlayerActionData,u=r.positionSelector;if(o?.validTargetCharacters)if(s.isKeyDown("w"))u.moveActiveCell(P[H.north]);else if(s.isKeyDown("a"))u.moveActiveCell(P[H.west]);else if(s.isKeyDown("s"))u.moveActiveCell(P[H.south]);else if(s.isKeyDown("d"))u.moveActiveCell(P[H.east]);else if(s.isKeyDown("e")){o.targetCharacter=u.validCharacters[u.activeCell];const d=n.takeAction(a,r,o);d.result==="complete"&&(u.validCells=[],l.text=d.message??"unknown action response",this.activePlayerAction=null,this.activePlayerActionData=null)}else s.isKeyDown("Escape")&&(u.validCells=[],l.text="canceled",this.activePlayerAction=null,this.activePlayerActionData=null)}else{const a=n.getActionForKey(e.event.key);if(a){const o=n.takeAction(a,r);if(o.result==="complete"||o.result==="notAvailable"||o.result==="invalid")this.activePlayerAction=null,this.activePlayerActionData=null,l.text=o.message??"unknown action response";else if(o.result==="infoNeeded"){this.activePlayerAction=a,this.activePlayerActionData=o;const u=r.positionSelector;l.text=o.message??"unknown action response",o.validTargetCharacters&&(u.validCharacters=o.validTargetCharacters),o.validTargetPositions&&(u.validCells=o.validTargetPositions)}}else if(s.isKeyDown("w"))n.move(H.north,r);else if(s.isKeyDown("a"))n.move(H.west,r);else if(s.isKeyDown("s"))n.move(H.south,r);else if(s.isKeyDown("d"))n.move(H.east,r);else if(s.isKeyDown(" "))n.rest(r);else if(s.isKeyDown("v")){const o=F.get().findById("scroller");o instanceof J&&o.zoom&&(o.zoom=.5);for(let u of r.metaTileMap.layer[T.seen].iterAll())r.metaTileMap.setInLayer(T.seen,u,1),r.tileMap.clearCache()}else return}if(r.updateCharacterVisibility(),n.actionsThisTurn===0){for(let a of r.enemies)a.takeTurn(r);n.actionsThisTurn=2,r.updateCharacterVisibility(!0)}}}F.registerClass("Action",ht,"Label");F.registerClass("FPS",ue,"Label");F.registerClass("Game",F,"App");F.registerClass("MissionMap",he,"Widget");Wt(oe);const _t=F.get(),de=_t.findById("MissionMap");de.setupLevel();_t.start();
