(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&e(n)}).observe(document,{childList:!0,subtree:!0});function i(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function e(s){if(s.ep)return;s.ep=!0;const r=i(s);fetch(s.href,r)}})();class vt{_seed=0;random(){return Math.random()}seed(t){}getRandomInt(t,i=0){return i!=0?t+Math.floor(this.random()*(i-t)):Math.floor(this.random()*t)}getRandomPos(t,i){return[this.getRandomInt(t),this.getRandomInt(i)]}randomRange(t,i){return Math.floor(this.random()*(i-t+1))+t}randomFloat(t=0,i=1){return this.random()*(i-t)+t}shuffle(t){let i,e;for(let s=1;s<t.length;s++)e=this.randomRange(0,s),i=t[s],t[s]=t[e],t[e]=i;return t}choose(t){return t[Math.floor(this.random()*t.length)]}chooseN(t,i){let e=new Array(i),s=t.length,r=new Array(s);if(i>s)throw new RangeError("chooeN: more elements requested than available");for(;i--;){let n=Math.floor(this.random()*s);e[i]=t[n in r?r[n]:n],r[n]=--s in r?r[s]:s}return e}}function at(o,t,i,e){return function(){o>>>=0,t>>>=0,i>>>=0,e>>>=0;var s=o+t|0;return o=t^t>>>9,t=i+(i<<3)|0,i=i<<21|i>>>11,e=e+1|0,s=s+e|0,i=i+s|0,(s>>>0)/4294967296}}class mt extends vt{_seed=1;d=3735928559;xorSeed=Math.floor(Date.now())^this.d;random=at(2654435769,608135816,3084996962,this.xorSeed);seed(t){this._seed=t,this.xorSeed=t^this.d,this.random=at(2654435769,608135816,3084996962,this.xorSeed)}}var gt=new mt;function St(o,t){return gt.getRandomPos(o,t)}function Mt(o=0,t=1){return gt.randomFloat(o,t)}function R(o,t){return new g([o,t])}function W(o){return new g(o)}class g extends Array{constructor(t=[0,0]){super(),this[0]=t[0],this[1]=t[1]}equals(t){return this.length===t.length&&this[0]===t[0]&&this[1]===t[1]}static random(t){return new g(St(t[0],t[1]))}add(t){return new g([this[0]+t[0],this[1]+t[1]])}sub(t){return new g([this[0]-t[0],this[1]-t[1]])}scale(t){return new g([this[0]*t,this[1]*t])}mul(t){return new g([this[0]*t[0],this[1]*t[1]])}div(t){return new g([this[0]/t[0],this[1]/t[1]])}dot(t){return this[0]*t[0]+this[1]*t[1]}dist(t){return Math.hypot(this[0]-t[0],this[1]-t[1])}abs(){return new g([Math.abs(this[0]),Math.abs(this[1])])}sum(){return this[0]+this[1]}relativeTo(t){return this.sub(t.pos).div(t.size)}absoluteFrom(t){return this.mul(t.size).add(t.pos)}relativeToPS(t,i){return this.sub(t).scale(1/i)}absoluteFromPS(t,i){return this.scale(i).add(t)}set x(t){this[0]=t}set y(t){this[1]=t}get x(){return this[0]}get y(){return this[1]}}class S extends Array{constructor(t=null){if(super(),t===null){this[0]=0,this[1]=0,this[2]=0,this[3]=0;return}this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3]}set x(t){this[0]=t}set y(t){this[1]=t}set w(t){this[2]=t}set h(t){this[3]=t}set pos(t){this[0]=t[0],this[1]=t[1]}set size(t){this[2]=t[2],this[3]=t[3]}get size(){return new g([this[2],this[3]])}get pos(){return new g([this[0],this[1]])}get x(){return this[0]}get y(){return this[1]}get w(){return this[2]}get h(){return this[3]}get right(){return this[0]+this[2]}get bottom(){return this[1]+this[3]}get center_x(){return this[0]+this[2]/2}get center_y(){return this[1]+this[3]/2}get center(){return new g([this.center_x,this.center_y])}grow(t){return new S([this[0]-t,this[1]-t,this[2]+2*t,this[3]+2*t])}get flooredCenter(){return new g([Math.floor(this[0]+this[2]/2),Math.floor(this[1]+this[3]/2)])}translate(t){return new S([this.x+t[0],this.y+t[1],this.w,this.h])}shrinkBorders(t){return new S([this.x+t,this.y+t,this.w-t*2,this.h-t*2])}scaleBorders(t){return new S([this.x+this.w*(1-t)/2,this.y+this.h*(1-t)/2,this.w*t,this.h*t])}mult(t){return new S([this[0]*t,this[1]*t,this[2]*t,this[3]*t])}multXY(t){return new S([this[0]*t[0],this[1]*t[1],this[2]*t[0],this[3]*t[1]])}scale(t,i=!0){if(i){let e=[this[2]*t,this[3]*t];return new S([this[0]+.5*(this[2]-e[0]),this[1]+.5*(this[3]-e[1]),e[0],e[1]])}else{let e=[this[2]*t,this[3]*t];return new S([this[0],this[1],e[0],e[1]])}}collideRadius(t,i=null){let e=[this.center_x-t.center_x,this.center_y-t.center_y];return i===null&&(i=Math.min(this.w,this.h,t.w,t.h)/2),e[0]*e[0]+e[1]*e[1]<i*i}collide(t){return this.x<t.x+t.w&&this.x+this.w>t.x&&this.y<t.y+t.h&&this.h+this.y>t.y}contains(t){return this.x<=t.x&&this.y<=t.y&&this.x+this.w>=t.x+t.w&&this.y+this.h>=t.y+t.h}contact(t){return this.x<=t.x+t.w&&this.x+this.w>=t.x&&this.y<=t.y+t.h&&this.h+this.y>=t.y}contactRadius(t,i=null){let e=[this.center_x-t.center_x,this.center_y-t.center_y];return i===null&&(i=Math.min(this.w,this.h,t.w,t.h)),e[0]*e[0]+e[1]*e[1]<=i*i}}class O extends Array{constructor(t=[0,0]){super(t[0]*t[1]),this.tileDim=new g(t),this.hidden=!1,this._cacheData=null}get(t){return this[t[0]+t[1]*this.tileDim[0]]}set(t,i){this[t[0]+t[1]*this.tileDim[0]]=i}*iterBetween(t,i,e=0){var s,r,n,l;if([s,r]=t,[n,l]=i,!(Math.abs(l-r)==0&&Math.abs(n-s)==0))if(Math.abs(l-r)>Math.abs(n-s)){var h=(n-s)/(l-r);if(r>l)for(var a=r;a>=l;a--){var u=s+(a-r)*h;yield[u,a]}else for(var a=r;a<=l;a++){var u=s+(a-r)*h;yield[u,a]}}else{var h=(l-r)/(n-s);if(s>n)for(var d=s;d>=n;d--){var f=r+(d-s)*h;yield[d,f]}else for(var d=s;d<=n;d++){var f=r+(d-s)*h;yield[d,f]}}}*iterInBetween(t,i){var e,s,r,n;if([e,s]=t,[r,n]=i,!(Math.abs(n-s)==0&&Math.abs(r-e)==0))if(Math.abs(n-s)>Math.abs(r-e)){var l=(r-e)/(n-s);if(s>n)for(var h=s-1;h>n;h--){var a=Math.round(e+(h-s)*l);yield[a,h]}else for(var h=s+1;h<n;h++){var a=Math.round(e+(h-s)*l);yield[a,h]}}else{var l=(n-s)/(r-e);if(e>r)for(var a=e-1;a>r;a--){var h=Math.round(s+(a-e)*l);yield[a,h]}else for(var a=e+1;a<r;a++){var h=Math.round(s+(a-e)*l);yield[a,h]}}}*iterTypesBetween(t,i,e){for(var s of this.iterBetween(t,i))e.includes(this.get(s))&&(yield s)}*iterTypesInBetween(t,i,e){for(var s of this.iterInBetween(t,i))e.includes(this.get(s))&&(yield s)}hasTypesBetween(t,i,e){for(var s of this.iterTypesBetween(t,i,e))return!0;return!1}hasTypesInBetween(t,i,e){for(var s of this.iterTypesInBetween(t,i,e))return!0;return!1}*iterAll(t=null){const[i,e]=this.tileDim;if(t!==null)for(var s=t[1];s<Math.min(e,t[1]+t[3]);s++)for(var r=t[0];r<Math.min(i,t[0]+t[2]);r++)yield[r,s];else for(var s=0;s<e;s++)for(var r=0;r<i;r++)yield[r,s]}*iterTypes(t,i){for(var e of this.iterAll(i))t.includes(this.get(e))&&(yield e)}*iterAdjacent(t){for(let i of[[0,-1],[1,0],[0,1],[-1,0]]){const e=t.add(i);e[0]>=0&&e[0]<this.tileDim[0]&&e[1]>=0&&e[1]<this.tileDim[1]&&(yield e)}}*iterInRange(t,i){var e,s;[e,s]=t;const[r,n]=this.tileDim;i==null&&(i=3);for(var l=Math.ceil(i),h=-l;h<l+1;h++)for(var a=-l;a<l+1;a++)if(a*a+h*h<=i*i){var u=e+a,d=s+h;0<=d&&d<n&&0<=u&&u<r&&(yield[u,d])}}*iterTypesInRange(t,i,e,s=null){for(var r of this.iterInRange(t,e))s!==null&&this.hasTypesBetween(t,r,s)||i.includes(this.get(r))&&(yield r)}numInRange(t,i,e,s=null){var r=0;for(var n of this.iterTypesInRange(t,i,e,s))r++;return r}*iterRectBoundary(t){const[i,e]=this.tileDim;let s=Math.min(Math.max(t.x,0),i),r=Math.min(Math.max(t.x+t.w,0),i),n=Math.min(Math.max(t.y,0),e),l=Math.min(Math.max(t.y+t.h,0),e);for(let h=s;h<r;h++)yield[h,n];for(let h=s;h<r;h++)yield[h,l];for(let h=n;h<l;h++)yield[s,h];for(let h=n;h<l;h++)yield[r,h]}*iterRect(t,i=!0){const[e,s]=this.tileDim;if(t instanceof S||(t=new S(t)),i&&(t.x<0||t.y<0||t.right>e||t.bottom>s))return;let r=Math.max(t.x,0),n=Math.min(t.x+t.w,e),l=Math.max(t.y,0),h=Math.min(t.y+t.h,s);for(let a=l;a<h;a++)for(let u=r;u<n;u++)yield[u,a]}numInRect(t,i,e=!0){let s=0;for(var r of this.iterRect(t,e))i.includes(this.get(r))&&s++;return s}}const P=8,E=48*(1/window.devicePixelRatio||1);function J(o,t,i,e,s,r,n){let l=1;i<P&&(l=1/E,o.save(),o.scale(l,l)),o.fillStyle=n,o.font=(i>=P?i:Math.ceil(i/l))+"px "+e,r.x;let h=l*o.measureText(t).width;return i<P&&o.restore(),[h,2*i]}function ut(o,t,i,e,s,r,n,l){let h=1;i<P&&(h=1/E,o.save(),o.scale(h,h)),o.fillStyle=l,o.font=(i>=P?i:Math.ceil(i/h))+"px "+e;let a=n.x,u=o.measureText(t),d=n.y;switch(s){case"left":break;case"center":a+=(n.w-h*u.width)/2;break;case"right":a+=n.w-h*u.width;break}switch(r){case"top":break;case"middle":d+=n.h/2;break;case"bottom":d+=n.h;break}let c={outText:[[t,a/h,d/h]],color:l,fontName:e,size:i,valign:r};return i<P&&o.restore(),c}function xt(o,t,i=null){let e=1,s=t.size;switch(i==null&&(i=t.color),s<P&&(e=1/E,o.save(),o.scale(e,e)),t.valign){case"top":o.textBaseline="top";break;case"middle":o.textBaseline="middle";break;case"bottom":o.textBaseline="bottom";break}o.fillStyle=i,o.font=(s>=P?s:Math.ceil(s/e))+"px "+t.fontName;let[r,n,l]=t.outText[0];o.fillText(r,n,l),s<P&&o.restore()}function Q(o,t,i,e,s,r,n,l=!0){let h=1;i<P&&(h=1/E,o.save(),o.scale(h,h)),o.font=(i>=P?i:Math.ceil(i/h))+"px "+e;let a=0,u="",d=Math.min(Math.max(1,Math.ceil(t.length*r.w/o.measureText(t).width/h)),t.length);for(;t!=""||u!="";){if(u==""){let m=t.indexOf(`
`);m>=0?(u=t.slice(0,m),t=t.slice(m+1)):(u=t,t="")}let f=u.slice(0,d),c=h*o.measureText(f).width;if(c>r.w&&d>1)for(;c>r.w&&d>1;)d--,f=u.slice(0,d),c=h*o.measureText(f).width;if(c<r.w&&d<u.length){for(;c<r.w&&d<u.length;)d++,f=u.slice(0,d),c=h*o.measureText(f).width;d--}if(l&&f[-1]!=""&&u[d]!=" "&&u[d]!="	"){let m=Math.max(f.lastIndexOf(" "),f.lastIndexOf("	"));m>=0&&(d-=f.length-m-1)}d=Math.max(1,d),f=u.slice(0,d),u=u.slice(d),l&&(u=u.trimStart()),a+=i}return a+=i,i<P&&o.restore(),[r.w,a]}function dt(o,t,i,e,s,r,n,l,h=!0){let a=1;i<P&&(a=1/E,o.save(),o.scale(a,a)),o.fillStyle=l,o.font=(i>=P?i:Math.ceil(i/a))+"px "+e;let u=n.y,d=[],f="",c=Math.min(Math.max(1,Math.ceil(t.length*(n.w/o.measureText(t).width)/a)),t.length);for(;t!=""||f!="";){if(f==""){let x=t.indexOf(`
`);x>=0?(f=t.slice(0,x),t=t.slice(x+1)):(f=t,t="")}let _=n.x,y=f.slice(0,c),M=a*o.measureText(y).width;if(M>n.w&&c>1)for(;M>n.w&&c>1;)c--,y=f.slice(0,c),M=a*o.measureText(y).width;if(M<n.w&&c<f.length){for(;M<n.w&&c<f.length;)c++,y=f.slice(0,c),M=a*o.measureText(y).width;c--}if(h&&c<f.length&&y[-1]!=""&&f[c]!=" "&&f[c]!="	"){let x=Math.max(y.lastIndexOf(" "),y.lastIndexOf("	"));x>=0&&(c-=y.length-x-1)}switch(c=Math.max(1,c),y=f.slice(0,c),f=f.slice(c),h&&(f=f.trimStart()),M=a*o.measureText(y).width,s){case"left":break;case"center":_+=(n.w-M)/2;break;case"right":_+=n.w-M;break}d.push([y,_/a,u/a]),u+=i}let m=u-n.y,b=0;switch(r){case"top":b=0;break;case"middle":b=(n.h-m)/2+i/2;break;case"bottom":b=n.h-m+i}let T={size:i,fontName:e,outText:d,off:b/a,color:l,valign:r};return i<P&&o.restore(),T}function Ct(o,t,i=null){let e=1,s=t.size;switch(i===null&&(i=t.color),s<P&&(e=1/E,o.save(),o.scale(e,e)),t.valign){case"top":o.textBaseline="top";break;case"middle":o.textBaseline="middle";break;case"bottom":o.textBaseline="bottom";break}o.fillStyle=i,o.font=(s>=P?s:Math.ceil(s/e))+"px "+t.fontName;for(let r of t.outText)o.fillText(r[0],r[1],r[2]+(t.off??0));s<P&&o.restore()}const $=(o,t,i)=>Math.min(Math.max(o,t),i);function Tt(o,t){return new g(o).dist(t)}function C(o){let t,i,e;return[t,i,e]=new X(o).scale(255).map(s=>Math.floor(s)),"#"+t.toString(16).padStart(2,"0")+i.toString(16).padStart(2,"0")+e.toString(16).padStart(2,"0")}class X extends Array{constructor(...t){t.length==1&&t[0]instanceof Array?super(...t[0]):super(...t)}static asRandomFloats(t,i=0,e=1){let s=new X(t);for(let r=0;r<s.length;r++)s[r]=Mt(i,e);return s}sum(){let t=0;return this.forEach(i=>t+=i),t}mean(){return this.sum()/this.length}max(){return Math.max.apply(null,this)}min(){return Math.min.apply(null,this)}vars(){let t=0;return this.forEach(i=>t+=i*i),(t-this.length*this.mean()^2)/(this.length-1)}var(){let t=0;return this.forEach(i=>t+=i*i),t/this.length-this.mean()^2}std(){return Math.sqrt(this.var())}add(t){let i=new X(this);if(t instanceof Array)for(let e=0;e<this.length;e++)i[e]+=t[e];else for(let e=0;e<this.length;e++)i[e]+=t;return i}mul(t){let i=new X(this);if(t instanceof Array)for(let e=0;e<this.length;e++)i[e]*=t[e];else for(let e=0;e<this.length;e++)i[e]*=t;return i}scale(t){const i=Array();for(let e of this)i.push(e*t);return i}dot(t){return this.mul(t).sum()}abs(){return Math.abs.apply(null,this)}lag(t){let i=new X;for(let e=-t;e<this.length-t;e++)e<0||e>=this.length?i.push(NaN):i.push(this[e]);return i}filter(t){return new X(super.filter(t))}dropNaN(){return this.filter(t=>!Number.isNaN(t))}}class A{identifier=-1;pos=[0,0];state="touch_up";device="touch";nativeObject=null;nativeEvent=null;constructor(t={}){for(let i in t)this[i]=t[i]}copy(){return new A({pos:[...this.pos],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}asChildTouch(t){return new A({pos:[...t.toChild(this.pos)],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}get rect(){return new S([...this.pos,0,0])}set x(t){this.pos[0]=t}set y(t){this.pos[1]=t}get x(){return this.pos[0]}get y(){return this.pos[1]}get grabbed(){return p.get().inputHandler.grabbed}grab(t){p.get().inputHandler.grab(t)}ungrab(){p.get().inputHandler.ungrab()}}class Dt{grabbed=null;mouseTouchEmulation=!0;mouseev=null;keyStates={};constructor(t){this.app=t,this.canvas=t.canvas;let i=this.canvas,e=this;document.addEventListener("keydown",function(s){e.process_key(s,"key_down")},!0),document.addEventListener("keyup",function(s){e.process_key(s,"key_up")},!0),i.addEventListener("mousedown",function(s){e.process_mouse(s,"mouse_down")},!0),i.addEventListener("mousemove",function(s){e.process_mouse(s,"mouse_move")},!0),i.addEventListener("mouseout",function(s){e.process_mouse(s,"mouse_cancel")},!0),i.addEventListener("mouseup",function(s){e.process_mouse(s,"mouse_up")},!0),i.addEventListener("touchstart",function(s){e.process_touch(s,"touch_down")},!1),i.addEventListener("touchmove",function(s){e.process_touch(s,"touch_move")},!1),i.addEventListener("touchcancel",function(s){e.process_touch(s,"touch_cancel")},!1),i.addEventListener("touchend",function(s){e.process_touch(s,"touch_up")},!1),i.addEventListener("wheel",function(s){e.process_wheel(s,"wheel")},!0),window.history.replaceState(null,document.title,location.pathname+"#!/backbutton"),window.history.pushState(null,document.title,location.pathname),window.addEventListener("popstate",function(s){e.process_back(s,"back_button")},!1)}grab(t){this.grabbed=t}ungrab(){this.grabbed=null}isKeyUp(t){return t in this.keyStates&&this.keyStates[t]}isKeyDown(t){return t in this.keyStates&&this.keyStates[t]}process_key(t,i){this.app.requestFrameUpdate();const e=this.keyStates[t.key];i==="key_up"?this.keyStates[t.key]=!1:i==="key_down"&&(this.keyStates[t.key]=!0),this.app.emit(i,{states:this.keyStates,oldState:e,event:t})}process_touch(t,i){if(this.app.requestFrameUpdate(),this.grabbed!==null)for(let e of t.changedTouches){let s=this.grabbed.appToChild([e.clientX,e.clientY]),r=new A({pos:s,state:i,nativeObject:e,nativeEvent:t,identifier:e.identifier});this.grabbed.emit(i,r)}else for(let e of t.changedTouches){let s=new A({pos:this.app.toChild([e.clientX,e.clientY]),state:i,nativeObject:e,nativeEvent:t,identifier:e.identifier});this.app.childEmit(i,s,!0)}t.preventDefault()}process_back(t,i){location.hash==="#!/backbutton"&&(history.replaceState(null,document.title,location.pathname),this.app.childEmit("back_button",t))}process_mouse(t,i){if(this.app.requestFrameUpdate(),this.mouseev=t,t.preventDefault(),this.mouseTouchEmulation){let e={mouse_up:"touch_up",mouse_down:"touch_down",mouse_move:"touch_move",mouse_cancel:"touch_cancel"};if(t.buttons!==1&&i!=="mouse_up")return;if(this.grabbed!==null){let s=[t.clientX,t.clientY],r=this.grabbed.appToChild(s),n=new A({pos:r,state:e[i],nativeObject:t,identifier:-1});this.grabbed.emit(e[i],n)}else{let s=new A({pos:this.app.toChild([t.clientX,t.clientY]),state:e[i],nativeObject:t,identifier:-1});this.app.childEmit(e[i],s,!0)}}else this.grabbed!==null?this.grabbed.emit(i,t):this.app.childEmit(i,t,!0)}process_wheel(t,i){if(this.mouseev!=null){if(this.app.requestFrameUpdate(),this.grabbed!=null){let e=this.grabbed.appToChild([this.mouseev.clientX,this.mouseev.clientY]),s=new A({pos:e,state:i,nativeObject:t});return this.grabbed.emit(i,s)}else{let e=new A({pos:this.app.toChild([this.mouseev.clientX,this.mouseev.clientY]),state:i,nativeObject:t});this.app.childEmit(i,e,!0)}t.preventDefault()}}vibrate(t,i,e){window.navigator.vibrate(e)}}function Pt(o,t,i,e){if(typeof t=="string"||t instanceof String){if(o.startsWith("on_"))return new Function("resources","parent","root",`return function(event, object, value) {${t}}`).bind(i)(p.resources,i.parent,e);if(t.trim().startsWith("(")&&t.indexOf("=>")<t.indexOf(`
`)){const a=new Function("resources","parent","root",`return ${t}`).bind(i)(p.resources,i.parent,e);return a.markupMethod=!0,a}const s=new Set;let r=0;if(t[0]!=="'"&&t[0]!=='"')for(let a of t.matchAll(/(?!\.)\b([a-z]\w*)\.([a-z_]\w*)\b/ig)){const u=a[1];u!=="this"&&u!=="parent"&&u!=="root"&&s.add(u),r++}if(r===0)return new Function("resources",`return ${t};`)(p.resources);const n=[...s].join(", "),l=`return function (${n}) { return ${t} }`,h=new Function("resources","parent","root",l)(p.resources,i.parent,e).bind(i);return h.text=`(${n}) => ${t}`,h}return t}function kt(o,t,i){t in o?o[t].push(i):o[t]=[i]}function zt(o,t){const i=o.indexOf(t);if(i===-1)return[o,""];const e=o.substring(0,i),s=o.substring(i+1);return[e,s]}function Lt(o,t,i){const e=i;let s=o[t];for(i=0;s[i]===" "&&i<s.length;i++);if(i<=e)throw Error(`Syntax error: invalid declaration on ${t}
${o[t-1]}
Declared object is neither a known class nor a valid property declaration`);let r=s;for(t++;i>e&&t<o.length;){for(s=o[t],i=0;s[i]===" "&&i<s.length;i++);i>e&&(r+=`
`+s,t++)}return[r,t,i]}function q(o,t,i,e,s){const r=e;let n=o[i];for(e=0;n[e]===" "&&e<n.length;e++);if(e<=r)return[i,e];const l=e;for(;;){if(n.trim()===""||n.trim().startsWith("#"))i++;else if(n.includes(":"))if(n=n.trim(),n.endsWith(":")){const h=n.slice(0,n.length-1);if(h in p.classes){const a={cls:h};[i,e]=q(o,t,i+1,e,a),kt(s,"children",a)}else{let a;[a,i,e]=Lt(o,i+1,e),s[h]=a}}else{const[h,a]=zt(n,":").map(u=>u.trim());s[h]=a,i++}else throw Error(`Syntax error on line ${i+1}
${n}`);if(i>=o.length)return[i,e];for(n=o[i],e=0;n[e]===" "&&e<n.length;e++);if(e>l)throw Error(`Syntax error on line ${i+1}
${n}`);if(e<l)return[i,e]}}function rt(o,t,i){const e={},s=o.constructor.name,n={...p.rules.get(s),...t};for(let l in n){const h=n[l];if(l==="children"&&h instanceof Array){const a=[];for(let u of h)if(u instanceof Object&&"cls"in u){const[d,f]=p.classes[u.cls],c=new d;rt(c,u,i),a.push(c)}else throw Error(`Unknown child class ${u} on clsName ${s}`);o instanceof p?o.baseWidget.children=a:o.children=a}else if(l!=="cls")try{e[l]=Pt(l,h,o,i)}catch{throw Error(`Error evaluating property ${l} on widget ${typeof o} and rootWidget ${typeof i} with value ${typeof h}
 ${h}`)}}o.updateProperties(e,!1)}function It(o,t){return{[o]:class extends t{}}[o]}function Wt(o){const t=o.split(`
`),i=[];let e=0,s=0,r=0;for(;r<t.length;){let n=t[r];if(n.trim()===""||n.trim().startsWith("#")){r++;continue}for(s=0;s<n.length&&n[s]===" ";++s);if(s!==e)throw Error(`Indentation error -- level ${s} used when ${e} expected on line # ${r+1}.
`+n);if(n=n.trim(),n.endsWith(":")){const l=n.replace(":","");if(n.startsWith("<")&&n.includes("@")){const[h,a]=l.slice(1,-1).split("@"),u=It(h,p.classes[a][0]),d={};[r,s]=q(t,h,r+1,s,d),p.classes[h]=[u,a],p.rules.add(h,d)}else if(n.startsWith("<")){const h=l.slice(1,-1).split(",").map(a=>a.trim());for(let a of h){const[u,d]=p.classes[a],f=p.rules.get(a);[r,s]=q(t,u,r+1,s,f),p.rules.add(a,f)}}else{const h=new p.classes[l][0],a={};[r,s]=q(t,l,r+1,s,a),rt(h,a,h),i.push(h)}}else throw Error(`Syntax error: Invalid declation on ${r}
${n}`)}return i}class Bt{constructor(t,i=0,e=null){this.elapsed=0,this.timer=t,this.triggered=!1,this.callback=e,i>0&&this.tick(i)}finished(){return this.elapsed>=this.timer}tick(t){return this.elapsed>=this.timer?(this.triggered&&(this.triggered=!1),!1):(this.elapsed+=t,this.elapsed>=this.timer?(this.callback!=null&&this.callback("timer",this),this.triggered=!0,!0):!1)}reset(t=-1,i=0){this.triggered=!1,t>=0&&(this.timer=t),i>0&&this.tick(i)}}class Ht{update(t,i){}}class At{constructor(){this.rules=new Map}add(t,i,e=!0){let s=this.rules.get(t);if(s&&!e)for(let r in s)s[r]=i[r];else this.rules.set(t,i)}get(t){return this.rules.get(t)??{}}remove(t){return this.rules.delete(t)}}class Yt{constructor(t,i,e){this.listener=t,this.event=i,this.callback=e}}class jt{constructor(){this.connections=new Map}bind(t,i,e,s){let r=new Yt(t,e,s),n=this.connections.get(i);n?n.add(r):this.connections.set(i,new Set([r]))}emit(t,i,e){const s=this.connections.get(t);if(!s)return!1;for(let r of s)if(r.event===i&&r.callback(i,t,e))return!0;return!1}disconnect(t){this.connections.delete(t);for(let i of this.connections.keys()){const e=[],s=this.connections.get(i);if(s){for(let r of s)r.listener===t&&e.push(r);e.forEach(r=>s.delete(r))}}}}class ct{stack=[];widget=null;props={};elapsed=0;add(t,i=1e3){this.stack.push([t,i])}update(t,i){if(this.widget===null)return;let e=this.stack[0][0],s=this.stack[0][1];if(this.elapsed==0){this.initProps={};for(let l in e)this.initProps[l]=this.widget[l]}let r=this.elapsed+i-s;this.elapsed=r<0?this.elapsed+i:s;let n=s==0?1:this.elapsed/s;if(r<0)for(let l in this.initProps){let h=e[l];typeof h=="number"&&(this.widget[l]=(1-n)*this.initProps[l]+n*h)}else{for(let l in this.initProps){let h=e[l];typeof h=="number"&&(this.widget[l]=h)}if(this.stack=this.stack.slice(1),this.elapsed=r,this.stack.length==0)this.cancel();else{this.initProps={};for(let l in this.stack[0][0])this.initProps[l]=this.widget[l]}}}start(t){this.widget=t,t._animation=this}cancel(){this.widget!==null&&(this.widget._animation=null)}}class z extends S{bgColor=null;outlineColor=null;_animation=null;_layoutNotify=!1;hints={};constructor(t=null){return super(),this.parent=null,this._processTouches=!1,this._deferredProps=null,this._children=[],this._needsLayout=!0,t!=null&&this.updateProperties(t),new Proxy(this,{set(i,e,s,r){return["x","y","w","h","children","rect"].includes[e]||e[0]=="_"?Reflect.set(i,e,s,r):(Reflect.set(i,e,s,r),typeof e=="string"&&Reflect.apply(i.emit,r,[e,s]),!0)}})}set rect(t){this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this._needsLayout=!0}get rect(){return new S([this[0],this[1],this[2],this[3]])}deferredProperties(t){let i=this._deferredProps;this._deferredProps=null;for(let e in i)if(!e.startsWith("on_")&&!e.startsWith("_")&&typeof i[e]=="function"){let s=i[e],r,n;[r,n]=(s.text??s.toString()).split("=>"),r=r.replace("(","").replace(")","").split(",").map(u=>u.trim());let l=r.map(u=>t.findById(u)),h={};for(let u of r)h[u]=t.findById(u);const a=/(\w+)\.(\w+)/g;for(let u of n.matchAll(a)){let d,f;if([f,d]=u.slice(1),console.log(f,d),f==="this")this.bind(d,(c,m,b)=>{try{this[e]=s(...l)}catch(T){console.log("Dynamic binding error",this,e,T)}});else if(f in h)try{h[f].bind(d,(c,m,b)=>{try{this[e]=s(...l)}catch(T){console.log("Dynamic binding error",this,e,T)}})}catch(c){console.log(`Warning: ${f} cannot be bound on`,this,`
property`,e,`
error`,c)}}try{this[e]=s(...l)}catch(u){console.log("Dynamic binding error",this,e,u)}}}updateProperties(t,i=!0){i&&rt(this,{},this);for(let e in t)!e.startsWith("on_")&&!e.startsWith("_")&&typeof t[e]=="function"&&!("markupMethod"in t[e])?this._deferredProps=t:this[e]=t[e]}bind(t,i,e=null){p.get()._eventManager.bind(e,this,t,i)}emit(t,i){return"on_"+t in this&&this["on_"+t](t,this,i)?!0:p.get()._eventManager.emit(this,t,i)}*iter(t=!0,i=!0){if(yield this,!!t)for(let e of this._children)yield*e.iter(...arguments)}*iterParents(){this.parent!==null&&(yield this.parent,this.parent!=p.get()&&(yield*this.parent.iterParents()))}findById(t){for(let i of this.iter(!0,!1))if("id"in i&&i.id==t)return i;return null}*iterByPropertyValue(t,i){for(let e of this.iter(!0,!1))t in e&&e[t]==i&&(yield e)}getTransformRecurse(t=!1,i=null){let e=this!==i&&this.parent!==null?this.parent.getTransformRecurse(!0,i):new DOMMatrix;if(!t)return e;let s=this.getTransform();return s?e.multiply(s):e}getTransform(){return null}applyTransform(t,i=!1,e=!1,s=!1,r=null){let n=e?this.getTransformRecurse(s,r):this.getTransform();if(!n)return t;i&&(n=n.inverse());let l=n.transformPoint(new DOMPoint(t.x,t.y));return new g([l.x,l.y])}appToWidget(t,i=!0){if(this.parent){let e=this.parent.getTransformRecurse().inverse().transformPoint(new DOMPoint(t[0],t[1]));return new g([e.x,e.y])}return t}appToChild(t,i=!0){let e=this.getTransformRecurse().inverse().transformPoint(new DOMPoint(t[0],t[1]));return new g([e.x,e.y])}toChild(t){let i=this.getTransform();if(!i)return t;let e=i.inverse().transformPoint(new DOMPoint(t[0],t[1]));return new g([e.x,e.y])}addChild(t,i=-1){i==-1?this._children.push(t):this._children=[...this._children.slice(0,i),t,...this._children.slice(i)],this.emit("child_added",t),t.parent=this,this._needsLayout=!0}removeChild(t,i=!0){this._children=this.children.filter(e=>e!=t),i&&p.get()._eventManager.disconnect(t),this.emit("child_removed",t),t.parent=null,this._needsLayout=!0}get children(){return this._children}set children(t){for(let i of this._children)this.emit("child_removed",i),i.parent=null,this._needsLayout=!0;this._children=[];for(let i of t)this.addChild(i)}set x(t){this._needsLayout=!0,this[0]=t}set center_x(t){this._needsLayout=!0,this[0]=t-this[2]/2}set right(t){this._needsLayout=!0,this[0]=t-this[2]}set y(t){this._needsLayout=!0,this[1]=t}set center_y(t){this._needsLayout=!0,this[1]=t-this[3]/2}set bottom(t){this._needsLayout=!0,this[1]=t-this[3]}set w(t){this._needsLayout=!0,this[2]=t}set h(t){this._needsLayout=!0,this[3]=t}get x(){return this[0]}get center_x(){return this[0]+this[2]/2}get right(){return this[0]+this[2]}get y(){return this[1]}get center_y(){return this[1]+this[3]/2}get bottom(){return this[1]+this[3]}get w(){return this[2]}get h(){return this[3]}on_wheel(t,i,e){for(let s=this._children.length-1;s>=0;s--)if(this._children[s].emit(t,e))return!0;return!1}on_touch_down(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];for(let l=this._children.length-1;l>=0;l--)if(this._children[l].emit(t,r))return!0}else for(let r=this._children.length-1;r>=0;r--)if(this._children[r].emit(t,e))return!0;return!1}on_touch_up(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];for(let l=this._children.length-1;l>=0;l--)if(this._children[l].emit(t,r))return!0}else for(let r=this._children.length-1;r>=0;r--)if(this._children[r].emit(t,e))return!0;return!1}on_touch_move(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];for(let l=this._children.length-1;l>=0;l--)if(this._children[l].emit(t,r))return!0}else for(let r=this._children.length-1;r>=0;r--)if(this._children[r].emit(t,e))return!0;return!1}on_touch_cancel(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];for(let l=this._children.length-1;l>=0;l--)if(this._children[l].emit(t,r))return!0}else for(let r=this._children.length-1;r>=0;r--)if(this._children[r].emit(t,e))return!0;return!1}on_back_button(t,i,e){return!1}getMetric(t,i,e,s=null,r=null){let n=p.get();if(e===null)return t[i];let l=0,h="relative";for(s=s??this.w,r=r??this.h;;){if(e.constructor==String){let a=e.slice(-2);if(a=="ww"){l=+e.slice(0,-2)*t.w;break}if(a=="wh"){l=+e.slice(0,-2)*t.h;break}if(a=="aw"){l=+e.slice(0,-2)*n.dimW,h="absolute";break}if(a=="ah"){l=+e.slice(0,-2)*n.dimH,h="absolute";break}let u=e.slice(-1);if(u=="w"){l=+e.slice(0,-1)*s;break}if(u=="h"){l=+e.slice(0,-1)*r;break}l=+e;break}if(i=="w"||i=="x"||i=="center_x"||i=="right"){l=+e;break}l=+e;break}return h=="relative"&&(["x","center_x","right"].includes(i)&&(l+=this.x),["y","center_y","bottom"].includes(i)&&(l+=this.y)),l}applyHintMetric(t,i,e,s=null,r=null){let n=p.get();if(e===null)return;let l=0,h="relative";for(s=s??this.w,r=r??this.h;;){if(e.constructor==String){let a=e.slice(-2);if(a=="ww"){l=+e.slice(0,-2)*t.w;break}if(a=="wh"){l=+e.slice(0,-2)*t.h;break}if(a=="aw"){l=+e.slice(0,-2)*n.dimW,h="absolute";break}if(a=="ah"){l=+e.slice(0,-2)*n.dimH,h="absolute";break}let u=e.slice(-1);if(u=="w"){l=+e.slice(0,-1)*s;break}if(u=="h"){l=+e.slice(0,-1)*r;break}l=+e;break}if(i=="w"||i=="x"||i=="center_x"||i=="right"){l=+e*s;break}l=+e*r;break}h=="relative"&&(["x","center_x","right"].includes(i)&&(l+=this.x),["y","center_y","bottom"].includes(i)&&(l+=this.y)),t[i]=l}applyHints(t,i=null,e=null){let s=t.hints;i=i??this.w,e=e??this.h,"w"in s&&s.w!=null&&s.w.constructor==String&&s.w.slice(-2)=="wh"?(s.h!==void 0&&this.applyHintMetric(t,"h",s.h,i,e),s.w!==void 0&&this.applyHintMetric(t,"w",s.w,i,e)):(s.w!==void 0&&this.applyHintMetric(t,"w",s.w,i,e),s.h!==void 0&&this.applyHintMetric(t,"h",s.h,i,e));for(let r in s)r!="w"&&r!="h"&&this.applyHintMetric(t,r,s[r],i,e)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;for(let t of this.children)this.applyHints(t),t.layoutChildren()}_draw(t,i,e){this.draw(t,i);let s=this.getTransform();if(s){i.save(),i.transform(s.a,s.b,s.c,s.d,s.e,s.f);for(let r of this._children)r._draw(t,i,e);i.restore();return}for(let r of this._children)r._draw(t,i,e)}draw(t,i){let e=this.rect;if(i.beginPath(),i.rect(e[0],e[1],e[2],e[3]),this.bgColor!=null&&(i.fillStyle=this.bgColor,i.fill()),this.outlineColor!=null){let s=i.lineWidth;i.lineWidth=1/t.tileSize,i.strokeStyle=this.outlineColor,i.stroke(),i.lineWidth=s}}update(t,i){this._deferredProps!=null&&this.deferredProperties(t),this._animation!=null&&(this._animation.update(t,i),t.requestFrameUpdate()),this._needsLayout&&(this.layoutChildren(),t.requestFrameUpdate());for(let e of this._children)e.update(t,i)}}class p extends z{static appInstance=null;static rules=new At;static resources=new Map;static classes={};static registerClass(t,i,e){p.classes[t]=[i,e]}constructor(t=null){if(p.appInstance!=null)return p.appInstance;super(),p.appInstance=this,window.app=this,this._eventManager=new jt,this.id="app",this.w=-1,this.h=-1,this._baseWidget=new z({hints:{x:0,y:0,w:1,h:1}}),this._baseWidget.parent=this,this._modalWidgets=[],this.pixelSize=1,this.integerTileSize=!1,this.exactDimensions=!1,this.prefDimW=32,this.prefDimH=16,this.dimW=this.prefDimW,this.dimH=this.prefDimH,this.tileSize=this.getTileScale()*this.pixelSize,this.canvasName="canvas",this.canvas=null,this.offsetX=0,this.offsetY=0,this.shakeX=0,this.shakeY=0,this.shakeAmount=0,this.timer_tick=null,this.timers=[],this.continuousFrameUpdates=!1,this._requestedFrameUpdate=!1,t&&this.updateProperties(t)}get baseWidget(){return this._baseWidget}addTimer(t,i){let e=new Bt(t,0,i);return this.timers.push(e),e}removeTimer(t){this.timers=this.timers.filter(i=>i!=t)}addModal(t){this._modalWidgets.push(t),this._needsLayout=!0}removeModal(t){this._modalWidgets=this._modalWidgets.filter(i=>i!=t)}static get(){return p.appInstance||(p.appInstance=new p),p.appInstance}start(){let t=this;this.setupCanvas(),this.inputHandler=new Dt(this),window.onresize=()=>t.updateWindowSize(),this.updateWindowSize(),window.onload=()=>this._start()}_start(){this.update()}childEmit(t,i,e=!1){if(e&&this._modalWidgets.length>0)return this._modalWidgets[this._modalWidgets.length-1].emit(t,i);if(this._baseWidget.emit(t,i))return!0;for(let s of this._modalWidgets)if(s.emit(t,i))return!0;return!1}*iter(t=!0,i=!0){yield this,yield*this._baseWidget.iter(...arguments);for(let e of this._modalWidgets)yield*e.iter(...arguments)}findById(t){for(let i of this.iter(!0,!1))if("id"in i&&i.id==t)return i;return null}*iterByPropertyValue(t,i){for(let e of this.iter(!0,!1))t in e&&e[t]===i&&(yield e)}update(){this._requestedFrameUpdate=!1;let t=15,i=Date.now();this.timer_tick!=null&&(t=Math.min(i-this.timer_tick,30)),(this.timers.length>0||this._needsLayout)&&this.requestFrameUpdate();for(let e of this.timers)e.tick(t);this._needsLayout&&this.layoutChildren();for(let e of p.resources.values())e.update(this,t);this._baseWidget.update(this,t);for(let e of this._modalWidgets)e.update(this,t);this.ctx&&this._draw(this,this.ctx,t),this.continuousFrameUpdates&&this.requestFrameUpdate(),this.timer_tick=i}requestFrameUpdate(){this._requestedFrameUpdate||(this._requestedFrameUpdate=!0,window.requestAnimationFrame(()=>this.update()))}_draw(t,i,e){if(!this.canvas)return;i.clearRect(0,0,this.canvas.width,this.canvas.height),this.shakeX=0,this.shakeY=0,this.screenShake(),i.save();let s=this.getTransform();s&&i.transform(s.a,s.b,s.c,s.d,s.e,s.f),this._baseWidget._draw(t,i,e);for(let r of this._modalWidgets)r._draw(t,i,e);i.restore()}getTransform(t=!0){return new DOMMatrix().translate(this.offsetX+this.shakeX,this.offsetY+this.shakeY).scale(this.tileSize,this.tileSize)}on_prefDimW(t,i,e){this.updateWindowSize()}on_prefDimH(t,i,e){this.updateWindowSize()}on_tileSize(t,i,e){this.prefDimH<0&&this.prefDimW<0&&this.updateWindowSize()}updateWindowSize(){this.x=0,this.y=0,this.w=window.innerWidth,this.h=window.innerHeight,this.prefDimH>=0&&this.prefDimW>=0&&(this.tileSize=this.getTileScale()),this.fitDimensionsToTileSize(this.tileSize),this.setupCanvas();try{screen.orientation.unlock()}catch{}this._needsLayout=!0,this.requestFrameUpdate()}getTileScale(){let t=this.h,i=this.w,e=1/this.pixelSize;return this.prefDimW<0&&this.prefDimH<0?this.tileSize>0&&(e=this.tileSize/this.pixelSize):this.prefDimW<0?e=t/this.prefDimH/this.pixelSize:this.prefDimH<0?e=i/this.prefDimW/this.pixelSize:e=Math.min(t/this.prefDimH/this.pixelSize,i/this.prefDimW/this.pixelSize),this.integerTileSize&&e>1&&(e=Math.floor(e)),e*this.pixelSize}fitDimensionsToTileSize(t){let i=this.h,e=this.w;if(this.exactDimensions){this.prefDimW<0&&this.prefDimH<0?(this.dimW=e/this.tileSize,this.dimH=i/this.tileSize):this.prefDimH<0?(this.dimW=this.prefDimW,this.dimH=i/this.tileSize):this.prefDimW<0?(this.dimW=e/this.tileSize,this.dimH=this.prefDimH):(this.dimH=this.prefDimH,this.dimW=this.prefDimW);return}this.dimH=Math.floor(i/t),this.dimW=Math.floor(e/t)}setupCanvas(){this.canvas=document.querySelector(this.canvasName),this.canvas&&(this.canvas.width=this.w,this.canvas.height=this.h,this.ctx=this.canvas.getContext("2d"),this.ctx&&(this.ctx.imageSmoothingEnabled=!1,this.offsetX=Math.floor((this.w-this.tileSize*this.dimW)/2),this.offsetY=Math.floor((this.h-this.tileSize*this.dimH)/2)))}applyHints(t){super.applyHints(t,this.dimW,this.dimH)}screenShake(){this.shakeAmount&&this.shakeAmount--;let t=Math.random()*Math.PI*2;this.shakeX=Math.round(Math.cos(t)*this.shakeAmount),this.shakeY=Math.round(Math.sin(t)*this.shakeAmount)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.applyHints(this._baseWidget),this._baseWidget.layoutChildren();for(let t of this._modalWidgets)this.applyHints(t),t.layoutChildren()}}class U extends z{fontSize=null;sizeGroup="";clip=!1;ignoreSizeForGroup=!1;fontName='"Nimbus Mono PS", "Courier New", monospace';text="";wrap=!1;wrapAtWord=!0;align="center";valign="middle";color="white";constructor(t=null){super(),this._textData=null,t!==null&&this.updateProperties(t)}on_align(t,i,e){this._needsLayout=!0}on_valign(t,i,e){this._needsLayout=!0}on_wrap(t,i,e){this._needsLayout=!0}on_wrapAtWord(t,i,e){this._needsLayout=!0}on_text(t,i,e){this._needsLayout=!0}on_fontSize(t,i,e){this._needsLayout=!0}on_fontName(t,i,e){this._needsLayout=!0}layoutChildren(){let i=p.get().ctx;if(!i)return;let e=this.fontSize===null?null:this.getMetric(this,"fontSize",this.fontSize);if("h"in this.hints&&this.hints.h==null&&e!==null&&(this[3]=this.wrap?Q(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[1]:J(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color)[1]),"w"in this.hints&&this.hints.w==null&&e!==null&&(this[2]=this.wrap?Q(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[0]:J(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color)[0]),e=e===null?this.h/2:e,this.fontSize===null&&this.rect.w!==void 0){let s=0,r,n;for(;s<50;){if(this.wrap?[r,n]=Q(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord):[r,n]=J(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color),(this.h>=n||"h"in this.hints&&this.hints.h==null||e<.01)&&(this.w>=r||"w"in this.hints&&this.hints.w==null)){"h"in this.hints&&this.hints.h==null&&(this.h=n),"w"in this.hints&&this.hints.w==null&&(this.w=r);break}const l=Math.min(1.1,this.w/r,this.h/n);this.wrap?e*=l**.5:e*=l**1.1,s++}e===void 0&&(e=.001*p.get().h)}this.sizeGroup!==""?(this._bestFontSize=e,this._textData=null):this.wrap?this._textData=dt(i,this.text,e,this.fontName,this.align,this.valign,this.rect,this.color,this.wrapAtWord):this._textData=ut(i,this.text,e,this.fontName,this.align,this.valign,this.rect,this.color),super.layoutChildren()}sizeToGroup(t){if(this._bestFontSize===void 0)return;let i=1/0;for(let e of p.get().iterByPropertyValue("sizeGroup",this.sizeGroup))i>e._bestFontSize&&!e.ignoreSizeForGroup&&(i=e._bestFontSize);if(i>0)for(let e of p.get().iterByPropertyValue("sizeGroup",this.sizeGroup)){const s=e.clip||!e.ignoreSizeForGroup?i:e._bestFontSize;e.wrap?e._textData=dt(t,e.text,s,e.fontName,e.align,e.valign,e.rect,e.color,e.wrapAtWord):e._textData=ut(t,e.text,s,e.fontName,e.align,e.valign,e.rect,e.color)}}draw(t,i){if(super.draw(t,i),this.clip){i.save();const e=this.rect;i.rect(e.x,e.y,e.w,e.h),i.clip()}!this._textData&&this.sizeGroup!==""&&this.sizeToGroup(i),this._textData&&(this.wrap?Ct(i,this._textData,this.color):xt(i,this._textData,this.color)),this.clip&&i.restore()}}class Rt extends U{bgColor=C([.5,.5,.5]);selectColor=C([.7,.7,.8]);disableColor1=C([.2,.2,.2]);disableColor2=C([.4,.4,.4]);disable=!1;constructor(t=null){super(),t!==null&&this.updateProperties(t)}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):!1}on_touch_up(t,i,e){return super.on_touch_up(t,i,e)?!0:e.grabbed!=this?!1:(e.ungrab(),!this.disable&&this.collide(e.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(t,i,e){return super.on_touch_move(t,i,e)?!0:(e.grabbed==this&&!this.disable&&(this._touching=this.collide(e.rect)),!1)}draw(t,i){let e=this.bgColor,s=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(t,i),this.bgColor=e,this.color=s}}class Ft extends z{color=C([.8,.8,.8]);bgColor=C([.5,.5,.5]);selectColor=C([.7,.7,.8]);disableColor1=C([.2,.2,.2]);disableColor2=C([.4,.4,.4]);disable=!1;constructor(t=null){super(),t!==null&&this.updateProperties(t)}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):!1}on_touch_up(t,i,e){return super.on_touch_up(t,i,e)?!0:e.grabbed!=this?!1:(e.ungrab(),!this.disable&&this.collide(e.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(t,i,e){return super.on_touch_move(t,i,e)?!0:(e.grabbed==this&&!this.disable&&(this._touching=this.collide(e.rect)),!1)}draw(t,i){let e=this.bgColor,s=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(t,i),this.bgColor=e,this.color=s}}class wt extends U{bgColor=C([.5,.5,.5]);pressColor=C([.7,.7,.7]);selectColor=C([.7,.7,.8]);disableColor1=C([.2,.2,.2]);disableColor2=C([.4,.4,.4]);disable=!1;_press=!1;group=null;singleSelect=!0;constructor(t=null){super(),t!==null&&this.updateProperties(t)}get press(){return this._press}set press(t){this._press=t}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,console.log("touch",this.text,this.parent,this),!0):!1}on_touch_up(t,i,e){if(e.grabbed!==this)return!1;if(e.ungrab(),this._touching=!1,console.log("release",this.text,this.parent,this),this.collide(e.rect)){if(this.group===null||!this.singleSelect)this.press=!this.press;else{if(this.parent!==null)for(let s of this.parent.iterByPropertyValue("group",this.group))s!==this&&(s._press=!1);this.press=!0}return!0}return!1}on_touch_move(t,i,e){return e.grabbed===this?(this._touching=this.collide(e.rect),!0):!1}draw(t,i){let e=this.bgColor,s=this.color;this.press&&(this.bgColor=this.pressColor),this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(t,i),this.bgColor=e,this.color=s}}class Xt extends z{selectColor=C([.7,.7,.8]);color=C([.6,.6,.6]);bgColor=C([.5,.5,.5]);disableColor1=C([.2,.2,.2]);disableColor2=C([.3,.3,.3]);disable=!1;check=!1;group=null;constructor(t=null){super(),t!==null&&this.updateProperties(t)}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):!1}on_touch_up(t,i,e){if(super.on_touch_up(t,i,e))return!0;if(this.parent===null||e.grabbed!=this)return!1;if(e.ungrab(),!this.disable&&this.collide(e.rect)){if(this._touching=!1,this.group==null)this.check=!this.check;else{for(let s of this.parent.iterByPropertyValue("group",this.group))s!=this&&(s.check=!1);this.check=!0}return!0}return!1}on_touch_move(t,i,e){return super.on_touch_move(t,i,e)?!0:e.grabbed==this&&!this.disable?(this._touching=this.collide(e.rect),!0):!1}draw(t,i){if(this.group!=null){let r=this.rect;r.w=r.h=.5*Math.min(r.w,r.h),r.x=this.x+(this.w-r.w)/2,r.y=this.y+(this.h-r.h)/2;let n=p.get().tileSize,l=p.get().ctx;if(!l)return;l.strokeStyle=this.disable?this.disableColor1:this.bgColor,l.lineWidth=1/n,l.beginPath(),l.arc(r.center_x,r.center_y,r.w/2,0,2*Math.PI),l.stroke(),(this._touching||this.disable)&&(l.fillStyle=this.disable?this.disableColor1:this.selectColor,l.fill()),this.check&&(l.fillStyle=this.disable?this.disableColor2:this.color,l.beginPath(),l.arc(r.center_x,r.center_y,r.w/3,0,2*Math.PI),l.fill());return}let e=this.rect;e.w=e.h=.5*Math.min(e.w,e.h),e.x=this.x+(this.w-e.w)/2,e.y=this.y+(this.h-e.h)/2;let s=t.tileSize;i.beginPath(),i.strokeStyle=this.bgColor,this.disable&&(i.strokeStyle=this.disableColor1),i.lineWidth=1/s,i.rect(e[0],e[1],e[2],e[3]),i.stroke(),this._touching&&(i.fillStyle=this.selectColor,i.fill()),this.check&&(i.strokeStyle=this.color,this.disable&&(i.strokeStyle=this.disableColor2),i.beginPath(),i.lineWidth=e.w/5,i.moveTo(e.x,e.y),i.lineTo(e.right,e.bottom),i.moveTo(e.right,e.y),i.lineTo(e.x,e.bottom),i.stroke())}}class Ot extends z{selectColor=C([.7,.7,.8]);color=C([.6,.6,.6]);bgColor=C([.4,.4,.4]);disableColor1=C([.2,.2,.2]);disableColor2=C([.3,.3,.3]);disable=!1;min=0;max=1;curMax=1;unboundedStopMultiple=10;exponentialSlider=!1;step=null;orientation="horizontal";value=0;sliderSize=.2;constructor(t=null){super(),t!==null&&this.updateProperties(t)}setValue(t){let i=this.max??this.curMax,e=0;this.orientation=="horizontal"&&(e=$((t.rect.x-this.x-this.w*this.sliderSize/2)/(this.w*(1-this.sliderSize)),0,1)),this.orientation=="vertical"&&(e=$((t.rect.y-this.y-this.h*this.sliderSize/2)/(this.h*(1-this.sliderSize)),0,1)),this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?e=e>.5?i/this.unboundedStopMultiple+(e-.5)/.5*(i-i/this.unboundedStopMultiple):this.min+e/.5*(i/this.unboundedStopMultiple-this.min):e=this.min+(i-this.min)*e,this.step!=null&&(e=Math.round(e/this.step)*this.step),this.value=e}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touch=!0,this.setValue(e),!0):!1}updateMax(){this.max===null&&(this.curMax=this.unboundedStopMultiple*this.value)}on_touch_up(t,i,e){return e.grabbed!=this?super.on_touch_up(t,i,e):(e.ungrab(),!this.disable&&this.collide(e.rect)&&(this._touching=!1,this.setValue(e)),this.updateMax(),!0)}on_touch_move(t,i,e){return e.grabbed!==this?super.on_touch_move(t,i,e):(this.disable||(this._touching=this.collide(e.rect),this.setValue(e)),!1)}draw(t,i){let e=t.tileSize,s=this.rect;if(this.orientation=="horizontal"){s.w-=this.sliderSize*this.w,s.x+=this.sliderSize/2*this.w;let r=Math.min(this.sliderSize/2*this.w,this.h/2)/2;i.strokeStyle=this.disable?this.disableColor1:this.bgColor,i.beginPath(),i.lineWidth=4/e,i.moveTo(s.x,s.center_y),i.lineTo(s.right,s.center_y),i.stroke();let n=this.max??this.curMax,l;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?l=this.value>n/this.unboundedStopMultiple?(.5+.5*(this.value-n/this.unboundedStopMultiple)/(n-n/this.unboundedStopMultiple))*s.w:.5*(this.value-this.min)/(n/this.unboundedStopMultiple-this.min)*s.w:l=(this.value-this.min)/(n-this.min)*s.w,i.strokeStyle=this.disable?this.disableColor2:this.bgColor,i.beginPath(),i.arc(s.x+l,s.center_y,r,0,2*Math.PI),i.stroke(),i.fillStyle=this.color,(this._touching||this.disable)&&(i.fillStyle=this.disable?this.disableColor1:this.selectColor),i.fill()}if(this.orientation=="vertical"){s.h-=this.sliderSize*this.h,s.y+=this.sliderSize/2*this.h;let r=Math.min(this.sliderSize/2*this.h,this.w/2)/2;i.strokeStyle=this.disable?this.disableColor1:this.bgColor,i.beginPath(),i.lineWidth=4/e,i.moveTo(s.center_x,s.y),i.lineTo(s.center_x,s.bottom),i.stroke();let n=this.max??this.curMax,l;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?l=this.value>n/this.unboundedStopMultiple?(.5+.5*(this.value-n/this.unboundedStopMultiple)/(n-n/this.unboundedStopMultiple))*s.h:.5*(this.value-this.min)/(n/this.unboundedStopMultiple-this.min)*s.h:l=(this.value-this.min)/(n-this.min)*s.h,i.strokeStyle=this.disable?this.disableColor2:this.bgColor,i.beginPath(),i.arc(s.center_x,s.y+l,r,0,2*Math.PI),i.stroke(),i.fillStyle=this.color,(this._touching||this.disable)&&(i.fillStyle=this.disable?this.disableColor1:this.selectColor),i.fill()}}}class Et extends U{_activeDOMInput=null;focus=!0;disable=!1;_inputSanitizer=void 0;constructor(t=null){super(),this._textData=null,t!==null&&this.updateProperties(t)}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):(this.clearDOM(),!1)}on_touch_up(t,i,e){return super.on_touch_up(t,i,e)?!0:e.grabbed!=this?!1:!this.disable&&this.collide(e.rect)?(this._touching=!1,this.addDOMInput(),!0):(this.clearDOM(),!1)}on_layout(t,i,e){this.clearDOM()}DOMInputRect(){let t=this.rect,i=this.getTransformRecurse(),e=new S,s=i.transformPoint(new DOMPoint(t.x,t.y)),r=i.transformPoint(new DOMPoint(t.right,t.bottom));return[e.x,e.y]=[s.x,s.y],[e.w,e.h]=[r.x,r.y],e.w-=e.x,e.h-=e.y,e}addDOMInput(){if(!this._textData)return;p.get();let t=document.getElementById("eskvapp");if(!t)return;let i=this.wrap?"textarea":"input",e=document.createElement(i);if(!(e instanceof HTMLInputElement)&&!(e instanceof HTMLTextAreaElement))return;let s,r=this.DOMInputRect(),n=this.color!=null?this.color:"white",l=this.bgColor!=null?this.bgColor:"black";e.style.color=n,s=this._textData.size/this.h*r.h/this._textData.outText.length,i=="textarea"&&this._textData.outText.length,e.value=this.text,s=(Math.floor(s*100)/100).toString()+"px",e.style.fontSize=s,e.style.backgroundColor=l,e.style.top=(Math.floor(r.y*100)/100).toString()+"px",e.style.left=(Math.floor(r.x*100)/100).toString()+"px",e.style.width=(Math.floor(r.w*100)/100).toString()+"px",e.style.height=(Math.floor(r.h*100)/100).toString()+"px",e.style.fontFamily=this.fontName,this._activeDOMInput=e,t.appendChild(e),e.addEventListener("focusout",h=>this.clearDOM()),e.focus(),e.select(),this.focus=!0}clearDOM(){if(this._activeDOMInput!=null){this.text=this._inputSanitizer?this._inputSanitizer(this._activeDOMInput.value,this):this._activeDOMInput.value;let t=this._activeDOMInput;this._activeDOMInput=null,t.remove(),this.focus=!1,this._needsLayout=!0;let i=p.get().inputHandler;i?.grabbed===this&&i.ungrab()}}layoutChildren(){if(super.layoutChildren(),this._activeDOMInput!=null){let t=this.DOMInputRect(),i=this._activeDOMInput;i.style.top=(Math.floor(t.y*100)/100).toString()+"px",i.style.left=(Math.floor(t.x*100)/100).toString()+"px",i.style.width=(Math.floor(t.w*100)/100).toString()+"px",i.style.height=(Math.floor(t.h*100)/100).toString()+"px"}}}class Gt extends z{bgColor=null;outlineColor=null;src=null;lockAspect=!0;scaleToFit=!0;antiAlias=!0;angle=0;anchor="center";mirror=!1;constructor(t=null){super(),this.image=new Image,t!==null&&this.updateProperties(t),this.src&&(this.image.src=this.src)}on_src(t,i,e){this.src?this.image.src=this.src:this.image.src=""}layoutChildren(){this._layoutNotify&&this.emit("layout",null);let t=p.get();"w"in this.hints&&this.hints.w==null&&(this[2]=this.image.width/t.tileSize),"h"in this.hints&&this.hints.h==null&&(this[3]=this.image.height/t.tileSize),this._needsLayout=!1,super.layoutChildren()}draw(t,i){if(super.draw(t,i),!this.image.complete||this.image.naturalHeight==0)return;let e=1-2*(this.mirror?1:0),s=this.rect;if(this.scaleToFit||(s.x+=s.w/2-this.image.width/2/t.tileSize,s.y+=s.h/2-this.image.height/2/t.tileSize,s.w=this.image.width/t.tileSize,s.h=this.image.height/t.tileSize),this.lockAspect){let n=this.image.height/this.image.width,l=s.h/s.w,h=s.h,a=s.w;n<l&&(h=s.w*n),n>l&&(a=s.h/n),s.x+=s.w/2-a/2,s.y+=s.h/2-h/2,s.w=a,s.h=h}i.save(),i.imageSmoothingEnabled=this.antiAlias;let r=this.anchor;r=="center"?r=[s.w/2,s.h/2]:r=[r[0]*s.w,r[1]*s.h],i.translate(s.x+r[0],s.y+r[1]),this.angle!=0&&i.rotate(this.angle),e&&i.scale(-1,1),i.translate(-r[0],-r[1]),i.drawImage(this.image,0,0,this.image.width,this.image.height,0,0,s.w,s.h),i.restore()}}class nt extends z{spacingX=0;spacingY=0;paddingX=0;paddingY=0;orientation="vertical";order="forward";constructor(t=null){super(),t!==null&&this.updateProperties(t)}*iterChildren(){if(this.order==="forward")for(let t of this._children)yield t;else for(let t=this._children.length-1;t>=0;t--)yield this._children[t]}on_numX(t,i,e){this._needsLayout=!0}on_numY(t,i,e){this._needsLayout=!0}on_spacingX(t,i,e){this._needsLayout=!0}on_spacingY(t,i,e){this._needsLayout=!0}on_paddingX(t,i,e){this._needsLayout=!0}on_paddingY(t,i,e){this._needsLayout=!0}on_orientation(t,i,e){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let t=this.getMetric(this,"spacingX",this.spacingX),i=this.getMetric(this,"spacingY",this.spacingY),e=this.getMetric(this,"paddingX",this.paddingX),s=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation==="vertical"){let r=this.children.length,n=this.h-i*(r-1)-2*s,l=this.w-2*e,h=0;for(let c of this.iterChildren())c.w=l,this.applyHints(c,l,n),"h"in c.hints&&(c.hints.h===null&&c.layoutChildren(),h+=c.h,r--);let a=(n-h)/r,u=l;r===0&&n>0&&(s=(n-h)/2);let d=this.y+s,f=this.x+e;for(let c of this.iterChildren())c.y=d,!("x"in c.hints)&&!("center_x"in c.hints)&&!("right"in c.hints)&&(c.x=f),"w"in c.hints||(c.w=u),"h"in c.hints||(c.h=a),c.layoutChildren(),d+=i+c.h;r===0&&"h"in this.hints&&this.hints.h===null&&(this[3]=d+s-this.y);return}if(this.orientation==="horizontal"){let r=this.children.length,n=this.h-2*s,l=this.w-t*(r-1)-2*e,h=0;for(let c of this.iterChildren())c.h=n,this.applyHints(c,l,n),"w"in c.hints&&(c.hints.w===null&&c.layoutChildren(),h+=c.w,r--);let a=n,u=(l-h)/r;r===0&&l>0&&(e=(l-h)/2);let d=this.y+s,f=this.x+e;for(let c of this.iterChildren())c.x=f,!("y"in c.hints)&&!("center_y"in c.hints)&&!("bottom"in c.hints)&&(c.y=d),"w"in c.hints||(c.w=u),"h"in c.hints||(c.h=a),c.layoutChildren(),f+=t+c.w;r==0&&"w"in this.hints&&this.hints.w==null&&(this[2]=f+e-this.x)}}}class yt extends z{activePage=0;constructor(t=null){super(),t!==null&&this.updateProperties(t)}on_wheel(t,i,e){const s=this.children[this.activePage]??void 0;return!!(s!==void 0&&s.emit(t,e))}on_touch_down(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(t,r))return!0}else{const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(t,e))return!0}return!1}on_touch_up(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(t,r))return!0}else{const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(t,e))return!0}return!1}on_touch_move(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(t,r))return!0}else{const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(t,e))return!0}return!1}on_touch_cancel(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(t,r))return!0}else{const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(t,e))return!0}return!1}on_activePage(t,i,e){this._needsLayout=!0}_draw(t,i,e){this.draw(t,i);let s=this.getTransform();if(s){i.save(),i.transform(s.a,s.b,s.c,s.d,s.e,s.f);let n=this.children[this.activePage]??void 0;n!==void 0&&n._draw(t,i,e),i.restore();return}let r=this.children[this.activePage]??void 0;r!==void 0&&r._draw(t,i,e)}}class Vt extends yt{tabHeightHint="1";tabGroupName="tabbedNotebookGroup";constructor(t=null){super(),this.buttonBox=new nt({orientation:"horizontal",hints:{h:this.tabHeightHint,w:null}}),this.buttonScroller=new lt({id:"_scrollview",hints:{h:this.tabHeightHint,w:1},children:[this.buttonBox]}),this._children=[this.buttonScroller],this.buttonScroller.parent=this,t!==null&&this.updateProperties(t),this.updateButtons()}on_tabHeightHint(t,i,e){this.buttonBox.hints.h=this.tabHeightHint}on_child_added(t,i,e){this.updateButtons()}on_child_removed(t,i,e){this.updateButtons()}on_wheel(t,i,e){const s=this._children[0]??void 0;if(s!==void 0&&s.emit(t,e))return!0;const r=this.children[this.activePage]??void 0;return!!(r!==void 0&&r.emit(t,e))}on_touch_down(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];const l=this._children[0]??void 0;if(l!==void 0&&l.emit(t,r))return!0;const h=this.children[this.activePage]??void 0;if(h!==void 0&&h.emit(t,r))return!0}else{const r=this._children[0]??void 0;if(r!==void 0&&r.emit(t,e))return!0;const n=this.children[this.activePage]??void 0;if(n!==void 0&&n.emit(t,e))return!0}return!1}on_touch_up(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];const l=this._children[0]??void 0;if(l!==void 0&&l.emit(t,r))return!0;const h=this.children[this.activePage]??void 0;if(h!==void 0&&h.emit(t,r))return!0}else{const r=this._children[0]??void 0;if(r!==void 0&&r.emit(t,e))return!0;const n=this.children[this.activePage]??void 0;if(n!==void 0&&n.emit(t,e))return!0}return!1}on_touch_move(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];const l=this._children[0]??void 0;if(l!==void 0&&l.emit(t,r))return!0;const h=this.children[this.activePage]??void 0;if(h!==void 0&&h.emit(t,r))return!0}else{const r=this._children[0]??void 0;if(r!==void 0&&r.emit(t,e))return!0;const n=this.children[this.activePage]??void 0;if(n!==void 0&&n.emit(t,e))return!0}return!1}on_touch_cancel(t,i,e){let s=this.getTransform();if(s){let r=e.copy(),n=s.inverse().transformPoint(new DOMPoint(r.pos[0],r.pos[1]));r.pos=[n.x,n.y];const l=this._children[0]??void 0;if(l!==void 0&&l.emit(t,r))return!0;const h=this.children[this.activePage]??void 0;if(h!==void 0&&h.emit(t,r))return!0}else{const r=this._children[0]??void 0;if(r!==void 0&&r.emit(t,e))return!0;const n=this.children[this.activePage]??void 0;if(n!==void 0&&n.emit(t,e))return!0}return!1}get children(){return this._children.slice(1)}set children(t){for(let i of this._children.slice(1))this.emit("child_removed",i),i.parent=null,this._needsLayout=!0,this.updateButtons();this._children=this._children.slice(0,1);for(let i of t)this.addChild(i)}updateButtons(){this.buttonBox.children=[];let t=0;for(let i of this.children){const e=new wt({text:i.name??String(t+1),group:this.tabGroupName,singleSelect:!0,press:this.activePage===t,fontSize:"0.5",hints:{h:null,w:null}});e.bind("press",(s,r,n)=>{this.activePage=this.buttonBox.children.findIndex(l=>l===r)}),this.buttonBox.addChild(e),t++}}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;const t=this._children[0];this.applyHints(t),t.x=this.x,t.y=this.y,t.layoutChildren();const i=this.h-t.h,e=this.w;for(let s of this.children)s.y=this.y+t.h,s.x=this.x,s.w=e,s.h=i,s.layoutChildren()}_draw(t,i,e){this.draw(t,i);let s=this.getTransform();if(s){i.save(),i.transform(s.a,s.b,s.c,s.d,s.e,s.f);let l=this._children[0]??void 0;l!==void 0&&l._draw(t,i,e);let h=this.children[this.activePage]??void 0;h!==void 0&&h._draw(t,i,e),i.restore();return}let r=this._children[0]??void 0;r!==void 0&&r._draw(t,i,e);let n=this.children[this.activePage]??void 0;n!==void 0&&n._draw(t,i,e)}}class Nt extends z{numX=1;numY=1;spacingX=0;spacingY=0;paddingX=0;paddingY=0;orientation="horizontal";constructor(t=null){super(),t!==null&&this.updateProperties(t)}on_numX(t,i,e){this._needsLayout=!0}on_numY(t,i,e){this._needsLayout=!0}on_spacingX(t,i,e){this._needsLayout=!0}on_spacingY(t,i,e){this._needsLayout=!0}on_paddingX(t,i,e){this._needsLayout=!0}on_paddingY(t,i,e){this._needsLayout=!0}on_orientation(t,i,e){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let t=this.getMetric(this,"spacingX",this.spacingX),i=this.getMetric(this,"spacingY",this.spacingY),e=this.getMetric(this,"paddingX",this.paddingX),s=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation=="horizontal"){let r=this.numX,n=Math.ceil(this.children.length/this.numX),l=this.h-i*(n-1)-2*s,h=this.w-t*(r-1)-2*e,a=new Array(r).fill(0),u=new Array(n).fill(0),d=0,f=0,c=0;for(let w of this.children)this.applyHints(w,h,l),"w"in w.hints&&(a[f]=Math.max(w.w,a[f])),"h"in w.hints&&(u[d]=Math.max(w.h,u[d])),(c+1)%r==0?(d++,f=0):f++,c++;let m=0,b=0,T=0,_=0;for(let w of a)m+=w,w>0&&T++;for(let w of u)b+=w,w>0&&_++;let y=n>_?(l-b)/(n-_):0,M=r>T?(h-m)/(r-T):0,x=this.y+s,I=this.x+e;d=0,f=0;for(let w=0;w<this.children.length;w++){let D=this.children[w],B=a[f]==0?M:a[f],Y=u[d]==0?y:u[d];"w"in D.hints||(D.w=B),"h"in D.hints||(D.h=Y),D.x=I,D.y=x,D.layoutChildren(),(w+1)%r==0?(I=this.x+e,x+=i+Y,f=0,d++):(I+=t+B,f++)}return}else{let r=Math.ceil(this.children.length/this.numY),n=this.numY,l=this.h-i*(n-1)-2*s,h=this.w-t*(r-1)-2*e,a=new Array(r).fill(0),u=new Array(n).fill(0),d=0,f=0,c=0;for(let w of this.children)this.applyHints(w,h,l),"w"in w.hints&&(a[f]=Math.max(w.w,a[f])),"h"in w.hints&&(u[d]=Math.max(w.h,u[d])),(c+1)%n==0?(f++,d=0):d++,c++;let m=0,b=0,T=0,_=0;for(let w of a)m+=w,w>0&&T++;for(let w of u)b+=w,w>0&&_++;let y=n>_?(l-b)/(n-_):0,M=r>T?(h-m)/(r-T):0,x=this.y+s,I=this.x+e;d=0,f=0;for(let w=0;w<this.children.length;w++){let D=this.children[w],B=a[f]==0?M:a[f],Y=u[d]==0?y:u[d];"w"in D.hints||(D.w=B),"h"in D.hints||(D.h=Y),D.x=I,D.y=x,D.layoutChildren(),(w+1)%n==0?(x=this.y+s,I+=t+B,d=0,f++):(x+=i+Y,d++)}}}}class lt extends z{_scrollX=0;_scrollY=0;scrollX=0;scrollY=0;scrollW=!0;scrollH=!0;wAlign="center";hAlign="top";uiZoom=!0;uiMove=!0;zoom=1;vel=null;velCutoff=1e-5;velDecay=.95;unboundedH=!1;unboundedW=!1;_zoomCenter=null;constructor(t=null){super(),t!==null&&this.updateProperties(t),this._processTouches=!0,this._oldTouch=null,this._lastDist=null}on_child_added(t,i,e){this.children.length==1&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0,e.bind("rect",(s,r,n)=>this._needsLayout=!0),e.bind("w",(s,r,n)=>this._needsLayout=!0),e.bind("h",(s,r,n)=>this._needsLayout=!0))}on_child_removed(t,i,e){this.children.length==0&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.children[0][0]=0,this.children[0][1]=0,this.scrollW||(this.children[0][2]=this.w),this.scrollH||(this.children[0][3]=this.h);for(let t of this.children)t.layoutChildren()}fitToClient(){this.zoom=Math.min(this.w/this.children[0].w,this.h/this.children[0].h),this.scrollX=.5*this.scrollableW,this.scrollY=.5*this.scrollableH}on_uiZoom(t,i,e){this._needsLayout=!0}on_hAlign(t,i,e){this._needsLayout=!0}on_vAlign(t,i,e){this._needsLayout=!0}*iter(t=!0,i=!0){if(yield this,!!t)if(i)for(let e of this._children)this.contains(e)&&(yield*e.iter(...arguments));else for(let e of this._children)yield*e.iter(...arguments)}on_scrollW(t,i,e){this._needsLayout=!0,this.scrollX=0}on_scrollH(t,i,e){this._needsLayout=!0,this.scrollY=0}on_scrollX(t,i,e){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedW){this._scrollX=this.scrollX;return}let s=0;switch(this.wAlign){case"center":s=.5*this.scrollableW;break;case"right":s=1*this.scrollableW}this._scrollX=this.scrollableW<=0||this.scrollableW>=this.children[0].w?s:e,this._scrollX=$(e,0,this.scrollableW)}on_scrollY(t,i,e){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedH){this._scrollY=this.scrollY;return}let s=0;switch(this.hAlign){case"middle":s=.5*this.scrollableH;break;case"bottom":s=1*this.scrollableH}this._scrollY=this.scrollableH<=0||this.scrollableH>=this.children[0].h?s:e,this._scrollY=$(e,0,this.scrollableH)}update(t,i){if(super.update(t,i),this.vel!==null){this.scrollX+=this.vel.x*i,this.scrollY+=this.vel.y*i,this.vel=this.vel.scale(this.velDecay**(i/30));let e=this.vel.abs();e.x<=this.velCutoff/this.zoom&&e.y<=this.velCutoff/this.zoom&&(this.vel=null)}}getTransform(){const t=p.get().tileSize;return new DOMMatrix().translate(Math.floor((this.x-this._scrollX*this.zoom)*t)/t,Math.floor((this.y-this._scrollY*this.zoom)*t)/t).scale(this.zoom,this.zoom)}on_touch_down(t,i,e){this.vel=null;let s=e.rect;if(this._lastDist=null,this.collide(s)){let r=Date.now(),n=e.asChildTouch(this);return this._oldTouch=[n.x,n.y,n.identifier,r,null],super.on_touch_down(t,i,e)||e.grab(this),!0}return!1}on_touch_up(t,i,e){if(e.grabbed!==this)return!1;if(this._oldTouch!=null){let s=this._oldTouch[4],r=new g([this._oldTouch[0],this._oldTouch[1]]),n=e.asChildTouch(this),l=Math.max(Date.now()-this._oldTouch[3],1),h=this.scrollableW>0||this.unboundedW?(n.x-r.x)/l:0,a=this.scrollableH>0||this.unboundedH?(n.y-r.y)/l:0;this.vel=new g([-h,-a]),s&&(this.vel=this.vel.add(s).scale(.5))}return this._oldTouch=null,this._lastDist=null,this._zoomCenter=null,e.ungrab(),!1}on_touch_move(t,i,e){if(e.grabbed!==this)return!1;let s=e.rect;if(this.collide(s)){let r=e.asChildTouch(this);if((this.uiMove&&e.nativeEvent==null||e.nativeEvent instanceof TouchEvent&&e.nativeEvent.touches.length==1)&&this._oldTouch!=null&&e.identifier==this._oldTouch[2]){this.scrollW&&(this.scrollX=this.scrollableW==0?0:this._scrollX+(this._oldTouch[0]-r.x)),this.scrollH&&(this.scrollY=this.scrollableH==0?0:this._scrollY+(this._oldTouch[1]-r.y));let n=e.asChildTouch(this),l=this._oldTouch,h=Date.now(),a=new g([0,0]),u=new g([0,0]);if(l!=null){let f=Math.max(h-l[3],1),c=this.scrollableW>0||this.unboundedW?(n.x-r.x)/f:0,m=this.scrollableH>0||this.unboundedH?(n.y-r.y)/f:0;a=new g([c,m]),u=l[4]!==null?l[4]:u}let d=a.abs().sum()===0?a:a.add(u).scale(.5);this._oldTouch=[n.x,n.y,e.identifier,h,d]}if(this.uiZoom&&e.nativeEvent&&e.nativeEvent instanceof TouchEvent&&e.nativeEvent.touches.length==2){let n=e.nativeEvent.touches[0],l=e.nativeEvent.touches[1],h=Tt([n.clientX,n.clientY],[l.clientX,l.clientY]);if(this._lastDist!=null){let a=this._scrollX+this.w/this.zoom/2,u=this._scrollY+this.h/this.zoom/2,d=[n.clientX,n.clientY],f=[l.clientX,l.clientY],c=this.appToChild(d),m=this.appToChild(f),b=[(c[0]+m[0])/2,(c[1]+m[1])/2];this._zoomCenter===null&&(this._zoomCenter=new g(b));let T=this.zoom*h/this._lastDist,_=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(T,_);let y=this.appToChild(d),M=this.appToChild(f),x=[(y[0]+M[0])/2,(y[1]+M[1])/2];this.scrollX=a+b[0]-x[0]-this.w/this.zoom/2,this.scrollY=u+b[1]-x[1]-this.h/this.zoom/2}this._lastDist=h}}return!1}on_touch_cancel(t,i,e){return this._lastDist=null,e.grabbed===this?(e.ungrab(),!0):!!super.on_touch_cancel(t,i,e)}on_wheel(t,i,e){let s=p.get();if(!s.inputHandler)return!0;let r=this._scrollX+this.w/this.zoom/2,n=this._scrollY+this.h/this.zoom/2,l=e.nativeObject;if(!this.collide(e.rect)&&(!this.unboundedW||!this.unboundedH)||!(l instanceof WheelEvent))return!1;if(this.uiZoom&&s.inputHandler.isKeyDown("Control")){let h=e.asChildTouch(this);h.pos[0],h.pos[1];let a=this.zoom*Math.exp(-l.deltaY/s.h),u=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(a,u);let d=e.asChildTouch(this);return d.pos[0],d.pos[1],this.scrollX=this.scrollableW==0&&!this.unboundedW?0:r-this.w/this.zoom/2,this.scrollY=this.scrollableH==0&&!this.unboundedH?0:n-this.h/this.zoom/2,this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}else{if(this.uiMove&&this.scrollW&&s.inputHandler.isKeyDown("Shift"))return this.scrollX+=this.scrollableW==0&&!this.unboundedW?0:this.w/this.zoom*(l.deltaY/s.w),this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),!0;if(this.uiMove&&this.scrollH)return this.scrollY+=this.scrollableH==0&&!this.unboundedH?0:this.h/this.zoom*(l.deltaY/s.h),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}return!1}get scrollableW(){return this.children.length==0?0:this.unboundedW?this.children[0].w-this.w/this.zoom:Math.max(this.children[0].w-this.w/this.zoom,0)}get scrollableH(){return this.children.length==0?0:this.unboundedH?this.children[0].h-this.h/this.zoom:Math.max(this.children[0].h-this.h/this.zoom,0)}_draw(t,i,e){this.draw(t,i);let s=this.rect;i.save(),i.beginPath(),i.rect(s[0],s[1],s[2],s[3]),i.clip();let r=this.getTransform();r&&i.transform(r.a,r.b,r.c,r.d,r.e,r.f),this.children[0]._draw(t,i,e),i.restore()}}class Ut extends nt{closeOnTouchOutside=!0;bgColor="slate";outlineColor="gray";dim=!0;dimScale=.8;constructor(t=null){super(),t!==null&&this.updateProperties(t)}popup(){if(this.parent==null){let t=p.get();return this.parent=t,t.addModal(this),!0}return!1}close(t=0){if(this.parent!=null){this.emit("close",t);let i=p.get();return this.parent=null,i.removeModal(this),!0}return!1}on_touch_down(t,i,e){return this.closeOnTouchOutside&&!this.collide(e.rect)?(this.close(),!0):super.on_touch_down(t,i,e)}draw(t,i){if(this.dim){let e=p.get().baseWidget.rect,s=p.get().ctx;if(!s)return;s.fillStyle="rgba(0,0,0,"+this.dimScale+")",s.rect(e[0],e[1],e[2],e[3]),s.fill(),super.draw(t,s)}}}function qt(o,t,i){const e=Math.floor(o/t/4)>0;o=o%(t*4);const s=Math.floor(o/t);o=o%t;const r=Math.floor(o/i),n=o%i;return[e,s,r,n]}class tt{constructor(t="",i=[],e=[],s={}){this.id=t,this.matchTiles=new Set(i),this.matchAdjTiles=new Set(e),this.autos=s}autoTile(t,i,e){let s=0,r=1;const n=i.get(t);if(this.matchTiles.has(n)){for(let h of[[0,-1],[1,0],[0,1],[-1,0]]){const a=t.add(h),u=i.get(a);this.matchAdjTiles.has(u)&&(s+=r),r*=2}const l=this.autos[s]??void 0;l&&e.set(t,l)}}get length(){return this.matchTiles.size}}class $t extends Ht{animations=new Map;autoTiles=new Map;tileStamps=new Map;aliases=new Map;constructor(t,i=16){super(),this.spriteSize=i,this.sw=0,this.sh=0,this.len=0,this.sheet=new Image,this.sheet.src=t,this.sheet.onload=e=>{this.sw=Math.floor(this.sheet.width/this.spriteSize),this.sh=Math.floor(this.sheet.height/this.spriteSize),this.len=this.sw*this.sh,p.get().emit("sheetLoaded",this.sheet),p.get()._needsLayout=!0}}getAlias(t){for(let i of this.aliases.keys())if(this.aliases.get(i)===t)return i}update(t,i){super.update(t,i);for(let e of this.animations.values())e.update(t,i)}sheetToDataURL(){const t=document.createElement("canvas");t.width=this.sheet.width,t.height=this.sheet.height;const i=t.getContext("2d");return i?(i.drawImage(this.sheet,0,0),t.toDataURL("image/png")):void 0}serialize(){const t={};t.spriteSize=this.spriteSize,t.src=this.sheetToDataURL();const i={};for(let s of this.animations.keys())i[String(s)]=this.animations.get(s);t.animations=i;const e={};for(let s of this.aliases.keys())e[s]=this.aliases.get(s);return t.aliases=e,t}deserialize(t){this.spriteSize=t.spriteSize,this.sheet=new Image,this.sheet.src=t.src,this.animations=new Map;for(let i in t.animations)this.animations.set(parseInt(i),t.animations[i]);this.aliases=new Map;for(let i in t.aliases)this.aliases.set(i,t.aliases[i])}drawIndexed(t,i,e,s,r=0){if(i<-1&&(i=this.animations.get(i)?.tileValue??-1),i>=0){let[n,l,h,a]=qt(i,this.len,this.sw);l=(l+r)%4,!n&&l===0?this.draw(t,[a,h],e,s):this.drawRotated(t,[a,h],e+.5,s+.5,l*90,n,"center")}}draw(t,i,e,s,r=!1){let n=r?-1:1;r&&t.scale(-1,1),t.drawImage(this.sheet,i[0]*this.spriteSize,i[1]*this.spriteSize,this.spriteSize,this.spriteSize,n*e,s,n,1),r&&t.scale(-1,1)}drawScaled(t,i,e,s,r,n=!1){let l=n?-1:1;n&&t.scale(-1,1),t.drawImage(this.sheet,i[0]*this.spriteSize,i[1]*this.spriteSize,this.spriteSize,this.spriteSize,l*e,s,l*r,r),n&&t.scale(-1,1)}drawRotated(t,i,e,s,r,n=!1,l="center"){t.save(),l=="center"?l=[1/2,1/2]:l=[l[0],l[1]],t.translate(e,s),t.rotate(r*Math.PI/180),n&&t.scale(-1,1),t.translate(-l[0],-l[1]),t.drawImage(this.sheet,i[0]*this.spriteSize,i[1]*this.spriteSize,this.spriteSize,this.spriteSize,0,0,1,1),t.restore()}drawRotatedMultitile(t,i,e,s,r,n=!1,l="center"){t.save();let h=i[2],a=i[3];l=="center"?l=[h*1/2,a*1/2]:l=[l[0],l[1]],t.translate(e+l[0],s+l[1]),t.rotate(r*Math.PI/180),n&&t.scale(-1,1),t.translate(-l[0],-l[1]),t.drawImage(this.sheet,i[0]*this.spriteSize,i[1]*this.spriteSize,this.spriteSize*h,this.spriteSize*a,0,0,h,a),t.restore()}}class ht extends z{spriteSheet=null;frames=[];timePerFrame=30;timeLeft=0;activeFrame=0;id="";index=-1;facing=0;flipX=!1;flipY=!1;constructor(t={}){super(),t&&this.updateProperties(t)}update(t,i){super.update(t,i),this.timeLeft-=i,this.timeLeft<=0&&(this.activeFrame++,this.activeFrame>=this.frames.length&&(this.activeFrame=0),this.timeLeft+=this.timePerFrame),this.frames.length>0&&t.requestFrameUpdate()}get tileValue(){return this.frames[this.activeFrame]??-1}layoutChildren(){super.layoutChildren()}draw(t,i){this.spriteSheet===null||!this.spriteSheet.sheet.complete||(i.translate(this.x,this.y),i.scale(this.w,this.h),this.spriteSheet.drawIndexed(i,this.tileValue,0,0,this.facing),i.scale(1/this.w,1/this.h),i.translate(-this.x,-this.y))}}class bt extends z{constructor(t={}){super(),this.defaultValue=-1,this._data=new O,this._vLayer=null,this._aLayer=null,this._cacheTileDim=new g,this.tileDim=new g,this.hints={w:null,h:null},this.spriteSheet=null,this.clipRegion=null,this.alphaValue=.5,this.useCache=!0,t&&this.updateProperties(t)}serialize(){const t={};return t._data=this._data.slice(),t.tileDim=this.tileDim.slice(),t.spriteSheet=Array(...p.resources.keys()).find(i=>p.resources[i]===this.spriteSheet)??null,t}get(t){return this._data.get(t)}set(t,i){this._data.set(t,i),this._data._cacheData=null}get data(){return this._data}deserialize(t){this.tileDim=new g(t.tileDim??[0,0]);const i=t._data;for(let e=0;e<i.length;e++)this._data[e]=i[e];this.spriteSheet=p.resources[t.spriteSheet]??null}on_tileDim(t,i,e){this.resizeData(),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new g(this.tileDim)}resizeData(){let t=[];for(let e=0;e<this._cacheTileDim[1];e++)for(let s=0;s<this._cacheTileDim[0];s++)t.push(this.get([s,e]));this._data.tileDim=new g(this.tileDim),this._data.length=this.tileDim[0]*this.tileDim[1],this._data.fill(this.defaultValue);let i=0;for(let e=0;e<this._cacheTileDim[1];e++)for(let s=0;s<this._cacheTileDim[0];s++)s<this.tileDim[0]&&e<this.tileDim[1]&&this.set([s,e],t[i]),++i}draw(t,i){if(super.draw(t,i),this.spriteSheet===null||!this.spriteSheet.sheet.complete||!this.spriteSheet.sheet.complete||this.spriteSheet.sheet.naturalHeight==0)return;let[e,s]=[0,0],[r,n]=this.tileDim;if(this.clipRegion&&([e,s]=this.clipRegion.pos,[r,n]=this.clipRegion.pos.add(this.clipRegion.size).add([1,1]),e=Math.min(Math.max(e,0),this.tileDim[0]),r=Math.min(Math.max(r,0),this.tileDim[0]),s=Math.min(Math.max(s,0),this.tileDim[1]),n=Math.min(Math.max(n,0),this.tileDim[1])),Math.floor(this.spriteSheet.sheet.width/this.spriteSheet.spriteSize),Math.floor(this.spriteSheet.sheet.height/this.spriteSheet.spriteSize),this.useCache){if(this._data._cacheData===null&&this.cacheCanvas(),this._data._cacheData===null)return;const l=this.spriteSheet.spriteSize;if(i.drawImage(this._data._cacheData,l*e,l*s,l*(r-e),l*(n-s),this.x+e,this.y+s,r-e,n-s),this._aLayer===null&&this._vLayer===null)for(let h=e;h<r;h++)for(let a=s;a<n;a++){let u=h+a*this.tileDim[0],d=this._data[u];d<-1&&this.spriteSheet.drawIndexed(i,d,h+this.x,a+this.y)}else if(this._aLayer&&this._vLayer){const h=this._aLayer,a=this._vLayer,u=i.globalAlpha,d=this._data;for(let f=e;f<r;f++)for(let c=s;c<n;c++){let m=f+c*this.tileDim[0],b=d[m];b<-1&&a[m]>0&&(h[m]===0?(i.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(i,b,f+this.x,c+this.y),i.globalAlpha=u):this.spriteSheet.drawIndexed(i,b,f+this.x,c+this.y))}}}else if(this._aLayer===null&&this._vLayer===null)for(let l=e;l<r;l++)for(let h=s;h<n;h++){let a=l+h*this.tileDim[0],u=this._data[a];this.spriteSheet.drawIndexed(i,u,l+this.x,h+this.y)}else if(this._aLayer&&this._vLayer){const l=this._aLayer,h=this._vLayer,a=i.globalAlpha,u=this._data;for(let d=e;d<r;d++)for(let f=s;f<n;f++){let c=d+f*this.tileDim[0],m=u[c];m!==-1&&h[c]>0&&(l[c]===0?(i.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(i,m,d+this.x,f+this.y),i.globalAlpha=a):this.spriteSheet.drawIndexed(i,m,d+this.x,f+this.y))}}}clearCache(){this.data._cacheData=null}cacheCanvas(){if(!this.spriteSheet)return;this._data._cacheData=null;const t=new OffscreenCanvas(this.tileDim[0]*this.spriteSheet.spriteSize,this.tileDim[1]*this.spriteSheet.spriteSize),i=t.getContext("2d");if(!i)return;i.scale(this.spriteSheet.spriteSize,this.spriteSheet.spriteSize);let[e,s]=[0,0],[r,n]=this.tileDim;if(this._aLayer===null&&this._vLayer===null)for(let l=e;l<r;l++)for(let h=s;h<n;h++){let a=l+h*this.tileDim[0],u=this._data[a];u>=0&&this.spriteSheet.drawIndexed(i,u,l,h)}else if(this._aLayer&&this._vLayer){const l=this._aLayer,h=this._vLayer,a=i.globalAlpha,u=this._data;for(let d=e;d<r;d++)for(let f=s;f<n;f++){let c=d+f*this.tileDim[0],m=u[c];m>=0&&h[c]>0&&(l[c]===0?(i.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(i,m,d,f),i.globalAlpha=a):this.spriteSheet.drawIndexed(i,m,d,f))}}this._data._cacheData=t}}class st extends bt{constructor(t={}){super(),this._layerData=[this._data],this.numLayers=1,this.activeLayer=0,this.visibilityLayer=-1,this.alphaLayer=-1,t&&this.updateProperties(t)}on_alphaLayer(t,i,e){this._aLayer=this.alphaLayer>=0?this._layerData[this.alphaLayer]:null}on_visibilityLayer(t,i,e){this._vLayer=this.visibilityLayer>=0?this._layerData[this.visibilityLayer]:null}serialize(){const t={},i=[];for(let e of this._layerData)i.push(e.slice());return t._layerData=i,t.activeLayer=this.activeLayer,t.numLayers=this.numLayers,t.tileDim=this.tileDim.slice(),t.spriteSheet=Array(...p.resources.keys()).find(e=>p.resources[e]===this.spriteSheet)??null,t}deserialize(t){this.numLayers=t.numLayers,this.activeLayer=t.activeLayer,this.tileDim=new g(t.tileDim??[0,0]);const i=t._layerData.length;this._layerData.length=i;for(let e=0;e<i;e++){const s=this._layerData[e],r=t._layerData[e];for(let n=0;n<r.lenth;n++)s[n]=r[n]}this.spriteSheet=p.resources[t.spriteSheet]??null,this.clearCache()}on_tileDim(t,i,e){if("_layerData"in this){for(let s of this._layerData)this._data=s,this.resizeData();this.activeLayer>=0&&(this._data=this._layerData[this.activeLayer]),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new g(this.tileDim)}}on_numLayers(t,i,e){const s=this._layerData.length;this._layerData.length=this.numLayers;for(let r=s;r<this.numLayers;r++){const n=new O(this.tileDim).fill(this.defaultValue);this._layerData[r]=n}this.activeLayer>=this.numLayers&&(this.activeLayer=this.numLayers-1)}on_activeLayer(t,i,e){this._data=this._layerData[this.activeLayer]}get layer(){return this._layerData}getFromLayer(t,i){return this._layerData[t][i[0]+i[1]*this.tileDim[0]]}setInLayer(t,i,e){this._layerData[t][i[0]+i[1]*this.tileDim[0]]=e,this._layerData[t]._cacheData=null}clearCache(){for(let t of this._layerData)t._cacheData=null}draw(t,i){for(let e of this._layerData)e.hidden||(this._data=e,super.draw(t,i));this._data=this._layerData[this.activeLayer]}}p.registerClass("Widget",z,"");p.registerClass("App",p,"");p.registerClass("Label",U,"");p.registerClass("Button",Rt,"");p.registerClass("ToggleButton",wt,"");p.registerClass("BasicButton",Ft,"");p.registerClass("TextInput",Et,"");p.registerClass("CheckBox",Xt,"");p.registerClass("Slider",Ot,"");p.registerClass("ImageWidget",Gt,"");p.registerClass("BoxLayout",nt,"");p.registerClass("GridLayout",Nt,"");p.registerClass("ScrollView",lt,"");p.registerClass("ModalView",Ut,"");p.registerClass("Notebook",yt,"");p.registerClass("TabbedNotebook",Vt,"");p.registerClass("SpriteWidget",ht,"");p.registerClass("TileMap",bt,"");p.registerClass("LayeredTileMap",st,"");class _t extends ht{constructor(t={}){super(),t&&this.updateProperties(t)}}class Kt extends ht{constructor(t={}){super(),t&&this.updateProperties(t)}}const V={north:0,east:1,south:2,west:3,none:4},G={0:R(0,-1),1:R(1,0),2:R(0,1),3:R(-1,0),4:R(0,0)},Zt={0:1,1:2,2:4,3:8,4:0};function et(o){return o[1]<0?0:o[0]>0?1:o[1]>0?2:o[0]<0?3:4}function Jt(o,t,i){if(t.equals(i))return[i];let e=new O(o.tileDim).fill(1/0);e.set(t,0);let s=[t],r=[],n=!1;for(;s.length>0&&!n;){let a=[];for(let d of s)for(let f of o.iterAdjacent(d)){let c=o.get(f);e.get(d)+c<e.get(f)&&(f.equals(i)&&(n=!0),e.set(f,e.get(d)+c),c>1&&!n?r.push([f,c]):a.push(f))}const u=[];for(let d of r)d[1]>1?(d[1]--,u.push(d)):a.push(d[0]);r=u,s=a}const l=[];if(e.get(i)===1/0)return l;let h=i;for(;!h.equals(t);){let a=1/0,u=null;for(let d of e.iterAdjacent(h)){const f=e.get(d);f<a&&(a=f,u=d)}l.unshift(h),u!==null&&(h=u)}return l}class N extends Kt{actions=new Set;facing=V.north;state="Patrolling";gpos=R(0,0);patrolRoute=[];patrolTarget=-1;actionsThisTurn=2;visibleToPlayer=!1;history=[];suppressed=!1;movementBlockedCount=0;_coverPositions=new Set;_visibleLayer=new O;activeCharacter=!1;constructor(t={}){super(),this.spriteSheet=p.resources.sprites,this.frames=[484],this.w=1,this.h=1,t&&this.updateProperties(t)}setupForLevelStart(t,i){this._coverPositions=new Set,this._visibleLayer=new O([t.w,t.h]).fill(0);let e=0,s=R(1,1),r=R(1,1);for(;e<1e3&&(e++,s=W(i.getRandomPos(t.w,t.h)),t.metaTileMap.layer[L.layout].get(s)!==v.floor););for(e=0;e<1e3&&(e++,r=W(i.getRandomPos(t.w,t.h)),!(t.metaTileMap.layer[L.layout].get(r)===v.floor&&!r.equals(s))););this.patrolRoute=[s,r],this.gpos=W(r),[this.x,this.y]=this.gpos;const n={Alfred:[832,2880],Bennie:[833,2881],Charlie:[834,2882],Devon:[835,2883]};t.tileMap.layer[1].set(s,n[this.id][0]),t.tileMap.layer[1].set(r,n[this.id][1])}rest(t){this.actionsThisTurn--,this.activeCharacter&&(this.updateLoS(t),this.updateCamera(t))}move(t,i){const e=this.gpos.add(G[t]),r=i.metaTileMap.getFromLayer(L.traversible,e);if(this.facing=t,r&Zt[t]&&!i.characters.reduce((n,l)=>n||l.gpos.equals(e),!1)){this.gpos=e;const n=new ct;n.add({x:this.gpos[0],y:this.gpos[1]},250),n.start(this),this.actionsThisTurn--,this.movementBlockedCount=Math.max(this.movementBlockedCount-1,0)}else this.movementBlockedCount++;this.activeCharacter&&(this.updateLoS(i),this.updateCamera(i))}useAction(t,i,e){}updateLoS(t){const i=t.metaTileMap;this._coverPositions.clear(),this._visibleLayer.fill(0),i.activeLayer=L.allowsSight;const e=this.gpos;for(let s of i.data.iterRectBoundary(new S([...this.gpos,20,20]).translate([-10,-10]).translate(G[this.facing].scale(9)))){const r=W(s);let n=W(this.gpos),l=!1;for(let h of i.data.iterBetween(e,r)){let a=W([Math.round(h[0]),Math.round(h[1])]),u=W(a);const d=h[0]-a[0];d>0?u[0]+=1:d<0&&(u[0]-=1);const f=h[1]-a[1];f>0?u[1]+=1:f<0&&(u[1]-=1);let c=G[et(W(a).sub(n))],m=G[et(W(u).sub(n))];const b=i.get(a),T=i.get(u);let _=e.dist(a)>e.dist(u),y=!1;if((e.dist(a)===0||c[1]<0&&b&1||c[0]>0&&b&2||c[1]>0&&b&4||c[0]<0&&b&8)&&(y=!0),l?(this._coverPositions.add(a),_&&this._coverPositions.add(a)):(this._visibleLayer[a[0]+a[1]*i.w]=1,this.activeCharacter&&i.setInLayer(L.seen,a,1),_&&(this._visibleLayer[u[0]+u[1]*i.w]=1,this.activeCharacter&&i.setInLayer(L.seen,u,1))),!y)break;l=!1,(c[1]<0&&b&16||c[0]>0&&b&32||c[1]>0&&b&64||c[0]<0&&b&128||_&&m[1]<0&&T&16||_&&m[0]>0&&T&32||_&&m[1]>0&&T&64||_&&m[0]<0&&T&128)&&(l=!0),n=W(a)}}t.tileMap.clearCache()}updateCamera(t){const i=p.get().findById("scroller");if(i){const e=this.gpos.add(G[this.facing].scale(5)),s=e.dist(this.gpos),r=Math.min(Math.max(e[0]+.5-i.w/i.zoom/2,0),t.w),n=Math.min(Math.max(e[1]+.5-i.h/i.zoom/2,0),t.h),l=new ct;l.add({scrollX:r,scrollY:n},250*s/2),l.start(i)}}takeAction(t,i){this.history.push(t)}takeTurn(t){for(t.updateCharacterVisibility(!0);this.actionsThisTurn>0;)if(this.state==="Patrolling"){if(this.patrolTarget<0&&(this.patrolTarget=0),this.patrolRoute.length===0)return;this.gpos.equals(this.patrolRoute[this.patrolTarget])&&(this.patrolTarget=(this.patrolTarget+1)%this.patrolRoute.length);const i=this.gpos,e=this.patrolRoute[this.patrolTarget],s=new O([t.w,t.h]);t.metaTileMap.layer[L.layout].forEach((n,l)=>{s[l]=n===v.wall?1/0:1});for(let n of t.characters)n!==this&&s.set(n.gpos,s.get(n.gpos)+(n.movementBlockedCount<=this.movementBlockedCount?4+this.movementBlockedCount*2:4));const r=Jt(s,i,e);r.length>0&&(this.move(et(r[0].sub(this.gpos)),t),this.history.push(new _t)),this.actionsThisTurn--,t.updateCharacterVisibility(!0)}this.actionsThisTurn=2}draw(t,i){(this.activeCharacter||this.visibleToPlayer)&&super.draw(t,i)}}class ft extends N{constructor(t={}){super(),this.spriteSheet=p.resources.sprites,this.frames=[292],t&&this.updateProperties(t)}setupForLevelStart(t){this._coverPositions=new Set,this.activeCharacter?(this._visibleLayer=t.metaTileMap._layerData[L.visible],this._visibleLayer.fill(0)):this._visibleLayer=new O([t.w,t.h]).fill(0)}takeAction(t,i){}}const L={layout:0,seen:1,visible:2,traversible:3,allowsSight:4,allowsSound:5,cover:6,moveCost:7},v={outside:0,floor:1,water:2,wall:3,doorway:4,window:5},Qt={tree:163},pt={0:103,1:74},te={1:1120,2:96,4:1120,8:96,5:1120,10:96,3:97,6:1121,12:2145,9:3169,7:1122,11:98,13:3170,14:2146,15:99},it={wall:new tt("mansionWalls",[v.wall],[v.wall,v.doorway,v.window],te),doorway:new tt("mansionDoorway",[v.doorway],[v.wall,v.doorway,v.window],{1:0,2:0,4:0,8:0,5:0,10:0}),window:new tt("mansionWindow",[v.window],[v.wall,v.doorway,v.window],{1:0,2:0,4:0,8:0,5:0,10:0})};function ee(o,t){const i=t.w-1,e=t.h-1,s=t.pos;for(let r of o.data.iterBetween(s,s.add([i,0])))o.set(r,v.wall);for(let r of o.data.iterBetween(s,s.add([0,e])))o.set(r,v.wall);for(let r of o.data.iterBetween(s.add([0,e]),s.add([i,e])))o.set(r,v.wall);for(let r of o.data.iterBetween(s.add([i,0]),s.add([i,e])))o.set(r,v.wall)}function H(o,t,i){for(let l of o.data.iterRect(t.grow(-1)))o.set(l,v.floor);ee(o,t);const e=t[0]+1+i.getRandomInt(t[2]-2),s=t[0]+1+i.getRandomInt(t[2]-2),r=t[1]+1+i.getRandomInt(t[3]-2),n=t[1]+1+i.getRandomInt(t[3]-2);o.set(new g([e,t[1]]),v.doorway),o.set(new g([s,t[1]+t[3]-1]),v.doorway),o.set(new g([t[0],r]),v.doorway),o.set(new g([t[0]+t[2]-1,n]),v.doorway)}function ie(o,t){o.w=80,o.h=40;const[i,e]=[o.w,o.h],s=new g([o.w,o.h]),r=o.tileMap;r.useCache=!0,r.numLayers=3,r.tileDim=s,r.activeLayer=0;const n=o.metaTileMap;n.defaultValue=0,n.numLayers=8,n.tileDim=s,n.activeLayer=0;for(const k of n.data.iterAll())n.set(k,v.outside);const h=new S([0,0,s[0],s[1]]).grow(-10),[a,u,d,f]=h,c=Math.floor(d)/2,m=Math.floor(d)/4,b=Math.floor(f)/2,T=Math.floor(f)/4,_=t.getRandomInt(m,c),y=c+t.getRandomInt(m,c),M=t.getRandomInt(T,b),x=t.getRandomInt(M+4,Math.min(M+7,f-1)),I=Math.max(t.getRandomInt(M-3,M),0),w=Math.min(t.getRandomInt(x+3,x),f-1),D=-t.getRandomInt(0,5),B=-t.getRandomInt(0,5);t.getRandomInt(0,4),H(n,new S([a+_,u,y-_+1,I+1]),t),H(n,new S([a+_,u+I,y-_+1,w-I+1]),t),H(n,new S([a+_,u+w,y-_+1,f-w+1]),t),H(n,new S([a,u+D,_+1,M+1]),t),H(n,new S([a,u+D+M,_+1,x-M+1]),t),H(n,new S([a,u+D+x,_+1,f-x+1]),t),H(n,new S([a+y,u+B,d-y+1,M+1]),t),H(n,new S([a+y,u+B+M,d-y+1,x-M+1]),t),H(n,new S([a+y,u+B+x,d-y+1,f-x+1]),t);const Y=[];for(let k of n.data.iterAll()){const j=n.get(k);if(j===v.outside&&t.random()>.95&&Y.push(k),j in pt)r.set(k,pt[j]);else{const Z=new g(k);it.wall.autoTile(Z,n,r),it.doorway.autoTile(Z,n,r),it.window.autoTile(Z,n,r)}const K=j===v.wall?0:15;n.setInLayer(L.traversible,k,K)}r.activeLayer=1;const ot=n._layerData[L.allowsSight];n.activeLayer=L.layout;for(let k of n.data.iterAll()){n.setInLayer(L.seen,k,n.data.numInRange(k,[v.outside],1.5)>0?1:0);const j=n.getFromLayer(L.layout,k),K=k[0]+k[1]*i;ot[K]|=j===v.wall?0:15}for(let k of Y){r.set(k,Qt.tree);const j=k[0]+k[1]*i;ot[j]|=240}r._vLayer=n._layerData[L.seen],r._aLayer=n._layerData[L.visible],r.clearCache()}class se extends z{rng=new mt;clipRegion=new S;tileMap=new st;metaTileMap=new st;enemies=[new N({id:"Alfred"}),new N({id:"Bennie"}),new N({id:"Charlie"}),new N({id:"Devon"})];entities=new z({hints:{h:1,w:1}});playerCharacters=[new ft({id:"Randy",x:0,y:0,activeCharacter:!0}),new ft({id:"Maria",activeCharacter:!1})];characters=[...this.enemies,...this.playerCharacters];activeCharacter=this.playerCharacters[0];spriteSheet=null;constructor(t=null){super(),this.children=[this.tileMap,this.entities,...this.enemies,...this.playerCharacters],this.rng.seed(100),t&&this.updateProperties(t)}setupLevel(){ie(this,this.rng),this.playerCharacters[0].setupForLevelStart(this,this.rng),this.enemies.forEach(t=>t.setupForLevelStart(this,this.rng))}on_spriteSheet(){this.tileMap.spriteSheet=this.spriteSheet,this.setupLevel()}on_parent(t,i,e){const s=this.parent;s instanceof lt&&(s.bind("scrollX",(r,n,l)=>this.updateClipRegion(n)),s.bind("scrollY",(r,n,l)=>this.updateClipRegion(n)),s.bind("zoom",(r,n,l)=>this.updateClipRegion(n)),this.updateClipRegion(s))}updateClipRegion(t){this.tileMap.clipRegion=new S([Math.floor(t._scrollX),Math.floor(t._scrollY),Math.ceil(t.w/t.zoom),Math.ceil(t.h/t.zoom)])}updateCharacterVisibility(t=!1){this.activeCharacter;for(let i of this.enemies)t&&(i.visibleToPlayer=!1),i.visibleToPlayer=i.visibleToPlayer||this.activeCharacter?._visibleLayer.get(i.gpos)===1}}const re=""+new URL("spritesheet-D2X_FfBP.png",import.meta.url).href,ne=`

Game:
    prefDimW: 20
    prefDimH: 21
    integerTileSize: true
    tileSize: 16
    Notebook:
        hints: {w:1, h:1}
        id: 'notebook'
        BoxLayout:
            id: 'game'
            orientation: 'vertical'
            hints: {center_x:0.5, center_y:0.5, w:1, h:1}
            BoxLayout:
                hints: {h:'1'}
                orientation: 'horizontal'
                FPS:
                    align:'left'
                Label:
                    id: 'zoomButton'
                    text: 'Welcome to the mansion'
                    align: 'right'
                Button: 
                    text: 'Help'
                    hints: {w: '3'}
                    on_press:
                        const help = window.app.findById('help');
                        help.helpVal = 0;
                        const nb = window.app.findById('notebook');
                        nb.activePage = 1;
                Button: 
                    text: '100%'
                    hints: {w: '3'}
                    id: 'zoomButton'
                    on_press:
                        const scroller = window.app.findById('scroller');
                        if(!scroller) return;
                        const zoom = Math.floor(scroller.zoom + 1);
                        scroller.zoom = zoom<4? zoom:0.5;
                        this.text = String(scroller.zoom*100)+'%';
            BoxLayout:
                bgColor: 'rgb(35,35,45)'
                orientation: 'horizontal'
                BoxLayout:
                    orientation: 'vertical'
                    hints: {w:'4'}
                    Label:
                        text:\`Randy \${Randy.gpos}\`
                        hints: {h:'1'}
                        sizeGroup: 'actionItems'
                        align: 'left'
                    SpriteWidget:
                        spriteSheet: resources['sprites']
                        frames: [354]
                        hints: {w:'3', h:'3'}
                    Label:
                        text:'1: Fire rifle'
                        hints: {h:'1'}
                        sizeGroup: 'actionItems'
                        align: 'left'
                    Action:
                        frames: [736]
                        labelText: 'Fire rifle'
                        spriteSheet: resources['sprites']
                        hints: {w:'3', h:'3'}
                    Label:
                        text:'2: Set C4'
                        hints: {h:'1'}
                        sizeGroup: 'actionItems'
                        align: 'left'
                    Action:
                        frames: [739]
                        labelText: 'Set C4'
                        spriteSheet: resources['sprites']
                        hints: {w:'3', h:'3'}
                    Label:
                        text:'3: Throw grenade'
                        hints: {h:'1'}
                        sizeGroup: 'actionItems'
                        align: 'left'
                    Action:
                        frames: [738]
                        labelText: 'Throw Grenade'
                        spriteSheet: resources['sprites']
                        hints: {w:'3', h:'3'}
                    Label:
                        text:'4: Use halligan'
                        hints: {h:'1'}
                        sizeGroup: 'actionItems'
                        align: 'left'
                    Action:
                        frames: [740]
                        labelText: 'Use Halligan'
                        spriteSheet: resources['sprites']
                        hints: {w:'3', h:'3'}
                    Widget:
                        id: 'padding2'
                BoxLayout:
                    hints: {w:'4', h:null}
                    padding: '2'
                    orientation: 'vertical'
                    Label:
                        text:'5: Fire phaser'
                        hints: {h:'1'}
                        sizeGroup: 'actionItems'
                        align: 'left'
                    Action:
                        frames: [737]
                        labelText: 'Fire phased'
                        spriteSheet: resources['sprites']
                        hints: {w:'3', h:'3'}
                    Label:
                        text:'6: Place endoscope'
                        hints: {h:'1'}
                        sizeGroup: 'actionItems'
                        align: 'left'
                    Action:
                        frames: [743]
                        labelText: 'Endoscope'
                        spriteSheet: resources['sprites']
                        hints: {w:'3', h:'3'}
                    Label:
                        text:'7: Use dusters'
                        hints: {h:'1'}
                        sizeGroup: 'actionItems'
                        align: 'left'
                    Action:
                        frames: [745]
                        labelText: 'Use knuckle dusters'
                        spriteSheet: resources['sprites']
                        sizeGroup: 'actionItems'
                        hints: {w:'3', h:'3'}
                    Label:
                        text:'8: Teleport'
                        hints: {h:'1'}
                        sizeGroup: 'actionItems'
                        align: 'left'
                    Action:
                        frames: [744]
                        labelText: 'Teleport'
                        spriteSheet: resources['sprites']
                        sizeGroup: 'actionItems'
                        hints: {w:'3', h:'3'}
                    Label:
                        text:\`Maria \${Maria.status}\`
                        wrap: true;
                        hints: {h:'1'}
                        sizeGroup: 'actionItems'
                        align: 'right'
                    SpriteWidget:
                        spriteSheet: resources['sprites']
                        frames: [450]
                        hints: {w:'3', h:'3'}
                    Widget:
                        id: 'padding2'
                ScrollView:
                    id: 'scroller'
                    uiZoom: false
                    hints: {h:'20'}
                    MissionMap:
                        id: 'MissionMap'
                        hints: {w:null, h:null}
                        spriteSheet: resources['sprites']
        BoxLayout:
            hints: {h:1, w:1}
            h:20
            w:20
            orientation:'vertical'
            bgColor: 'rgb(25,25,35)'
            id: 'help'
            paddingX: '1'
            paddingY: '1'
            helpVal: 0
            on_helpVal:
                this.parent._needsLayout=true;
                const helpHeader = window.app.findById('helpHeader');
                helpHeader.text = [
                    'Introduction',
                    'Agent Randy',
                    'Agent Maria',
                    'Director Stevens',
                    'Conrad Couli',
                    'Flint Ironsights',
                    'Mitch Crawford',
                    'Roland Kennedy',
                    'Irvina Schlitz',                            
                ][this.helpVal];
                const helpText = window.app.findById('helpText');
                helpText.text = [
                    'Intro: In the 22nd century, mankind has moved to the stars and conquered space. However, the realm of time is still one that has eluded them. Until now. Deep in the Unified Space Governments most classified labs, the beginnings of time looping technology are being created.'+ 
                    '\\n\\nHowever, such a powerful technology always attracts those who want to use it for evil. Thanks to an inside mole, a group of reckless idealists have managed to get their hands on this technology. This group wants to wield the tech on a global sale by selling it to the highest bidder in violation of arms control laws. They hope that this will be the final step needed to bring about the final revolution that will ultimately achieve a stable universal government and a world where history can finally, truly be rewritten.'+
                    '\\n\\nGiven the severity of the situation, the Unified Space Government has given two of their top agents a secret, limited, and local version of the time loop tech to provide an edge on missions so that they can stop the syndicate before its too late.',
                    'Player Character 1. A tanky close-combat specialist. He began his work as a soldier fighting on the frontlines of various conflicts. His combat skills, even during severe ammo shortages, were noticed by those around him and he rose through the ranks. His special training included close-quarters combat training and cybernetic augments that make him more resilient to damage.',
                    'Player Character 2. A stealthy ranged specialist. A former agent in the United Space Governments Intelligence division, she specialized in monitoring and, on occasion, eliminating targets with a minimum of fuss. She trained in the use of firearms and being able to move quickly yet silently.',
                    'The no-nonsense director of the player characters unit, who provides important details before each mission.',
                    'The head of one of the galaxys leading space travel companies, along with several companies that have gone bankrupt thanks to his leadership. His wealthy eccentricity, combined with an unhealthy interest in government-based conspiracy theories, has led him to offer financial assistance to the criminal conspiracy.',
                    'One of the galaxys most notorious dealers in military-grade and black market weapons. Often sells weapons to both sides in wars and may have helped stared a few.',
                    'A defector from the galaxys main government. Formerly a high-ranking agent, theyre believed to be the main suspect in leaking the time loop technology.',
                    'A moderate-ranking politician on a highly urbanized planet. He reached his current position by appealing to jingoists and is rumored to be linked to a few notorious hate groups. ',
                    'A scientist with an incredible curiosity and a severe lack of empathy and restraint. They have avoided the authorities as they performed immoral experiments in highly regulated fields. Getting to field test a technology as powerful as time looping would be the height of her career.',
                ][this.helpVal];
                const helpSprite = window.app.findById('helpSprite');
                helpSprite.frames = [
                    [0], [355], [451], [0], [832], [833],[0],[834],[835]
                ][this.helpVal];
            Label:
                id: 'helpHeader'
                hints: {h:'2'}
            SpriteWidget:
                id: 'helpSprite'
                spriteSheet: resources['sprites']
                hints: {w:'3', h:'3'}
            Label:
                id: 'helpText'
                fontSize: '0.5'
                wrap: true
                vAlign: 'top'
                hints: {h:null}
            BoxLayout:
                hints: {h:'1', w:'8'}
                orientation: 'horizontal'
                Button:
                    text: 'Next'
                    bgColor: 'rgb(15,15,25)'
                    on_press:
                        const help = window.app.findById('help');
                        help.helpVal = (help.helpVal+1)%9;
                Button:
                    text: 'Exit'
                    bgColor: 'rgb(15,15,25)'
                    on_press:
                        const nb = window.app.findById('notebook');
                        nb.activePage = 0;
                
`;class le extends U{_counter=0;_frames=0;_worst=300;_tref=Date.now();_badFrameCount=0;update(t,i){super.update(t,i);const e=Date.now();this._counter+=e-this._tref,this._frames+=1;const s=1e3/(e-this._tref);this._tref=e,this._badFrameCount+=s<50?1:0,s<this._worst&&(this._worst=s),this._counter>=1e3&&(this.text=`FPS: ${Math.round(this._frames/this._counter*1e3)} (worst: ${Math.round(this._worst)}, # >20ms: ${Math.round(this._badFrameCount)})`,this._counter=0,this._frames=0,this._worst=300,this._badFrameCount=0)}}class F extends p{constructor(t={}){super(),F.resources.sprites=new $t(re,16),this.continuousFrameUpdates=!0,window.focus(),this.canvas?.focus(),t&&this.updateProperties(t)}static get(){return p.get()}on_key_down(t,i,e){const s=this.inputHandler;if(s===void 0)return;const r=this.findById("MissionMap");if(r===null)return;const n=this.findById("Randy");if(n!==null){if(s.isKeyDown("w"))n.move(V.north,r);else if(s.isKeyDown("a"))n.move(V.west,r);else if(s.isKeyDown("s"))n.move(V.south,r);else if(s.isKeyDown("d"))n.move(V.east,r);else if(s.isKeyDown(" "))n.rest(r);else return;if(r.updateCharacterVisibility(),n.actionsThisTurn===0){for(let l of r.enemies)l.takeTurn(r);n.actionsThisTurn=2,r.updateCharacterVisibility(!0)}}}}F.registerClass("Action",_t,"Label");F.registerClass("FPS",le,"Label");F.registerClass("Game",F,"App");F.registerClass("MissionMap",se,"Widget");Wt(ne);F.get().start();
