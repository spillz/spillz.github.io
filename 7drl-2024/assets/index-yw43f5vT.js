(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function i(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function e(s){if(s.ep)return;s.ep=!0;const n=i(s);fetch(s.href,n)}})();class Mt{_seed=0;random(){return Math.random()}seed(t){}getRandomInt(t,i=0){return i!=0?t+Math.floor(this.random()*(i-t)):Math.floor(this.random()*t)}getRandomPos(t,i){return[this.getRandomInt(t),this.getRandomInt(i)]}randomRange(t=0,i=1){return Math.floor(this.random()*(i-t+1))+t}randomFloat(t=0,i=1){return this.random()*(i-t)+t}shuffle(t){let i,e;for(let s=1;s<t.length;s++)e=this.randomRange(0,s),i=t[s],t[s]=t[e],t[e]=i;return t}choose(t){return t[Math.floor(this.random()*t.length)]}chooseN(t,i){let e=new Array(i),s=t.length,n=new Array(s);if(i>s)throw new RangeError("chooeN: more elements requested than available");for(;i--;){let r=Math.floor(this.random()*s);e[i]=t[r in n?n[r]:r],n[r]=--s in n?n[s]:s}return e}}function ct(a,t,i,e){return function(){a>>>=0,t>>>=0,i>>>=0,e>>>=0;var s=a+t|0;return a=t^t>>>9,t=i+(i<<3)|0,i=i<<21|i>>>11,e=e+1|0,s=s+e|0,i=i+s|0,(s>>>0)/4294967296}}class mt extends Mt{_seed=1;d=3735928559;xorSeed=Math.floor(Date.now())^this.d;random=ct(2654435769,608135816,3084996962,this.xorSeed);seed(t){this._seed=t,this.xorSeed=t^this.d,this.random=ct(2654435769,608135816,3084996962,this.xorSeed)}}var yt=new mt;function Ct(a,t){return yt.getRandomPos(a,t)}function xt(a=0,t=1){return yt.randomFloat(a,t)}function j(a,t){return new y([a,t])}function Y(a){return new y(a)}class y extends Array{constructor(t=[0,0]){super(),this[0]=t[0],this[1]=t[1]}equals(t){return this.length===t.length&&this[0]===t[0]&&this[1]===t[1]}static random(t){return new y(Ct(t[0],t[1]))}add(t){return new y([this[0]+t[0],this[1]+t[1]])}sub(t){return new y([this[0]-t[0],this[1]-t[1]])}scale(t){return new y([this[0]*t,this[1]*t])}mul(t){return new y([this[0]*t[0],this[1]*t[1]])}div(t){return new y([this[0]/t[0],this[1]/t[1]])}dot(t){return this[0]*t[0]+this[1]*t[1]}dist(t){return Math.hypot(this[0]-t[0],this[1]-t[1])}abs(){return new y([Math.abs(this[0]),Math.abs(this[1])])}sum(){return this[0]+this[1]}relativeTo(t){return this.sub(t.pos).div(t.size)}absoluteFrom(t){return this.mul(t.size).add(t.pos)}relativeToPS(t,i){return this.sub(t).scale(1/i)}absoluteFromPS(t,i){return this.scale(i).add(t)}set x(t){this[0]=t}set y(t){this[1]=t}get x(){return this[0]}get y(){return this[1]}}class C extends Array{constructor(t=null){if(super(),t===null){this[0]=0,this[1]=0,this[2]=0,this[3]=0;return}this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3]}set x(t){this[0]=t}set y(t){this[1]=t}set w(t){this[2]=t}set h(t){this[3]=t}set pos(t){this[0]=t[0],this[1]=t[1]}set size(t){this[2]=t[2],this[3]=t[3]}get size(){return new y([this[2],this[3]])}get pos(){return new y([this[0],this[1]])}get x(){return this[0]}get y(){return this[1]}get w(){return this[2]}get h(){return this[3]}get right(){return this[0]+this[2]}get bottom(){return this[1]+this[3]}get center_x(){return this[0]+this[2]/2}get center_y(){return this[1]+this[3]/2}get center(){return new y([this.center_x,this.center_y])}grow(t){return new C([this[0]-t,this[1]-t,this[2]+2*t,this[3]+2*t])}get flooredCenter(){return new y([Math.floor(this[0]+this[2]/2),Math.floor(this[1]+this[3]/2)])}translate(t){return new C([this.x+t[0],this.y+t[1],this.w,this.h])}shrinkBorders(t){return new C([this.x+t,this.y+t,this.w-t*2,this.h-t*2])}scaleBorders(t){return new C([this.x+this.w*(1-t)/2,this.y+this.h*(1-t)/2,this.w*t,this.h*t])}mult(t){return new C([this[0]*t,this[1]*t,this[2]*t,this[3]*t])}multXY(t){return new C([this[0]*t[0],this[1]*t[1],this[2]*t[0],this[3]*t[1]])}scale(t,i=!0){if(i){let e=[this[2]*t,this[3]*t];return new C([this[0]+.5*(this[2]-e[0]),this[1]+.5*(this[3]-e[1]),e[0],e[1]])}else{let e=[this[2]*t,this[3]*t];return new C([this[0],this[1],e[0],e[1]])}}collideRadius(t,i=null){let e=[this.center_x-t.center_x,this.center_y-t.center_y];return i===null&&(i=Math.min(this.w,this.h,t.w,t.h)/2),e[0]*e[0]+e[1]*e[1]<i*i}collide(t){return this.x<t.x+t.w&&this.x+this.w>t.x&&this.y<t.y+t.h&&this.h+this.y>t.y}contains(t){return this.x<=t.x&&this.y<=t.y&&this.x+this.w>=t.x+t.w&&this.y+this.h>=t.y+t.h}contact(t){return this.x<=t.x+t.w&&this.x+this.w>=t.x&&this.y<=t.y+t.h&&this.h+this.y>=t.y}contactRadius(t,i=null){let e=[this.center_x-t.center_x,this.center_y-t.center_y];return i===null&&(i=Math.min(this.w,this.h,t.w,t.h)),e[0]*e[0]+e[1]*e[1]<=i*i}}class V extends Array{constructor(t=[0,0]){super(t[0]*t[1]),this.tileDim=new y(t),this.hidden=!1,this._cacheData=null}get(t){return this[t[0]+t[1]*this.tileDim[0]]}set(t,i){this[t[0]+t[1]*this.tileDim[0]]=i}*iterBetween(t,i,e=0){var s,n,r,l;if([s,n]=t,[r,l]=i,!(Math.abs(l-n)==0&&Math.abs(r-s)==0))if(Math.abs(l-n)>Math.abs(r-s)){var h=(r-s)/(l-n);if(n>l)for(var o=n;o>=l;o--){var u=s+(o-n)*h;yield[u,o]}else for(var o=n;o<=l;o++){var u=s+(o-n)*h;yield[u,o]}}else{var h=(l-n)/(r-s);if(s>r)for(var d=s;d>=r;d--){var c=n+(d-s)*h;yield[d,c]}else for(var d=s;d<=r;d++){var c=n+(d-s)*h;yield[d,c]}}}*iterInBetween(t,i){var e,s,n,r;if([e,s]=t,[n,r]=i,!(Math.abs(r-s)==0&&Math.abs(n-e)==0))if(Math.abs(r-s)>Math.abs(n-e)){var l=(n-e)/(r-s);if(s>r)for(var h=s-1;h>r;h--){var o=Math.round(e+(h-s)*l);yield[o,h]}else for(var h=s+1;h<r;h++){var o=Math.round(e+(h-s)*l);yield[o,h]}}else{var l=(r-s)/(n-e);if(e>n)for(var o=e-1;o>n;o--){var h=Math.round(s+(o-e)*l);yield[o,h]}else for(var o=e+1;o<n;o++){var h=Math.round(s+(o-e)*l);yield[o,h]}}}*iterTypesBetween(t,i,e){for(var s of this.iterBetween(t,i))e.includes(this.get(s))&&(yield s)}*iterTypesInBetween(t,i,e){for(var s of this.iterInBetween(t,i))e.includes(this.get(s))&&(yield s)}hasTypesBetween(t,i,e){for(var s of this.iterTypesBetween(t,i,e))return!0;return!1}hasTypesInBetween(t,i,e){for(var s of this.iterTypesInBetween(t,i,e))return!0;return!1}*iterAll(t=null){const[i,e]=this.tileDim;if(t!==null)for(var s=t[1];s<Math.min(e,t[1]+t[3]);s++)for(var n=t[0];n<Math.min(i,t[0]+t[2]);n++)yield[n,s];else for(var s=0;s<e;s++)for(var n=0;n<i;n++)yield[n,s]}*iterTypes(t,i){for(var e of this.iterAll(i))t.includes(this.get(e))&&(yield e)}*iterAdjacent(t){t=new y(t);for(let i of[[0,-1],[1,0],[0,1],[-1,0]]){const e=t.add(i);e[0]>=0&&e[0]<this.tileDim[0]&&e[1]>=0&&e[1]<this.tileDim[1]&&(yield e)}}hasAdjacent(t,i){for(let e of this.iterAdjacent(t))if(i.includes(this.get(t)))return!0;return!1}*iterInRange(t,i){var e,s;[e,s]=t;const[n,r]=this.tileDim;i==null&&(i=3);for(var l=Math.ceil(i),h=-l;h<l+1;h++)for(var o=-l;o<l+1;o++)if(o*o+h*h<=i*i){var u=e+o,d=s+h;0<=d&&d<r&&0<=u&&u<n&&(yield[u,d])}}*iterTypesInRange(t,i,e,s=null){for(var n of this.iterInRange(t,e))s!==null&&this.hasTypesBetween(t,n,s)||i.includes(this.get(n))&&(yield n)}numInRange(t,i,e,s=null){var n=0;for(var r of this.iterTypesInRange(t,i,e,s))n++;return n}*iterRectBoundary(t){const[i,e]=this.tileDim;let s=Math.min(Math.max(t.x,0),i),n=Math.min(Math.max(t.x+t.w,0),i),r=Math.min(Math.max(t.y,0),e),l=Math.min(Math.max(t.y+t.h,0),e);for(let h=s;h<n;h++)yield[h,r];for(let h=s;h<n;h++)yield[h,l];for(let h=r;h<l;h++)yield[s,h];for(let h=r;h<l;h++)yield[n,h]}*iterRect(t,i=!0){const[e,s]=this.tileDim;if(t instanceof C||(t=new C(t)),i&&(t.x<0||t.y<0||t.right>e||t.bottom>s))return;let n=Math.max(t.x,0),r=Math.min(t.x+t.w,e),l=Math.max(t.y,0),h=Math.min(t.y+t.h,s);for(let o=l;o<h;o++)for(let u=n;u<r;u++)yield[u,o]}numInRect(t,i,e=!0){let s=0;for(var n of this.iterRect(t,e))i.includes(this.get(n))&&s++;return s}}const P=8,N=48*(1/window.devicePixelRatio||1);function lt(a,t,i,e,s,n,r){let l=1;i<P&&(l=1/N,a.save(),a.scale(l,l)),a.fillStyle=r,a.font=(i>=P?i:Math.ceil(i/l))+"px "+e,n.x;let h=l*a.measureText(t).width;return i<P&&a.restore(),[h,2*i]}function ft(a,t,i,e,s,n,r,l){let h=1;i<P&&(h=1/N,a.save(),a.scale(h,h)),a.fillStyle=l,a.font=(i>=P?i:Math.ceil(i/h))+"px "+e;let o=r.x,u=a.measureText(t),d=r.y;switch(s){case"left":break;case"center":o+=(r.w-h*u.width)/2;break;case"right":o+=r.w-h*u.width;break}switch(n){case"top":break;case"middle":d+=r.h/2;break;case"bottom":d+=r.h;break}let f={outText:[[t,o/h,d/h]],color:l,fontName:e,size:i,valign:n};return i<P&&a.restore(),f}function Tt(a,t,i=null){let e=1,s=t.size;switch(i==null&&(i=t.color),s<P&&(e=1/N,a.save(),a.scale(e,e)),t.valign){case"top":a.textBaseline="top";break;case"middle":a.textBaseline="middle";break;case"bottom":a.textBaseline="bottom";break}a.fillStyle=i,a.font=(s>=P?s:Math.ceil(s/e))+"px "+t.fontName;let[n,r,l]=t.outText[0];a.fillText(n,r,l),s<P&&a.restore()}function at(a,t,i,e,s,n,r,l=!0){let h=1;i<P&&(h=1/N,a.save(),a.scale(h,h)),a.font=(i>=P?i:Math.ceil(i/h))+"px "+e;let o=0,u="",d=Math.min(Math.max(1,Math.ceil(t.length*n.w/a.measureText(t).width/h)),t.length);for(;t!=""||u!="";){if(u==""){let m=t.indexOf(`
`);m>=0?(u=t.slice(0,m),t=t.slice(m+1)):(u=t,t="")}let c=u.slice(0,d),f=h*a.measureText(c).width;if(f>n.w&&d>1)for(;f>n.w&&d>1;)d--,c=u.slice(0,d),f=h*a.measureText(c).width;if(f<n.w&&d<u.length){for(;f<n.w&&d<u.length;)d++,c=u.slice(0,d),f=h*a.measureText(c).width;d--}if(l&&c[-1]!=""&&u[d]!=" "&&u[d]!="	"){let m=Math.max(c.lastIndexOf(" "),c.lastIndexOf("	"));m>=0&&(d-=c.length-m-1)}d=Math.max(1,d),c=u.slice(0,d),u=u.slice(d),l&&(u=u.trimStart()),o+=i}return o+=i,i<P&&a.restore(),[n.w,o]}function pt(a,t,i,e,s,n,r,l,h=!0){let o=1;i<P&&(o=1/N,a.save(),a.scale(o,o)),a.fillStyle=l,a.font=(i>=P?i:Math.ceil(i/o))+"px "+e;let u=r.y,d=[],c="",f=Math.min(Math.max(1,Math.ceil(t.length*(r.w/a.measureText(t).width)/o)),t.length);for(;t!=""||c!="";){if(c==""){let M=t.indexOf(`
`);M>=0?(c=t.slice(0,M),t=t.slice(M+1)):(c=t,t="")}let L=r.x,w=c.slice(0,f),b=o*a.measureText(w).width;if(b>r.w&&f>1)for(;b>r.w&&f>1;)f--,w=c.slice(0,f),b=o*a.measureText(w).width;if(b<r.w&&f<c.length){for(;b<r.w&&f<c.length;)f++,w=c.slice(0,f),b=o*a.measureText(w).width;f--}if(h&&f<c.length&&w[-1]!=""&&c[f]!=" "&&c[f]!="	"){let M=Math.max(w.lastIndexOf(" "),w.lastIndexOf("	"));M>=0&&(f-=w.length-M-1)}switch(f=Math.max(1,f),w=c.slice(0,f),c=c.slice(f),h&&(c=c.trimStart()),b=o*a.measureText(w).width,s){case"left":break;case"center":L+=(r.w-b)/2;break;case"right":L+=r.w-b;break}d.push([w,L/o,u/o]),u+=i}let m=u-r.y,T=0;switch(n){case"top":T=0;break;case"middle":T=(r.h-m)/2+i/2;break;case"bottom":T=r.h-m+i}let k={size:i,fontName:e,outText:d,off:T/o,color:l,valign:n};return i<P&&a.restore(),k}function Dt(a,t,i=null){let e=1,s=t.size;switch(i===null&&(i=t.color),s<P&&(e=1/N,a.save(),a.scale(e,e)),t.valign){case"top":a.textBaseline="top";break;case"middle":a.textBaseline="middle";break;case"bottom":a.textBaseline="bottom";break}a.fillStyle=i,a.font=(s>=P?s:Math.ceil(s/e))+"px "+t.fontName;for(let n of t.outText)a.fillText(n[0],n[1],n[2]+(t.off??0));s<P&&a.restore()}const et=(a,t,i)=>Math.min(Math.max(a,t),i);function kt(a,t){return new y(a).dist(t)}function x(a){let t,i,e;return[t,i,e]=new O(a).scale(255).map(s=>Math.floor(s)),"#"+t.toString(16).padStart(2,"0")+i.toString(16).padStart(2,"0")+e.toString(16).padStart(2,"0")}class O extends Array{constructor(...t){t.length==1&&t[0]instanceof Array?super(...t[0]):super(...t)}static asRandomFloats(t,i=0,e=1){let s=new O(t);for(let n=0;n<s.length;n++)s[n]=xt(i,e);return s}sum(){let t=0;return this.forEach(i=>t+=i),t}mean(){return this.sum()/this.length}max(){return Math.max.apply(null,this)}min(){return Math.min.apply(null,this)}vars(){let t=0;return this.forEach(i=>t+=i*i),(t-this.length*this.mean()^2)/(this.length-1)}var(){let t=0;return this.forEach(i=>t+=i*i),t/this.length-this.mean()^2}std(){return Math.sqrt(this.var())}add(t){let i=new O(this);if(t instanceof Array)for(let e=0;e<this.length;e++)i[e]+=t[e];else for(let e=0;e<this.length;e++)i[e]+=t;return i}mul(t){let i=new O(this);if(t instanceof Array)for(let e=0;e<this.length;e++)i[e]*=t[e];else for(let e=0;e<this.length;e++)i[e]*=t;return i}scale(t){const i=Array();for(let e of this)i.push(e*t);return i}dot(t){return this.mul(t).sum()}abs(){return Math.abs.apply(null,this)}lag(t){let i=new O;for(let e=-t;e<this.length-t;e++)e<0||e>=this.length?i.push(NaN):i.push(this[e]);return i}filter(t){return new O(super.filter(t))}dropNaN(){return this.filter(t=>!Number.isNaN(t))}}class B{identifier=-1;pos=[0,0];state="touch_up";device="touch";nativeObject=null;nativeEvent=null;constructor(t={}){for(let i in t)this[i]=t[i]}copy(){return new B({pos:[...this.pos],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}asChildTouch(t){return new B({pos:[...t.toChild(this.pos)],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}get rect(){return new C([...this.pos,0,0])}set x(t){this.pos[0]=t}set y(t){this.pos[1]=t}get x(){return this.pos[0]}get y(){return this.pos[1]}get grabbed(){return p.get().inputHandler.grabbed}grab(t){p.get().inputHandler.grab(t)}ungrab(){p.get().inputHandler.ungrab()}}class Pt{grabbed=null;mouseTouchEmulation=!0;mouseev=null;keyStates={};constructor(t){this.app=t,this.canvas=t.canvas;let i=this.canvas,e=this;document.addEventListener("keydown",function(s){e.process_key(s,"key_down")},!0),document.addEventListener("keyup",function(s){e.process_key(s,"key_up")},!0),i.addEventListener("mousedown",function(s){e.process_mouse(s,"mouse_down")},!0),i.addEventListener("mousemove",function(s){e.process_mouse(s,"mouse_move")},!0),i.addEventListener("mouseout",function(s){e.process_mouse(s,"mouse_cancel")},!0),i.addEventListener("mouseup",function(s){e.process_mouse(s,"mouse_up")},!0),i.addEventListener("touchstart",function(s){e.process_touch(s,"touch_down")},!1),i.addEventListener("touchmove",function(s){e.process_touch(s,"touch_move")},!1),i.addEventListener("touchcancel",function(s){e.process_touch(s,"touch_cancel")},!1),i.addEventListener("touchend",function(s){e.process_touch(s,"touch_up")},!1),i.addEventListener("wheel",function(s){e.process_wheel(s,"wheel")},!0),window.history.replaceState(null,document.title,location.pathname+"#!/backbutton"),window.history.pushState(null,document.title,location.pathname),window.addEventListener("popstate",function(s){e.process_back(s,"back_button")},!1)}grab(t){this.grabbed=t}ungrab(){this.grabbed=null}isKeyUp(t){return t in this.keyStates&&this.keyStates[t]}isKeyDown(t){return t in this.keyStates&&this.keyStates[t]}process_key(t,i){this.app.requestFrameUpdate();const e=this.keyStates[t.key];i==="key_up"?this.keyStates[t.key]=!1:i==="key_down"&&(this.keyStates[t.key]=!0),this.app.emit(i,{states:this.keyStates,oldState:e,event:t})}process_touch(t,i){if(this.app.requestFrameUpdate(),this.grabbed!==null)for(let e of t.changedTouches){let s=this.grabbed.appToChild([e.clientX,e.clientY]),n=new B({pos:s,state:i,nativeObject:e,nativeEvent:t,identifier:e.identifier});this.grabbed.emit(i,n)}else for(let e of t.changedTouches){let s=new B({pos:this.app.toChild([e.clientX,e.clientY]),state:i,nativeObject:e,nativeEvent:t,identifier:e.identifier});this.app.childEmit(i,s,!0)}t.preventDefault()}process_back(t,i){location.hash==="#!/backbutton"&&(history.replaceState(null,document.title,location.pathname),this.app.childEmit("back_button",t))}process_mouse(t,i){if(this.app.requestFrameUpdate(),this.mouseev=t,t.preventDefault(),this.mouseTouchEmulation){let e={mouse_up:"touch_up",mouse_down:"touch_down",mouse_move:"touch_move",mouse_cancel:"touch_cancel"};if(t.buttons!==1&&i!=="mouse_up")return;if(this.grabbed!==null){let s=[t.clientX,t.clientY],n=this.grabbed.appToChild(s),r=new B({pos:n,state:e[i],nativeObject:t,identifier:-1});this.grabbed.emit(e[i],r)}else{let s=new B({pos:this.app.toChild([t.clientX,t.clientY]),state:e[i],nativeObject:t,identifier:-1});this.app.childEmit(e[i],s,!0)}}else this.grabbed!==null?this.grabbed.emit(i,t):this.app.childEmit(i,t,!0)}process_wheel(t,i){if(this.mouseev!=null){if(this.app.requestFrameUpdate(),this.grabbed!=null){let e=this.grabbed.appToChild([this.mouseev.clientX,this.mouseev.clientY]),s=new B({pos:e,state:i,nativeObject:t});return this.grabbed.emit(i,s)}else{let e=new B({pos:this.app.toChild([this.mouseev.clientX,this.mouseev.clientY]),state:i,nativeObject:t});this.app.childEmit(i,e,!0)}t.preventDefault()}}vibrate(t,i,e){window.navigator.vibrate(e)}}function Lt(a,t,i,e){if(typeof t=="string"||t instanceof String){if(a.startsWith("on_"))return new Function("resources","parent","root",`return function(event, object, value) {${t}}`).bind(i)(p.resources,i.parent,e);if(t.trim().startsWith("(")&&t.indexOf("=>")<t.indexOf(`
`)){const o=new Function("resources","parent","root",`return ${t}`).bind(i)(p.resources,i.parent,e);return o.markupMethod=!0,o}const s=new Set;let n=0;if(t[0]!=="'"&&t[0]!=='"')for(let o of t.matchAll(/(?!\.)\b([a-z]\w*)\.([a-z_]\w*)\b/ig)){const u=o[1];u!=="this"&&u!=="parent"&&u!=="root"&&s.add(u),n++}if(n===0)return new Function("resources",`return ${t};`)(p.resources);const r=[...s].join(", "),l=`return function (${r}) { return ${t} }`,h=new Function("resources","parent","root",l)(p.resources,i.parent,e).bind(i);return h.text=`(${r}) => ${t}`,h}return t}function It(a,t,i){t in a?a[t].push(i):a[t]=[i]}function zt(a,t){const i=a.indexOf(t);if(i===-1)return[a,""];const e=a.substring(0,i),s=a.substring(i+1);return[e,s]}function Wt(a,t,i){const e=i;let s=a[t];for(i=0;s[i]===" "&&i<s.length;i++);if(i<=e)throw Error(`Syntax error: invalid declaration on ${t}
${a[t-1]}
Declared object is neither a known class nor a valid property declaration`);let n=s;for(t++;i>e&&t<a.length;){for(s=a[t],i=0;s[i]===" "&&i<s.length;i++);i>e&&(n+=`
`+s,t++)}return[n,t,i]}function Q(a,t,i,e,s){const n=e;let r=a[i];for(e=0;r[e]===" "&&e<r.length;e++);if(e<=n)return[i,e];const l=e;for(;;){if(i>=a.length)return[i,e];if(r=a[i],r.trim()===""||r.trim().startsWith("#")||r.trim().startsWith("//")){i++;continue}for(e=0;r[e]===" "&&e<r.length;e++);if(e>l)throw Error(`Syntax error on line ${i+1}
${r}`);if(e<l)return[i,e];if(r.includes(":"))if(r=r.trim(),r.endsWith(":")){const h=r.slice(0,r.length-1);if(h in p.classes){const o={cls:h};[i,e]=Q(a,t,i+1,e,o),It(s,"children",o)}else{let o;[o,i,e]=Wt(a,i+1,e),s[h]=o}}else{const[h,o]=zt(r,":").map(u=>u.trim());s[h]=o,i++}else throw Error(`Syntax error on line ${i+1}
${r}`)}}function ut(a,t,i){const e={},s=a.constructor.name,r={...p.rules.get(s),...t};for(let l in r){const h=r[l];if(l==="children"&&h instanceof Array){const o=[];for(let u of h)if(u instanceof Object&&"cls"in u){const[d,c]=p.classes[u.cls],f=new d;ut(f,u,i),o.push(f)}else throw Error(`Unknown child class ${u} on clsName ${s}`);a instanceof p?a.baseWidget.children=o:a.children=o}else if(l!=="cls")try{e[l]=Lt(l,h,a,i)}catch{e[l]=h}}a.updateProperties(e,!1)}function At(a,t){return{[a]:class extends t{}}[a]}function Ht(a){const t=a.split(`
`),i=[];let e=0,s=0,n=0;for(;n<t.length;){let r=t[n];if(r.trim()===""||r.trim().startsWith("#")||r.trim().startsWith("//")){n++;continue}for(s=0;s<r.length&&r[s]===" ";++s);if(s!==e)throw Error(`Indentation error -- level ${s} used when ${e} expected on line # ${n+1}.
`+r);if(r=r.trim(),r.endsWith(":")){const l=r.replace(":","");if(r.startsWith("<")&&r.includes("@")){const[h,o]=l.slice(1,-1).split("@"),u=At(h,p.classes[o][0]),d={};[n,s]=Q(t,h,n+1,s,d),p.classes[h]=[u,o],p.rules.add(h,d)}else if(r.startsWith("<")){const h=l.slice(1,-1).split(",").map(o=>o.trim());for(let o of h){const[u,d]=p.classes[o],c=p.rules.get(o);[n,s]=Q(t,u,n+1,s,c),p.rules.add(o,c)}}else{const h=new p.classes[l][0],o={};[n,s]=Q(t,l,n+1,s,o),ut(h,o,h),i.push(h)}}else throw Error(`Syntax error: Invalid declation on ${n}
${r}`)}return i}class Bt{constructor(t,i=0,e=null){this.elapsed=0,this.timer=t,this.triggered=!1,this.callback=e,i>0&&this.tick(i)}finished(){return this.elapsed>=this.timer}tick(t){return this.elapsed>=this.timer?(this.triggered&&(this.triggered=!1),!1):(this.elapsed+=t,this.elapsed>=this.timer?(this.callback!=null&&this.callback("timer",this),this.triggered=!0,!0):!1)}reset(t=-1,i=0){this.triggered=!1,t>=0&&(this.timer=t),i>0&&this.tick(i)}}class jt{update(t,i){}}class Ft{constructor(){this.rules=new Map}add(t,i,e=!0){let s=this.rules.get(t);if(s&&!e)for(let n in s)s[n]=i[n];else this.rules.set(t,i)}get(t){return this.rules.get(t)??{}}remove(t){return this.rules.delete(t)}}class Yt{constructor(t,i,e){this.listener=t,this.event=i,this.callback=e}}class Rt{constructor(){this.connections=new Map}bind(t,i,e,s){let n=new Yt(t,e,s),r=this.connections.get(i);r?r.add(n):this.connections.set(i,new Set([n]))}emit(t,i,e){const s=this.connections.get(t);if(!s)return!1;for(let n of s)if(n.event===i&&n.callback(i,t,e))return!0;return!1}disconnect(t){this.connections.delete(t);for(let i of this.connections.keys()){const e=[],s=this.connections.get(i);if(s){for(let n of s)n.listener===t&&e.push(n);e.forEach(n=>s.delete(n))}}}}class gt{stack=[];widget=null;props={};elapsed=0;add(t,i=1e3){this.stack.push([t,i])}update(t,i){if(this.widget===null)return;let e=this.stack[0][0],s=this.stack[0][1];if(this.elapsed==0){this.initProps={};for(let l in e)this.initProps[l]=this.widget[l]}let n=this.elapsed+i-s;this.elapsed=n<0?this.elapsed+i:s;let r=s==0?1:this.elapsed/s;if(n<0)for(let l in this.initProps){let h=e[l];typeof h=="number"&&(this.widget[l]=(1-r)*this.initProps[l]+r*h)}else{for(let l in this.initProps){let h=e[l];typeof h=="number"&&(this.widget[l]=h)}if(this.stack=this.stack.slice(1),this.elapsed=n,this.stack.length==0)this.cancel();else{this.initProps={};for(let l in this.stack[0][0])this.initProps[l]=this.widget[l]}}}start(t){this.widget=t,t._animation=this}cancel(){this.widget!==null&&(this.widget._animation=null,this.widget.emit("animationComplete",this))}}class z extends C{bgColor=null;outlineColor=null;_animation=null;_layoutNotify=!1;hints={};constructor(t=null){return super(),this.parent=null,this._processTouches=!1,this._deferredProps=null,this._children=[],this._needsLayout=!0,t!=null&&this.updateProperties(t),new Proxy(this,{set(i,e,s,n){return typeof e=="string"&&(["x","y","w","h","children","rect"].includes(e)||e[0]=="_")?Reflect.set(i,e,s,n):(Reflect.set(i,e,s,n),typeof e=="string"&&Reflect.apply(i.emit,n,[e,s]),!0)}})}set rect(t){this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this._needsLayout=!0}get rect(){return new C([this[0],this[1],this[2],this[3]])}deferredProperties(t){let i=this._deferredProps;this._deferredProps=null;for(let e in i)if(!e.startsWith("on_")&&!e.startsWith("_")&&typeof i[e]=="function"){let s=i[e],n,r;[n,r]=(s.text??s.toString()).split("=>"),n=n.replace("(","").replace(")","").split(",").map(u=>u.trim());let l=n.map(u=>t.findById(u)),h={};for(let u of n)h[u]=t.findById(u);const o=/(\w+)\.(\w+)/g;for(let u of r.matchAll(o)){let d,c;if([c,d]=u.slice(1),c==="this")this.bind(d,(f,m,T)=>{try{this[e]=s(...l)}catch(k){console.log("Dynamic binding error",this,e,k)}});else if(c in h)try{h[c].bind(d,(f,m,T)=>{try{this[e]=s(...l)}catch(k){console.log("Dynamic binding error",this,e,k)}})}catch(f){console.log(`Warning: ${c} cannot be bound on`,this,`
property`,e,`
error`,f)}}try{this[e]=s(...l)}catch(u){console.log("Dynamic binding error",this,e,u)}}}updateProperties(t,i=!0){i&&ut(this,{},this);for(let e in t)!e.startsWith("on_")&&!e.startsWith("_")&&typeof t[e]=="function"&&!("markupMethod"in t[e])?this._deferredProps=t:this[e]=t[e]}bind(t,i,e=null){p.get()._eventManager.bind(e,this,t,i)}emit(t,i){return"on_"+t in this&&this["on_"+t](t,this,i)?!0:p.get()._eventManager.emit(this,t,i)}*iter(t=!0,i=!0){if(yield this,!!t)for(let e of this._children)yield*e.iter(...arguments)}*iterParents(){this.parent!==null&&(yield this.parent,this.parent!=p.get()&&(yield*this.parent.iterParents()))}findById(t){for(let i of this.iter(!0,!1))if("id"in i&&i.id==t)return i;return null}*iterByPropertyValue(t,i){for(let e of this.iter(!0,!1))t in e&&e[t]==i&&(yield e)}getTransformRecurse(t=!1,i=null){let e=this!==i&&this.parent!==null?this.parent.getTransformRecurse(!0,i):new DOMMatrix;if(!t)return e;let s=this.getTransform();return s?e.multiply(s):e}getTransform(){return null}applyTransform(t,i=!1,e=!1,s=!1,n=null){let r=e?this.getTransformRecurse(s,n):this.getTransform();if(!r)return t;i&&(r=r.inverse());let l=r.transformPoint(new DOMPoint(t.x,t.y));return new y([l.x,l.y])}appToWidget(t,i=!0){if(this.parent){let e=this.parent.getTransformRecurse().inverse().transformPoint(new DOMPoint(t[0],t[1]));return new y([e.x,e.y])}return t}appToChild(t,i=!0){let e=this.getTransformRecurse().inverse().transformPoint(new DOMPoint(t[0],t[1]));return new y([e.x,e.y])}toChild(t){let i=this.getTransform();if(!i)return t;let e=i.inverse().transformPoint(new DOMPoint(t[0],t[1]));return new y([e.x,e.y])}addChild(t,i=-1){i==-1?this._children.push(t):this._children=[...this._children.slice(0,i),t,...this._children.slice(i)],this.emit("child_added",t),t.parent=this,this._needsLayout=!0}removeChild(t,i=!0){this._children=this.children.filter(e=>e!=t),i&&p.get()._eventManager.disconnect(t),this.emit("child_removed",t),t.parent=null,this._needsLayout=!0}get children(){return this._children}set children(t){for(let i of this._children)this.emit("child_removed",i),i.parent=null,this._needsLayout=!0;this._children=[];for(let i of t)this.addChild(i)}set x(t){this._needsLayout=!0,this[0]=t}set center_x(t){this._needsLayout=!0,this[0]=t-this[2]/2}set right(t){this._needsLayout=!0,this[0]=t-this[2]}set y(t){this._needsLayout=!0,this[1]=t}set center_y(t){this._needsLayout=!0,this[1]=t-this[3]/2}set bottom(t){this._needsLayout=!0,this[1]=t-this[3]}set w(t){this._needsLayout=!0,this[2]=t}set h(t){this._needsLayout=!0,this[3]=t}get x(){return this[0]}get center_x(){return this[0]+this[2]/2}get right(){return this[0]+this[2]}get y(){return this[1]}get center_y(){return this[1]+this[3]/2}get bottom(){return this[1]+this[3]}get w(){return this[2]}get h(){return this[3]}on_wheel(t,i,e){for(let s=this._children.length-1;s>=0;s--)if(this._children[s].emit(t,e))return!0;return!1}on_touch_down(t,i,e){let s=this.getTransform();if(s){let n=e.copy(),r=s.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[r.x,r.y];for(let l=this._children.length-1;l>=0;l--)if(this._children[l].emit(t,n))return!0}else for(let n=this._children.length-1;n>=0;n--)if(this._children[n].emit(t,e))return!0;return!1}on_touch_up(t,i,e){let s=this.getTransform();if(s){let n=e.copy(),r=s.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[r.x,r.y];for(let l=this._children.length-1;l>=0;l--)if(this._children[l].emit(t,n))return!0}else for(let n=this._children.length-1;n>=0;n--)if(this._children[n].emit(t,e))return!0;return!1}on_touch_move(t,i,e){let s=this.getTransform();if(s){let n=e.copy(),r=s.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[r.x,r.y];for(let l=this._children.length-1;l>=0;l--)if(this._children[l].emit(t,n))return!0}else for(let n=this._children.length-1;n>=0;n--)if(this._children[n].emit(t,e))return!0;return!1}on_touch_cancel(t,i,e){let s=this.getTransform();if(s){let n=e.copy(),r=s.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[r.x,r.y];for(let l=this._children.length-1;l>=0;l--)if(this._children[l].emit(t,n))return!0}else for(let n=this._children.length-1;n>=0;n--)if(this._children[n].emit(t,e))return!0;return!1}on_back_button(t,i,e){return!1}getMetric(t,i,e,s=null,n=null){let r=p.get();if(e===null)return t[i];let l=0,h="relative";for(s=s??this.w,n=n??this.h;;){if(e.constructor==String){let o=e.slice(-2);if(o=="ww"){l=+e.slice(0,-2)*t.w;break}if(o=="wh"){l=+e.slice(0,-2)*t.h;break}if(o=="aw"){l=+e.slice(0,-2)*r.dimW,h="absolute";break}if(o=="ah"){l=+e.slice(0,-2)*r.dimH,h="absolute";break}let u=e.slice(-1);if(u=="w"){l=+e.slice(0,-1)*s;break}if(u=="h"){l=+e.slice(0,-1)*n;break}l=+e;break}if(i=="w"||i=="x"||i=="center_x"||i=="right"){l=+e;break}l=+e;break}return h=="relative"&&(["x","center_x","right"].includes(i)&&(l+=this.x),["y","center_y","bottom"].includes(i)&&(l+=this.y)),l}applyHintMetric(t,i,e,s=null,n=null){let r=p.get();if(e===null)return;let l=0,h="relative";for(s=s??this.w,n=n??this.h;;){if(e.constructor==String){let o=e.slice(-2);if(o=="ww"){l=+e.slice(0,-2)*t.w;break}if(o=="wh"){l=+e.slice(0,-2)*t.h;break}if(o=="aw"){l=+e.slice(0,-2)*r.dimW,h="absolute";break}if(o=="ah"){l=+e.slice(0,-2)*r.dimH,h="absolute";break}let u=e.slice(-1);if(u=="w"){l=+e.slice(0,-1)*s;break}if(u=="h"){l=+e.slice(0,-1)*n;break}l=+e;break}if(i=="w"||i=="x"||i=="center_x"||i=="right"){l=+e*s;break}l=+e*n;break}h=="relative"&&(["x","center_x","right"].includes(i)&&(l+=this.x),["y","center_y","bottom"].includes(i)&&(l+=this.y)),t[i]=l}applyHints(t,i=null,e=null){let s=t.hints;i=i??this.w,e=e??this.h,"w"in s&&s.w!=null&&s.w.constructor==String&&s.w.slice(-2)=="wh"?(s.h!==void 0&&this.applyHintMetric(t,"h",s.h,i,e),s.w!==void 0&&this.applyHintMetric(t,"w",s.w,i,e)):(s.w!==void 0&&this.applyHintMetric(t,"w",s.w,i,e),s.h!==void 0&&this.applyHintMetric(t,"h",s.h,i,e));for(let n in s)n!="w"&&n!="h"&&this.applyHintMetric(t,n,s[n],i,e)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;for(let t of this.children)this.applyHints(t),t.layoutChildren()}_draw(t,i,e){this.draw(t,i);let s=this.getTransform();if(s){i.save(),i.transform(s.a,s.b,s.c,s.d,s.e,s.f);for(let n of this._children)n._draw(t,i,e);i.restore();return}for(let n of this._children)n._draw(t,i,e)}draw(t,i){let e=this.rect;if(i.beginPath(),i.rect(e[0],e[1],e[2],e[3]),this.bgColor!=null&&(i.fillStyle=this.bgColor,i.fill()),this.outlineColor!=null){let s=i.lineWidth;i.lineWidth=1/t.tileSize,i.strokeStyle=this.outlineColor,i.stroke(),i.lineWidth=s}}update(t,i){this._deferredProps!=null&&this.deferredProperties(t),this._animation!=null&&(this._animation.update(t,i),t.requestFrameUpdate()),this._needsLayout&&(this.layoutChildren(),t.requestFrameUpdate());for(let e of this._children)e.update(t,i)}}class p extends z{static appInstance=null;static rules=new Ft;static resources=new Map;static classes={};static registerClass(t,i,e){p.classes[t]=[i,e]}constructor(t=null){if(p.appInstance!=null)return p.appInstance;super(),p.appInstance=this,window.app=this,this._eventManager=new Rt,this.id="app",this.w=-1,this.h=-1,this._baseWidget=new z({hints:{x:0,y:0,w:1,h:1}}),this._baseWidget.parent=this,this._modalWidgets=[],this._udpateActive=!0,this.pixelSize=1,this.integerTileSize=!1,this.exactDimensions=!1,this.prefDimW=32,this.prefDimH=16,this.dimW=this.prefDimW,this.dimH=this.prefDimH,this.tileSize=this.getTileScale()*this.pixelSize,this.canvasName="canvas",this.canvas=null,this.offsetX=0,this.offsetY=0,this.shakeX=0,this.shakeY=0,this.shakeAmount=0,this.timer_tick=null,this.timers=[],this.continuousFrameUpdates=!1,this._requestedFrameUpdate=!1,t&&this.updateProperties(t)}get baseWidget(){return this._baseWidget}addTimer(t,i){let e=new Bt(t,0,i);return this.timers.push(e),e}removeTimer(t){this.timers=this.timers.filter(i=>i!=t)}addModal(t){this._modalWidgets.push(t),this._needsLayout=!0}removeModal(t){this._modalWidgets=this._modalWidgets.filter(i=>i!=t)}static get(){return p.appInstance||(p.appInstance=new p),p.appInstance}start(){let t=this;this.setupCanvas(),this.inputHandler=new Pt(this),window.onresize=()=>t.updateWindowSize(),this.updateWindowSize(),window.onload=()=>this._start()}_start(){this.update()}childEmit(t,i,e=!1){if(e&&this._modalWidgets.length>0)return this._modalWidgets[this._modalWidgets.length-1].emit(t,i);if(this._baseWidget.emit(t,i))return!0;for(let s of this._modalWidgets)if(s.emit(t,i))return!0;return!1}*iter(t=!0,i=!0){yield this,yield*this._baseWidget.iter(...arguments);for(let e of this._modalWidgets)yield*e.iter(...arguments)}findById(t){for(let i of this.iter(!0,!1))if("id"in i&&i.id==t)return i;return null}*iterByPropertyValue(t,i){for(let e of this.iter(!0,!1))t in e&&e[t]===i&&(yield e)}update(){this._udpateActive=!0,this._requestedFrameUpdate=!1;let t=15,i=Date.now();this.timer_tick!=null&&(t=Math.min(i-this.timer_tick,30)),(this.timers.length>0||this._needsLayout)&&this.requestFrameUpdate();for(let e of this.timers)e.tick(t);this._needsLayout&&this.layoutChildren();for(let e of p.resources.values())e.update(this,t);this._baseWidget.update(this,t);for(let e of this._modalWidgets)e.update(this,t);this.ctx&&this._draw(this,this.ctx,t),this.continuousFrameUpdates&&this.requestFrameUpdate(),this.timer_tick=i,this._requestedFrameUpdate&&window.requestAnimationFrame(()=>this.update()),this._udpateActive=!1}requestFrameUpdate(){this._requestedFrameUpdate||(this._udpateActive?this._requestedFrameUpdate=!0:window.requestAnimationFrame(()=>this.update()))}_draw(t,i,e){if(!this.canvas)return;i.clearRect(0,0,this.canvas.width,this.canvas.height),this.shakeX=0,this.shakeY=0,this.screenShake(),i.save();let s=this.getTransform();s&&i.transform(s.a,s.b,s.c,s.d,s.e,s.f),this._baseWidget._draw(t,i,e);for(let n of this._modalWidgets)n._draw(t,i,e);i.restore()}getTransform(t=!0){return new DOMMatrix().translate(this.offsetX+this.shakeX,this.offsetY+this.shakeY).scale(this.tileSize,this.tileSize)}on_prefDimW(t,i,e){this.updateWindowSize()}on_prefDimH(t,i,e){this.updateWindowSize()}on_tileSize(t,i,e){this.prefDimH<0&&this.prefDimW<0&&this.updateWindowSize()}updateWindowSize(){this.x=0,this.y=0,this.w=window.innerWidth,this.h=window.innerHeight,this.prefDimH>=0&&this.prefDimW>=0&&(this.tileSize=this.getTileScale()),this.fitDimensionsToTileSize(this.tileSize),this.setupCanvas();try{screen.orientation.unlock()}catch{}this._needsLayout=!0,this.requestFrameUpdate()}getTileScale(){let t=this.h,i=this.w,e=1/this.pixelSize;return this.prefDimW<0&&this.prefDimH<0?this.tileSize>0&&(e=this.tileSize/this.pixelSize):this.prefDimW<0?e=t/this.prefDimH/this.pixelSize:this.prefDimH<0?e=i/this.prefDimW/this.pixelSize:e=Math.min(t/this.prefDimH/this.pixelSize,i/this.prefDimW/this.pixelSize),this.integerTileSize&&e>1&&(e=Math.floor(e)),e*this.pixelSize}fitDimensionsToTileSize(t){let i=this.h,e=this.w;if(this.exactDimensions){this.prefDimW<0&&this.prefDimH<0?(this.dimW=e/this.tileSize,this.dimH=i/this.tileSize):this.prefDimH<0?(this.dimW=this.prefDimW,this.dimH=i/this.tileSize):this.prefDimW<0?(this.dimW=e/this.tileSize,this.dimH=this.prefDimH):(this.dimH=this.prefDimH,this.dimW=this.prefDimW);return}this.dimH=Math.floor(i/t),this.dimW=Math.floor(e/t)}setupCanvas(){this.canvas=document.querySelector(this.canvasName),this.canvas&&(this.canvas.width=this.w,this.canvas.height=this.h,this.ctx=this.canvas.getContext("2d"),this.ctx&&(this.ctx.imageSmoothingEnabled=!1,this.offsetX=Math.floor((this.w-this.tileSize*this.dimW)/2),this.offsetY=Math.floor((this.h-this.tileSize*this.dimH)/2)))}applyHints(t){super.applyHints(t,this.dimW,this.dimH)}screenShake(){this.shakeAmount&&this.shakeAmount--;let t=Math.random()*Math.PI*2;this.shakeX=Math.round(Math.cos(t)*this.shakeAmount),this.shakeY=Math.round(Math.sin(t)*this.shakeAmount)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.applyHints(this._baseWidget),this._baseWidget.layoutChildren();for(let t of this._modalWidgets)this.applyHints(t),t.layoutChildren()}}class G extends z{fontSize=null;sizeGroup="";clip=!1;ignoreSizeForGroup=!1;fontName='"Nimbus Mono PS", "Courier New", monospace';text="";wrap=!1;wrapAtWord=!0;align="center";valign="middle";color="white";constructor(t=null){super(),this._textData=null,t!==null&&this.updateProperties(t)}on_align(t,i,e){this._needsLayout=!0}on_valign(t,i,e){this._needsLayout=!0}on_wrap(t,i,e){this._needsLayout=!0}on_wrapAtWord(t,i,e){this._needsLayout=!0}on_text(t,i,e){this._needsLayout=!0}on_fontSize(t,i,e){this._needsLayout=!0}on_fontName(t,i,e){this._needsLayout=!0}layoutChildren(){let i=p.get().ctx;if(!i)return;let e=this.fontSize===null?null:this.getMetric(this,"fontSize",this.fontSize);if("h"in this.hints&&this.hints.h==null&&e!==null&&(this[3]=this.wrap?at(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[1]:lt(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color)[1]),"w"in this.hints&&this.hints.w==null&&e!==null&&(this[2]=this.wrap?at(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[0]:lt(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color)[0]),e=e===null?this.h/2:e,this.fontSize===null&&this.rect.w!==void 0){let s=0,n,r;for(;s<50;){if(this.wrap?[n,r]=at(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord):[n,r]=lt(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color),(this.h>=r||"h"in this.hints&&this.hints.h==null||e<.01)&&(this.w>=n||"w"in this.hints&&this.hints.w==null)){"h"in this.hints&&this.hints.h==null&&(this.h=r),"w"in this.hints&&this.hints.w==null&&(this.w=n);break}const l=Math.min(1.1,this.w/n,this.h/r);this.wrap?e*=l**.5:e*=l**1.1,s++}e===void 0&&(e=.001*p.get().h)}this.sizeGroup!==""?(this._bestFontSize=e,this._textData=null):this.wrap?this._textData=pt(i,this.text,e,this.fontName,this.align,this.valign,this.rect,this.color,this.wrapAtWord):this._textData=ft(i,this.text,e,this.fontName,this.align,this.valign,this.rect,this.color),super.layoutChildren()}sizeToGroup(t){if(this._bestFontSize===void 0)return;let i=1/0;for(let e of p.get().iterByPropertyValue("sizeGroup",this.sizeGroup))i>e._bestFontSize&&!e.ignoreSizeForGroup&&(i=e._bestFontSize);if(i>0)for(let e of p.get().iterByPropertyValue("sizeGroup",this.sizeGroup)){const s=e.clip||!e.ignoreSizeForGroup?i:e._bestFontSize;e.wrap?e._textData=pt(t,e.text,s,e.fontName,e.align,e.valign,e.rect,e.color,e.wrapAtWord):e._textData=ft(t,e.text,s,e.fontName,e.align,e.valign,e.rect,e.color)}}draw(t,i){if(super.draw(t,i),this.clip){i.save();const e=this.rect;i.rect(e.x,e.y,e.w,e.h),i.clip()}!this._textData&&this.sizeGroup!==""&&this.sizeToGroup(i),this._textData&&(this.wrap?Dt(i,this._textData,this.color):Tt(i,this._textData,this.color)),this.clip&&i.restore()}}class Xt extends G{bgColor=x([.5,.5,.5]);selectColor=x([.7,.7,.8]);disableColor1=x([.2,.2,.2]);disableColor2=x([.4,.4,.4]);disable=!1;constructor(t=null){super(),t!==null&&this.updateProperties(t)}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):!1}on_touch_up(t,i,e){return super.on_touch_up(t,i,e)?!0:e.grabbed!=this?!1:(e.ungrab(),!this.disable&&this.collide(e.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(t,i,e){return super.on_touch_move(t,i,e)?!0:(e.grabbed==this&&!this.disable&&(this._touching=this.collide(e.rect)),!1)}draw(t,i){let e=this.bgColor,s=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(t,i),this.bgColor=e,this.color=s}}class Ot extends z{color=x([.8,.8,.8]);bgColor=x([.5,.5,.5]);selectColor=x([.7,.7,.8]);disableColor1=x([.2,.2,.2]);disableColor2=x([.4,.4,.4]);disable=!1;constructor(t=null){super(),t!==null&&this.updateProperties(t)}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):!1}on_touch_up(t,i,e){return super.on_touch_up(t,i,e)?!0:e.grabbed!=this?!1:(e.ungrab(),!this.disable&&this.collide(e.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(t,i,e){return super.on_touch_move(t,i,e)?!0:(e.grabbed==this&&!this.disable&&(this._touching=this.collide(e.rect)),!1)}draw(t,i){let e=this.bgColor,s=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(t,i),this.bgColor=e,this.color=s}}class bt extends G{bgColor=x([.5,.5,.5]);pressColor=x([.7,.7,.7]);selectColor=x([.7,.7,.8]);disableColor1=x([.2,.2,.2]);disableColor2=x([.4,.4,.4]);disable=!1;_press=!1;group=null;singleSelect=!0;constructor(t=null){super(),t!==null&&this.updateProperties(t)}get press(){return this._press}set press(t){this._press=t}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):!1}on_touch_up(t,i,e){if(e.grabbed!==this)return!1;if(e.ungrab(),this._touching=!1,this.collide(e.rect)){if(this.group===null||!this.singleSelect)this.press=!this.press;else{if(this.parent!==null)for(let s of this.parent.iterByPropertyValue("group",this.group))s!==this&&(s._press=!1);this.press=!0}return!0}return!1}on_touch_move(t,i,e){return e.grabbed===this?(this._touching=this.collide(e.rect),!0):!1}draw(t,i){let e=this.bgColor,s=this.color;this.press&&(this.bgColor=this.pressColor),this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(t,i),this.bgColor=e,this.color=s}}class Et extends z{selectColor=x([.7,.7,.8]);color=x([.6,.6,.6]);bgColor=x([.5,.5,.5]);disableColor1=x([.2,.2,.2]);disableColor2=x([.3,.3,.3]);disable=!1;check=!1;group=null;constructor(t=null){super(),t!==null&&this.updateProperties(t)}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):!1}on_touch_up(t,i,e){if(super.on_touch_up(t,i,e))return!0;if(this.parent===null||e.grabbed!=this)return!1;if(e.ungrab(),!this.disable&&this.collide(e.rect)){if(this._touching=!1,this.group==null)this.check=!this.check;else{for(let s of this.parent.iterByPropertyValue("group",this.group))s!=this&&(s.check=!1);this.check=!0}return!0}return!1}on_touch_move(t,i,e){return super.on_touch_move(t,i,e)?!0:e.grabbed==this&&!this.disable?(this._touching=this.collide(e.rect),!0):!1}draw(t,i){if(this.group!=null){let n=this.rect;n.w=n.h=.5*Math.min(n.w,n.h),n.x=this.x+(this.w-n.w)/2,n.y=this.y+(this.h-n.h)/2;let r=p.get().tileSize,l=p.get().ctx;if(!l)return;l.strokeStyle=this.disable?this.disableColor1:this.bgColor,l.lineWidth=1/r,l.beginPath(),l.arc(n.center_x,n.center_y,n.w/2,0,2*Math.PI),l.stroke(),(this._touching||this.disable)&&(l.fillStyle=this.disable?this.disableColor1:this.selectColor,l.fill()),this.check&&(l.fillStyle=this.disable?this.disableColor2:this.color,l.beginPath(),l.arc(n.center_x,n.center_y,n.w/3,0,2*Math.PI),l.fill());return}let e=this.rect;e.w=e.h=.5*Math.min(e.w,e.h),e.x=this.x+(this.w-e.w)/2,e.y=this.y+(this.h-e.h)/2;let s=t.tileSize;i.beginPath(),i.strokeStyle=this.bgColor,this.disable&&(i.strokeStyle=this.disableColor1),i.lineWidth=1/s,i.rect(e[0],e[1],e[2],e[3]),i.stroke(),this._touching&&(i.fillStyle=this.selectColor,i.fill()),this.check&&(i.strokeStyle=this.color,this.disable&&(i.strokeStyle=this.disableColor2),i.beginPath(),i.lineWidth=e.w/5,i.moveTo(e.x,e.y),i.lineTo(e.right,e.bottom),i.moveTo(e.right,e.y),i.lineTo(e.x,e.bottom),i.stroke())}}class Vt extends z{selectColor=x([.7,.7,.8]);color=x([.6,.6,.6]);bgColor=x([.4,.4,.4]);disableColor1=x([.2,.2,.2]);disableColor2=x([.3,.3,.3]);disable=!1;min=0;max=1;curMax=1;unboundedStopMultiple=10;exponentialSlider=!1;step=null;orientation="horizontal";value=0;sliderSize=.2;constructor(t=null){super(),t!==null&&this.updateProperties(t)}setValue(t){let i=this.max??this.curMax,e=0;this.orientation=="horizontal"&&(e=et((t.rect.x-this.x-this.w*this.sliderSize/2)/(this.w*(1-this.sliderSize)),0,1)),this.orientation=="vertical"&&(e=et((t.rect.y-this.y-this.h*this.sliderSize/2)/(this.h*(1-this.sliderSize)),0,1)),this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?e=e>.5?i/this.unboundedStopMultiple+(e-.5)/.5*(i-i/this.unboundedStopMultiple):this.min+e/.5*(i/this.unboundedStopMultiple-this.min):e=this.min+(i-this.min)*e,this.step!=null&&(e=Math.round(e/this.step)*this.step),this.value=e}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touch=!0,this.setValue(e),!0):!1}updateMax(){this.max===null&&(this.curMax=this.unboundedStopMultiple*this.value)}on_touch_up(t,i,e){return e.grabbed!=this?super.on_touch_up(t,i,e):(e.ungrab(),!this.disable&&this.collide(e.rect)&&(this._touching=!1,this.setValue(e)),this.updateMax(),!0)}on_touch_move(t,i,e){return e.grabbed!==this?super.on_touch_move(t,i,e):(this.disable||(this._touching=this.collide(e.rect),this.setValue(e)),!1)}draw(t,i){let e=t.tileSize,s=this.rect;if(this.orientation=="horizontal"){s.w-=this.sliderSize*this.w,s.x+=this.sliderSize/2*this.w;let n=Math.min(this.sliderSize/2*this.w,this.h/2)/2;i.strokeStyle=this.disable?this.disableColor1:this.bgColor,i.beginPath(),i.lineWidth=4/e,i.moveTo(s.x,s.center_y),i.lineTo(s.right,s.center_y),i.stroke();let r=this.max??this.curMax,l;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?l=this.value>r/this.unboundedStopMultiple?(.5+.5*(this.value-r/this.unboundedStopMultiple)/(r-r/this.unboundedStopMultiple))*s.w:.5*(this.value-this.min)/(r/this.unboundedStopMultiple-this.min)*s.w:l=(this.value-this.min)/(r-this.min)*s.w,i.strokeStyle=this.disable?this.disableColor2:this.bgColor,i.beginPath(),i.arc(s.x+l,s.center_y,n,0,2*Math.PI),i.stroke(),i.fillStyle=this.color,(this._touching||this.disable)&&(i.fillStyle=this.disable?this.disableColor1:this.selectColor),i.fill()}if(this.orientation=="vertical"){s.h-=this.sliderSize*this.h,s.y+=this.sliderSize/2*this.h;let n=Math.min(this.sliderSize/2*this.h,this.w/2)/2;i.strokeStyle=this.disable?this.disableColor1:this.bgColor,i.beginPath(),i.lineWidth=4/e,i.moveTo(s.center_x,s.y),i.lineTo(s.center_x,s.bottom),i.stroke();let r=this.max??this.curMax,l;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?l=this.value>r/this.unboundedStopMultiple?(.5+.5*(this.value-r/this.unboundedStopMultiple)/(r-r/this.unboundedStopMultiple))*s.h:.5*(this.value-this.min)/(r/this.unboundedStopMultiple-this.min)*s.h:l=(this.value-this.min)/(r-this.min)*s.h,i.strokeStyle=this.disable?this.disableColor2:this.bgColor,i.beginPath(),i.arc(s.center_x,s.y+l,n,0,2*Math.PI),i.stroke(),i.fillStyle=this.color,(this._touching||this.disable)&&(i.fillStyle=this.disable?this.disableColor1:this.selectColor),i.fill()}}}class qt extends G{_activeDOMInput=null;focus=!0;disable=!1;_inputSanitizer=void 0;constructor(t={}){super(),this._textData=null,t!==null&&this.updateProperties(t)}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):(this.clearDOM(),!1)}on_touch_up(t,i,e){return super.on_touch_up(t,i,e)?!0:e.grabbed!=this?!1:!this.disable&&this.collide(e.rect)?(this._touching=!1,this.addDOMInput(),!0):(this.clearDOM(),!1)}on_layout(t,i,e){this.clearDOM()}DOMInputRect(){let t=this.rect,i=this.getTransformRecurse(),e=new C,s=i.transformPoint(new DOMPoint(t.x,t.y)),n=i.transformPoint(new DOMPoint(t.right,t.bottom));return[e.x,e.y]=[s.x,s.y],[e.w,e.h]=[n.x,n.y],e.w-=e.x,e.h-=e.y,e}addDOMInput(){if(!this._textData)return;p.get();let t=document.getElementById("eskvapp");if(!t)return;let i=this.wrap?"textarea":"input",e=document.createElement(i);if(!(e instanceof HTMLInputElement)&&!(e instanceof HTMLTextAreaElement))return;let s,n=this.DOMInputRect(),r=this.color!=null?this.color:"white",l=this.bgColor!=null?this.bgColor:"black";e.style.color=r,s=this._textData.size/this.h*n.h/this._textData.outText.length,i=="textarea"&&this._textData.outText.length,e.value=this.text,s=(Math.floor(s*100)/100).toString()+"px",e.style.fontSize=s,e.style.backgroundColor=l,e.style.top=(Math.floor(n.y*100)/100).toString()+"px",e.style.left=(Math.floor(n.x*100)/100).toString()+"px",e.style.width=(Math.floor(n.w*100)/100).toString()+"px",e.style.height=(Math.floor(n.h*100)/100).toString()+"px",e.style.fontFamily=this.fontName,this._activeDOMInput=e,t.appendChild(e),e.addEventListener("focusout",h=>this.clearDOM()),e.focus(),e.select(),this.focus=!0}clearDOM(){if(this._activeDOMInput!=null){this.text=this._inputSanitizer?this._inputSanitizer(this._activeDOMInput.value,this):this._activeDOMInput.value;let t=this._activeDOMInput;this._activeDOMInput=null,t.remove(),this.focus=!1,this._needsLayout=!0;let i=p.get().inputHandler;i?.grabbed===this&&i.ungrab()}}layoutChildren(){if(super.layoutChildren(),this._activeDOMInput!=null){let t=this.DOMInputRect(),i=this._activeDOMInput;i.style.top=(Math.floor(t.y*100)/100).toString()+"px",i.style.left=(Math.floor(t.x*100)/100).toString()+"px",i.style.width=(Math.floor(t.w*100)/100).toString()+"px",i.style.height=(Math.floor(t.h*100)/100).toString()+"px"}}}class Nt extends z{bgColor=null;outlineColor=null;src=null;lockAspect=!0;scaleToFit=!0;antiAlias=!0;angle=0;anchor="center";mirror=!1;constructor(t=null){super(),this.image=new Image,t!==null&&this.updateProperties(t),this.src&&(this.image.src=this.src)}on_src(t,i,e){this.src?this.image.src=this.src:this.image.src=""}layoutChildren(){this._layoutNotify&&this.emit("layout",null);let t=p.get();"w"in this.hints&&this.hints.w==null&&(this[2]=this.image.width/t.tileSize),"h"in this.hints&&this.hints.h==null&&(this[3]=this.image.height/t.tileSize),this._needsLayout=!1,super.layoutChildren()}draw(t,i){if(super.draw(t,i),!this.image.complete||this.image.naturalHeight==0)return;let e=this.rect;if(this.scaleToFit||(e.x+=e.w/2-this.image.width/2/t.tileSize,e.y+=e.h/2-this.image.height/2/t.tileSize,e.w=this.image.width/t.tileSize,e.h=this.image.height/t.tileSize),this.lockAspect){let n=this.image.height/this.image.width,r=e.h/e.w,l=e.h,h=e.w;n<r&&(l=e.w*n),n>r&&(h=e.h/n),e.x+=e.w/2-h/2,e.y+=e.h/2-l/2,e.w=h,e.h=l}i.save(),i.imageSmoothingEnabled=this.antiAlias;let s=this.anchor;s=="center"?s=[e.w/2,e.h/2]:s=[s[0]*e.w,s[1]*e.h],this.mirror&&i.scale(-1,1),i.translate(e.x+s[0],e.y+s[1]),this.angle!=0&&i.rotate(this.angle),i.translate(-s[0],-s[1]),i.drawImage(this.image,0,0,this.image.width,this.image.height,0,0,e.w,e.h),i.restore()}}class nt extends z{spacingX=0;spacingY=0;paddingX=0;paddingY=0;orientation="vertical";order="forward";constructor(t=null){super(),t!==null&&this.updateProperties(t)}*iterChildren(){if(this.order==="forward")for(let t of this._children)yield t;else for(let t=this._children.length-1;t>=0;t--)yield this._children[t]}on_numX(t,i,e){this._needsLayout=!0}on_numY(t,i,e){this._needsLayout=!0}on_spacingX(t,i,e){this._needsLayout=!0}on_spacingY(t,i,e){this._needsLayout=!0}on_paddingX(t,i,e){this._needsLayout=!0}on_paddingY(t,i,e){this._needsLayout=!0}on_orientation(t,i,e){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let t=this.getMetric(this,"spacingX",this.spacingX),i=this.getMetric(this,"spacingY",this.spacingY),e=this.getMetric(this,"paddingX",this.paddingX),s=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation==="vertical"){let n=this.children.length,r=this.h-i*(n-1)-2*s,l=this.w-2*e,h=0;for(let f of this.iterChildren())f.w=l,this.applyHints(f,l,r),"h"in f.hints&&(f.hints.h===null&&f.layoutChildren(),h+=f.h,n--);let o=(r-h)/n,u=l;n===0&&r>0&&(s=(r-h)/2);let d=this.y+s,c=this.x+e;for(let f of this.iterChildren())f.y=d,!("x"in f.hints)&&!("center_x"in f.hints)&&!("right"in f.hints)&&(f.x=c),"w"in f.hints||(f.w=u),"h"in f.hints||(f.h=o),f.layoutChildren(),d+=i+f.h;n===0&&"h"in this.hints&&this.hints.h===null&&(this[3]=d+s-this.y);return}if(this.orientation==="horizontal"){let n=this.children.length,r=this.h-2*s,l=this.w-t*(n-1)-2*e,h=0;for(let f of this.iterChildren())f.h=r,this.applyHints(f,l,r),"w"in f.hints&&(f.hints.w===null&&f.layoutChildren(),h+=f.w,n--);let o=r,u=(l-h)/n;n===0&&l>0&&(e=(l-h)/2);let d=this.y+s,c=this.x+e;for(let f of this.iterChildren())f.x=c,!("y"in f.hints)&&!("center_y"in f.hints)&&!("bottom"in f.hints)&&(f.y=d),"w"in f.hints||(f.w=u),"h"in f.hints||(f.h=o),f.layoutChildren(),c+=t+f.w;n==0&&"w"in this.hints&&this.hints.w==null&&(this[2]=c+e-this.x)}}}class _t extends z{activePage=0;constructor(t=null){super(),t!==null&&this.updateProperties(t)}on_wheel(t,i,e){const s=this.children[this.activePage]??void 0;return!!(s!==void 0&&s.emit(t,e))}on_touch_down(t,i,e){let s=this.getTransform();if(s){let n=e.copy(),r=s.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[r.x,r.y];const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(t,n))return!0}else{const n=this.children[this.activePage]??void 0;if(n!==void 0&&n.emit(t,e))return!0}return!1}on_touch_up(t,i,e){let s=this.getTransform();if(s){let n=e.copy(),r=s.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[r.x,r.y];const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(t,n))return!0}else{const n=this.children[this.activePage]??void 0;if(n!==void 0&&n.emit(t,e))return!0}return!1}on_touch_move(t,i,e){let s=this.getTransform();if(s){let n=e.copy(),r=s.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[r.x,r.y];const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(t,n))return!0}else{const n=this.children[this.activePage]??void 0;if(n!==void 0&&n.emit(t,e))return!0}return!1}on_touch_cancel(t,i,e){let s=this.getTransform();if(s){let n=e.copy(),r=s.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[r.x,r.y];const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(t,n))return!0}else{const n=this.children[this.activePage]??void 0;if(n!==void 0&&n.emit(t,e))return!0}return!1}on_activePage(t,i,e){this._needsLayout=!0}_draw(t,i,e){this.draw(t,i);let s=this.getTransform();if(s){i.save(),i.transform(s.a,s.b,s.c,s.d,s.e,s.f);let r=this.children[this.activePage]??void 0;r!==void 0&&r._draw(t,i,e),i.restore();return}let n=this.children[this.activePage]??void 0;n!==void 0&&n._draw(t,i,e)}}class Gt extends _t{tabHeightHint="1";tabGroupName="tabbedNotebookGroup";constructor(t=null){super(),this.buttonBox=new nt({orientation:"horizontal",hints:{h:this.tabHeightHint,w:null}}),this.buttonScroller=new rt({id:"_scrollview",hints:{h:this.tabHeightHint,w:1},children:[this.buttonBox]}),this._children=[this.buttonScroller],this.buttonScroller.parent=this,t!==null&&this.updateProperties(t),this.updateButtons()}on_tabHeightHint(t,i,e){this.buttonBox.hints.h=this.tabHeightHint}on_child_added(t,i,e){this.updateButtons()}on_child_removed(t,i,e){this.updateButtons()}on_wheel(t,i,e){const s=this._children[0]??void 0;if(s!==void 0&&s.emit(t,e))return!0;const n=this.children[this.activePage]??void 0;return!!(n!==void 0&&n.emit(t,e))}on_touch_down(t,i,e){let s=this.getTransform();if(s){let n=e.copy(),r=s.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[r.x,r.y];const l=this._children[0]??void 0;if(l!==void 0&&l.emit(t,n))return!0;const h=this.children[this.activePage]??void 0;if(h!==void 0&&h.emit(t,n))return!0}else{const n=this._children[0]??void 0;if(n!==void 0&&n.emit(t,e))return!0;const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(t,e))return!0}return!1}on_touch_up(t,i,e){let s=this.getTransform();if(s){let n=e.copy(),r=s.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[r.x,r.y];const l=this._children[0]??void 0;if(l!==void 0&&l.emit(t,n))return!0;const h=this.children[this.activePage]??void 0;if(h!==void 0&&h.emit(t,n))return!0}else{const n=this._children[0]??void 0;if(n!==void 0&&n.emit(t,e))return!0;const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(t,e))return!0}return!1}on_touch_move(t,i,e){let s=this.getTransform();if(s){let n=e.copy(),r=s.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[r.x,r.y];const l=this._children[0]??void 0;if(l!==void 0&&l.emit(t,n))return!0;const h=this.children[this.activePage]??void 0;if(h!==void 0&&h.emit(t,n))return!0}else{const n=this._children[0]??void 0;if(n!==void 0&&n.emit(t,e))return!0;const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(t,e))return!0}return!1}on_touch_cancel(t,i,e){let s=this.getTransform();if(s){let n=e.copy(),r=s.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[r.x,r.y];const l=this._children[0]??void 0;if(l!==void 0&&l.emit(t,n))return!0;const h=this.children[this.activePage]??void 0;if(h!==void 0&&h.emit(t,n))return!0}else{const n=this._children[0]??void 0;if(n!==void 0&&n.emit(t,e))return!0;const r=this.children[this.activePage]??void 0;if(r!==void 0&&r.emit(t,e))return!0}return!1}get children(){return this._children.slice(1)}set children(t){for(let i of this._children.slice(1))this.emit("child_removed",i),i.parent=null,this._needsLayout=!0,this.updateButtons();this._children=this._children.slice(0,1);for(let i of t)this.addChild(i)}updateButtons(){this.buttonBox.children=[];let t=0;for(let i of this.children){const e=new bt({text:i.name??String(t+1),group:this.tabGroupName,singleSelect:!0,press:this.activePage===t,fontSize:"0.5",hints:{h:null,w:null}});e.bind("press",(s,n,r)=>{this.activePage=this.buttonBox.children.findIndex(l=>l===n)}),this.buttonBox.addChild(e),t++}}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;const t=this._children[0];this.applyHints(t),t.x=this.x,t.y=this.y,t.layoutChildren();const i=this.h-t.h,e=this.w;for(let s of this.children)s.y=this.y+t.h,s.x=this.x,s.w=e,s.h=i,s.layoutChildren()}_draw(t,i,e){this.draw(t,i);let s=this.getTransform();if(s){i.save(),i.transform(s.a,s.b,s.c,s.d,s.e,s.f);let l=this._children[0]??void 0;l!==void 0&&l._draw(t,i,e);let h=this.children[this.activePage]??void 0;h!==void 0&&h._draw(t,i,e),i.restore();return}let n=this._children[0]??void 0;n!==void 0&&n._draw(t,i,e);let r=this.children[this.activePage]??void 0;r!==void 0&&r._draw(t,i,e)}}class Ut extends z{numX=1;numY=1;spacingX=0;spacingY=0;paddingX=0;paddingY=0;orientation="horizontal";constructor(t=null){super(),t!==null&&this.updateProperties(t)}on_numX(t,i,e){this._needsLayout=!0}on_numY(t,i,e){this._needsLayout=!0}on_spacingX(t,i,e){this._needsLayout=!0}on_spacingY(t,i,e){this._needsLayout=!0}on_paddingX(t,i,e){this._needsLayout=!0}on_paddingY(t,i,e){this._needsLayout=!0}on_orientation(t,i,e){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let t=this.getMetric(this,"spacingX",this.spacingX),i=this.getMetric(this,"spacingY",this.spacingY),e=this.getMetric(this,"paddingX",this.paddingX),s=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation=="horizontal"){let n=this.numX,r=Math.ceil(this.children.length/this.numX),l=this.h-i*(r-1)-2*s,h=this.w-t*(n-1)-2*e,o=new Array(n).fill(0),u=new Array(r).fill(0),d=0,c=0,f=0;for(let v of this.children)this.applyHints(v,h,l),"w"in v.hints&&(o[c]=Math.max(v.w,o[c])),"h"in v.hints&&(u[d]=Math.max(v.h,u[d])),(f+1)%n==0?(d++,c=0):c++,f++;let m=0,T=0,k=0,L=0;for(let v of o)m+=v,v>0&&k++;for(let v of u)T+=v,v>0&&L++;let w=r>L?(l-T)/(r-L):0,b=n>k?(h-m)/(n-k):0,M=this.y+s,D=this.x+e;d=0,c=0;for(let v=0;v<this.children.length;v++){let W=this.children[v],U=o[c]==0?b:o[c],$=u[d]==0?w:u[d];"w"in W.hints||(W.w=U),"h"in W.hints||(W.h=$),W.x=D,W.y=M,W.layoutChildren(),(v+1)%n==0?(D=this.x+e,M+=i+$,c=0,d++):(D+=t+U,c++)}return}else{let n=Math.ceil(this.children.length/this.numY),r=this.numY,l=this.h-i*(r-1)-2*s,h=this.w-t*(n-1)-2*e,o=new Array(n).fill(0),u=new Array(r).fill(0),d=0,c=0,f=0;for(let v of this.children)this.applyHints(v,h,l),"w"in v.hints&&(o[c]=Math.max(v.w,o[c])),"h"in v.hints&&(u[d]=Math.max(v.h,u[d])),(f+1)%r==0?(c++,d=0):d++,f++;let m=0,T=0,k=0,L=0;for(let v of o)m+=v,v>0&&k++;for(let v of u)T+=v,v>0&&L++;let w=r>L?(l-T)/(r-L):0,b=n>k?(h-m)/(n-k):0,M=this.y+s,D=this.x+e;d=0,c=0;for(let v=0;v<this.children.length;v++){let W=this.children[v],U=o[c]==0?b:o[c],$=u[d]==0?w:u[d];"w"in W.hints||(W.w=U),"h"in W.hints||(W.h=$),W.x=D,W.y=M,W.layoutChildren(),(v+1)%r==0?(M=this.y+s,D+=t+U,d=0,c++):(M+=i+$,d++)}}}}class rt extends z{_scrollX=0;_scrollY=0;scrollX=0;scrollY=0;scrollW=!0;scrollH=!0;wAlign="center";hAlign="top";uiZoom=!0;uiMove=!0;zoom=1;vel=null;velCutoff=1e-5;velDecay=.95;unboundedH=!1;unboundedW=!1;_zoomCenter=null;constructor(t=null){super(),t!==null&&this.updateProperties(t),this._processTouches=!0,this._oldTouch=null,this._lastDist=null}on_child_added(t,i,e){this.children.length==1&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0,e.bind("rect",(s,n,r)=>this._needsLayout=!0),e.bind("w",(s,n,r)=>this._needsLayout=!0),e.bind("h",(s,n,r)=>this._needsLayout=!0))}on_child_removed(t,i,e){this.children.length==0&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.children[0][0]=0,this.children[0][1]=0,this.scrollW||(this.children[0][2]=this.w),this.scrollH||(this.children[0][3]=this.h);for(let t of this.children)t.layoutChildren()}fitToClient(){this.zoom=Math.min(this.w/this.children[0].w,this.h/this.children[0].h),this.scrollX=.5*this.scrollableW,this.scrollY=.5*this.scrollableH}on_uiZoom(t,i,e){this._needsLayout=!0}on_hAlign(t,i,e){this._needsLayout=!0}on_vAlign(t,i,e){this._needsLayout=!0}*iter(t=!0,i=!0){if(yield this,!!t)if(i)for(let e of this._children)this.contains(e)&&(yield*e.iter(...arguments));else for(let e of this._children)yield*e.iter(...arguments)}on_scrollW(t,i,e){this._needsLayout=!0,this.scrollX=0}on_scrollH(t,i,e){this._needsLayout=!0,this.scrollY=0}on_scrollX(t,i,e){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedW){this._scrollX=this.scrollX;return}let s=0;switch(this.wAlign){case"center":s=.5*this.scrollableW;break;case"right":s=1*this.scrollableW}this._scrollX=this.scrollableW<=0||this.scrollableW>=this.children[0].w?s:e,this._scrollX=et(e,0,this.scrollableW)}on_scrollY(t,i,e){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedH){this._scrollY=this.scrollY;return}let s=0;switch(this.hAlign){case"middle":s=.5*this.scrollableH;break;case"bottom":s=1*this.scrollableH}this._scrollY=this.scrollableH<=0||this.scrollableH>=this.children[0].h?s:e,this._scrollY=et(e,0,this.scrollableH)}update(t,i){if(super.update(t,i),this.vel!==null){this.scrollX+=this.vel.x*i,this.scrollY+=this.vel.y*i,this.vel=this.vel.scale(this.velDecay**(i/30));let e=this.vel.abs();e.x<=this.velCutoff/this.zoom&&e.y<=this.velCutoff/this.zoom&&(this.vel=null)}}getTransform(){const t=p.get().tileSize;return new DOMMatrix().translate(Math.floor((this.x-this._scrollX*this.zoom)*t)/t,Math.floor((this.y-this._scrollY*this.zoom)*t)/t).scale(this.zoom,this.zoom)}on_touch_down(t,i,e){this.vel=null;let s=e.rect;if(this._lastDist=null,this.collide(s)){let n=Date.now(),r=e.asChildTouch(this);return this._oldTouch=[r.x,r.y,r.identifier,n,null],super.on_touch_down(t,i,e)||e.grab(this),!0}return!1}on_touch_up(t,i,e){if(e.grabbed!==this)return!1;if(this._oldTouch!=null){let s=this._oldTouch[4],n=new y([this._oldTouch[0],this._oldTouch[1]]),r=e.asChildTouch(this),l=Math.max(Date.now()-this._oldTouch[3],1),h=this.scrollableW>0||this.unboundedW?(r.x-n.x)/l:0,o=this.scrollableH>0||this.unboundedH?(r.y-n.y)/l:0;this.vel=new y([-h,-o]),s&&(this.vel=this.vel.add(s).scale(.5))}return this._oldTouch=null,this._lastDist=null,this._zoomCenter=null,e.ungrab(),!1}on_touch_move(t,i,e){if(e.grabbed!==this)return!1;let s=e.rect;if(this.collide(s)){let n=e.asChildTouch(this);if((this.uiMove&&e.nativeEvent==null||e.nativeEvent instanceof TouchEvent&&e.nativeEvent.touches.length==1)&&this._oldTouch!=null&&e.identifier==this._oldTouch[2]){this.scrollW&&(this.scrollX=this.scrollableW==0?0:this._scrollX+(this._oldTouch[0]-n.x)),this.scrollH&&(this.scrollY=this.scrollableH==0?0:this._scrollY+(this._oldTouch[1]-n.y));let r=e.asChildTouch(this),l=this._oldTouch,h=Date.now(),o=new y([0,0]),u=new y([0,0]);if(l!=null){let c=Math.max(h-l[3],1),f=this.scrollableW>0||this.unboundedW?(r.x-n.x)/c:0,m=this.scrollableH>0||this.unboundedH?(r.y-n.y)/c:0;o=new y([f,m]),u=l[4]!==null?l[4]:u}let d=o.abs().sum()===0?o:o.add(u).scale(.5);this._oldTouch=[r.x,r.y,e.identifier,h,d]}if(this.uiZoom&&e.nativeEvent&&e.nativeEvent instanceof TouchEvent&&e.nativeEvent.touches.length==2){let r=e.nativeEvent.touches[0],l=e.nativeEvent.touches[1],h=kt([r.clientX,r.clientY],[l.clientX,l.clientY]);if(this._lastDist!=null){let o=this._scrollX+this.w/this.zoom/2,u=this._scrollY+this.h/this.zoom/2,d=[r.clientX,r.clientY],c=[l.clientX,l.clientY],f=this.appToChild(d),m=this.appToChild(c),T=[(f[0]+m[0])/2,(f[1]+m[1])/2];this._zoomCenter===null&&(this._zoomCenter=new y(T));let k=this.zoom*h/this._lastDist,L=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(k,L);let w=this.appToChild(d),b=this.appToChild(c),M=[(w[0]+b[0])/2,(w[1]+b[1])/2];this.scrollX=o+T[0]-M[0]-this.w/this.zoom/2,this.scrollY=u+T[1]-M[1]-this.h/this.zoom/2}this._lastDist=h}}return!1}on_touch_cancel(t,i,e){return this._lastDist=null,e.grabbed===this?(e.ungrab(),!0):!!super.on_touch_cancel(t,i,e)}on_wheel(t,i,e){let s=p.get();if(!s.inputHandler)return!0;let n=this._scrollX+this.w/this.zoom/2,r=this._scrollY+this.h/this.zoom/2,l=e.nativeObject;if(!this.collide(e.rect)&&(!this.unboundedW||!this.unboundedH)||!(l instanceof WheelEvent))return!1;if(this.uiZoom&&s.inputHandler.isKeyDown("Control")){let h=e.asChildTouch(this);h.pos[0],h.pos[1];let o=this.zoom*Math.exp(-l.deltaY/s.h),u=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(o,u);let d=e.asChildTouch(this);return d.pos[0],d.pos[1],this.scrollX=this.scrollableW==0&&!this.unboundedW?0:n-this.w/this.zoom/2,this.scrollY=this.scrollableH==0&&!this.unboundedH?0:r-this.h/this.zoom/2,this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}else{if(this.uiMove&&this.scrollW&&s.inputHandler.isKeyDown("Shift"))return this.scrollX+=this.scrollableW==0&&!this.unboundedW?0:this.w/this.zoom*(l.deltaY/s.w),this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),!0;if(this.uiMove&&this.scrollH)return this.scrollY+=this.scrollableH==0&&!this.unboundedH?0:this.h/this.zoom*(l.deltaY/s.h),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}return!1}get scrollableW(){return this.children.length==0?0:this.unboundedW?this.children[0].w-this.w/this.zoom:Math.max(this.children[0].w-this.w/this.zoom,0)}get scrollableH(){return this.children.length==0?0:this.unboundedH?this.children[0].h-this.h/this.zoom:Math.max(this.children[0].h-this.h/this.zoom,0)}_draw(t,i,e){this.draw(t,i);let s=this.rect;s[0]=Math.floor(s[0]*t.tileSize*t.pixelSize)/(t.tileSize*t.pixelSize),s[1]=Math.floor(s[1]*t.tileSize*t.pixelSize)/(t.tileSize*t.pixelSize),s[2]=Math.floor(s[2]*t.tileSize*t.pixelSize)/(t.tileSize*t.pixelSize),s[3]=Math.floor(s[3]*t.tileSize*t.pixelSize)/(t.tileSize*t.pixelSize),i.save(),i.beginPath(),i.rect(s[0],s[1],s[2],s[3]),i.clip();let n=this.getTransform();n&&i.transform(n.a,n.b,n.c,n.d,n.e,n.f),this.children[0]._draw(t,i,e),i.restore()}}class $t extends nt{closeOnTouchOutside=!0;bgColor="slate";outlineColor="gray";dim=!0;dimScale=.8;constructor(t=null){super(),t!==null&&this.updateProperties(t)}popup(){if(this.parent==null){let t=p.get();return this.parent=t,t.addModal(this),!0}return!1}close(t=0){if(this.parent!=null){this.emit("close",t);let i=p.get();return this.parent=null,i.removeModal(this),!0}return!1}on_touch_down(t,i,e){return this.closeOnTouchOutside&&!this.collide(e.rect)?(this.close(),!0):super.on_touch_down(t,i,e)}draw(t,i){if(this.dim){let e=p.get().baseWidget.rect,s=p.get().ctx;if(!s)return;s.fillStyle="rgba(0,0,0,"+this.dimScale+")",s.rect(e[0],e[1],e[2],e[3]),s.fill(),super.draw(t,s)}}}function Kt(a,t,i){const e=Math.floor(a/t/4)>0;a=a%(t*4);const s=Math.floor(a/t);a=a%t;const n=Math.floor(a/i),r=a%i;return[e,s,n,r]}class K{constructor(t="",i=[],e=[],s={}){this.id=t,this.matchTiles=new Set(i),this.matchAdjTiles=new Set(e),this.autos=s}autoTile(t,i,e){let s=0,n=1;const r=i.get(t);if(this.matchTiles.has(r)){for(let h of[[0,-1],[1,0],[0,1],[-1,0]]){const o=t.add(h),u=i.get(o);this.matchAdjTiles.has(u)&&(s+=n),n*=2}const l=this.autos[s]??void 0;l&&e.set(t,l)}}get length(){return this.matchTiles.size}}class Zt extends jt{animations=new Map;autoTiles=new Map;tileStamps=new Map;aliases=new Map;constructor(t,i=16){super(),this.spriteSize=i,this.sw=0,this.sh=0,this.len=0,this.sheet=new Image,this.sheet.src=t,this.sheet.onload=e=>{this.sw=Math.floor(this.sheet.width/this.spriteSize),this.sh=Math.floor(this.sheet.height/this.spriteSize),this.len=this.sw*this.sh,p.get().emit("sheetLoaded",this.sheet),p.get()._needsLayout=!0}}getAlias(t){for(let i of this.aliases.keys())if(this.aliases.get(i)===t)return i}update(t,i){super.update(t,i);for(let e of this.animations.values())e.update(t,i)}sheetToDataURL(){const t=document.createElement("canvas");t.width=this.sheet.width,t.height=this.sheet.height;const i=t.getContext("2d");return i?(i.drawImage(this.sheet,0,0),t.toDataURL("image/png")):void 0}serialize(){const t={};t.spriteSize=this.spriteSize,t.src=this.sheetToDataURL();const i={};for(let s of this.animations.keys())i[String(s)]=this.animations.get(s);t.animations=i;const e={};for(let s of this.aliases.keys())e[s]=this.aliases.get(s);return t.aliases=e,t}deserialize(t){this.spriteSize=t.spriteSize,this.sheet=new Image,this.sheet.onload=i=>{this.sw=Math.floor(this.sheet.width/this.spriteSize),this.sh=Math.floor(this.sheet.height/this.spriteSize),this.len=this.sw*this.sh,p.get().emit("sheetLoaded",this.sheet),p.get()._needsLayout=!0},this.sheet.src=t.src,this.animations=new Map;for(let i in t.animations)this.animations.set(parseInt(i),t.animations[i]);this.aliases=new Map;for(let i in t.aliases)this.aliases.set(i,t.aliases[i])}drawIndexed(t,i,e,s,n=0,r=0,l=0){if(i<-1&&(i=this.animations.get(i)?.tileValue??-1),i>=0){let[h,o,u,d]=Kt(i,this.len,this.sw);o=(o+n)%4,!h&&o===0?this.draw(t,[d,u],e+r,s+l):this.drawRotated(t,[d,u],e+.5,s+.5,o*90,h,[.5-r,.5-l])}}draw(t,i,e,s,n=!1){let r=n?-1:1;n&&t.scale(-1,1),t.drawImage(this.sheet,i[0]*this.spriteSize,i[1]*this.spriteSize,this.spriteSize,this.spriteSize,r*e,s,r,1),n&&t.scale(-1,1)}drawScaled(t,i,e,s,n,r=!1){let l=r?-1:1;r&&t.scale(-1,1),t.drawImage(this.sheet,i[0]*this.spriteSize,i[1]*this.spriteSize,this.spriteSize,this.spriteSize,l*e,s,l*n,n),r&&t.scale(-1,1)}drawRotated(t,i,e,s,n,r=!1,l="center"){t.save(),l=="center"?l=[1/2,1/2]:l=[l[0],l[1]],t.translate(e,s),t.rotate(n*Math.PI/180),r&&t.scale(-1,1),t.translate(-l[0],-l[1]),t.drawImage(this.sheet,i[0]*this.spriteSize,i[1]*this.spriteSize,this.spriteSize,this.spriteSize,0,0,1,1),t.restore()}drawRotatedMultitile(t,i,e,s,n,r=!1,l="center"){t.save();let h=i[2],o=i[3];l=="center"?l=[h*1/2,o*1/2]:l=[l[0],l[1]],t.translate(e+l[0],s+l[1]),t.rotate(n*Math.PI/180),r&&t.scale(-1,1),t.translate(-l[0],-l[1]),t.drawImage(this.sheet,i[0]*this.spriteSize,i[1]*this.spriteSize,this.spriteSize*h,this.spriteSize*o,0,0,h,o),t.restore()}}class E extends Array{constructor(t,i){super();for(let e=0;e<t.length;++e)i[e]?this.push(t[e],i[e][0],i[e][1]):this.push(t[e],0,0)}*iter(){for(let t=0;t<this.length/3;t++)yield this.slice(t*3,t*3+3)}}function S(a=[],t=[]){return new E(a,t)}class Z extends z{spriteSheet=null;frames=[];timePerFrame=30;timeLeft=0;activeFrame=0;id="";facing=0;flipX=!1;flipY=!1;oneShot=!1;constructor(t={}){super(),t&&this.updateProperties(t)}update(t,i){if(super.update(t,i),this.timeLeft-=i,this.timeLeft<=0){if(this.oneShot&&this.activeFrame===this.frames.length-1){this.timeLeft=1/0,this.emit("animationComplete",this.activeFrame);return}this.activeFrame++,this.activeFrame>=this.frames.length&&(this.activeFrame=0),this.timeLeft+=this.timePerFrame}this.frames.length>0&&this.timeLeft!==1/0&&t.requestFrameUpdate()}restart(){this.activeFrame=0,this.timeLeft=this.timePerFrame}on_frames(t,i,e){this.restart()}get frame(){return this.frames[this.activeFrame]??-1}draw(t,i){if(this.spriteSheet===null||!this.spriteSheet.sheet.complete)return;const e=Math.floor(this.x*t.tileSize)/t.tileSize,s=Math.floor(this.y*t.tileSize)/t.tileSize;if(i.translate(e,s),i.scale(this.w,this.h),this.frame instanceof E)for(let[n,r,l]of this.frame.iter())this.spriteSheet.drawIndexed(i,n,0,0,this.facing,r,l);else this.spriteSheet.drawIndexed(i,this.frame,0,0,this.facing);i.scale(1/this.w,1/this.h),i.translate(-e,-s)}}class vt extends z{constructor(t={}){super(),this.defaultValue=-1,this._data=new V,this._vLayer=null,this._aLayer=null,this._cacheTileDim=new y,this.tileDim=new y,this.hints={w:null,h:null},this.spriteSheet=null,this.clipRegion=null,this.alphaValue=.5,this.useCache=!0,t&&this.updateProperties(t)}serialize(){const t={};return t._data=this._data.slice(),t.tileDim=this.tileDim.slice(),t.spriteSheet=Array(...p.resources.keys()).find(i=>p.resources[i]===this.spriteSheet)??null,t}get(t){return this._data.get(t)}set(t,i){this._data.set(t,i),this._data._cacheData=null}get data(){return this._data}deserialize(t){this.tileDim=new y(t.tileDim??[0,0]);const i=t._data;for(let e=0;e<i.length;e++)this._data[e]=i[e];this.spriteSheet=p.resources[t.spriteSheet]??null,this._data._cacheData=null}on_tileDim(t,i,e){this.resizeData(),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new y(this.tileDim)}resizeData(){let t=[];for(let e=0;e<this._cacheTileDim[1];e++)for(let s=0;s<this._cacheTileDim[0];s++)t.push(this.get([s,e]));this._data.tileDim=new y(this.tileDim),this._data.length=this.tileDim[0]*this.tileDim[1],this._data.fill(this.defaultValue);let i=0;for(let e=0;e<this._cacheTileDim[1];e++)for(let s=0;s<this._cacheTileDim[0];s++)s<this.tileDim[0]&&e<this.tileDim[1]&&this.set([s,e],t[i]),++i;this._data._cacheData=null}draw(t,i){if(super.draw(t,i),this.spriteSheet===null||!this.spriteSheet.sheet.complete||!this.spriteSheet.sheet.complete||this.spriteSheet.sheet.naturalHeight==0)return;let[e,s]=[0,0],[n,r]=this.tileDim;if(this.clipRegion&&([e,s]=this.clipRegion.pos,[n,r]=this.clipRegion.pos.add(this.clipRegion.size).add([1,1]),e=Math.min(Math.max(e,0),this.tileDim[0]),n=Math.min(Math.max(n,0),this.tileDim[0]),s=Math.min(Math.max(s,0),this.tileDim[1]),r=Math.min(Math.max(r,0),this.tileDim[1])),Math.floor(this.spriteSheet.sheet.width/this.spriteSheet.spriteSize),Math.floor(this.spriteSheet.sheet.height/this.spriteSheet.spriteSize),this.useCache){if(this._data._cacheData===null&&this.cacheCanvas(),this._data._cacheData===null)return;const l=this.spriteSheet.spriteSize;if(i.drawImage(this._data._cacheData,l*e,l*s,l*(n-e),l*(r-s),this.x+e,this.y+s,n-e,r-s),this._aLayer===null&&this._vLayer===null)for(let h=e;h<n;h++)for(let o=s;o<r;o++){let u=h+o*this.tileDim[0],d=this._data[u];d<-1&&this.spriteSheet.drawIndexed(i,d,h+this.x,o+this.y)}else if(this._aLayer&&this._vLayer){const h=this._aLayer,o=this._vLayer,u=i.globalAlpha,d=this._data;for(let c=e;c<n;c++)for(let f=s;f<r;f++){let m=c+f*this.tileDim[0],T=d[m];T<-1&&o[m]>0&&(h[m]===0?(i.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(i,T,c+this.x,f+this.y),i.globalAlpha=u):this.spriteSheet.drawIndexed(i,T,c+this.x,f+this.y))}}}else if(this._aLayer===null&&this._vLayer===null)for(let l=e;l<n;l++)for(let h=s;h<r;h++){let o=l+h*this.tileDim[0],u=this._data[o];this.spriteSheet.drawIndexed(i,u,l+this.x,h+this.y)}else if(this._aLayer&&this._vLayer){const l=this._aLayer,h=this._vLayer,o=i.globalAlpha,u=this._data;for(let d=e;d<n;d++)for(let c=s;c<r;c++){let f=d+c*this.tileDim[0],m=u[f];m!==-1&&h[f]>0&&(l[f]===0?(i.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(i,m,d+this.x,c+this.y),i.globalAlpha=o):this.spriteSheet.drawIndexed(i,m,d+this.x,c+this.y))}}}clearCache(){this.data._cacheData=null}cacheCanvas(){if(this._data._cacheData=null,!this.spriteSheet||!this.spriteSheet.sheet||this.tileDim[0]<=0||this.tileDim[1]<=0)return;const t=new OffscreenCanvas(this.tileDim[0]*this.spriteSheet.spriteSize,this.tileDim[1]*this.spriteSheet.spriteSize),i=t.getContext("2d");if(!i)return;i.scale(this.spriteSheet.spriteSize,this.spriteSheet.spriteSize);let[e,s]=[0,0],[n,r]=this.tileDim;if(this._aLayer===null&&this._vLayer===null)for(let l=e;l<n;l++)for(let h=s;h<r;h++){let o=l+h*this.tileDim[0],u=this._data[o];u>=0&&this.spriteSheet.drawIndexed(i,u,l,h)}else if(this._aLayer&&this._vLayer){const l=this._aLayer,h=this._vLayer,o=i.globalAlpha,u=this._data;for(let d=e;d<n;d++)for(let c=s;c<r;c++){let f=d+c*this.tileDim[0],m=u[f];m>=0&&h[f]>0&&(l[f]===0?(i.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(i,m,d,c),i.globalAlpha=o):this.spriteSheet.drawIndexed(i,m,d,c))}}this._data._cacheData=t}}class ht extends vt{constructor(t={}){super(),this._layerData=[this._data],this.numLayers=1,this.activeLayer=0,this.visibilityLayer=-1,this.alphaLayer=-1,t&&this.updateProperties(t)}on_alphaLayer(t,i,e){this._aLayer=this.alphaLayer>=0?this._layerData[this.alphaLayer]:null}on_visibilityLayer(t,i,e){this._vLayer=this.visibilityLayer>=0?this._layerData[this.visibilityLayer]:null}serialize(){const t={},i=[];for(let e of this._layerData)i.push(e.slice());return t._layerData=i,t.activeLayer=this.activeLayer,t.numLayers=this.numLayers,t.tileDim=this.tileDim.slice(),t.spriteSheet=Array(...p.resources.keys()).find(e=>p.resources[e]===this.spriteSheet)??null,t}deserialize(t){this.numLayers=t.numLayers,this.activeLayer=t.activeLayer,this.tileDim=new y(t.tileDim??[0,0]);const i=t._layerData.length;this._layerData.length=i;for(let e=0;e<i;e++){const s=this._layerData[e],n=t._layerData[e];for(let r=0;r<n.lenth;r++)s[r]=n[r]}this.spriteSheet=p.resources[t.spriteSheet]??null,this.clearCache()}on_tileDim(t,i,e){if("_layerData"in this){for(let s of this._layerData)this._data=s,this.resizeData();this.activeLayer>=0&&(this._data=this._layerData[this.activeLayer]),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new y(this.tileDim)}}on_numLayers(t,i,e){const s=this._layerData.length;this._layerData.length=this.numLayers;for(let n=s;n<this.numLayers;n++){const r=new V(this.tileDim).fill(this.defaultValue);this._layerData[n]=r}this.activeLayer>=this.numLayers&&(this.activeLayer=this.numLayers-1)}on_activeLayer(t,i,e){this._data=this._layerData[this.activeLayer]}get layer(){return this._layerData}getFromLayer(t,i){return this._layerData[t][i[0]+i[1]*this.tileDim[0]]}setInLayer(t,i,e){this._layerData[t][i[0]+i[1]*this.tileDim[0]]=e,this._layerData[t]._cacheData=null}clearCache(){for(let t of this._layerData)t._cacheData=null}draw(t,i){for(let e of this._layerData)e.hidden||(this._data=e,super.draw(t,i));this._data=this._layerData[this.activeLayer]}}p.registerClass("Widget",z,"");p.registerClass("App",p,"");p.registerClass("Label",G,"");p.registerClass("Button",Xt,"");p.registerClass("ToggleButton",bt,"");p.registerClass("BasicButton",Ot,"");p.registerClass("TextInput",qt,"");p.registerClass("CheckBox",Et,"");p.registerClass("Slider",Vt,"");p.registerClass("ImageWidget",Nt,"");p.registerClass("BoxLayout",nt,"");p.registerClass("GridLayout",Ut,"");p.registerClass("ScrollView",rt,"");p.registerClass("ModalView",$t,"");p.registerClass("Notebook",_t,"");p.registerClass("TabbedNotebook",Gt,"");p.registerClass("SpriteWidget",Z,"");p.registerClass("TileMap",vt,"");p.registerClass("LayeredTileMap",ht,"");const A={north:0,east:1,south:2,west:3,none:4},I={0:j(0,-1),1:j(1,0),2:j(0,1),3:j(-1,0),4:j(0,0)},tt={0:1,1:2,2:4,3:8,4:0};function Jt(a){return a[1]<0?0:a[0]>0?1:a[1]>0?2:a[0]<0?3:4}class X extends Z{visible=!0;constructor(t={}){super(),t&&this.updateProperties(t)}get traversible(){return 15}get allowsSight(){return 15}updateVisibility(t){return t.get(this.pos)>0}interact(t,i){return!1}}class Qt extends X{state="open";animationState="open";lockState="unlocked";timePerFrame=100;visible=!1;oneShot=!0;animationGroup={closed:[39],open:[new E([3111],[[.5,-.5]])],closing:[new E([7],[[0,-.25]])],opening:[new E([7],[[0,-.25]])],flattened:[new E([40,8],[[0,-.5],[0,-1.5]])],destroyed:[new E([9,41],[[0,-.5],[0,-1.5]])],falling:[10],exploding:[41]};constructor(t={}){super(),this.spriteSheet=p.resources.sprites,t&&this.updateProperties(t)}placeDoor(t,i){this.pos=t,this.facing=i}on_state(t,i,e){switch(this.state){case"closed":this.animationState="closing";break;case"open":this.animationState="opening";break;case"destroyed":this.animationState="exploding";break;case"flattened":this.animationState="falling";break}}get traversible(){return this.state!=="closed"?15:0}get allowsSight(){return this.state==="closed"?0:this.facing===A.north?5:this.facing===A.east?10:this.facing===A.south?5:10}updateVisibility(t){if(super.updateVisibility(t))return!0;const i=(this.facing+3)%4,e=this.pos.add(I[this.facing]),s=e.add(I[i]);return t.get(e)>0||t.get(s)>0}interact(t,i){if(i instanceof it&&this.lockState==="locked"&&this.state==="closed")return!1;if(this.state==="closed"){this.state="open",t.metaTileMap.layer[_.traversible].set(this.pos,this.traversible);const e=(this.facing+3)%4,s=(this.facing+1)%4,n=(this.facing+2)%4,r=this.pos.add(I[this.facing]),l=r.add(I[e]),h=this.allowsSight;return t.metaTileMap.layer[_.allowsSight].set(this.pos,15),t.metaTileMap.layer[_.layout].get(r)===g.floor&&t.metaTileMap.layer[_.allowsSight].set(r,h|tt[s]),t.metaTileMap.layer[_.layout].get(l)===g.floor&&t.metaTileMap.layer[_.allowsSight].set(l,h&~tt[n]|tt[e]),!0}if(this.state==="open"){this.state="closed",t.metaTileMap.layer[_.allowsSight].set(this.pos,this.allowsSight),t.metaTileMap.layer[_.traversible].set(this.pos,this.traversible);const e=(this.facing+3)%4,s=this.pos.add(I[this.facing]),n=s.add(I[e]);return t.metaTileMap.layer[_.layout].get(s)===g.floor&&t.metaTileMap.layer[_.allowsSight].set(s,15),t.metaTileMap.layer[_.layout].get(n)===g.floor&&t.metaTileMap.layer[_.allowsSight].set(n,15),!0}return!1}on_animationState(t,i,e){this.animationGroup&&(this.frames=this.animationGroup[this.animationState])}on_animationComplete(t,i,e){switch(this.animationState){case"closing":this.animationState="closed";break;case"opening":this.animationState="open";break;case"exploding":this.animationState="destroyed";break;case"falling":this.animationState="flattened";break}}draw(t,i){this.visible&&super.draw(t,i)}}const ot={randy:{standing:[S([326,4388],[[0,0],[0,-.25]])],walking:[S([323,4387],[[0,0],[0,-.25]]),S([324,4387],[[0,0],[0,-.25]]),S([4420,4388],[[0,0],[0,-.25]]),S([4419,4389],[[0,0],[0,-.25]]),S([4420,4389],[[0,0],[0,-.25]]),S([324,4388],[[0,0],[0,-.25]])],dead:[S([321,289],[[0,1],[0,0]])]},maria:{standing:[S([422,4484],[[0,0],[0,-.25]])],walking:[S([419,4483],[[0,0],[0,-.25]]),S([420,4483],[[0,0],[0,-.25]]),S([4516,4484],[[0,0],[0,-.25]]),S([4515,4485],[[0,0],[0,-.25]]),S([4516,4485],[[0,0],[0,-.25]]),S([420,4484],[[0,0],[0,-.25]])],dead:[S([417,385],[[0,1],[0,0]])]},greenShirt:{standing:[S([614,4676],[[0,0],[0,-.25]])],walking:[S([611,4675],[[0,0],[0,-.25]]),S([612,4675],[[0,0],[0,-.25]]),S([4708,4676],[[0,0],[0,-.25]]),S([4707,4677],[[0,0],[0,-.25]]),S([4708,4677],[[0,0],[0,-.25]]),S([612,4676],[[0,0],[0,-.25]])],dead:[S([609,577,641],[[0,1],[0,0]])]},whiteShirt:{standing:[S([518,484],[[0,0],[0,-.25]])],walking:[S([515,483],[[0,0],[0,-.25]]),S([516,483],[[0,0],[0,-.25]]),S([4612,484],[[0,0],[0,-.25]]),S([4611,4579],[[0,0],[0,-.25]]),S([4612,4579],[[0,0],[0,-.25]]),S([516,484],[[0,0],[0,-.25]])],dead:[S([513,481,545],[[0,1],[0,0]])]}};function te(a,t,i){if(t.equals(i))return[i];let e=new V(a.tileDim).fill(1/0);e.set(t,0);let s=[t],n=[],r=!1;for(;s.length>0&&!r;){let o=[];for(let d of s)for(let c of a.iterAdjacent(d)){let f=a.get(c);e.get(d)+f<e.get(c)&&(c.equals(i)&&(r=!0),e.set(c,e.get(d)+f),f>1&&!r?n.push([c,f]):o.push(c))}const u=[];for(let d of n)d[1]>1?(d[1]--,u.push(d)):o.push(d[0]);n=u,s=o}const l=[];if(e.get(i)===1/0)return l;let h=i;for(;!h.equals(t);){let o=1/0,u=null;for(let d of e.iterAdjacent(h)){const c=e.get(d);c<o&&(o=c,u=d)}l.unshift(h),u!==null&&(h=u)}return l}class q extends X{actions=new Set;actionInventory=null;facing=A.north;constitution=1;priorState="patrolling";state="patrolling";resumeState="patrolling";animationState="standing";animationGroup=null;gpos=j(0,0);patrolRoute=[];patrolTarget=-1;actionsThisTurn=2;visibleToPlayer=!1;history=[];suppressed=!1;movementBlockedCount=0;_coverPositions=new Set;_visibleLayer=new V;activeCharacter=!1;constructor(t={}){super(),this.spriteSheet=p.resources.sprites,this.frames=[452],this.w=1,this.h=1,t&&this.updateProperties(t)}on_actionInventory(t,i,e){if(this.actionInventory){const s=[];for(let n of this.actions)n.hints={w:"3",h:"3"},this.actionInventory.addChild(n);this.actionInventory.children=s}}addAction(t){return this.actions.has(t)?!1:(this.actions.add(t),t.hints={w:"3",h:"3"},this.actionInventory&&this.actionInventory.addChild(t),!0)}removeAction(t){return this.actions.has(t)?(this.actions.delete(t),this.actionInventory&&this.actionInventory.removeChild(t),!0):!1}on_animationState(t,i,e){this.animationGroup&&(this.frames=this.animationGroup[this.animationState])}canSee(t,i){const e=i.metaTileMap.layer[_.allowsSight],s=i.metaTileMap.layer[_.cover],n=e.tileDim[0];let r=!1;for(let l of e.iterInBetween(this.gpos,t.gpos)){if(e[l[0]+l[1]*n]===0||r)return!1;r=s[l[0]+l[1]*n]>0}return!0}setupForLevelStart(t,i){this._coverPositions=new Set,this._visibleLayer=new V([t.w,t.h]).fill(0);let e=0,s=j(1,1),n=j(1,1);for(;e<1e3&&(e++,s=Y(i.getRandomPos(t.w,t.h)),t.metaTileMap.layer[_.layout].get(s)!==g.floor););for(e=0;e<1e3&&(e++,n=Y(i.getRandomPos(t.w,t.h)),!(t.metaTileMap.layer[_.layout].get(n)===g.floor&&n.dist(s)>15)););this.patrolRoute=[s,n],this.gpos=Y(n),[this.x,this.y]=this.gpos,this.animationGroup=this.id[0]==="d"?ot.greenShirt:ot.whiteShirt,this.animationState="standing"}rest(t){this.actionsThisTurn--,this.activeCharacter&&(this.updateFoV(t),this.updateCamera(t))}move(t,i){const e=this.gpos.add(I[t]),n=i.metaTileMap.getFromLayer(_.traversible,e);if(this.facing=t,n&tt[t])if(i.characters.reduce((r,l)=>r||l.gpos.equals(e)&&l.state!=="dead",!1))this.movementBlockedCount++;else{this.pos=Y(this.gpos),this.gpos=e;const r=new gt;r.add({x:this.gpos[0],y:this.gpos[1]},300),r.start(this),this.animationGroup!==null&&(this.animationState="walking",this.timePerFrame=60),this.actionsThisTurn--,this.movementBlockedCount=Math.max(this.movementBlockedCount-1,0)}else{for(let r of i.entities.children)if(r instanceof X&&r.pos.equals(e)){r.interact(i,this),this.actionsThisTurn--;break}this instanceof it&&i.metaTileMap.layer[_.layout].get(e)===g.window&&(i.metaTileMap.layer[_.layout].set(e,g.brokenWindow),i.updateTileInfo(e))}this.activeCharacter&&(this.updateFoV(i),this.updateCamera(i))}on_animationComplete(t,i,e){(this.animationState="walking")&&(this.animationState="standing")}takeDamage(t){t==="piercing"&&(this.state="dead",this.animationState="dead")}useAction(t,i,e){}updateFoV(t){const i=t.metaTileMap;this._coverPositions.clear(),this._visibleLayer.fill(0),i.activeLayer=_.allowsSight;const e=this.gpos;for(let s of i.data.iterRectBoundary(new C([...this.gpos,20,20]).translate([-10,-10]).translate(I[this.facing].scale(9)))){const n=Y(s);let r=Y(this.gpos),l=!1,h=n.sub(e).scale(1/n.dist(e));Math.abs(h[0])>Math.abs(h[1])?h[1]=0:Math.abs(h[1])>Math.abs(h[0])&&(h[0]=0);for(let o of i.data.iterBetween(e,n)){let u=Y([Math.round(o[0]),Math.round(o[1])]),d=i.get(r),c=i.get(u),f=!1;if((e.equals(o)||h[1]<0&&h[0]===0&&d&1&&c&4||h[1]<0&&h[0]>0&&d&1&&c&8&&d&2&&c&4||h[0]>0&&h[1]===0&&d&2&&c&8||h[1]>0&&h[0]>0&&d&4&&c&1&&d&2&&c&8||h[1]>0&&h[0]===0&&d&4&&c&1||h[1]>0&&h[0]<0&&d&4&&c&1&&d&8&&c&2||h[0]<0&&h[1]===0&&d&8&&c&2||h[1]<0&&h[0]<0&&d&1&&c&4&&d&8&&c&2)&&(f=!0),l=!1,!e.equals(o)&&!r.equals(e)&&(h[1]<0&&d&16||h[1]<0&&h[0]>0&&(d&16||d&32)||h[0]>0&&d&32||h[1]>0&&h[0]>0&&(d&64||d&32)||h[1]>0&&d&64||h[1]>0&&h[0]<0&&(d&64||d&128)||h[0]<0&&d&128||h[1]<0&&h[0]<0&&(d&16||d&128))&&(l=!0),r=Y(u),f&&!l?(this._visibleLayer[u[0]+u[1]*i.w]=1,this.activeCharacter&&i.setInLayer(_.seen,u,1)):(c===0&&(this._visibleLayer[u[0]+u[1]*i.w]=1,this.activeCharacter&&i.setInLayer(_.seen,u,1)),l&&this._coverPositions.add(u)),!f)break}}for(let s of t.entities.children)s instanceof X&&(s.visible=s.updateVisibility(this._visibleLayer));t.tileMap.clearCache()}updateCamera(t){const i=p.get().findById("scroller");if(i){const e=this.gpos.add(I[this.facing].scale(5)),s=e.dist(this.gpos);let n=Math.min(Math.max(e[0]+.5-i.w/i.zoom/2,0),t.w),r=Math.min(Math.max(e[1]+.5-i.h/i.zoom/2,0),t.h);const l=p.get().tileSize;n=Math.floor(n*l)/l,r=Math.floor(r*l)/l;const h=new gt;h.add({scrollX:n,scrollY:r},250*s/2),h.start(i)}}takeAction(t,i,e={}){if(this.actions.has(t)){const s=t.request(this,i,e);return s.result==="complete"&&(this.history.push([t,e]),this.actionsThisTurn--),s}return{result:"notAvailable"}}takeTurn(t){for(t.updateCharacterVisibility(!0);this.actionsThisTurn>0;)if(this.state==="patrolling"){if(this.patrolTarget<0&&(this.patrolTarget=0),this.patrolRoute.length===0)break;this.gpos.equals(this.patrolRoute[this.patrolTarget])&&(this.patrolTarget=(this.patrolTarget+1)%this.patrolRoute.length);const i=this.gpos,e=this.patrolRoute[this.patrolTarget],s=new V([t.w,t.h]);t.metaTileMap.layer[_.layout].forEach((r,l)=>{s[l]=r===g.wall||r===g.window||r===g.coveredWindow?1/0:1});for(let r of t.characters)r!==this&&s.set(r.gpos,s.get(r.gpos)+(r.movementBlockedCount<=this.movementBlockedCount?4+this.movementBlockedCount*2:4));const n=te(s,i,e);n.length>0&&(this.move(Jt(n[0].sub(this.gpos)),t),this.history.push([new dt,{}])),this.actionsThisTurn--,t.updateCharacterVisibility(!0)}else this.state==="dead"&&this.actionsThisTurn--;this.actionsThisTurn=2}draw(t,i){(this.activeCharacter||this.visibleToPlayer)&&super.draw(t,i)}}class it extends q{constructor(t={}){super(),this.spriteSheet=p.resources.sprites,this.frames=[259],t&&this.updateProperties(t)}setupForLevelStart(t){this._coverPositions=new Set,this.animationGroup=ot[this.id],this.animationState="standing",this.activeCharacter?(this._visibleLayer=t.metaTileMap._layerData[_.visible],this._visibleLayer.fill(0)):this._visibleLayer=new V([t.w,t.h]).fill(0)}canSee(t,i){const e=this._visibleLayer,[s,n]=t.gpos;return e[s+n*e.tileDim[0]]>0}getActionForKey(t){return[...this.actions].find(i=>i.keyControl===t)}}class dt extends nt{orientation="vertical";keyControl="";constructor(t={}){super(),this.hints={h:"5"},this.sprite=new Z({spriteSheet:p.resources.sprites}),this.label=new G({hints:{h:"1"}}),this.children=[this.sprite,this.label],t&&this.updateProperties(t)}request(t,i,e){return{result:"notAvailable"}}get name(){return this.label.text}set name(t){this.label.text=t}}class ee extends dt{keyControl="f";constructor(){super(),this.label.text="Rifle",this.sprite.frames=[736],this.ammo=200,this.mode="single"}request(t,i,e){if(e.targetCharacter instanceof q&&e.targetCharacter!==t)return this.fire(t,i,e.targetCharacter)?{result:"complete",message:"Target hit"}:{result:"complete",message:"Target missed"};if(this.ammo>0){const s=[];for(let n of i.characters)n!==t&&t.canSee(n,i)&&s.push(n);return s.length>0?{message:"Select target",result:"infoNeeded",validTargetCharacters:s}:{message:"No visible target",result:"notAvailable"}}else return{message:"Out of ammo",result:"notAvailable"}}fire(t,i,e){this.ammo-=this.mode==="single"?1:5;const s=e;return(this.mode==="single"?!0:i.rng.random()>.5)?(s.takeDamage("piercing"),!0):!1}}const _={layout:0,seen:1,visible:2,traversible:3,allowsSight:4,allowsSound:5,cover:6,moveCost:7},g={outside:0,floor:1,hallway:2,water:3,wall:4,doorway:5,window:6,coveredWindow:7,brokenWindow:8},ie={tree:163},st={0:103,1:74},se={1:1120,2:96,4:1120,8:96,5:1120,10:96,3:97,6:1121,12:2145,9:3169,7:1122,11:98,13:3170,14:2146,15:99},R={wall:new K("mansionWalls",[g.wall],[g.wall,g.doorway,g.window],se),doorway:new K("mansionDoorway",[g.doorway],[g.wall,g.doorway,g.window],{1:74,2:74,4:74,8:74,5:74,10:74}),window:new K("mansionWindow",[g.window],[g.wall,g.doorway,g.window],{1:3109,2:37,4:1061,8:2085,5:3109,10:37}),coveredWindow:new K("mansionCoveredWindow",[g.coveredWindow],[g.wall,g.doorway,g.window,g.coveredWindow],{1:3109,2:37,4:1061,8:2085,5:3109,10:37}),brokenWindow:new K("mansionBrokenWindow",[g.brokenWindow],[g.wall,g.doorway,g.window,g.coveredWindow,g.brokenWindow],{1:3110,2:38,4:1062,8:2086,5:3110,10:38})};function ne(a,t){const i=t.w,e=t.h,s=t.pos;for(let n of a.data.iterBetween(s,s.add([i,0])))a.set(n,g.wall);for(let n of a.data.iterBetween(s,s.add([0,e])))a.set(n,g.wall);for(let n of a.data.iterBetween(s.add([0,e]),s.add([i,e])))a.set(n,g.wall);for(let n of a.data.iterBetween(s.add([i,0]),s.add([i,e])))a.set(n,g.wall)}function J(a,t,i,e){const s=t.add(I[0]),n=t.add(I[1]),r=t.add(I[2]),l=t.add(I[3]),h=a.get(s),o=a.get(n),u=a.get(r),d=a.get(l);if(h===g.wall&&u===g.wall){if(o!==g.wall&&d==g.outside||d!==g.wall&&o==g.outside)return a.set(t,g.window),e.push(t),!0;if(o!==g.wall&&d!==g.wall)return a.set(t,g.doorway),i.push([t,1]),!0}if(o===g.wall&&d===g.wall){if(h!==g.wall&&u==g.outside||u!==g.wall&&h==g.outside)return a.set(t,g.window),e.push(t),!0;if(h!==g.wall&&u!==g.wall)return a.set(t,g.doorway),i.push([t,0]),!0}return!1}function re(a,t){for(let i of a.data.iterRect([t[0],t[1],t[2]+1,t[3]+1]))a.set(i,g.hallway)}function le(a,t){for(let i of a.data.iterRect([t[0]+1,t[1]+1,t[2]-1,t[3]-1]))a.set(i,g.floor);ne(a,t)}function ae(a){for(let t of a.data.iterAll())if(a.data.get(t)===g.hallway)for(let i of a.data.iterInRange(t,1.5)){const e=a.data.get(i);if(e===g.floor||e===g.outside){a.data.set(t,g.wall);break}}for(let t of a.data.iterAll())a.data.get(t)===g.hallway&&a.data.set(t,g.floor)}function he(a,t,i,e,s){if(!a.data.hasTypesBetween([t[0],t[1]],[t[0]+t[2],t[1]],[g.doorway,g.floor])){const n=t[0]+1+s.getRandomInt(t[2]-2);let r=n;for(;!J(a,new y([r,t[1]]),i,e)&&(r++,r>=t.right&&(r=t[0]+1),r!==n););}if(!a.data.hasTypesBetween([t[0],t[1]+t[3]],[t[0]+t[2],t[1]+t[3]],[g.doorway,g.floor])){const n=t[0]+1+s.getRandomInt(t[2]-2);let r=n;for(;!J(a,new y([r,t[1]+t[3]]),i,e)&&(r++,r>=t.right&&(r=t[0]+1),r!==n););}if(!a.data.hasTypesBetween([t[0],t[1]],[t[0],t[1]+t[3]],[g.doorway,g.floor])){const n=t[1]+1+s.getRandomInt(t[3]-2);let r=n;for(;!J(a,new y([t[0],r]),i,e)&&(r++,r>=t.bottom&&(r=t[1]+1),r!==n););}if(!a.data.hasTypesBetween([t[0]+t[2],t[1]],[t[0]+t[2],t[1]+t[3]],[g.doorway,g.floor])){let n=t[1]+1+s.getRandomInt(t[3]-2),r=n;for(;!J(a,new y([t[0]+t[2],n]),i,e)&&(r++,r>=t.bottom&&(r=t[1]+1),r!==n););}}function oe(a,t){return a.x<=t.x||a.y<=t.y||a.right>=t.right||a.bottom>=t.bottom}function ue(a,t){const i=a.x<t.right&&a.right>t.x,e=a.y<t.bottom&&a.bottom>t.y;return i&&(a.y===t.bottom||a.bottom===t.y)||e&&(a.x===t.right||a.right===t.x)}function wt(a,t){for(let i of t)if(ue(a,i))return!0}function H(a,t,i,e,s,n,r=.5,l=0,h=0){if(a.w<t*2&&a.h<t*2)return e.push(a),!0;const o=a.w<t+i?0:a.h<t+i||a.w>a.h?1:a.h<a.w?0:s.random()>r?1:0,u=a.x<=0||a.y<=0||a.right>=n.w||a.bottom>=n.h;if(o===0){if(!u&&a.h>=2*t+i&&a.w>t&&s.random()>h){const f=Math.floor((a.h-2*t-i)/4),m=Math.floor(s.random()*(a.h-2*t-i-2*f))+t+f;if(H(new C([a.x,a.y+m,a.w,i]),t,i,e,s,n,0,l,h))return H(new C([a.x,a.y,a.w,m]),t,i,e,s,n,0,l,h),H(new C([a.x,a.y+m+i,a.w,a.h-m-i]),t,i,e,s,n,0,l,h),!0}const d=Math.floor((a.h-2*t)/4),c=Math.floor(s.random()*(a.h-2*t-2*d))+t+d;H(new C([a.x,a.y,a.w,c]),t,i,e,s,n,0,l,h),H(new C([a.x,a.y+c,a.w,a.h-c]),t,i,e,s,n,0,l,h)}else{if(!u&&a.w>=2*t+i&&a.h>t&&s.random()>l){const f=Math.floor((a.w-2*t-i)/4),m=Math.floor(s.random()*(a.w-2*t-i-2*f))+t+f;if(H(new C([a.x+m,a.y,i,a.h]),t,i,e,s,n,1,l,h))return H(new C([a.x,a.y,m,a.h]),t,i,e,s,n,1,l,h),H(new C([a.x+m+i,a.y,a.w-m-i,a.h]),t,i,e,s,n,1,l,h),!0}const d=Math.floor((a.w-2*t)/4),c=Math.floor(s.random()*(a.w-2*t-2*d))+t+d;H(new C([a.x,a.y,c,a.h]),t,i,e,s,n,1,l,h),H(new C([a.x+c,a.y,a.w-c,a.h]),t,i,e,s,n,1,l,h)}return!0}function de(a,t){a.w=80,a.h=40;const[i,e]=[a.w,a.h],s=new y([a.w,a.h]),n=a.tileMap;n.useCache=!0,n.numLayers=3,n.tileDim=s,n.activeLayer=0;const r=a.metaTileMap;r.defaultValue=0,r.numLayers=8,r.tileDim=s,r.activeLayer=0;for(const w of r.data.iterAll())r.set(w,g.outside);const l=[],h=new C([0,0,i,e]);H(h,5,3,l,t,h);const o=l.filter(w=>oe(w,h)),u=l.filter(w=>!o.includes(w)),d=u.filter(w=>wt(w,o));let c=u.filter(w=>!d.includes(w)&&w.w>3&&w.h>3);c.sort((w,b)=>(b.w<=3||b.h<=3?-100:b.w*b.h)-(w.w<=3||w.h<=3?-100:w.w*w.h));const f=[];for(;c.length>.04*u.length;)u.splice(u.indexOf(c[0]),1),f.push(c.shift()),c=u.filter(w=>!wt(w,[...o,...f])&&w.w>3&&w.h>3),c.sort((w,b)=>(b.w<=3||b.h<=3?-100:b.w*b.h)-(w.w<=3||w.h<=3?-100:w.w*w.h));for(let w of u)(w.w<=3||w.h<=3)&&re(r,w);for(let w of u)w.w>3&&w.h>3&&le(r,w);ae(r);const m=[],T=[];for(let w of u)he(r,w,m,T,t);for(let[w,b]of m){const M=new Qt;M.pos=w,M.w=1,M.h=1,M.facing=b,M.state="closed",a.entities.addChild(M)}const k=[];for(let w of r.data.iterAll()){const b=r.get(w);if(b===g.outside&&t.random()>.95&&k.push(w),b in st)n.set(w,st[b]);else{const D=new y(w);R.wall.autoTile(D,r,n),R.doorway.autoTile(D,r,n),R.window.autoTile(D,r,n),R.brokenWindow.autoTile(D,r,n)}let M=b===g.wall||b===g.window?0:15;for(let D of a.entities.children)D instanceof X&&D.pos.equals(w)&&(M&=D.traversible);r.setInLayer(_.traversible,w,M)}n.activeLayer=1;const L=r._layerData[_.allowsSight];r.activeLayer=_.layout;for(let w of r.data.iterAll()){r.setInLayer(_.seen,w,r.data.numInRange(w,[g.outside],1.5)>0?1:0);const b=r.getFromLayer(_.layout,w),M=w[0]+w[1]*i;L[M]|=b===g.wall?0:15;for(let D of a.entities.children)D instanceof X&&D.pos.equals(w)&&(L[M]&=D.allowsSight)}for(let w of k){n.set(w,ie.tree);const b=w[0]+w[1]*i;L[b]|=240}n._vLayer=r._layerData[_.seen],n._aLayer=r._layerData[_.visible],n.clearCache()}class ce extends z{_validCells=[];_validCharacters=[];activeCell=-1;constructor(t={}){super(),t&&this.updateProperties(t)}set validCharacters(t){this._validCharacters=t,this._validCells=this.validCharacters.map(i=>i.gpos),this.setupValidCells()}get validCharacters(){return this._validCharacters}set validCells(t){this._validCharacters=[],this._validCells=t,this.setupValidCells()}get validCells(){return this._validCells}setupValidCells(){const t=[];let i=0;for(let e of this._validCells)t.push(new Z({spriteSheet:p.resources.sprites,x:e[0],y:e[1],w:1,h:1,frames:[this.activeCell===i?6:5]})),i++;this.children=t,this.activeCell=this._validCells.length>0?0:-1}on_activeCell(t,i,e){let s=0;for(let n of this.children)n instanceof Z&&(n.frames=[this.activeCell===s?6:5]),s++}moveActiveCell(t){const i=this.validCells[this.activeCell];let e=0,s=1/0,n=-1,r=this.activeCell,l=0;for(let h of this.validCells){const o=h.sub(i),u=o.mul(t).sum()+j(1,1).sub(t.abs()).mul(o).sum();u>0&&u<s&&(s=u,n=l),u<0&&u<e&&(e=u,r=l),l++}this.activeCell=n>=0?n:r}}class fe extends z{rng=new mt;clipRegion=new C;tileMap=new ht;metaTileMap=new ht;enemies=[new q({id:"alfred"}),new q({id:"bennie"}),new q({id:"charlie"}),new q({id:"devon"})];entities=new z({hints:{h:1,w:1}});playerCharacters=[new it({id:"randy",x:0,y:0,activeCharacter:!0}),new it({id:"maria",activeCharacter:!1})];characters=[...this.enemies,...this.playerCharacters];activeCharacter=this.playerCharacters[0];spriteSheet=null;constructor(t=null){super(),this.positionSelector=new ce,this.children=[this.tileMap,this.entities,this.positionSelector,...this.enemies,...this.playerCharacters],t&&this.updateProperties(t)}setupLevel(){de(this,this.rng),this.playerCharacters[0].setupForLevelStart(this,this.rng),this.enemies.forEach(t=>t.setupForLevelStart(this,this.rng)),this.playerCharacters[0].actionInventory=p.get().findById("firstPlayerInventory"),this.playerCharacters[0].addAction(new ee)}on_spriteSheet(){this.tileMap.spriteSheet=this.spriteSheet}on_parent(t,i,e){const s=this.parent;s instanceof rt&&(s.bind("scrollX",(n,r,l)=>this.updateClipRegion(r)),s.bind("scrollY",(n,r,l)=>this.updateClipRegion(r)),s.bind("zoom",(n,r,l)=>this.updateClipRegion(r)),this.updateClipRegion(s))}updateTileInfo(t){const i=this.metaTileMap.layer[_.layout].get(t),e=this.metaTileMap;e.activeLayer=_.layout;const s=this.tileMap;s.activeLayer=0,i in st?(s.set(t,st[i]),s.clearCache()):(R.wall.autoTile(t,e,s),R.doorway.autoTile(t,e,s),R.window.autoTile(t,e,s),R.brokenWindow.autoTile(t,e,s));let n=i===g.wall||i===g.window?0:15;for(let l of this.entities.children)l instanceof X&&l.pos.equals(t)&&(n&=l.traversible);this.metaTileMap.setInLayer(_.traversible,t,n);let r=i===g.wall?0:15;for(let l of this.entities.children)l instanceof X&&l.pos.equals(t)&&(r&=l.allowsSight);this.metaTileMap.setInLayer(_.allowsSight,t,r)}updateClipRegion(t){this.tileMap.clipRegion=new C([Math.floor(t._scrollX),Math.floor(t._scrollY),Math.ceil(t.w/t.zoom),Math.ceil(t.h/t.zoom)])}updateCharacterVisibility(t=!1){this.activeCharacter;for(let i of this.enemies)t&&(i.visibleToPlayer=!1),i.visibleToPlayer=i.visibleToPlayer||this.activeCharacter?._visibleLayer.get(i.gpos)===1}targetSelector(t,i,e){}prompt(t,i){}getCharacterAt(t){for(let i of this.characters)if(i.gpos.equals(t))return i;return null}}const pe=""+new URL("spritesheet-BdhrULeS.png",import.meta.url).href,ge=`

Game:
    prefDimW: 20
    prefDimH: 21
    integerTileSize: true
    tileSize: 16
    Notebook:
        hints: {w:1, h:1}
        id: 'notebook'
        BoxLayout:
            id: 'game'
            orientation: 'vertical'
            hints: {center_x:0.5, center_y:0.5, w:1, h:1}
            BoxLayout:
                hints: {h:'1'}
                orientation: 'horizontal'
                FPS:
                    align:'left'
                Label:
                    id: 'messageLabel'
                    text: 'Welcome to the mansion'
                    align: 'left'
                Button: 
                    text: 'Help'
                    hints: {w: '3'}
                    on_press:
                        const help = window.app.findById('help');
                        help.helpVal = 0;
                        const nb = window.app.findById('notebook');
                        nb.activePage = 1;
                Button: 
                    text:  \`\${scroller.zoom*100}%\`
                    hints: {w: '3'}
                    id: 'zoomButton'
                    on_press:
                        const scroller = window.app.findById('scroller');
                        if(!scroller) return;
                        const zoom = Math.floor(scroller.zoom + 1);
                        scroller.zoom = zoom<4? zoom:0.5;
            BoxLayout:
                bgColor: 'rgb(35,35,45)'
                orientation: 'horizontal'
                BoxLayout:
                    orientation: 'vertical'
                    hints: {w:'4'}
                    id: 'firstPlayer'
                    Label:
                        text:\`Randy \${randy.gpos}\`
                        hints: {h:'1'}
                        sizeGroup: 'actionItems'
                        align: 'left'
                    SpriteWidget:
                        spriteSheet: resources['sprites']
                        frames: [354]
                        hints: {w:'3', h:'3'}
                    BoxLayout:
                        hints: {h:null}
                        id: 'firstPlayerInventory'
                    Widget:
                        id: 'padding2'
                BoxLayout:
                    hints: {w:'4', h:null}
                    padding: '2'
                    orientation: 'vertical'
                    id: 'secondPlayer'
                    Widget:
                        id: 'padding2'
                    BoxLayout:
                        hints: {h:null}
                        id: 'secondPlayerInventory'
                    Label:
                        text:\`Maria \${Maria.status}\`
                        wrap: true;
                        hints: {h:'1'}
                        sizeGroup: 'actionItems'
                        align: 'right'
                    SpriteWidget:
                        spriteSheet: resources['sprites']
                        frames: [450]
                        hints: {w:'3', h:'3'}
                ScrollView:
                    id: 'scroller'
                    uiZoom: false
                    hints: {h:'20'}
                    MissionMap:
                        id: 'MissionMap'
                        hints: {w:null, h:null}
                        spriteSheet: resources['sprites']
        BoxLayout:
            hints: {h:1, w:1}
            h:20
            w:20
            orientation:'vertical'
            bgColor: 'rgb(25,25,35)'
            id: 'help'
            paddingX: '1'
            paddingY: '1'
            helpVal: 0
            on_helpVal:
                this.parent._needsLayout=true;
                const helpHeader = window.app.findById('helpHeader');
                helpHeader.text = [
                    'Controls',
                    'Instructions',
                    'Backstory',
                    'Agent Randy',
                    'Agent Maria',
                    'Director Stevens',
                    'Conrad Couli',
                    'Flint Ironsights',
                    'Mitch Crawford',
                    'Roland Kennedy',
                    'Irvina Schlitz',                            
                ][this.helpVal];
                const helpText = window.app.findById('helpText');
                helpText.text = [
                    'Use W/A/S/D to move, space to pause, 1-4 to use items.',
                    'Navigate the level to complete the mission objectives.',
                    'Intro: In the 22nd century, mankind has moved to the stars and conquered space. However, the realm of time is still one that has eluded them. Until now. Deep in the Unified Space Governments most classified labs, the beginnings of time looping technology are being created.'+ 
                    '\\n\\nHowever, such a powerful technology always attracts those who want to use it for evil. Thanks to an inside mole, a group of reckless idealists have managed to get their hands on this technology. This group wants to wield the tech on a global sale by selling it to the highest bidder in violation of arms control laws. They hope that this will be the final step needed to bring about the final revolution that will ultimately achieve a stable universal government and a world where history can finally, truly be rewritten.'+
                    '\\n\\nGiven the severity of the situation, the Unified Space Government has given two of their top agents a secret, limited, and local version of the time loop tech to provide an edge on missions so that they can stop the syndicate before its too late.',
                    'Player Character 1. A tanky close-combat specialist. He began his work as a soldier fighting on the frontlines of various conflicts. His combat skills, even during severe ammo shortages, were noticed by those around him and he rose through the ranks. His special training included close-quarters combat training and cybernetic augments that make him more resilient to damage.',
                    'Player Character 2. A stealthy ranged specialist. A former agent in the United Space Governments Intelligence division, she specialized in monitoring and, on occasion, eliminating targets with a minimum of fuss. She trained in the use of firearms and being able to move quickly yet silently.',
                    'The no-nonsense director of the player characters unit, who provides important details before each mission.',
                    'The head of one of the galaxys leading space travel companies, along with several companies that have gone bankrupt thanks to his leadership. His wealthy eccentricity, combined with an unhealthy interest in government-based conspiracy theories, has led him to offer financial assistance to the criminal conspiracy.',
                    'One of the galaxys most notorious dealers in military-grade and black market weapons. Often sells weapons to both sides in wars and may have helped stared a few.',
                    'A defector from the galaxys main government. Formerly a high-ranking agent, theyre believed to be the main suspect in leaking the time loop technology.',
                    'A moderate-ranking politician on a highly urbanized planet. He reached his current position by appealing to jingoists and is rumored to be linked to a few notorious hate groups. ',
                    'A scientist with an incredible curiosity and a severe lack of empathy and restraint. They have avoided the authorities as they performed immoral experiments in highly regulated fields. Getting to field test a technology as powerful as time looping would be the height of her career.',
                ][this.helpVal];
                const helpSprite = window.app.findById('helpSprite');
                helpSprite.frames = [
                    [0], [0], [0], [355], [451], [0], [832], [833],[0],[834],[835]
                ][this.helpVal];
            Label:
                id: 'helpHeader'
                hints: {h:'2'}
            SpriteWidget:
                id: 'helpSprite'
                spriteSheet: resources['sprites']
                hints: {w:'3', h:'3'}
            Label:
                id: 'helpText'
                fontSize: '0.5'
                wrap: true
                vAlign: 'top'
                hints: {h:null}
            BoxLayout:
                hints: {h:'1', w:'8'}
                orientation: 'horizontal'
                Button:
                    text: 'Next'
                    bgColor: 'rgb(15,15,25)'
                    on_press:
                        const help = window.app.findById('help');
                        help.helpVal = (help.helpVal+1)%9;
                Button:
                    text: 'Exit'
                    bgColor: 'rgb(15,15,25)'
                    on_press:
                        const nb = window.app.findById('notebook');
                        nb.activePage = 0;
                
`;class we extends G{_counter=0;_frames=0;_worst=300;_tref=Date.now();_badFrameCount=0;update(t,i){super.update(t,i);const e=Date.now();this._counter+=e-this._tref,this._frames+=1;const s=1e3/(e-this._tref);this._tref=e,this._badFrameCount+=s<50?1:0,s<this._worst&&(this._worst=s),this._counter>=1e3&&(this.text=`FPS: ${Math.round(this._frames/this._counter*1e3)} (worst: ${Math.round(this._worst)}, # >20ms: ${Math.round(this._badFrameCount)})`,this._counter=0,this._frames=0,this._worst=300,this._badFrameCount=0)}}class F extends p{activePlayerAction=null;activePlayerActionData=null;constructor(t={}){super(),F.resources.sprites=new Zt(pe,16),this.continuousFrameUpdates=!0,window.focus(),this.canvas?.focus(),t&&this.updateProperties(t)}static get(){return p.get()}on_key_down(t,i,e){const s=this.inputHandler;if(s===void 0)return;const n=this.findById("MissionMap"),r=this.findById("randy"),l=this.findById("messageLabel");if(this.activePlayerAction){const h=this.activePlayerAction,o=this.activePlayerActionData,u=n.positionSelector;if(o?.validTargetCharacters)if(s.isKeyDown("w"))u.moveActiveCell(I[A.north]);else if(s.isKeyDown("a"))u.moveActiveCell(I[A.west]);else if(s.isKeyDown("s"))u.moveActiveCell(I[A.south]);else if(s.isKeyDown("d"))u.moveActiveCell(I[A.east]);else if(s.isKeyDown("e")){o.targetCharacter=u.validCharacters[u.activeCell];const d=r.takeAction(h,n,o);d.result==="complete"&&(u.validCells=[],l.text=d.message??"unknown action response",this.activePlayerAction=null,this.activePlayerActionData=null)}else s.isKeyDown("Escape")&&(u.validCells=[],l.text="canceled",this.activePlayerAction=null,this.activePlayerActionData=null)}else{const h=r.getActionForKey(e.event.key);if(h){const o=r.takeAction(h,n);if(o.result==="complete"||o.result==="notAvailable"||o.result==="invalid")this.activePlayerAction=null,this.activePlayerActionData=null,l.text=o.message??"unknown action response";else if(o.result==="infoNeeded"){this.activePlayerAction=h,this.activePlayerActionData=o;const u=n.positionSelector;l.text=o.message??"unknown action response",o.validTargetCharacters&&(u.validCharacters=o.validTargetCharacters),o.validTargetPositions&&(u.validCells=o.validTargetPositions)}}else if(s.isKeyDown("w"))r.move(A.north,n);else if(s.isKeyDown("a"))r.move(A.west,n);else if(s.isKeyDown("s"))r.move(A.south,n);else if(s.isKeyDown("d"))r.move(A.east,n);else if(s.isKeyDown(" "))r.rest(n);else if(s.isKeyDown("v")){const o=F.get().findById("scroller");o instanceof rt&&o.zoom&&(o.zoom=.5);for(let u of n.metaTileMap.layer[_.seen].iterAll())n.metaTileMap.setInLayer(_.seen,u,1),n.tileMap.clearCache()}else return}if(n.updateCharacterVisibility(),r.actionsThisTurn===0){for(let h of n.enemies)h.takeTurn(n);r.actionsThisTurn=2,n.updateCharacterVisibility(!0)}}}F.registerClass("Action",dt,"Label");F.registerClass("FPS",we,"Label");F.registerClass("Game",F,"App");F.registerClass("MissionMap",fe,"Widget");Ht(ge);const St=F.get(),me=St.findById("MissionMap");me.setupLevel();St.start();
