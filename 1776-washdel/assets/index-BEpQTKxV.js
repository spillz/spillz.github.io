var Wt=Object.defineProperty;var Bt=(n,t,e)=>t in n?Wt(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var o=(n,t,e)=>Bt(n,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const h of a.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();function Rt(n,t){for(let e=1e3;e>0;e--)if(t())return;throw"Timeout while trying to "+n}function it(n,t=0){return t!=0?n+Math.floor(Math.random()*(t-n)):Math.floor(Math.random()*n)}function At(n,t){return[it(n),it(t)]}function Tt(n){let t=n.length,e;for(;t!=0;)e=Math.floor(Math.random()*t),t--,[n[t],n[e]]=[n[e],n[t]];return n}function P(n){return n[Math.floor(Math.random()*n.length)]}function It(n,t){const e=n.slice(),s=e.length,i=Math.min(t,s);for(let a=0;a<i;a++){const h=a+Math.floor(Math.random()*(s-a));[e[a],e[h]]=[e[h],e[a]]}return e.slice(0,i)}class L extends Array{constructor(...t){t.length==1&&t[0]instanceof Array?super(...t[0]):super(...t)}sum(){let t=0;return this.forEach(e=>t+=e),t}mean(){return this.sum()/this.length}max(){return Math.max.apply(null,this)}min(){return Math.min.apply(null,this)}vars(){let t=0;return this.forEach(e=>t+=e*e),(t-this.length*this.mean()^2)/(this.length-1)}var(){let t=0;return this.forEach(e=>t+=e*e),t/this.length-this.mean()^2}std(){return Math.sqrt(this.var())}add(t){let e=new L(this);if(t instanceof Array||t instanceof L)for(let s=0;s<this.length;s++)e[s]+=t[s];else for(let s=0;s<this.length;s++)e[s]+=t;return e}mul(t){let e=new L(this);if(t instanceof Array||t instanceof L)for(let s=0;s<this.length;s++)e[s]*=t[s];else for(let s=0;s<this.length;s++)e[s]*=t;return e}dot(t){return this.mul(t).sum()}abs(){return Math.abs.apply(null,this)}shift(t){let e=new L;for(let s=-t;s<this.length-t;s++)s<0||s>=this.length?e.push(NaN):e.push(this[s]);return e}filter(t){return new L(super.filter(t))}dropNaN(){return this.filter(t=>!Number.isNaN(t))}}class p extends Array{constructor(t){super(),this[0]=t[0],this[1]=t[1]}static random(t){return new p(At(t[0],t[1]))}add(t){return new p([this[0]+t[0],this[1]+t[1]])}subtract(t){return new p([this[0]-t[0],this[1]-t[1]])}scale(t){return new p([this[0]*t,this[1]*t])}mul(t){return new p([this[0]*t[0],this[1]*t[1]])}dot(t){return this[0]*t[0]+this[1]*t[1]}dist(t){return Math.hypot(this[0]-t[0],this[1]-t[1])}set x(t){this[0]=t}set y(t){this[1]=t}get x(){return this[0]}get y(){return this[1]}}class w extends Array{constructor(t){super(),this.length=4,this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3]}set x(t){this[0]=t}set y(t){this[1]=t}set w(t){this[2]=t}set h(t){this[3]=t}set pos(t){this[0]=t[0],this[1]=t[1]}get pos(){return new p([this[0],this[1]])}get x(){return this[0]}get y(){return this[1]}get w(){return this[2]}get h(){return this[3]}get right(){return this[0]+this[2]}get bottom(){return this[1]+this[3]}get center_x(){return this[0]+this[2]/2}get center_y(){return this[1]+this[3]/2}get center(){return new p([this.center_x,this.center_y])}shift(t){return new w([this.x+t[0],this.y+t[1],this.w,this.h])}shrinkBorders(t){return new w([this.x+t,this.y+t,this.w-t*2,this.h-t*2])}scale(t,e=!0){if(e){let s=[this[2]*t,this[3]*t];return new w([this[0]+.5*(this[2]-s[0]),this[1]+.5*(this[3]-s[1]),s[0],s[1]])}else{let s=[this[2]*t,this[3]*t];return new w([this[0],this[1],s[0],s[1]])}}collide(t){return this.x<t.x+t.w&&this.x+this.w>t.x&&this.y<t.y+t.h&&this.h+this.y>t.y}contact(t){return this.x<=t.x+t.w&&this.x+this.w>=t.x&&this.y<=t.y+t.h&&this.h+this.y>=t.y}}function pt(n,t){return Math.floor(Math.random()*(t-n+1))+n}function wt(n,t=20){let e="";return n.forEach(s=>{s+="";for(let i=s.length;i<t;i++)s+=" ";e+=s}),e}function yt(n,t,e,s,i="IM Fell English SC"){n.font=s+"px "+i;const a=t.split(`
`),h=[];for(let r of a){const l=r.split(/\s+/);let d="";for(let f of l){const m=d?d+" "+f:f;n.measureText(m).width>e&&d?(h.push(d),d=f):d=m}d&&h.push(d)}return h}function mt(n,t,e,s,i,a=10,h="IM Fell English SC",r=1.2){n.font=a+"px "+h,n.fillStyle=i,n.textBaseline="top";const l=a*r;for(let d=0;d<t.length;d++)n.fillText(t[d],e,s+d*l);return t.length*l}class H{constructor(t,e=0){this.elapsed=0,this.timer=t,this.triggered=!1,e>0&&this.tick(e)}finished(){return this.elapsed>=this.timer}tick(t){return this.elapsed>=this.timer?(this.triggered&&(this.triggered=!1),!1):(this.elapsed+=t,this.elapsed>=this.timer?(this.triggered=!0,!0):!1)}reset(t=-1,e=0){this.elapsed=e,this.triggered=!1,t>=0&&(this.timer=t)}}const M={left:!1,right:!1,up:!1,down:!1,cycle:!1,use:!1,dodge:!1,dash:!1,camera:!1,menu:!1};var Mt={...M};function dt(){return{...Mt}}var z={...M};({...M});function Lt(n){z={...n}}var q=null,zt={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down",a:"left",d:"right",w:"up",s:"down",j:"dash",k:"dodge",l:"cycle",i:"use"," ":"dash",z:"dodge",x:"dash",c:"cycle",v:"use",0:"camera",Escape:"menu"};class ut{constructor(){this.controlStates={...Mt},this.attachToPlayer(),window.addEventListener("blur",t=>{this.clearPressedAll()},{passive:!1})}attachToPlayer(t=null){this.player=t,q=this,t!=null&&(this.player.controller=this)}set(t,e=!0){M[t]=e,q=this;let s=this.player;s!=null&&(s.controlStates[t]=e)}clearPressedAll(){for(const t in this.controlStates)this.controlStates[t]=!1}vibrate(t,e,s){}}class Ot extends ut{constructor(t,e=null){super(),this.game=t,e==null&&(e=zt),this.keyMap=e;let s=this;document.onkeydown=function(i){s.keyDownHandler(i)},document.onkeyup=function(i){s.keyUpHandler(i)}}keyDownHandler(t){if(this.game.gameState==="title"&&this.game.music===null&&this.game.playTitleMusic(),t.key=="p"&&(this.game.fillScreen=!this.game.fillScreen,this.game.updateWindowSize()),t.key=="f"&&(this.game.showFPS=!this.game.showFPS,this.game.updateWindowSize()),t.key=="G"&&(this.game.cullOffCamera=!this.game.cullOffCamera),t.key=="C"&&this.game.gameState==="running"&&this.game.activePlayers.length>0&&this.game.activeChapter<this.game.chapters.length-1){const e=this.game.activePlayers[0],s=this.game.chapters[this.game.activeChapter+1];e.pos=new p(s.startPos),this.game.camera.pos=new p([-e.pos.x+this.game.camera.viewPortW/2,-e.pos.y+this.game.camera.viewPortH/2]),e.setState(this.game,s.startState),this.game.nextChapter()}t.key=="H"&&this.game.gameState==="running"&&this.game.activePlayers.length>0&&this.game.activePlayers[0].hp++,t.key=="T"&&this.game.gameState==="running"&&this.game.activePlayers.length>0&&(this.game.activePlayers[0].pos=new p([19,21]),this.game.camera.pos=new p([-19+this.game.camera.viewPortW/2,-21+this.game.camera.viewPortH/2])),t.key in this.keyMap&&this.set(this.keyMap[t.key],!0)}keyUpHandler(t){t.key in this.keyMap&&this.set(this.keyMap[t.key],!1)}}class _t extends ut{constructor(t,e){super(),this.game=t,this.gamepad=e,this.thresh=.2,this.internalStates={...this.controlStates}}set(t,e=!0){this.internalStates[t]!=e&&(this.internalStates[t]=e,super.set(t,e))}vibrate(t,e,s){this.game.activePlayers.length==1&&window.navigator.vibrate(s),this.gamepad.vibrationActuator!=null&&this.gamepad.vibrationActuator.playEffect("dual-rumble",{startDelay:0,duration:s,weakMagnitude:t,strongMagnitude:e})}}class Et{constructor(t){o(this,"gamepads",{});let e=this;this.game=t,window.addEventListener("gamepadconnected",function(s){e.connected(s)}),window.addEventListener("gamepaddisconnected",function(s){e.disconnected(s)})}connected(t){this.gamepads[t.gamepad.index]=new _t(this.game,t.gamepad)}disconnected(t){let e=this.gamepads[t.gamepad.index];e.player!=null&&(e.player.dead=!0,e.player.dropFromGame=!0),delete this.gamepads[t.gamepad.index]}updateGamepadStates(){let t=navigator.getGamepads();if(t!=null)for(let e of t){if(e==null)continue;let s=this.gamepads[e.index];s.gamepad=e,s.set("dash",this.buttonPressed(e.buttons[0])),s.set("cycle",this.buttonPressed(e.buttons[1])||this.buttonPressed(e.buttons[6])),s.set("use",this.buttonPressed(e.buttons[2])||this.buttonPressed(e.buttons[7])),s.set("dodge",this.buttonPressed(e.buttons[5])),s.set("camera",this.buttonPressed(e.buttons[12])),s.set("menu",this.buttonPressed(e.buttons[9])),s.set("left",e.axes[0]<-s.thresh&&e.axes[0]<-.5*Math.abs(e.axes[1])),s.set("right",e.axes[0]>s.thresh&&e.axes[0]>.5*Math.abs(e.axes[1])),s.set("up",e.axes[1]<-s.thresh&&e.axes[1]<-.5*Math.abs(e.axes[0])),s.set("down",e.axes[1]>s.thresh&&e.axes[1]>-.5*Math.abs(e.axes[0]))}}buttonPressed(t){return typeof t=="object"?t.pressed:t==1}attachAllToPlayer(t){for(let e of Object.keys(this.gamepads))this.gamepads[e].attachToPlayer(t)}releaseAllPlayers(){for(let t of Object.keys(this.gamepads))this.gamepads[t].attachToPlayer()}}class Yt extends ut{constructor(e){super();o(this,"canvas");this.game=e;const s=document.getElementById("canvas");if(s instanceof HTMLCanvasElement){this.canvas=s;let i=this;s.addEventListener("touchstart",function(a){i.processTouchstart(a)},!1),s.addEventListener("touchmove",function(a){i.processTouchmove(a)},!1),s.addEventListener("touchcancel",function(a){i.processTouchend(a)},!1),s.addEventListener("touchend",function(a){i.processTouchend(a)},!1)}this.dPad=[-1,0,0],this.butMenu=[-1,0,0],this.butDodge=[-1,0,0],this.butDash=[-1,0,0],this.butInv=[-1,0,0],this.butCamera=[-1,0,0]}processBack(e){this.set("menu",!0)}processTouchstart(e){let s=this.canvas;e.touches[0];for(let i of e.changedTouches)i.clientX<.5*s.width?i.clientY>.33*s.height?this.dPad=[i.identifier,i.clientX,i.clientY]:(this.set("camera"),this.butCamera=[i.identifier,i.clientX,i.clientY]):i.clientY>.66*s.height?(this.set("dash"),this.butDash=[i.identifier,i.clientX,i.clientY]):i.clientY<.33*s.height?(this.set("menu"),this.butMenu=[i.identifier,i.clientX,i.clientY]):(this.set("dodge"),this.butDodge=[i.identifier,i.clientX,i.clientY]);e.preventDefault()}processTouchmove(e){for(let s of e.changedTouches)if(s.identifier==this.dPad[0]){let i=this.dPad[1],a=this.dPad[2];for(let h of["left","right","up","down","run","camera"])this.set(h,!1);this.set("left",s.clientX<i-.1*this.game.tileSize*this.game.pixelSize&&s.clientX-i<-.5*Math.abs(s.clientY-a)),this.set("right",s.clientX>i+.1*this.game.tileSize*this.game.pixelSize&&s.clientX-i>.5*Math.abs(s.clientY-a)),this.set("up",s.clientY<a-.1*this.game.tileSize*this.game.pixelSize&&s.clientY-a<-.5*Math.abs(s.clientX-i)),this.set("down",s.clientY>a+.1*this.game.tileSize*this.game.pixelSize&&s.clientY-a>.5*Math.abs(s.clientX-i)),this.set("run",s.clientX<i-this.game.tileSize*this.game.pixelSize||s.clientX>i+this.game.tileSize*this.game.pixelSize||s.clientY>a+this.game.tileSize*this.game.pixelSize||s.clientY<a-this.game.tileSize*this.game.pixelSize)}e.preventDefault()}processTouchend(e){for(let s of e.changedTouches){if(s.identifier==this.dPad[0]){for(let i of["left","right","up","down"])this.set(i,!1);this.dPad=[-1,0,0]}s.identifier==this.butInv[0]&&this.set("cycle",!1),s.identifier==this.butMenu[0]&&this.set("menu",!1),s.identifier==this.butDodge[0]&&this.set("dodge",!1),s.identifier==this.butDash[0]&&this.set("dash",!1)}e.preventDefault()}vibrate(e,s,i){window.navigator.vibrate(i)}}function c(n,t){return[n,t]}function v(n,t,e,s){return[n,t,e,s]}function G(n,t){return n}class Xt{constructor(t,e,s=16,i=1,a=!1){if(this.spriteSize=s,this.pad=i,this.game=t,this.sheetStride=this.spriteSize+this.pad,i>0&&!a){const h=new Image;h.onload=()=>{this._createPaddedImage(h)},h.src=e,this.sheet=new Image}else this.sheet=new Image,this.sheet.src=e}_createDoublePaddedImage(t){const e=this.pad,s=this.spriteSize,i=s+e,a=Math.floor(t.width/s),h=Math.floor(t.height/s),r=document.createElement("canvas");r.width=a*i,r.height=h*i;const l=r.getContext("2d");l.imageSmoothingEnabled=!1;for(let d=0;d<h;d++)for(let f=0;f<a;f++){const m=f*s,S=d*s,k=f*i+e,R=d*i+e;l.drawImage(t,m,S,s,s,k,R,s,s)}this.sheet.src=r.toDataURL()}_createPaddedImage(t){const e=this.pad,s=Math.floor(t.width/this.spriteSize),i=Math.floor(t.height/this.spriteSize),a=this.spriteSize+e,h=document.createElement("canvas");h.width=s*a,h.height=i*a;const r=h.getContext("2d");r.imageSmoothingEnabled=!1;for(let l=0;l<i;l++)for(let d=0;d<s;d++){const f=d*this.spriteSize,m=l*this.spriteSize,S=d*a,k=l*a;r.drawImage(t,f,m,this.spriteSize,this.spriteSize,S,k,this.spriteSize,this.spriteSize)}this.sheet.src=h.toDataURL()}get ctx(){return this.game.offscreenCtx}draw(t,e,s,i=!1){const[a,h]=t,r=this.sheetStride,l=a*r,d=h*r;let f=i?-1:1;i&&this.ctx.scale(-1,1),this.ctx.drawImage(this.sheet,l,d,this.spriteSize,this.spriteSize,f*G(e,this.spriteSize),G(s,this.spriteSize),f,1),i&&this.ctx.scale(-1,1)}drawMainContext(t,e,s,i=!1){const[a,h]=t,r=this.sheetStride;this.game.tileSize*this.game.pixelSize;const l=a*r,d=h*r;let f=i?-1:1;i&&this.ctx.scale(-1,1),this.game.ctx.drawImage(this.sheet,l,d,this.spriteSize,this.spriteSize,f*G(e),G(s),f,1),i&&this.ctx.scale(-1,1)}drawScaled(t,e,s,i,a=!1){const[h,r]=t,l=this.sheetStride,d=h*l,f=r*l;let m=a?-1:1;a&&this.ctx.scale(-1,1),this.ctx.drawImage(this.sheet,d,f,this.spriteSize,this.spriteSize,m*e,s,m*i,i),a&&this.ctx.scale(-1,1)}drawRotated(t,e,s,i,a=!1,h="center"){const[r,l]=t,d=this.sheetStride;this.game.tileSize*this.game.pixelSize;const f=r*d,m=l*d;this.ctx.save(),h=="center"?h=[.5,.5]:h=[h[0],h[1]],this.ctx.translate(G(e)+h[0],G(s)+h[1]),this.ctx.rotate(i*Math.PI/180),a&&this.ctx.scale(-1,1),this.ctx.translate(-h[0],-h[1]),this.ctx.drawImage(this.sheet,f,m,this.spriteSize,this.spriteSize,0,0,1,1),this.ctx.restore()}drawRotatedMultitileUnpadded(t,e,s,i,a=!1,h="center"){const[r,l,d,f]=t,m=this.sheetStride,S=r*m,k=l*m;this.ctx.save(),h=h==="center"?[d/2,f/2]:h,this.ctx.translate(e+h[0],s+h[1]),this.ctx.rotate(i*Math.PI/180),a&&this.ctx.scale(-1,1),this.ctx.translate(-h[0],-h[1]),this.ctx.drawImage(this.sheet,S,k,d*this.spriteSize,f*this.spriteSize,0,0,d,f),this.ctx.restore()}drawRotatedMultitile(t,e,s,i,a=!1,h="center"){const[r,l,d,f]=t,m=this.sheetStride,S=this.spriteSize;this.game.tileSize*this.game.pixelSize,this.ctx.save(),h=h==="center"?[d/2,f/2]:h,this.ctx.translate(G(e)+h[0],G(s)+h[1]),this.ctx.rotate(i*Math.PI/180),a&&this.ctx.scale(-1,1),this.ctx.translate(-h[0],-h[1]);const k=r+d,R=l+f;let D=r,y=Math.floor(D+1);for(;D<k;){const g=y-D,E=Math.floor(D)*m+(1-g)*S,j=g*S;let O=l,N=Math.floor(O+1);for(;O<R;){const lt=N-O,Ft=Math.floor(O)*m+(1-lt)*S,Ct=lt*S,Ht=D-r,Dt=O-l;this.ctx.drawImage(this.sheet,E,Ft,j,Ct,Ht,Dt,g,lt),O=N,N+=Math.min(1,R-N)}D=y,y+=Math.min(1,k-y)}this.ctx.restore()}}const u=Object.freeze({Health:c(12,0),Snow1:c(0,4),Snow2:c(1,4),Snow3:c(2,4),Snow4:c(3,4),ShoreSW:c(4,4),ShoreNE:c(6,4),ShoreS:c(5,4),ShoreN:c(7,4),RoadNS:c(4,5),RoadEW:c(5,5),Water1:c(0,5),Water2:c(1,5),Water3:c(2,5),Water4:c(3,5),Iceberg1:c(0,6),Iceberg2:c(1,6),Iceberg3:c(2,6),SnowFlake1:c(3,6),SnowFlake2:c(6,6),SnowFlake3:c(7,6),Sleet:c(5,6),CannonBall:c(7,3),RedBullet:c(8,3),OrangeBullet:c(9,3),PiercingBullet:c(10,3),Cheese:c(12,1),Sausage:c(13,1),StoneHighlighted:c(42,0),Stone:c(43,0),RiverStone:c(44,0),Sword1:c(30,0),Sword2:c(31,0),Sword3:c(32,0),Pistol1:c(33,0),Pistol2:c(34,0),Pistol3:c(35,0),Pistol4:c(36,0),Pistol5:c(38,0),Pistol6:c(39,0),Pistol7:c(40,0),Pistol8:c(41,0),HessianHelmet1:c(10,1),HessianHelmet2:c(11,1),Rifle1:c(10,2),Rifle2:c(11,2),Washington1:c(0,0),Washington2:c(1,0),Washington3:c(2,0),Washington4:c(3,0),Washington5:c(4,0),Washington6:c(5,0),WashingtonDodge:c(20,0),WashingtonSunglasses:c(9,0),Soldier1:c(0,1),Soldier2:c(4,1),Soldier3:c(3,1),Soldier4:c(2,1),Soldier5:c(1,1),SoldierFall:c(5,1),SoldierIcecube:c(6,1),SoldierDead:c(7,1),SoldierHat:c(9,1),Hessian1:c(0,2),Hessian2:c(1,2),Hessian3:c(2,2),Hessian4:c(3,2),Hessian5:c(4,2),HessianDaed:c(5,2),HessianLB1:c(11,3),HessianLB2:c(12,3),HessianLB3:c(13,3),HessianLB4:c(14,3),HessianLB5:c(15,3),HessianLB6:c(16,3),HessianLBSword:c(17,3),HessianLBRifle:c(18,3),Empty:c(15,15),BeachUpper:c(4,0),BeachLower:c(5,0),Water:c(6,0),Jelly:c(11,1),Cannonball:c(13,2),Wall:c(8,0),WallEnd:c(9,0),Pillar1:c(6,1),Pillar2:c(7,1),Pillar3:c(8,1),Slash:c(10,7),Strike:c(10,7),Cutlas:c(11,7),Crab:c(6,4),Chips:c(16,0),Treasure:c(16,0),Boot1:c(16,0),Boot2:c(16,0),Boot3:c(16,0),Boom:c(16,0),Key:c(16,0),Pickup1:c(16,0),Pickup2:c(16,0),Shot1:c(15,0),Shot2:c(16,0),Shot3:c(16,0),LiveGrenade:c(16,0),Frag:c(16,0),LiveRocket:c(16,0),Drone1:c(16,0),LiveVibroBlade:c(16,0),Reticle:c(16,0),TrapBlade:c(16,0),Floor:c(16,0),Ledge:c(16,0),LockedExit:c(16,0),Exit:c(16,0),TrapBlock:c(16,0)}),x=Object.freeze({Rall1:v(1,13,1,2),RallHorsback:v(3,13,1,2),RallHorse1:v(0,10,3,3),BoatBack:v(0,9,4,1),BoatFront:v(4,9,4,1),BoatVerticle1:v(10,8,1,2),BoatVerticle2:v(12,8,1,2),Lantern1:v(3,7,1,2),Lantern2:v(4,7,1,2),Lantern3:v(5,7,1,2),Lantern4:v(6,7,1,2),Tree1:v(0,7,1,2),Tree2:v(1,7,1,2),Cannon:v(12,5,2,1),CanonNS:v(14,3,1,2),CanonEW:v(12,4,2,1),House1:v(0,16,3,3),House2:v(3,16,3,3),House3:v(6,16,3,3),BigHouseBlue:v(1,22,11,10),BigHouseRed:v(13,22,11,10),HouseBlue:v(25,22,8,7),HouseRed:v(34,22,8,7)});class _ extends w{constructor(t,e=null,s=!0,i=!1){super([t[0],t[1],1,1]),this.sprite=e,this.passable=s,this.climbable=i,this.climbSpeed=1/300,this.hp=100}bounds(){return new w([this.x,this.y,1,1])}dist(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}draw(t){this.sprite!=null&&t.sprites.base.draw(this.sprite,this.x,this.y)}playerInteract(t,e,s){}entityInteract(t,e,s){}initItems(t){}hitFrom(t,e,s,i){}}class W extends _{constructor(t,e=null){super(t,e,!0,!1)}}function jt(n){B.riverTimer+=n,B.riverSprite=[u.Water1,u.Water2,u.Water3,u.Water4][Math.floor(B.riverTimer/500)%4],Z.lanternTimer+=n,Z.lanternSprite=[x.Lantern1,x.Lantern2,x.Lantern3,x.Lantern4][Math.floor(Z.lanternTimer/500)%4]}class ct extends _{constructor(){super(...arguments);o(this,"passable",!1)}}class Nt extends _{constructor(e,s=null){s===null&&(s=P([x.Tree1,x.Tree2]));super(e,s,!0,!1);o(this,"passable",!1)}draw(e){e.sprites.base.draw(u.Snow1,this.x,this.y),e.sprites.base.drawRotatedMultitile(this.sprite,this.x,this.y-1,0)}}class xt extends _{constructor(e,s=null){s===null&&(s=u.Hessian1);super(e,s,!0,!1);o(this,"passable",!1);this.hat=P([!1,!1,!1,!1,!0])}draw(e){e.sprites.base.draw(u.Snow1,this.x,this.y),e.sprites.base.draw(this.sprite,this.x,this.y),this.hat&&e.sprites.base.draw(u.HessianHelmet1,this.x,this.y-.5)}}const Q=class Q extends _{constructor(t,e=null){super(t,e,!1,!1)}draw(t){t.sprites.base.draw(u.Snow1,this.x,this.y),Q.lanternSprite&&t.sprites.base.drawRotatedMultitile(Q.lanternSprite,this.x,this.y-1,0)}};o(Q,"lanternTimer",0),o(Q,"lanternSprite");let Z=Q;const st=class st extends _{constructor(e,s=null){super(e,s,!0,!1);o(this,"passable",!1)}draw(e){e.sprites.base.draw(st.riverSprite,this.x,this.y)}};o(st,"riverTimer",0),o(st,"riverSprite");let B=st;class at extends _{constructor(t,e=null){e==null&&(e=P([u.Snow1,u.Snow1,u.Snow1,u.Snow1,u.Snow1,u.Snow1,u.Snow2,u.Snow3])),super(t,e,!0,!1)}draw(t){super.draw(t)}}class T extends _{constructor(t,e=null){e==null&&(e=P([u.RoadNS,u.RoadEW])),super(t,e,!0,!1)}draw(t){super.draw(t)}}class V{constructor(t,e,s){this.tilemap=t,this.tile=e,this.pos=s}move(t,e){const s=new p([this.pos[0]+t,this.pos[1]+e]),i=this.tilemap.at(s);return new V(this.tilemap,i,s)}left(){return this.move(-1,0)}right(){return this.move(1,0)}above(){return this.move(0,-1)}below(){return this.move(0,1)}replace(t,...e){return this.tilemap.set(this.pos,t,...e),this.tile=t,this}getNeighbor(t,e){return this.move(t,e)}getAdjacentNeighbors(){return Tt([this.getNeighbor(0,-1),this.getNeighbor(0,1),this.getNeighbor(-1,0),this.getNeighbor(1,0)])}getAdjacentPassableNeighbors(){return this.getAdjacentNeighbors().filter(t=>t.tile.passable)}getConnectedTiles(){let t=[this],e=[this];for(;e.length;){let s=e.pop().getAdjacentPassableNeighbors().filter(i=>!t.includes(i));t=t.concat(s),e=e.concat(s)}return t}}class Gt{constructor(t,e){const s=new p([0,0]);this.startTile=new W(s),this.endTile=new W(s),this.dimW=t,this.dimH=e,this.array=[];for(let i=0;i<t;i++){this.array[i]=[];for(let a=0;a<e;a++)this.array[i][a]=new _([i,a])}}isValidPos(t){return t!=null&&t[0]>=0&&t[0]<this.dimW&&t[1]>=0&&t[1]<this.dimH}at(t){return this.isValidPos(t)?this.array[t[0]][t[1]]:new W(t)}get(t){const e=new p(t),s=this.at(e);return new V(this,s,e)}set(t,e,...s){if(!this.isValidPos(t))return null;let i=new e(t,...s);return this.array[t[0]][t[1]]=i,i}fillRect(t,e){for(let s of this.iterRectPos(t))this.set(s,e)}fillLine(t,e,s){const i=new p(t),a=new p(e),h=a[0]-i[0],r=a[1]-i[1],l=Math.max(Math.abs(h),Math.abs(r));for(let d=0;d<=l;d++){const f=new p([i[0]+h*d/l,i[1]+r*d/l]).map(Math.floor);this.set(f,s)}}fillCircle(t,e,s){for(let i of this.iterRange(t,e))this.set(i.pos,s)}leftOf(t){return new V(this,this.at([t[0],t[1]]),t).left()}rightOf(t){return new V(this,this.at([t[0],t[1]]),t).right()}above(t){return new V(this,this.at([t[0],t[1]]),t).above()}below(t){return new V(this,this.at([t[0],t[1]]),t).below()}*iterAllPos(){for(let t=0;t<this.dimW;t++)for(let e=0;e<this.dimH;e++)yield new p([t,e])}*iterRectPos(t){for(let e=Math.max(t.x,0);e<Math.min(t.right,this.dimW);e++)for(let s=Math.max(t.y,0);s<Math.min(t.bottom,this.dimH);s++)yield new p([e,s])}*iterAll(){for(let t=0;t<this.dimW;t++)for(let e=0;e<this.dimH;e++)yield this.at([t,e])}*iterRect(t){for(let e=t.x;e<t.right;e++)for(let s=t.y;s<t.bottom;s++){let i=this.at([e,s]);i instanceof W||(yield i)}}*iterRectBorder(t){for(let e=t.x;e<t.right;e++){let s=this.at([e,t.y]);s instanceof W||(yield s),s=this.at([e,t.bottom-1]),s instanceof W||(yield s)}for(let e=t.y;e<t.bottom;e++){let s=this.at([t.x,e]);s instanceof W||(yield s),s=this.at([t.right-1,e]),s instanceof W||(yield s)}}*iterRange(t,e){for(let s=Math.floor(t[0]-e);s<=Math.ceil(t[0]+e);s++)for(let i=Math.floor(t[1]-e);i<=Math.ceil(t[1]+e);i++)if(Math.hypot(t[0]-s,t[1]-i)<=e){let a=this.at([s,i]);a instanceof W||(yield a)}}*colliders(t){for(let e of this.iterRange([t.center_x-.5,t.center_y-.5],1.5))e.collide(t)&&(yield e)}*contacters(t){for(let e of this.iterRange([t.center_x-.5,t.center_y-.5],1.5))e.contact(t)&&(yield e)}*iterRandom(t=null,e=null,s=null,i=1){let a=t==null?this.iterAllPos():this.iterRectPos(t);for(let h of Tt(Array.from(a)))(e==null||this.at(h)instanceof e)&&(s==null||!(this.numNeighbors(h,s)<=i))&&(yield h)}hasNeighbors(t,e){for(let s of this.iterRange(t,1.5))if(this.at(s.pos)instanceof e)return!0;return!1}numNeighbors(t,e,s=1.5){let i=0;for(let a of this.iterRange(t,s))this.at(a.pos)instanceof e&&(i+=1);return i}closestTile(t){return this.at([Math.round(t.center_x-.5),Math.round(t.center_y-.5)])}closestPos(t){return new p([Math.round(t.x),Math.round(t.y)])}move(t,e=15,s=null){s===null&&(s=new p(t.vel));let i=t.pos.add([0,s.y*e]),a=t.bounds(i);for(let l of this.colliders(a))l.passable||(s.y>0&&a.bottom>l.y&&(i.y-=a.bottom-l.y,s.y=0,t.vel.y=0,a=t.bounds(i)),s.y<0&&a.y<l.bottom&&(i.y+=l.bottom-a.y,s.y=0,t.vel.y=0,a=t.bounds(i)));let h=i.add([s.x*e,0]),r=t.bounds(h);for(let l of this.colliders(r))l.passable||(s.x>0&&r.right>l.x&&(h.x-=r.right-l.x,s.x=0,t.vel.x=0,r=t.bounds(h)),s.x<0&&r.x<l.right&&(h.x+=l.right-r.x,s.x=0,t.vel.x=0,r=t.bounds(h)));t.pos=new p([h.x,i.y])}moveBoat(t,e=15,s=null){s===null&&(s=new p(t.vel));let i=t.pos.add([0,s.y*e]),a=t.bounds(i);for(let l of this.colliders(a))l instanceof B||(s.y>0&&a.bottom>l.y&&(i.y-=a.bottom-l.y,s.y=0,t.vel.y=0,a=t.bounds(i)),s.y<0&&a.y<l.bottom&&(i.y+=l.bottom-a.y,s.y=0,t.vel.y=0,a=t.bounds(i)));let h=i.add([s.x*e,0]),r=t.bounds(h);for(let l of this.colliders(r))l instanceof B||(s.x>0&&r.right>l.x&&(h.x-=r.right-l.x,s.x=0,t.vel.x=0,r=t.bounds(h)),s.x<0&&r.x<l.right&&(h.x+=l.right-r.x,s.x=0,t.vel.x=0,r=t.bounds(h)));t.pos=new p([h.x,i.y])}}class C{constructor(t,e){this.pos=new p([0,0]),this.vel=new p([0,0]),this.oldVel=new p([0,0]),this.angle=0,this.isPlayer=!1,this.size=new p([1,1]),this.boundingBox=new w([.25,.25,.5,.5]),this.boundingBoxes=[],this.facing=1,this.falling=!1,this.canFall=!0,this.dead=!1,this.sprite=e,this.hitBox=new w(this.boundingBox),t instanceof _||t===null?this.move(t):this.pos=new p(t),this.oldPos=new p(this.pos)}move(t){t!==null?this.pos=new p([t[0],t[1]]):this.pos=new p([-1,-1])}rotatedBoundingBox(t=null,e=null,s=null,i=null,a=null){s=s??this.getFlipped(),e=e??this.angle,t==null&&(t=this.sprite.length==2?[.5,.5]:[.5*this.sprite[2],.5*this.sprite[3]]),i==null&&(i=[this.boundingBox[0]+this.boundingBox[2]/2,this.boundingBox[1]+this.boundingBox[3]/2]),a==null&&(a=this.boundingBox.slice(2,4));let h=(i[0]-t[0])*(1-2*s),r=i[1]-t[1],l=Math.cos(e/180*Math.PI),d=Math.sin(e/180*Math.PI),f=-(h-h*l+r*d),m=-(r-h*d-r*l);return new w([(i[0]-t[0])*(1-2*s)+t[0]+f-a[0]/2,i[1]+m-a[1]/2,a[0],a[1]])}bounds(t=null,e=null){return t==null&&(t=this.pos),e==null&&(e=this.boundingBox!=null?this.boundingBox:this.boundingBoxes[0]),new w([t[0]+e[0],t[1]+e[1],e[2],e[3]])}hitBounds(t=null){return t==null&&(t=this.pos),new w([t[0]+this.hitBox[0],t[1]+this.hitBox[1],this.hitBox[2],this.hitBox[3]])}getDisplayX(){return this.pos.x}getDisplayY(){return this.pos.y}getFlipped(){return this.facing==-1}draw(t){t.sprites.base.draw([this.sprite[0],this.sprite[1]],this.getDisplayX(),this.getDisplayY(),this.getFlipped())}draw_bounds(t){const e=t.sprites.base.ctx;if(this.boundingBox!=null){let s=this.bounds(this.pos,this.boundingBox);e.beginPath(),e.lineWidth=t.tileSize/16,e.strokeStyle="#BAC3D9",e.rect(s[0],s[1],s[2],s[3]),e.stroke()}else for(let s of this.boundingBoxes){let i=this.bounds(this.pos,s);e.beginPath(),e.lineWidth=t.tileSize/16,e.strokeStyle="#BAC3D9",e.rect(i[0],i[1],i[2],i[3]),e.stroke()}}entityInteract(t,e,s){}entityCollide(t,e){}update(t,e){}}class Ut extends C{constructor(t,e=null){e==null&&(e=P([x.Tree1,x.Tree2])),super(t,e)}entityCollide(t,e){if(e.isPlayer){const[s,i,a,h]=e.bounds(),[r,l,d,f]=this.bounds(),m=Math.min(s+a-r,r+d-s),S=Math.min(i+h-l,l+f-i);m>0&&S>0&&(m<=S?e.pos[0]+=s<r?-m:m:e.pos[1]+=i<l?-S:S),e.vel[0]=0,e.vel[1]=0}}bounds(){return new w([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){t.sprites.base.drawRotatedMultitile(this.sprite,this.pos[0]-.5,this.pos[1]-1,0,!1)}}class A extends C{constructor(t,e=null){e==null&&(e=P([x.Tree1,x.Tree2])),super(t,e),this.boardable=!1}entityCollide(t,e){this.boardable&&e instanceof K&&e.bounds().collide(this.bounds())&&!this.dead&&t.activeChapter===0&&t.chapters[t.activeChapter].activeObjective===2&&(e.vel[0]=0,e.vel[1]=0,e.boardBoat(t,this),this.dead=!0)}bounds(){return new w([this.pos[0],this.pos[1],4,1])}draw(t){t.sprites.base.drawRotatedMultitile(x.BoatBack,this.pos[0],this.pos[1],0,!1),t.sprites.base.drawRotatedMultitile(x.BoatFront,this.pos[0],this.pos[1],0,!1)}}class Vt extends C{constructor(t,e=null){e==null&&(e=u.RiverStone),super(t,e)}entityCollide(t,e){if(e instanceof K&&e.activeState===F&&e.bounds().collide(this.bounds())){e.vel[0]=1/200,e.vel[1]=1/100;const s=new p([Math.round(e.pos.x),Math.round(e.pos.y)]);t.items.push(new b(s.add([2,1]),u.SoldierIcecube)),t.items.push(new b(s.add([1,2]),u.SoldierIcecube)),t.items.push(new b(s.add([0,1]),x.BoatVerticle1)),t.items.push(new b(s.add([-1,2]),u.SoldierIcecube)),t.items.push(new b(s.add([-2,1]),u.SoldierIcecube)),e.die(t),e.hidden=!0}}update(t,e){super.update(t,e)}bounds(){return new w([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){this.sprite.length===2?t.sprites.base.draw(this.sprite,this.pos[0],this.pos[1]):t.sprites.base.drawRotatedMultitile(this.sprite,this.pos[0]-(this.sprite[2]-1)/2,this.pos[1]-this.sprite[3]+1,0,!1)}}class b extends C{constructor(t,e=null){e==null&&(e=P([u.Iceberg1,u.Iceberg2,u.Iceberg3])),super(t,e),this.vel.x=1/200,this.vel.y=1/100}entityCollide(t,e){if(e instanceof K&&e.activeState===F&&e.bounds().collide(this.bounds())){e.vel[0]=1/200,e.vel[1]=1/100;const s=new p([Math.round(e.pos.x),Math.round(e.pos.y)]);t.items.push(new b(s.add([2,1]),u.SoldierIcecube)),t.items.push(new b(s.add([1,2]),u.SoldierIcecube)),t.items.push(new b(s.add([0,1]),x.BoatVerticle1)),t.items.push(new b(s.add([-1,2]),u.SoldierIcecube)),t.items.push(new b(s.add([-2,1]),u.SoldierIcecube)),e.die(t),e.hidden=!0}}update(t,e){super.update(t,e),this.pos=this.pos.add(this.vel.scale(e/15)),(this.pos.x<-1||this.pos.y<-1||this.pos.x>t.tiles.dimW||this.pos.y>t.tiles.dimH)&&(this.dead=!0)}bounds(){return new w([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){this.sprite.length===2?t.sprites.base.draw(this.sprite,this.pos[0],this.pos[1]):t.sprites.base.drawRotatedMultitile(this.sprite,this.pos[0]-(this.sprite[2]-1)/2,this.pos[1]-this.sprite[3]+1,0,!1)}}class Kt extends C{constructor(t,e=null){e==null&&(e=u.StoneHighlighted),super(t,e)}entityCollide(t,e){}bounds(){return new w([this.pos[0]+.2,this.pos[1]+.2,.6,.2])}}class tt extends C{constructor(t,e=null){e==null&&(e=P([x.HouseBlue,x.HouseRed])),super(t,e)}entityCollide(t,e){if(e.isPlayer){const[s,i,a,h]=e.bounds(),[r,l,d,f]=this.bounds(),m=Math.min(s+a-r,r+d-s),S=Math.min(i+h-l,l+f-i);m>0&&S>0&&(m<=S?e.pos[0]+=s<r?-m:m:e.pos[1]+=i<l?-S:S),e.vel[0]=0,e.vel[1]=0}}bounds(){return new w([this.pos[0],this.pos[1]+2,8,4.5])}draw(t){t.sprites.base.drawRotatedMultitile(this.sprite,this.pos[0],this.pos[1],0,!1)}}class Jt{constructor(){o(this,"flakes",[]);o(this,"maxFlakes",100);o(this,"fallSpeed",1/100);o(this,"xySpeed",1/200);o(this,"xWind",0);o(this,"yWind",0);o(this,"sprite",u.SnowFlake1)}reset(){this.flakes=[]}changeMode(t){t==="clear"?(this.flakes=[],this.maxFlakes=0):t==="snow"?(this.flakes=[],this.sprite=u.SnowFlake3,this.fallSpeed=1/50,this.maxFlakes=50,this.xySpeed=1/200,this.xWind=0):t==="heavySnow"?(this.flakes=[],this.sprite=u.SnowFlake1,this.fallSpeed=1/30,this.maxFlakes=150,this.xySpeed=1/50,this.xWind=-1/20):(this.flakes=[],this.sprite=u.Sleet,this.fallSpeed=1/3,this.xySpeed=0,this.xWind=-1/30)}update(t,e){const s=new w([t.camera.x,t.camera.y,t.camera.w,t.camera.h]);for(let i of this.flakes)i[0]<s.x&&(i[0]+=s.w),i[0]>s.right&&(i[0]-=s.w),i[1]<s.y&&(i[1]+=s.h),i[1]>s.bottom&&(i[1]-=s.h),i[2]-=(.5+.5*Math.random())*15/e*this.fallSpeed,i[1]+=(Math.random()-.5)*15/e*this.xySpeed+15/e*this.yWind,i[0]+=(Math.random()-.5)*15/e*this.xySpeed+15/e*this.xWind;for(this.flakes=this.flakes.filter(i=>i[2]>=0);this.flakes.length<this.maxFlakes;)this.flakes.push([s.x+Math.random()*s.w,s.y+Math.random()*s.h,Math.random()*s.h])}draw(t,e){for(let s of this.flakes)t.sprites.base.draw(this.sprite,s[0],s[1]-s[2])}}class Pt extends C{constructor(t,e=null,s){super(t,u.OrangeBullet),this.vel[0]=Math.cos(s*Math.PI/180)*1/150,this.vel[1]=Math.sin(s*Math.PI/180)*1/150,this.angle=s}entityCollide(t,e){e.isPlayer&&(e.hitFrom(t,this.pos,1,1),this.dead=!0)}update(t,e){super.update(t,e),t.tiles.move(this,e,this.vel.scale(e/15)),(this.pos.x<-1||this.pos.y<-1||this.pos.x>t.tiles.dimW||this.pos.y>t.tiles.dimH||this.vel.dist([0,0])===0)&&(this.dead=!0)}bounds(){return new w([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){this.sprite.length===2&&t.sprites.base.drawRotated(this.sprite,this.pos[0],this.pos[1],this.angle+180)}}class qt extends C{constructor(t,e=null,s=0){super(t,u.HessianLB1),this.vel[0]=Math.cos(s*Math.PI/180)*1/100,this.vel[1]=Math.sin(s*Math.PI/180)*1/100,this.angle=s}entityCollide(t,e){e.isPlayer&&(e.hitFrom(t,this.pos,1,1),this.dead=!0)}update(t,e){super.update(t,e),t.tiles.move(this,e,this.vel.scale(e/15)),(this.pos.x<-1||this.pos.y<-1||this.pos.x>t.tiles.dimW||this.pos.y>t.tiles.dimH||this.vel.dist([0,0])===0)&&(this.dead=!0)}bounds(){return new w([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){this.sprite.length===2&&t.sprites.base.draw(this.sprite,this.pos[0],this.pos[1])}}class Qt extends C{constructor(t,e=null,s){super(t,u.CannonBall);const i=Math.cos(s*Math.PI/180),a=Math.sin(s*Math.PI/180);this.vel[0]=i*1/20,this.vel[1]=a*1/20,this.pos[0]+=i,this.pos[1]+=a,this.angle=s}entityCollide(t,e){e.isPlayer&&(e.hitFrom(t,this.pos,1,1),this.dead=!0)}update(t,e){super.update(t,e),this.pos=this.pos.add(this.vel.scale(e/15)),(this.pos.x<-1||this.pos.y<-1||this.pos.x>t.tiles.dimW||this.pos.y>t.tiles.dimH)&&(this.dead=!0)}bounds(){return new w([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){this.sprite.length===2&&t.sprites.base.drawRotated(this.sprite,this.pos[0],this.pos[1],this.angle+90)}}class Zt extends C{constructor(t,e=1){super(t,u.Sausage),this.value=e}entityCollide(t,e){t.score++,e instanceof K&&(t.playSound("pickup2"),e.hp<e.maxHp&&e.hp++,this.dead=!0)}entityInteract(t,e,s){!this.dead&&e instanceof K&&(e.hp<e.maxHp&&e.hp++,t.score++,t.playSound("pickup2"),this.dead=!0)}}class $t extends C{constructor(t,e){super(t,[1,e.sprite[1]]),this.elapsed=0,this.timer=3e3}update(t,e){this.elapsed+=e,this.elapsed>this.timer&&(this.dead=!0)}draw(t){this.sprite.length===2&&t.sprites.players.draw(this.sprite,this.getDisplayX(),this.getDisplayY(),this.getFlipped())}}class te extends C{constructor(t,e){super(null,null),this.sound=t,this.delay=e,this.elapsed=0}update(t,e){this.elapsed+=e,this.elapsed>this.delay&&(t.playSound(this.sound),this.dead=!0)}draw(){}}class ee extends C{constructor(t,e=250){super(t,u.Boom),this.timer=e,this.elapsed=0}update(t,e){if(this.elapsed+=e,this.elapsed>=this.timer){this.dead=!0;let s=t.tiles.get(this.pos);s instanceof at||s.replace(at)}}}class se extends C{constructor(t){super(null,u.TrapBlade),this.platform=t,this.triggered=!1,t.type=="static"?this.pos=new p(this.platform.shift([0,-1])):this.pos=new p(this.platform),this.facing=1,this.boundingBox=new w([.125,.25,.75,.75]),this.elapsed=0}update(t,e){let s=this.platform;if(t.tiles.at(s.pos)!=s&&(this.dead=!0),this.elapsed+=e,s.type=="contact")if(this.pos.y==s.y&&this.vel.y==0){for(let a of t.activePlayers)if(a.bounds().collide(t.tiles.at(s).shift([0,-1]))){this.vel.y=-1/s.extendTime,this.elapsed=0;break}}else this.pos.y==s.y-1&&this.elapsed>=s.extendedTime&&(this.vel.y=1/s.extendTime,this.elapsed=0);else s.type=="cycling"&&(this.pos.y==s.y-1&&this.elapsed>=s.extendedTime&&(this.vel.y=1/s.extendTime,this.elapsed=0),this.pos.y==s.y&&this.elapsed>=s.retractedTime&&(this.vel.y=-1/s.extendTime,this.elapsed=0));for(let a of t.monsters_and_players())this.bounds().collide(a.bounds())&&(a.hitFrom(t,this.pos,s.damage,1),a.isPlayer||a.stun(500));let i=this.elapsed>s.contactDelay||s.type!=="contact"?this.vel.y:0;this.pos.y=Math.min(Math.max(this.pos.y+i*e,s.y-1),s.y),(this.pos.y==s.y-1&&this.vel.y<0||this.pos.y==s.y&&this.vel.y>0)&&(this.vel.y=0)}drawAsTile(t){this.sprite.length===2&&t.sprites.entitiesItems.draw(this.sprite,this.getDisplayX(),this.getDisplayY(),this.getFlipped())}draw(t){}}class $ extends C{constructor(t,e=null,s=1){super(t,e),this.hp=s,this.maxHp=s,this.facing=pt(0,1)*2-1,this.topSpeed=1/600,this.jumpSpeed=1/350,this.maxFallSpeed=1/50,this.hitDamage=1,this.spawnTimer=1e3,this.spawnElapsed=0,this.stunTimer=new H(0,0),this.hitTimer=new H(0,0),this.boundingBox=new w([.25,.5,.5,.5]),this.hitBox=new w([.25,.2,.5,.8]),this.drone=!1,this.climbing=!1,this.falling=!1,this.dying=!1,this.intelLevel=1,this.elevation=0,this.stance="aggressive",this.playerFriendly=!1,this.destination=new p([0,0]),this.animationFrames=[],this.activeAnimationFrame=-1,this.animationFrameTimer=0,this.animationFrameTime=250}getDisplayY(){return super.getDisplayY()-this.elevation}draw(t){this.activeAnimationFrame<this.animationFrames.length&&this.activeAnimationFrame>=0?t.sprites.monsters.draw(this.animationFrames[this.activeAnimationFrame],this.getDisplayX(),this.getDisplayY(),this.getFlipped()):t.sprites.monsters.draw([this.dying?1:0,this.sprite[1]],this.getDisplayX(),this.getDisplayY(),this.getFlipped()),this.hitTimer.finished()||u.Strike.length===2&&t.sprites.entitiesItems.draw(u.Strike,this.getDisplayX(),this.getDisplayY(),this.getFlipped())}die(t){this.stun(),this.dying=!0}death(t){if(this.dead=!0,!this.isPlayer){if(t.tiles.closestTile(this.bounds())instanceof W||this.playerFriendly)return;t.activePlayers[0].score++}}heal(t){this.hp=Math.min(this.maxHp,this.hp+t)}tile_pos(){return new p([Math.round(this.pos.x),Math.ceil(this.pos.y)])}stun(t=2e3){this.dying||this.stunTimer.reset(t)}update(t,e){if(this.spawnElapsed+=e,this.animationFrameTimer+=e,this.animationFrames.length>0&&this.activeAnimationFrame>=0&&this.animationFrameTimer>=this.animationFrameTime&&(this.activeAnimationFrame=(this.activeAnimationFrame+1)%this.animationFrames.length,this.animationFrameTimer=this.animationFrameTimer%this.animationFrameTime),this.spawnElapsed<this.spawnTimer)return;this.hitTimer.tick(e),this.stunTimer.tick(e);let s=!this.stunTimer.finished();if(!s&&this.dying){this.death(t);return}if(this.dying&&(this.vel=this.vel.scale(.9**(e/15))),this.stance==="fleeing"){const i=t.activePlayers[0],a=this.pos.dist(i.pos);if(a<10){this.destination=i.pos.subtract(this.pos).scale(-1).add(this.pos);const h=this.destination.subtract(this.pos),r=this.destination.dist(this.pos);this.vel=h.scale(this.topSpeed/r)}else if(a<25){this.destination=new p(i.pos);const h=this.destination.subtract(this.pos),r=this.destination.dist(this.pos);this.vel=h.scale(this.topSpeed/r)}else this.vel.fill(0)}if(this.facing=this.vel.x>=0?1:-1,t.tiles.move(this,e),!s&&!this.playerFriendly)for(let i of t.activePlayers)i.hitBounds().collide(this.bounds())&&(i.hitFrom(t,this.pos,this.hitDamage,this.hitDamage),i.stun(500*this.hitDamage));this.pos.y>t.tiles.dimH+3&&this.die(t)}hitFrom(t,e,s,i=0){this.hp-=s,s>0&&this.hitTimer.reset(200),this.hp<=0&&this.die(t);const a=this.pos.dist(e);if(a>0){const h=this.pos.add(e.scale(-1)).scale(1/a);this.vel.x=i*1/200*h[0],this.vel.y=i*1/200*h[1]}this.falling=!0}tile_collide(t){return t.bounds.collide(this.bounds())}monster_collide(t){return t.bounds.collide(this.bounds())}fallCheck(t,e){return!1}}class ie extends ${constructor(t){super(t,x.Rall1,1),this.hp=10,this.topSpeed=.5*this.topSpeed,this.fallOrigin=null,this.leapDestination=new p([0,0]),this.attackTimer=new H(1e4,Math.random()*5e3),this.stance="passive",this.immune=!0,this.boundingBox=new w([.75,1,1.5,2]),this.hitBox=new w([.75,1,1.5,2])}draw(t){if(this.dead)return;this.facing===0&&console.log("FACING 0");const e=1-.5*this.facing;this.stance==="passive"?(t.sprites.base.drawRotatedMultitile(x.RallHorse1,this.getDisplayX(),this.getDisplayY(),0,!this.getFlipped()),t.sprites.base.drawRotatedMultitile(x.RallHorsback,this.getDisplayX()+e,this.getDisplayY()-.125,0,!this.getFlipped())):this.stance==="preLeap"?(t.sprites.base.drawRotatedMultitile(x.RallHorse1,this.getDisplayX(),this.getDisplayY(),0,!this.getFlipped()),t.sprites.base.drawRotatedMultitile(x.RallHorsback,this.getDisplayX()+e,this.getDisplayY()-.125,0,!this.getFlipped())):this.stance==="leap"?(t.sprites.base.drawRotatedMultitile(x.RallHorse1,this.getDisplayX(),this.getDisplayY(),0,!this.getFlipped()),t.sprites.base.drawRotatedMultitile(x.RallHorsback,this.getDisplayX()+e,this.getDisplayY()-.125,0,!this.getFlipped())):this.stance==="postLeap"&&(t.sprites.base.drawRotatedMultitile(x.RallHorse1,this.getDisplayX(),this.getDisplayY(),0,!this.getFlipped()),t.sprites.base.drawRotatedMultitile(x.RallHorsback,this.getDisplayX()+e,this.getDisplayY()-.125,0,!this.getFlipped()))}update(t,e){if(super.update(t,e),!this.dead){if(this.stance==="passive")this.attackTimer.tick(e),this.attackTimer.finished()&&(this.immune=!0,this.stance="preLeap",this.attackTimer.reset(1e3));else if(this.stance==="preLeap"){if(this.attackTimer.tick(e),this.attackTimer.finished()){this.stance="leap",this.attackTimer.reset(1e3);const[s,i]=t.nearestPlayer(this.pos);if(s!==null){let a=s.pos.dist(this.pos);a<=10?this.leapDestination=new p(s.pos):(this.leapDestination=this.pos.add(s.pos.subtract(this.pos).scale(10/a)),a=10),this.vel=this.leapDestination.subtract(this.pos).scale(1/1e3),this.attackTimer.reset(1e3*a/10),console.log("started leap dest",this.leapDestination,"cur",this.pos,a)}}}else if(this.stance==="leap"){this.attackTimer.tick(e);const s=this.attackTimer.elapsed/this.attackTimer.timer,i=2;this.elevation=-4*i*s*s+4*i*s,(this.vel.dist([0,0])<=1e-6||this.attackTimer.finished())&&(console.log("ended leap dest",this.leapDestination,"cur",this.pos),this.vel=new p([0,0]),this.stance="postLeap",this.attackTimer.reset(1e3),this.elevation=0)}else this.stance==="postLeap"&&(this.attackTimer.tick(e),this.attackTimer.finished()&&(this.immune=!1,this.stance="passive",this.attackTimer.reset(5e3),this.vel=new p([0,0])));this.vel.x>0?this.facing=1:this.vel.x<0&&(this.facing=-1)}}}class X extends ${constructor(t,e=null,s=1,i=!1){super(t,u.Soldier1,1),this.playerFriendly=!0,this.hp=1,this.fallOrigin=null,this.stance="passive",this.wayPoints=[],this.activeWayPoint=-1,this.wayPointLoop=!1,this.follows=null,this.followDist=1,this.hat=i,this.activeAnimationFrame=0,this.animationFrameTime=200,this.animationFrames=[u.Soldier2,u.Soldier3,u.Soldier4,u.Soldier5]}draw(t){if(this.dead||this.dying){t.sprites.base.draw(u.SoldierDead,this.getDisplayX(),this.getDisplayY(),this.getFlipped());return}if(this.stance==="passive"||this.vel.x===0&&this.vel.y===0){t.sprites.base.draw(u.Soldier1,this.getDisplayX(),this.getDisplayY(),!this.getFlipped());return}u.Soldier1.length===2&&(t.sprites.base.draw(this.animationFrames[this.activeAnimationFrame]??u.Soldier1,this.getDisplayX(),this.getDisplayY(),!this.getFlipped()),this.hat&&t.sprites.base.draw(u.SoldierHat,this.getDisplayX(),this.getDisplayY()-.5,!this.getFlipped()))}update(t,e){if(this.stance==="marching"&&this.stunTimer.finished()&&this.activeWayPoint>=0){let s=this.wayPoints[this.activeWayPoint],i=!1;if(this.follows){const a=this.follows,h=this.pos.dist(s),r=this.pos.dist(a.pos),l=a.pos.dist(s);i=h<l+this.followDist&&r<l}i?(this.vel.x=0,this.vel.y=0):(this.vel=s.subtract(this.pos).scale(this.topSpeed*e/15/s.dist(this.pos)),this.pos.dist(s)<.25&&(this.activeWayPoint=(this.activeWayPoint+1)%this.wayPoints.length,this.activeWayPoint===0&&!this.wayPointLoop&&(this.activeWayPoint=-1,this.stance="passive",this.animationFrames=[],this.vel=new p([0,0]))))}super.update(t,e)}}class ot extends ${constructor(t){super(t,u.Hessian1,1),this.hp=1,this.topSpeed=.5*this.topSpeed,this.fallOrigin=null,this.stance="passive",this.launchTimer=new H(1e4,Math.random()*5e3),this.launching=0,this.shoots=!0}draw(t){if(u.Hessian1.length===2){if(this.dead||this.dying){t.sprites.base.drawRotated(u.Hessian1,this.getDisplayX(),this.getDisplayY(),90,this.getFlipped());return}t.sprites.base.draw(u.Hessian1,this.getDisplayX(),this.getDisplayY(),this.getFlipped()),t.sprites.base.draw(u.HessianHelmet1,this.getDisplayX(),this.getDisplayY()-.5,this.getFlipped()),this.shoots&&t.sprites.base.draw(this.launchTimer.elapsed-this.launchTimer.timer>1e3?u.Rifle1:u.Rifle2,this.getDisplayX()+this.facing*.375,this.getDisplayY()+.25,!this.getFlipped())}}update(t,e){if(super.update(t,e),this.dead||this.dying)return;const s=t.activePlayers[0];if(!(this.pos.dist(s.pos)>20)&&(this.facing=s.pos[0]>this.pos[0]?1:-1,!!this.shoots&&(this.launchTimer.tick(e),this.launchTimer.finished())))if(this.launching<=0){this.launchTimer.reset(500);const[i,a]=this.pos.scale(-1).add(s.pos);let h=Math.atan2(a,i)*180/Math.PI;t.items.push(new Pt(this.pos.add([1*this.facing,0]),null,h)),this.launching++}else this.launching=0,this.launchTimer.reset(2e3-0*Math.random())}}class ae extends ${constructor(t){super(t,u.Hessian1,1),this.hp=1,this.topSpeed=.5*this.topSpeed,this.fallOrigin=null,this.stance="passive",this.destination=new p(t.pos),this.launchTimer=new H(1e4,Math.random()*5e3),this.launching=0}draw(t){if(u.Hessian1.length===2){if(this.dead||this.dying){t.sprites.base.drawRotated(u.Hessian1,this.getDisplayX(),this.getDisplayY(),90,this.getFlipped());return}t.sprites.base.draw(u.Hessian1,this.getDisplayX(),this.getDisplayY(),this.getFlipped()),t.sprites.base.draw(this.launchTimer.elapsed-this.launchTimer.timer>1e3?u.Rifle1:u.Rifle2,this.getDisplayX()+this.facing*.375,this.getDisplayY()+.25,!this.getFlipped())}}update(t,e){if(super.update(t,e),this.dead||this.dying)return;const s=t.activePlayers[0];if(this.pos.dist(s.pos)>30&&!this.dead){this.stance==="fleeing"&&(this.dead=!0);return}if(this.pos.dist(s.pos)<5&&this.stance==="passive"&&!this.dead&&(this.stance="fleeing"),this.facing=s.pos[0]>this.pos[0]?1:-1,this.launchTimer.tick(e),this.launchTimer.finished())if(this.launching<=0){this.launchTimer.reset(500);const[i,a]=this.pos.scale(-1).add(s.pos);let h=Math.atan2(a,i)*180/Math.PI;t.items.push(new Pt(this.pos.add([1*this.facing,0]),null,h)),this.launching++}else this.launching=0,this.launchTimer.reset(2e3-0*Math.random())}}class he extends ${constructor(t){super(t,[0,0],1),this.hp=10,this.topSpeed=.5*this.topSpeed,this.fallOrigin=null,this.stance="passive",this.launchTimer=new H(1e3),this.launching=0,this.firingAngle=0,this.hitDamage=0,this.spawnTimer=0,this.facing=1}draw(t){t.sprites.base.drawRotatedMultitile(x.Cannon,this.getDisplayX()-1,this.getDisplayY(),0,this.getFlipped())}stun(t=2e3){}update(t,e){super.update(t,e),!this.dead&&(this.firingAngle+=e/15,this.firingAngle>=360&&(this.firingAngle=0),this.launchTimer.tick(e),this.launchTimer.finished()&&(t.items.push(new Qt(t.tiles.at(this.tile_pos()),null,this.firingAngle)),this.launchTimer.reset()))}hitFrom(t,e,s,i=0){this.hp-=s,s>0&&this.hitTimer.reset(200),this.hp<=0&&this.die(t)}}const et=0,St=1,J=2,U=3,Y=4,nt=5,F=6;class K extends ${constructor(e=-1,s=null){super(s,[0,e],3);o(this,"isPlayer",!0);o(this,"boundingBox",new w([.25,.5,.5,.5]));o(this,"hitBox",new w([.25,.25,.5,.5]));o(this,"dashBox",new w([0,0,1,1]));o(this,"immunityTimer",new H(1e3,1e3));o(this,"selectedTimer",new H(500,500));o(this,"dashTimer",new H(3e3,3e3));o(this,"hitTimer",new H(500,500));o(this,"stunTimer",new H(500,500));o(this,"jumpTimer",new H(0,0));o(this,"freeze",!1);o(this,"selectedSprite",null);o(this,"hidden",!1);o(this,"escaped",!1);o(this,"running",!1);o(this,"climbing",!1);o(this,"aiming",!1);o(this,"dropFromGame",!1);o(this,"startLevel",0);o(this,"lastVel",new p([0,0]));o(this,"dodgeOrigin",new p(this.pos));o(this,"boatOffset",new p([-2.5,0]));o(this,"holding","sword");o(this,"ridingBoat",!1);o(this,"maxHp",4);o(this,"topSpeed",1/250);o(this,"jumpSpeed",1/135);o(this,"maxFallSpeed",1/50);o(this,"airJumps",0);o(this,"wallJumps",0);o(this,"spikedBoots",0);o(this,"chips",0);o(this,"dead",!1);o(this,"score",0);o(this,"deaths",0);o(this,"pause",0);o(this,"lastFacing",0);o(this,"lastFramePos",new p([0,0]));o(this,"currentFrame",0);o(this,"useTimer",new H(0));o(this,"hookHitModifier",[]);o(this,"hookUpdate",[]);o(this,"activeState",Y);o(this,"stateTimer",new H);o(this,"controller",null);this.controlStates={...dt()},this.newControlStates={...dt()},this.oldControlStates={...dt()},this.sprite=[0,8],this.setAnimationFrames()}bounds(e=null){return e===null&&(e=this.pos),this.activeState===F?new w([this.pos.x-2,this.pos.y+.25,3,.5]):super.bounds(e)}dashBounds(){const e=this.vel.x>0?.5:this.vel.x<0?-.5:0,s=this.vel.y>0?.5:this.vel.y<0?-.5:0,i=[this.pos.x+e,this.pos.y+s];return this.dashBox.shift(i)}setAnimationFrames(){this.animationFrames={WALK_EW:[new p([1,0]),new p([4,0]),new p([4,0]),new p([3,0]),new p([3,0]),new p([2,0]),new p([2,0]),new p([1,0])],WALK_N:[new p([1,0]),new p([2,0]),new p([1,0]),new p([2,0])],WALK_S:[new p([1,0]),new p([2,0]),new p([1,0]),new p([2,0])],DASH_EW:[new p([1,0]),new p([2,0]),new p([2,0])],DASH_N:[new p([14,0]),new p([15,0]),new p([15,0]),new p([14,0])],DASH_S:[new p([12,0]),new p([13,0]),new p([13,0]),new p([12,0])],STAND:[new p([0,0])]}}cycleSprite(e){let s=e.other_players(this).map(i=>i.sprite[1]);for(;this.sprite[1]++,this.sprite[1]>=4&&(this.sprite[1]=0),!!s.includes(this.sprite[1]););this.setAnimationFrames()}die(e){if(this.dead)return;this.dead=!0,this.hp=0,this.deaths++;let s=P(["dead1","dead2","dead3","dead4","dead5","dead6","dead7","dead8"]);this.setState(e,nt),e.playSound(s)}boardBoat(e,s){this.enterState(e,F),this.pos=s.pos.subtract(this.boatOffset).add([3,0])}enterState(e,s){switch(s){case F:case J:{const i=this.dashTimer.finished()?.01:.004;this.vel.x>0&&(this.vel.x=1),this.vel.x<0&&(this.vel.x=-1),this.vel.y>0&&(this.vel.y=1),this.vel.y<0&&(this.vel.y=-1);const a=this.vel.dist([0,0]);a>0&&(this.vel=this.vel.scale(i/a));break}}this.activeState=s}exitState(e,s){}updateState(e,s){switch(this.activeState){case Y:case et:if(this.entityInteract(e),this.stunTimer.finished()){if(this.moveCheck(e,s,this.running),this.cycleInventoryCheck(e,s),this.vel.x!==0||this.vel.y!==0){if(!this.oldControlStates.dodge&&this.controlStates.dodge){this.setState(e,U),this.dodgeOrigin=new p(this.pos);return}else if(!this.oldControlStates.dash&&this.controlStates.dash){this.setState(e,J),this.dashTimer.reset();return}}this.activeState===Y&&this.setState(e,et)}this.vel.x===0&&this.vel.y===0&&this.activeState===et&&this.setState(e,Y),this.tileInteract(e,s);break;case St:this.stunTimer.finished()&&(this.entityInteract(e),this.setState(e,et),this.stunTimer.finished()&&(this.moveCheck(e,s,!1),this.cycleInventoryCheck(e,s)),this.tileInteract(e,s)),!this.jumpTimer.finished()&&this.vel.y<0&&!this.controlStates.dash&&(this.vel.y*=.5**(s/15));break;case J:this.entityInteract(e);for(let i of e.monsters)i.hitBounds().collide(this.dashBounds())&&(i.hitFrom(e,this.pos,1,2),i.stun());this.stateTimer.elapsed>100&&this.setState(e,Y);break;case U:this.entityInteract(e),this.stunTimer.finished()&&(this.moveCheck(e,s,!0),this.cycleInventoryCheck(e,s)),!this.oldControlStates.dash&&this.controlStates.dash&&(this.vel.x!==0||this.vel.y!==0)&&this.setState(e,J),this.tileInteract(e,s),this.stateTimer.elapsed>500&&this.setState(e,Y);break;case nt:this.driftCheck(e,s,!1);break;case F:this.facing=1,!this.oldControlStates.left&&this.controlStates.left&&(this.vel.x=-1/400,this.vel.y=0),!this.oldControlStates.right&&this.controlStates.right&&(this.vel.x=1/200,this.vel.y=0),!this.oldControlStates.up&&this.controlStates.up&&(this.vel.y=-1/800,this.vel.x=0),!this.oldControlStates.down&&this.controlStates.down&&(this.vel.y=1/400,this.vel.x=0),this.entityInteract(e),this.vel.y=this.vel.y*.99,this.vel.x=this.vel.x*.99;break}}revive(e){this.dead=!1,this.setState(e,et),this.hp=e.competitiveMode?this.maxHp:1}hitFrom(e,s,i,a=0){if(!this.dead&&!this.escaped&&this.activeState!==U&&this.immunityTimer.finished()){for(let h of this.hookHitModifier)[i,a]=h.hitModifier(i,a);super.hitFrom(e,s,i,a),this.immunityTimer.reset(),e.playSound("hit1")}}use(e,s){this.useTimer.reset(s)}draw(e){if(this.hidden)return;const s=this.activeState===J?this.animationFrames.DASH_EW:this.animationFrames.WALK_EW;let i=this.getFlipped();if(this.escaped)return;let a=[0,0];this.dead?(a=[0,a[1]],this.currentFrame=0,this.lastFramePos=new p(this.pos)):this.activeState===St?(a=[0,a[1]],this.currentFrame=0,this.lastFramePos=new p(this.pos)):this.activeState===Y?(a=u.Washington1,this.currentFrame=0,this.lastFramePos=new p(this.pos)):this.activeState===U?(a=u.WashingtonDodge,this.currentFrame=0,this.lastFramePos=new p(this.pos)):(this.facing!==this.lastFacing?(this.currentFrame=0,this.lastFramePos=new p(this.pos)):this.pos.dist(this.lastFramePos)*4>=1&&(this.currentFrame+=Math.floor(this.pos.dist(this.lastFramePos)*4),this.lastFramePos=new p(this.pos)),this.currentFrame=this.currentFrame%s.length,a=s[this.currentFrame]);const h=e.sprites.base.ctx;if(this.activeState===U){if(h.globalAlpha=.75,this.vel.x===0){if(this.vel.y<0){const r=this.dodgeOrigin.y-this.pos.y;e.sprites.base.drawRotatedMultitile([20,4.5-r,1,.5+r],this.pos.x,this.pos.y+.5,0,!i)}else if(this.vel.y>0){const r=this.pos.y-this.dodgeOrigin.y;e.sprites.base.drawRotatedMultitile([21,1,1,.5+r],this.pos.x,this.dodgeOrigin.y,0,!i)}}else if(this.vel.x>0){const r=Math.min(this.pos.x-this.dodgeOrigin.x,3.5);e.sprites.base.drawRotatedMultitile([24.5-r,0,.5+r,1],this.dodgeOrigin.x,this.pos.y,this.vel.y<0?-20:this.vel.y>0?20:0,!i)}else if(this.vel.x<0){const r=Math.min(this.dodgeOrigin.x-this.pos.x,3.5);e.sprites.base.drawRotatedMultitile([24.5-r,0,.5+r,1],this.pos.x+.5,this.pos.y,this.vel.y<0?20:this.vel.y>0?-20:0,!i)}h.globalAlpha=1}if(this.activeState===F){e.sprites.base.drawRotatedMultitile(x.BoatBack,this.getDisplayX()+this.boatOffset.x,this.getDisplayY()+this.boatOffset.y,0,i);for(let r=0;r<4;r++)e.sprites.base.draw(u.Soldier1,this.getDisplayX()-2+r/2,this.getDisplayY(),!i);a=u.Washington1}if(this.activeState===nt)e.sprites.base.drawRotated([a[0],a[1]],this.getDisplayX(),this.getDisplayY(),i?270:90,!i);else{if(this.activeState===U&&(h.globalAlpha=.5),e.sprites.base.draw([a[0],a[1]],this.getDisplayX(),this.getDisplayY(),!i),this.activeState===J){const r=this.currentFrame===0?this.facing*.25:this.facing*.5;e.sprites.base.draw(this.currentFrame===0?u.Sword2:u.Sword3,this.getDisplayX()+r,this.getDisplayY(),!i)}else{const r=this.facing*.5;e.sprites.base.draw(u.Sword1,this.getDisplayX()+r,this.getDisplayY(),!i)}this.activeState===U&&(h.globalAlpha=1)}this.hitTimer.finished()||u.Strike.length===2&&e.sprites.base.draw(u.Strike,this.getDisplayX(),this.getDisplayY(),!this.getFlipped()),this.activeState===F&&e.sprites.base.drawRotatedMultitile(x.BoatFront,this.getDisplayX()+this.boatOffset.x,this.getDisplayY()+this.boatOffset.y,0,i),this.lastFacing=this.facing}drawHUD(e,s){u.Health.length===2&&e.sprites.base.drawMainContext(u.Health,s.x,s.y),e.drawTileText(""+Math.ceil(this.hp),.5,s.add([0,-.25]),"White")}update(e,s){if(!this.escaped){new p(this.vel),new p(this.pos),this.immunityTimer.tick(s),this.stateTimer.tick(s),this.jumpTimer.tick(s),this.hitTimer.tick(s),this.useTimer.tick(s),this.stunTimer.tick(s),this.selectedTimer.tick(s),this.dashTimer.tick(s),this.updateState(e,s);for(let i of this.hookUpdate)i.update(e,s,this);this.activeState!=nt&&this.pos.y>e.tiles.dimH+3&&this.die(e),this.lastVel=new p(this.vel),this.activeState!==F?this.freeze||e.tiles.move(this,s):this.activeState===F?this.freeze||e.tiles.moveBoat(this,s):this.pos=this.pos.add(this.vel.scale(15/s)),this.activeState===F&&(this.lastVel.x!==this.vel.x||this.lastVel.y!==this.vel.y)&&(this.pos=this.pos.add([3,0]),e.tiles.closestTile(new w([this.pos[0],this.pos[1],1,1]))instanceof at&&(this.setState(e,Y),e.items.push(new A(e.tiles.at(this.pos.subtract([6,0]).map(Math.ceil))))))}}driftCheck(e,s,i){const a=15625e-8;this.vel.x=this.vel.x>0?Math.max(this.vel.x-a*s/15,0):Math.min(this.vel.x+a*s/15,0),this.vel.y=this.vel.y>0?Math.max(this.vel.y-a*s/15,0):Math.min(this.vel.y+a*s/15,0)}moveCheck(e,s,i){this.controlStates.left?(this.vel.x=Math.max(-this.topSpeed*(i?2:1),this.vel.x-1/1600*s/15),this.facing=-1):!i&&this.vel.x<0&&(this.vel.x=0),this.controlStates.right?(this.vel.x=Math.min(this.topSpeed*(i?2:1),this.vel.x+1/1600*s/15),this.facing=1):!i&&this.vel.x>0&&(this.vel.x=0),this.controlStates.up?this.vel.y=Math.max(-this.topSpeed*(i?2:1),this.vel.y-1/1600*s/15):!i&&this.vel.y<0&&(this.vel.y=0),this.controlStates.down?this.vel.y=Math.min(this.topSpeed*(i?2:1),this.vel.y+1/1600*s/15):!i&&this.vel.y>0&&(this.vel.y=0)}cycleInventoryCheck(e,s){this.controlStates.cycle&&this.oldControlStates.cycle}entityInteract(e){for(let s=0;s<e.items.length;s++)this.bounds().collide(e.items[s].bounds())&&(e.items[s].entityCollide(e,this),this.aiming||(this.controlStates.up&&e.items[s].entityInteract(e,this,"up"),this.controlStates.down&&e.items[s].entityInteract(e,this,"down")))}tileInteract(e,s){if(this.controlStates.up){let i=e.tiles.closestTile(this.bounds());i instanceof W||i.entityInteract(e,this,"up")}if(this.controlStates.down){let i=e.tiles.closestTile(this.bounds());if(!(i instanceof W)){i.entityInteract(e,this,"down");let a=e.tiles.below(i.pos);!(a instanceof W)&&a.tile.y==this.bounds().bottom&&a.tile.entityInteract(e,this,"down")}}}setState(e,s){this.exitState(e,this.activeState),this.enterState(e,s),this.stateTimer.reset()}}class ne extends w{constructor(){super([0,0,14,8]),this.scrollable=!0,this.focusPlayer=null}get viewPortH(){return this.h}set viewPortH(t){this.h=t}get viewPortW(){return this.w}set viewPortW(t){this.w=t}get pos(){return new p([-this.x,-this.y])}set pos(t){t!=null?(this.x=-t.x,this.y=-t.y):(this.x=null,this.y=null)}update(t,e){if(this.scrollable){let s=0,i=0,a=0;for(let l of t.activePlayers)!l.dead&&!l.escaped&&((this.focusPlayer==null||this.focusPlayer.dead||this.focusPlayer.escaped)&&(this.focusPlayer=l),l.controlStates.camera&&!l.oldControlStates.camera&&(this.focusPlayer=l),i+=l.pos.x,a+=l.pos.y,s++);this.focusPlayer===null&&(this.focusPlayer=t.activePlayers[0]),s>0&&(i/=s,a/=s),s==0&&(i=this.focusPlayer.pos.x,a=this.focusPlayer.pos.y),s>1&&(Math.abs(this.focusPlayer.pos.x-i)>this.viewPortW/2-1||Math.abs(this.focusPlayer.pos.y-a)>this.viewPortH/2-1)&&(i=this.focusPlayer.pos.x,a=this.focusPlayer.pos.y);let h=-i-.5+this.viewPortW/2,r=-a-.5+this.viewPortH/2;if(h=Math.max(Math.min(h,0),-t.dimW+this.viewPortW),r=Math.max(Math.min(r,0),-t.dimH+this.viewPortH),this.x==null||this.y==null)this.pos=new p([h,r]);else{let l=h-this.pos.x,d=r-this.pos.y,f=1*(e/15),m=Math.max(Math.abs(l),Math.abs(d));this.pos!=null&&m>f?this.pos=new p([this.pos.x+l*f/m,this.pos.y+d*f/m]):this.pos=new p([h,r])}}}draw(){}}function re(n){let t;if(n.camera.scrollable&&n.prefDimW==null&&n.prefDimH==null)switch(t=0,t){case 0:n.dimW=256,n.dimH=128;break}const e=n.dimW,s=n.dimH;n.tiles=new Gt(e,s);let i=n.tiles;i.fillRect(new w([0,0,e,s]),at);for(let d=0;d<s;d++){const f=Math.floor(d/2);i.fillLine([f+20,d],[f+120,d],B)}const a=116;i.fillLine([0,a],[50,a],T),i.fillLine([0,a+1],[50,a+1],T),i.fillLine([49,a],[49,a-10],T),i.fillLine([50,a+1],[50,a-10],T),i.fillLine([48,a-10],[28,a-30],T),i.fillLine([49,a-10],[29,a-30],T),i.fillLine([50,a-10],[30,a-30],T),i.fillLine([28,a-30],[18,a-80],T),i.fillLine([29,a-30],[19,a-80],T),i.fillLine([30,a-30],[20,a-80],T),i.fillLine([19,a-80],[19,a-95],T),i.fillLine([130,0],[194,128],T),i.fillLine([131,0],[195,128],T),i.fillLine([132,0],[196,128],T),i.fillRect(new w([185,107,63,2]),T),i.fillRect(new w([193,122,57,2]),T),i.fillRect(new w([248,107,2,24]),T),i.endTile=i.at([255,127]),i.startTile=i.at([0,116]),i.endTile=i.at([255,127]),n.cells=10,n.cellsCollected=0,n.items=[],n.items.push(new tt([15.5,a-100])),n.items.push(new A([28,20]));const h=new A([38,40]);h.boardable=!0,n.items.push(h),n.items.push(new A([48,60])),n.items.push(new A([58,80])),n.items.push(new A([68,100])),n.items.push(new A([78,120])),n.items.push(new A([152,60])),n.items.push(new A([162,80])),n.items.push(new A([172,100])),n.items.push(new A([182,120])),i.fillRect(new w([185,107,63,2]),T),i.fillRect(new w([193,122,57,2]),T),i.fillRect(new w([248,107,2,24]),T);for(let d=0;d<100;d+=24){let f=140+Math.floor(d/2);n.items.push(new tt([f,d]))}for(let d=10;d<110;d+=24){let f=133+Math.floor(d/2)+it(5);i.set([f,d],Z)}let r=0;for(let d=0;d<100;d++){r=Math.min(Math.max(Math.random()>.5?-1:1,0),5);let f=150+Math.floor(d/2)+r;i.fillLine([f,d],[256,d],Nt)}let l=0;n.tiles.fillRect(new w([198,102,52,5]),ct),n.tiles.fillRect(new w([198,124,52,7]),ct),n.tiles.fillRect(new w([250,107,5,24]),ct);for(let d=198;d<250;d+=8)n.items.push(new tt([d,100]));for(let d=198;d<250;d+=8)n.items.push(new tt([d,124]));for(let d=105;d<128;d+=6)n.items.push(new tt([250,d]));l=0,l=0;for(let d of n.tiles.iterRandom(null,B,null,20))if(n.items.push(new b(n.tiles.at(d))),l++,l>100)break;l=0;for(let d of n.tiles.iterRandom(null,at,null,200))if(n.items.push(new Ut(n.tiles.at(d))),l++,l>100)break;n.monsters=[],n.monsters.push(new X([h.pos.x-2,h.pos.y-2],null,2,!0)),n.monsters.push(new X([h.pos.x-4,h.pos.y-2],null,2,!0)),n.monsters.push(new X([h.pos.x-2,h.pos.y+2],null,2,!0)),n.monsters.push(new X([h.pos.x-4,h.pos.y+2],null,2,!0));for(let d of n.tiles.iterAll())d.initItems(n)}function oe(n,t=null,e=!1,s=!0){let i;return Rt("get random passable tile",function(){let a=pt(0,n.dimW-1),h=pt(0,n.dimH-1);return i=n.at([a,h]),t!=null?i.passable&&i.pos.dist(t)>3:!0}),i}function le(n,t,e=!1,s=null){s===null&&(s=[ot]);let i=P(s),a=new i(oe(n.tiles,t,e));n.monsters.push(a)}class ft{constructor(t,e,s){this.options=t,this.dim=new w(e),this.activeOption=0,this.callback=s,this.color="rgba(100, 100, 218, 1)"}draw(t){let e=this.dim.h/this.options.length*1.2,s=this.dim.h/this.options.length*.6,i=this.dim.y,a=this.dim.x+this.dim.w/2,h=0;for(let r of this.options){let l=h==this.activeOption?">"+r+"<":r;this.drawMenuText(t,l,s,!0,a,i,this.color),h+=1,i+=e}}drawMenuText(t,e,s,i,a,h,r){t.ctx.fillStyle=r,t.ctx.font=s+"px IM Fell English SC",i&&(a=a-t.ctx.measureText(e).width/2),t.ctx.fillText(e,a,h)}update(t,e){M.up&&!z.up&&(this.activeOption=this.activeOption>0?this.activeOption-1:this.options.length-1,this.callback(this,"change")),M.down&&!z.down&&(this.activeOption=this.activeOption<this.options.length-1?this.activeOption+1:0,this.callback(this,"change")),(M.use&&!z.use||M.dash&&!z.dash)&&this.callback(this,"select")}}class de extends ft{constructor(t){let e=new w([0,t.H/2,t.W,3]);super(["Play Game","High Scores","Options"],e,(s,i)=>this.handler(t,s,i))}updateWindowSize(t){this.dim=new w([0,t.H/2,t.W,3])}handler(t,e,s){if(s==="select")switch(e.activeOption){case 0:M.left?(t.prefDimW=80,t.prefDimH=40,t.startLevelTime=0):M.right?(t.prefDimW=22,t.prefDimH=13,t.startLevelTime=0):(t.prefDimW=null,t.prefDimH=null,t.startLevelTime=0),t.competitiveMode=!1,t.updateWindowSize(),t.startGame();break;case 1:t.gameState="scores";break;case 2:t.gameState="options";break}}}class ce extends ft{constructor(t){let e=new w([0,t.H/2,t.W,3]);super([],e,(s,i)=>this.handler(t,s,i))}updateWindowSize(t){this.dim=new w([0,t.H/2,t.W,this.options.length])}update(t,e){this.options=["Pixel perfect scaling: "+(t.fillScreen?"OFF":"ON"),"Show framerate: "+(t.showFPS?"ON":"OFF"),"Back"],this.dim=new w([0,t.H/2,t.W,this.options.length]),super.update(t,e)}handler(t,e,s){if(s=="select")switch(e.activeOption){case 0:t.fillScreen=!t.fillScreen,t.updateWindowSize();break;case 1:t.showFPS=!t.showFPS;break;case 2:t.gameState="title";break}}}class pe extends ft{constructor(t){let e=new w([0,t.H/2,t.W,3]);super(["Continue","Drop Player","Exit to Main Menu"],e,(s,i)=>this.handler(t,s,i))}updateWindowSize(t){this.dim=new w([0,t.H/2,t.W,this.options.length])}handler(t,e,s){if(s=="select")switch(e.activeOption){case 0:t.gameState="running";break;case 1:for(let i of t.activePlayers)i.controlStates.dash&&!i.oldControlStates.dash&&(i.dead=!0,i.dropFromGame=!0,t.gameState="running");break;case 2:t.gameState="title",t.playTitleMusic();break}}}function kt(){return localStorage["1776/high_scores"]?JSON.parse(localStorage["1776/high_scores"]):[]}function ue(n,t,e){var a;let s=kt(),i={score:t,chapter:((a=n.chapters[n.activeChapter])==null?void 0:a.title)??"Pennsylvania",won:e};s.push(i),n.sandboxMode||(localStorage["1776/high_scores"]=JSON.stringify(s))}function fe(n){let t=kt();if(t.length){n.drawText(wt(["CHAPTER","SCORE","END"]),.35,!0,.45*n.H,"white");let e=t.pop();t.sort(function(s,i){return i.score-s.score}),t.unshift(e);for(let s=0;s<Math.min(10,t.length);s++){let i=wt([t[s].chapter??"Pennsylvania",t[s].score,t[s].won?"SURVIVED":"DIED"]);n.drawText(i,.35,!0,.45*n.H+.5+s/2,s==0?"DarkOrange":"DarkSeaGreen")}}}const we="/1776-washdel/assets/spritesheet-6v75mpQf.png",ye="/1776-washdel/assets/the_marines_hymn_slow_version-wL2A_HOJ.mp3",me="/1776-washdel/assets/four-flams-CE5QOPlm.mp3",xe="/1776-washdel/assets/holst-march-DHIMIGoC.mp3",Se="/1776-washdel/assets/star-spangled-banner-Bht74Z9J.mp3",ge="/1776-washdel/assets/to-the-colors-DfVqikZB.mp3",ve="/1776-washdel/assets/hit1-B8fjDMVY.wav",be="/1776-washdel/assets/hit2-BUt-r6lq.wav",Te="/1776-washdel/assets/sfx_sounds_powerup5-9kcmwmYb.wav",Me="/1776-washdel/assets/sfx_sounds_powerup15-BCTjFyTw.wav",rt="/1776-washdel/assets/Slide_Sharp_01-Chnp6Y48.wav",Pe="/1776-washdel/assets/explodemini-D3OoVwHb.wav",ke="/1776-washdel/assets/explode-BNxvceyl.wav",Fe="/1776-washdel/assets/aargh0-BapSXfr1.ogg",Ce="/1776-washdel/assets/aargh1-CpJFM2VX.ogg",He="/1776-washdel/assets/aargh2-DSamuWiH.ogg",De="/1776-washdel/assets/aargh3-ByRNAUSJ.ogg",We="/1776-washdel/assets/aargh4-ClzDA7Un.ogg",Be="/1776-washdel/assets/aargh5-C63Uz6i_.ogg",Re="/1776-washdel/assets/aargh6-CYmQwO-t.ogg",Ae="/1776-washdel/assets/aargh7-9yHQMFdu.ogg",gt="/1776-washdel/assets/rock_metal_slide_1-C2c5Tw6I.wav",Ie="/1776-washdel/assets/Click_Standard_02-B2nmSCJT.wav",Le="/1776-washdel/assets/flaunch-BKRvBjGH.wav",ze="/1776-washdel/assets/sfx_wpn_laser7-B5OWkHW5.wav",Oe="/1776-washdel/assets/sfx_wpn_laser6-Drhqhz-r.wav",_e="/1776-washdel/assets/sfx_wpn_laser5-v584Gpjn.wav",vt="/1776-washdel/assets/sfx_wpn_reload-DQ6QsLU9.wav",Ee="/1776-washdel/assets/Rifleprimary2-CKvPeCK4.ogg",Ye="/1776-washdel/assets/minigun3-D9jlbypc.ogg",Xe="/1776-washdel/assets/Rack-BKgWHnMr.mp3",je="/1776-washdel/assets/sfx_wpn_missilelaunch-DaPY7xwi.wav",Ne="/1776-washdel/assets/jumppad-BqbMzNcn.ogg",bt="/1776-washdel/assets/rattle1-D8oszgzt.wav",Ge="/1776-washdel/assets/SpaceShip_Engine_Large_Loop_00-wpyxUmoF.wav";function Ue(){return{main:we}}function Ve(){return Object.freeze({hit1:new Audio(ve),hit2:new Audio(be),pickup1:new Audio(Te),pickup2:new Audio(Me),changeInv:new Audio(rt),boom:new Audio(Pe),boomBig:new Audio(ke),dead1:new Audio(Fe),dead2:new Audio(Ce),dead3:new Audio(He),dead4:new Audio(De),dead5:new Audio(We),dead6:new Audio(Be),dead7:new Audio(Re),dead8:new Audio(Ae),exitLevel:new Audio(gt),gameOver:new Audio(gt),kioskInteract:new Audio(Ie),kioskDispense:new Audio(Le),gunFire1:new Audio(ze),gunFire2:new Audio(Oe),gunFire3:new Audio(_e),gunReload:new Audio(vt),rifleFire:new Audio(Ee),rifleReload:new Audio(vt),shotgunFire:new Audio(Ye),shotgunReload:new Audio(Xe),rocketFire:new Audio(je),rocketReload:new Audio(rt),grappleFire:new Audio(Ne),grappleReload:new Audio(rt),grappleRetract:new Audio(bt),wrenchFire:new Audio(bt),wrenchReload:new Audio(rt),saberCharge:new Audio(Ge),marinesHymn:new Audio(ye),fourFlams:new Audio(me),holstMarch:new Audio(xe),starSpangled:new Audio(Se),toTheColors:new Audio(ge)})}class ht{constructor(){o(this,"intro",[]);o(this,"startPos",[0,0]);o(this,"startState",Y);o(this,"activeIntroLine",0);o(this,"objectives",[]);o(this,"activeObjective",0);o(this,"startTime",0);o(this,"title","")}start(t,e=!0){this.startTime=t.levelTime,e&&t.music!=null&&(t.music.pause(),t.music.currentTime=0)}update(t,e){t.levelTime>=this.startTime+1e4*(this.activeIntroLine+1)&&this.activeIntroLine++}draw(t,e){this.drawTextBox2(t,this.title,!0,"top",3/8),t.gameState==="dead"&&t.activeChapter>=4&&t.activePlayers[0].hp>0&&this.drawTextBox2(t,"VICTORY!",!0,"middle",2),t.activePlayers[0].dead?t.activePlayers[0].hidden?this.drawTextBox(t,`
Washington drowned crossing the Delaware (press ESC to exit).`):this.drawTextBox(t,`
Washington has died in battle (press ESC to exit).`):this.activeIntroLine<this.intro.length&&this.activeObjective===0?this.drawTextBox(t,this.intro[this.activeIntroLine]):(t.levelTime>=this.startTime+1e4*this.intro.length||this.activeObjective>0)&&this.objectives.length>this.activeObjective&&this.drawTextBox(t,this.objectives[this.activeObjective])}drawTextBox(t,e){t.ctx.fillStyle="rgba(75,75,75,0.5)";const s=1,i=t.camera.viewPortW-2,a=yt(t.ctx,e,i,.5),h=a.length*1.1/2,r=t.camera.viewPortH-.5-h;t.ctx.fillRect(s,r,i,h),mt(t.ctx,a,s,r,"darkOrange",.5)}drawTextBox2(t,e,s=!1,i="bottom",a=null){a===null&&(a=.5);const h=t.ctx;h.scale(.01,.01),a*=100;const r=.25*100,l=a/4,d=(t.W-2)*100,f=`${a}px IM Fell English SC`,m=yt(h,e,d,a,f),S=1.1;h.font=f;const k=Math.max(...m.map(O=>h.measureText(O).width)),R=h.measureText(m[0]),D=R.actualBoundingBoxAscent+R.actualBoundingBoxDescent,y=s?k+2*r:d,g=D+(m.length-1)*a*S+2*l,E=s?(100*t.W-y)/2:1;let j;switch(i){case"top":j=0;break;case"middle":j=(100*t.H-g)/2;break;case"bottom":default:j=100*t.H-.5-g;break}h.fillStyle="rgba(75,75,75,0.5)",h.fillRect(E,j,y,g),mt(h,m,E+r,j+l,"darkOrange",a,f,S),h.scale(100,100)}}class Ke extends ht{constructor(){super(...arguments);o(this,"stone",null);o(this,"startPos",[0,116]);o(this,"title","McConkey Ferry, Pennsylvania");o(this,"intro",["The year is 1776, the U.S. army has faced defeat after defeat. Having recently lost New York, the colonial army holds a lower morale than ever, and is on the verge of collapse.","General Washington knows the soldiers need a decisive victory to raise their spirits, and has planned a surprise attack on the Hessian occupied Trenton. However, first he must cross the Delaware River, which has begun to freeze due to poor weather conditions."]);o(this,"objectives",[`Head north and rouse your troops.
Controls: ARROWS or W/A/S/D to move, SPACE/J to swing sword, Z/K to dodge.`,'Tyranny, like hell, is not easily conquered; yet we have this consolation with us, that the harder the conflict, the more glorious the triumph..."',`Find your captains and board your boat.
Controls: ARROWS or W/A/S/D to move, SPACE/J to swing sword, Z/K to dodge.`]);o(this,"speechTimer",5e3)}start(e){super.start(e),e.weather.changeMode("snow"),e.backLight="rgba(156, 156, 192, 1)",e.spotLight1="rgba(122, 122, 156, 1)",e.spotLight2="rgba(192, 192, 192, 1)",this.stone=new Kt([17,32]),e.items.push(this.stone),e.music=e.sounds.fourFlams,e.music.loop=!0,e.music.play();const s=116;let i=500;for(let a=0;a<8;a+=2)for(let h=0;h<12;h+=2){const r=new X([-2,s]);r.stance="marching",r.wayPoints=[new p([49,s]),new p([49,s-10]),new p([28,s-31]),new p([21,s-65]),new p([9+a,s+h-80])],r.activeWayPoint=0,r.stunTimer.reset(i),e.monsters.push(r),i+=P([1e3,1500,2e3])}i=1e3;for(let a=0;a<10;a+=2)for(let h=0;h<12;h+=2){const r=new X([-2,s+1]);r.stance="marching",r.wayPoints=[new p([50,s+1]),new p([50,s-10]),new p([30,s-31]),new p([23,s-65]),new p([22+a,s+h-80])],r.activeWayPoint=0,r.stunTimer.reset(i),e.monsters.push(r),i+=P([1e3,1500,2e3])}}paradeSoldiers(e){for(let s of e.monsters)s instanceof X&&s.wayPoints.length>0&&(s.pos.x=s.wayPoints[s.wayPoints.length-1].x,s.pos.y=s.wayPoints[s.wayPoints.length-1].y,s.vel.x=0,s.vel.y=0,s.stance="passive")}update(e,s){super.update(e,s);const i=e.activePlayers[0];this.activeObjective===0&&i.bounds().collide(this.stone.bounds())&&(i.pos=this.stone.pos.add([0,-.5]),i.freeze=!0,this.paradeSoldiers(e),this.activeObjective++),this.activeObjective===1&&this.speechTimer>0?(this.speechTimer-=s,this.speechTimer<=0&&(i.freeze=!1,this.activeObjective++)):this.activeObjective===2&&e.activePlayers[0].activeState===F&&(e.monsters=e.monsters.filter(r=>!(r instanceof X&&r.hat)),e.nextChapter());let a=100-e.items.reduce((r,l)=>l instanceof b?r+1:r,0);const h=e.tiles.iterRandom(null,B);for(;a>0;){const r=h.next();r.value&&r.value.dist(i.pos)>=20&&e.items.push(new b(r.value,P([u.Iceberg1,u.SoldierIcecube,u.SoldierIcecube,x.BoatVerticle1]))),a--}}draw(e,s){super.draw(e,s)}}class Je extends ht{constructor(){super(...arguments);o(this,"title","Delaware River");o(this,"startState",F);o(this,"startPos",[43,40]);o(this,"intro",["The snow was unyielding, but Washington was determined to take Trenton so the plan continued. The ice and poor visibility made the crossing a tremendous task.","FACT CHECK: Although some boats did flip in the water, in reality no one died."]);o(this,"objectives",["Get to the other side!"])}start(e){super.start(e),e.weather.changeMode("heavySnow"),e.backLight="rgba(108, 108, 128, 1)",e.spotLight1="rgba(122, 122, 156, 1)",e.spotLight2="rgba(192, 192, 192, 1)",e.music=e.sounds.marinesHymn,e.music.loop=!0,e.music.play();const s=e.activePlayers[0];let a=s.pos.y+10;for(let h=0;h<e.tiles.dimW;h+=3){const r=a+P([0,1]),l=e.tiles.at([h,r]);l instanceof B&&e.items.push(new Vt(l))}e.items=e.items.filter(h=>h instanceof b?h.pos.dist(s.pos)>8:!0)}update(e,s){super.update(e,s);const i=e.activePlayers[0];if(i.activeState!==F&&!i.dead){e.nextChapter();return}const a=10,h=new w([Math.floor(e.camera.x)-a,Math.floor(e.camera.y)-a,Math.floor(e.camera.w)+a*2,Math.floor(e.camera.h)+a]);e.items=e.items.filter(y=>y instanceof b?h.collide(y.bounds()):!0);let r=0;for(let y of e.items)y instanceof b&&h.collide(y.bounds())&&r++;const l=[...e.tiles.iterRect(h)].filter(y=>y instanceof B),d=l.length,m=Math.floor(d*.05);if(r>=m)return;const S=10,k=m-r,R=Math.min(k,S),D=[u.Iceberg1,u.Iceberg2,u.Iceberg1,u.Iceberg2,u.Iceberg1,u.Iceberg2,u.Iceberg1,u.Iceberg2,u.Iceberg1,u.Iceberg2,u.SoldierIcecube,u.SoldierIcecube,x.BoatVerticle1];for(let y of It(l,R)){const[g,E]=y.pos;if(e.camera.collide([g,E,1,1])||i.pos.dist([g,E])<8||e.items.some(N=>N instanceof b&&Math.abs(N.pos[0]-g)<2&&Math.abs(N.pos[1]-E)<2))continue;const O=[g+Math.random(),E+Math.random()];e.items.push(new b(O,P(D)))}}oldUpdate(e,s){super.update(e,s);const i=e.activePlayers[0];i.activeState!==F&&!i.dead&&e.nextChapter(),e.items=e.items.filter(l=>!(l instanceof b&&l.pos.y>i.pos.y+40));let a=150-e.items.reduce((l,d)=>d instanceof b?l+1:l,0);const h=e.tiles.iterRandom(new w([Math.round(i.pos.x-20),Math.round(i.pos.y-e.camera.viewPortH/2)-10,100,10]),B),r=[u.Iceberg1,u.Iceberg2,u.Iceberg1,u.Iceberg2,u.Iceberg1,u.Iceberg2,u.Iceberg1,u.Iceberg2,u.Iceberg1,u.Iceberg2,u.SoldierIcecube,u.SoldierIcecube,x.BoatVerticle1];for(;a>0;){const l=h.next();l.value&&e.items.push(new b(l.value,P(r))),a--}}draw(e,s){super.draw(e,s)}}class qe extends ht{constructor(){super(...arguments);o(this,"title","The Frozen March to Trenton");o(this,"startPos",[143,44]);o(this,"intro",["Having crossed the river, Washington began a march South towards Trenton. The march started later than anticipated at around 3AM instead of the planned midnight.",'Look out for spies, men! No shooting!"']);o(this,"objectives",["Follow the river south until you get to Trenton. Stop any spies from reporting to Colonel Rall."])}start(e){super.start(e),e.weather.changeMode("sleet"),e.backLight="rgba(108, 108, 128, 1)";for(let h=9;h<100;h+=24){let r=140+Math.floor(h/2)+5;e.monsters.push(new ae(e.tiles.at([r+it(5),h+it(5)])))}e.music=e.sounds.holstMarch,e.music.loop=!0,e.music.play(),e.backLight="rgba(156, 156, 192, 1)",e.spotLight1="rgba(122, 122, 156, 1)",e.spotLight2="rgba(192, 192, 192, 1)";const s=e.activePlayers[0],i=s.pos.y,a=s.pos.x;for(let h=2;h<6;h+=2){let r=s;for(let l=2;l<26;l+=2){const d=new X([a+h,i-l]);d.stance="marching",d.wayPoints=[new p([190+h-l/2,124-l])],d.activeWayPoint=0,d.follows=r,r=d,e.monsters.push(d)}}}update(e,s){super.update(e,s);const i=e.activePlayers[0];i.pos.x>=195&&i.pos.y>=100&&e.nextChapter()}draw(e,s){super.draw(e,s)}}class Qe extends ht{constructor(){super(...arguments);o(this,"title","Trenton");o(this,"startPos",[198,108]);o(this,"intro",["By the time Washingtons army reached Trenton the sun had started to rise, it was around 8AM. The battle of Trenton had begun.","The Hessians had a total of 6 cannons during the battle, take that down to 5.","FACT CHECK: In reality the Americans actually had more cannons than the Hessians but for gameplay purposes, its more entertaining to be less powerful."]);o(this,"cannon",null);o(this,"cannonier",null);o(this,"objectives",["Destroy the cannon!"])}start(e){super.start(e),e.weather.changeMode("clear"),e.backLight="rgba(255,225,225,1)",e.spotLight1="rgba(192, 192, 192, 1)",e.spotLight2="rgba(230, 220, 210, 1)",e.music=e.sounds.toTheColors,e.music.loop=!0,e.music.play();for(let i=185;i<215;i+=5)e.monsters.push(new ot(e.tiles.at([i,107]))),e.monsters.push(new ot(e.tiles.at([i+3,122])));const s=Math.floor(229/2);this.cannon=new he([212,s]),e.monsters.push(this.cannon),this.cannonier=new ot([213,s]),this.cannonier.shoots=!1,e.monsters.push(this.cannonier)}update(e,s){super.update(e,s),this.cannonier.dead&&this.cannon.hp>1&&(this.cannon.hp=1),this.cannon.dead&&e.nextChapter()}draw(e,s){super.draw(e,s)}}class Ze extends ht{constructor(){super(...arguments);o(this,"title","Colonel Johann Rall");o(this,"startPos",[220,108]);o(this,"intro",["Great work, now take the final Hessian position held by Colonel Rall.","FACT CHECK: There wasnt actually an epic battle between Washington and Rall, however, Rall was injured and later died after the conflict"]);o(this,"boss",null);o(this,"launchTimer",0);o(this,"leftBarrier",180);o(this,"rightBarrier",247);o(this,"objectives",["Defeat Rall","Press ESC to exit"])}start(e){super.start(e,!1),e.weather.changeMode("clear"),e.backLight="rgba(255,255,255,1)",e.spotLight1="rgba(218, 218, 218, 1)",e.spotLight2="rgba(230, 230, 220, 1)";const s=e.activePlayers[0],i=Math.floor(s.pos.x-2);this.leftBarrier=i;for(let a=0;a<10;a+=2)e.tiles.fillLine([i-a,107],[i-a,123],xt);e.tiles.fillLine([248,107],[248,123],xt),this.boss=new ie(e.tiles.at([240,Math.floor(229/2)])),e.monsters.push(this.boss)}update(e,s){if(super.update(e,s),this.launchTimer-=s,this.launchTimer<0){let i=Math.random()>.5?this.leftBarrier+1:this.rightBarrier-1;for(let a=107;a<=123;a++)e.items.push(new qt(e.tiles.at([i,a]),null,i>this.leftBarrier+1?180:0));this.launchTimer=8e3}this.activeObjective===0&&this.boss.dead&&(e.gameState="dead",e.activePlayers[0].escaped=!0,this.activeObjective++)}draw(e,s){super.draw(e,s)}}class $e{constructor(){o(this,"timer_tick",null);o(this,"FPSframes",0);o(this,"FPStime",0);o(this,"FPS",0);o(this,"tileSize",16);o(this,"pixelSize",1);o(this,"updateTimes",new L([]));o(this,"drawTimes",new L([]));o(this,"updateMean",0);o(this,"updateMax",0);o(this,"drawMean",0);o(this,"drawMax",0);o(this,"weather",new Jt);o(this,"activeChapter",-1);o(this,"offscreenCanvas",new OffscreenCanvas(1,1));o(this,"chapters",[]);o(this,"music",null);o(this,"fillScreen",!1);o(this,"prefDimW",44);o(this,"prefDimH",26);o(this,"dimW",this.prefDimW);o(this,"dimH",this.prefDimH);o(this,"uiWidth",0);o(this,"uiHeight",2);o(this,"gameOffsetX",0);o(this,"gameOffsetY",0);o(this,"startLevelTime",0);o(this,"maxHp",3);o(this,"backLight","rgba(108, 108, 128 , 1)");o(this,"spotLight1","rgba(122, 122, 156, 1)");o(this,"spotLight2","rgba(192, 192, 192, 1)");o(this,"activePlayers",[]);o(this,"tiles",null);o(this,"monsters",null);o(this,"items",null);o(this,"multiplayerEnabled",!0);o(this,"competitiveMode",!1);o(this,"sandboxMode",!1);o(this,"gameState","loading");o(this,"showFPS",!1);o(this,"cullOffCamera",!0);o(this,"cells",0);o(this,"cellsCollected",0);o(this,"startingHp",3);o(this,"shakeAmount",0);o(this,"shakeX",0);o(this,"shakeY",0);o(this,"numReady",0);this.initSounds(),this.keyboard=new Ot(this),this.touch=new Yt(this),this.gamepadMgr=new Et(this),this.camera=new ne,this.tileSize=16;const t=Ue();this.sprites={base:new Xt(this,t.main,16)}}start(){window.onresize=()=>t.updateWindowSize(),this.tileSize=16,this.pixelSize=this.getTileScale(),this.fitMaptoTileSize(this.tileSize*this.pixelSize),this.setupCanvas();let t=this;this.sprites.base.sheet.onload=()=>t.ready(),this.mainMenu=new de(this),this.optionsMenu=new ce(this),this.inGameMenu=new pe(this)}ready(){this.numReady++,this.numReady>=1&&(this.gameState="title",this.playTitleMusic(),this.update())}update(){var s;let t=performance.now();this.gamepadMgr.updateGamepadStates();for(let i of Object.keys(M))z[i],M[i];for(let i of this.activePlayers)for(let a of Object.keys(i.controlStates))i.newControlStates[a]=i.oldControlStates[a]!==i.controlStates[a];if(this.gameState=="dead"&&!z.menu&&M.menu)this.gameState="scores";else if(this.gameState=="running"||this.gameState=="dead"){this.gameState=="running"&&M.menu&&!z.menu&&(this.music!==null&&this.music.pause(),this.gameState="paused"),this.gameState=="running"&&M.dash&&!z.dash&&q.player==null&&this.addPlayer();let i=15,a=Date.now();this.timer_tick!=null&&(i=Math.min(a-this.timer_tick,30)),this.timer_tick=a;for(let r of this.activePlayers)r.update(I,i);this.levelTime+=i,jt(i),this.weather.update(this,i);for(let r of this.items)r.update(this,i);this.remove_dead(this.items);for(let r of this.monsters)r.update(this,i);this.remove_dead(this.monsters),this.remove_dropped(this.activePlayers);let h=!0;for(let r of this.activePlayers)if(!r.dead){h=!1;break}!this.competitiveMode&&h&&this.gameState!="dead"&&(this.keyboard.player=null,this.touch.player=null,this.gamepadMgr.releaseAllPlayers(),ue(I,this.activePlayers[0].score,!1),this.gameState="dead",this.items.push(new te("gameOver",1e3)));for(let r of this.activePlayers)if(!r.dead&&!r.escaped)break;this.spawnCounter-=i,this.spawnCounter<=0&&this.activePlayers.length>0&&(this.spawnCounter=this.spawnRate,this.monsters.length<20&&le(this,this.activePlayers[0].pos,!0)),this.updateTimes.push(performance.now()-t),(s=this.chapters[this.activeChapter])==null||s.update(this,i),this.draw(i)}else this.gameState==="title"||this.gameState==="options"?this.showTitle():this.gameState==="scores"?(this.showTitle(),!z.dash&&M.dash&&(this.gameState="title",this.playTitleMusic())):this.gameState==="paused"&&(this.showTitle(),this.gameState==="paused"&&!z.menu&&M.menu&&(this.gameState="running",this.music!==null&&this.music.play()));Lt(M);for(let i of this.activePlayers)i.oldControlStates={...i.controlStates};let e=this;window.requestAnimationFrame(()=>e.update())}draw(t){var i;let e=performance.now();const s=a=>Math.round(a*this.tileSize*this.pixelSize)/this.tileSize/this.pixelSize;if(this.gameState==="running"||this.gameState==="dead"){this.screenshake(),this.camera.update(this,t),this.offscreenCtx.save(),this.offscreenCtx.resetTransform(),this.offscreenCtx.scale(this.tileSize*this.pixelSize,this.tileSize*this.pixelSize),this.offscreenCtx.clearRect(0,0,this.W,this.H),this.offscreenCtx.translate(s(-this.camera.x),s(-this.camera.y));let a=0,h=0,r=this.tiles.dimW,l=this.tiles.dimH;this.cullOffCamera&&(a=Math.floor(this.camera.x),h=Math.floor(this.camera.y),r=Math.ceil(this.camera.right),l=Math.ceil(this.camera.bottom));for(let y=a;y<r;y++)for(let g=h;g<l;g++)this.tiles.at([y,g]).draw(I);const d=this.offscreenCtx;let f=this.camera;d.globalCompositeOperation="multiply",this.activePlayers[0],d.fillStyle=this.backLight,d.fillRect(-s(f.pos.x)-1,-s(f.pos.y)-1,s(this.W)+2,s(this.H)+2),d.globalCompositeOperation="source-over";const m=[...this.monsters,...this.activePlayers,...this.items];if(m.sort((y,g)=>y.bounds().bottom-g.bounds().bottom),this.cullOffCamera)for(let y of m)y.sprite&&(y.sprite.length===2?f.shrinkBorders(-2).collide(new w([y.pos.x,y.pos.y,1,1]))&&y.draw(this):f.shrinkBorders(-2).collide(new w([y.pos.x,y.pos.y,y.sprite[2],y.sprite[3]]))&&y.draw(this));else for(let y=0;y<this.items.length;y++)this.items[y].draw(this);this.weather.draw(this,t);{const y=this.activePlayers[0];d.globalCompositeOperation="multiply";let g=d.createRadialGradient(y.pos[0]+.5,y.pos[1]+.5,f.viewPortW/4,y.pos[0]+.5,y.pos[1]+.5,2);g.addColorStop(0,I.spotLight1),g.addColorStop(1,I.spotLight2),d.fillStyle=g,d.fillRect(-s(f.pos.x)-1,-s(f.pos.y)-1,s(this.W)+2,s(this.H)+2),d.globalCompositeOperation="source-over"}this.shakeX=0,this.shakeY=0;const S=this.W,k=this.H;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.offscreenCanvas,0,0,this.W*this.tileSize*this.pixelSize,this.H*this.tileSize*this.pixelSize),this.ctx.save(),this.ctx.scale(this.tileSize*this.pixelSize,this.tileSize*this.pixelSize);let R=[new p([0,0]),new p([S-6,0]),new p([0,k-1]),new p([S-6,k-1])],D=0;for(let y of this.activePlayers){let g=R[D];y.drawHUD(I,g),D++}(i=this.chapters[this.activeChapter])==null||i.draw(this,t),this.drawTimes.push(performance.now()-e),this.drawFps(t),this.ctx.restore(),this.offscreenCtx.restore()}}drawFps(t){if(this.showFPS){this.FPSframes+=1,this.FPStime+=t,this.FPStime>1e3&&(this.FPS=Math.round(10*1e3*this.FPSframes/this.FPStime)/10,this.FPStime=0,this.FPSframes=0,this.updateMean=Math.round(this.updateTimes.mean()*100)/100,this.updateMax=Math.round(this.updateTimes.max()*100)/100,this.updateTimes=new L([]),this.drawMean=Math.round(this.drawTimes.mean()*100)/100,this.drawMax=Math.round(this.drawTimes.max()*100)/100,this.drawTimes=new L([]));let e=this.cullOffCamera?"CULL":"";this.drawText("FPS: "+this.FPS+"  Update: "+this.updateMean+"ms (peak "+this.updateMax+")  Draw: "+this.drawMean+"ms (peak "+this.drawMax+") "+e,3/8,!0,this.H-.25,"DarkSeaGreen")}}setupCanvas(){this.canvas=document.querySelector("canvas"),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.canvas.style.width=this.canvas.width+"px",this.canvas.style.height=this.canvas.height+"px",this.camera.scrollable?(this.gameOffsetX=0,this.gameOffsetY=0):(this.gameOffsetX=0,this.gameOffsetY=0),this.ctx=this.canvas.getContext("2d"),this.ctx.imageSmoothingEnabled=!1,this.offscreenCanvas.width=Math.ceil(this.W*this.tileSize*this.pixelSize),this.offscreenCanvas.height=Math.ceil(this.H*this.tileSize*this.pixelSize),this.offscreenCtx=this.offscreenCanvas.getContext("2d"),this.offscreenCtx.imageSmoothingEnabled=!1}getTileScale(){let t=window.innerHeight,e=window.innerWidth,s;return this.camera.scrollable?s=Math.min(t/(this.camera.viewPortH+this.uiHeight)/this.tileSize,e/(this.camera.viewPortW+this.uiWidth)/this.tileSize):s=Math.min(t/(this.prefDimH+this.uiHeight)/this.tileSize,e/(this.prefDimW+this.uiWidth)/this.tileSize),this.fillScreen||(s=Math.floor(s)),s}fitMaptoTileSize(t){let e=window.innerWidth,s=window.innerHeight;this.camera.scrollable?(this.camera.viewPortW=Math.floor(e/t),this.camera.viewPortH=Math.floor(s/t)):(this.dimW=Math.floor(e/t),this.dimH=Math.floor(s/t),this.camera.viewPortW=this.dimW,this.camera.viewPortH=this.dimH)}get W(){return this.camera.viewPortW}get H(){return this.camera.viewPortH}updateWindowSize(){this.competitiveMode?this.camera.scrollable=!1:(this.camera.scrollable=!0,this.camera.viewPortW=14,this.camera.viewPortH=8),this.tileSize=16,this.pixelSize=this.getTileScale(),this.fitMaptoTileSize(this.tileSize*this.pixelSize),this.setupCanvas(),this.mainMenu.updateWindowSize(this),this.optionsMenu.updateWindowSize(this)}initSounds(){this.sounds=Ve()}playSound(t,e=0,s=!1,i=!0){return this.sounds[t].currentTime=e,this.sounds[t].loop=s,i&&this.sounds[t].play(),this.sounds[t]}showTitle(){this.ctx.save(),this.ctx.scale(this.tileSize*this.pixelSize,this.tileSize*this.pixelSize),this.ctx.fillStyle="rgba(0,0,0,.75)",this.ctx.fillRect(0,0,this.W,this.H),this.drawText("1776: Washington's Crossing",1.25,!0,this.H/2-3.5,"DarkRed"),this.drawText("by Evan Moore",1,!0,this.H/2-2,"White"),this.gameState==="title"?(this.mainMenu.update(this,0),this.mainMenu.draw(this)):this.gameState==="options"?(this.optionsMenu.update(this,0),this.optionsMenu.draw(this)):this.gameState==="paused"?(this.inGameMenu.update(this,0),this.inGameMenu.draw(this)):this.gameState==="scores"&&fe(this),this.ctx.restore()}addPlayer(){let t=new K;t.hp=this.startingHp,t.maxHp=this.startingHp,t.pos=this.tiles.startTile.pos,t.controller=q,q.attachToPlayer(t),this.activePlayers.push(t)}startGame(){this.timer_tick=null,this.score=0,this.cellsCollected=2,this.activePlayers=[];let t=new K;this.activePlayers.push(t),this.multiplayerEnabled?q.attachToPlayer(t):(this.keyboard.attachToPlayer(t),this.touch.attachToPlayer(t),this.gamepadMgr.attachAllToPlayer(t)),t.hp=this.startingHp,t.maxHp=this.startingHp,this.chapters=[new Ke,new Je,new qe,new Qe,new Ze],this.weather.reset(),this.startLevel(),this.gameState="running"}nextChapter(){this.activeChapter++,this.chapters[this.activeChapter].start(this)}startLevel(){this.spawnRate=1e4,this.spawnCounter=this.spawnRate,this.levelTime=this.startLevelTime,this.camera.pos=null,this.activeChapter=0,this.competitiveMode||this.cellsCollected,re(I);for(let t of this.activePlayers)t.pos=this.tiles.startTile.pos,t.escaped=!1,t.dead&&t.revive(this);this.chapters[this.activeChapter].start(this)}playTitleMusic(){I.music!==null&&(I.music.pause(),I.music.currentTime=0),this.music=this.sounds.starSpangled,this.music.loop=!0,this.music.play()}screenshake(){this.shakeAmount&&this.shakeAmount--;let t=Math.random()*Math.PI*2;this.shakeX=Math.round(Math.cos(t)*this.shakeAmount),this.shakeY=Math.round(Math.sin(t)*this.shakeAmount)}drawText(t,e,s,i,a,h="IM Fell English SC"){this.ctx.fillStyle=a,this.ctx.font=e+"px "+h;let r;s?r=(this.W-this.ctx.measureText(t).width)/2:r=this.W-this.uiWidth*(this.tileSize-1),this.ctx.fillText(t,r,i)}drawTileText(t,e,s,i){this.ctx.fillStyle=i,this.ctx.font=e+"px IM Fell English SC";let a=s.y+1-(1-e)/2,h=s.x+(1-this.ctx.measureText(t).width)/2;this.ctx.fillText(t,h,a)}nearestPlayer(t){let e=1e9,s=null;for(let i of this.activePlayers)if(!i.dead){let a=i.pos.dist(t);s=a<e?i:s,e=a<e?a:e}return[s,e]}monsters_and_players(t=!0,e=null){return!t&&(!this.competitiveMode||this.levelTime>this.startLevelTime+1e4)?this.monsters.filter(s=>s!==e):this.monsters.concat(this.activePlayers).filter(s=>s!==e)}monsters_with_other_players(t){if(!this.competitiveMode||this.levelTime>this.startLevelTime+1e4)return this.monsters;let e=this.activePlayers.indexOf(t),s=this.activePlayers.slice(0,e).concat(this.activePlayers.slice(e+1));return this.monsters.concat(s)}other_players(t){let e=this.activePlayers.indexOf(t);return this.activePlayers.slice(0,e).concat(this.activePlayers.slice(e+1))}remove(t,e){for(let s=0;s<t.length;s++)if(t[s]==e){t.splice(s,1);return}}remove_dead(t){for(let e=t.length-1;e>=0;e--)t[e].dead&&t.splice(e,1)}remove_dropped(t){for(let e=t.length-1;e>=0;e--)t[e].dropFromGame&&(t[e].controller.attachToPlayer(),this.items.push(new $t(t[e])),t.splice(e,1))}addGunPlatform(t){}addChips(t,e){const s=new Zt(t,e);return this.items.push(s),s}addBoom(t,e){const s=new ee(t,e);return this.items.push(s),s}addTrapBlade(t){const e=new se(t);return this.items.push(e),e}}var I=new $e;I.start();
