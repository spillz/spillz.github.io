var kt=Object.defineProperty;var Pt=(h,t,e)=>t in h?kt(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var n=(h,t,e)=>Pt(h,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();function Ht(h,t){for(let e=1e3;e>0;e--)if(t())return;throw"Timeout while trying to "+h}function Z(h,t=0){return t!=0?h+Math.floor(Math.random()*(t-h)):Math.floor(Math.random()*h)}function Dt(h,t){return[Z(h),Z(t)]}function xt(h){let t=h.length,e;for(;t!=0;)e=Math.floor(Math.random()*t),t--,[h[t],h[e]]=[h[e],h[t]];return h}function C(h){return h[Math.floor(Math.random()*h.length)]}class B extends Array{constructor(...t){t.length==1&&t[0]instanceof Array?super(...t[0]):super(...t)}sum(){let t=0;return this.forEach(e=>t+=e),t}mean(){return this.sum()/this.length}max(){return Math.max.apply(null,this)}min(){return Math.min.apply(null,this)}vars(){let t=0;return this.forEach(e=>t+=e*e),(t-this.length*this.mean()^2)/(this.length-1)}var(){let t=0;return this.forEach(e=>t+=e*e),t/this.length-this.mean()^2}std(){return Math.sqrt(this.var())}add(t){let e=new B(this);if(t instanceof Array||t instanceof B)for(let s=0;s<this.length;s++)e[s]+=t[s];else for(let s=0;s<this.length;s++)e[s]+=t;return e}mul(t){let e=new B(this);if(t instanceof Array||t instanceof B)for(let s=0;s<this.length;s++)e[s]*=t[s];else for(let s=0;s<this.length;s++)e[s]*=t;return e}dot(t){return this.mul(t).sum()}abs(){return Math.abs.apply(null,this)}shift(t){let e=new B;for(let s=-t;s<this.length-t;s++)s<0||s>=this.length?e.push(NaN):e.push(this[s]);return e}filter(t){return new B(super.filter(t))}dropNaN(){return this.filter(t=>!Number.isNaN(t))}}class c extends Array{constructor(t){super(),this[0]=t[0],this[1]=t[1]}static random(t){return new c(Dt(t[0],t[1]))}add(t){return new c([this[0]+t[0],this[1]+t[1]])}subtract(t){return new c([this[0]-t[0],this[1]-t[1]])}scale(t){return new c([this[0]*t,this[1]*t])}mul(t){return new c([this[0]*t[0],this[1]*t[1]])}dot(t){return this[0]*t[0]+this[1]*t[1]}dist(t){return Math.hypot(this[0]-t[0],this[1]-t[1])}set x(t){this[0]=t}set y(t){this[1]=t}get x(){return this[0]}get y(){return this[1]}}class f extends Array{constructor(t){super(),this.length=4,this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3]}set x(t){this[0]=t}set y(t){this[1]=t}set w(t){this[2]=t}set h(t){this[3]=t}set pos(t){this[0]=t[0],this[1]=t[1]}get pos(){return new c([this[0],this[1]])}get x(){return this[0]}get y(){return this[1]}get w(){return this[2]}get h(){return this[3]}get right(){return this[0]+this[2]}get bottom(){return this[1]+this[3]}get center_x(){return this[0]+this[2]/2}get center_y(){return this[1]+this[3]/2}get center(){return new c([this.center_x,this.center_y])}shift(t){return new f([this.x+t[0],this.y+t[1],this.w,this.h])}shrinkBorders(t){return new f([this.x+t,this.y+t,this.w-t*2,this.h-t*2])}scale(t,e=!0){if(e){let s=[this[2]*t,this[3]*t];return new f([this[0]+.5*(this[2]-s[0]),this[1]+.5*(this[3]-s[1]),s[0],s[1]])}else{let s=[this[2]*t,this[3]*t];return new f([this[0],this[1],s[0],s[1]])}}collide(t){return this.x<t.x+t.w&&this.x+this.w>t.x&&this.y<t.y+t.h&&this.h+this.y>t.y}contact(t){return this.x<=t.x+t.w&&this.x+this.w>=t.x&&this.y<=t.y+t.h&&this.h+this.y>=t.y}}function rt(h,t){return Math.floor(Math.random()*(t-h+1))+h}function pt(h,t=20){let e="";return h.forEach(s=>{s+="";for(let i=s.length;i<t;i++)s+=" ";e+=s}),e}function ut(h,t,e,s,i="IM Fell English SC"){h.font=s+"px "+i;const a=t.split(`
`),l=[];for(let r of a){const d=r.split(/\s+/);let p="";for(let w of d){const m=p?p+" "+w:w;h.measureText(m).width>e&&p?(l.push(p),p=w):p=m}p&&l.push(p)}return l}function ft(h,t,e,s,i,a=10,l="IM Fell English SC",r=1.2){h.font=a+"px "+l,h.fillStyle=i,h.textBaseline="top";const d=a*r;for(let p=0;p<t.length;p++)h.fillText(t[p],e,s+p*d);return t.length*d}class T{constructor(t,e=0){this.elapsed=0,this.timer=t,this.triggered=!1,e>0&&this.tick(e)}finished(){return this.elapsed>=this.timer}tick(t){return this.elapsed>=this.timer?(this.triggered&&(this.triggered=!1),!1):(this.elapsed+=t,this.elapsed>=this.timer?(this.triggered=!0,!0):!1)}reset(t=-1,e=0){this.elapsed=e,this.triggered=!1,t>=0&&(this.timer=t)}}const b={left:!1,right:!1,up:!1,down:!1,cycle:!1,use:!1,dodge:!1,dash:!1,camera:!1,menu:!1};var vt={...b};function nt(){return{...vt}}var R={...b};({...b});function Ct(h){R={...h}}var E=null,Ft={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down",a:"left",d:"right",w:"up",s:"down",j:"dash",k:"dodge",l:"cycle",i:"use"," ":"dash",z:"dodge",x:"cycle",c:"use",0:"camera",Escape:"menu"};class ot{constructor(){this.controlStates={...vt},this.attach_to_player(),window.addEventListener("blur",t=>{this.clearPressedAll()})}attach_to_player(t=null){this.player=t,E=this,t!=null&&(this.player.controller=this)}set(t,e=!0){b[t]=e,E=this;let s=this.player;s!=null&&(s.controlStates[t]=e)}clearPressedAll(){for(const t in this.controlStates)this.controlStates[t]=!1}vibrate(t,e,s){}}class Bt extends ot{constructor(t,e=null){super(),this.game=t,e==null&&(e=Ft),this.keyMap=e;let s=this;document.onkeydown=function(i){s.keyDownHandler(i)},document.onkeyup=function(i){s.keyUpHandler(i)}}keyDownHandler(t){if(this.game.gameState==="title"&&this.game.music===null&&this.game.playTitleMusic(),t.key=="p"&&(this.game.fillScreen=!this.game.fillScreen,this.game.updateWindowSize()),t.key=="f"&&(this.game.showFPS=!this.game.showFPS,this.game.updateWindowSize()),t.key=="G"&&(this.game.cullOffCamera=!this.game.cullOffCamera),t.key=="C"&&this.game.gameState==="running"&&this.game.activePlayers.length>0&&this.game.activeChapter<this.game.chapters.length-1){const e=this.game.activePlayers[0],s=this.game.chapters[this.game.activeChapter+1];e.pos=new c(s.startPos),this.game.camera.pos=new c([-e.pos.x+this.game.camera.viewPortW/2,-e.pos.y+this.game.camera.viewPortH/2]),e.setState(this.game,s.startState),this.game.nextChapter()}t.key=="H"&&this.game.gameState==="running"&&this.game.activePlayers.length>0&&this.game.activePlayers[0].hp++,t.key=="T"&&this.game.gameState==="running"&&this.game.activePlayers.length>0&&(this.game.activePlayers[0].pos=new c([19,21]),this.game.camera.pos=new c([-19+this.game.camera.viewPortW/2,-21+this.game.camera.viewPortH/2])),t.key in this.keyMap&&this.set(this.keyMap[t.key],!0)}keyUpHandler(t){t.key in this.keyMap&&this.set(this.keyMap[t.key],!1)}}class Rt extends ot{constructor(t,e){super(),this.game=t,this.gamepad=e,this.thresh=.2,this.internalStates={...this.controlStates}}set(t,e=!0){this.internalStates[t]!=e&&(this.internalStates[t]=e,super.set(t,e))}vibrate(t,e,s){this.game.activePlayers.length==1&&window.navigator.vibrate(s),this.gamepad.vibrationActuator!=null&&this.gamepad.vibrationActuator.playEffect("dual-rumble",{startDelay:0,duration:s,weakMagnitude:t,strongMagnitude:e})}}class zt{constructor(t){n(this,"gamepads",{});let e=this;this.game=t,window.addEventListener("gamepadconnected",function(s){e.connected(s)}),window.addEventListener("gamepaddisconnected",function(s){e.disconnected(s)})}connected(t){this.gamepads[t.gamepad.index]=new Rt(this.game,t.gamepad)}disconnected(t){let e=this.gamepads[t.gamepad.index];e.player!=null&&(e.player.dead=!0,e.player.dropFromGame=!0),delete this.gamepads[t.gamepad.index]}update_gamepad_states(){let t=navigator.getGamepads();if(t!=null)for(let e of t){if(e==null)continue;let s=this.gamepads[e.index];s.gamepad=e,s.set("dash",this.buttonPressed(e.buttons[0])),s.set("cycle",this.buttonPressed(e.buttons[1])||this.buttonPressed(e.buttons[6])),s.set("use",this.buttonPressed(e.buttons[2])||this.buttonPressed(e.buttons[7])),s.set("dodge",this.buttonPressed(e.buttons[5])),s.set("camera",this.buttonPressed(e.buttons[12])),s.set("menu",this.buttonPressed(e.buttons[9])),s.set("left",e.axes[0]<-s.thresh&&e.axes[0]<-.5*Math.abs(e.axes[1])),s.set("right",e.axes[0]>s.thresh&&e.axes[0]>.5*Math.abs(e.axes[1])),s.set("up",e.axes[1]<-s.thresh&&e.axes[1]<-.5*Math.abs(e.axes[0])),s.set("down",e.axes[1]>s.thresh&&e.axes[1]>-.5*Math.abs(e.axes[0]))}}buttonPressed(t){return typeof t=="object"?t.pressed:t==1}attach_all_to_player(t){for(let e of Object.keys(this.gamepads))this.gamepads[e].attach_to_player(t)}release_all_players(){for(let t of Object.keys(this.gamepads))this.gamepads[t].attach_to_player()}}class Wt extends ot{constructor(e){super();n(this,"canvas");this.game=e;const s=document.getElementById("canvas");if(s instanceof HTMLCanvasElement){this.canvas=s;let i=this;s.addEventListener("touchstart",function(a){i.process_touchstart(a)},!1),s.addEventListener("touchmove",function(a){i.process_touchmove(a)},!1),s.addEventListener("touchcancel",function(a){i.process_touchend(a)},!1),s.addEventListener("touchend",function(a){i.process_touchend(a)},!1),document.addEventListener("backbutton",function(a){i.process_back(a)},!0)}this.dPad=[-1,0,0],this.butMenu=[-1,0,0],this.butDodge=[-1,0,0],this.butDash=[-1,0,0],this.butInv=[-1,0,0],this.butCamera=[-1,0,0]}process_back(e){this.set("menu",!0)}process_touchstart(e){let s=this.canvas;e.touches[0];for(let i of e.changedTouches)i.clientX<.5*s.width?i.clientY>.33*s.height?this.dPad=[i.identifier,i.clientX,i.clientY]:(this.set("camera"),this.butCamera=[i.identifier,i.clientX,i.clientY]):i.clientY>.66*s.height?(this.set("dash"),this.butDash=[i.identifier,i.clientX,i.clientY]):i.clientY<.33*s.height?(this.set("menu"),this.butMenu=[i.identifier,i.clientX,i.clientY]):(this.set("dodge"),this.butDodge=[i.identifier,i.clientX,i.clientY]);e.preventDefault()}process_touchmove(e){for(let s of e.changedTouches)if(s.identifier==this.dPad[0]){let i=this.dPad[1],a=this.dPad[2];for(let l of["left","right","up","down","run","camera"])this.set(l,!1);this.set("left",s.clientX<i-.1*this.game.tileSize&&s.clientX-i<-.5*Math.abs(s.clientY-a)),this.set("right",s.clientX>i+.1*this.game.tileSize&&s.clientX-i>.5*Math.abs(s.clientY-a)),this.set("up",s.clientY<a-.1*this.game.tileSize&&s.clientY-a<-.5*Math.abs(s.clientX-i)),this.set("down",s.clientY>a+.1*this.game.tileSize&&s.clientY-a>.5*Math.abs(s.clientX-i)),this.set("run",s.clientX<i-this.game.tileSize||s.clientX>i+this.game.tileSize||s.clientY>a+this.game.tileSize||s.clientY<a-this.game.tileSize)}e.preventDefault()}process_touchend(e){for(let s of e.changedTouches){if(s.identifier==this.dPad[0]){for(let i of["left","right","up","down"])this.set(i,!1);this.dPad=[-1,0,0]}s.identifier==this.butInv[0]&&this.set("cycle",!1),s.identifier==this.butMenu[0]&&this.set("menu",!1),s.identifier==this.butDodge[0]&&this.set("dodge",!1),s.identifier==this.butDash[0]&&this.set("dash",!1)}e.preventDefault()}vibrate(e,s,i){window.navigator.vibrate(i)}}class O extends f{constructor(t,e=null,s=!0,i=!1){super([t[0],t[1],1,1]),this.sprite=e,this.passable=s,this.climbable=i,this.climbSpeed=1/300,this.hp=100}bounds(){return new f([this.x,this.y,1,1])}dist(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}draw(t){this.sprite!=null&&t.sprites.base.draw(this.sprite,this.x,this.y)}playerInteract(t,e,s){}entityInteract(t,e,s){}initItems(t){}hitFrom(t,e,s,i){}}class P extends O{constructor(t,e=null){super(t,e,!0,!1)}}function Ot(h){z.riverTimer+=h,z.riverSprite=[u.Water1,u.Water2,u.Water3,u.Water4][Math.floor(z.riverTimer/500)%4],N.lanternTimer+=h,N.lanternSprite=[y.Lantern1,y.Lantern2,y.Lantern3,y.Lantern4][Math.floor(N.lanternTimer/500)%4]}class lt extends O{constructor(){super(...arguments);n(this,"passable",!1)}}class At extends O{constructor(e,s=null){s===null&&(s=C([y.Tree1,y.Tree2]));super(e,s,!0,!1);n(this,"passable",!1)}draw(e){e.sprites.base.draw(u.Snow1,this.x,this.y),e.sprites.base.drawRotatedMultitile(this.sprite,this.x,this.y-1,0)}}class wt extends O{constructor(e,s=null){s===null&&(s=u.Hessian1);super(e,s,!0,!1);n(this,"passable",!1);this.hat=C([!1,!1,!1,!1,!0])}draw(e){e.sprites.base.draw(u.Snow1,this.x,this.y),e.sprites.base.draw(this.sprite,this.x,this.y),this.hat&&e.sprites.base.draw(u.HessianHelmet1,this.x,this.y-.5)}}const j=class j extends O{constructor(t,e=null){super(t,e,!1,!1)}draw(t){t.sprites.base.draw(u.Snow1,this.x,this.y),j.lanternSprite&&t.sprites.base.drawRotatedMultitile(j.lanternSprite,this.x,this.y-1,0)}};n(j,"lanternTimer",0),n(j,"lanternSprite");let N=j;const Q=class Q extends O{constructor(e,s=null){super(e,s,!0,!1);n(this,"passable",!1)}draw(e){e.sprites.base.draw(Q.riverSprite,this.x,this.y)}};n(Q,"riverTimer",0),n(Q,"riverSprite");let z=Q;class $ extends O{constructor(t,e=null){e==null&&(e=C([u.Snow1,u.Snow1,u.Snow1,u.Snow1,u.Snow1,u.Snow1,u.Snow2,u.Snow3])),super(t,e,!0,!1)}draw(t){super.draw(t)}}class x extends O{constructor(t,e=null){e==null&&(e=C([u.RoadNS,u.RoadEW])),super(t,e,!0,!1)}draw(t){super.draw(t)}}class k{constructor(t,e){this.pos=new c([0,0]),this.vel=new c([0,0]),this.oldVel=new c([0,0]),this.angle=0,this.isPlayer=!1,this.size=new c([1,1]),this.boundingBox=new f([.25,.25,.5,.5]),this.boundingBoxes=[],this.facing=1,this.falling=!1,this.canFall=!0,this.dead=!1,this.sprite=e,this.hitBox=new f(this.boundingBox),t instanceof O||t===null?this.move(t):this.pos=new c(t),this.oldPos=new c(this.pos)}move(t){t!==null?this.pos=new c([t[0],t[1]]):this.pos=new c([-1,-1])}rotatedBoundingBox(t=null,e=null,s=null,i=null,a=null){s=s??this.getFlipped(),e=e??this.angle,t==null&&(t=this.sprite.length==2?[.5,.5]:[.5*this.sprite[2],.5*this.sprite[3]]),i==null&&(i=[this.boundingBox[0]+this.boundingBox[2]/2,this.boundingBox[1]+this.boundingBox[3]/2]),a==null&&(a=this.boundingBox.slice(2,4));let l=(i[0]-t[0])*(1-2*s),r=i[1]-t[1],d=Math.cos(e/180*Math.PI),p=Math.sin(e/180*Math.PI),w=-(l-l*d+r*p),m=-(r-l*p-r*d);return new f([(i[0]-t[0])*(1-2*s)+t[0]+w-a[0]/2,i[1]+m-a[1]/2,a[0],a[1]])}bounds(t=null,e=null){return t==null&&(t=this.pos),e==null&&(e=this.boundingBox!=null?this.boundingBox:this.boundingBoxes[0]),new f([t[0]+e[0],t[1]+e[1],e[2],e[3]])}hitBounds(t=null){return t==null&&(t=this.pos),new f([t[0]+this.hitBox[0],t[1]+this.hitBox[1],this.hitBox[2],this.hitBox[3]])}getDisplayX(){return this.pos.x}getDisplayY(){return this.pos.y}getFlipped(){return this.facing==-1}draw(t){t.sprites.base.draw([this.sprite[0],this.sprite[1]],this.getDisplayX(),this.getDisplayY(),this.getFlipped())}draw_bounds(t){if(this.boundingBox!=null){let e=this.bounds(this.pos,this.boundingBox);e[0]=e[0]*t.tileSize+t.shakeX+t.gameOffsetX,e[1]=e[1]*t.tileSize+t.shakeY+t.gameOffsetY,e[2]=e[2]*t.tileSize,e[3]=e[3]*t.tileSize,t.ctx.beginPath(),t.ctx.lineWidth=t.tileSize/16,t.ctx.strokeStyle="#BAC3D9",t.ctx.rect(e[0],e[1],e[2],e[3]),t.ctx.stroke()}else for(let e of this.boundingBoxes){let s=this.bounds(this.pos,e);s[0]=s[0]*t.tileSize+t.shakeX+t.gameOffsetX,s[1]=s[1]*t.tileSize+t.shakeY+t.gameOffsetY,s[2]=s[2]*t.tileSize,s[3]=s[3]*t.tileSize,t.ctx.beginPath(),t.ctx.lineWidth=t.tileSize/16,t.ctx.strokeStyle="#BAC3D9",t.ctx.rect(s[0],s[1],s[2],s[3]),t.ctx.stroke()}}entityInteract(t,e,s){}entityCollide(t,e){}update(t,e){}}class K extends k{constructor(t,e,s=1){super(t,e),this.hp=s,this.maxHp=s,this.facing=rt(0,1)*2-1,this.topSpeed=1/600,this.jumpSpeed=1/350,this.maxFallSpeed=1/50,this.hitDamage=1,this.spawnTimer=1e3,this.spawnElapsed=0,this.stunTimer=new T(0,0),this.hitTimer=new T(0,0),this.boundingBox=new f([.25,.5,.5,.5]),this.hitBox=new f([.25,.2,.5,.8]),this.drone=!1,this.climbing=!1,this.falling=!1,this.dying=!1,this.intelLevel=1,this.elevation=0,this.stance="aggressive",this.playerFriendly=!1,this.destination=new c([0,0])}getDisplayY(){return super.getDisplayY()-this.elevation}draw(t){t.sprites.monsters.draw([this.dying?1:0,this.sprite[1]],this.getDisplayX(),this.getDisplayY(),this.getFlipped()),this.hitTimer.finished()||u.Strike.length===2&&t.sprites.entitiesItems.draw(u.Strike,this.getDisplayX(),this.getDisplayY(),this.getFlipped())}die(t){this.stun(),this.dying=!0}death(t){if(this.dead=!0,!this.isPlayer){if(t.tiles.closestTile(this.bounds())instanceof P||this.playerFriendly)return;t.activePlayers[0].score++}}heal(t){this.hp=Math.min(this.maxHp,this.hp+t)}tile_pos(){return new c([Math.round(this.pos.x),Math.ceil(this.pos.y)])}stun(t=2e3){this.dying||this.stunTimer.reset(t)}update(t,e){if(this.spawnElapsed+=e,this.spawnElapsed<this.spawnTimer)return;this.hitTimer.tick(e),this.stunTimer.tick(e);let s=!this.stunTimer.finished();if(!s&&this.dying){this.death(t);return}if(this.dying&&(this.vel=this.vel.scale(.9**(e/15))),this.stance==="fleeing"){const i=t.activePlayers[0],a=this.pos.dist(i.pos);if(a<10){this.destination=i.pos.subtract(this.pos).scale(-1).add(this.pos);const l=this.destination.subtract(this.pos),r=this.destination.dist(this.pos);this.vel=l.scale(this.topSpeed/r)}else if(a<25){this.destination=new c(i.pos);const l=this.destination.subtract(this.pos),r=this.destination.dist(this.pos);this.vel=l.scale(this.topSpeed/r)}else this.vel.fill(0)}if(t.tiles.move(this,e),!s&&!this.playerFriendly)for(let i of t.activePlayers)i.hitBounds().collide(this.bounds())&&(i.hitFrom(t,this.pos,this.hitDamage,this.hitDamage),i.stun(500*this.hitDamage));this.pos.y>t.tiles.dimH+3&&this.die(t)}hitFrom(t,e,s,i=0){this.hp-=s,s>0&&this.hitTimer.reset(200),this.hp<=0&&this.die(t);const a=this.pos.dist(e);if(a>0){const l=this.pos.add(e.scale(-1)).scale(1/a);this.vel.x=i*1/200*l[0],this.vel.y=i*1/200*l[1]}this.falling=!0}tile_collide(t){return t.bounds.collide(this.bounds())}monster_collide(t){return t.bounds.collide(this.bounds())}fallCheck(t,e){return!1}}class _t extends K{constructor(t){super(t,y.Rall1,1),this.hp=10,this.topSpeed=.5*this.topSpeed,this.fallOrigin=null,this.leapDestination=new c([0,0]),this.attackTimer=new T(1e4,Math.random()*5e3),this.stance="passive",this.immune=!0,this.boundingBox=new f([.75,1,1.5,2]),this.hitBox=new f([.75,1,1.5,2])}draw(t){if(this.dead)return;this.facing===0&&console.log("FACING 0");const e=1-.5*this.facing;this.stance==="passive"?(t.sprites.base.drawRotatedMultitile(y.RallHorse1,this.getDisplayX(),this.getDisplayY(),0,!this.getFlipped()),t.sprites.base.drawRotatedMultitile(y.RallHorsback,this.getDisplayX()+e,this.getDisplayY()-.125,0,!this.getFlipped())):this.stance==="preLeap"?(t.sprites.base.drawRotatedMultitile(y.RallHorse1,this.getDisplayX(),this.getDisplayY(),0,!this.getFlipped()),t.sprites.base.drawRotatedMultitile(y.RallHorsback,this.getDisplayX()+e,this.getDisplayY()-.125,0,!this.getFlipped())):this.stance==="leap"?(t.sprites.base.drawRotatedMultitile(y.RallHorse1,this.getDisplayX(),this.getDisplayY(),0,!this.getFlipped()),t.sprites.base.drawRotatedMultitile(y.RallHorsback,this.getDisplayX()+e,this.getDisplayY()-.125,0,!this.getFlipped())):this.stance==="postLeap"&&(t.sprites.base.drawRotatedMultitile(y.RallHorse1,this.getDisplayX(),this.getDisplayY(),0,!this.getFlipped()),t.sprites.base.drawRotatedMultitile(y.RallHorsback,this.getDisplayX()+e,this.getDisplayY()-.125,0,!this.getFlipped()))}update(t,e){if(super.update(t,e),!this.dead){if(this.stance==="passive")this.attackTimer.tick(e),this.attackTimer.finished()&&(this.immune=!0,this.stance="preLeap",this.attackTimer.reset(1e3));else if(this.stance==="preLeap"){if(this.attackTimer.tick(e),this.attackTimer.finished()){this.stance="leap",this.attackTimer.reset(1e3);const[s,i]=t.nearestPlayer(this.pos);if(s!==null){let a=s.pos.dist(this.pos);a<=10?this.leapDestination=new c(s.pos):(this.leapDestination=this.pos.add(s.pos.subtract(this.pos).scale(10/a)),a=10),this.vel=this.leapDestination.subtract(this.pos).scale(1/1e3),this.attackTimer.reset(1e3*a/10),console.log("started leap dest",this.leapDestination,"cur",this.pos,a)}}}else if(this.stance==="leap"){this.attackTimer.tick(e);const s=this.attackTimer.elapsed/this.attackTimer.timer,i=2;this.elevation=-4*i*s*s+4*i*s,(this.vel.dist([0,0])<=1e-6||this.attackTimer.finished())&&(console.log("ended leap dest",this.leapDestination,"cur",this.pos),this.vel=new c([0,0]),this.stance="postLeap",this.attackTimer.reset(1e3),this.elevation=0)}else this.stance==="postLeap"&&(this.attackTimer.tick(e),this.attackTimer.finished()&&(this.immune=!1,this.stance="passive",this.attackTimer.reset(5e3),this.vel=new c([0,0])));this.vel.x>0?this.facing=1:this.vel.x<0&&(this.facing=-1)}}}class L extends K{constructor(t,e=null,s=1,i=!1){super(t,u.Soldier1,1),this.playerFriendly=!0,this.hp=1,this.topSpeed=.5*this.topSpeed,this.fallOrigin=null,this.stance="passive",this.hat=i}draw(t){if(this.dead||this.dying){t.sprites.base.drawRotated(u.Soldier1,this.getDisplayX(),this.getDisplayY(),90,!this.getFlipped());return}u.Soldier1.length===2&&(t.sprites.base.draw(u.Soldier1,this.getDisplayX(),this.getDisplayY(),!this.getFlipped()),this.hat&&t.sprites.base.draw(u.SoldierHat,this.getDisplayX(),this.getDisplayY()-.5,!this.getFlipped()))}update(t,e){super.update(t,e)}}class it extends K{constructor(t){super(t,u.Hessian1,1),this.hp=1,this.topSpeed=.5*this.topSpeed,this.fallOrigin=null,this.stance="passive",this.launchTimer=new T(1e4,Math.random()*5e3),this.launching=0,this.shoots=!0}draw(t){if(u.Hessian1.length===2){if(this.dead||this.dying){t.sprites.base.drawRotated(u.Hessian1,this.getDisplayX(),this.getDisplayY(),90,this.getFlipped());return}t.sprites.base.draw(u.Hessian1,this.getDisplayX(),this.getDisplayY(),this.getFlipped()),t.sprites.base.draw(u.HessianHelmet1,this.getDisplayX(),this.getDisplayY()-.5,this.getFlipped()),this.shoots&&t.sprites.base.draw(this.launchTimer.elapsed-this.launchTimer.timer>1e3?u.Rifle1:u.Rifle2,this.getDisplayX()+this.facing*.375,this.getDisplayY()+.25,!this.getFlipped())}}update(t,e){if(super.update(t,e),this.dead||this.dying)return;const s=t.activePlayers[0];if(!(this.pos.dist(s.pos)>20)&&(this.facing=s.pos[0]>this.pos[0]?1:-1,!!this.shoots&&(this.launchTimer.tick(e),this.launchTimer.finished())))if(this.launching<=0){this.launchTimer.reset(500);const[i,a]=this.pos.scale(-1).add(s.pos);let l=Math.atan2(a,i)*180/Math.PI;t.items.push(new bt(this.pos.add([1*this.facing,0]),null,l)),this.launching++}else this.launching=0,this.launchTimer.reset(2e3-0*Math.random())}}class Lt extends K{constructor(t){super(t,u.Hessian1,1),this.hp=1,this.topSpeed=.5*this.topSpeed,this.fallOrigin=null,this.stance="passive",this.destination=new c(t.pos),this.launchTimer=new T(1e4,Math.random()*5e3),this.launching=0}draw(t){if(u.Hessian1.length===2){if(this.dead||this.dying){t.sprites.base.drawRotated(u.Hessian1,this.getDisplayX(),this.getDisplayY(),90,this.getFlipped());return}t.sprites.base.draw(u.Hessian1,this.getDisplayX(),this.getDisplayY(),this.getFlipped()),t.sprites.base.draw(this.launchTimer.elapsed-this.launchTimer.timer>1e3?u.Rifle1:u.Rifle2,this.getDisplayX()+this.facing*.375,this.getDisplayY()+.25,!this.getFlipped())}}update(t,e){if(super.update(t,e),this.dead||this.dying)return;const s=t.activePlayers[0];if(this.pos.dist(s.pos)>30&&!this.dead){this.stance==="fleeing"&&(this.dead=!0);return}if(this.pos.dist(s.pos)<5&&this.stance==="passive"&&!this.dead&&(this.stance="fleeing"),this.facing=s.pos[0]>this.pos[0]?1:-1,this.launchTimer.tick(e),this.launchTimer.finished())if(this.launching<=0){this.launchTimer.reset(500);const[i,a]=this.pos.scale(-1).add(s.pos);let l=Math.atan2(a,i)*180/Math.PI;t.items.push(new bt(this.pos.add([1*this.facing,0]),null,l)),this.launching++}else this.launching=0,this.launchTimer.reset(2e3-0*Math.random())}}class It extends K{constructor(t){super(t,[0,0],1),this.hp=10,this.topSpeed=.5*this.topSpeed,this.fallOrigin=null,this.stance="passive",this.launchTimer=new T(1e3),this.launching=0,this.firingAngle=0,this.hitDamage=0,this.spawnTimer=0,this.facing=1}draw(t){t.sprites.base.drawRotatedMultitile(y.Cannon,this.getDisplayX()-1,this.getDisplayY(),0,this.getFlipped())}stun(t=2e3){}update(t,e){super.update(t,e),!this.dead&&(this.firingAngle+=e/15,this.firingAngle>=360&&(this.firingAngle=0),this.launchTimer.tick(e),this.launchTimer.finished()&&(t.items.push(new Nt(t.tiles.at(this.tile_pos()),null,this.firingAngle)),this.launchTimer.reset()))}hitFrom(t,e,s,i=0){this.hp-=s,s>0&&this.hitTimer.reset(200),this.hp<=0&&this.die(t)}}const J=0,yt=1,X=2,_=3,A=4,et=5,H=6;class G extends K{constructor(e=-1,s=null){super(s,[0,e],3);n(this,"isPlayer",!0);n(this,"boundingBox",new f([.25,.5,.5,.5]));n(this,"hitBox",new f([.25,.25,.5,.5]));n(this,"dashBox",new f([0,0,1,1]));n(this,"immunityTimer",new T(1e3,1e3));n(this,"selectedTimer",new T(500,500));n(this,"dashTimer",new T(3e3,3e3));n(this,"hitTimer",new T(500,500));n(this,"stunTimer",new T(500,500));n(this,"jumpTimer",new T(0,0));n(this,"freeze",!1);n(this,"selectedSprite",null);n(this,"hidden",!1);n(this,"escaped",!1);n(this,"running",!1);n(this,"climbing",!1);n(this,"aiming",!1);n(this,"dropFromGame",!1);n(this,"startLevel",0);n(this,"lastVel",new c([0,0]));n(this,"dodgeOrigin",new c(this.pos));n(this,"boatOffset",new c([-2.5,0]));n(this,"holding","sword");n(this,"ridingBoat",!1);n(this,"maxHp",4);n(this,"topSpeed",1/250);n(this,"jumpSpeed",1/135);n(this,"maxFallSpeed",1/50);n(this,"airJumps",0);n(this,"wallJumps",0);n(this,"spikedBoots",0);n(this,"chips",0);n(this,"dead",!1);n(this,"score",0);n(this,"deaths",0);n(this,"pause",0);n(this,"lastFacing",0);n(this,"lastFramePos",new c([0,0]));n(this,"currentFrame",0);n(this,"useTimer",new T(0));n(this,"hookHitModifier",[]);n(this,"hookUpdate",[]);n(this,"activeState",A);n(this,"stateTimer",new T);n(this,"controller",null);this.controlStates={...nt()},this.newControlStates={...nt()},this.oldControlStates={...nt()},this.sprite=[0,8],this.setAnimationFrames()}bounds(e=null){return e===null&&(e=this.pos),this.activeState===H?new f([this.pos.x-2.5,this.pos.y,3.5,1]):super.bounds(e)}dashBounds(){const e=this.vel.x>0?.5:this.vel.x<0?-.5:0,s=this.vel.y>0?.5:this.vel.y<0?-.5:0,i=[this.pos.x+e,this.pos.y+s];return this.dashBox.shift(i)}setAnimationFrames(){this.animationFrames={WALK_EW:[new c([1,0]),new c([4,0]),new c([4,0]),new c([3,0]),new c([3,0]),new c([2,0]),new c([2,0]),new c([1,0])],WALK_N:[new c([1,0]),new c([2,0]),new c([1,0]),new c([2,0])],WALK_S:[new c([1,0]),new c([2,0]),new c([1,0]),new c([2,0])],DASH_EW:[new c([1,0]),new c([2,0]),new c([2,0])],DASH_N:[new c([14,0]),new c([15,0]),new c([15,0]),new c([14,0])],DASH_S:[new c([12,0]),new c([13,0]),new c([13,0]),new c([12,0])],STAND:[new c([0,0])]}}cycleSprite(e){let s=e.other_players(this).map(i=>i.sprite[1]);for(;this.sprite[1]++,this.sprite[1]>=4&&(this.sprite[1]=0),!!s.includes(this.sprite[1]););this.setAnimationFrames()}die(e){if(this.dead)return;this.dead=!0,this.hp=0,this.deaths++;let s=C(["dead1","dead2","dead3","dead4","dead5","dead6","dead7","dead8"]);this.setState(e,et),e.playSound(s)}boardBoat(e,s){this.enterState(e,H),this.pos=s.pos.subtract(this.boatOffset).add([3,0])}enterState(e,s){switch(s){case H:case X:{const i=this.dashTimer.finished()?.01:.004;this.vel.x>0&&(this.vel.x=1),this.vel.x<0&&(this.vel.x=-1),this.vel.y>0&&(this.vel.y=1),this.vel.y<0&&(this.vel.y=-1);const a=this.vel.dist([0,0]);a>0&&(this.vel=this.vel.scale(i/a));break}}this.activeState=s}exitState(e,s){}updateState(e,s){switch(this.activeState){case A:case J:if(this.entityInteract(e),this.stunTimer.finished()){if(this.moveCheck(e,s,this.running),this.cycleInventoryCheck(e,s),this.vel.x!==0||this.vel.y!==0){if(!this.oldControlStates.dodge&&this.controlStates.dodge){this.setState(e,_),this.dodgeOrigin=new c(this.pos);return}else if(!this.oldControlStates.dash&&this.controlStates.dash){this.setState(e,X),this.dashTimer.reset();return}}this.activeState===A&&this.setState(e,J)}this.vel.x===0&&this.vel.y===0&&this.activeState===J&&this.setState(e,A),this.tileInteract(e,s);break;case yt:this.stunTimer.finished()&&(this.entityInteract(e),this.setState(e,J),this.stunTimer.finished()&&(this.moveCheck(e,s,!1),this.cycleInventoryCheck(e,s)),this.tileInteract(e,s)),!this.jumpTimer.finished()&&this.vel.y<0&&!this.controlStates.dash&&(this.vel.y*=.5**(s/15));break;case X:this.entityInteract(e);for(let i of e.monsters)i.hitBounds().collide(this.dashBounds())&&(i.hitFrom(e,this.pos,1,2),i.stun());this.stateTimer.elapsed>100&&this.setState(e,A);break;case _:this.entityInteract(e),this.stunTimer.finished()&&(this.moveCheck(e,s,!0),this.cycleInventoryCheck(e,s)),!this.oldControlStates.dash&&this.controlStates.dash&&(this.vel.x!==0||this.vel.y!==0)&&this.setState(e,X),this.tileInteract(e,s),this.stateTimer.elapsed>500&&this.setState(e,A);break;case et:this.driftCheck(e,s,!1);break;case H:this.facing=1,!this.oldControlStates.left&&this.controlStates.left&&(this.vel.x=-1/400,this.vel.y=0),!this.oldControlStates.right&&this.controlStates.right&&(this.vel.x=1/200,this.vel.y=0),!this.oldControlStates.up&&this.controlStates.up&&(this.vel.y=-1/800,this.vel.x=0),!this.oldControlStates.down&&this.controlStates.down&&(this.vel.y=1/400,this.vel.x=0),this.entityInteract(e),this.vel.y=this.vel.y*.99,this.vel.x=this.vel.x*.99;break}}revive(e){this.dead=!1,this.setState(e,J),this.hp=e.competitiveMode?this.maxHp:1}hitFrom(e,s,i,a=0){if(!this.dead&&!this.escaped&&this.activeState!==_&&this.immunityTimer.finished()){for(let l of this.hookHitModifier)[i,a]=l.hitModifier(i,a);super.hitFrom(e,s,i,a),this.immunityTimer.reset(),e.playSound("hit1")}}use(e,s){this.useTimer.reset(s)}draw(e){if(this.hidden)return;const s=this.activeState===X?this.animationFrames.DASH_EW:this.animationFrames.WALK_EW;let i=this.getFlipped();if(this.escaped)return;let a=[0,0];if(this.dead?(a=[0,a[1]],this.currentFrame=0,this.lastFramePos=new c(this.pos)):this.activeState===yt?(a=[0,a[1]],this.currentFrame=0,this.lastFramePos=new c(this.pos)):this.activeState===A?(a=u.Washington1,this.currentFrame=0,this.lastFramePos=new c(this.pos)):this.activeState===_?(a=u.WashingtonDodge,this.currentFrame=0,this.lastFramePos=new c(this.pos)):(this.facing!==this.lastFacing?(this.currentFrame=0,this.lastFramePos=new c(this.pos)):this.pos.dist(this.lastFramePos)*4>=1&&(this.currentFrame+=Math.floor(this.pos.dist(this.lastFramePos)*4),this.lastFramePos=new c(this.pos)),this.currentFrame=this.currentFrame%s.length,a=s[this.currentFrame]),this.activeState===_){if(e.ctx.globalAlpha=.75,this.vel.x===0){if(this.vel.y<0){const l=this.dodgeOrigin.y-this.pos.y;e.sprites.base.drawRotatedMultitile([20,4.5-l,1,.5+l],this.pos.x,this.pos.y+.5,0,!i)}else if(this.vel.y>0){const l=this.pos.y-this.dodgeOrigin.y;e.sprites.base.drawRotatedMultitile([21,1,1,.5+l],this.pos.x,this.dodgeOrigin.y,0,!i)}}else if(this.vel.x>0){const l=Math.min(this.pos.x-this.dodgeOrigin.x,3.5);e.sprites.base.drawRotatedMultitile([24.5-l,0,.5+l,1],this.dodgeOrigin.x,this.pos.y,this.vel.y<0?-20:this.vel.y>0?20:0,!i)}else if(this.vel.x<0){const l=Math.min(this.dodgeOrigin.x-this.pos.x,3.5);e.sprites.base.drawRotatedMultitile([24.5-l,0,.5+l,1],this.pos.x+.5,this.pos.y,this.vel.y<0?20:this.vel.y>0?-20:0,!i)}e.ctx.globalAlpha=1}if(this.activeState===H){e.sprites.base.drawRotatedMultitile(y.BoatBack,this.getDisplayX()+this.boatOffset.x,this.getDisplayY()+this.boatOffset.y,0,i);for(let l=0;l<4;l++)e.sprites.base.draw(u.Soldier1,this.getDisplayX()-2+l/2,this.getDisplayY(),!i);a=u.Washington1}if(this.activeState===et)e.sprites.base.drawRotated([a[0],a[1]],this.getDisplayX(),this.getDisplayY(),i?270:90,!i);else{if(this.activeState===_&&(e.ctx.globalAlpha=.5),e.sprites.base.draw([a[0],a[1]],this.getDisplayX(),this.getDisplayY(),!i),this.activeState===X){const l=this.currentFrame===0?this.facing*.25:this.facing*.5;e.sprites.base.draw(this.currentFrame===0?u.Sword2:u.Sword3,this.getDisplayX()+l,this.getDisplayY(),!i)}else{const l=this.facing*.5;e.sprites.base.draw(u.Sword1,this.getDisplayX()+l,this.getDisplayY(),!i)}this.activeState===_&&(e.ctx.globalAlpha=1)}this.hitTimer.finished()||u.Strike.length===2&&e.sprites.base.draw(u.Strike,this.getDisplayX(),this.getDisplayY(),!this.getFlipped()),this.activeState===H&&e.sprites.base.drawRotatedMultitile(y.BoatFront,this.getDisplayX()+this.boatOffset.x,this.getDisplayY()+this.boatOffset.y,0,i),this.lastFacing=this.facing}drawHUD(e,s){u.Health.length===2&&e.sprites.base.draw(u.Health,s.x,s.y),e.drawTileText(""+Math.ceil(this.hp),.5*e.tileSize,s.add([0,-.5]),"White")}update(e,s){if(!this.escaped){new c(this.vel),new c(this.pos),this.immunityTimer.tick(s),this.stateTimer.tick(s),this.jumpTimer.tick(s),this.hitTimer.tick(s),this.useTimer.tick(s),this.stunTimer.tick(s),this.selectedTimer.tick(s),this.dashTimer.tick(s),this.updateState(e,s);for(let i of this.hookUpdate)i.update(e,s,this);this.activeState!=et&&this.pos.y>e.tiles.dimH+3&&this.die(e),this.lastVel=new c(this.vel),this.activeState!==H?this.freeze||e.tiles.move(this,s):this.activeState===H?this.freeze||e.tiles.moveBoat(this,s):this.pos=this.pos.add(this.vel.scale(15/s)),this.activeState===H&&(this.lastVel.x!==this.vel.x||this.lastVel.y!==this.vel.y)&&(this.pos=this.pos.add([3,0]),e.tiles.closestTile(new f([this.pos[0],this.pos[1],1,1]))instanceof $&&(this.setState(e,A),e.items.push(new F(e.tiles.at(this.pos.subtract([6,0]).map(Math.ceil))))))}}driftCheck(e,s,i){const a=15625e-8;this.vel.x=this.vel.x>0?Math.max(this.vel.x-a*s/15,0):Math.min(this.vel.x+a*s/15,0),this.vel.y=this.vel.y>0?Math.max(this.vel.y-a*s/15,0):Math.min(this.vel.y+a*s/15,0)}moveCheck(e,s,i){this.controlStates.left?(this.vel.x=Math.max(-this.topSpeed*(i?2:1),this.vel.x-1/1600*s/15),this.facing=-1):!i&&this.vel.x<0&&(this.vel.x=0),this.controlStates.right?(this.vel.x=Math.min(this.topSpeed*(i?2:1),this.vel.x+1/1600*s/15),this.facing=1):!i&&this.vel.x>0&&(this.vel.x=0),this.controlStates.up?this.vel.y=Math.max(-this.topSpeed*(i?2:1),this.vel.y-1/1600*s/15):!i&&this.vel.y<0&&(this.vel.y=0),this.controlStates.down?this.vel.y=Math.min(this.topSpeed*(i?2:1),this.vel.y+1/1600*s/15):!i&&this.vel.y>0&&(this.vel.y=0)}cycleInventoryCheck(e,s){this.controlStates.cycle&&this.oldControlStates.cycle}entityInteract(e){for(let s=0;s<e.items.length;s++)this.bounds().collide(e.items[s].bounds())&&(e.items[s].entityCollide(e,this),this.aiming||(this.controlStates.up&&e.items[s].entityInteract(e,this,"up"),this.controlStates.down&&e.items[s].entityInteract(e,this,"down")))}tileInteract(e,s){if(this.controlStates.up){let i=e.tiles.closestTile(this.bounds());i instanceof P||i.entityInteract(e,this,"up")}if(this.controlStates.down){let i=e.tiles.closestTile(this.bounds());if(!(i instanceof P)){i.entityInteract(e,this,"down");let a=e.tiles.below(i.pos);!(a instanceof P)&&a.tile.y==this.bounds().bottom&&a.tile.entityInteract(e,this,"down")}}}setState(e,s){this.exitState(e,this.activeState),this.enterState(e,s),this.stateTimer.reset()}}class Yt extends k{constructor(t,e=null){e==null&&(e=C([y.Tree1,y.Tree2])),super(t,e)}entityCollide(t,e){if(e.isPlayer){const[s,i,a,l]=e.bounds(),[r,d,p,w]=this.bounds(),m=Math.min(s+a-r,r+p-s),v=Math.min(i+l-d,d+w-i);m>0&&v>0&&(m<=v?e.pos[0]+=s<r?-m:m:e.pos[1]+=i<d?-v:v),e.vel[0]=0,e.vel[1]=0}}bounds(){return new f([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){t.sprites.base.drawRotatedMultitile(this.sprite,this.pos[0]-.5,this.pos[1]-1,0,!1)}}class F extends k{constructor(t,e=null){e==null&&(e=C([y.Tree1,y.Tree2])),super(t,e),this.boardable=!1}entityCollide(t,e){this.boardable&&e instanceof G&&e.bounds().collide(this.bounds())&&!this.dead&&t.activeChapter===0&&t.chapters[t.activeChapter].activeObjective===2&&(e.vel[0]=0,e.vel[1]=0,e.boardBoat(t,this),this.dead=!0)}bounds(){return new f([this.pos[0],this.pos[1],4,1])}draw(t){t.sprites.base.drawRotatedMultitile(y.BoatBack,this.pos[0],this.pos[1],0,!1),t.sprites.base.drawRotatedMultitile(y.BoatFront,this.pos[0],this.pos[1],0,!1)}}class D extends k{constructor(t,e=null){e==null&&(e=C([u.Iceberg1,u.Iceberg2,u.Iceberg3])),super(t,e),this.vel.x=1/200,this.vel.y=1/100}entityCollide(t,e){if(e instanceof G&&e.activeState===H&&e.bounds().collide(this.bounds())){e.vel[0]=1/200,e.vel[1]=1/100;const s=new c([Math.round(e.pos.x),Math.round(e.pos.y)]);t.items.push(new D(s.add([2,1]),u.SoldierIcecube)),t.items.push(new D(s.add([1,2]),u.SoldierIcecube)),t.items.push(new D(s.add([0,1]),y.BoatVerticle1)),t.items.push(new D(s.add([-1,2]),u.SoldierIcecube)),t.items.push(new D(s.add([-2,1]),u.SoldierIcecube)),e.die(t),e.hidden=!0}}update(t,e){super.update(t,e),this.pos=this.pos.add(this.vel.scale(e/15)),(this.pos.x<-1||this.pos.y<-1||this.pos.x>t.tiles.dimW||this.pos.y>t.tiles.dimH)&&(this.dead=!0)}bounds(){return new f([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){this.sprite.length===2?t.sprites.base.draw(this.sprite,this.pos[0],this.pos[1]):t.sprites.base.drawRotatedMultitile(this.sprite,this.pos[0]-(this.sprite[2]-1)/2,this.pos[1]-this.sprite[3]+1,0,!1)}}class Xt extends k{constructor(t,e=null){e==null&&(e=u.StoneHighlighted),super(t,e)}entityCollide(t,e){}bounds(){return new f([this.pos[0]+.2,this.pos[1]+.2,.6,.2])}}class q extends k{constructor(t,e=null){e==null&&(e=C([y.HouseBlue,y.HouseRed])),super(t,e)}entityCollide(t,e){if(e.isPlayer){const[s,i,a,l]=e.bounds(),[r,d,p,w]=this.bounds(),m=Math.min(s+a-r,r+p-s),v=Math.min(i+l-d,d+w-i);m>0&&v>0&&(m<=v?e.pos[0]+=s<r?-m:m:e.pos[1]+=i<d?-v:v),e.vel[0]=0,e.vel[1]=0}}bounds(){return new f([this.pos[0],this.pos[1]+2,8,4.5])}draw(t){t.sprites.base.drawRotatedMultitile(this.sprite,this.pos[0],this.pos[1],0,!1)}}class Et{constructor(){n(this,"flakes",[]);n(this,"maxFlakes",100);n(this,"fallSpeed",1/100);n(this,"xySpeed",1/200);n(this,"xWind",0);n(this,"yWind",0);n(this,"sprite",u.SnowFlake1)}reset(){this.flakes=[]}changeMode(t){t==="clear"?(this.flakes=[],this.maxFlakes=0):t==="snow"?(this.flakes=[],this.sprite=u.SnowFlake3,this.fallSpeed=1/50,this.maxFlakes=50,this.xySpeed=1/200,this.xWind=0):t==="heavySnow"?(this.flakes=[],this.sprite=u.SnowFlake1,this.fallSpeed=1/30,this.maxFlakes=150,this.xySpeed=1/50,this.xWind=-1/20):(this.flakes=[],this.sprite=u.Sleet,this.fallSpeed=1/3,this.xySpeed=0,this.xWind=-1/30)}update(t,e){const s=new f([t.camera.x,t.camera.y,t.camera.w,t.camera.h]);for(let i of this.flakes)i[0]<s.x&&(i[0]+=s.w),i[0]>s.right&&(i[0]-=s.w),i[1]<s.y&&(i[1]+=s.h),i[1]>s.bottom&&(i[1]-=s.h),i[2]-=(.5+.5*Math.random())*15/e*this.fallSpeed,i[1]+=(Math.random()-.5)*15/e*this.xySpeed+15/e*this.yWind,i[0]+=(Math.random()-.5)*15/e*this.xySpeed+15/e*this.xWind;for(this.flakes=this.flakes.filter(i=>i[2]>=0);this.flakes.length<this.maxFlakes;)this.flakes.push([s.x+Math.random()*s.w,s.y+Math.random()*s.h,Math.random()*s.h])}draw(t,e){for(let s of this.flakes)t.sprites.base.draw(this.sprite,s[0],s[1]-s[2])}}class bt extends k{constructor(t,e=null,s){super(t,u.OrangeBullet),this.vel[0]=Math.cos(s*Math.PI/180)*1/150,this.vel[1]=Math.sin(s*Math.PI/180)*1/150,this.angle=s}entityCollide(t,e){e.isPlayer&&(e.hitFrom(t,this.pos,1,1),this.dead=!0)}update(t,e){super.update(t,e),t.tiles.move(this,e,this.vel.scale(e/15)),(this.pos.x<-1||this.pos.y<-1||this.pos.x>t.tiles.dimW||this.pos.y>t.tiles.dimH||this.vel.dist([0,0])===0)&&(this.dead=!0)}bounds(){return new f([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){this.sprite.length===2&&t.sprites.base.drawRotated(this.sprite,this.pos[0],this.pos[1],this.angle+180)}}class jt extends k{constructor(t,e=null,s=0){super(t,u.HessianLB1),this.vel[0]=Math.cos(s*Math.PI/180)*1/100,this.vel[1]=Math.sin(s*Math.PI/180)*1/100,this.angle=s}entityCollide(t,e){e.isPlayer&&(e.hitFrom(t,this.pos,1,1),this.dead=!0)}update(t,e){super.update(t,e),t.tiles.move(this,e,this.vel.scale(e/15)),(this.pos.x<-1||this.pos.y<-1||this.pos.x>t.tiles.dimW||this.pos.y>t.tiles.dimH||this.vel.dist([0,0])===0)&&(this.dead=!0)}bounds(){return new f([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){this.sprite.length===2&&t.sprites.base.draw(this.sprite,this.pos[0],this.pos[1])}}class Nt extends k{constructor(t,e=null,s){super(t,u.CannonBall);const i=Math.cos(s*Math.PI/180),a=Math.sin(s*Math.PI/180);this.vel[0]=i*1/20,this.vel[1]=a*1/20,this.pos[0]+=i,this.pos[1]+=a,this.angle=s}entityCollide(t,e){e.isPlayer&&(e.hitFrom(t,this.pos,1,1),this.dead=!0)}update(t,e){super.update(t,e),this.pos=this.pos.add(this.vel.scale(e/15)),(this.pos.x<-1||this.pos.y<-1||this.pos.x>t.tiles.dimW||this.pos.y>t.tiles.dimH)&&(this.dead=!0)}bounds(){return new f([this.pos[0]+.2,this.pos[1]+.2,.6,.6])}draw(t){this.sprite.length===2&&t.sprites.base.drawRotated(this.sprite,this.pos[0],this.pos[1],this.angle+90)}}class Gt extends k{constructor(t,e=1){super(t,u.Sausage),this.value=e}entityCollide(t,e){t.score++,e instanceof G&&(t.playSound("pickup2"),e.hp<e.maxHp&&e.hp++,this.dead=!0)}entityInteract(t,e,s){!this.dead&&e instanceof G&&(e.hp<e.maxHp&&e.hp++,t.score++,t.playSound("pickup2"),this.dead=!0)}}class Kt extends k{constructor(t,e){super(t,[1,e.sprite[1]]),this.elapsed=0,this.timer=3e3}update(t,e){this.elapsed+=e,this.elapsed>this.timer&&(this.dead=!0)}draw(t){this.sprite.length===2&&t.sprites.players.draw(this.sprite,this.getDisplayX(),this.getDisplayY(),this.getFlipped())}}class Ut extends k{constructor(t,e){super(null,null),this.sound=t,this.delay=e,this.elapsed=0}update(t,e){this.elapsed+=e,this.elapsed>this.delay&&(t.playSound(this.sound),this.dead=!0)}draw(){}}class Vt extends k{constructor(t,e=250){super(t,u.Boom),this.timer=e,this.elapsed=0}update(t,e){if(this.elapsed+=e,this.elapsed>=this.timer){this.dead=!0;let s=t.tiles.get(this.pos);s instanceof $||s.replace($)}}}class Jt extends k{constructor(t){super(null,u.TrapBlade),this.platform=t,this.triggered=!1,t.type=="static"?this.pos=new c(this.platform.shift([0,-1])):this.pos=new c(this.platform),this.facing=1,this.boundingBox=new f([.125,.25,.75,.75]),this.elapsed=0}update(t,e){let s=this.platform;if(t.tiles.at(s.pos)!=s&&(this.dead=!0),this.elapsed+=e,s.type=="contact")if(this.pos.y==s.y&&this.vel.y==0){for(let a of t.activePlayers)if(a.bounds().collide(t.tiles.at(s).shift([0,-1]))){this.vel.y=-1/s.extendTime,this.elapsed=0;break}}else this.pos.y==s.y-1&&this.elapsed>=s.extendedTime&&(this.vel.y=1/s.extendTime,this.elapsed=0);else s.type=="cycling"&&(this.pos.y==s.y-1&&this.elapsed>=s.extendedTime&&(this.vel.y=1/s.extendTime,this.elapsed=0),this.pos.y==s.y&&this.elapsed>=s.retractedTime&&(this.vel.y=-1/s.extendTime,this.elapsed=0));for(let a of t.monsters_and_players())this.bounds().collide(a.bounds())&&(a.hitFrom(t,this.pos,s.damage,1),a.isPlayer||a.stun(500));let i=this.elapsed>s.contactDelay||s.type!=="contact"?this.vel.y:0;this.pos.y=Math.min(Math.max(this.pos.y+i*e,s.y-1),s.y),(this.pos.y==s.y-1&&this.vel.y<0||this.pos.y==s.y&&this.vel.y>0)&&(this.vel.y=0)}drawAsTile(t){this.sprite.length===2&&t.sprites.entitiesItems.draw(this.sprite,this.getDisplayX(),this.getDisplayY(),this.getFlipped())}draw(t){}}function o(h,t){return[h,t]}function g(h,t,e,s){return[h,t,e,s]}class qt{constructor(t,e,s=16){this.spriteSize=s,this.sheet=new Image,this.sheet.src=e,this.game=t}draw(t,e,s,i=!1){let a=i?-1:1;i&&this.game.ctx.scale(-1,1),this.game.ctx.drawImage(this.sheet,t[0]*this.spriteSize,t[1]*this.spriteSize,this.spriteSize,this.spriteSize,a*(e*this.game.tileSize+this.game.shakeX+this.game.gameOffsetX),s*this.game.tileSize+this.game.shakeY+this.game.gameOffsetY,a*this.game.tileSize,this.game.tileSize),i&&this.game.ctx.scale(-1,1)}drawScaled(t,e,s,i,a=!1){let l=a?-1:1;a&&this.game.ctx.scale(-1,1),this.game.ctx.drawImage(this.sheet,t[0]*this.spriteSize,t[1]*this.spriteSize,this.spriteSize,this.spriteSize,l*Math.floor(e*this.game.tileSize+this.game.shakeX+this.game.gameOffsetX),Math.floor(s*this.game.tileSize+this.game.shakeY+this.game.gameOffsetY),l*this.game.tileSize*i,this.game.tileSize*i),a&&this.game.ctx.scale(-1,1)}drawRotated(t,e,s,i,a=!1,l="center"){const r=this.game;r.ctx.save(),l=="center"?l=[r.tileSize/2,r.tileSize/2]:l=[Math.floor(l[0]*r.tileSize),Math.floor(l[1]*r.tileSize)],r.ctx.translate(Math.floor(e*r.tileSize+r.shakeX+r.gameOffsetX+l[0]),Math.floor(s*r.tileSize+r.shakeY+r.gameOffsetY+l[1])),r.ctx.rotate(i*Math.PI/180),a&&r.ctx.scale(-1,1),r.ctx.translate(-l[0],-l[1]),r.ctx.drawImage(this.sheet,t[0]*this.spriteSize,t[1]*this.spriteSize,this.spriteSize,this.spriteSize,0,0,r.tileSize,r.tileSize),r.ctx.restore()}drawRotatedMultitile(t,e,s,i,a=!1,l="center"){const r=this.game;r.ctx.save();let d=t[2],p=t[3];l=="center"?l=[d*r.tileSize/2,p*r.tileSize/2]:l=[Math.floor(l[0]*r.tileSize),Math.floor(l[1]*r.tileSize)],r.ctx.translate(Math.floor(e*r.tileSize+r.shakeX+r.gameOffsetX+l[0]),Math.floor(s*r.tileSize+r.shakeY+r.gameOffsetY+l[1])),r.ctx.rotate(i*Math.PI/180),a&&r.ctx.scale(-1,1),r.ctx.translate(-l[0],-l[1]),r.ctx.drawImage(this.sheet,t[0]*this.spriteSize,t[1]*this.spriteSize,this.spriteSize*d,this.spriteSize*p,0,0,r.tileSize*d,r.tileSize*p),r.ctx.restore()}}const u=Object.freeze({Health:o(12,0),Snow1:o(0,4),Snow2:o(1,4),Snow3:o(2,4),Snow4:o(3,4),ShoreSW:o(4,4),ShoreNE:o(6,4),ShoreS:o(5,4),ShoreN:o(7,4),RoadNS:o(4,5),RoadEW:o(5,5),Water1:o(0,5),Water2:o(1,5),Water3:o(2,5),Water4:o(3,5),Iceberg1:o(0,6),Iceberg2:o(1,6),Iceberg3:o(2,6),SnowFlake1:o(3,6),SnowFlake2:o(6,6),SnowFlake3:o(7,6),Sleet:o(5,6),CannonBall:o(7,3),RedBullet:o(8,3),OrangeBullet:o(9,3),PiercingBullet:o(10,3),Cheese:o(12,1),Sausage:o(13,1),StoneHighlighted:o(42,0),Stone:o(43,0),Sword1:o(30,0),Sword2:o(31,0),Sword3:o(32,0),Pistol1:o(33,0),Pistol2:o(34,0),Pistol3:o(35,0),Pistol4:o(36,0),Pistol5:o(38,0),Pistol6:o(39,0),Pistol7:o(40,0),Pistol8:o(41,0),HessianHelmet1:o(10,1),HessianHelmet2:o(11,1),Rifle1:o(10,2),Rifle2:o(11,2),Washington1:o(0,0),Washington2:o(1,0),Washington3:o(2,0),Washington4:o(3,0),Washington5:o(4,0),Washington6:o(5,0),WashingtonDodge:o(20,0),WashingtonSunglasses:o(9,0),Soldier1:o(0,1),Soldier2:o(1,1),Soldier3:o(2,1),Soldier4:o(3,1),Soldier5:o(4,1),SoldierFall:o(5,1),SoldierIcecube:o(6,1),SoldierDead:o(7,1),SoldierHat:o(9,1),Hessian1:o(0,2),Hessian2:o(1,2),Hessian3:o(2,2),Hessian4:o(3,2),Hessian5:o(4,2),HessianDaed:o(5,2),HessianLB1:o(11,3),HessianLB2:o(12,3),HessianLB3:o(13,3),HessianLB4:o(14,3),HessianLB5:o(15,3),HessianLB6:o(16,3),HessianLBSword:o(17,3),HessianLBRifle:o(18,3),Empty:o(15,15),BeachUpper:o(4,0),BeachLower:o(5,0),Water:o(6,0),Jelly:o(11,1),Cannonball:o(13,2),Wall:o(8,0),WallEnd:o(9,0),Pillar1:o(6,1),Pillar2:o(7,1),Pillar3:o(8,1),Slash:o(10,7),Strike:o(10,7),Cutlas:o(11,7),Crab:o(6,4),Chips:o(16,0),Treasure:o(16,0),Boot1:o(16,0),Boot2:o(16,0),Boot3:o(16,0),Boom:o(16,0),Key:o(16,0),Pickup1:o(16,0),Pickup2:o(16,0),Shot1:o(15,0),Shot2:o(16,0),Shot3:o(16,0),LiveGrenade:o(16,0),Frag:o(16,0),LiveRocket:o(16,0),Drone1:o(16,0),LiveVibroBlade:o(16,0),Reticle:o(16,0),TrapBlade:o(16,0),Floor:o(16,0),Ledge:o(16,0),LockedExit:o(16,0),Exit:o(16,0),TrapBlock:o(16,0)}),y=Object.freeze({Rall1:g(1,13,1,2),RallHorsback:g(3,13,1,2),RallHorse1:g(0,10,3,3),BoatBack:g(0,9,4,1),BoatFront:g(4,9,4,1),BoatVerticle1:g(10,8,1,2),BoatVerticle2:g(12,8,1,2),Lantern1:g(3,7,1,2),Lantern2:g(4,7,1,2),Lantern3:g(5,7,1,2),Lantern4:g(6,7,1,2),Tree1:g(0,7,1,2),Tree2:g(1,7,1,2),Cannon:g(12,5,2,1),CanonNS:g(14,3,1,2),CanonEW:g(12,4,2,1),House1:g(0,16,3,3),House2:g(3,16,3,3),House3:g(6,16,3,3),BigHouseBlue:g(1,22,11,10),BigHouseRed:g(13,22,11,10),HouseBlue:g(25,22,8,7),HouseRed:g(34,22,8,7)});class I{constructor(t,e,s){this.tilemap=t,this.tile=e,this.pos=s}move(t,e){const s=new c([this.pos[0]+t,this.pos[1]+e]),i=this.tilemap.at(s);return new I(this.tilemap,i,s)}left(){return this.move(-1,0)}right(){return this.move(1,0)}above(){return this.move(0,-1)}below(){return this.move(0,1)}replace(t,...e){return this.tilemap.set(this.pos,t,...e),this.tile=t,this}getNeighbor(t,e){return this.move(t,e)}getAdjacentNeighbors(){return xt([this.getNeighbor(0,-1),this.getNeighbor(0,1),this.getNeighbor(-1,0),this.getNeighbor(1,0)])}getAdjacentPassableNeighbors(){return this.getAdjacentNeighbors().filter(t=>t.tile.passable)}getConnectedTiles(){let t=[this],e=[this];for(;e.length;){let s=e.pop().getAdjacentPassableNeighbors().filter(i=>!t.includes(i));t=t.concat(s),e=e.concat(s)}return t}}class Qt{constructor(t,e){const s=new c([0,0]);this.startTile=new P(s),this.endTile=new P(s),this.dimW=t,this.dimH=e,this.array=[];for(let i=0;i<t;i++){this.array[i]=[];for(let a=0;a<e;a++)this.array[i][a]=new O([i,a])}}isValidPos(t){return t!=null&&t[0]>=0&&t[0]<this.dimW&&t[1]>=0&&t[1]<this.dimH}at(t){return this.isValidPos(t)?this.array[t[0]][t[1]]:new P(t)}get(t){const e=new c(t),s=this.at(e);return new I(this,s,e)}set(t,e,...s){if(!this.isValidPos(t))return null;let i=new e(t,...s);return this.array[t[0]][t[1]]=i,i}fillRect(t,e){for(let s of this.iterRectPos(t))this.set(s,e)}fillLine(t,e,s){const i=new c(t),a=new c(e),l=a[0]-i[0],r=a[1]-i[1],d=Math.max(Math.abs(l),Math.abs(r));for(let p=0;p<=d;p++){const w=new c([i[0]+l*p/d,i[1]+r*p/d]).map(Math.floor);this.set(w,s)}}fillCircle(t,e,s){for(let i of this.iterRange(t,e))this.set(i.pos,s)}leftOf(t){return new I(this,this.at([t[0],t[1]]),t).left()}rightOf(t){return new I(this,this.at([t[0],t[1]]),t).right()}above(t){return new I(this,this.at([t[0],t[1]]),t).above()}below(t){return new I(this,this.at([t[0],t[1]]),t).below()}*iterAllPos(){for(let t=0;t<this.dimW;t++)for(let e=0;e<this.dimH;e++)yield new c([t,e])}*iterRectPos(t){for(let e=Math.max(t.x,0);e<Math.min(t.right,this.dimW);e++)for(let s=Math.max(t.y,0);s<Math.min(t.bottom,this.dimH);s++)yield new c([e,s])}*iterAll(){for(let t=0;t<this.dimW;t++)for(let e=0;e<this.dimH;e++)yield this.at([t,e])}*iterRect(t){for(let e=t.x;e<t.right;e++)for(let s=t.y;s<t.bottom;s++){let i=this.at([e,s]);i instanceof P||(yield i)}}*iterRectBorder(t){for(let e=t.x;e<t.right;e++){let s=this.at([e,t.y]);s instanceof P||(yield s),s=this.at([e,t.bottom-1]),s instanceof P||(yield s)}for(let e=t.y;e<t.bottom;e++){let s=this.at([t.x,e]);s instanceof P||(yield s),s=this.at([t.right-1,e]),s instanceof P||(yield s)}}*iterRange(t,e){for(let s=Math.floor(t[0]-e);s<=Math.ceil(t[0]+e);s++)for(let i=Math.floor(t[1]-e);i<=Math.ceil(t[1]+e);i++)if(Math.hypot(t[0]-s,t[1]-i)<=e){let a=this.at([s,i]);a instanceof P||(yield a)}}*colliders(t){for(let e of this.iterRange([t.center_x-.5,t.center_y-.5],1.5))e.collide(t)&&(yield e)}*contacters(t){for(let e of this.iterRange([t.center_x-.5,t.center_y-.5],1.5))e.contact(t)&&(yield e)}*iterRandom(t=null,e=null,s=null,i=1){let a=t==null?this.iterAllPos():this.iterRectPos(t);for(let l of xt(Array.from(a)))(e==null||this.at(l)instanceof e)&&(s==null||!(this.numNeighbors(l,s)<=i))&&(yield l)}hasNeighbors(t,e){for(let s of this.iterRange(t,1.5))if(this.at(s.pos)instanceof e)return!0;return!1}numNeighbors(t,e,s=1.5){let i=0;for(let a of this.iterRange(t,s))this.at(a.pos)instanceof e&&(i+=1);return i}closestTile(t){return this.at([Math.round(t.center_x-.5),Math.round(t.center_y-.5)])}closestPos(t){return new c([Math.round(t.x),Math.round(t.y)])}move(t,e=15,s=null){s===null&&(s=new c(t.vel));let i=t.pos.add([0,s.y*e]),a=t.bounds(i);for(let d of this.colliders(a))d.passable||(s.y>0&&a.bottom>d.y&&(i.y-=a.bottom-d.y,s.y=0,t.vel.y=0,a=t.bounds(i)),s.y<0&&a.y<d.bottom&&(i.y+=d.bottom-a.y,s.y=0,t.vel.y=0,a=t.bounds(i)));let l=i.add([s.x*e,0]),r=t.bounds(l);for(let d of this.colliders(r))d.passable||(s.x>0&&r.right>d.x&&(l.x-=r.right-d.x,s.x=0,t.vel.x=0,r=t.bounds(l)),s.x<0&&r.x<d.right&&(l.x+=d.right-r.x,s.x=0,t.vel.x=0,r=t.bounds(l)));t.pos=new c([l.x,i.y])}moveBoat(t,e=15,s=null){s===null&&(s=new c(t.vel));let i=t.pos.add([0,s.y*e]),a=t.bounds(i);for(let d of this.colliders(a))d instanceof z||(s.y>0&&a.bottom>d.y&&(i.y-=a.bottom-d.y,s.y=0,t.vel.y=0,a=t.bounds(i)),s.y<0&&a.y<d.bottom&&(i.y+=d.bottom-a.y,s.y=0,t.vel.y=0,a=t.bounds(i)));let l=i.add([s.x*e,0]),r=t.bounds(l);for(let d of this.colliders(r))d instanceof z||(s.x>0&&r.right>d.x&&(l.x-=r.right-d.x,s.x=0,t.vel.x=0,r=t.bounds(l)),s.x<0&&r.x<d.right&&(l.x+=d.right-r.x,s.x=0,t.vel.x=0,r=t.bounds(l)));t.pos=new c([l.x,i.y])}}class Zt extends f{constructor(){super([0,0,14,8]),this.scrollable=!0,this.focusPlayer=null}get viewPortH(){return this.h}set viewPortH(t){this.h=t}get viewPortW(){return this.w}set viewPortW(t){this.w=t}get pos(){return new c([-this.x,-this.y])}set pos(t){t!=null?(this.x=-t.x,this.y=-t.y):(this.x=null,this.y=null)}update(t,e){if(this.scrollable){let s=0,i=0,a=0;for(let d of t.activePlayers)!d.dead&&!d.escaped&&((this.focusPlayer==null||this.focusPlayer.dead||this.focusPlayer.escaped)&&(this.focusPlayer=d),d.controlStates.camera&&!d.oldControlStates.camera&&(this.focusPlayer=d),i+=d.pos.x,a+=d.pos.y,s++);this.focusPlayer===null&&(this.focusPlayer=t.activePlayers[0]),s>0&&(i/=s,a/=s),s==0&&(i=this.focusPlayer.pos.x,a=this.focusPlayer.pos.y),s>1&&(Math.abs(this.focusPlayer.pos.x-i)>this.viewPortW/2-1||Math.abs(this.focusPlayer.pos.y-a)>this.viewPortH/2-1)&&(i=this.focusPlayer.pos.x,a=this.focusPlayer.pos.y);let l=-i-.5+this.viewPortW/2,r=-a-.5+this.viewPortH/2;if(l=Math.max(Math.min(l,0),-t.dimW+this.viewPortW),r=Math.max(Math.min(r,0),-t.dimH+this.viewPortH),this.x==null||this.y==null)this.pos=new c([l,r]);else{let d=l-this.pos.x,p=r-this.pos.y,w=.2*(e/15),m=Math.max(Math.abs(d),Math.abs(p));this.pos!=null&&m>w?this.pos=new c([this.pos.x+d*w/m,this.pos.y+p*w/m]):this.pos=new c([l,r])}t.shakeX=Math.floor(-this.x*t.tileSize),t.shakeY=Math.floor(-this.y*t.tileSize)}}draw(){}}function $t(h){let t;if(h.camera.scrollable&&h.prefDimW==null&&h.prefDimH==null)switch(t=0,t){case 0:h.dimW=256,h.dimH=128;break}const e=h.dimW,s=h.dimH;h.tiles=new Qt(e,s);let i=h.tiles;i.fillRect(new f([0,0,e,s]),$);for(let p=0;p<s;p++){const w=Math.floor(p/2);i.fillLine([w+20,p],[w+120,p],z)}const a=116;i.fillLine([0,a],[50,a],x),i.fillLine([0,a+1],[50,a+1],x),i.fillLine([49,a],[49,a-10],x),i.fillLine([50,a+1],[50,a-10],x),i.fillLine([48,a-10],[28,a-30],x),i.fillLine([49,a-10],[29,a-30],x),i.fillLine([50,a-10],[30,a-30],x),i.fillLine([28,a-30],[18,a-80],x),i.fillLine([29,a-30],[19,a-80],x),i.fillLine([30,a-30],[20,a-80],x),i.fillLine([19,a-80],[19,a-95],x),i.fillLine([130,0],[194,128],x),i.fillLine([131,0],[195,128],x),i.fillLine([132,0],[196,128],x),i.fillRect(new f([185,107,63,2]),x),i.fillRect(new f([193,122,57,2]),x),i.fillRect(new f([248,107,2,24]),x),i.endTile=i.at([255,127]),i.startTile=i.at([0,116]),i.endTile=i.at([255,127]),h.cells=10,h.cellsCollected=0,h.items=[],h.items.push(new q([15.5,a-100])),h.items.push(new F([28,20]));const l=new F([38,40]);l.boardable=!0,h.items.push(l),h.items.push(new F([48,60])),h.items.push(new F([58,80])),h.items.push(new F([68,100])),h.items.push(new F([78,120])),h.items.push(new F([152,60])),h.items.push(new F([162,80])),h.items.push(new F([172,100])),h.items.push(new F([182,120])),i.fillRect(new f([185,107,63,2]),x),i.fillRect(new f([193,122,57,2]),x),i.fillRect(new f([248,107,2,24]),x);for(let p=0;p<100;p+=24){let w=140+Math.floor(p/2);h.items.push(new q([w,p]))}for(let p=10;p<110;p+=24){let w=133+Math.floor(p/2)+Z(5);i.set([w,p],N)}let r=0;for(let p=0;p<100;p++){r=Math.min(Math.max(Math.random()>.5?-1:1,0),5);let w=150+Math.floor(p/2)+r;i.fillLine([w,p],[256,p],At)}let d=0;h.tiles.fillRect(new f([198,102,52,5]),lt),h.tiles.fillRect(new f([198,124,52,7]),lt),h.tiles.fillRect(new f([250,107,5,24]),lt);for(let p=198;p<250;p+=8)h.items.push(new q([p,100]));for(let p=198;p<250;p+=8)h.items.push(new q([p,124]));for(let p=105;p<128;p+=6)h.items.push(new q([250,p]));d=0,d=0;for(let p of h.tiles.iterRandom(null,z,null,20))if(h.items.push(new D(h.tiles.at(p))),d++,d>100)break;d=0;for(let p of h.tiles.iterRandom(null,$,null,200))if(h.items.push(new Yt(h.tiles.at(p))),d++,d>100)break;h.monsters=[];for(let p=0;p<8;p+=2)for(let w=0;w<12;w+=2)h.monsters.push(new L([9+p,a+w-80]));for(let p=0;p<10;p+=2)for(let w=0;w<12;w+=2)h.monsters.push(new L([22+p,a+w-80]));h.monsters.push(new L([l.pos.x-2,l.pos.y-2],null,2,!0)),h.monsters.push(new L([l.pos.x-4,l.pos.y-2],null,2,!0)),h.monsters.push(new L([l.pos.x-2,l.pos.y+2],null,2,!0)),h.monsters.push(new L([l.pos.x-4,l.pos.y+2],null,2,!0));for(let p of h.tiles.iterAll())p.initItems(h)}function te(h,t=null,e=!1,s=!0){let i;return Ht("get random passable tile",function(){let a=rt(0,h.dimW-1),l=rt(0,h.dimH-1);return i=h.at([a,l]),t!=null?i.passable&&i.pos.dist(t)>3:!0}),i}function ee(h,t,e=!1,s=null){s===null&&(s=[it]);let i=C(s),a=new i(te(h.tiles,t,e));h.monsters.push(a)}class dt{constructor(t,e,s){this.options=t,this.dim=new f(e),this.activeOption=0,this.callback=s,this.color="rgba(100, 100, 218, 1)"}draw(t){let e=Math.ceil(this.dim.h/this.options.length),s=Math.ceil(this.dim.h/this.options.length/2),i=this.dim.y,a=this.dim.x+this.dim.w/2,l=0;for(let r of this.options){let d=l==this.activeOption?">"+r+"<":r;this.drawMenuText(t,d,s,!0,a,i,this.color),l+=1,i+=e}}drawMenuText(t,e,s,i,a,l,r){t.ctx.fillStyle=r,t.ctx.font=s+"px IM Fell English SC",i&&(a=a-t.ctx.measureText(e).width/2),t.ctx.fillText(e,a,l)}update(t,e){b.up&&!R.up&&(this.activeOption=this.activeOption>0?this.activeOption-1:this.options.length-1,this.callback(this,"change")),b.down&&!R.down&&(this.activeOption=this.activeOption<this.options.length-1?this.activeOption+1:0,this.callback(this,"change")),(b.use&&!R.use||b.dash&&!R.dash)&&this.callback(this,"select")}}class se extends dt{constructor(t){let e=new f([0,t.canvas.height/2,t.canvas.width,4*t.tileSize]);super(["Play Game","High Scores","Options"],e,(s,i)=>this.handler(t,s,i))}updateWindowSize(t){this.dim=new f([0,t.canvas.height/2,t.canvas.width,4*t.tileSize])}handler(t,e,s){if(s==="select")switch(e.activeOption){case 0:b.left?(t.prefDimW=80,t.prefDimH=40,t.startLevelTime=0):b.right?(t.prefDimW=22,t.prefDimH=13,t.startLevelTime=0):(t.prefDimW=null,t.prefDimH=null,t.startLevelTime=0),t.competitiveMode=!1,t.updateWindowSize(),t.startGame();break;case 1:t.gameState="scores";break;case 2:t.gameState="options";break}}}class ie extends dt{constructor(t){let e=new f([0,t.canvas.height/2,t.canvas.width,0]);super([],e,(s,i)=>this.handler(t,s,i))}updateWindowSize(t){this.dim=new f([0,t.canvas.height/2,t.canvas.width,this.options.length*t.tileSize])}update(t,e){this.options=["Pixel perfect scaling: "+(t.fillScreen?"OFF":"ON"),"Show framerate: "+(t.showFPS?"ON":"OFF"),"Back"],this.dim=new f([0,t.canvas.height/2,t.canvas.width,this.options.length*t.tileSize]),super.update(t,e)}handler(t,e,s){if(s=="select")switch(e.activeOption){case 0:t.fillScreen=!t.fillScreen,t.updateWindowSize();break;case 1:t.showFPS=!t.showFPS;break;case 2:t.gameState="title";break}}}class ae extends dt{constructor(t){let e=new f([0,t.canvas.height/2,t.canvas.width,3*t.tileSize]);super(["Continue","Drop Player","Exit to Main Menu"],e,(s,i)=>this.handler(t,s,i))}updateWindowSize(t){this.dim=new f([0,t.canvas.height/2,t.canvas.width,this.options.length*t.tileSize])}handler(t,e,s){if(s=="select")switch(e.activeOption){case 0:t.gameState="running";break;case 1:for(let i of t.activePlayers)i.controlStates.dash&&!i.oldControlStates.dash&&(i.dead=!0,i.dropFromGame=!0,t.gameState="running");break;case 2:t.gameState="title",t.playTitleMusic();break}}}function Mt(){return localStorage["1776/high_scores"]?JSON.parse(localStorage["1776/high_scores"]):[]}function he(h,t,e){var a;let s=Mt(),i={score:t,chapter:((a=h.chapters[h.activeChapter])==null?void 0:a.title)??"Pennsylvania",won:e};s.push(i),h.sandboxMode||(localStorage["1776/high_scores"]=JSON.stringify(s))}function ne(h){let t=Mt();if(t.length){h.drawText(pt(["CHAPTER","SCORE","END"]),18,!0,h.canvas.height/2,"white");let e=t.pop();t.sort(function(s,i){return i.score-s.score}),t.unshift(e);for(let s=0;s<Math.min(10,t.length);s++){let i=pt([t[s].chapter??"Pennsylvania",t[s].score,t[s].won?"SURVIVED":"DIED"]);h.drawText(i,18,!0,h.canvas.height/2+24+s*24,s==0?"DarkOrange":"DarkSeaGreen")}}}const le="/1776-washdel/assets/spritesheet-D-cvJQic.png",re="/1776-washdel/assets/the_marines_hymn_slow_version-wL2A_HOJ.mp3",oe="/1776-washdel/assets/four-flams-CE5QOPlm.mp3",de="/1776-washdel/assets/holst-march-DHIMIGoC.mp3",ce="/1776-washdel/assets/star-spangled-banner-Bht74Z9J.mp3",pe="/1776-washdel/assets/to-the-colors-DfVqikZB.mp3",ue="/1776-washdel/assets/hit1-B8fjDMVY.wav",fe="/1776-washdel/assets/hit2-BUt-r6lq.wav",we="/1776-washdel/assets/sfx_sounds_powerup5-9kcmwmYb.wav",ye="/1776-washdel/assets/sfx_sounds_powerup15-BCTjFyTw.wav",st="/1776-washdel/assets/Slide_Sharp_01-Chnp6Y48.wav",me="/1776-washdel/assets/explodemini-D3OoVwHb.wav",Se="/1776-washdel/assets/explode-BNxvceyl.wav",ge="/1776-washdel/assets/aargh0-BapSXfr1.ogg",xe="/1776-washdel/assets/aargh1-CpJFM2VX.ogg",ve="/1776-washdel/assets/aargh2-DSamuWiH.ogg",be="/1776-washdel/assets/aargh3-ByRNAUSJ.ogg",Me="/1776-washdel/assets/aargh4-ClzDA7Un.ogg",Te="/1776-washdel/assets/aargh5-C63Uz6i_.ogg",ke="/1776-washdel/assets/aargh6-CYmQwO-t.ogg",Pe="/1776-washdel/assets/aargh7-9yHQMFdu.ogg",mt="/1776-washdel/assets/rock_metal_slide_1-C2c5Tw6I.wav",He="/1776-washdel/assets/Click_Standard_02-B2nmSCJT.wav",De="/1776-washdel/assets/flaunch-BKRvBjGH.wav",Ce="/1776-washdel/assets/sfx_wpn_laser7-B5OWkHW5.wav",Fe="/1776-washdel/assets/sfx_wpn_laser6-Drhqhz-r.wav",Be="/1776-washdel/assets/sfx_wpn_laser5-v584Gpjn.wav",St="/1776-washdel/assets/sfx_wpn_reload-DQ6QsLU9.wav",Re="/1776-washdel/assets/Rifleprimary2-CKvPeCK4.ogg",ze="/1776-washdel/assets/minigun3-D9jlbypc.ogg",We="/1776-washdel/assets/Rack-BKgWHnMr.mp3",Oe="/1776-washdel/assets/sfx_wpn_missilelaunch-DaPY7xwi.wav",Ae="/1776-washdel/assets/jumppad-BqbMzNcn.ogg",gt="/1776-washdel/assets/rattle1-D8oszgzt.wav",_e="/1776-washdel/assets/SpaceShip_Engine_Large_Loop_00-wpyxUmoF.wav";function Le(){return{main:le}}function Ie(){return Object.freeze({hit1:new Audio(ue),hit2:new Audio(fe),pickup1:new Audio(we),pickup2:new Audio(ye),changeInv:new Audio(st),boom:new Audio(me),boomBig:new Audio(Se),dead1:new Audio(ge),dead2:new Audio(xe),dead3:new Audio(ve),dead4:new Audio(be),dead5:new Audio(Me),dead6:new Audio(Te),dead7:new Audio(ke),dead8:new Audio(Pe),exitLevel:new Audio(mt),gameOver:new Audio(mt),kioskInteract:new Audio(He),kioskDispense:new Audio(De),gunFire1:new Audio(Ce),gunFire2:new Audio(Fe),gunFire3:new Audio(Be),gunReload:new Audio(St),rifleFire:new Audio(Re),rifleReload:new Audio(St),shotgunFire:new Audio(ze),shotgunReload:new Audio(We),rocketFire:new Audio(Oe),rocketReload:new Audio(st),grappleFire:new Audio(Ae),grappleReload:new Audio(st),grappleRetract:new Audio(gt),wrenchFire:new Audio(gt),wrenchReload:new Audio(st),saberCharge:new Audio(_e),marinesHymn:new Audio(re),fourFlams:new Audio(oe),holstMarch:new Audio(de),starSpangled:new Audio(ce),toTheColors:new Audio(pe)})}class tt{constructor(){n(this,"intro",[]);n(this,"startPos",[0,0]);n(this,"startState",A);n(this,"activeIntroLine",0);n(this,"objectives",[]);n(this,"activeObjective",0);n(this,"startTime",0);n(this,"title","")}start(t,e=!0){this.startTime=t.levelTime,e&&t.music!=null&&(t.music.pause(),t.music.currentTime=0)}update(t,e){t.levelTime>=this.startTime+1e4*(this.activeIntroLine+1)&&this.activeIntroLine++}draw(t,e){this.drawTextBox2(t,this.title,!0,"top",t.tileSize*3/8),t.gameState==="dead"&&t.activeChapter>=4&&t.activePlayers[0].hp>0&&this.drawTextBox2(t,"VICTORY!",!0,"middle",2*t.tileSize),t.activePlayers[0].dead?t.activePlayers[0].hidden?this.drawTextBox(t,`
Washington drowned crossing the Delaware (press ESC to exit).`):this.drawTextBox(t,`
Washington has died in battle (press ESC to exit).`):this.activeIntroLine<this.intro.length&&this.activeObjective===0?this.drawTextBox(t,this.intro[this.activeIntroLine]):(t.levelTime>=this.startTime+1e4*this.intro.length||this.activeObjective>0)&&this.objectives.length>this.activeObjective&&this.drawTextBox(t,this.objectives[this.activeObjective])}drawTextBox(t,e){t.ctx.fillStyle="rgba(75,75,75,0.5)";const s=1*t.tileSize,i=(t.camera.viewPortW-2)*t.tileSize,a=ut(t.ctx,e,i,t.tileSize/2),l=a.length*1.1*t.tileSize/2,r=(t.camera.viewPortH-.5)*t.tileSize-l;t.ctx.fillRect(s,r,i,l),ft(t.ctx,a,s,r,"darkOrange",t.tileSize/2)}drawTextBox2(t,e,s=!1,i="bottom",a=null){const l=t.tileSize;a===null&&(a=l/2);const r=t.ctx,d=l/4,p=a/4,w=(t.camera.viewPortW-2)*l,m=`${a}px IM Fell English SC`,v=ut(r,e,w,a,m),Y=1.1;r.font=m;const at=Math.max(...v.map(Tt=>r.measureText(Tt).width)),U=r.measureText(v[0]),S=U.actualBoundingBoxAscent+U.actualBoundingBoxDescent,W=s?at+2*d:w,ht=S+(v.length-1)*a*Y+2*p,ct=s?(t.canvas.width-W)/2:1*l;let V;switch(i){case"top":V=0;break;case"middle":V=(t.camera.viewPortH*l-ht)/2;break;case"bottom":default:V=(t.camera.viewPortH-.5)*l-ht;break}r.fillStyle="rgba(75,75,75,0.5)",r.fillRect(ct,V,W,ht),ft(r,v,ct+d,V+p,"darkOrange",a,m,Y)}}class Ye extends tt{constructor(){super(...arguments);n(this,"stone",null);n(this,"startPos",[0,116]);n(this,"title","McConkey Ferry, Pennsylvania");n(this,"intro",["The year is 1776, the U.S. army has faced defeat after defeat. Having recently lost New York, the colonial army holds a lower morale than ever, and is on the verge of collapse.","General Washington knows the soldiers need a decisive victory to raise their spirits, and has planned a surprise attack on the Hessian occupied Trenton. However, first he must cross the Delaware River, which has begun to freeze due to poor weather conditions."]);n(this,"objectives",[`Head north and rouse your troops.
Controls: ARROWS or W/A/S/D to move, SPACE/J to swing sword, Z/K to dodge.`,'“Tyranny, like hell, is not easily conquered; yet we have this consolation with us, that the harder the conflict, the more glorious the triumph..."',`Find your captains and board your boat.
Controls: ARROWS or W/A/S/D to move, SPACE/J to swing sword, Z/K to dodge.`]);n(this,"speechTimer",5e3)}start(e){super.start(e),e.weather.changeMode("snow"),e.backLight="rgba(156, 156, 192, 1)",e.spotLight1="rgba(122, 122, 156, 1)",e.spotLight2="rgba(192, 192, 192, 1)",this.stone=new Xt([17,32]),e.items.push(this.stone),e.music=e.sounds.fourFlams,e.music.loop=!0,e.music.play()}update(e,s){super.update(e,s);const i=e.activePlayers[0];this.activeObjective===0&&i.bounds().collide(this.stone.bounds())&&(i.pos=this.stone.pos.add([0,-.5]),i.freeze=!0,this.activeObjective++),this.activeObjective===1&&this.speechTimer>0?(this.speechTimer-=s,this.speechTimer<=0&&(i.freeze=!1,this.activeObjective++)):this.activeObjective===2&&e.activePlayers[0].activeState===H&&(e.monsters=e.monsters.filter(r=>!(r instanceof L&&r.hat)),e.nextChapter());let a=100-e.items.reduce((r,d)=>d instanceof D?r+1:r,0);const l=e.tiles.iterRandom(null,z);for(;a>0;){const r=l.next();r.value&&r.value.dist(i.pos)>=20&&e.items.push(new D(r.value,C([u.Iceberg1,u.SoldierIcecube,u.SoldierIcecube,y.BoatVerticle1]))),a--}}draw(e,s){super.draw(e,s)}}class Xe extends tt{constructor(){super(...arguments);n(this,"title","Delaware River");n(this,"startState",H);n(this,"startPos",[43,40]);n(this,"intro",["The snow was unyielding, but Washington was determined to take Trenton so the plan continued. The ice and poor visibility made the crossing a tremendous task.","FACT CHECK: Although some boats did flip in the water, in reality no one died."]);n(this,"objectives",["Get to the other side!"])}start(e){super.start(e),e.weather.changeMode("heavySnow"),e.backLight="rgba(108, 108, 128, 1)",e.spotLight1="rgba(122, 122, 156, 1)",e.spotLight2="rgba(192, 192, 192, 1)",e.music=e.sounds.marinesHymn,e.music.loop=!0,e.music.play()}update(e,s){super.update(e,s);const i=e.activePlayers[0];i.activeState!==H&&!i.dead&&e.nextChapter(),e.items=e.items.filter(d=>!(d instanceof D&&d.pos.y>i.pos.y+40));let a=150-e.items.reduce((d,p)=>p instanceof D?d+1:d,0);const l=e.tiles.iterRandom(new f([Math.round(i.pos.x-20),Math.round(i.pos.y-e.camera.viewPortH/2)-10,100,10]),z),r=[u.Iceberg1,u.Iceberg2,u.Iceberg1,u.Iceberg2,u.Iceberg1,u.Iceberg2,u.Iceberg1,u.Iceberg2,u.Iceberg1,u.Iceberg2,u.SoldierIcecube,u.SoldierIcecube,y.BoatVerticle1];for(;a>0;){const d=l.next();d.value&&e.items.push(new D(d.value,C(r))),a--}}draw(e,s){super.draw(e,s)}}class Ee extends tt{constructor(){super(...arguments);n(this,"title","The Frozen March to Trenton");n(this,"startPos",[143,44]);n(this,"intro",["Having crossed the river, Washington began a march South towards Trenton. The march started later than anticipated at around 3AM instead of the planned midnight.",'“Look out for spies, men! No shooting!"']);n(this,"objectives",["Follow the river south until you get to Trenton. Stop any spies from reporting to Colonel Rall."])}start(e){super.start(e),e.weather.changeMode("sleet"),e.backLight="rgba(108, 108, 128, 1)";for(let s=9;s<100;s+=24){let i=140+Math.floor(s/2)+5;e.monsters.push(new Lt(e.tiles.at([i+Z(5),s+Z(5)])))}e.music=e.sounds.holstMarch,e.music.loop=!0,e.music.play(),e.backLight="rgba(156, 156, 192, 1)",e.spotLight1="rgba(122, 122, 156, 1)",e.spotLight2="rgba(192, 192, 192, 1)"}update(e,s){super.update(e,s);const i=e.activePlayers[0];i.pos.x>=195&&i.pos.y>=100&&e.nextChapter()}draw(e,s){super.draw(e,s)}}class je extends tt{constructor(){super(...arguments);n(this,"title","Trenton");n(this,"startPos",[198,108]);n(this,"intro",["By the time Washington’s army reached Trenton the sun had started to rise, it was around 8AM. The battle of Trenton had begun.","The Hessians had a total of 6 cannons during the battle, take that down to 5.","FACT CHECK: In reality the Americans actually had more cannons than the Hessians but for gameplay purposes, it’s more entertaining to be less powerful."]);n(this,"cannon",null);n(this,"cannonier",null);n(this,"objectives",["Destroy the cannon!"])}start(e){super.start(e),e.weather.changeMode("clear"),e.backLight="rgba(255,225,225,1)",e.spotLight1="rgba(192, 192, 192, 1)",e.spotLight2="rgba(230, 220, 210, 1)",e.music=e.sounds.toTheColors,e.music.loop=!0,e.music.play();for(let i=185;i<215;i+=5)e.monsters.push(new it(e.tiles.at([i,107]))),e.monsters.push(new it(e.tiles.at([i+3,122])));const s=Math.floor(229/2);this.cannon=new It([212,s]),e.monsters.push(this.cannon),this.cannonier=new it([213,s]),this.cannonier.shoots=!1,e.monsters.push(this.cannonier)}update(e,s){super.update(e,s),this.cannonier.dead&&this.cannon.hp>1&&(this.cannon.hp=1),this.cannon.dead&&e.nextChapter()}draw(e,s){super.draw(e,s)}}class Ne extends tt{constructor(){super(...arguments);n(this,"title","Colonel Johann Rall");n(this,"startPos",[220,108]);n(this,"intro",["Great work, now take the final Hessian position held by Colonel Rall.","FACT CHECK: There wasn’t actually an epic battle between Washington and Rall, however, Rall was injured and later died after the conflict"]);n(this,"boss",null);n(this,"launchTimer",0);n(this,"leftBarrier",180);n(this,"rightBarrier",247);n(this,"objectives",["Defeat Rall","Press ESC to exit"])}start(e){super.start(e,!1),e.weather.changeMode("clear"),e.backLight="rgba(255,255,255,1)",e.spotLight1="rgba(218, 218, 218, 1)",e.spotLight2="rgba(230, 230, 220, 1)";const s=e.activePlayers[0],i=Math.floor(s.pos.x-2);this.leftBarrier=i;for(let a=0;a<10;a+=2)e.tiles.fillLine([i-a,107],[i-a,123],wt);e.tiles.fillLine([248,107],[248,123],wt),this.boss=new _t(e.tiles.at([240,Math.floor(229/2)])),e.monsters.push(this.boss)}update(e,s){if(super.update(e,s),this.launchTimer-=s,this.launchTimer<0){let i=Math.random()>.5?this.leftBarrier+1:this.rightBarrier-1;for(let a=107;a<=123;a++)e.items.push(new jt(e.tiles.at([i,a]),null,i>this.leftBarrier+1?180:0));this.launchTimer=8e3}this.activeObjective===0&&this.boss.dead&&(e.gameState="dead",e.activePlayers[0].escaped=!0,this.activeObjective++)}draw(e,s){super.draw(e,s)}}class Ge{constructor(){n(this,"timer_tick",null);n(this,"FPSframes",0);n(this,"FPStime",0);n(this,"FPS",0);n(this,"updateTimes",new B([]));n(this,"drawTimes",new B([]));n(this,"updateMean",0);n(this,"updateMax",0);n(this,"drawMean",0);n(this,"drawMax",0);n(this,"weather",new Et);n(this,"activeChapter",-1);n(this,"chapters",[]);n(this,"music",null);n(this,"fillScreen",!1);n(this,"prefDimW",44);n(this,"prefDimH",26);n(this,"dimW",this.prefDimW);n(this,"dimH",this.prefDimH);n(this,"uiWidth",0);n(this,"uiHeight",2);n(this,"gameOffsetX",0);n(this,"gameOffsetY",0);n(this,"startLevelTime",0);n(this,"maxHp",3);n(this,"backLight","rgba(108, 108, 128 , 1)");n(this,"spotLight1","rgba(122, 122, 156, 1)");n(this,"spotLight2","rgba(192, 192, 192, 1)");n(this,"activePlayers",[]);n(this,"tiles",null);n(this,"monsters",null);n(this,"items",null);n(this,"multiplayerEnabled",!0);n(this,"competitiveMode",!1);n(this,"sandboxMode",!1);n(this,"gameState","loading");n(this,"showFPS",!1);n(this,"cullOffCamera",!0);n(this,"cells",0);n(this,"cellsCollected",0);n(this,"startingHp",3);n(this,"shakeAmount",0);n(this,"shakeX",0);n(this,"shakeY",0);n(this,"numReady",0);this.initSounds(),this.keyboard=new Bt(this),this.touch=new Wt(this),this.gamepadMgr=new zt(this),this.camera=new Zt,this.tileSize=this.getTileScale()*16;const t=Le();this.sprites={base:new qt(this,t.main,16)}}start(){window.onresize=()=>t.updateWindowSize(),this.setupCanvas();let t=this;this.sprites.base.sheet.onload=()=>t.ready(),this.mainMenu=new se(this),this.optionsMenu=new ie(this),this.inGameMenu=new ae(this)}ready(){this.numReady++,this.numReady>=1&&(this.gameState="title",this.playTitleMusic(),this.update())}update(){var s;let t=performance.now();this.gamepadMgr.update_gamepad_states();for(let i of Object.keys(b))R[i],b[i];for(let i of this.activePlayers)for(let a of Object.keys(i.controlStates))i.newControlStates[a]=i.oldControlStates[a]!==i.controlStates[a];if(this.gameState=="dead"&&!R.menu&&b.menu)this.gameState="scores";else if(this.gameState=="running"||this.gameState=="dead"){this.gameState=="running"&&b.menu&&!R.menu&&(this.music!==null&&this.music.pause(),this.gameState="paused"),this.gameState=="running"&&b.dash&&!R.dash&&E.player==null&&this.addPlayer();let i=15,a=Date.now();this.timer_tick!=null&&(i=Math.min(a-this.timer_tick,30)),this.timer_tick=a;for(let r of this.activePlayers)r.update(M,i);this.levelTime+=i,Ot(i),this.weather.update(this,i);for(let r of this.items)r.update(this,i);this.remove_dead(this.items);for(let r of this.monsters)r.update(this,i);this.remove_dead(this.monsters),this.remove_dropped(this.activePlayers);let l=!0;for(let r of this.activePlayers)if(!r.dead){l=!1;break}!this.competitiveMode&&l&&this.gameState!="dead"&&(this.keyboard.player=null,this.touch.player=null,this.gamepadMgr.release_all_players(),he(M,this.activePlayers[0].score,!1),this.gameState="dead",this.items.push(new Ut("gameOver",1e3)));for(let r of this.activePlayers)if(!r.dead&&!r.escaped)break;this.spawnCounter-=i,this.spawnCounter<=0&&this.activePlayers.length>0&&(this.spawnCounter=this.spawnRate,this.monsters.length<20&&ee(this,this.activePlayers[0].pos,!0)),this.updateTimes.push(performance.now()-t),(s=this.chapters[this.activeChapter])==null||s.update(this,i),this.draw(i)}else this.gameState==="title"||this.gameState==="options"?this.showTitle():this.gameState==="scores"?(this.showTitle(),!R.dash&&b.dash&&(this.gameState="title",this.playTitleMusic())):this.gameState==="paused"&&(this.showTitle(),this.gameState==="paused"&&!R.menu&&b.menu&&(this.gameState="running",this.music!==null&&this.music.play()));Ct(b);for(let i of this.activePlayers)i.oldControlStates={...i.controlStates};let e=this;window.requestAnimationFrame(()=>e.update())}draw(t){var s;let e=performance.now();if(this.gameState==="running"||this.gameState==="dead"){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.screenshake(),this.camera.update(M,t);let i=0,a=0,l=this.tiles.dimW,r=this.tiles.dimH;this.cullOffCamera&&(i=Math.floor(this.camera.x),a=Math.floor(this.camera.y),l=Math.ceil(this.camera.right),r=Math.ceil(this.camera.bottom));for(let S=i;S<l;S++)for(let W=a;W<r;W++)this.tiles.at([S,W]).draw(M);let d=this.camera;this.ctx.globalCompositeOperation="multiply";const p=this.activePlayers[0];this.ctx.fillStyle=this.backLight,this.ctx.fillRect(-d.pos.x*this.tileSize+this.shakeX+this.gameOffsetX,-d.pos.y*this.tileSize+this.shakeY+this.gameOffsetY,d.viewPortW*this.tileSize+1,d.viewPortH*this.tileSize+1),this.ctx.globalCompositeOperation="source-over";const w=[...this.monsters,...this.activePlayers,...this.items];if(w.sort((S,W)=>S.bounds().bottom-W.bounds().bottom),this.cullOffCamera)for(let S of w)S.sprite&&(S.sprite.length===2?d.shrinkBorders(-2).collide(new f([S.pos.x,S.pos.y,1,1]))&&S.draw(this):d.shrinkBorders(-2).collide(new f([S.pos.x,S.pos.y,S.sprite[2],S.sprite[3]]))&&S.draw(this));else for(let S=0;S<this.items.length;S++)this.items[S].draw(this);this.weather.draw(M,t),this.ctx.globalCompositeOperation="multiply";let m=this.ctx.createRadialGradient((p.pos[0]+.5)*this.tileSize+this.shakeX+this.gameOffsetX,(p.pos[1]+.5)*this.tileSize+this.shakeY+this.gameOffsetY,d.viewPortW/4*this.tileSize,(p.pos[0]+.5)*this.tileSize+this.shakeX+this.gameOffsetX,(p.pos[1]+.5)*this.tileSize+this.shakeY+this.gameOffsetY,this.tileSize*2);m.addColorStop(0,M.spotLight1),m.addColorStop(1,M.spotLight2),this.ctx.fillStyle=m,this.ctx.fillRect(-d.pos.x*this.tileSize+this.shakeX+this.gameOffsetX,-d.pos.y*this.tileSize+this.shakeY+this.gameOffsetY,d.viewPortW*this.tileSize+1,d.viewPortH*this.tileSize+1),this.ctx.globalCompositeOperation="source-over",this.shakeX=0,this.shakeY=0;const v=this.camera.scrollable?this.camera.viewPortW:this.dimW,Y=this.camera.scrollable?this.camera.viewPortH:this.dimH;let at=[new c([0,0]),new c([v-6,0]),new c([0,Y-1]),new c([v-6,Y-1])],U=0;for(let S of this.activePlayers){let W=at[U];S.drawHUD(M,W),U++}if((s=this.chapters[this.activeChapter])==null||s.draw(this,t),this.drawTimes.push(performance.now()-e),this.showFPS){this.FPSframes+=1,this.FPStime+=t,this.FPStime>1e3&&(this.FPS=Math.round(10*1e3*this.FPSframes/this.FPStime)/10,this.FPStime=0,this.FPSframes=0,this.updateMean=Math.round(this.updateTimes.mean()*100)/100,this.updateMax=Math.round(this.updateTimes.max()*100)/100,this.updateTimes=new B([]),this.drawMean=Math.round(this.drawTimes.mean()*100)/100,this.drawMax=Math.round(this.drawTimes.max()*100)/100,this.drawTimes=new B([]));let S=this.cullOffCamera?"CULL":"";this.drawText("FPS: "+this.FPS+"  Update: "+this.updateMean+"ms (peak "+this.updateMax+")  Draw: "+this.drawMean+"ms (peak "+this.drawMax+") "+S,this.tileSize*3/8,!0,this.tileSize*(Y-.25)+this.gameOffsetY,"DarkSeaGreen")}}}setupCanvas(){this.canvas=document.querySelector("canvas"),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.canvas.style.width=this.canvas.width+"px",this.canvas.style.height=this.canvas.height+"px",this.ctx=this.canvas.getContext("2d"),this.ctx.imageSmoothingEnabled=!1,this.camera.scrollable?(this.gameOffsetX=Math.floor((window.innerWidth-this.tileSize*this.camera.viewPortW)/2),this.gameOffsetY=Math.floor((window.innerHeight-this.tileSize*this.camera.viewPortH)/2)):(this.gameOffsetX=Math.floor((window.innerWidth-this.tileSize*this.dimW)/2),this.gameOffsetY=Math.floor((window.innerHeight-this.tileSize*this.dimH)/2))}getTileScale(){let t=window.innerHeight,e=window.innerWidth,s;return this.camera.scrollable?s=Math.min(t/(this.camera.viewPortH+this.uiHeight)/16,e/(this.camera.viewPortW+this.uiWidth)/16):s=Math.min(t/(this.prefDimH+this.uiHeight)/16,e/(this.prefDimW+this.uiWidth)/16),this.fillScreen||(s=Math.floor(s)),s}fitMaptoTileSize(t){let e=window.innerHeight,s=window.innerWidth;this.camera.scrollable?(this.camera.viewPortH=e/t,this.camera.viewPortW=s/t):(this.dimH=Math.floor(e/t),this.dimW=Math.floor(s/t),this.camera.viewPortH=this.dimH,this.camera.viewPortW=this.dimW)}updateWindowSize(){this.competitiveMode?this.camera.scrollable=!1:(this.camera.scrollable=!0,this.camera.viewPortW=14,this.camera.viewPortH=8),this.tileSize=this.getTileScale()*16,this.fitMaptoTileSize(this.tileSize),this.setupCanvas(),this.mainMenu.updateWindowSize(this),this.optionsMenu.updateWindowSize(this)}initSounds(){this.sounds=Ie()}playSound(t,e=0,s=!1,i=!0){return this.sounds[t].currentTime=e,this.sounds[t].loop=s,i&&this.sounds[t].play(),this.sounds[t]}showTitle(){this.ctx.fillStyle="rgba(0,0,0,.75)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),M.drawText("1776: Washington's Crossing",1.25*this.tileSize,!0,this.canvas.height/2-3.5*this.tileSize,"DarkRed"),M.drawText("by Evan Moore",this.tileSize,!0,this.canvas.height/2-2*this.tileSize,"White"),this.gameState==="title"?(this.mainMenu.update(this,0),this.mainMenu.draw(this)):this.gameState==="options"?(this.optionsMenu.update(this,0),this.optionsMenu.draw(this)):this.gameState==="paused"?(this.inGameMenu.update(this,0),this.inGameMenu.draw(this)):this.gameState==="scores"&&ne(this)}addPlayer(){let t=new G;t.hp=this.startingHp,t.maxHp=this.startingHp,t.pos=this.tiles.startTile.pos,t.controller=E,E.attach_to_player(t),this.activePlayers.push(t)}startGame(){this.timer_tick=null,this.score=0,this.cellsCollected=2,this.activePlayers=[];let t=new G;this.activePlayers.push(t),this.multiplayerEnabled?E.attach_to_player(t):(this.keyboard.attach_to_player(t),this.touch.attach_to_player(t),this.gamepadMgr.attach_all_to_player(t)),t.hp=this.startingHp,t.maxHp=this.startingHp,this.chapters=[new Ye,new Xe,new Ee,new je,new Ne],this.weather.reset(),this.startLevel(),this.gameState="running"}nextChapter(){this.activeChapter++,this.chapters[this.activeChapter].start(this)}startLevel(){this.spawnRate=1e4,this.spawnCounter=this.spawnRate,this.levelTime=this.startLevelTime,this.camera.pos=null,this.activeChapter=0,this.competitiveMode||this.cellsCollected,$t(M);for(let t of this.activePlayers)t.pos=this.tiles.startTile.pos,t.escaped=!1,t.dead&&t.revive(this);this.chapters[this.activeChapter].start(this)}playTitleMusic(){M.music!==null&&(M.music.pause(),M.music.currentTime=0),this.music=this.sounds.starSpangled,this.music.loop=!0,this.music.play()}screenshake(){this.shakeAmount&&this.shakeAmount--;let t=Math.random()*Math.PI*2;this.shakeX=Math.round(Math.cos(t)*this.shakeAmount),this.shakeY=Math.round(Math.sin(t)*this.shakeAmount)}drawText(t,e,s,i,a,l="IM Fell English SC"){this.ctx.fillStyle=a,this.ctx.font=e+"px "+l;let r;s?r=(this.canvas.width-this.ctx.measureText(t).width)/2:r=this.canvas.width-this.uiWidth*(this.tileSize-1),this.ctx.fillText(t,r,i)}drawTileText(t,e,s,i){this.ctx.fillStyle=i,this.ctx.font=e+"px IM Fell English SC";let a=(s.y+1-(1-e/this.tileSize)/2)*this.tileSize+this.gameOffsetY+this.shakeY,l=(s.x+(1-this.ctx.measureText(t).width/this.tileSize)/2)*this.tileSize+this.gameOffsetX+this.shakeX;this.ctx.fillText(t,l,a)}nearestPlayer(t){let e=1e9,s=null;for(let i of this.activePlayers)if(!i.dead){let a=i.pos.dist(t);s=a<e?i:s,e=a<e?a:e}return[s,e]}monsters_and_players(t=!0,e=null){return!t&&(!this.competitiveMode||this.levelTime>this.startLevelTime+1e4)?this.monsters.filter(s=>s!==e):this.monsters.concat(this.activePlayers).filter(s=>s!==e)}monsters_with_other_players(t){if(!this.competitiveMode||this.levelTime>this.startLevelTime+1e4)return this.monsters;let e=this.activePlayers.indexOf(t),s=this.activePlayers.slice(0,e).concat(this.activePlayers.slice(e+1));return this.monsters.concat(s)}other_players(t){let e=this.activePlayers.indexOf(t);return this.activePlayers.slice(0,e).concat(this.activePlayers.slice(e+1))}remove(t,e){for(let s=0;s<t.length;s++)if(t[s]==e){t.splice(s,1);return}}remove_dead(t){for(let e=t.length-1;e>=0;e--)t[e].dead&&t.splice(e,1)}remove_dropped(t){for(let e=t.length-1;e>=0;e--)t[e].dropFromGame&&(t[e].controller.attach_to_player(),this.items.push(new Kt(t[e])),t.splice(e,1))}addGunPlatform(t){}addChips(t,e){const s=new Gt(t,e);return this.items.push(s),s}addBoom(t,e){const s=new Vt(t,e);return this.items.push(s),s}addTrapBlade(t){const e=new Jt(t);return this.items.push(e),e}}var M=new Ge;M.start();
