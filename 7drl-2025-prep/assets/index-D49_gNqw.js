var rt=Object.defineProperty;var nt=(u,s,t)=>s in u?rt(u,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[s]=t;var a=(u,s,t)=>nt(u,typeof s!="symbol"?s+"":s,t);(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))i(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerPolicy&&(r.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?r.credentials="include":e.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(e){if(e.ep)return;e.ep=!0;const r=t(e);fetch(e.href,r)}})();class ht{constructor(){a(this,"_seed",0)}random(){return Math.random()}seed(s){}getRandomInt(s,t=0){return t!=0?s+Math.floor(this.random()*(t-s)):Math.floor(this.random()*s)}getRandomPos(s,t){return[this.getRandomInt(s),this.getRandomInt(t)]}randomRange(s=0,t=1){return Math.floor(this.random()*(t-s+1))+s}randomFloat(s=0,t=1){return this.random()*(t-s)+s}shuffle(s){let t,i;for(let e=1;e<s.length;e++)i=this.randomRange(0,e),t=s[e],s[e]=s[i],s[i]=t;return s}choose(s){return s[Math.floor(this.random()*s.length)]}chooseN(s,t){let i=new Array(t),e=s.length,r=new Array(e);if(t>e)throw new RangeError("chooeN: more elements requested than available");for(;t--;){let n=Math.floor(this.random()*e);i[t]=s[n in r?r[n]:n],r[n]=--e in r?r[e]:e}return i}}function G(u,s,t,i){return function(){u>>>=0,s>>>=0,t>>>=0,i>>>=0;var e=u+s|0;return u=s^s>>>9,s=t+(t<<3)|0,t=t<<21|t>>>11,i=i+1|0,e=e+i|0,t=t+e|0,(e>>>0)/4294967296}}class lt extends ht{constructor(){super(...arguments);a(this,"_seed",1);a(this,"d",3735928559);a(this,"xorSeed",Math.floor(Date.now())^this.d);a(this,"random",G(2654435769,608135816,3084996962,this.xorSeed))}seed(t){this._seed=t,this.xorSeed=t^this.d,this.random=G(2654435769,608135816,3084996962,this.xorSeed)}}var K=new lt;function ot(u,s){return K.getRandomPos(u,s)}function at(u=0,s=1){return K.randomFloat(u,s)}class _ extends Array{constructor(s=[0,0]){super(),this[0]=s[0],this[1]=s[1]}equals(s){return this.length===s.length&&this[0]===s[0]&&this[1]===s[1]}static random(s){return new _(ot(s[0],s[1]))}add(s){return new _([this[0]+s[0],this[1]+s[1]])}sub(s){return new _([this[0]-s[0],this[1]-s[1]])}scale(s){return new _([this[0]*s,this[1]*s])}mul(s){return new _([this[0]*s[0],this[1]*s[1]])}div(s){return new _([this[0]/s[0],this[1]/s[1]])}dot(s){return this[0]*s[0]+this[1]*s[1]}dist(s){return Math.hypot(this[0]-s[0],this[1]-s[1])}abs(){return new _([Math.abs(this[0]),Math.abs(this[1])])}sum(){return this[0]+this[1]}relativeTo(s){return this.sub(s.pos).div(s.size)}absoluteFrom(s){return this.mul(s.size).add(s.pos)}relativeToPS(s,t){return this.sub(s).scale(1/t)}absoluteFromPS(s,t){return this.scale(t).add(s)}set x(s){this[0]=s}set y(s){this[1]=s}get x(){return this[0]}get y(){return this[1]}}class P extends Array{constructor(s=null){if(super(),s===null){this[0]=0,this[1]=0,this[2]=0,this[3]=0;return}this[0]=s[0],this[1]=s[1],this[2]=s[2],this[3]=s[3]}set x(s){this[0]=s}set y(s){this[1]=s}set w(s){this[2]=s}set h(s){this[3]=s}set pos(s){this[0]=s[0],this[1]=s[1]}set size(s){this[2]=s[0],this[3]=s[1]}get size(){return new _([this[2],this[3]])}get pos(){return new _([this[0],this[1]])}get x(){return this[0]}get y(){return this[1]}get w(){return this[2]}get h(){return this[3]}get right(){return this[0]+this[2]}get bottom(){return this[1]+this[3]}get center_x(){return this[0]+this[2]/2}get center_y(){return this[1]+this[3]/2}get center(){return new _([this.center_x,this.center_y])}grow(s){return new P([this[0]-s,this[1]-s,this[2]+2*s,this[3]+2*s])}get flooredCenter(){return new _([Math.floor(this[0]+this[2]/2),Math.floor(this[1]+this[3]/2)])}translate(s){return new P([this.x+s[0],this.y+s[1],this.w,this.h])}shrinkBorders(s){return new P([this.x+s,this.y+s,this.w-s*2,this.h-s*2])}scaleBorders(s){return new P([this.x+this.w*(1-s)/2,this.y+this.h*(1-s)/2,this.w*s,this.h*s])}mult(s){return new P([this[0]*s,this[1]*s,this[2]*s,this[3]*s])}multXY(s){return new P([this[0]*s[0],this[1]*s[1],this[2]*s[0],this[3]*s[1]])}scale(s,t=!0){if(t){let i=[this[2]*s,this[3]*s];return new P([this[0]+.5*(this[2]-i[0]),this[1]+.5*(this[3]-i[1]),i[0],i[1]])}else{let i=[this[2]*s,this[3]*s];return new P([this[0],this[1],i[0],i[1]])}}collideRadius(s,t=null){let i=[this.center_x-s.center_x,this.center_y-s.center_y];return t===null&&(t=Math.min(this.w,this.h,s.w,s.h)/2),i[0]*i[0]+i[1]*i[1]<t*t}collide(s){return this.x<s.x+s.w&&this.x+this.w>s.x&&this.y<s.y+s.h&&this.h+this.y>s.y}contains(s){return this.x<=s.x&&this.y<=s.y&&this.x+this.w>=s.x+s.w&&this.y+this.h>=s.y+s.h}contact(s){return this.x<=s.x+s.w&&this.x+this.w>=s.x&&this.y<=s.y+s.h&&this.h+this.y>=s.y}contactRadius(s,t=null){let i=[this.center_x-s.center_x,this.center_y-s.center_y];return t===null&&(t=Math.min(this.w,this.h,s.w,s.h)),i[0]*i[0]+i[1]*i[1]<=t*t}}class J extends Array{constructor(s=[0,0]){super(s[0]*s[1]),this.tileDim=new _(s),this.hidden=!1,this._cacheData=null}get(s){return this[s[0]+s[1]*this.tileDim[0]]}set(s,t){this[s[0]+s[1]*this.tileDim[0]]=t}*iterBetween(s,t,i=0){var e,r,n,l;if([e,r]=s,[n,l]=t,!(Math.abs(l-r)==0&&Math.abs(n-e)==0))if(Math.abs(l-r)>Math.abs(n-e)){var h=(n-e)/(l-r);if(r>l)for(var o=r;o>=l;o--){var f=e+(o-r)*h;yield[f,o]}else for(var o=r;o<=l;o++){var f=e+(o-r)*h;yield[f,o]}}else{var h=(l-r)/(n-e);if(e>n)for(var d=e;d>=n;d--){var c=r+(d-e)*h;yield[d,c]}else for(var d=e;d<=n;d++){var c=r+(d-e)*h;yield[d,c]}}}*iterInBetween(s,t){var i,e,r,n;if([i,e]=s,[r,n]=t,!(Math.abs(n-e)==0&&Math.abs(r-i)==0))if(Math.abs(n-e)>Math.abs(r-i)){var l=(r-i)/(n-e);if(e>n)for(var h=e-1;h>n;h--){var o=Math.round(i+(h-e)*l);yield[o,h]}else for(var h=e+1;h<n;h++){var o=Math.round(i+(h-e)*l);yield[o,h]}}else{var l=(n-e)/(r-i);if(i>r)for(var o=i-1;o>r;o--){var h=Math.round(e+(o-i)*l);yield[o,h]}else for(var o=i+1;o<r;o++){var h=Math.round(e+(o-i)*l);yield[o,h]}}}*iterTypesBetween(s,t,i){for(var e of this.iterBetween(s,t))i.includes(this.get(e))&&(yield e)}*iterTypesInBetween(s,t,i){for(var e of this.iterInBetween(s,t))i.includes(this.get(e))&&(yield e)}hasTypesBetween(s,t,i){for(var e of this.iterTypesBetween(s,t,i))return!0;return!1}hasTypesInBetween(s,t,i){for(var e of this.iterTypesInBetween(s,t,i))return!0;return!1}*iterAll(s=null){const[t,i]=this.tileDim;if(s!==null)for(var e=s[1];e<Math.min(i,s[1]+s[3]);e++)for(var r=s[0];r<Math.min(t,s[0]+s[2]);r++)yield[r,e];else for(var e=0;e<i;e++)for(var r=0;r<t;r++)yield[r,e]}*iterTypes(s,t){for(var i of this.iterAll(t))s.includes(this.get(i))&&(yield i)}*iterAdjacent(s){s=new _(s);for(let t of[[0,-1],[1,0],[0,1],[-1,0]]){const i=s.add(t);i[0]>=0&&i[0]<this.tileDim[0]&&i[1]>=0&&i[1]<this.tileDim[1]&&(yield i)}}hasAdjacent(s,t){for(let i of this.iterAdjacent(s))if(t.includes(this.get(s)))return!0;return!1}*iterInRange(s,t){var i,e;[i,e]=s;const[r,n]=this.tileDim;t==null&&(t=3);for(var l=Math.ceil(t),h=-l;h<l+1;h++)for(var o=-l;o<l+1;o++)if(o*o+h*h<=t*t){var f=i+o,d=e+h;0<=d&&d<n&&0<=f&&f<r&&(yield[f,d])}}*iterTypesInRange(s,t,i,e=null){for(var r of this.iterInRange(s,i))e!==null&&this.hasTypesBetween(s,r,e)||t.includes(this.get(r))&&(yield r)}numInRange(s,t,i,e=null){var r=0;for(var n of this.iterTypesInRange(s,t,i,e))r++;return r}*iterRectBoundary(s){const[t,i]=this.tileDim;let e=Math.min(Math.max(s.x,0),t),r=Math.min(Math.max(s.x+s.w,0),t),n=Math.min(Math.max(s.y,0),i),l=Math.min(Math.max(s.y+s.h,0),i);for(let h=e;h<r;h++)yield[h,n];for(let h=e;h<r;h++)yield[h,l];for(let h=n;h<l;h++)yield[e,h];for(let h=n;h<l;h++)yield[r,h]}*iterRect(s,t=!0){const[i,e]=this.tileDim;if(s instanceof P||(s=new P(s)),t&&(s.x<0||s.y<0||s.right>i||s.bottom>e))return;let r=Math.max(s.x,0),n=Math.min(s.x+s.w,i),l=Math.max(s.y,0),h=Math.min(s.y+s.h,e);for(let o=l;o<h;o++)for(let f=r;f<n;f++)yield[f,o]}numInRect(s,t,i=!0){let e=0;for(var r of this.iterRect(s,i))t.includes(this.get(r))&&e++;return e}}const M=8,H=48*(1/window.devicePixelRatio||1);function X(u,s,t,i,e,r,n){let l=1;t<M&&(l=1/H,u.save(),u.scale(l,l)),u.fillStyle=n,u.font=(t>=M?t:Math.ceil(t/l))+"px "+i,r.x;let h=l*u.measureText(s).width;return t<M&&u.restore(),[h,2*t]}function Q(u,s,t,i,e,r,n,l){let h=1;t<M&&(h=1/H,u.save(),u.scale(h,h)),u.fillStyle=l,u.font=(t>=M?t:Math.ceil(t/h))+"px "+i;let o=n.x,f=u.measureText(s),d=n.y;switch(e){case"left":break;case"center":o+=(n.w-h*f.width)/2;break;case"right":o+=n.w-h*f.width;break}switch(r){case"top":break;case"middle":d+=n.h/2;break;case"bottom":d+=n.h;break}let g={outText:[[s,o/h,d/h]],color:l,fontName:i,size:t,valign:r};return t<M&&u.restore(),g}function ut(u,s,t=null){let i=1,e=s.size;switch(t==null&&(t=s.color),e<M&&(i=1/H,u.save(),u.scale(i,i)),s.valign){case"top":u.textBaseline="top";break;case"middle":u.textBaseline="middle";break;case"bottom":u.textBaseline="bottom";break}u.fillStyle=t,u.font=(e>=M?e:Math.ceil(e/i))+"px "+s.fontName;let[r,n,l]=s.outText[0];u.fillText(r,n,l),e<M&&u.restore()}function j(u,s,t,i,e,r,n,l=!0){let h=1;t<M&&(h=1/H,u.save(),u.scale(h,h)),u.font=(t>=M?t:Math.ceil(t/h))+"px "+i;let o=0,f="",d=Math.min(Math.max(1,Math.ceil(s.length*r.w/u.measureText(s).width/h)),s.length);for(;s!=""||f!="";){if(f==""){let m=s.indexOf(`
`);m>=0?(f=s.slice(0,m),s=s.slice(m+1)):(f=s,s="")}let c=f.slice(0,d),g=h*u.measureText(c).width;if(g>r.w&&d>1)for(;g>r.w&&d>1;)d--,c=f.slice(0,d),g=h*u.measureText(c).width;if(g<r.w&&d<f.length){for(;g<r.w&&d<f.length;)d++,c=f.slice(0,d),g=h*u.measureText(c).width;d--}if(l&&c[-1]!=""&&f[d]!=" "&&f[d]!="	"){let m=Math.max(c.lastIndexOf(" "),c.lastIndexOf("	"));m>=0&&(d-=c.length-m-1)}d=Math.max(1,d),c=f.slice(0,d),f=f.slice(d),l&&(f=f.trimStart()),o+=t}return o+=t,t<M&&u.restore(),[r.w,o]}function V(u,s,t,i,e,r,n,l,h=!0){let o=1;t<M&&(o=1/H,u.save(),u.scale(o,o)),u.fillStyle=l,u.font=(t>=M?t:Math.ceil(t/o))+"px "+i;let f=n.y,d=[],c="",g=Math.min(Math.max(1,Math.ceil(s.length*(n.w/u.measureText(s).width)/o)),s.length);for(;s!=""||c!="";){if(c==""){let C=s.indexOf(`
`);C>=0?(c=s.slice(0,C),s=s.slice(C+1)):(c=s,s="")}let x=n.x,y=c.slice(0,g),D=o*u.measureText(y).width;if(D>n.w&&g>1)for(;D>n.w&&g>1;)g--,y=c.slice(0,g),D=o*u.measureText(y).width;if(D<n.w&&g<c.length){for(;D<n.w&&g<c.length;)g++,y=c.slice(0,g),D=o*u.measureText(y).width;g--}if(h&&g<c.length&&y[-1]!=""&&c[g]!=" "&&c[g]!="	"){let C=Math.max(y.lastIndexOf(" "),y.lastIndexOf("	"));C>=0&&(g-=y.length-C-1)}switch(g=Math.max(1,g),y=c.slice(0,g),c=c.slice(g),h&&(c=c.trimStart()),D=o*u.measureText(y).width,e){case"left":break;case"center":x+=(n.w-D)/2;break;case"right":x+=n.w-D;break}d.push([y,x/o,f/o]),f+=t}let m=f-n.y,b=0;switch(r){case"top":b=0;break;case"middle":b=(n.h-m)/2+t/2;break;case"bottom":b=n.h-m+t}let T={size:t,fontName:i,outText:d,off:b/o,color:l,valign:r};return t<M&&u.restore(),T}function dt(u,s,t=null){let i=1,e=s.size;switch(t===null&&(t=s.color),e<M&&(i=1/H,u.save(),u.scale(i,i)),s.valign){case"top":u.textBaseline="top";break;case"middle":u.textBaseline="middle";break;case"bottom":u.textBaseline="bottom";break}u.fillStyle=t,u.font=(e>=M?e:Math.ceil(e/i))+"px "+s.fontName;for(let r of s.outText)u.fillText(r[0],r[1],r[2]+(s.off??0));e<M&&u.restore()}const Y=(u,s,t)=>Math.min(Math.max(u,s),t);function ft(u,s){return new _(u).dist(s)}function v(u){let s,t,i;return[s,t,i]=new I(u).scale(255).map(e=>Math.floor(e)),"#"+s.toString(16).padStart(2,"0")+t.toString(16).padStart(2,"0")+i.toString(16).padStart(2,"0")}class I extends Array{constructor(...s){s.length==1&&s[0]instanceof Array?super(...s[0]):super(...s)}static asRandomFloats(s,t=0,i=1){let e=new I(s);for(let r=0;r<e.length;r++)e[r]=at(t,i);return e}sum(){let s=0;return this.forEach(t=>s+=t),s}mean(){return this.sum()/this.length}max(){return Math.max.apply(null,this)}min(){return Math.min.apply(null,this)}vars(){let s=0;return this.forEach(t=>s+=t*t),(s-this.length*this.mean()^2)/(this.length-1)}var(){let s=0;return this.forEach(t=>s+=t*t),s/this.length-this.mean()^2}std(){return Math.sqrt(this.var())}add(s){let t=new I(this);if(s instanceof Array)for(let i=0;i<this.length;i++)t[i]+=s[i];else for(let i=0;i<this.length;i++)t[i]+=s;return t}mul(s){let t=new I(this);if(s instanceof Array)for(let i=0;i<this.length;i++)t[i]*=s[i];else for(let i=0;i<this.length;i++)t[i]*=s;return t}scale(s){const t=Array();for(let i of this)t.push(i*s);return t}dot(s){return this.mul(s).sum()}abs(){return Math.abs.apply(null,this)}lag(s){let t=new I;for(let i=-s;i<this.length-s;i++)i<0||i>=this.length?t.push(NaN):t.push(this[i]);return t}filter(s){return new I(super.filter(s))}dropNaN(){return this.filter(s=>!Number.isNaN(s))}}class k{constructor(s={}){a(this,"identifier",-1);a(this,"pos",[0,0]);a(this,"state","touch_up");a(this,"device","touch");a(this,"nativeObject",null);a(this,"nativeEvent",null);for(let t in s)this[t]=s[t]}copy(){return new k({pos:[...this.pos],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}asChildTouch(s){return new k({pos:[...s.toChild(this.pos)],state:this.state,device:this.device,nativeObject:this.nativeObject,nativeEvent:this.nativeEvent,identifier:this.identifier})}get rect(){return new P([...this.pos,0,0])}set x(s){this.pos[0]=s}set y(s){this.pos[1]=s}get x(){return this.pos[0]}get y(){return this.pos[1]}get grabbed(){return p.get().inputHandler.grabbed}grab(s){p.get().inputHandler.grab(s)}ungrab(){p.get().inputHandler.ungrab()}}class ct{constructor(s){a(this,"grabbed",null);a(this,"mouseTouchEmulation",!0);a(this,"mouseev",null);a(this,"keyStates",{});this.app=s,this.canvas=s.canvas;let t=this.canvas,i=this;document.addEventListener("keydown",function(e){i.process_key(e,"key_down")},!0),document.addEventListener("keyup",function(e){i.process_key(e,"key_up")},!0),t.addEventListener("mousedown",function(e){i.process_mouse(e,"mouse_down")},!0),t.addEventListener("mousemove",function(e){i.process_mouse(e,"mouse_move")},!0),t.addEventListener("mouseout",function(e){i.process_mouse(e,"mouse_cancel")},!0),t.addEventListener("mouseup",function(e){i.process_mouse(e,"mouse_up")},!0),t.addEventListener("touchstart",function(e){i.process_touch(e,"touch_down")},!1),t.addEventListener("touchmove",function(e){i.process_touch(e,"touch_move")},!1),t.addEventListener("touchcancel",function(e){i.process_touch(e,"touch_cancel")},!1),t.addEventListener("touchend",function(e){i.process_touch(e,"touch_up")},!1),t.addEventListener("wheel",function(e){i.process_wheel(e,"wheel")},!0),window.history.replaceState(null,document.title,location.pathname+"#!/backbutton"),window.history.pushState(null,document.title,location.pathname),window.addEventListener("popstate",function(e){i.process_back(e,"back_button")},!1)}grab(s){this.grabbed=s}ungrab(){this.grabbed=null}isKeyUp(s){return s in this.keyStates&&this.keyStates[s]}isKeyDown(s){return s in this.keyStates&&this.keyStates[s]}process_key(s,t){this.app.requestFrameUpdate();const i=this.keyStates[s.key];t==="key_up"?this.keyStates[s.key]=!1:t==="key_down"&&(this.keyStates[s.key]=!0),this.app.emit(t,{states:this.keyStates,oldState:i,event:s})}process_touch(s,t){if(this.app.requestFrameUpdate(),this.grabbed!==null)for(let i of s.changedTouches){let e=this.grabbed.appToChild([i.clientX,i.clientY]),r=new k({pos:e,state:t,nativeObject:i,nativeEvent:s,identifier:i.identifier});this.grabbed.emit(t,r)}else for(let i of s.changedTouches){let e=new k({pos:this.app.toChild([i.clientX,i.clientY]),state:t,nativeObject:i,nativeEvent:s,identifier:i.identifier});this.app.childEmit(t,e,!0)}s.preventDefault()}process_back(s,t){location.hash==="#!/backbutton"&&(history.replaceState(null,document.title,location.pathname),this.app.childEmit("back_button",s))}process_mouse(s,t){if(this.app.requestFrameUpdate(),this.mouseev=s,s.preventDefault(),this.mouseTouchEmulation){let i={mouse_up:"touch_up",mouse_down:"touch_down",mouse_move:"touch_move",mouse_cancel:"touch_cancel"};if(s.buttons!==1&&t!=="mouse_up")return;if(this.grabbed!==null){let e=[s.clientX,s.clientY],r=this.grabbed.appToChild(e),n=new k({pos:r,state:i[t],nativeObject:s,identifier:-1});this.grabbed.emit(i[t],n)}else{let e=new k({pos:this.app.toChild([s.clientX,s.clientY]),state:i[t],nativeObject:s,identifier:-1});this.app.childEmit(i[t],e,!0)}}else this.grabbed!==null?this.grabbed.emit(t,s):this.app.childEmit(t,s,!0)}process_wheel(s,t){if(this.mouseev!=null){if(this.app.requestFrameUpdate(),this.grabbed!=null){let i=this.grabbed.appToChild([this.mouseev.clientX,this.mouseev.clientY]),e=new k({pos:i,state:t,nativeObject:s});return this.grabbed.emit(t,e)}else{let i=new k({pos:this.app.toChild([this.mouseev.clientX,this.mouseev.clientY]),state:t,nativeObject:s});this.app.childEmit(t,i,!0)}s.preventDefault()}}vibrate(s,t,i){window.navigator.vibrate(i)}}function gt(u,s,t,i){if(typeof s=="string"||s instanceof String){if(u.startsWith("on_"))return new Function("resources","parent","root",`return function(event, object, value) {${s}}`).bind(t)(p.resources,t.parent,i);if(s.trim().startsWith("(")&&s.indexOf("=>")<s.indexOf(`
`)){const o=new Function("resources","parent","root",`return ${s}`).bind(t)(p.resources,t.parent,i);return o.markupMethod=!0,o}const e=new Set;let r=0;if(s[0]!=="'"&&s[0]!=='"')for(let o of s.matchAll(/(?!\.)\b([a-z]\w*)\.([a-z_]\w*)\b/ig)){const f=o[1];f!=="this"&&f!=="parent"&&f!=="root"&&f!=="resources"&&e.add(f),r++}if(r===0)return new Function("resources",`return ${s};`)(p.resources);const n=[...e].join(", "),l=`return function (${n}) { return ${s} }`,h=new Function("resources","parent","root",l)(p.resources,t.parent,i).bind(t);return h.text=`(${n}) => ${s}`,h}return s}function Z(u,s,t){const i={},e=u.constructor.name,n={...p.rules.get(e),...s};for(let l in n){const h=n[l];if(l==="children"&&h instanceof Array){const o=[];for(let f of h)if(f instanceof Object&&"cls"in f){const[d,c]=p.classes[f.cls],g=new d;Z(g,f,t),o.push(g)}else throw Error(`Unknown child class ${f} on clsName ${e}`);u instanceof p?u.baseWidget.children=o:u.children=o}else if(l!=="cls")try{i[l]=gt(l,h,u,t)}catch{i[l]=h}}u.updateProperties(i,!1)}class mt{constructor(s,t=0,i=null){this.elapsed=0,this.timer=s,this.triggered=!1,this.callback=i,t>0&&this.tick(t)}finished(){return this.elapsed>=this.timer}tick(s){return this.elapsed>=this.timer?(this.triggered&&(this.triggered=!1),!1):(this.elapsed+=s,this.elapsed>=this.timer?(this.callback!=null&&this.callback("timer",this),this.triggered=!0,!0):!1)}reset(s=-1,t=0){this.triggered=!1,s>=0&&(this.timer=s),t>0&&this.tick(t)}}class pt{constructor(){this.rules=new Map}add(s,t,i=!0){let e=this.rules.get(s);if(e&&!i)for(let r in e)e[r]=t[r];else this.rules.set(s,t)}get(s){return this.rules.get(s)??{}}remove(s){return this.rules.delete(s)}}class wt{constructor(s,t,i){this.listener=s,this.event=t,this.callback=i}}class _t{constructor(){this.connections=new Map}bind(s,t,i,e){let r=new wt(s,i,e),n=this.connections.get(t);n?n.add(r):this.connections.set(t,new Set([r]))}emit(s,t,i){const e=this.connections.get(s);if(!e)return!1;for(let r of e)if(r.event===t&&r.callback(t,s,i))return!0;return!1}disconnect(s){this.connections.delete(s);for(let t of this.connections.keys()){const i=[],e=this.connections.get(t);if(e){for(let r of e)r.listener===s&&i.push(r);i.forEach(r=>e.delete(r))}}}}class L extends P{constructor(t=null){super();a(this,"bgColor",null);a(this,"outlineColor",null);a(this,"_animation",null);a(this,"_layoutNotify",!1);a(this,"hints",{});return this.parent=null,this._processTouches=!1,this._deferredProps=null,this._children=[],this._needsLayout=!0,t!=null&&this.updateProperties(t),new Proxy(this,{set(i,e,r,n){return typeof e=="string"&&(["x","y","w","h","children","rect"].includes(e)||e[0]=="_")?Reflect.set(i,e,r,n):(Reflect.set(i,e,r,n),typeof e=="string"&&Reflect.apply(i.emit,n,[e,r]),!0)}})}set rect(t){this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this._needsLayout=!0}get rect(){return new P([this[0],this[1],this[2],this[3]])}deferredProperties(t){let i=this._deferredProps;this._deferredProps=null;for(let e in i)if(!e.startsWith("on_")&&!e.startsWith("_")&&typeof i[e]=="function"){let r=i[e],n,l;[n,l]=(r.text??r.toString()).split("=>"),n=n.replace("(","").replace(")","").split(",").map(d=>d.trim());let h=n.map(d=>t.findById(d)),o={};for(let d of n)o[d]=t.findById(d);const f=/(\w+)\.(\w+)/g;for(let d of l.matchAll(f)){let c,g;if([g,c]=d.slice(1),g==="this")this.bind(c,(m,b,T)=>{try{this[e]=r(...h)}catch(x){console.log("Dynamic binding error",this,e,x)}});else if(g in o)try{o[g].bind(c,(m,b,T)=>{try{this[e]=r(...h)}catch(x){console.log("Dynamic binding error",this,e,x)}})}catch(m){console.log(`Warning: ${g} cannot be bound on`,this,`
property`,e,`
error`,m)}}try{this[e]=r(...h)}catch(d){console.log("Dynamic binding error",this,e,d)}}}updateProperties(t,i=!0){i&&Z(this,{},this);for(let e in t)!e.startsWith("on_")&&!e.startsWith("_")&&typeof t[e]=="function"&&!("markupMethod"in t[e])?this._deferredProps=t:this[e]=t[e]}bind(t,i,e=null){p.get()._eventManager.bind(e,this,t,i)}emit(t,i){return"on_"+t in this&&this["on_"+t](t,this,i)?!0:p.get()._eventManager.emit(this,t,i)}*iter(t=!0,i=!0){if(yield this,!!t)for(let e of this._children)yield*e.iter(...arguments)}*iterParents(){this.parent!==null&&(yield this.parent,this.parent!=p.get()&&(yield*this.parent.iterParents()))}findById(t){for(let i of this.iter(!0,!1))if("id"in i&&i.id==t)return i;return null}*iterByPropertyValue(t,i){for(let e of this.iter(!0,!1))t in e&&e[t]==i&&(yield e)}getTransformRecurse(t=!1,i=null){let e=this!==i&&this.parent!==null?this.parent.getTransformRecurse(!0,i):new DOMMatrix;if(!t)return e;let r=this.getTransform();return r?e.multiply(r):e}getTransform(){return null}applyTransform(t,i=!1,e=!1,r=!1,n=null){let l=e?this.getTransformRecurse(r,n):this.getTransform();if(!l)return t;i&&(l=l.inverse());let h=l.transformPoint(new DOMPoint(t.x,t.y));return new _([h.x,h.y])}appToWidget(t,i=!0){if(this.parent){let e=this.parent.getTransformRecurse().inverse().transformPoint(new DOMPoint(t[0],t[1]));return new _([e.x,e.y])}return t}appToChild(t,i=!0){let e=this.getTransformRecurse().inverse().transformPoint(new DOMPoint(t[0],t[1]));return new _([e.x,e.y])}toChild(t){let i=this.getTransform();if(!i)return t;let e=i.inverse().transformPoint(new DOMPoint(t[0],t[1]));return new _([e.x,e.y])}addChild(t,i=-1){i==-1?this._children.push(t):this._children=[...this._children.slice(0,i),t,...this._children.slice(i)],this.emit("child_added",t),t.parent=this,this._needsLayout=!0}removeChild(t,i=!0){this._children=this.children.filter(e=>e!=t),i&&p.get()._eventManager.disconnect(t),this.emit("child_removed",t),t.parent=null,this._needsLayout=!0}get children(){return this._children}set children(t){for(let i of this._children)this.emit("child_removed",i),i.parent=null,this._needsLayout=!0;this._children=[];for(let i of t)this.addChild(i)}set x(t){this._needsLayout=!0,this[0]=t}set center_x(t){this._needsLayout=!0,this[0]=t-this[2]/2}set right(t){this._needsLayout=!0,this[0]=t-this[2]}set y(t){this._needsLayout=!0,this[1]=t}set center_y(t){this._needsLayout=!0,this[1]=t-this[3]/2}set bottom(t){this._needsLayout=!0,this[1]=t-this[3]}set w(t){this._needsLayout=!0,this[2]=t}set h(t){this._needsLayout=!0,this[3]=t}get x(){return this[0]}get center_x(){return this[0]+this[2]/2}get right(){return this[0]+this[2]}get y(){return this[1]}get center_y(){return this[1]+this[3]/2}get bottom(){return this[1]+this[3]}get w(){return this[2]}get h(){return this[3]}on_wheel(t,i,e){for(let r=this._children.length-1;r>=0;r--)if(this._children[r].emit(t,e))return!0;return!1}on_touch_down(t,i,e){let r=this.getTransform();if(r){let n=e.copy(),l=r.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[l.x,l.y];for(let h=this._children.length-1;h>=0;h--)if(this._children[h].emit(t,n))return!0}else for(let n=this._children.length-1;n>=0;n--)if(this._children[n].emit(t,e))return!0;return!1}on_touch_up(t,i,e){let r=this.getTransform();if(r){let n=e.copy(),l=r.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[l.x,l.y];for(let h=this._children.length-1;h>=0;h--)if(this._children[h].emit(t,n))return!0}else for(let n=this._children.length-1;n>=0;n--)if(this._children[n].emit(t,e))return!0;return!1}on_touch_move(t,i,e){let r=this.getTransform();if(r){let n=e.copy(),l=r.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[l.x,l.y];for(let h=this._children.length-1;h>=0;h--)if(this._children[h].emit(t,n))return!0}else for(let n=this._children.length-1;n>=0;n--)if(this._children[n].emit(t,e))return!0;return!1}on_touch_cancel(t,i,e){let r=this.getTransform();if(r){let n=e.copy(),l=r.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[l.x,l.y];for(let h=this._children.length-1;h>=0;h--)if(this._children[h].emit(t,n))return!0}else for(let n=this._children.length-1;n>=0;n--)if(this._children[n].emit(t,e))return!0;return!1}on_back_button(t,i,e){return!1}getMetric(t,i,e,r=null,n=null){let l=p.get();if(e===null)return t[i];let h=0,o="relative";for(r=r??this.w,n=n??this.h;;){if(e.constructor==String){let f=e.slice(-2);if(f=="ww"){h=+e.slice(0,-2)*t.w;break}if(f=="wh"){h=+e.slice(0,-2)*t.h;break}if(f=="aw"){h=+e.slice(0,-2)*l.dimW,o="absolute";break}if(f=="ah"){h=+e.slice(0,-2)*l.dimH,o="absolute";break}let d=e.slice(-1);if(d=="w"){h=+e.slice(0,-1)*r;break}if(d=="h"){h=+e.slice(0,-1)*n;break}h=+e;break}if(i=="w"||i=="x"||i=="center_x"||i=="right"){h=+e;break}h=+e;break}return o=="relative"&&(["x","center_x","right"].includes(i)&&(h+=this.x),["y","center_y","bottom"].includes(i)&&(h+=this.y)),h}applyHintMetric(t,i,e,r=null,n=null){let l=p.get();if(e===null)return;let h=0,o="relative";for(r=r??this.w,n=n??this.h;;){if(e.constructor==String){let f=e.slice(-2);if(f=="ww"){h=+e.slice(0,-2)*t.w;break}if(f=="wh"){h=+e.slice(0,-2)*t.h;break}if(f=="aw"){h=+e.slice(0,-2)*l.dimW,o="absolute";break}if(f=="ah"){h=+e.slice(0,-2)*l.dimH,o="absolute";break}let d=e.slice(-1);if(d=="w"){h=+e.slice(0,-1)*r;break}if(d=="h"){h=+e.slice(0,-1)*n;break}h=+e;break}if(i=="w"||i=="x"||i=="center_x"||i=="right"){h=+e*r;break}h=+e*n;break}o=="relative"&&(["x","center_x","right"].includes(i)&&(h+=this.x),["y","center_y","bottom"].includes(i)&&(h+=this.y)),t[i]=h}applyHints(t,i=null,e=null){let r=t.hints;i=i??this.w,e=e??this.h,"w"in r&&r.w!=null&&r.w.constructor==String&&r.w.slice(-2)=="wh"?(r.h!==void 0&&this.applyHintMetric(t,"h",r.h,i,e),r.w!==void 0&&this.applyHintMetric(t,"w",r.w,i,e)):(r.w!==void 0&&this.applyHintMetric(t,"w",r.w,i,e),r.h!==void 0&&this.applyHintMetric(t,"h",r.h,i,e));for(let n in r)n!="w"&&n!="h"&&this.applyHintMetric(t,n,r[n],i,e)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;for(let t of this.children)this.applyHints(t),t.layoutChildren()}_draw(t,i,e){this.draw(t,i);let r=this.getTransform();if(r){i.save(),i.transform(r.a,r.b,r.c,r.d,r.e,r.f);for(let n of this._children)n._draw(t,i,e);i.restore();return}for(let n of this._children)n._draw(t,i,e)}draw(t,i){let e=this.rect;if(i.beginPath(),i.rect(e[0],e[1],e[2],e[3]),this.bgColor!=null&&(i.fillStyle=this.bgColor,i.fill()),this.outlineColor!=null){let r=i.lineWidth;i.lineWidth=1/t.tileSize,i.strokeStyle=this.outlineColor,i.stroke(),i.lineWidth=r}}update(t,i){this._deferredProps!=null&&this.deferredProperties(t),this._animation!=null&&(this._animation.update(t,i),t.requestFrameUpdate()),this._needsLayout&&(this.layoutChildren(),t.requestFrameUpdate());for(let e of this._children)e.update(t,i)}}const A=class A extends L{static registerClass(s,t,i){A.classes[s]=[t,i]}constructor(s=null){if(A.appInstance!=null)return A.appInstance;super(),A.appInstance=this,window.app=this,this._eventManager=new _t,this.id="app",this.w=-1,this.h=-1,this._baseWidget=new L({hints:{x:0,y:0,w:1,h:1}}),this._baseWidget.parent=this,this._modalWidgets=[],this._udpateActive=!0,this.pixelSize=1,this.integerTileSize=!1,this.exactDimensions=!1,this.prefDimW=32,this.prefDimH=16,this.dimW=this.prefDimW,this.dimH=this.prefDimH,this.tileSize=this.getTileScale()*this.pixelSize,this.canvasName="canvas",this.canvas=null,this.offsetX=0,this.offsetY=0,this.shakeX=0,this.shakeY=0,this.shakeAmount=0,this.timer_tick=null,this.timers=[],this.continuousFrameUpdates=!1,this._requestedFrameUpdate=!1,s&&this.updateProperties(s)}get baseWidget(){return this._baseWidget}addTimer(s,t){let i=new mt(s,0,t);return this.timers.push(i),i}removeTimer(s){this.timers=this.timers.filter(t=>t!=s)}addModal(s){this._modalWidgets.push(s),this._needsLayout=!0}removeModal(s){this._modalWidgets=this._modalWidgets.filter(t=>t!=s)}static get(){return A.appInstance||(A.appInstance=new A),A.appInstance}start(){let s=this;this.setupCanvas(),this.inputHandler=new ct(this),window.onresize=()=>s.updateWindowSize(),this.updateWindowSize(),setTimeout(()=>this._start(),1)}_start(){this.update()}childEmit(s,t,i=!1){if(i&&this._modalWidgets.length>0)return this._modalWidgets[this._modalWidgets.length-1].emit(s,t);if(this._baseWidget.emit(s,t))return!0;for(let e of this._modalWidgets)if(e.emit(s,t))return!0;return!1}*iter(s=!0,t=!0){yield this,yield*this._baseWidget.iter(...arguments);for(let i of this._modalWidgets)yield*i.iter(...arguments)}findById(s){for(let t of this.iter(!0,!1))if("id"in t&&t.id==s)return t;return null}*iterByPropertyValue(s,t){for(let i of this.iter(!0,!1))s in i&&i[s]===t&&(yield i)}update(){this._udpateActive=!0,this._requestedFrameUpdate=!1;let s=15,t=Date.now();this.timer_tick!=null&&(s=Math.min(t-this.timer_tick,30)),(this.timers.length>0||this._needsLayout)&&this.requestFrameUpdate();for(let i of this.timers)i.tick(s);this._needsLayout&&this.layoutChildren();for(let i of A.resources.values())i.update(this,s);this._baseWidget.update(this,s);for(let i of this._modalWidgets)i.update(this,s);this.ctx&&this._draw(this,this.ctx,s),this.continuousFrameUpdates&&this.requestFrameUpdate(),this.timer_tick=t,this._requestedFrameUpdate&&window.requestAnimationFrame(()=>this.update()),this._udpateActive=!1}requestFrameUpdate(){this._requestedFrameUpdate||(this._udpateActive?this._requestedFrameUpdate=!0:window.requestAnimationFrame(()=>this.update()))}_draw(s,t,i){if(!this.canvas)return;t.clearRect(0,0,this.canvas.width,this.canvas.height),this.shakeX=0,this.shakeY=0,this.screenShake(),t.save();let e=this.getTransform();e&&t.transform(e.a,e.b,e.c,e.d,e.e,e.f),this._baseWidget._draw(s,t,i);for(let r of this._modalWidgets)r._draw(s,t,i);t.restore()}getTransform(s=!0){return new DOMMatrix().translate(this.offsetX+this.shakeX,this.offsetY+this.shakeY).scale(this.tileSize,this.tileSize)}on_prefDimW(s,t,i){this.updateWindowSize()}on_prefDimH(s,t,i){this.updateWindowSize()}on_tileSize(s,t,i){this.prefDimH<0&&this.prefDimW<0&&this.updateWindowSize()}updateWindowSize(){this.x=0,this.y=0,this.w=window.innerWidth,this.h=window.innerHeight,this.prefDimH>=0&&this.prefDimW>=0&&(this.tileSize=this.getTileScale()),this.fitDimensionsToTileSize(this.tileSize),this.setupCanvas();try{screen.orientation.unlock()}catch{}this._needsLayout=!0,this.requestFrameUpdate()}getTileScale(){let s=this.h,t=this.w,i=1/this.pixelSize;return this.prefDimW<0&&this.prefDimH<0?this.tileSize>0&&(i=this.tileSize/this.pixelSize):this.prefDimW<0?i=s/this.prefDimH/this.pixelSize:this.prefDimH<0?i=t/this.prefDimW/this.pixelSize:i=Math.min(s/this.prefDimH/this.pixelSize,t/this.prefDimW/this.pixelSize),this.integerTileSize&&i>1&&(i=Math.floor(i)),i*this.pixelSize}fitDimensionsToTileSize(s){let t=this.h,i=this.w;if(this.exactDimensions){this.prefDimW<0&&this.prefDimH<0?(this.dimW=i/this.tileSize,this.dimH=t/this.tileSize):this.prefDimH<0?(this.dimW=this.prefDimW,this.dimH=t/this.tileSize):this.prefDimW<0?(this.dimW=i/this.tileSize,this.dimH=this.prefDimH):(this.dimH=this.prefDimH,this.dimW=this.prefDimW);return}this.dimH=Math.floor(t/s),this.dimW=Math.floor(i/s)}setupCanvas(){this.canvas=document.querySelector(this.canvasName),this.canvas&&(this.canvas.width=this.w,this.canvas.height=this.h,this.ctx=this.canvas.getContext("2d"),this.ctx&&(this.ctx.imageSmoothingEnabled=!1,this.offsetX=Math.floor((this.w-this.tileSize*this.dimW)/2),this.offsetY=Math.floor((this.h-this.tileSize*this.dimH)/2)))}applyHints(s){super.applyHints(s,this.dimW,this.dimH)}screenShake(){this.shakeAmount&&this.shakeAmount--;let s=Math.random()*Math.PI*2;this.shakeX=Math.round(Math.cos(s)*this.shakeAmount),this.shakeY=Math.round(Math.sin(s)*this.shakeAmount)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.applyHints(this._baseWidget),this._baseWidget.layoutChildren();for(let s of this._modalWidgets)this.applyHints(s),s.layoutChildren()}};a(A,"appInstance",null),a(A,"rules",new pt),a(A,"resources",new Map),a(A,"classes",{});let p=A;class R extends L{constructor(t=null){super();a(this,"fontSize",null);a(this,"sizeGroup","");a(this,"clip",!1);a(this,"ignoreSizeForGroup",!1);a(this,"fontName",'"Nimbus Mono PS", "Courier New", monospace');a(this,"text","");a(this,"wrap",!1);a(this,"wrapAtWord",!0);a(this,"align","center");a(this,"valign","middle");a(this,"color","white");this._textData=null,t!==null&&this.updateProperties(t)}on_align(t,i,e){this._needsLayout=!0}on_valign(t,i,e){this._needsLayout=!0}on_wrap(t,i,e){this._needsLayout=!0}on_wrapAtWord(t,i,e){this._needsLayout=!0}on_text(t,i,e){this._needsLayout=!0}on_fontSize(t,i,e){this._needsLayout=!0}on_fontName(t,i,e){this._needsLayout=!0}layoutChildren(){let i=p.get().ctx;if(!i)return;let e=this.fontSize===null?null:this.getMetric(this,"fontSize",this.fontSize);if("h"in this.hints&&this.hints.h==null&&e!==null&&(this[3]=this.wrap?j(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[1]:X(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color)[1]),"w"in this.hints&&this.hints.w==null&&e!==null&&(this[2]=this.wrap?j(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord)[0]:X(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color)[0]),e=e===null?this.h/2:e,this.fontSize===null&&this.rect.w!==void 0){let r=0,n,l;for(;r<50;){if(this.wrap?[n,l]=j(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color,this.wrapAtWord):[n,l]=X(i,this.text,e,this.fontName,this.align=="center",this.rect,this.color),(this.h>=l||"h"in this.hints&&this.hints.h==null||e<.01)&&(this.w>=n||"w"in this.hints&&this.hints.w==null)){"h"in this.hints&&this.hints.h==null&&(this.h=l),"w"in this.hints&&this.hints.w==null&&(this.w=n);break}const h=Math.min(1.1,this.w/n,this.h/l);this.wrap?e*=h**.5:e*=h**1.1,r++}e===void 0&&(e=.001*p.get().h)}this.sizeGroup!==""?(this._bestFontSize=e,this._textData=null):this.wrap?this._textData=V(i,this.text,e,this.fontName,this.align,this.valign,this.rect,this.color,this.wrapAtWord):this._textData=Q(i,this.text,e,this.fontName,this.align,this.valign,this.rect,this.color),super.layoutChildren()}sizeToGroup(t){if(this._bestFontSize===void 0)return;let i=1/0;for(let e of p.get().iterByPropertyValue("sizeGroup",this.sizeGroup))i>e._bestFontSize&&!e.ignoreSizeForGroup&&(i=e._bestFontSize);if(i>0)for(let e of p.get().iterByPropertyValue("sizeGroup",this.sizeGroup)){const r=e.clip||!e.ignoreSizeForGroup?i:e._bestFontSize;e.wrap?e._textData=V(t,e.text,r,e.fontName,e.align,e.valign,e.rect,e.color,e.wrapAtWord):e._textData=Q(t,e.text,r,e.fontName,e.align,e.valign,e.rect,e.color)}}draw(t,i){if(super.draw(t,i),this.clip){i.save();const e=this.rect;i.rect(e.x,e.y,e.w,e.h),i.clip()}!this._textData&&this.sizeGroup!==""&&this.sizeToGroup(i),this._textData&&(this.wrap?dt(i,this._textData,this.color):ut(i,this._textData,this.color)),this.clip&&i.restore()}}class yt extends R{constructor(t=null){super();a(this,"bgColor",v([.5,.5,.5]));a(this,"selectColor",v([.7,.7,.8]));a(this,"disableColor1",v([.2,.2,.2]));a(this,"disableColor2",v([.4,.4,.4]));a(this,"disable",!1);t!==null&&this.updateProperties(t)}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):!1}on_touch_up(t,i,e){return super.on_touch_up(t,i,e)?!0:e.grabbed!=this?!1:(e.ungrab(),!this.disable&&this.collide(e.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(t,i,e){return super.on_touch_move(t,i,e)?!0:(e.grabbed==this&&!this.disable&&(this._touching=this.collide(e.rect)),!1)}draw(t,i){let e=this.bgColor,r=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(t,i),this.bgColor=e,this.color=r}}class bt extends L{constructor(t=null){super();a(this,"color",v([.8,.8,.8]));a(this,"bgColor",v([.5,.5,.5]));a(this,"selectColor",v([.7,.7,.8]));a(this,"disableColor1",v([.2,.2,.2]));a(this,"disableColor2",v([.4,.4,.4]));a(this,"disable",!1);t!==null&&this.updateProperties(t)}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):!1}on_touch_up(t,i,e){return super.on_touch_up(t,i,e)?!0:e.grabbed!=this?!1:(e.ungrab(),!this.disable&&this.collide(e.rect)?(this._touching=!1,this.emit("press",null),!0):!1)}on_touch_move(t,i,e){return super.on_touch_move(t,i,e)?!0:(e.grabbed==this&&!this.disable&&(this._touching=this.collide(e.rect)),!1)}draw(t,i){let e=this.bgColor,r=this.color;this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(t,i),this.bgColor=e,this.color=r}}class $ extends R{constructor(t=null){super();a(this,"bgColor",v([.5,.5,.5]));a(this,"pressColor",v([.7,.7,.7]));a(this,"selectColor",v([.7,.7,.8]));a(this,"disableColor1",v([.2,.2,.2]));a(this,"disableColor2",v([.4,.4,.4]));a(this,"disable",!1);a(this,"_press",!1);a(this,"group",null);a(this,"singleSelect",!0);t!==null&&this.updateProperties(t)}get press(){return this._press}set press(t){this._press=t}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):!1}on_touch_up(t,i,e){if(e.grabbed!==this)return!1;if(e.ungrab(),this._touching=!1,this.collide(e.rect)){if(this.group===null||!this.singleSelect)this.press=!this.press;else{if(this.parent!==null)for(let r of this.parent.iterByPropertyValue("group",this.group))r!==this&&(r._press=!1);this.press=!0}return!0}return!1}on_touch_move(t,i,e){return e.grabbed===this?(this._touching=this.collide(e.rect),!0):!1}draw(t,i){let e=this.bgColor,r=this.color;this.press&&(this.bgColor=this.pressColor),this._touching&&(this.bgColor=this.selectColor),this.disable&&(this.bgColor=this.disableColor1,this.color=this.disableColor2),super.draw(t,i),this.bgColor=e,this.color=r}}class vt extends L{constructor(t=null){super();a(this,"selectColor",v([.7,.7,.8]));a(this,"color",v([.6,.6,.6]));a(this,"bgColor",v([.5,.5,.5]));a(this,"disableColor1",v([.2,.2,.2]));a(this,"disableColor2",v([.3,.3,.3]));a(this,"disable",!1);a(this,"check",!1);a(this,"group",null);t!==null&&this.updateProperties(t)}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):!1}on_touch_up(t,i,e){if(super.on_touch_up(t,i,e))return!0;if(this.parent===null||e.grabbed!=this)return!1;if(e.ungrab(),!this.disable&&this.collide(e.rect)){if(this._touching=!1,this.group==null)this.check=!this.check;else{for(let r of this.parent.iterByPropertyValue("group",this.group))r!=this&&(r.check=!1);this.check=!0}return!0}return!1}on_touch_move(t,i,e){return super.on_touch_move(t,i,e)?!0:e.grabbed==this&&!this.disable?(this._touching=this.collide(e.rect),!0):!1}draw(t,i){if(this.group!=null){let n=this.rect;n.w=n.h=.5*Math.min(n.w,n.h),n.x=this.x+(this.w-n.w)/2,n.y=this.y+(this.h-n.h)/2;let l=p.get().tileSize,h=p.get().ctx;if(!h)return;h.strokeStyle=this.disable?this.disableColor1:this.bgColor,h.lineWidth=1/l,h.beginPath(),h.arc(n.center_x,n.center_y,n.w/2,0,2*Math.PI),h.stroke(),(this._touching||this.disable)&&(h.fillStyle=this.disable?this.disableColor1:this.selectColor,h.fill()),this.check&&(h.fillStyle=this.disable?this.disableColor2:this.color,h.beginPath(),h.arc(n.center_x,n.center_y,n.w/3,0,2*Math.PI),h.fill());return}let e=this.rect;e.w=e.h=.5*Math.min(e.w,e.h),e.x=this.x+(this.w-e.w)/2,e.y=this.y+(this.h-e.h)/2;let r=t.tileSize;i.beginPath(),i.strokeStyle=this.bgColor,this.disable&&(i.strokeStyle=this.disableColor1),i.lineWidth=1/r,i.rect(e[0],e[1],e[2],e[3]),i.stroke(),this._touching&&(i.fillStyle=this.selectColor,i.fill()),this.check&&(i.strokeStyle=this.color,this.disable&&(i.strokeStyle=this.disableColor2),i.beginPath(),i.lineWidth=e.w/5,i.moveTo(e.x,e.y),i.lineTo(e.right,e.bottom),i.moveTo(e.right,e.y),i.lineTo(e.x,e.bottom),i.stroke())}}class xt extends L{constructor(t=null){super();a(this,"selectColor",v([.7,.7,.8]));a(this,"color",v([.6,.6,.6]));a(this,"bgColor",v([.4,.4,.4]));a(this,"disableColor1",v([.2,.2,.2]));a(this,"disableColor2",v([.3,.3,.3]));a(this,"disable",!1);a(this,"min",0);a(this,"max",1);a(this,"curMax",1);a(this,"unboundedStopMultiple",10);a(this,"exponentialSlider",!1);a(this,"step",null);a(this,"orientation","horizontal");a(this,"value",0);a(this,"sliderSize",.2);t!==null&&this.updateProperties(t)}setValue(t){let i=this.max??this.curMax,e=0;this.orientation=="horizontal"&&(e=Y((t.rect.x-this.x-this.w*this.sliderSize/2)/(this.w*(1-this.sliderSize)),0,1)),this.orientation=="vertical"&&(e=Y((t.rect.y-this.y-this.h*this.sliderSize/2)/(this.h*(1-this.sliderSize)),0,1)),this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?e=e>.5?i/this.unboundedStopMultiple+(e-.5)/.5*(i-i/this.unboundedStopMultiple):this.min+e/.5*(i/this.unboundedStopMultiple-this.min):e=this.min+(i-this.min)*e,this.step!=null&&(e=Math.round(e/this.step)*this.step),this.value=e}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touch=!0,this.setValue(e),!0):!1}updateMax(){this.max===null&&(this.curMax=this.unboundedStopMultiple*this.value)}on_touch_up(t,i,e){return e.grabbed!=this?super.on_touch_up(t,i,e):(e.ungrab(),!this.disable&&this.collide(e.rect)&&(this._touching=!1,this.setValue(e)),this.updateMax(),!0)}on_touch_move(t,i,e){return e.grabbed!==this?super.on_touch_move(t,i,e):(this.disable||(this._touching=this.collide(e.rect),this.setValue(e)),!1)}draw(t,i){let e=t.tileSize,r=this.rect;if(this.orientation=="horizontal"){r.w-=this.sliderSize*this.w,r.x+=this.sliderSize/2*this.w;let n=Math.min(this.sliderSize/2*this.w,this.h/2)/2;i.strokeStyle=this.disable?this.disableColor1:this.bgColor,i.beginPath(),i.lineWidth=4/e,i.moveTo(r.x,r.center_y),i.lineTo(r.right,r.center_y),i.stroke();let l=this.max??this.curMax,h;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?h=this.value>l/this.unboundedStopMultiple?(.5+.5*(this.value-l/this.unboundedStopMultiple)/(l-l/this.unboundedStopMultiple))*r.w:.5*(this.value-this.min)/(l/this.unboundedStopMultiple-this.min)*r.w:h=(this.value-this.min)/(l-this.min)*r.w,i.strokeStyle=this.disable?this.disableColor2:this.bgColor,i.beginPath(),i.arc(r.x+h,r.center_y,n,0,2*Math.PI),i.stroke(),i.fillStyle=this.color,(this._touching||this.disable)&&(i.fillStyle=this.disable?this.disableColor1:this.selectColor),i.fill()}if(this.orientation=="vertical"){r.h-=this.sliderSize*this.h,r.y+=this.sliderSize/2*this.h;let n=Math.min(this.sliderSize/2*this.h,this.w/2)/2;i.strokeStyle=this.disable?this.disableColor1:this.bgColor,i.beginPath(),i.lineWidth=4/e,i.moveTo(r.center_x,r.y),i.lineTo(r.center_x,r.bottom),i.stroke();let l=this.max??this.curMax,h;this.max===null&&this.curMax/this.unboundedStopMultiple>this.min?h=this.value>l/this.unboundedStopMultiple?(.5+.5*(this.value-l/this.unboundedStopMultiple)/(l-l/this.unboundedStopMultiple))*r.h:.5*(this.value-this.min)/(l/this.unboundedStopMultiple-this.min)*r.h:h=(this.value-this.min)/(l-this.min)*r.h,i.strokeStyle=this.disable?this.disableColor2:this.bgColor,i.beginPath(),i.arc(r.center_x,r.y+h,n,0,2*Math.PI),i.stroke(),i.fillStyle=this.color,(this._touching||this.disable)&&(i.fillStyle=this.disable?this.disableColor1:this.selectColor),i.fill()}}}class St extends R{constructor(t={}){super();a(this,"_activeDOMInput",null);a(this,"focus",!0);a(this,"disable",!1);a(this,"_inputSanitizer");this._textData=null,t!==null&&this.updateProperties(t)}on_touch_down(t,i,e){return super.on_touch_down(t,i,e)?!0:!this.disable&&this.collide(e.rect)?(e.grab(this),this._touching=!0,!0):(this.clearDOM(),!1)}on_touch_up(t,i,e){return super.on_touch_up(t,i,e)?!0:e.grabbed!=this?!1:!this.disable&&this.collide(e.rect)?(this._touching=!1,this.addDOMInput(),!0):(this.clearDOM(),!1)}on_layout(t,i,e){this.clearDOM()}DOMInputRect(){let t=this.rect,i=this.getTransformRecurse(),e=new P,r=i.transformPoint(new DOMPoint(t.x,t.y)),n=i.transformPoint(new DOMPoint(t.right,t.bottom));return[e.x,e.y]=[r.x,r.y],[e.w,e.h]=[n.x,n.y],e.w-=e.x,e.h-=e.y,e}addDOMInput(){if(!this._textData)return;p.get();let t=document.getElementById("eskvapp");if(!t)return;let i=this.wrap?"textarea":"input",e=document.createElement(i);if(!(e instanceof HTMLInputElement)&&!(e instanceof HTMLTextAreaElement))return;let r,n=this.DOMInputRect(),l=this.color!=null?this.color:"white",h=this.bgColor!=null?this.bgColor:"black";e.style.color=l,r=this._textData.size/this.h*n.h/this._textData.outText.length,i=="textarea"&&this._textData.outText.length,e.value=this.text,r=(Math.floor(r*100)/100).toString()+"px",e.style.fontSize=r,e.style.backgroundColor=h,e.style.top=(Math.floor(n.y*100)/100).toString()+"px",e.style.left=(Math.floor(n.x*100)/100).toString()+"px",e.style.width=(Math.floor(n.w*100)/100).toString()+"px",e.style.height=(Math.floor(n.h*100)/100).toString()+"px",e.style.fontFamily=this.fontName,this._activeDOMInput=e,t.appendChild(e),e.addEventListener("focusout",o=>this.clearDOM()),e.focus(),e.select(),this.focus=!0}clearDOM(){if(this._activeDOMInput!=null){this.text=this._inputSanitizer?this._inputSanitizer(this._activeDOMInput.value,this):this._activeDOMInput.value;let t=this._activeDOMInput;this._activeDOMInput=null,t.remove(),this.focus=!1,this._needsLayout=!0;let i=p.get().inputHandler;(i==null?void 0:i.grabbed)===this&&i.ungrab()}}layoutChildren(){if(super.layoutChildren(),this._activeDOMInput!=null){let t=this.DOMInputRect(),i=this._activeDOMInput;i.style.top=(Math.floor(t.y*100)/100).toString()+"px",i.style.left=(Math.floor(t.x*100)/100).toString()+"px",i.style.width=(Math.floor(t.w*100)/100).toString()+"px",i.style.height=(Math.floor(t.h*100)/100).toString()+"px"}}}class Dt extends L{constructor(t=null){super();a(this,"bgColor",null);a(this,"outlineColor",null);a(this,"src",null);a(this,"lockAspect",!0);a(this,"scaleToFit",!0);a(this,"antiAlias",!0);a(this,"angle",0);a(this,"anchor","center");a(this,"mirror",!1);this.image=new Image,t!==null&&this.updateProperties(t),this.src&&(this.image.src=this.src)}on_src(t,i,e){this.src?this.image.src=this.src:this.image.src=""}layoutChildren(){this._layoutNotify&&this.emit("layout",null);let t=p.get();"w"in this.hints&&this.hints.w==null&&(this[2]=this.image.width/t.tileSize),"h"in this.hints&&this.hints.h==null&&(this[3]=this.image.height/t.tileSize),this._needsLayout=!1,super.layoutChildren()}draw(t,i){if(super.draw(t,i),!this.image.complete||this.image.naturalHeight==0)return;let e=this.rect;if(this.scaleToFit||(e.x+=e.w/2-this.image.width/2/t.tileSize,e.y+=e.h/2-this.image.height/2/t.tileSize,e.w=this.image.width/t.tileSize,e.h=this.image.height/t.tileSize),this.lockAspect){let n=this.image.height/this.image.width,l=e.h/e.w,h=e.h,o=e.w;n<l&&(h=e.w*n),n>l&&(o=e.h/n),e.x+=e.w/2-o/2,e.y+=e.h/2-h/2,e.w=o,e.h=h}i.save(),i.imageSmoothingEnabled=this.antiAlias;let r=this.anchor;r=="center"?r=[e.w/2,e.h/2]:r=[r[0]*e.w,r[1]*e.h],this.mirror&&i.scale(-1,1),i.translate(e.x+r[0],e.y+r[1]),this.angle!=0&&i.rotate(this.angle),i.translate(-r[0],-r[1]),i.drawImage(this.image,0,0,this.image.width,this.image.height,0,0,e.w,e.h),i.restore()}}class N extends L{constructor(t=null){super();a(this,"spacingX",0);a(this,"spacingY",0);a(this,"paddingX",0);a(this,"paddingY",0);a(this,"orientation","vertical");a(this,"order","forward");t!==null&&this.updateProperties(t)}*iterChildren(){if(this.order==="forward")for(let t of this._children)yield t;else for(let t=this._children.length-1;t>=0;t--)yield this._children[t]}on_numX(t,i,e){this._needsLayout=!0}on_numY(t,i,e){this._needsLayout=!0}on_spacingX(t,i,e){this._needsLayout=!0}on_spacingY(t,i,e){this._needsLayout=!0}on_paddingX(t,i,e){this._needsLayout=!0}on_paddingY(t,i,e){this._needsLayout=!0}on_orientation(t,i,e){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let t=this.getMetric(this,"spacingX",this.spacingX),i=this.getMetric(this,"spacingY",this.spacingY),e=this.getMetric(this,"paddingX",this.paddingX),r=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation==="vertical"){let n=this.children.length,l=this.h-i*(n-1)-2*r,h=this.w-2*e,o=0;for(let m of this.iterChildren())m.w=h,this.applyHints(m,h,l),"h"in m.hints&&(m.hints.h===null&&m.layoutChildren(),o+=m.h,n--);let f=(l-o)/n,d=h;n===0&&l>0&&(r=(l-o)/2);let c=this.y+r,g=this.x+e;for(let m of this.iterChildren())m.y=c,!("x"in m.hints)&&!("center_x"in m.hints)&&!("right"in m.hints)&&(m.x=g),"w"in m.hints||(m.w=d),"h"in m.hints||(m.h=f),m.layoutChildren(),c+=i+m.h;if(n===0&&"h"in this.hints&&this.hints.h===null){const m=this[3];this[3]=c+2*r-this.y,Math.abs(m-this[3])>1e-6&&(p.get()._needsLayout=!0)}return}if(this.orientation==="horizontal"){let n=this.children.length,l=this.h-2*r,h=this.w-t*(n-1)-2*e,o=0;for(let m of this.iterChildren())m.h=l,this.applyHints(m,h,l),"w"in m.hints&&(m.hints.w===null&&m.layoutChildren(),o+=m.w,n--);let f=l,d=(h-o)/n;n===0&&h>0&&(e=(h-o)/2);let c=this.y+r,g=this.x+e;for(let m of this.iterChildren())m.x=g,!("y"in m.hints)&&!("center_y"in m.hints)&&!("bottom"in m.hints)&&(m.y=c),"w"in m.hints||(m.w=d),"h"in m.hints||(m.h=f),m.layoutChildren(),g+=t+m.w;if(n==0&&"w"in this.hints&&this.hints.w==null){const m=this[2];this[2]=g+2*e-this.x,Math.abs(m-this[2])>1e-6&&(p.get()._needsLayout=!0)}}}}class tt extends L{constructor(t=null){super();a(this,"activePage",0);t!==null&&this.updateProperties(t)}on_wheel(t,i,e){const r=this.children[this.activePage]??void 0;return!!(r!==void 0&&r.emit(t,e))}on_touch_down(t,i,e){let r=this.getTransform();if(r){let n=e.copy(),l=r.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[l.x,l.y];const h=this.children[this.activePage]??void 0;if(h!==void 0&&h.emit(t,n))return!0}else{const n=this.children[this.activePage]??void 0;if(n!==void 0&&n.emit(t,e))return!0}return!1}on_touch_up(t,i,e){let r=this.getTransform();if(r){let n=e.copy(),l=r.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[l.x,l.y];const h=this.children[this.activePage]??void 0;if(h!==void 0&&h.emit(t,n))return!0}else{const n=this.children[this.activePage]??void 0;if(n!==void 0&&n.emit(t,e))return!0}return!1}on_touch_move(t,i,e){let r=this.getTransform();if(r){let n=e.copy(),l=r.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[l.x,l.y];const h=this.children[this.activePage]??void 0;if(h!==void 0&&h.emit(t,n))return!0}else{const n=this.children[this.activePage]??void 0;if(n!==void 0&&n.emit(t,e))return!0}return!1}on_touch_cancel(t,i,e){let r=this.getTransform();if(r){let n=e.copy(),l=r.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[l.x,l.y];const h=this.children[this.activePage]??void 0;if(h!==void 0&&h.emit(t,n))return!0}else{const n=this.children[this.activePage]??void 0;if(n!==void 0&&n.emit(t,e))return!0}return!1}on_activePage(t,i,e){this._needsLayout=!0}_draw(t,i,e){this.draw(t,i);let r=this.getTransform();if(r){i.save(),i.transform(r.a,r.b,r.c,r.d,r.e,r.f);let l=this.children[this.activePage]??void 0;l!==void 0&&l._draw(t,i,e),i.restore();return}let n=this.children[this.activePage]??void 0;n!==void 0&&n._draw(t,i,e)}}class Mt extends tt{constructor(t=null){super();a(this,"tabHeightHint","1");a(this,"tabGroupName","tabbedNotebookGroup");this.buttonBox=new N({orientation:"horizontal",hints:{h:this.tabHeightHint,w:null}}),this.buttonScroller=new et({id:"_scrollview",hints:{h:this.tabHeightHint,w:1},children:[this.buttonBox]}),this._children=[this.buttonScroller],this.buttonScroller.parent=this,t!==null&&this.updateProperties(t),this.updateButtons()}on_tabHeightHint(t,i,e){this.buttonBox.hints.h=this.tabHeightHint}on_child_added(t,i,e){this.updateButtons()}on_child_removed(t,i,e){this.updateButtons()}on_wheel(t,i,e){const r=this._children[0]??void 0;if(r!==void 0&&r.emit(t,e))return!0;const n=this.children[this.activePage]??void 0;return!!(n!==void 0&&n.emit(t,e))}on_touch_down(t,i,e){let r=this.getTransform();if(r){let n=e.copy(),l=r.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[l.x,l.y];const h=this._children[0]??void 0;if(h!==void 0&&h.emit(t,n))return!0;const o=this.children[this.activePage]??void 0;if(o!==void 0&&o.emit(t,n))return!0}else{const n=this._children[0]??void 0;if(n!==void 0&&n.emit(t,e))return!0;const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(t,e))return!0}return!1}on_touch_up(t,i,e){let r=this.getTransform();if(r){let n=e.copy(),l=r.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[l.x,l.y];const h=this._children[0]??void 0;if(h!==void 0&&h.emit(t,n))return!0;const o=this.children[this.activePage]??void 0;if(o!==void 0&&o.emit(t,n))return!0}else{const n=this._children[0]??void 0;if(n!==void 0&&n.emit(t,e))return!0;const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(t,e))return!0}return!1}on_touch_move(t,i,e){let r=this.getTransform();if(r){let n=e.copy(),l=r.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[l.x,l.y];const h=this._children[0]??void 0;if(h!==void 0&&h.emit(t,n))return!0;const o=this.children[this.activePage]??void 0;if(o!==void 0&&o.emit(t,n))return!0}else{const n=this._children[0]??void 0;if(n!==void 0&&n.emit(t,e))return!0;const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(t,e))return!0}return!1}on_touch_cancel(t,i,e){let r=this.getTransform();if(r){let n=e.copy(),l=r.inverse().transformPoint(new DOMPoint(n.pos[0],n.pos[1]));n.pos=[l.x,l.y];const h=this._children[0]??void 0;if(h!==void 0&&h.emit(t,n))return!0;const o=this.children[this.activePage]??void 0;if(o!==void 0&&o.emit(t,n))return!0}else{const n=this._children[0]??void 0;if(n!==void 0&&n.emit(t,e))return!0;const l=this.children[this.activePage]??void 0;if(l!==void 0&&l.emit(t,e))return!0}return!1}get children(){return this._children.slice(1)}set children(t){for(let i of this._children.slice(1))this.emit("child_removed",i),i.parent=null,this._needsLayout=!0,this.updateButtons();this._children=this._children.slice(0,1);for(let i of t)this.addChild(i)}updateButtons(){this.buttonBox.children=[];let t=0;for(let i of this.children){const e=new $({text:i.name??String(t+1),group:this.tabGroupName,singleSelect:!0,press:this.activePage===t,fontSize:"0.5",hints:{h:null,w:null}});e.bind("press",(r,n,l)=>{this.activePage=this.buttonBox.children.findIndex(h=>h===n)}),this.buttonBox.addChild(e),t++}}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;const t=this._children[0];this.applyHints(t),t.x=this.x,t.y=this.y,t.layoutChildren();const i=this.h-t.h,e=this.w;for(let r of this.children)r.y=this.y+t.h,r.x=this.x,r.w=e,r.h=i,r.layoutChildren()}_draw(t,i,e){this.draw(t,i);let r=this.getTransform();if(r){i.save(),i.transform(r.a,r.b,r.c,r.d,r.e,r.f);let h=this._children[0]??void 0;h!==void 0&&h._draw(t,i,e);let o=this.children[this.activePage]??void 0;o!==void 0&&o._draw(t,i,e),i.restore();return}let n=this._children[0]??void 0;n!==void 0&&n._draw(t,i,e);let l=this.children[this.activePage]??void 0;l!==void 0&&l._draw(t,i,e)}}class Tt extends L{constructor(t=null){super();a(this,"numX",1);a(this,"numY",1);a(this,"spacingX",0);a(this,"spacingY",0);a(this,"paddingX",0);a(this,"paddingY",0);a(this,"orientation","horizontal");t!==null&&this.updateProperties(t)}on_numX(t,i,e){this._needsLayout=!0}on_numY(t,i,e){this._needsLayout=!0}on_spacingX(t,i,e){this._needsLayout=!0}on_spacingY(t,i,e){this._needsLayout=!0}on_paddingX(t,i,e){this._needsLayout=!0}on_paddingY(t,i,e){this._needsLayout=!0}on_orientation(t,i,e){this._needsLayout=!0}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1;let t=this.getMetric(this,"spacingX",this.spacingX),i=this.getMetric(this,"spacingY",this.spacingY),e=this.getMetric(this,"paddingX",this.paddingX),r=this.getMetric(this,"paddingY",this.paddingY);if(this.orientation=="horizontal"){let n=this.numX,l=Math.ceil(this.children.length/this.numX),h=this.h-i*(l-1)-2*r,o=this.w-t*(n-1)-2*e,f=new Array(n).fill(0),d=new Array(l).fill(0),c=0,g=0,m=0;for(let w of this.children)this.applyHints(w,o,h),"w"in w.hints&&(f[g]=Math.max(w.w,f[g])),"h"in w.hints&&(d[c]=Math.max(w.h,d[c])),(m+1)%n==0?(c++,g=0):g++,m++;let b=0,T=0,x=0,y=0;for(let w of f)b+=w,w>0&&x++;for(let w of d)T+=w,w>0&&y++;let D=l>y?(h-T)/(l-y):0,C=n>x?(o-b)/(n-x):0,z=this.y+r,E=this.x+e;c=0,g=0;for(let w=0;w<this.children.length;w++){let S=this.children[w],O=f[g]==0?C:f[g],B=d[c]==0?D:d[c];"w"in S.hints||(S.w=O),"h"in S.hints||(S.h=B),S.x=E,S.y=z,S.layoutChildren(),(w+1)%n==0?(E=this.x+e,z+=i+B,g=0,c++):(E+=t+O,g++)}return}else{let n=Math.ceil(this.children.length/this.numY),l=this.numY,h=this.h-i*(l-1)-2*r,o=this.w-t*(n-1)-2*e,f=new Array(n).fill(0),d=new Array(l).fill(0),c=0,g=0,m=0;for(let w of this.children)this.applyHints(w,o,h),"w"in w.hints&&(f[g]=Math.max(w.w,f[g])),"h"in w.hints&&(d[c]=Math.max(w.h,d[c])),(m+1)%l==0?(g++,c=0):c++,m++;let b=0,T=0,x=0,y=0;for(let w of f)b+=w,w>0&&x++;for(let w of d)T+=w,w>0&&y++;let D=l>y?(h-T)/(l-y):0,C=n>x?(o-b)/(n-x):0,z=this.y+r,E=this.x+e;c=0,g=0;for(let w=0;w<this.children.length;w++){let S=this.children[w],O=f[g]==0?C:f[g],B=d[c]==0?D:d[c];"w"in S.hints||(S.w=O),"h"in S.hints||(S.h=B),S.x=E,S.y=z,S.layoutChildren(),(w+1)%l==0?(z=this.y+r,E+=t+O,c=0,g++):(z+=i+B,c++)}}}}class et extends L{constructor(t=null){super();a(this,"_scrollX",0);a(this,"_scrollY",0);a(this,"scrollX",0);a(this,"scrollY",0);a(this,"scrollW",!0);a(this,"scrollH",!0);a(this,"wAlign","center");a(this,"hAlign","top");a(this,"uiZoom",!0);a(this,"uiMove",!0);a(this,"zoom",1);a(this,"vel",null);a(this,"velCutoff",1e-5);a(this,"velDecay",.95);a(this,"unboundedH",!1);a(this,"unboundedW",!1);a(this,"_zoomCenter",null);t!==null&&this.updateProperties(t),this._processTouches=!0,this._oldTouch=null,this._lastDist=null}on_child_added(t,i,e){this.children.length==1&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0,e.bind("rect",(r,n,l)=>this._needsLayout=!0),e.bind("w",(r,n,l)=>this._needsLayout=!0),e.bind("h",(r,n,l)=>this._needsLayout=!0))}on_child_removed(t,i,e){this.children.length==0&&(this.scrollX=0,this.scrollY=0,this._needsLayout=!0)}layoutChildren(){this._layoutNotify&&this.emit("layout",null),this._needsLayout=!1,this.children[0][0]=0,this.children[0][1]=0,this.scrollW||(this.children[0][2]=this.w),this.scrollH||(this.children[0][3]=this.h);for(let t of this.children)t.layoutChildren()}fitToClient(){this.zoom=Math.min(this.w/this.children[0].w,this.h/this.children[0].h),this.scrollX=.5*this.scrollableW,this.scrollY=.5*this.scrollableH}on_uiZoom(t,i,e){this._needsLayout=!0}on_hAlign(t,i,e){this._needsLayout=!0}on_vAlign(t,i,e){this._needsLayout=!0}*iter(t=!0,i=!0){if(yield this,!!t)if(i)for(let e of this._children)this.contains(e)&&(yield*e.iter(...arguments));else for(let e of this._children)yield*e.iter(...arguments)}on_scrollW(t,i,e){this._needsLayout=!0,this.scrollX=0}on_scrollH(t,i,e){this._needsLayout=!0,this.scrollY=0}on_scrollX(t,i,e){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedW){this._scrollX=this.scrollX;return}let r=0;switch(this.wAlign){case"center":r=.5*this.scrollableW;break;case"right":r=1*this.scrollableW}this._scrollX=this.scrollableW<=0||this.scrollableW>=this.children[0].w?r:e,this._scrollX=Y(e,0,this.scrollableW)}on_scrollY(t,i,e){if(this.children.length==0)return;if(this._needsLayout=!0,this.unboundedH){this._scrollY=this.scrollY;return}let r=0;switch(this.hAlign){case"middle":r=.5*this.scrollableH;break;case"bottom":r=1*this.scrollableH}this._scrollY=this.scrollableH<=0||this.scrollableH>=this.children[0].h?r:e,this._scrollY=Y(e,0,this.scrollableH)}update(t,i){if(super.update(t,i),this.vel!==null){this.scrollX+=this.vel.x*i,this.scrollY+=this.vel.y*i,this.vel=this.vel.scale(this.velDecay**(i/30));let e=this.vel.abs();e.x<=this.velCutoff/this.zoom&&e.y<=this.velCutoff/this.zoom&&(this.vel=null)}}getTransform(){const t=p.get().tileSize;return new DOMMatrix().translate(Math.floor((this.x-this._scrollX*this.zoom)*t)/t,Math.floor((this.y-this._scrollY*this.zoom)*t)/t).scale(this.zoom,this.zoom)}on_touch_down(t,i,e){this.vel=null;let r=e.rect;if(this._lastDist=null,this.collide(r)){let n=Date.now(),l=e.asChildTouch(this);return this._oldTouch=[l.x,l.y,l.identifier,n,null],super.on_touch_down(t,i,e)||e.grab(this),!0}return!1}on_touch_up(t,i,e){if(e.grabbed!==this)return!1;if(this._oldTouch!=null){let r=this._oldTouch[4],n=new _([this._oldTouch[0],this._oldTouch[1]]),l=e.asChildTouch(this),h=Math.max(Date.now()-this._oldTouch[3],1),o=this.scrollableW>0||this.unboundedW?(l.x-n.x)/h:0,f=this.scrollableH>0||this.unboundedH?(l.y-n.y)/h:0;this.vel=new _([-o,-f]),r&&(this.vel=this.vel.add(r).scale(.5))}return this._oldTouch=null,this._lastDist=null,this._zoomCenter=null,e.ungrab(),!1}on_touch_move(t,i,e){if(e.grabbed!==this)return!1;let r=e.rect;if(this.collide(r)){let n=e.asChildTouch(this);if((this.uiMove&&e.nativeEvent==null||e.nativeEvent instanceof TouchEvent&&e.nativeEvent.touches.length==1)&&this._oldTouch!=null&&e.identifier==this._oldTouch[2]){this.scrollW&&(this.scrollX=this.scrollableW==0?0:this._scrollX+(this._oldTouch[0]-n.x)),this.scrollH&&(this.scrollY=this.scrollableH==0?0:this._scrollY+(this._oldTouch[1]-n.y));let l=e.asChildTouch(this),h=this._oldTouch,o=Date.now(),f=new _([0,0]),d=new _([0,0]);if(h!=null){let g=Math.max(o-h[3],1),m=this.scrollableW>0||this.unboundedW?(l.x-n.x)/g:0,b=this.scrollableH>0||this.unboundedH?(l.y-n.y)/g:0;f=new _([m,b]),d=h[4]!==null?h[4]:d}let c=f.abs().sum()===0?f:f.add(d).scale(.5);this._oldTouch=[l.x,l.y,e.identifier,o,c]}if(this.uiZoom&&e.nativeEvent&&e.nativeEvent instanceof TouchEvent&&e.nativeEvent.touches.length==2){let l=e.nativeEvent.touches[0],h=e.nativeEvent.touches[1],o=ft([l.clientX,l.clientY],[h.clientX,h.clientY]);if(this._lastDist!=null){let f=this._scrollX+this.w/this.zoom/2,d=this._scrollY+this.h/this.zoom/2,c=[l.clientX,l.clientY],g=[h.clientX,h.clientY],m=this.appToChild(c),b=this.appToChild(g),T=[(m[0]+b[0])/2,(m[1]+b[1])/2];this._zoomCenter===null&&(this._zoomCenter=new _(T));let x=this.zoom*o/this._lastDist,y=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(x,y);let D=this.appToChild(c),C=this.appToChild(g),z=[(D[0]+C[0])/2,(D[1]+C[1])/2];this.scrollX=f+T[0]-z[0]-this.w/this.zoom/2,this.scrollY=d+T[1]-z[1]-this.h/this.zoom/2}this._lastDist=o}}return!1}on_touch_cancel(t,i,e){return this._lastDist=null,e.grabbed===this?(e.ungrab(),!0):!!super.on_touch_cancel(t,i,e)}on_wheel(t,i,e){let r=p.get();if(!r.inputHandler)return!0;let n=this._scrollX+this.w/this.zoom/2,l=this._scrollY+this.h/this.zoom/2,h=e.nativeObject;if(!this.collide(e.rect)&&(!this.unboundedW||!this.unboundedH)||!(h instanceof WheelEvent))return!1;if(this.uiZoom&&r.inputHandler.isKeyDown("Control")){let o=e.asChildTouch(this);o.pos[0],o.pos[1];let f=this.zoom*Math.exp(-h.deltaY/r.h),d=Math.min(this.unboundedW?.01:this.w/this.children[0].w,this.unboundedH?.01:this.h/this.children[0].h);this.zoom=Math.max(f,d);let c=e.asChildTouch(this);return c.pos[0],c.pos[1],this.scrollX=this.scrollableW==0&&!this.unboundedW?0:n-this.w/this.zoom/2,this.scrollY=this.scrollableH==0&&!this.unboundedH?0:l-this.h/this.zoom/2,this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}else{if(this.uiMove&&this.scrollW&&r.inputHandler.isKeyDown("Shift"))return this.scrollX+=this.scrollableW==0&&!this.unboundedW?0:this.w/this.zoom*(h.deltaY/r.w),this.scrollX!=this._scrollX&&(this.scrollX=this._scrollX),!0;if(this.uiMove&&this.scrollH)return this.scrollY+=this.scrollableH==0&&!this.unboundedH?0:this.h/this.zoom*(h.deltaY/r.h),this.scrollY!=this._scrollY&&(this.scrollY=this._scrollY),!0}return!1}get scrollableW(){return this.children.length==0?0:this.unboundedW?this.children[0].w-this.w/this.zoom:Math.max(this.children[0].w-this.w/this.zoom,0)}get scrollableH(){return this.children.length==0?0:this.unboundedH?this.children[0].h-this.h/this.zoom:Math.max(this.children[0].h-this.h/this.zoom,0)}_draw(t,i,e){this.draw(t,i);let r=this.rect;r[0]=Math.floor(r[0]*t.tileSize*t.pixelSize)/(t.tileSize*t.pixelSize),r[1]=Math.floor(r[1]*t.tileSize*t.pixelSize)/(t.tileSize*t.pixelSize),r[2]=Math.floor(r[2]*t.tileSize*t.pixelSize)/(t.tileSize*t.pixelSize),r[3]=Math.floor(r[3]*t.tileSize*t.pixelSize)/(t.tileSize*t.pixelSize),i.save(),i.beginPath(),i.rect(r[0],r[1],r[2],r[3]),i.clip();let n=this.getTransform();n&&i.transform(n.a,n.b,n.c,n.d,n.e,n.f),this.children[0]._draw(t,i,e),i.restore()}}class Ct extends N{constructor(t=null){super();a(this,"closeOnTouchOutside",!0);a(this,"bgColor","slate");a(this,"outlineColor","gray");a(this,"dim",!0);a(this,"dimScale",.8);t!==null&&this.updateProperties(t)}get visible(){return p.get()._modalWidgets.indexOf(this)>=0}popup(){if(this.parent==null){let t=p.get();return this.parent=t,t.addModal(this),!0}return!1}close(t=0){if(this.parent!=null){this.emit("close",t);let i=p.get();return this.parent=null,i.removeModal(this),!0}return!1}on_touch_down(t,i,e){return this.closeOnTouchOutside&&!this.collide(e.rect)?(this.close(),!0):super.on_touch_down(t,i,e)}draw(t,i){if(this.dim){let e=p.get().baseWidget.rect,r=p.get().ctx;if(!r)return;r.fillStyle="rgba(0,0,0,"+this.dimScale+")",r.rect(e[0],e[1],e[2],e[3]),r.fill(),super.draw(t,r)}}}class At extends Array{constructor(s,t){super();for(let i=0;i<s.length;++i)t[i]?this.push(s[i],t[i][0],t[i][1]):this.push(s[i],0,0)}*iter(){for(let s=0;s<this.length/3;s++)yield this.slice(s*3,s*3+3)}}class Pt extends L{constructor(t={}){super();a(this,"spriteSheet",null);a(this,"frames",[]);a(this,"timePerFrame",30);a(this,"timeLeft",0);a(this,"activeFrame",0);a(this,"id","");a(this,"facing",0);a(this,"flipX",!1);a(this,"flipY",!1);a(this,"oneShot",!1);t&&this.updateProperties(t)}update(t,i){if(super.update(t,i),this.timeLeft-=i,this.timeLeft<=0){if(this.oneShot&&this.activeFrame===this.frames.length-1){this.timeLeft=1/0,this.emit("animationComplete",this.activeFrame);return}this.activeFrame++,this.activeFrame>=this.frames.length&&(this.activeFrame=0),this.timeLeft+=this.timePerFrame}this.frames.length>0&&this.timeLeft!==1/0&&t.requestFrameUpdate()}restart(){this.activeFrame=0,this.timeLeft=this.timePerFrame}on_frames(t,i,e){this.restart()}get frame(){return this.frames[this.activeFrame]??-1}draw(t,i){if(this.spriteSheet===null||!this.spriteSheet.sheet.complete)return;const e=Math.floor(this.x*t.tileSize)/t.tileSize,r=Math.floor(this.y*t.tileSize)/t.tileSize;if(i.translate(e,r),i.scale(this.w,this.h),this.frame instanceof At)for(let[n,l,h]of this.frame.iter())this.spriteSheet.drawIndexed(i,n,0,0,this.facing,l,h);else this.spriteSheet.drawIndexed(i,this.frame,0,0,this.facing);i.scale(1/this.w,1/this.h),i.translate(-e,-r)}}class it extends L{constructor(s={}){super(),this.defaultValue=-1,this._data=new J,this._vLayer=null,this._aLayer=null,this._cacheTileDim=new _,this.tileDim=new _,this.hints={w:null,h:null},this.spriteSheet=null,this.clipRegion=null,this.alphaValue=.5,this.useCache=!0,s&&this.updateProperties(s)}serialize(){const s={};return s._data=this._data.slice(),s.tileDim=this.tileDim.slice(),s.spriteSheet=Array(...p.resources.keys()).find(t=>p.resources[t]===this.spriteSheet)??null,s}get(s){return this._data.get(s)}set(s,t){this._data.set(s,t),this._data._cacheData=null}get data(){return this._data}deserialize(s){this.tileDim=new _(s.tileDim??[0,0]);const t=s._data;for(let i=0;i<t.length;i++)this._data[i]=t[i];this.spriteSheet=p.resources[s.spriteSheet]??null,this._data._cacheData=null}on_tileDim(s,t,i){this.resizeData(),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new _(this.tileDim)}resizeData(){let s=[];for(let i=0;i<this._cacheTileDim[1];i++)for(let e=0;e<this._cacheTileDim[0];e++)s.push(this.get([e,i]));this._data.tileDim=new _(this.tileDim),this._data.length=this.tileDim[0]*this.tileDim[1],this._data.fill(this.defaultValue);let t=0;for(let i=0;i<this._cacheTileDim[1];i++)for(let e=0;e<this._cacheTileDim[0];e++)e<this.tileDim[0]&&i<this.tileDim[1]&&this.set([e,i],s[t]),++t;this._data._cacheData=null}draw(s,t){if(super.draw(s,t),this.spriteSheet===null||!this.spriteSheet.sheet.complete||!this.spriteSheet.sheet.complete||this.spriteSheet.sheet.naturalHeight==0)return;let[i,e]=[0,0],[r,n]=this.tileDim;if(this.clipRegion&&([i,e]=this.clipRegion.pos,[r,n]=this.clipRegion.pos.add(this.clipRegion.size).add([1,1]),i=Math.min(Math.max(i,0),this.tileDim[0]),r=Math.min(Math.max(r,0),this.tileDim[0]),e=Math.min(Math.max(e,0),this.tileDim[1]),n=Math.min(Math.max(n,0),this.tileDim[1])),Math.floor(this.spriteSheet.sheet.width/this.spriteSheet.spriteSize),Math.floor(this.spriteSheet.sheet.height/this.spriteSheet.spriteSize),this.useCache){if(this._data._cacheData===null&&this.cacheCanvas(),this._data._cacheData===null)return;const l=this.spriteSheet.spriteSize;if(t.drawImage(this._data._cacheData,l*i,l*e,l*(r-i),l*(n-e),this.x+i,this.y+e,r-i,n-e),this._aLayer===null&&this._vLayer===null)for(let h=i;h<r;h++)for(let o=e;o<n;o++){let f=h+o*this.tileDim[0],d=this._data[f];d<-1&&this.spriteSheet.drawIndexed(t,d,h+this.x,o+this.y)}else if(this._aLayer&&this._vLayer){const h=this._aLayer,o=this._vLayer,f=t.globalAlpha,d=this._data;for(let c=i;c<r;c++)for(let g=e;g<n;g++){let m=c+g*this.tileDim[0],b=d[m];b<-1&&o[m]>0&&(h[m]===0?(t.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(t,b,c+this.x,g+this.y),t.globalAlpha=f):this.spriteSheet.drawIndexed(t,b,c+this.x,g+this.y))}}}else if(this._aLayer===null&&this._vLayer===null)for(let l=i;l<r;l++)for(let h=e;h<n;h++){let o=l+h*this.tileDim[0],f=this._data[o];this.spriteSheet.drawIndexed(t,f,l+this.x,h+this.y)}else if(this._aLayer&&this._vLayer){const l=this._aLayer,h=this._vLayer,o=t.globalAlpha,f=this._data;for(let d=i;d<r;d++)for(let c=e;c<n;c++){let g=d+c*this.tileDim[0],m=f[g];m!==-1&&h[g]>0&&(l[g]===0?(t.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(t,m,d+this.x,c+this.y),t.globalAlpha=o):this.spriteSheet.drawIndexed(t,m,d+this.x,c+this.y))}}}clearCache(){this.data._cacheData=null}cacheCanvas(){if(this._data._cacheData=null,!this.spriteSheet||!this.spriteSheet.sheet||this.tileDim[0]<=0||this.tileDim[1]<=0)return;const s=new OffscreenCanvas(this.tileDim[0]*this.spriteSheet.spriteSize,this.tileDim[1]*this.spriteSheet.spriteSize),t=s.getContext("2d");if(!t)return;t.scale(this.spriteSheet.spriteSize,this.spriteSheet.spriteSize);let[i,e]=[0,0],[r,n]=this.tileDim;if(this._aLayer===null&&this._vLayer===null)for(let l=i;l<r;l++)for(let h=e;h<n;h++){let o=l+h*this.tileDim[0],f=this._data[o];f>=0&&this.spriteSheet.drawIndexed(t,f,l,h)}else if(this._aLayer&&this._vLayer){const l=this._aLayer,h=this._vLayer,o=t.globalAlpha,f=this._data;for(let d=i;d<r;d++)for(let c=e;c<n;c++){let g=d+c*this.tileDim[0],m=f[g];m>=0&&h[g]>0&&(l[g]===0?(t.globalAlpha=this.alphaValue,this.spriteSheet.drawIndexed(t,m,d,c),t.globalAlpha=o):this.spriteSheet.drawIndexed(t,m,d,c))}}this._data._cacheData=s}}class Lt extends it{constructor(s={}){super(),this._layerData=[this._data],this.numLayers=1,this.activeLayer=0,this.visibilityLayer=-1,this.alphaLayer=-1,s&&this.updateProperties(s)}on_alphaLayer(s,t,i){this._aLayer=this.alphaLayer>=0?this._layerData[this.alphaLayer]:null}on_visibilityLayer(s,t,i){this._vLayer=this.visibilityLayer>=0?this._layerData[this.visibilityLayer]:null}serialize(){const s={},t=[];for(let i of this._layerData)t.push(i.slice());return s._layerData=t,s.activeLayer=this.activeLayer,s.numLayers=this.numLayers,s.tileDim=this.tileDim.slice(),s.spriteSheet=Array(...p.resources.keys()).find(i=>p.resources[i]===this.spriteSheet)??null,s}deserialize(s){this.numLayers=s.numLayers,this.activeLayer=s.activeLayer,this.tileDim=new _(s.tileDim??[0,0]);const t=s._layerData.length;this._layerData.length=t;for(let i=0;i<t;i++){const e=this._layerData[i],r=s._layerData[i];for(let n=0;n<r.lenth;n++)e[n]=r[n]}this.spriteSheet=p.resources[s.spriteSheet]??null,this.clearCache()}on_tileDim(s,t,i){if("_layerData"in this){for(let e of this._layerData)this._data=e,this.resizeData();this.activeLayer>=0&&(this._data=this._layerData[this.activeLayer]),this.w=this.tileDim[0],this.h=this.tileDim[1],this._cacheTileDim=new _(this.tileDim)}}on_numLayers(s,t,i){const e=this._layerData.length;this._layerData.length=this.numLayers;for(let r=e;r<this.numLayers;r++){const n=new J(this.tileDim).fill(this.defaultValue);this._layerData[r]=n}this.activeLayer>=this.numLayers&&(this.activeLayer=this.numLayers-1)}on_activeLayer(s,t,i){this._data=this._layerData[this.activeLayer]}get layer(){return this._layerData}getFromLayer(s,t){return this._layerData[s][t[0]+t[1]*this.tileDim[0]]}setInLayer(s,t,i){this._layerData[s][t[0]+t[1]*this.tileDim[0]]=i,this._layerData[s]._cacheData=null}clearCache(){for(let s of this._layerData)s._cacheData=null}draw(s,t){for(let i of this._layerData)i.hidden||(this._data=i,super.draw(s,t));this._data=this._layerData[this.activeLayer]}}p.registerClass("Widget",L,"");p.registerClass("App",p,"");p.registerClass("Label",R,"");p.registerClass("Button",yt,"");p.registerClass("ToggleButton",$,"");p.registerClass("BasicButton",bt,"");p.registerClass("TextInput",St,"");p.registerClass("CheckBox",vt,"");p.registerClass("Slider",xt,"");p.registerClass("ImageWidget",Dt,"");p.registerClass("BoxLayout",N,"");p.registerClass("GridLayout",Tt,"");p.registerClass("ScrollView",et,"");p.registerClass("ModalView",Ct,"");p.registerClass("Notebook",tt,"");p.registerClass("TabbedNotebook",Mt,"");p.registerClass("SpriteWidget",Pt,"");p.registerClass("TileMap",it,"");p.registerClass("LayeredTileMap",Lt,"");class zt{constructor(s){if(this.canvas=s,this.gl=s.getContext("webgl"),this.gl===null)throw Error(`WebGL context couldb not be retrieved from ${s}`);const t=this.initShaders();this.shaderProgram=t.program,this.aPosition=t.aPosition,this.aTexCoord=t.aTexCoord,this.aColor=t.aColor;const i=this.gl;this.vertexBuffer=i.createBuffer(),this.indexBuffer=i.createBuffer(),this.vertexData=new Float32Array(100*6*8),this.indexData=new Uint16Array(100*6);for(let e=0,r=0;e<this.indexData.length;e+=6,r+=4)this.indexData.set([r,r+1,r+2,r+2,r+3,r],e);i.bindBuffer(i.ARRAY_BUFFER,this.vertexBuffer),i.bufferData(i.ARRAY_BUFFER,this.vertexData,i.DYNAMIC_DRAW),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.indexBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,this.indexData,i.STATIC_DRAW),this.textures=new Map,this.vertexCount=0,this.activeTexture=null}initShaders(){const s=this.gl,e=this.compileShaderProgram(`
            attribute vec2 aPosition;
            attribute vec2 aTexCoord;
            attribute vec4 aColor;
            uniform mat4 uProjectionMatrix;
            varying vec2 vTexCoord;
            varying vec4 vColor;
            void main() {
                gl_Position = uProjectionMatrix*vec4(aPosition, 0.0, 1.0);
                vTexCoord = aTexCoord;
                vColor = aColor;
            }
        `,`
            precision mediump float;
            varying vec2 vTexCoord;
            varying vec4 vColor;
            uniform sampler2D uTexture;
            void main() {
                gl_FragColor = texture2D(uTexture, vTexCoord) * vColor;
            }
        `),r=s.getAttribLocation(e,"aPosition"),n=s.getAttribLocation(e,"aTexCoord"),l=s.getAttribLocation(e,"aColor");if(r===void 0)throw Error("Could not bind aPosition");if(n===void 0)throw Error("Could not bind aTexCoord");if(l===void 0)throw Error("Could not bind aColor");return{program:e,aPosition:r,aTexCoord:n,aColor:l}}compileShaderProgram(s,t){const i=this.gl,e=this.compileShader(i.VERTEX_SHADER,s),r=this.compileShader(i.FRAGMENT_SHADER,t);if(e===null)throw Error(`Error in vertShader ${e}`);if(r===null)throw Error(`Error in fragShader ${r}`);const n=i.createProgram();return i.attachShader(n,e),i.attachShader(n,r),i.linkProgram(n),i.getProgramParameter(n,i.LINK_STATUS)||console.error("Shader link error:",i.getProgramInfoLog(n)),i.useProgram(n),n}compileShader(s,t){const i=this.gl,e=i.createShader(s);if(e===null)throw Error(`Invalid shader type ${s}`);return i.shaderSource(e,t),i.compileShader(e),i.getShaderParameter(e,i.COMPILE_STATUS)||console.error("Shader compile error:",i.getShaderInfoLog(e)),e}registerTexture(s,t,i=1,e=null){const r=this.gl,n=r.createTexture(),[l,h]=i instanceof Array?i:[i,i];e===null&&(e=r.NEAREST),r.bindTexture(r.TEXTURE_2D,n),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,t);const o=d=>(d&d-1)===0;o(t.width)&&o(t.height)?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_LINEAR),r.generateMipmap(r.TEXTURE_2D)):(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,e)),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,e),r.bindTexture(r.TEXTURE_2D,null),this.textures.set(s,{texture:n,width:t.width/l,height:t.height/h})}start(s){const t=this.gl;this.gl.viewport(0,0,this.canvas.width,this.canvas.height);const i=t.getUniformLocation(this.shaderProgram,"uProjectionMatrix"),e=new Float32Array([2/this.canvas.width*s,0,0,0,0,-2/this.canvas.height*s,0,0,0,0,1,0,-1,1,0,1]);t.uniformMatrix4fv(i,!1,e)}drawTexture(s,t,i,e,r,n,l,h,o,f){if(!this.textures.has(s))return;const{texture:d,width:c,height:g}=this.textures.get(s);this.activeTexture!==d&&(this.activeTexture!==null&&this.flush(),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,d),this.activeTexture=d),this.gl;const m=n,b=l,T=n+h,x=l+o,y=t/c,D=i/g,C=(t+e)/c,z=(i+r)/g,E=f??[1,1,1,1],w=this.vertexCount*8,S=this.vertexData;S.set([m,b,y,D,...E],w),S.set([T,b,C,D,...E],w+8),S.set([T,x,C,z,...E],w+16),S.set([m,x,y,z,...E],w+24),this.vertexCount+=4,this.vertexCount>=100*4&&this.flush()}flush(){if(this.vertexCount===0)return;const s=this.gl;s.bindBuffer(s.ARRAY_BUFFER,this.vertexBuffer),s.bufferSubData(s.ARRAY_BUFFER,0,this.vertexData.subarray(0,this.vertexCount*8)),s.vertexAttribPointer(this.aPosition,2,s.FLOAT,!1,8*4,0),s.enableVertexAttribArray(this.aPosition),s.vertexAttribPointer(this.aTexCoord,2,s.FLOAT,!1,8*4,2*4),s.enableVertexAttribArray(this.aTexCoord),s.vertexAttribPointer(this.aColor,4,s.FLOAT,!1,8*4,4*4),s.enableVertexAttribArray(this.aColor),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this.indexBuffer),s.drawElements(s.TRIANGLES,this.vertexCount*6/4,s.UNSIGNED_SHORT,0),this.vertexCount=0}clear(s=0,t=0,i=0,e=1){const r=this.gl;r.clearColor(s,t,i,e),r.clear(r.COLOR_BUFFER_BIT),this.vertexCount=0}}class Et extends L{constructor(s={}){super(),this.drawBatch=[];const t=document.createElement("canvas");this.webglRenderer=new zt(t),this.txTileDim=s.tileDim??1,this.txImage=new Image,this.txImage.src=s.src??"",this.txImage.onload=()=>{this.webglRenderer.registerTexture("texture",this.txImage,this.txTileDim)},this.updateProperties(s)}set src(s){this.txImage.src=s}get src(){return this.txImage.src}addGlyph(s,t,i,e,r,n,l,h,o){this.drawBatch.push({sx:s,sy:t,sw:i,sh:e,dx:r,dy:n,dw:l,dh:h,tint:o})}draw(s,t){const i=this.webglRenderer;i.canvas.width=this.w*this.txTileDim,i.canvas.height=this.h*this.txTileDim,i.start(this.txTileDim),i.clear(0,0,0,1);for(let{sx:e,sy:r,sw:n,sh:l,dx:h,dy:o,dw:f,dh:d,tint:c}of this.drawBatch)i.drawTexture("texture",e,r,n,l,h,o,f,d,c);i.flush(),t.drawImage(i.canvas,0,0,i.canvas.width,i.canvas.height,this.x,this.y,this.w,this.h)}}const kt="data:image/png;base64,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";class U extends p{constructor(){super(...arguments);a(this,"prefDimW",16);a(this,"prefDimH",12);a(this,"playerPos",[8,5])}on_key_down(t,i,e){const r=this.inputHandler;r!==void 0&&(r.isKeyDown("w")?this.playerPos[1]-=1:r.isKeyDown("a")?this.playerPos[0]-=1:r.isKeyDown("s")?this.playerPos[1]+=1:r.isKeyDown("d")?this.playerPos[0]+=1:r.isKeyDown(" "),W.drawBatch[W.drawBatch.length-1].dx=this.playerPos[0],W.drawBatch[W.drawBatch.length-1].dy=this.playerPos[1],U.get().requestFrameUpdate())}}const st=new U,W=new Et({id:"webgl",src:kt,txTileDim:8,hints:{center_x:.5,y:.1,w:"16",h:"10"}});st.baseWidget.children=[new R({text:"Hello",fontName:"serif",align:"center",hints:{center_x:.5,center_y:.05,w:1,h:.1}}),W];let F=[1,1,1,1];for(let u=0;u<160;++u)Math.random()>.5?W.addGlyph(4,4,1,1,u%16,Math.floor(u/16),1,1,F):W.addGlyph(5,4,1,1,u%16,Math.floor(u/16),1,1,F);const q=[8,5];W.addGlyph(5,0,1,1,q[0],q[1],1,1,F);st.start();
